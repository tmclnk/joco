{"id":"rust-b5c2a0fc","diff":" compiler/rustc_resolve/src/diagnostics.rs |  5 ++++-\n compiler/rustc_resolve/src/ident.rs       | 19 +++++++++++--------\n compiler/rustc_resolve/src/late.rs        |  8 +++-----\n compiler/rustc_resolve/src/lib.rs         |  2 +-\n 4 files changed, 19 insertions(+), 15 deletions(-)\n","expectedMessage":"Auto merge of #150982 - petrochenkov:modsplitfast2, r\u003dJonathanBrouwer","repository":"rust","commitHash":"b5c2a0fc0ac851e83ef943e3a2b90c1abab06baa","metadata":{"author":"bors \u003cbors@rust-lang.org\u003e"}}
{"id":"rust-7704328b","diff":" compiler/rustc_hir_typeck/src/pat.rs               | 13 +--\n compiler/rustc_lint_defs/src/builtin.rs            |  2 +-\n compiler/rustc_middle/src/mir/syntax.rs            | 25 +++---\n compiler/rustc_middle/src/thir.rs                  | 14 +---\n compiler/rustc_middle/src/thir/visit.rs            |  8 +-\n compiler/rustc_mir_build/src/builder/block.rs      | 13 +--\n .../src/builder/expr/as_constant.rs                |  2 +-\n .../rustc_mir_build/src/builder/expr/as_operand.rs |  9 ++-\n .../rustc_mir_build/src/builder/expr/as_place.rs   |  5 +-\n .../rustc_mir_build/src/builder/expr/as_rvalue.rs  |  9 ++-\n .../rustc_mir_build/src/builder/expr/as_temp.rs    | 12 +--\n compiler/rustc_mir_build/src/builder/expr/into.rs  |  5 +-\n compiler/rustc_mir_build/src/builder/expr/stmt.rs  | 10 +--\n .../src/builder/matches/match_pair.rs              | 93 ++++++++++++----------\n .../rustc_mir_build/src/builder/matches/mod.rs     |  8 +-\n compiler/rustc_mir_build/src/builder/mod.rs        |  4 +-\n compiler/rustc_mir_build/src/builder/scope.rs      | 10 ++-\n compiler/rustc_mir_build/src/check_unsafety.rs     |  2 +-\n compiler/rustc_mir_build/src/thir/cx/block.rs      |  2 +-\n compiler/rustc_mir_build/src/thir/cx/expr.rs       |  4 +-\n .../src/thir/pattern/check_match.rs                | 66 +++++++--------\n compiler/rustc_mir_build/src/thir/print.rs         | 12 +--\n tests/ui/imports/ambiguous-10.rs                   |  4 +-\n tests/ui/imports/ambiguous-10.stderr               | 10 +--\n tests/ui/imports/ambiguous-12.rs                   |  4 +-\n tests/ui/imports/ambiguous-12.stderr               | 10 +--\n tests/ui/imports/ambiguous-13.rs                   |  4 +-\n tests/ui/imports/ambiguous-13.stderr               | 10 +--\n tests/ui/imports/ambiguous-14.rs                   |  4 +-\n tests/ui/imports/ambiguous-14.stderr               | 10 +--\n tests/ui/imports/ambiguous-15.rs                   |  4 +-\n tests/ui/imports/ambiguous-15.stderr               | 10 +--\n tests/ui/imports/ambiguous-16.rs                   |  4 +-\n tests/ui/imports/ambiguous-16.stderr               | 10 +--\n tests/ui/imports/ambiguous-17.rs                   |  4 +-\n tests/ui/imports/ambiguous-17.stderr               | 10 +--\n tests/ui/imports/ambiguous-2.rs                    |  4 +-\n tests/ui/imports/ambiguous-2.stderr                | 10 +--\n tests/ui/imports/ambiguous-3.rs                    |  4 +-\n tests/ui/imports/ambiguous-3.stderr                | 10 +--\n tests/ui/imports/ambiguous-4.rs                    |  4 +-\n tests/ui/imports/ambiguous-4.stderr                | 10 +--\n tests/ui/imports/ambiguous-5.rs                    |  4 +-\n tests/ui/imports/ambiguous-5.stderr                | 10 +--\n tests/ui/imports/ambiguous-6.rs                    |  4 +-\n tests/ui/imports/ambiguous-6.stderr                | 10 +--\n tests/ui/imports/ambiguous-9.rs                    |  6 +-\n tests/ui/imports/ambiguous-9.stderr                | 16 ++--\n tests/ui/imports/ambiguous-panic-globvsglob.rs     |  4 +-\n tests/ui/imports/ambiguous-panic-globvsglob.stderr | 10 +--\n tests/ui/imports/duplicate.rs                      |  2 +-\n tests/ui/imports/duplicate.stderr                  | 10 +--\n tests/ui/imports/glob-conflict-cross-crate-1.rs    |  6 +-\n .../ui/imports/glob-conflict-cross-crate-1.stderr  | 16 ++--\n tests/ui/imports/glob-conflict-cross-crate-2.rs    |  4 +-\n .../ui/imports/glob-conflict-cross-crate-2.stderr  | 10 +--\n tests/ui/imports/glob-conflict-cross-crate-3.rs    |  6 +-\n .../ui/imports/glob-conflict-cross-crate-3.stderr  | 16 ++--\n tests/ui/imports/issue-114682-2.rs                 |  6 +-\n tests/ui/imports/issue-114682-2.stderr             | 16 ++--\n tests/ui/imports/issue-114682-4.rs                 |  2 +-\n tests/ui/imports/issue-114682-4.stderr             | 10 +--\n tests/ui/imports/issue-114682-5.rs                 |  2 +-\n tests/ui/imports/issue-114682-5.stderr             | 10 +--\n tests/ui/imports/issue-114682-6.rs                 |  4 +-\n tests/ui/imports/issue-114682-6.stderr             | 10 +--\n tests/ui/imports/overwrite-different-ambig-2.rs    |  4 +-\n .../ui/imports/overwrite-different-ambig-2.stderr  | 22 ++---\n tests/ui/imports/unresolved-seg-after-ambiguous.rs |  2 +-\n .../imports/unresolved-seg-after-ambiguous.stderr  | 10 +--\n tests/ui/pattern/type_mismatch.rs                  | 63 ++++++++++++++-\n tests/ui/pattern/type_mismatch.stderr              | 61 +++++++++++++-\n tests/ui/thir-print/c-variadic.stdout              |  2 +-\n tests/ui/thir-print/offset_of.stdout               | 76 +++++++++---------\n tests/ui/thir-print/thir-flat-const-variant.stdout | 36 +++------\n tests/ui/thir-print/thir-flat.stdout               |  4 +-\n tests/ui/thir-print/thir-tree-loop-match.stdout    | 24 +++---\n tests/ui/thir-print/thir-tree-match.stdout         | 20 ++---\n tests/ui/thir-print/thir-tree.stdout               |  2 +-\n tests/ui/unpretty/box.stdout                       |  8 +-\n 80 files changed, 557 insertions(+), 439 deletions(-)","expectedMessage":"Auto merge of #151158 - Zalathar:rollup-okXJcXA, r\u003dZalathar","repository":"rust","commitHash":"7704328ba5ae8d6ce0ac303c9d5a1a1605906766","metadata":{"author":"bors \u003cbors@rust-lang.org\u003e"}}
{"id":"rust-25672263","diff":" compiler/rustc_lint_defs/src/builtin.rs            |  2 +-\n tests/ui/imports/ambiguous-10.rs                   |  4 ++--\n tests/ui/imports/ambiguous-10.stderr               | 10 +++++-----\n tests/ui/imports/ambiguous-12.rs                   |  4 ++--\n tests/ui/imports/ambiguous-12.stderr               | 10 +++++-----\n tests/ui/imports/ambiguous-13.rs                   |  4 ++--\n tests/ui/imports/ambiguous-13.stderr               | 10 +++++-----\n tests/ui/imports/ambiguous-14.rs                   |  4 ++--\n tests/ui/imports/ambiguous-14.stderr               | 10 +++++-----\n tests/ui/imports/ambiguous-15.rs                   |  4 ++--\n tests/ui/imports/ambiguous-15.stderr               | 10 +++++-----\n tests/ui/imports/ambiguous-16.rs                   |  4 ++--\n tests/ui/imports/ambiguous-16.stderr               | 10 +++++-----\n tests/ui/imports/ambiguous-17.rs                   |  4 ++--\n tests/ui/imports/ambiguous-17.stderr               | 10 +++++-----\n tests/ui/imports/ambiguous-2.rs                    |  4 ++--\n tests/ui/imports/ambiguous-2.stderr                | 10 +++++-----\n tests/ui/imports/ambiguous-3.rs                    |  4 ++--\n tests/ui/imports/ambiguous-3.stderr                | 10 +++++-----\n tests/ui/imports/ambiguous-4.rs                    |  4 ++--\n tests/ui/imports/ambiguous-4.stderr                | 10 +++++-----\n tests/ui/imports/ambiguous-5.rs                    |  4 ++--\n tests/ui/imports/ambiguous-5.stderr                | 10 +++++-----\n tests/ui/imports/ambiguous-6.rs                    |  4 ++--\n tests/ui/imports/ambiguous-6.stderr                | 10 +++++-----\n tests/ui/imports/ambiguous-9.rs                    |  6 +++---\n tests/ui/imports/ambiguous-9.stderr                | 16 ++++++++--------\n tests/ui/imports/ambiguous-panic-globvsglob.rs     |  4 ++--\n tests/ui/imports/ambiguous-panic-globvsglob.stderr | 10 +++++-----\n tests/ui/imports/duplicate.rs                      |  2 +-\n tests/ui/imports/duplicate.stderr                  | 10 +++++-----\n tests/ui/imports/glob-conflict-cross-crate-1.rs    |  6 +++---\n .../ui/imports/glob-conflict-cross-crate-1.stderr  | 16 ++++++++--------\n tests/ui/imports/glob-conflict-cross-crate-2.rs    |  4 ++--\n .../ui/imports/glob-conflict-cross-crate-2.stderr  | 10 +++++-----\n tests/ui/imports/glob-conflict-cross-crate-3.rs    |  6 +++---\n .../ui/imports/glob-conflict-cross-crate-3.stderr  | 16 ++++++++--------\n tests/ui/imports/issue-114682-2.rs                 |  6 +++---\n tests/ui/imports/issue-114682-2.stderr             | 16 ++++++++--------\n tests/ui/imports/issue-114682-4.rs                 |  2 +-\n tests/ui/imports/issue-114682-4.stderr             | 10 +++++-----\n tests/ui/imports/issue-114682-5.rs                 |  2 +-\n tests/ui/imports/issue-114682-5.stderr             | 10 +++++-----\n tests/ui/imports/issue-114682-6.rs                 |  4 ++--\n tests/ui/imports/issue-114682-6.stderr             | 10 +++++-----\n tests/ui/imports/overwrite-different-ambig-2.rs    |  4 +++-\n .../ui/imports/overwrite-different-ambig-2.stderr  | 22 +++++++++++-----------\n tests/ui/imports/unresolved-seg-after-ambiguous.rs |  2 +-\n .../imports/unresolved-seg-after-ambiguous.stderr  | 10 +++++-----\n 49 files changed, 188 insertions(+), 186 deletions(-)","expectedMessage":"Rollup merge of #151130 - diesel2, r\u003dlqd","repository":"rust","commitHash":"256722639d16cd65d5c813b5c083e9bb5063e0ad","metadata":{"author":"Stuart Cook \u003cZalathar@users.noreply.github.com\u003e"}}
{"id":"rust-69f0a498","diff":" compiler/rustc_middle/src/mir/syntax.rs            | 25 +++---\n .../src/builder/matches/match_pair.rs              | 93 ++++++++++++----------\n 2 files changed, 67 insertions(+), 51 deletions(-)","expectedMessage":"Rollup merge of #151103 - array-pat-len, r\u003dNadrieril,petrochenkov","repository":"rust","commitHash":"69f0a498ba504c42a3dedf0431c2b2b40c4e86f4","metadata":{"author":"Stuart Cook \u003cZalathar@users.noreply.github.com\u003e"}}
{"id":"rust-9682509b","diff":" compiler/rustc_hir_typeck/src/pat.rs  | 13 ++++----\n tests/ui/pattern/type_mismatch.rs     | 63 ++++++++++++++++++++++++++++++++++-\n tests/ui/pattern/type_mismatch.stderr | 61 +++++++++++++++++++++++++++++++--\n 3 files changed, 128 insertions(+), 9 deletions(-)","expectedMessage":"Rollup merge of #150979 - typeck-pat, r\u003dlcnr","repository":"rust","commitHash":"9682509bdb909669a673e6d1d534dc21f176cc71","metadata":{"author":"Stuart Cook \u003cZalathar@users.noreply.github.com\u003e"}}
{"id":"rust-eafe40e0","diff":" compiler/rustc_middle/src/thir.rs                  | 14 ++--\n compiler/rustc_middle/src/thir/visit.rs            |  8 +--\n compiler/rustc_mir_build/src/builder/block.rs      | 13 ++--\n .../src/builder/expr/as_constant.rs                |  2 +-\n .../rustc_mir_build/src/builder/expr/as_operand.rs |  9 +--\n .../rustc_mir_build/src/builder/expr/as_place.rs   |  5 +-\n .../rustc_mir_build/src/builder/expr/as_rvalue.rs  |  9 ++-\n .../rustc_mir_build/src/builder/expr/as_temp.rs    | 12 ++--\n compiler/rustc_mir_build/src/builder/expr/into.rs  |  5 +-\n compiler/rustc_mir_build/src/builder/expr/stmt.rs  | 10 +--\n .../rustc_mir_build/src/builder/matches/mod.rs     |  8 +--\n compiler/rustc_mir_build/src/builder/mod.rs        |  4 +-\n compiler/rustc_mir_build/src/builder/scope.rs      | 10 ++-\n compiler/rustc_mir_build/src/check_unsafety.rs     |  2 +-\n compiler/rustc_mir_build/src/thir/cx/block.rs      |  2 +-\n compiler/rustc_mir_build/src/thir/cx/expr.rs       |  4 +-\n .../src/thir/pattern/check_match.rs                | 66 ++++++++-----------\n compiler/rustc_mir_build/src/thir/print.rs         | 12 ++--\n tests/ui/thir-print/c-variadic.stdout              |  2 +-\n tests/ui/thir-print/offset_of.stdout               | 76 +++++++++++-----------\n tests/ui/thir-print/thir-flat-const-variant.stdout | 36 +++-------\n tests/ui/thir-print/thir-flat.stdout               |  4 +-\n tests/ui/thir-print/thir-tree-loop-match.stdout    | 24 +++----\n tests/ui/thir-print/thir-tree-match.stdout         | 20 +++---\n tests/ui/thir-print/thir-tree.stdout               |  2 +-\n tests/ui/unpretty/box.stdout                       |  8 +--\n 26 files changed, 174 insertions(+), 193 deletions(-)\n","expectedMessage":"Rollup merge of #150846 - thir-hir-id, r\u003dlcnr","repository":"rust","commitHash":"eafe40e05c909ea7e5122d9239f5aa245155e54e","metadata":{"author":"Stuart Cook \u003cZalathar@users.noreply.github.com\u003e"}}
{"id":"rust-a6acf0f0","diff":" .github/workflows/ci.yml | 16 ++++------------\n 1 file changed, 4 insertions(+), 12 deletions(-)","expectedMessage":"Auto merge of #150772 - Kobzol:remove-bors-build-finished, r\u003djieyouxu","repository":"rust","commitHash":"a6acf0f07f0ed1c12e26dc0db3b9bf1d0504a0bb","metadata":{"author":"bors \u003cbors@rust-lang.org\u003e"}}
{"id":"rust-c9af9c1d","diff":" compiler/rustc_codegen_llvm/src/attributes.rs      | 11 +-------\n library/alloc/src/slice.rs                         |  8 +++---\n library/alloc/src/vec/mod.rs                       |  6 +----\n .../lib-optimizations/append-elements.rs           | 30 ----------------------\n tests/rustdoc-gui/utils.goml                       | 30 +++++++++++++++++-----\n 5 files changed, 29 insertions(+), 56 deletions(-)","expectedMessage":"Auto merge of #151151 - Zalathar:rollup-kAQYrsB, r\u003dZalathar","repository":"rust","commitHash":"c9af9c1dc85a55e309345030ff9cb7ea247953fa","metadata":{"author":"bors \u003cbors@rust-lang.org\u003e"}}
{"id":"rust-d87e654b","diff":" tests/rustdoc-gui/utils.goml | 30 ++++++++++++++++++++++++------\n 1 file changed, 24 insertions(+), 6 deletions(-)","expectedMessage":"Rollup merge of #151145 - reduce-rustdoc-flakyness, r\u003djieyouxu","repository":"rust","commitHash":"d87e654be974199d8d0068a31643ffcdf6c306e3","metadata":{"author":"Stuart Cook \u003cZalathar@users.noreply.github.com\u003e"}}
{"id":"rust-11b00792","diff":" compiler/rustc_codegen_llvm/src/attributes.rs      | 11 +-------\n library/alloc/src/slice.rs                         |  8 +++---\n library/alloc/src/vec/mod.rs                       |  6 +----\n .../lib-optimizations/append-elements.rs           | 30 ----------------------\n 4 files changed, 5 insertions(+), 50 deletions(-)","expectedMessage":"Rollup merge of #151150 - revert-vec-append, r\u003dZalathar","repository":"rust","commitHash":"11b00792ba5350bf210e5de1d3ed772c636bb5b7","metadata":{"author":"Stuart Cook \u003cZalathar@users.noreply.github.com\u003e"}}
{"id":"rust-cd79ff2e","diff":" compiler/rustc_codegen_llvm/src/attributes.rs      | 11 +-------\n library/alloc/src/slice.rs                         |  8 +++---\n library/alloc/src/vec/mod.rs                       |  6 +----\n .../lib-optimizations/append-elements.rs           | 30 ----------------------\n 4 files changed, 5 insertions(+), 50 deletions(-)\n\ndiff --git a/compiler/rustc_codegen_llvm/src/attributes.rs b/compiler/rustc_codegen_llvm/src/attributes.rs\nindex bf6bb81b53b..a25ce9e5a90 100644\n--- a/compiler/rustc_codegen_llvm/src/attributes.rs\n+++ b/compiler/rustc_codegen_llvm/src/attributes.rs\n@@ -517,16 +517,7 @@ pub(crate) fn llfn_attrs_from_instance\u003c\u0027ll, \u0027tcx\u003e(\n         to_add.push(llvm::CreateAllocKindAttr(cx.llcx, AllocKindFlags::Free));\n         // applies to argument place instead of function place\n         let allocated_pointer \u003d AttributeKind::AllocatedPointer.create_attr(cx.llcx);\n-        let attrs: \u0026[_] \u003d if llvm_util::get_version() \u003e\u003d (21, 0, 0) {\n-            // \"Does not capture provenance\" means \"if the function call stashes the pointer somewhere,\n-            // accessing that pointer after the function returns is UB\". That is definitely the case here since\n-            // freeing will destroy the provenance.\n-            let captures_addr \u003d AttributeKind::CapturesAddress.create_attr(cx.llcx);\n-            \u0026[allocated_pointer, captures_addr]\n-        } else {\n-            \u0026[allocated_pointer]\n-        };\n-        attributes::apply_to_llfn(llfn, AttributePlace::Argument(0), attrs);\n+        attributes::apply_to_llfn(llfn, AttributePlace::Argument(0), \u0026[allocated_pointer]);\n     }\n     if let Some(align) \u003d codegen_fn_attrs.alignment {\n         llvm::set_alignment(llfn, align);\ndiff --git a/library/alloc/src/slice.rs b/library/alloc/src/slice.rs\nindex 58abf4bd657..e7d0fc3454e 100644\n--- a/library/alloc/src/slice.rs\n+++ b/library/alloc/src/slice.rs\n@@ -448,11 +448,9 @@ fn to_vec\u003cA: Allocator\u003e(s: \u0026[Self], alloc: A) -\u003e Vec\u003cSelf, A\u003e {\n                 // SAFETY:\n                 // allocated above with the capacity of `s`, and initialize to `s.len()` in\n                 // ptr::copy_to_non_overlapping below.\n-                if s.len() \u003e 0 {\n-                    unsafe {\n-                        s.as_ptr().copy_to_nonoverlapping(v.as_mut_ptr(), s.len());\n-                        v.set_len(s.len());\n-                    }\n+                unsafe {\n+                    s.as_ptr().copy_to_nonoverlapping(v.as_mut_ptr(), s.len());\n+                    v.set_len(s.len());\n                 }\n                 v\n             }\ndiff --git a/library/alloc/src/vec/mod.rs b/library/alloc/src/vec/mod.rs\nindex ac86399df7a..379e964f0a0 100644\n--- a/library/alloc/src/vec/mod.rs\n+++ b/library/alloc/src/vec/mod.rs\n@@ -2818,11 +2818,7 @@ unsafe fn append_elements(\u0026mut self, other: *const [T]) {\n         let count \u003d other.len();\n         self.reserve(count);\n         let len \u003d self.len();\n-        if count \u003e 0 {\n-            unsafe {\n-                ptr::copy_nonoverlapping(other as *const T, self.as_mut_ptr().add(len), count)\n-            };\n-        }\n+        unsafe { ptr::copy_nonoverlapping(other as *const T, self.as_mut_ptr().add(len), count) };\n         self.len +\u003d count;\n     }\n \ndiff --git a/tests/codegen-llvm/lib-optimizations/append-elements.rs b/tests/codegen-llvm/lib-optimizations/append-elements.rs\ndeleted file mode 100644\nindex 8ee520a131f..00000000000\n--- a/tests/codegen-llvm/lib-optimizations/append-elements.rs\n+++ /dev/null\n@@ -1,30 +0,0 @@\n-//@ compile-flags: -O -Zmerge-functions\u003ddisabled\n-//@ min-llvm-version: 21\n-#![crate_type \u003d \"lib\"]\n-\n-//! Check that a temporary intermediate allocations can eliminated and replaced\n-//! with memcpy forwarding.\n-//! This requires Vec code to be structured in a way that avoids phi nodes from the\n-//! zero-capacity length flowing into the memcpy arguments.\n-\n-// CHECK-LABEL: @vec_append_with_temp_alloc\n-#[no_mangle]\n-pub fn vec_append_with_temp_alloc(dst: \u0026mut Vec\u003cu8\u003e, src: \u0026[u8]) {\n-    // CHECK-NOT: call void @llvm.memcpy\n-    // CHECK: call void @llvm.memcpy.{{.*}}%dst.i{{.*}}%src.0\n-    // CHECK-NOT: call void @llvm.memcpy\n-    let temp \u003d src.to_vec();\n-    dst.extend(\u0026temp);\n-    // CHECK: ret\n-}\n-\n-// CHECK-LABEL: @string_append_with_temp_alloc\n-#[no_mangle]\n-pub fn string_append_with_temp_alloc(dst: \u0026mut String, src: \u0026str) {\n-    // CHECK-NOT: call void @llvm.memcpy\n-    // CHECK: call void @llvm.memcpy.{{.*}}%dst.i{{.*}}%src.0\n-    // CHECK-NOT: call void @llvm.memcpy\n-    let temp \u003d src.to_string();\n-    dst.push_str(\u0026temp);\n-    // CHECK: ret\n-}","expectedMessage":"Revert \"avoid phi node for pointers flowing into Vec appends #130998\"","repository":"rust","commitHash":"cd79ff2e2c804c626c5ab0dce701077afc35db83","metadata":{"author":"Jieyou Xu \u003cjieyouxu@outlook.com\u003e"}}
{"id":"rust-8868b479","diff":" compiler/rustc_middle/src/thir.rs                       |  6 ------\n compiler/rustc_mir_build/src/builder/block.rs           |  1 +\n compiler/rustc_mir_build/src/builder/expr/as_operand.rs |  1 +\n compiler/rustc_mir_build/src/builder/expr/as_place.rs   |  1 +\n compiler/rustc_mir_build/src/builder/expr/as_rvalue.rs  |  1 +\n compiler/rustc_mir_build/src/builder/expr/as_temp.rs    |  2 +-\n compiler/rustc_mir_build/src/builder/expr/into.rs       |  1 +\n compiler/rustc_mir_build/src/builder/expr/stmt.rs       |  2 +-\n compiler/rustc_mir_build/src/builder/matches/mod.rs     |  2 +-\n compiler/rustc_mir_build/src/builder/mod.rs             |  4 ++--\n compiler/rustc_mir_build/src/builder/scope.rs           | 10 +++++++++-\n 11 files changed, 19 insertions(+), 12 deletions(-)\n\ndiff --git a/compiler/rustc_middle/src/thir.rs b/compiler/rustc_middle/src/thir.rs\nindex 86bd6fb803b..86c19520e07 100644\n--- a/compiler/rustc_middle/src/thir.rs\n+++ b/compiler/rustc_middle/src/thir.rs\n@@ -116,12 +116,6 @@ pub struct Param\u003c\u0027tcx\u003e {\n     pub hir_id: Option\u003cHirId\u003e,\n }\n \n-#[derive(Copy, Clone, Debug, HashStable)]\n-pub enum LintLevel {\n-    Inherited,\n-    Explicit(HirId),\n-}\n-\n #[derive(Clone, Debug, HashStable)]\n pub struct Block {\n     /// Whether the block itself has a label. Used by `label: {}`\ndiff --git a/compiler/rustc_mir_build/src/builder/block.rs b/compiler/rustc_mir_build/src/builder/block.rs\nindex d8837d2b195..bfbb6fa7d16 100644\n--- a/compiler/rustc_mir_build/src/builder/block.rs\n+++ b/compiler/rustc_mir_build/src/builder/block.rs\n@@ -7,6 +7,7 @@\n \n use crate::builder::ForGuard::OutsideGuard;\n use crate::builder::matches::{DeclareLetBindings, ScheduleDrops};\n+use crate::builder::scope::LintLevel;\n use crate::builder::{BlockAnd, BlockAndExtension, BlockFrame, Builder};\n \n impl\u003c\u0027a, \u0027tcx\u003e Builder\u003c\u0027a, \u0027tcx\u003e {\ndiff --git a/compiler/rustc_mir_build/src/builder/expr/as_operand.rs b/compiler/rustc_mir_build/src/builder/expr/as_operand.rs\nindex c9c166b7f01..d2f06cc9d57 100644\n--- a/compiler/rustc_mir_build/src/builder/expr/as_operand.rs\n+++ b/compiler/rustc_mir_build/src/builder/expr/as_operand.rs\n@@ -6,6 +6,7 @@\n use tracing::{debug, instrument};\n \n use crate::builder::expr::category::Category;\n+use crate::builder::scope::LintLevel;\n use crate::builder::{BlockAnd, BlockAndExtension, Builder, NeedsTemporary};\n \n impl\u003c\u0027a, \u0027tcx\u003e Builder\u003c\u0027a, \u0027tcx\u003e {\ndiff --git a/compiler/rustc_mir_build/src/builder/expr/as_place.rs b/compiler/rustc_mir_build/src/builder/expr/as_place.rs\nindex db9aa3cd870..139c6da29d4 100644\n--- a/compiler/rustc_mir_build/src/builder/expr/as_place.rs\n+++ b/compiler/rustc_mir_build/src/builder/expr/as_place.rs\n@@ -16,6 +16,7 @@\n \n use crate::builder::ForGuard::{OutsideGuard, RefWithinGuard};\n use crate::builder::expr::category::Category;\n+use crate::builder::scope::LintLevel;\n use crate::builder::{BlockAnd, BlockAndExtension, Builder, Capture, CaptureMap};\n \n /// The \"outermost\" place that holds this value.\ndiff --git a/compiler/rustc_mir_build/src/builder/expr/as_rvalue.rs b/compiler/rustc_mir_build/src/builder/expr/as_rvalue.rs\nindex 3d1774bd1d6..8de79ab2531 100644\n--- a/compiler/rustc_mir_build/src/builder/expr/as_rvalue.rs\n+++ b/compiler/rustc_mir_build/src/builder/expr/as_rvalue.rs\n@@ -18,6 +18,7 @@\n \n use crate::builder::expr::as_place::PlaceBase;\n use crate::builder::expr::category::{Category, RvalueFunc};\n+use crate::builder::scope::LintLevel;\n use crate::builder::{BlockAnd, BlockAndExtension, Builder, NeedsTemporary};\n \n impl\u003c\u0027a, \u0027tcx\u003e Builder\u003c\u0027a, \u0027tcx\u003e {\ndiff --git a/compiler/rustc_mir_build/src/builder/expr/as_temp.rs b/compiler/rustc_mir_build/src/builder/expr/as_temp.rs\nindex 2aace64062c..55296c647c8 100644\n--- a/compiler/rustc_mir_build/src/builder/expr/as_temp.rs\n+++ b/compiler/rustc_mir_build/src/builder/expr/as_temp.rs\n@@ -7,7 +7,7 @@\n use rustc_middle::thir::*;\n use tracing::{debug, instrument};\n \n-use crate::builder::scope::DropKind;\n+use crate::builder::scope::{DropKind, LintLevel};\n use crate::builder::{BlockAnd, BlockAndExtension, Builder};\n \n impl\u003c\u0027a, \u0027tcx\u003e Builder\u003c\u0027a, \u0027tcx\u003e {\ndiff --git a/compiler/rustc_mir_build/src/builder/expr/into.rs b/compiler/rustc_mir_build/src/builder/expr/into.rs\nindex 9731f0de135..60e05b691a8 100644\n--- a/compiler/rustc_mir_build/src/builder/expr/into.rs\n+++ b/compiler/rustc_mir_build/src/builder/expr/into.rs\n@@ -16,6 +16,7 @@\n \n use crate::builder::expr::category::{Category, RvalueFunc};\n use crate::builder::matches::{DeclareLetBindings, HasMatchGuard};\n+use crate::builder::scope::LintLevel;\n use crate::builder::{BlockAnd, BlockAndExtension, BlockFrame, Builder, NeedsTemporary};\n use crate::errors::{LoopMatchArmWithGuard, LoopMatchUnsupportedType};\n \ndiff --git a/compiler/rustc_mir_build/src/builder/expr/stmt.rs b/compiler/rustc_mir_build/src/builder/expr/stmt.rs\nindex f28e483b6a5..3d603afbaa4 100644\n--- a/compiler/rustc_mir_build/src/builder/expr/stmt.rs\n+++ b/compiler/rustc_mir_build/src/builder/expr/stmt.rs\n@@ -5,7 +5,7 @@\n use rustc_span::source_map::Spanned;\n use tracing::debug;\n \n-use crate::builder::scope::BreakableTarget;\n+use crate::builder::scope::{BreakableTarget, LintLevel};\n use crate::builder::{BlockAnd, BlockAndExtension, BlockFrame, Builder};\n \n impl\u003c\u0027a, \u0027tcx\u003e Builder\u003c\u0027a, \u0027tcx\u003e {\ndiff --git a/compiler/rustc_mir_build/src/builder/matches/mod.rs b/compiler/rustc_mir_build/src/builder/matches/mod.rs\nindex 49caee4a189..565d97fa68b 100644\n--- a/compiler/rustc_mir_build/src/builder/matches/mod.rs\n+++ b/compiler/rustc_mir_build/src/builder/matches/mod.rs\n@@ -29,7 +29,7 @@\n use crate::builder::expr::as_place::PlaceBuilder;\n use crate::builder::matches::buckets::PartitionedCandidates;\n use crate::builder::matches::user_ty::ProjectedUserTypesNode;\n-use crate::builder::scope::DropKind;\n+use crate::builder::scope::{DropKind, LintLevel};\n use crate::builder::{\n     BlockAnd, BlockAndExtension, Builder, GuardFrame, GuardFrameLocal, LocalsForNode,\n };\ndiff --git a/compiler/rustc_mir_build/src/builder/mod.rs b/compiler/rustc_mir_build/src/builder/mod.rs\nindex 40f1fe0d5d1..132062961da 100644\n--- a/compiler/rustc_mir_build/src/builder/mod.rs\n+++ b/compiler/rustc_mir_build/src/builder/mod.rs\n@@ -38,14 +38,14 @@\n use rustc_middle::hir::place::PlaceBase as HirPlaceBase;\n use rustc_middle::middle::region;\n use rustc_middle::mir::*;\n-use rustc_middle::thir::{self, ExprId, LintLevel, LocalVarId, Param, ParamId, PatKind, Thir};\n+use rustc_middle::thir::{self, ExprId, LocalVarId, Param, ParamId, PatKind, Thir};\n use rustc_middle::ty::{self, ScalarInt, Ty, TyCtxt, TypeVisitableExt, TypingMode};\n use rustc_middle::{bug, span_bug};\n use rustc_session::lint;\n use rustc_span::{Span, Symbol, sym};\n \n use crate::builder::expr::as_place::PlaceBuilder;\n-use crate::builder::scope::DropKind;\n+use crate::builder::scope::{DropKind, LintLevel};\n use crate::errors;\n \n pub(crate) fn closure_saved_names_of_captured_variables\u003c\u0027tcx\u003e(\ndiff --git a/compiler/rustc_mir_build/src/builder/scope.rs b/compiler/rustc_mir_build/src/builder/scope.rs\nindex 98170405253..b10df60e0f7 100644\n--- a/compiler/rustc_mir_build/src/builder/scope.rs\n+++ b/compiler/rustc_mir_build/src/builder/scope.rs\n@@ -89,7 +89,7 @@\n use rustc_index::{IndexSlice, IndexVec};\n use rustc_middle::middle::region;\n use rustc_middle::mir::{self, *};\n-use rustc_middle::thir::{AdtExpr, AdtExprBase, ArmId, ExprId, ExprKind, LintLevel};\n+use rustc_middle::thir::{AdtExpr, AdtExprBase, ArmId, ExprId, ExprKind};\n use rustc_middle::ty::{self, Ty, TyCtxt, TypeVisitableExt, ValTree};\n use rustc_middle::{bug, span_bug};\n use rustc_pattern_analysis::rustc::RustcPatCtxt;\n@@ -522,6 +522,14 @@ fn topmost(\u0026self) -\u003e region::Scope {\n     }\n }\n \n+/// Used by [`Builder::in_scope`] to create source scopes mapping from MIR back to HIR at points\n+/// where lint levels change.\n+#[derive(Copy, Clone, Debug)]\n+pub(crate) enum LintLevel {\n+    Inherited,\n+    Explicit(HirId),\n+}\n+\n impl\u003c\u0027a, \u0027tcx\u003e Builder\u003c\u0027a, \u0027tcx\u003e {\n     // Adding and removing scopes\n     // \u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d","expectedMessage":"move `LintLevel` to `rustc_mir_build`","repository":"rust","commitHash":"8868b479a81cdf27e7493c2ac41d2b7efa2dbe89","metadata":{"author":"dianne \u003cdiannes.gm@gmail.com\u003e"}}
{"id":"rust-4bacdf7b","diff":" tests/rustdoc-gui/utils.goml | 30 ++++++++++++++++++++++++------\n 1 file changed, 24 insertions(+), 6 deletions(-)\n\ndiff --git a/tests/rustdoc-gui/utils.goml b/tests/rustdoc-gui/utils.goml\nindex c0625ead2f1..c5c8ab3b1af 100644\n--- a/tests/rustdoc-gui/utils.goml\n+++ b/tests/rustdoc-gui/utils.goml\n@@ -29,9 +29,18 @@ define-function: (\n     \"open-settings-menu\",\n     [],\n     block {\n-        call-function: (\"click-settings-button\", {})\n-        // Wait for the popover to appear...\n-        wait-for-css: (\"#settings\", {\"display\": \"block\"})\n+        store-count: (\"#settings\", nb_settings_menu)\n+        if: (|nb_settings_menu| !\u003d 0, block {\n+            store-css: (\"#settings\", {\"display\": settings_display})\n+        })\n+        else: block {\n+            store-value: (settings_display, \"none\")\n+        }\n+        if: (|settings_display| !\u003d \"block\", block {\n+            call-function: (\"click-settings-button\", {})\n+            // Wait for the popover to appear...\n+            wait-for-css: (\"#settings\", {\"display\": \"block\"})\n+        })\n     }\n )\n \n@@ -39,9 +48,18 @@ define-function: (\n     \"close-settings-menu\",\n     [],\n     block {\n-        call-function: (\"click-settings-button\", {})\n-        // Wait for the popover to disappear...\n-        wait-for-css-false: (\"#settings\", {\"display\": \"block\"})\n+        store-count: (\"#settings\", nb_settings_menu)\n+        if: (|nb_settings_menu| !\u003d 0, block {\n+            store-css: (\"#settings\", {\"display\": settings_display})\n+        })\n+        else: block {\n+            store-value: (settings_display, \"block\")\n+        }\n+        if: (|settings_display| \u003d\u003d \"block\", block {\n+            call-function: (\"click-settings-button\", {})\n+            // Wait for the popover to disappear...\n+            wait-for-css-false: (\"#settings\", {\"display\": \"block\"})\n+        })\n     }\n )\n ","expectedMessage":"Reduce rustdoc GUI flakyness, take 2","repository":"rust","commitHash":"4bacdf7b8b9046507ef5ae3bcb349d54fb827b0d","metadata":{"author":"Guillaume Gomez \u003cguillaume1.gomez@gmail.com\u003e"}}
{"id":"rust-b6fdaf2a","diff":" .mailmap                                           |   1 +\n INSTALL.md                                         |   2 +-\n compiler/rustc_attr_parsing/src/attributes/cfg.rs  |   1 -\n compiler/rustc_attr_parsing/src/attributes/doc.rs  |   6 -\n compiler/rustc_attr_parsing/src/parser.rs          |   8 +-\n compiler/rustc_borrowck/src/type_check/mod.rs      |  67 +--\n compiler/rustc_builtin_macros/messages.ftl         |   2 +\n compiler/rustc_builtin_macros/src/eii.rs           |  94 ++--\n compiler/rustc_builtin_macros/src/errors.rs        |  10 +\n compiler/rustc_codegen_llvm/src/mono_item.rs       |   2 +-\n compiler/rustc_codegen_llvm/src/va_arg.rs          |   9 -\n compiler/rustc_hir_analysis/src/collect.rs         |   8 +-\n .../src/errors/wrong_number_of_generic_args.rs     |   3 +\n .../src/hir_ty_lowering/bounds.rs                  |  35 +-\n .../rustc_hir_analysis/src/hir_ty_lowering/mod.rs  | 136 +++--\n compiler/rustc_hir_analysis/src/lib.rs             |   6 +-\n compiler/rustc_hir_typeck/src/expr.rs              |   4 +-\n compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs     |  13 +-\n compiler/rustc_hir_typeck/src/method/confirm.rs    |   7 +-\n compiler/rustc_parse/src/parser/generics.rs        |  26 +-\n compiler/rustc_parse/src/parser/item.rs            |   1 +\n compiler/rustc_resolve/src/diagnostics.rs          |   4 +-\n compiler/rustc_resolve/src/imports.rs              |  23 +-\n compiler/rustc_span/src/symbol.rs                  |   1 -\n compiler/rustc_target/src/asm/mod.rs               |   2 +-\n compiler/rustc_target/src/callconv/mod.rs          |   2 +-\n compiler/rustc_target/src/spec/mod.rs              |   7 +-\n compiler/rustc_target/src/target_features.rs       |   8 +-\n library/std/src/sys/thread/unix.rs                 |   9 +\n src/bootstrap/Cargo.toml                           |   2 +-\n src/build_helper/Cargo.toml                        |   7 +-\n src/build_helper/src/lib.rs                        |   1 +\n src/ci/citool/Cargo.toml                           |   2 +-\n src/librustdoc/clean/mod.rs                        |  50 +-\n src/librustdoc/passes/collect_intra_doc_links.rs   | 624 +++++++++++----------\n src/tools/miri/src/shims/alloc.rs                  |   1 -\n src/tools/opt-dist/Cargo.toml                      |   2 +-\n tests/rustdoc-html/intra-doc/adt-through-alias.rs  |  71 +++\n tests/rustdoc-html/intra-doc/associated-items.rs   |   9 +-\n .../associated-const-bindings/ambiguity.stderr     |   6 +\n tests/ui/const-generics/incorrect-const-param.rs   |  45 ++\n .../ui/const-generics/incorrect-const-param.stderr |  70 +++\n .../mgca/tuple_expr_arg_bad-issue-151048.rs        |   8 +\n .../mgca/tuple_expr_arg_bad-issue-151048.stderr    |   8 +\n tests/ui/eii/error_statement_position.rs           |  15 +-\n tests/ui/eii/error_statement_position.stderr       |  13 +-\n tests/ui/generics/wrong-number-of-args-in-macro.rs |  15 +\n .../generics/wrong-number-of-args-in-macro.stderr  |  44 ++\n tests/ui/hygiene/cross-crate-redefine.rs           |   2 +-\n tests/ui/hygiene/cross-crate-redefine.stderr       |   7 +-\n tests/ui/imports/overwrite-deep-glob.rs            |  22 +\n tests/ui/imports/overwrite-deep-glob.stderr        |  12 +\n tests/ui/imports/overwrite-different-ambig-2.rs    |  24 +\n .../ui/imports/overwrite-different-ambig-2.stderr  |  49 ++\n tests/ui/imports/overwrite-different-ambig.rs      |  25 +\n tests/ui/imports/overwrite-different-vis.rs        |  21 +\n .../imports/overwrite-different-warn-ambiguity.rs  |  28 +\n .../macro/kw-in-const-item-pos-recovery-149692.rs  |  11 +\n .../kw-in-const-item-pos-recovery-149692.stderr    |  11 +\n .../parser/macro/kw-in-item-pos-recovery-149692.rs |  19 +\n .../macro/kw-in-item-pos-recovery-149692.stderr    |  29 +\n 61 files changed, 1140 insertions(+), 610 deletions(-)","expectedMessage":"Auto merge of #151144 - JonathanBrouwer:rollup-QW4Ug5q, r\u003dJonathanBrouwer","repository":"rust","commitHash":"b6fdaf2a15736cbccf248b532f48e33179614d40","metadata":{"author":"bors \u003cbors@rust-lang.org\u003e"}}
{"id":"rust-4523c2ef","diff":" INSTALL.md | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)","expectedMessage":"Rollup merge of #151138 - fix-install-lld, r\u003dKobzol","repository":"rust","commitHash":"4523c2eff436e918e6facd7eba30e260fbd73602","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-1a1056ff","diff":" .mailmap | 1 +\n 1 file changed, 1 insertion(+)","expectedMessage":"Rollup merge of #151128 - new-bors-mailmap, r\u003dlqd","repository":"rust","commitHash":"1a1056ff761e940ed8fa53d4d9393b6a5413e77c","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-c7f7c3fc","diff":" compiler/rustc_attr_parsing/src/attributes/cfg.rs | 1 -\n compiler/rustc_attr_parsing/src/attributes/doc.rs | 6 ------\n compiler/rustc_attr_parsing/src/parser.rs         | 8 +++-----\n 3 files changed, 3 insertions(+), 12 deletions(-)","expectedMessage":"Rollup merge of #151127 - delete_variant, r\u003dJonathanBrouwer","repository":"rust","commitHash":"c7f7c3fc219b7a048dfedfbbde354678ce792a13","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-92737cab","diff":" src/bootstrap/Cargo.toml      | 2 +-\n src/build_helper/Cargo.toml   | 7 +++++--\n src/build_helper/src/lib.rs   | 1 +\n src/ci/citool/Cargo.toml      | 2 +-\n src/tools/opt-dist/Cargo.toml | 2 +-\n 5 files changed, 9 insertions(+), 5 deletions(-)","expectedMessage":"Rollup merge of #151117 - reduce_deps, r\u003dKobzol","repository":"rust","commitHash":"92737cab34ec2ce9e11ec208d5f3d804e5396f26","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-00501de1","diff":" compiler/rustc_parse/src/parser/generics.rs        | 26 +++++++-\n tests/ui/const-generics/incorrect-const-param.rs   | 45 ++++++++++++++\n .../ui/const-generics/incorrect-const-param.stderr | 70 ++++++++++++++++++++++\n 3 files changed, 140 insertions(+), 1 deletion(-)","expectedMessage":"Rollup merge of #151099 - issue-84327-2, r\u003dfmease","repository":"rust","commitHash":"00501de1c801221282ea2a048ddec31d48997650","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-daae6601","diff":" compiler/rustc_builtin_macros/src/eii.rs | 3 +++\n 1 file changed, 3 insertions(+)\n","expectedMessage":"Rollup merge of #151046 - semiopaque-eii-fix, r\u003djdonszelmann","repository":"rust","commitHash":"daae6601be4eca73dd75ccb983a15485d4515196","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-2c17e0e1","diff":" library/std/src/sys/thread/unix.rs | 9 +++++++++\n 1 file changed, 9 insertions(+)\n","expectedMessage":"Rollup merge of #151016 - fix_wasi_threading, r\u003dalexcrichton","repository":"rust","commitHash":"2c17e0e11096135d50abfbffc5173c7289747ece","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-46d4bbf6","diff":" compiler/rustc_builtin_macros/messages.ftl   |  2 +\n compiler/rustc_builtin_macros/src/eii.rs     | 91 +++++++++-------------------\n compiler/rustc_builtin_macros/src/errors.rs  | 10 +++\n tests/ui/eii/error_statement_position.rs     | 15 ++---\n tests/ui/eii/error_statement_position.stderr | 13 +++-\n 5 files changed, 61 insertions(+), 70 deletions(-)","expectedMessage":"Rollup merge of #150971 - disallow-eii-in-statement-position, r\u003dwafflelapkin","repository":"rust","commitHash":"46d4bbf6dff27a475155c7afce79c4850e2e71af","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-d23e780a","diff":" compiler/rustc_codegen_llvm/src/mono_item.rs | 2 +-\n compiler/rustc_codegen_llvm/src/va_arg.rs    | 9 ---------\n compiler/rustc_span/src/symbol.rs            | 1 -\n compiler/rustc_target/src/asm/mod.rs         | 2 +-\n compiler/rustc_target/src/callconv/mod.rs    | 2 +-\n compiler/rustc_target/src/spec/mod.rs        | 7 ++-----\n compiler/rustc_target/src/target_features.rs | 8 +-------\n src/tools/miri/src/shims/alloc.rs            | 1 -\n 8 files changed, 6 insertions(+), 26 deletions(-)\n","expectedMessage":"Rollup merge of #150966 - arch-powerpc64le, r\u003dpetrochenkov","repository":"rust","commitHash":"d23e780a57b5a2a6949d59480e83f83d1e109414","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-27e6ef9f","diff":" compiler/rustc_hir_analysis/src/collect.rs         |   8 +-\n .../src/hir_ty_lowering/bounds.rs                  |  35 +++---\n .../rustc_hir_analysis/src/hir_ty_lowering/mod.rs  | 136 ++++++++++-----------\n compiler/rustc_hir_analysis/src/lib.rs             |   6 +-\n compiler/rustc_hir_typeck/src/expr.rs              |   4 +-\n compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs     |  13 +-\n compiler/rustc_hir_typeck/src/method/confirm.rs    |   7 +-\n src/librustdoc/clean/mod.rs                        |  50 ++++++--\n .../associated-const-bindings/ambiguity.stderr     |   6 +\n .../mgca/tuple_expr_arg_bad-issue-151048.rs        |   8 ++\n .../mgca/tuple_expr_arg_bad-issue-151048.stderr    |   8 ++\n 11 files changed, 163 insertions(+), 118 deletions(-)\n\ndiff --cc compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\nindex a66a521975c,65d2d61e6fc..6e1e6c157a9\n--- a/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\n+++ b/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\n@@@ -2410,15 -2410,12 +2410,11 @@@ impl\u003c\u0027tcx\u003e dyn HirTyLowerer\u003c\u0027tcx\u003e + \u0027_ \n      ) -\u003e Const\u003c\u0027tcx\u003e {\n          let tcx \u003d self.tcx();\n  \n-         let FeedConstTy::WithTy(ty) \u003d feed else {\n-             return Const::new_error_with_message(tcx, array_expr.span, \"unsupported const array\");\n-         };\n- \n          let ty::Array(elem_ty, _) \u003d ty.kind() else {\n -            return Const::new_error_with_message(\n -                tcx,\n -                array_expr.span,\n -                \"const array must have an array type\",\n -            );\n +            let e \u003d tcx\n +                .dcx()\n +                .span_err(array_expr.span, format!(\"expected `{}`, found const array\", ty));\n +            return Const::new_error(tcx, e);\n          };\n  \n          let elems \u003d array_expr","expectedMessage":"Rollup merge of #150962 - rm/feed_const_ty, r\u003dBoxyUwU","repository":"rust","commitHash":"27e6ef9f6dcbe179513d3ca9f2c1969bacd28bd4","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-6cdcef54","diff":" compiler/rustc_resolve/src/diagnostics.rs          |  4 +-\n compiler/rustc_resolve/src/imports.rs              | 23 ++++++----\n tests/ui/hygiene/cross-crate-redefine.rs           |  2 +-\n tests/ui/hygiene/cross-crate-redefine.stderr       |  7 ++--\n tests/ui/imports/overwrite-deep-glob.rs            | 22 ++++++++++\n tests/ui/imports/overwrite-deep-glob.stderr        | 12 ++++++\n tests/ui/imports/overwrite-different-ambig-2.rs    | 24 +++++++++++\n .../ui/imports/overwrite-different-ambig-2.stderr  | 49 ++++++++++++++++++++++\n tests/ui/imports/overwrite-different-ambig.rs      | 25 +++++++++++\n tests/ui/imports/overwrite-different-vis.rs        | 21 ++++++++++\n .../imports/overwrite-different-warn-ambiguity.rs  | 28 +++++++++++++\n 11 files changed, 202 insertions(+), 15 deletions(-)","expectedMessage":"Rollup merge of #150939 - impasse, r\u003destebank","repository":"rust","commitHash":"6cdcef5454e0a315ba643ffa0e416ec3783a29a3","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-7cab6434","diff":" compiler/rustc_borrowck/src/type_check/mod.rs | 67 ++++-----------------------\n 1 file changed, 9 insertions(+), 58 deletions(-)","expectedMessage":"Rollup merge of #150817 - cleanup-inline-const-pat-borrowck, r\u003dlcnr","repository":"rust","commitHash":"7cab6434610cb60a3861b2256d0e2d91b3fddc61","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-9ef76797","diff":" compiler/rustc_parse/src/parser/item.rs            |  1 +\n .../macro/kw-in-const-item-pos-recovery-149692.rs  | 11 ++++++++\n .../kw-in-const-item-pos-recovery-149692.stderr    | 11 ++++++++\n .../parser/macro/kw-in-item-pos-recovery-149692.rs | 19 ++++++++++++++\n .../macro/kw-in-item-pos-recovery-149692.stderr    | 29 ++++++++++++++++++++++\n 5 files changed, 71 insertions(+)\n","expectedMessage":"Rollup merge of #150590 - ident-kw-ice, r\u003dpetrochenkov","repository":"rust","commitHash":"9ef76797eab421ff16925fb16df164c05682e77b","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-e04af736","diff":" src/librustdoc/passes/collect_intra_doc_links.rs  | 624 +++++++++++-----------\n tests/rustdoc-html/intra-doc/adt-through-alias.rs |  71 +++\n tests/rustdoc-html/intra-doc/associated-items.rs  |   9 +-\n 3 files changed, 400 insertions(+), 304 deletions(-)\n","expectedMessage":"Rollup merge of #150586 - intra-doc-assoc-alias, r\u003dGuillaumeGomez","repository":"rust","commitHash":"e04af73628147a98c6855075ad1f9e3a6920c3e5","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-a496d1de","diff":" .../src/errors/wrong_number_of_generic_args.rs     |  3 ++\n tests/ui/generics/wrong-number-of-args-in-macro.rs | 15 ++++++++\n .../generics/wrong-number-of-args-in-macro.stderr  | 44 ++++++++++++++++++++++\n 3 files changed, 62 insertions(+)","expectedMessage":"Rollup merge of #150585 - issue-149559, r\u003dpetrochenkov","repository":"rust","commitHash":"a496d1de668953f3374b7bf10b66c861acc91802","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
{"id":"rust-436fb87e","diff":" INSTALL.md | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/INSTALL.md b/INSTALL.md\nindex 98eb825cd10..dd6c64b3df5 100644\n--- a/INSTALL.md\n+++ b/INSTALL.md\n@@ -97,7 +97,7 @@ See [the rustc-dev-guide for more info][sysllvm].\n       --set llvm.ninja\u003dfalse \\\n       --set rust.debug-assertions\u003dfalse \\\n       --set rust.jemalloc \\\n-      --set rust.use-lld\u003dtrue \\\n+      --set rust.bootstrap-override-lld\u003dtrue \\\n       --set rust.lto\u003dthin \\\n       --set rust.codegen-units\u003d1\n    ```","expectedMessage":"Rename `rust.use-lld` to `rust.bootstrap-override-lld` in INSTALL.md","repository":"rust","commitHash":"436fb87eeb833f8986ca520311e91f32ed0c32e2","metadata":{"author":"Zijie Zhao \u003czijie4@illinois.edu\u003e"}}
{"id":"rust-1028c7a6","diff":" compiler/rustc_hir_typeck/src/pat.rs  | 13 ++++----\n tests/ui/pattern/type_mismatch.rs     | 63 ++++++++++++++++++++++++++++++++++-\n tests/ui/pattern/type_mismatch.stderr | 61 +++++++++++++++++++++++++++++++--\n 3 files changed, 128 insertions(+), 9 deletions(-)\n\ndiff --git a/compiler/rustc_hir_typeck/src/pat.rs b/compiler/rustc_hir_typeck/src/pat.rs\nindex 90e22b2cd38..b56ab6dcb4a 100644\n--- a/compiler/rustc_hir_typeck/src/pat.rs\n+++ b/compiler/rustc_hir_typeck/src/pat.rs\n@@ -1512,11 +1512,14 @@ fn check_pat_struct(\n         pat_info: PatInfo\u003c\u0027tcx\u003e,\n     ) -\u003e Ty\u003c\u0027tcx\u003e {\n         // Type-check the path.\n-        let _ \u003d self.demand_eqtype_pat(pat.span, expected, pat_ty, \u0026pat_info.top_info);\n+        let had_err \u003d self.demand_eqtype_pat(pat.span, expected, pat_ty, \u0026pat_info.top_info);\n \n         // Type-check subpatterns.\n         match self.check_struct_pat_fields(pat_ty, pat, variant, fields, has_rest_pat, pat_info) {\n-            Ok(()) \u003d\u003e pat_ty,\n+            Ok(()) \u003d\u003e match had_err {\n+                Ok(()) \u003d\u003e pat_ty,\n+                Err(guar) \u003d\u003e Ty::new_error(self.tcx, guar),\n+            },\n             Err(guar) \u003d\u003e Ty::new_error(self.tcx, guar),\n         }\n     }\n@@ -1764,8 +1767,7 @@ fn check_pat_tuple_struct(\n         };\n \n         // Type-check the tuple struct pattern against the expected type.\n-        let diag \u003d self.demand_eqtype_pat_diag(pat.span, expected, pat_ty, \u0026pat_info.top_info);\n-        let had_err \u003d diag.map_err(|diag| diag.emit());\n+        let had_err \u003d self.demand_eqtype_pat(pat.span, expected, pat_ty, \u0026pat_info.top_info);\n \n         // Type-check subpatterns.\n         if subpats.len() \u003d\u003d variant.fields.len()\n@@ -1989,11 +1991,10 @@ fn check_pat_tuple(\n         if let Err(reported) \u003d self.demand_eqtype_pat(span, expected, pat_ty, \u0026pat_info.top_info) {\n             // Walk subpatterns with an expected type of `err` in this case to silence\n             // further errors being emitted when using the bindings. #50333\n-            let element_tys_iter \u003d (0..max_len).map(|_| Ty::new_error(tcx, reported));\n             for (_, elem) in elements.iter().enumerate_and_adjust(max_len, ddpos) {\n                 self.check_pat(elem, Ty::new_error(tcx, reported), pat_info);\n             }\n-            Ty::new_tup_from_iter(tcx, element_tys_iter)\n+            Ty::new_error(tcx, reported)\n         } else {\n             for (i, elem) in elements.iter().enumerate_and_adjust(max_len, ddpos) {\n                 self.check_pat(elem, element_tys[i], pat_info);\ndiff --git a/tests/ui/pattern/type_mismatch.rs b/tests/ui/pattern/type_mismatch.rs\nindex 408ff758847..39d57301e98 100644\n--- a/tests/ui/pattern/type_mismatch.rs\n+++ b/tests/ui/pattern/type_mismatch.rs\n@@ -1,4 +1,4 @@\n-//! This test used to ICE: rust-lang/rust#109812\n+//! These tests used to ICE: rust-lang/rust#109812, rust-lang/rust#150507\n //! Instead of actually analyzing the erroneous patterns,\n //! we instead stop after typeck where errors are already\n //! reported.\n@@ -8,12 +8,21 @@\n enum Either {\n     One(X),\n     Two(X),\n+    Three { a: X },\n }\n \n struct X(Y);\n \n struct Y;\n \n+struct Z(*const i32);\n+unsafe impl Send for Z {}\n+\n+enum Meow {\n+    A { a: Z },\n+    B(Z),\n+}\n+\n fn consume_fnmut(_: impl FnMut()) {}\n \n fn move_into_fnmut() {\n@@ -25,6 +34,58 @@ fn move_into_fnmut() {\n \n         let X(mut _t) \u003d x;\n     });\n+\n+    consume_fnmut(|| {\n+        let Either::Three { a: ref mut _t } \u003d x;\n+        //~^ ERROR: mismatched types\n+\n+        let X(mut _t) \u003d x;\n+    });\n+}\n+\n+fn tuple_against_array() {\n+    let variant: [();1] \u003d [()];\n+\n+    || match variant {\n+        (2,) \u003d\u003e (),\n+        //~^ ERROR: mismatched types\n+        _ \u003d\u003e {}\n+    };\n+\n+    || {\n+        let ((2,) | _) \u003d variant;\n+        //~^ ERROR: mismatched types\n+    };\n+}\n+\n+// Reproducer that triggers the compatibility lint more reliably, instead of relying on the fact\n+// that at the time of writing, an unresolved integer type variable does not implement any\n+// auto-traits.\n+//\n+// The @_ makes this example also reproduce ICE #150507 before PR #138961\n+fn arcane() {\n+    let variant: [();1] \u003d [()];\n+\n+    || {\n+        match variant {\n+            (Z(y@_),) \u003d\u003e {}\n+            //~^ ERROR: mismatched types\n+        }\n+    };\n+\n+    || {\n+        match variant {\n+            Meow::A { a: Z(y@_) } \u003d\u003e {}\n+            //~^ ERROR: mismatched types\n+        }\n+    };\n+\n+    || {\n+        match variant {\n+            Meow::B(Z(y@_)) \u003d\u003e {}\n+            //~^ ERROR: mismatched types\n+        }\n+    };\n }\n \n fn main() {}\ndiff --git a/tests/ui/pattern/type_mismatch.stderr b/tests/ui/pattern/type_mismatch.stderr\nindex b0441b1fadc..3f24b2e7069 100644\n--- a/tests/ui/pattern/type_mismatch.stderr\n+++ b/tests/ui/pattern/type_mismatch.stderr\n@@ -1,11 +1,68 @@\n error[E0308]: mismatched types\n-  --\u003e $DIR/type_mismatch.rs:23:13\n+  --\u003e $DIR/type_mismatch.rs:32:13\n    |\n LL |         let Either::Two(ref mut _t) \u003d x;\n    |             ^^^^^^^^^^^^^^^^^^^^^^^   - this expression has type `X`\n    |             |\n    |             expected `X`, found `Either`\n \n-error: aborting due to 1 previous error\n+error[E0308]: mismatched types\n+  --\u003e $DIR/type_mismatch.rs:39:13\n+   |\n+LL |         let Either::Three { a: ref mut _t } \u003d x;\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^   - this expression has type `X`\n+   |             |\n+   |             expected `X`, found `Either`\n+\n+error[E0308]: mismatched types\n+  --\u003e $DIR/type_mismatch.rs:50:9\n+   |\n+LL |     || match variant {\n+   |              ------- this expression has type `[(); 1]`\n+LL |         (2,) \u003d\u003e (),\n+   |         ^^^^ expected `[(); 1]`, found `(_,)`\n+   |\n+   \u003d note: expected array `[(); 1]`\n+              found tuple `(_,)`\n+\n+error[E0308]: mismatched types\n+  --\u003e $DIR/type_mismatch.rs:56:14\n+   |\n+LL |         let ((2,) | _) \u003d variant;\n+   |              ^^^^        ------- this expression has type `[(); 1]`\n+   |              |\n+   |              expected `[(); 1]`, found `(_,)`\n+   |\n+   \u003d note: expected array `[(); 1]`\n+              found tuple `(_,)`\n+\n+error[E0308]: mismatched types\n+  --\u003e $DIR/type_mismatch.rs:71:13\n+   |\n+LL |         match variant {\n+   |               ------- this expression has type `[(); 1]`\n+LL |             (Z(y@_),) \u003d\u003e {}\n+   |             ^^^^^^^^^ expected `[(); 1]`, found `(_,)`\n+   |\n+   \u003d note: expected array `[(); 1]`\n+              found tuple `(_,)`\n+\n+error[E0308]: mismatched types\n+  --\u003e $DIR/type_mismatch.rs:78:13\n+   |\n+LL |         match variant {\n+   |               ------- this expression has type `[(); 1]`\n+LL |             Meow::A { a: Z(y@_) } \u003d\u003e {}\n+   |             ^^^^^^^^^^^^^^^^^^^^^ expected `[(); 1]`, found `Meow`\n+\n+error[E0308]: mismatched types\n+  --\u003e $DIR/type_mismatch.rs:85:13\n+   |\n+LL |         match variant {\n+   |               ------- this expression has type `[(); 1]`\n+LL |             Meow::B(Z(y@_)) \u003d\u003e {}\n+   |             ^^^^^^^^^^^^^^^ expected `[(); 1]`, found `Meow`\n+\n+error: aborting due to 7 previous errors\n \n For more information about this error, try `rustc --explain E0308`.","expectedMessage":"Avoid ICEs after bad patterns, for the other syntactic variants","repository":"rust","commitHash":"1028c7a66a718a6421241b3a46268681f79fd597","metadata":{"author":"Maja Kdzioka \u003cmaya@compilercrim.es\u003e"}}
{"id":"rust-92db7b2b","diff":" compiler/rustc_parse/src/parser/generics.rs        | 26 +++++++-\n tests/ui/const-generics/incorrect-const-param.rs   | 45 ++++++++++++++\n .../ui/const-generics/incorrect-const-param.stderr | 70 ++++++++++++++++++++++\n 3 files changed, 140 insertions(+), 1 deletion(-)\n\ndiff --git a/compiler/rustc_parse/src/parser/generics.rs b/compiler/rustc_parse/src/parser/generics.rs\nindex 2c76c0fe358..ef6c9cc344c 100644\n--- a/compiler/rustc_parse/src/parser/generics.rs\n+++ b/compiler/rustc_parse/src/parser/generics.rs\n@@ -109,7 +109,31 @@ pub(crate) fn parse_const_param(\n \n         self.expect_keyword(exp!(Const))?;\n         let ident \u003d self.parse_ident()?;\n-        self.expect(exp!(Colon))?;\n+        if let Err(mut err) \u003d self.expect(exp!(Colon)) {\n+            return if self.token.kind \u003d\u003d token::Comma || self.token.kind \u003d\u003d token::Gt {\n+                // Recover parse from `\u003cconst N\u003e` where the type is missing.\n+                let span \u003d const_span.to(ident.span);\n+                err.span_suggestion_verbose(\n+                    ident.span.shrink_to_hi(),\n+                    \"you likely meant to write the type of the const parameter here\",\n+                    \": /* Type */\".to_string(),\n+                    Applicability::HasPlaceholders,\n+                );\n+                let kind \u003d TyKind::Err(err.emit());\n+                let ty \u003d self.mk_ty(span, kind);\n+                Ok(GenericParam {\n+                    ident,\n+                    id: ast::DUMMY_NODE_ID,\n+                    attrs: preceding_attrs,\n+                    bounds: Vec::new(),\n+                    kind: GenericParamKind::Const { ty, span, default: None },\n+                    is_placeholder: false,\n+                    colon_span: None,\n+                })\n+            } else {\n+                Err(err)\n+            };\n+        }\n         let ty \u003d self.parse_ty()?;\n \n         // Parse optional const generics default value.\ndiff --git a/tests/ui/const-generics/incorrect-const-param.rs b/tests/ui/const-generics/incorrect-const-param.rs\nnew file mode 100644\nindex 00000000000..5f1d8ca2ae9\n--- /dev/null\n+++ b/tests/ui/const-generics/incorrect-const-param.rs\n@@ -0,0 +1,45 @@\n+// #84327\n+\n+struct VecWrapper\u003cT\u003e(Vec\u003cT\u003e);\n+\n+// Correct\n+impl\u003cT, const N: usize\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+where\n+    T: Clone,\n+{\n+    fn from(slice: [T; N]) -\u003e Self {\n+        VecWrapper(slice.to_vec())\n+    }\n+}\n+\n+// Forgot const\n+impl\u003cT, N: usize\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e //~ ERROR expected value, found type parameter `N`\n+where //~^ ERROR expected trait, found builtin type `usize`\n+    T: Clone,\n+{\n+    fn from(slice: [T; N]) -\u003e Self { //~ ERROR expected value, found type parameter `N`\n+        VecWrapper(slice.to_vec())\n+    }\n+}\n+\n+// Forgot type\n+impl\u003cT, const N\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e //~ ERROR expected `:`, found `\u003e`\n+where\n+    T: Clone,\n+{\n+    fn from(slice: [T; N]) -\u003e Self {\n+        VecWrapper(slice.to_vec())\n+    }\n+}\n+\n+// Forgot const and type\n+impl\u003cT, N\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e //~ ERROR expected value, found type parameter `N`\n+where\n+    T: Clone,\n+{\n+    fn from(slice: [T; N]) -\u003e Self { //~ ERROR expected value, found type parameter `N`\n+        VecWrapper(slice.to_vec())\n+    }\n+}\n+\n+fn main() {}\ndiff --git a/tests/ui/const-generics/incorrect-const-param.stderr b/tests/ui/const-generics/incorrect-const-param.stderr\nnew file mode 100644\nindex 00000000000..c5cf54500ee\n--- /dev/null\n+++ b/tests/ui/const-generics/incorrect-const-param.stderr\n@@ -0,0 +1,70 @@\n+error: expected `:`, found `\u003e`\n+  --\u003e $DIR/incorrect-const-param.rs:26:16\n+   |\n+LL | impl\u003cT, const N\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |                ^ expected `:`\n+   |\n+help: you likely meant to write the type of the const parameter here\n+   |\n+LL | impl\u003cT, const N: /* Type */\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |                ++++++++++++\n+\n+error[E0423]: expected value, found type parameter `N`\n+  --\u003e $DIR/incorrect-const-param.rs:16:28\n+   |\n+LL | impl\u003cT, N: usize\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |         -                  ^ not a value\n+   |         |\n+   |         found this type parameter\n+\n+error[E0404]: expected trait, found builtin type `usize`\n+  --\u003e $DIR/incorrect-const-param.rs:16:12\n+   |\n+LL | impl\u003cT, N: usize\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |            ^^^^^ not a trait\n+   |\n+help: you might have meant to write a const parameter here\n+   |\n+LL | impl\u003cT, const N: usize\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |         +++++\n+\n+error[E0423]: expected value, found type parameter `N`\n+  --\u003e $DIR/incorrect-const-param.rs:20:24\n+   |\n+LL | impl\u003cT, N: usize\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |         - found this type parameter\n+...\n+LL |     fn from(slice: [T; N]) -\u003e Self {\n+   |                        ^ not a value\n+\n+error[E0423]: expected value, found type parameter `N`\n+  --\u003e $DIR/incorrect-const-param.rs:36:21\n+   |\n+LL | impl\u003cT, N\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |         -           ^ not a value\n+   |         |\n+   |         found this type parameter\n+   |\n+help: you might have meant to write a const parameter here\n+   |\n+LL | impl\u003cT, const N: /* Type */\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |         +++++  ++++++++++++\n+\n+error[E0423]: expected value, found type parameter `N`\n+  --\u003e $DIR/incorrect-const-param.rs:40:24\n+   |\n+LL | impl\u003cT, N\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |         - found this type parameter\n+...\n+LL |     fn from(slice: [T; N]) -\u003e Self {\n+   |                        ^ not a value\n+   |\n+help: you might have meant to write a const parameter here\n+   |\n+LL | impl\u003cT, const N: /* Type */\u003e From\u003c[T; N]\u003e for VecWrapper\u003cT\u003e\n+   |         +++++  ++++++++++++\n+\n+error: aborting due to 6 previous errors\n+\n+Some errors have detailed explanations: E0404, E0423.\n+For more information about an error, try `rustc --explain E0404`.","expectedMessage":"Recover parse gracefully from `\u003cconst N\u003e`","repository":"rust","commitHash":"92db7b2b5ab89a37a2d7bdd9c8a25fd8be31e303","metadata":{"author":"Esteban Kber \u003cesteban@kuber.com.ar\u003e"}}
{"id":"rust-9f1cf9ef","diff":" .mailmap | 1 +\n 1 file changed, 1 insertion(+)\n\ndiff --git a/.mailmap b/.mailmap\nindex 4c254b396b5..948f1ab14fd 100644\n--- a/.mailmap\n+++ b/.mailmap\n@@ -96,6 +96,7 @@ boolean_coercion \u003cbooleancoercion@gmail.com\u003e\n Boris Egorov \u003cjightuse@gmail.com\u003e \u003cegorov@linux.com\u003e\n bors \u003cbors@rust-lang.org\u003e bors[bot] \u003c26634292+bors[bot]@users.noreply.github.com\u003e\n bors \u003cbors@rust-lang.org\u003e bors[bot] \u003cbors[bot]@users.noreply.github.com\u003e\n+bors \u003cbors@rust-lang.org\u003e \u003c122020455+rust-bors[bot]@users.noreply.github.com\u003e\n BoxyUwU \u003crust@boxyuwu.dev\u003e\n BoxyUwU \u003crust@boxyuwu.dev\u003e \u003csupbscripter@gmail.com\u003e\n Braden Nelson \u003cmoonheart08@users.noreply.github.com\u003e","expectedMessage":"Add temporary new bors e-mail address to the mailmap","repository":"rust","commitHash":"9f1cf9efe0eaa25e76243e23a695b9a042c16c06","metadata":{"author":"Jakub Bernek \u003cberykubik@gmail.com\u003e"}}
{"id":"rust-83c5f2c1","diff":" compiler/rustc_resolve/src/imports.rs              |  9 +++-\n tests/ui/imports/overwrite-different-ambig-2.rs    | 24 +++++++++++\n .../ui/imports/overwrite-different-ambig-2.stderr  | 49 ++++++++++++++++++++++\n 3 files changed, 81 insertions(+), 1 deletion(-)\n\ndiff --git a/compiler/rustc_resolve/src/imports.rs b/compiler/rustc_resolve/src/imports.rs\nindex c3ea408deb8..451779ae32c 100644\n--- a/compiler/rustc_resolve/src/imports.rs\n+++ b/compiler/rustc_resolve/src/imports.rs\n@@ -301,9 +301,12 @@ fn remove_same_import\u003c\u0027ra\u003e(d1: Decl\u003c\u0027ra\u003e, d2: Decl\u003c\u0027ra\u003e) -\u003e (Decl\u003c\u0027ra\u003e, Decl\u003c\u0027ra\n         \u0026\u0026 let DeclKind::Import { import: import2, source_decl: d2_next } \u003d d2.kind\n         \u0026\u0026 import1 \u003d\u003d import2\n     {\n-        assert_eq!(d1.ambiguity.get(), d2.ambiguity.get());\n         assert_eq!(d1.expansion, d2.expansion);\n         assert_eq!(d1.span, d2.span);\n+        if d1.ambiguity.get() !\u003d d2.ambiguity.get() {\n+            assert!(d1.ambiguity.get().is_some());\n+            assert!(d2.ambiguity.get().is_none());\n+        }\n         // Visibility of the new import declaration may be different,\n         // because it already incorporates the visibility of the source binding.\n         // `warn_ambiguity` of a re-fetched glob can also change in both directions.\n@@ -377,6 +380,10 @@ fn select_glob_decl(\n             // assert_ne!(old_deep_decl, deep_decl);\n             // assert!(old_deep_decl.is_glob_import());\n             assert!(!deep_decl.is_glob_import());\n+            if old_glob_decl.ambiguity.get().is_some() \u0026\u0026 glob_decl.ambiguity.get().is_none() {\n+                // Do not lose glob ambiguities when re-fetching the glob.\n+                glob_decl.ambiguity.set_unchecked(old_glob_decl.ambiguity.get());\n+            }\n             if glob_decl.is_ambiguity_recursive() {\n                 glob_decl.warn_ambiguity.set_unchecked(true);\n             }\ndiff --git a/tests/ui/imports/overwrite-different-ambig-2.rs b/tests/ui/imports/overwrite-different-ambig-2.rs\nnew file mode 100644\nindex 00000000000..1b6d20e24d3\n--- /dev/null\n+++ b/tests/ui/imports/overwrite-different-ambig-2.rs\n@@ -0,0 +1,24 @@\n+mod m1 {\n+    mod inner {\n+        pub struct S {}\n+    }\n+    pub use self::inner::*;\n+\n+    #[derive(Debug)]\n+    pub struct S {}\n+}\n+\n+mod m2 {\n+    pub struct S {}\n+}\n+\n+// First we have a glob ambiguity in this glob (with `m2::*`).\n+// Then we re-fetch `m1::*` because non-glob `m1::S` materializes from derive,\n+// and we need to make sure that the glob ambiguity is not lost during re-fetching.\n+use m1::*;\n+use m2::*;\n+\n+fn main() {\n+    let _: m1::S \u003d S {}; //~ ERROR `S` is ambiguous\n+                         //~| WARN this was previously accepted\n+}\ndiff --git a/tests/ui/imports/overwrite-different-ambig-2.stderr b/tests/ui/imports/overwrite-different-ambig-2.stderr\nnew file mode 100644\nindex 00000000000..e75f552d119\n--- /dev/null\n+++ b/tests/ui/imports/overwrite-different-ambig-2.stderr\n@@ -0,0 +1,49 @@\n+error: `S` is ambiguous\n+  --\u003e $DIR/overwrite-different-ambig-2.rs:22:20\n+   |\n+LL |     let _: m1::S \u003d S {};\n+   |                    ^ ambiguous name\n+   |\n+   \u003d warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   \u003d note: for more information, see issue #114095 \u003chttps://github.com/rust-lang/rust/issues/114095\u003e\n+   \u003d note: ambiguous because of multiple glob imports of a name in the same module\n+note: `S` could refer to the struct imported here\n+  --\u003e $DIR/overwrite-different-ambig-2.rs:18:5\n+   |\n+LL | use m1::*;\n+   |     ^^^^^\n+   \u003d help: consider adding an explicit import of `S` to disambiguate\n+note: `S` could also refer to the struct imported here\n+  --\u003e $DIR/overwrite-different-ambig-2.rs:19:5\n+   |\n+LL | use m2::*;\n+   |     ^^^^^\n+   \u003d help: consider adding an explicit import of `S` to disambiguate\n+   \u003d note: `#[deny(ambiguous_glob_imports)]` (part of `#[deny(future_incompatible)]`) on by default\n+\n+error: aborting due to 1 previous error\n+\n+Future incompatibility report: Future breakage diagnostic:\n+error: `S` is ambiguous\n+  --\u003e $DIR/overwrite-different-ambig-2.rs:22:20\n+   |\n+LL |     let _: m1::S \u003d S {};\n+   |                    ^ ambiguous name\n+   |\n+   \u003d warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   \u003d note: for more information, see issue #114095 \u003chttps://github.com/rust-lang/rust/issues/114095\u003e\n+   \u003d note: ambiguous because of multiple glob imports of a name in the same module\n+note: `S` could refer to the struct imported here\n+  --\u003e $DIR/overwrite-different-ambig-2.rs:18:5\n+   |\n+LL | use m1::*;\n+   |     ^^^^^\n+   \u003d help: consider adding an explicit import of `S` to disambiguate\n+note: `S` could also refer to the struct imported here\n+  --\u003e $DIR/overwrite-different-ambig-2.rs:19:5\n+   |\n+LL | use m2::*;\n+   |     ^^^^^\n+   \u003d help: consider adding an explicit import of `S` to disambiguate\n+   \u003d note: `#[deny(ambiguous_glob_imports)]` (part of `#[deny(future_incompatible)]`) on by default\n+","expectedMessage":"resolve: Relax one more assert in glob overwriting and add a test","repository":"rust","commitHash":"83c5f2c19409deb44778bc6ad36a33f3b9ce0f57","metadata":{"author":"Vadim Petrochenkov \u003cvadim.petrochenkov@gmail.com\u003e"}}
{"id":"rust-1c3841b3","diff":" .../imports/overwrite-different-warn-ambiguity.rs  | 28 ++++++++++++++++++++++\n 1 file changed, 28 insertions(+)\n\ndiff --git a/tests/ui/imports/overwrite-different-warn-ambiguity.rs b/tests/ui/imports/overwrite-different-warn-ambiguity.rs\nnew file mode 100644\nindex 00000000000..f843208b37d\n--- /dev/null\n+++ b/tests/ui/imports/overwrite-different-warn-ambiguity.rs\n@@ -0,0 +1,28 @@\n+//@ check-pass\n+//@ edition:2024\n+\n+mod framing {\n+    mod public_message_in {\n+        mod public_message {\n+            mod public_message {\n+                pub struct ConfirmedTranscriptHashInput;\n+            }\n+            mod public_message_in {\n+                use super::*;\n+                #[derive(Debug)]\n+                pub struct ConfirmedTranscriptHashInput;\n+            }\n+            pub use public_message::*;\n+            use public_message_in::*;\n+        }\n+        mod public_message_in {\n+            #[derive(Debug)]\n+            pub struct ConfirmedTranscriptHashInput;\n+        }\n+        pub use public_message::*;\n+        use public_message_in::*;\n+    }\n+    use public_message_in::*;\n+}\n+\n+fn main() {}","expectedMessage":"Add a test for issue 150977","repository":"rust","commitHash":"1c3841b372a248c0e8c405b051050dbef68f1527","metadata":{"author":"Vadim Petrochenkov \u003cvadim.petrochenkov@gmail.com\u003e"}}
{"id":"rust-81ef42d5","diff":" compiler/rustc_resolve/src/diagnostics.rs    | 4 ++--\n compiler/rustc_resolve/src/imports.rs        | 8 ++++----\n tests/ui/hygiene/cross-crate-redefine.rs     | 2 +-\n tests/ui/hygiene/cross-crate-redefine.stderr | 7 +++----\n 4 files changed, 10 insertions(+), 11 deletions(-)\n\ndiff --git a/compiler/rustc_resolve/src/diagnostics.rs b/compiler/rustc_resolve/src/diagnostics.rs\nindex b80011e8c0c..9f13ba1201f 100644\n--- a/compiler/rustc_resolve/src/diagnostics.rs\n+++ b/compiler/rustc_resolve/src/diagnostics.rs\n@@ -212,12 +212,12 @@ pub(crate) fn report_conflict(\n         \u0026mut self,\n         ident: Ident,\n         ns: Namespace,\n-        new_binding: Decl\u003c\u0027ra\u003e,\n         old_binding: Decl\u003c\u0027ra\u003e,\n+        new_binding: Decl\u003c\u0027ra\u003e,\n     ) {\n         // Error on the second of two conflicting names\n         if old_binding.span.lo() \u003e new_binding.span.lo() {\n-            return self.report_conflict(ident, ns, old_binding, new_binding);\n+            return self.report_conflict(ident, ns, new_binding, old_binding);\n         }\n \n         let container \u003d match old_binding.parent_module.unwrap().kind {\ndiff --git a/compiler/rustc_resolve/src/imports.rs b/compiler/rustc_resolve/src/imports.rs\nindex 7c0cbcf1d52..c3ea408deb8 100644\n--- a/compiler/rustc_resolve/src/imports.rs\n+++ b/compiler/rustc_resolve/src/imports.rs\n@@ -348,8 +348,8 @@ pub(crate) fn new_import_decl(\u0026self, decl: Decl\u003c\u0027ra\u003e, import: Import\u003c\u0027ra\u003e) -\u003e De\n     /// decide which one to keep.\n     fn select_glob_decl(\n         \u0026self,\n-        glob_decl: Decl\u003c\u0027ra\u003e,\n         old_glob_decl: Decl\u003c\u0027ra\u003e,\n+        glob_decl: Decl\u003c\u0027ra\u003e,\n         warn_ambiguity: bool,\n     ) -\u003e Decl\u003c\u0027ra\u003e {\n         assert!(glob_decl.is_glob_import());\n@@ -369,7 +369,7 @@ fn select_glob_decl(\n         // with the re-fetched decls.\n         // This is probably incorrect in corner cases, and the outdated decls still get\n         // propagated to other places and get stuck there, but that\u0027s what we have at the moment.\n-        let (deep_decl, old_deep_decl) \u003d remove_same_import(glob_decl, old_glob_decl);\n+        let (old_deep_decl, deep_decl) \u003d remove_same_import(old_glob_decl, glob_decl);\n         if deep_decl !\u003d glob_decl {\n             // Some import layers have been removed, need to overwrite.\n             assert_ne!(old_deep_decl, old_glob_decl);\n@@ -436,7 +436,7 @@ pub(crate) fn try_plant_decl_into_local_module(\n                 match (old_decl.is_glob_import(), decl.is_glob_import()) {\n                     (true, true) \u003d\u003e {\n                         resolution.glob_decl \u003d\n-                            Some(this.select_glob_decl(decl, old_decl, warn_ambiguity));\n+                            Some(this.select_glob_decl(old_decl, decl, warn_ambiguity));\n                     }\n                     (old_glob @ true, false) | (old_glob @ false, true) \u003d\u003e {\n                         let (glob_decl, non_glob_decl) \u003d\n@@ -446,7 +446,7 @@ pub(crate) fn try_plant_decl_into_local_module(\n                             \u0026\u0026 old_glob_decl !\u003d glob_decl\n                         {\n                             resolution.glob_decl \u003d\n-                                Some(this.select_glob_decl(glob_decl, old_glob_decl, false));\n+                                Some(this.select_glob_decl(old_glob_decl, glob_decl, false));\n                         } else {\n                             resolution.glob_decl \u003d Some(glob_decl);\n                         }\ndiff --git a/tests/ui/hygiene/cross-crate-redefine.rs b/tests/ui/hygiene/cross-crate-redefine.rs\nindex e42c5e3de06..a87c933391d 100644\n--- a/tests/ui/hygiene/cross-crate-redefine.rs\n+++ b/tests/ui/hygiene/cross-crate-redefine.rs\n@@ -8,7 +8,7 @@\n use use_by_macro::*;\n \n my_struct!(define);\n-//~^ ERROR the name `MyStruct` is defined multiple times\n my_struct!(define);\n+//~^ ERROR the name `MyStruct` is defined multiple times\n \n fn main() {}\ndiff --git a/tests/ui/hygiene/cross-crate-redefine.stderr b/tests/ui/hygiene/cross-crate-redefine.stderr\nindex c0fd3f4b7eb..8ad7d6d7b08 100644\n--- a/tests/ui/hygiene/cross-crate-redefine.stderr\n+++ b/tests/ui/hygiene/cross-crate-redefine.stderr\n@@ -1,11 +1,10 @@\n error[E0428]: the name `MyStruct` is defined multiple times\n-  --\u003e $DIR/cross-crate-redefine.rs:10:1\n+  --\u003e $DIR/cross-crate-redefine.rs:11:1\n    |\n-LL | my_struct!(define);\n-   | ^^^^^^^^^^^^^^^^^^ `MyStruct` redefined here\n-LL |\n LL | my_struct!(define);\n    | ------------------ previous definition of the type `MyStruct` here\n+LL | my_struct!(define);\n+   | ^^^^^^^^^^^^^^^^^^ `MyStruct` redefined here\n    |\n    \u003d note: `MyStruct` must be defined only once in the type namespace of this module\n    \u003d note: this error originates in the macro `my_struct` (in Nightly builds, run with -Z macro-backtrace for more info)","expectedMessage":"resolve: Consistently use old decls before new decls in interfaces","repository":"rust","commitHash":"81ef42d5b7c4de7e8fa621fff4dc8f4627a581dc","metadata":{"author":"Vadim Petrochenkov \u003cvadim.petrochenkov@gmail.com\u003e"}}
{"id":"rust-8b52c73b","diff":" compiler/rustc_resolve/src/imports.rs         |  6 +++---\n tests/ui/imports/overwrite-deep-glob.rs       | 22 ++++++++++++++++++++++\n tests/ui/imports/overwrite-deep-glob.stderr   | 12 ++++++++++++\n tests/ui/imports/overwrite-different-ambig.rs | 25 +++++++++++++++++++++++++\n tests/ui/imports/overwrite-different-vis.rs   | 21 +++++++++++++++++++++\n 5 files changed, 83 insertions(+), 3 deletions(-)\n\ndiff --git a/compiler/rustc_resolve/src/imports.rs b/compiler/rustc_resolve/src/imports.rs\nindex e525abd00f9..7c0cbcf1d52 100644\n--- a/compiler/rustc_resolve/src/imports.rs\n+++ b/compiler/rustc_resolve/src/imports.rs\n@@ -300,13 +300,13 @@ fn remove_same_import\u003c\u0027ra\u003e(d1: Decl\u003c\u0027ra\u003e, d2: Decl\u003c\u0027ra\u003e) -\u003e (Decl\u003c\u0027ra\u003e, Decl\u003c\u0027ra\n     if let DeclKind::Import { import: import1, source_decl: d1_next } \u003d d1.kind\n         \u0026\u0026 let DeclKind::Import { import: import2, source_decl: d2_next } \u003d d2.kind\n         \u0026\u0026 import1 \u003d\u003d import2\n-        \u0026\u0026 d1.warn_ambiguity.get() \u003d\u003d d2.warn_ambiguity.get()\n     {\n         assert_eq!(d1.ambiguity.get(), d2.ambiguity.get());\n-        assert!(!d1.warn_ambiguity.get());\n         assert_eq!(d1.expansion, d2.expansion);\n         assert_eq!(d1.span, d2.span);\n-        assert_eq!(d1.vis(), d2.vis());\n+        // Visibility of the new import declaration may be different,\n+        // because it already incorporates the visibility of the source binding.\n+        // `warn_ambiguity` of a re-fetched glob can also change in both directions.\n         remove_same_import(d1_next, d2_next)\n     } else {\n         (d1, d2)\ndiff --git a/tests/ui/imports/overwrite-deep-glob.rs b/tests/ui/imports/overwrite-deep-glob.rs\nnew file mode 100644\nindex 00000000000..261b22f6e0a\n--- /dev/null\n+++ b/tests/ui/imports/overwrite-deep-glob.rs\n@@ -0,0 +1,22 @@\n+//@ check-pass\n+\n+mod openssl {\n+    pub use self::handwritten::*;\n+\n+    mod handwritten {\n+        mod m1 {\n+            pub struct S {}\n+        }\n+        mod m2 {\n+            #[derive(Default)]\n+            pub struct S {}\n+        }\n+\n+        pub use self::m1::*; //~ WARN ambiguous glob re-exports\n+        pub use self::m2::*;\n+    }\n+}\n+\n+pub use openssl::*;\n+\n+fn main() {}\ndiff --git a/tests/ui/imports/overwrite-deep-glob.stderr b/tests/ui/imports/overwrite-deep-glob.stderr\nnew file mode 100644\nindex 00000000000..093478c57c9\n--- /dev/null\n+++ b/tests/ui/imports/overwrite-deep-glob.stderr\n@@ -0,0 +1,12 @@\n+warning: ambiguous glob re-exports\n+  --\u003e $DIR/overwrite-deep-glob.rs:15:17\n+   |\n+LL |         pub use self::m1::*;\n+   |                 ^^^^^^^^^^^ the name `S` in the type namespace is first re-exported here\n+LL |         pub use self::m2::*;\n+   |                 ----------- but the name `S` in the type namespace is also re-exported here\n+   |\n+   \u003d note: `#[warn(ambiguous_glob_reexports)]` on by default\n+\n+warning: 1 warning emitted\n+\ndiff --git a/tests/ui/imports/overwrite-different-ambig.rs b/tests/ui/imports/overwrite-different-ambig.rs\nnew file mode 100644\nindex 00000000000..9aee63e1897\n--- /dev/null\n+++ b/tests/ui/imports/overwrite-different-ambig.rs\n@@ -0,0 +1,25 @@\n+//@ check-pass\n+//@ edition:2024\n+\n+mod a {\n+    mod b {\n+        mod c {\n+            pub struct E;\n+        }\n+        mod d {\n+            mod c {\n+                pub struct E;\n+            }\n+            mod d {\n+                #[derive(Debug)]\n+                pub struct E;\n+            }\n+            pub use c::*;\n+            use d::*;\n+        }\n+        use c::*;\n+        use d::*;\n+    }\n+}\n+\n+fn main() {}\ndiff --git a/tests/ui/imports/overwrite-different-vis.rs b/tests/ui/imports/overwrite-different-vis.rs\nnew file mode 100644\nindex 00000000000..edcc441bcb7\n--- /dev/null\n+++ b/tests/ui/imports/overwrite-different-vis.rs\n@@ -0,0 +1,21 @@\n+//@ check-pass\n+\n+mod b {\n+    pub mod http {\n+        pub struct HeaderMap;\n+    }\n+\n+    pub(crate) use self::http::*;\n+    #[derive(Debug)]\n+    pub struct HeaderMap;\n+}\n+\n+mod a {\n+    pub use crate::b::*;\n+\n+    fn check_type() {\n+        let _: HeaderMap \u003d crate::b::HeaderMap;\n+    }\n+}\n+\n+fn main() {}","expectedMessage":"resolve: Relax some asserts in glob overwriting and add tests","repository":"rust","commitHash":"8b52c73b3ec29dadf5df8dc02aeea5aeea778fd7","metadata":{"author":"Vadim Petrochenkov \u003cvadim.petrochenkov@gmail.com\u003e"}}
{"id":"rust-00384df0","diff":" compiler/rustc_attr_parsing/src/attributes/cfg.rs | 1 -\n compiler/rustc_attr_parsing/src/attributes/doc.rs | 6 ------\n compiler/rustc_attr_parsing/src/parser.rs         | 8 +++-----\n 3 files changed, 3 insertions(+), 12 deletions(-)\n\ndiff --git a/compiler/rustc_attr_parsing/src/attributes/cfg.rs b/compiler/rustc_attr_parsing/src/attributes/cfg.rs\nindex ccf0a394afd..dcb74dda81a 100644\n--- a/compiler/rustc_attr_parsing/src/attributes/cfg.rs\n+++ b/compiler/rustc_attr_parsing/src/attributes/cfg.rs\n@@ -94,7 +94,6 @@ pub fn parse_cfg_entry\u003cS: Stage\u003e(\n             LitKind::Bool(b) \u003d\u003e CfgEntry::Bool(b, lit.span),\n             _ \u003d\u003e return Err(cx.expected_identifier(lit.span)),\n         },\n-        MetaItemOrLitParser::Err(_, err) \u003d\u003e return Err(*err),\n     })\n }\n \ndiff --git a/compiler/rustc_attr_parsing/src/attributes/doc.rs b/compiler/rustc_attr_parsing/src/attributes/doc.rs\nindex 6cc4ac35ead..409102a79c0 100644\n--- a/compiler/rustc_attr_parsing/src/attributes/doc.rs\n+++ b/compiler/rustc_attr_parsing/src/attributes/doc.rs\n@@ -514,9 +514,6 @@ macro_rules! string_arg_and_crate_level {\n                         MetaItemOrLitParser::Lit(lit) \u003d\u003e {\n                             cx.unexpected_literal(lit.span);\n                         }\n-                        MetaItemOrLitParser::Err(..) \u003d\u003e {\n-                            // already had an error here, move on.\n-                        }\n                     }\n                 }\n             }\n@@ -600,9 +597,6 @@ fn accept_single_doc_attr\u003cS: Stage\u003e(\n                         MetaItemOrLitParser::Lit(lit) \u003d\u003e {\n                             cx.expected_name_value(lit.span, None);\n                         }\n-                        MetaItemOrLitParser::Err(..) \u003d\u003e {\n-                            // already had an error here, move on.\n-                        }\n                     }\n                 }\n             }\ndiff --git a/compiler/rustc_attr_parsing/src/parser.rs b/compiler/rustc_attr_parsing/src/parser.rs\nindex 68265649d18..ebf12dd1dfd 100644\n--- a/compiler/rustc_attr_parsing/src/parser.rs\n+++ b/compiler/rustc_attr_parsing/src/parser.rs\n@@ -18,7 +18,7 @@\n use rustc_parse::parser::{ForceCollect, Parser, PathStyle, token_descr};\n use rustc_session::errors::{create_lit_error, report_lit_error};\n use rustc_session::parse::ParseSess;\n-use rustc_span::{ErrorGuaranteed, Ident, Span, Symbol, sym};\n+use rustc_span::{Ident, Span, Symbol, sym};\n use thin_vec::ThinVec;\n \n use crate::ShouldEmit;\n@@ -192,7 +192,6 @@ pub fn no_args(\u0026self) -\u003e Result\u003c(), Span\u003e {\n pub enum MetaItemOrLitParser {\n     MetaItemParser(MetaItemParser),\n     Lit(MetaItemLit),\n-    Err(Span, ErrorGuaranteed),\n }\n \n impl MetaItemOrLitParser {\n@@ -210,21 +209,20 @@ pub fn span(\u0026self) -\u003e Span {\n                 generic_meta_item_parser.span()\n             }\n             MetaItemOrLitParser::Lit(meta_item_lit) \u003d\u003e meta_item_lit.span,\n-            MetaItemOrLitParser::Err(span, _) \u003d\u003e *span,\n         }\n     }\n \n     pub fn lit(\u0026self) -\u003e Option\u003c\u0026MetaItemLit\u003e {\n         match self {\n             MetaItemOrLitParser::Lit(meta_item_lit) \u003d\u003e Some(meta_item_lit),\n-            _ \u003d\u003e None,\n+            MetaItemOrLitParser::MetaItemParser(_) \u003d\u003e None,\n         }\n     }\n \n     pub fn meta_item(\u0026self) -\u003e Option\u003c\u0026MetaItemParser\u003e {\n         match self {\n             MetaItemOrLitParser::MetaItemParser(parser) \u003d\u003e Some(parser),\n-            _ \u003d\u003e None,\n+            MetaItemOrLitParser::Lit(_) \u003d\u003e None,\n         }\n     }\n }","expectedMessage":"Delete `MetaItemOrLitParser::Err`","repository":"rust","commitHash":"00384df08069939166b91813bca8b3c67d47d850","metadata":{"author":"mejrs \u003c59372212+mejrs@users.noreply.github.com\u003e"}}
{"id":"rust-86a49fd7","diff":" compiler/rustc_codegen_llvm/src/attributes.rs      | 11 +++++++-\n library/alloc/src/slice.rs                         |  8 +++---\n library/alloc/src/vec/mod.rs                       |  6 ++++-\n .../lib-optimizations/append-elements.rs           | 30 ++++++++++++++++++++++\n 4 files changed, 50 insertions(+), 5 deletions(-)","expectedMessage":"Auto merge of #130998 - the8472:bail-before-memcpy, r\u003dnnethercote","repository":"rust","commitHash":"86a49fd71fecd25b0fd20247db0ba95eeceaba28","metadata":{"author":"bors \u003cbors@rust-lang.org\u003e"}}
{"id":"rust-0361bd00","diff":" compiler/rustc_resolve/src/diagnostics.rs |  5 ++++-\n compiler/rustc_resolve/src/ident.rs       | 19 +++++++++++--------\n compiler/rustc_resolve/src/late.rs        |  8 +++-----\n compiler/rustc_resolve/src/lib.rs         |  2 +-\n 4 files changed, 19 insertions(+), 15 deletions(-)\n\ndiff --git a/compiler/rustc_resolve/src/diagnostics.rs b/compiler/rustc_resolve/src/diagnostics.rs\nindex 7bc08f1de54..899f8152552 100644\n--- a/compiler/rustc_resolve/src/diagnostics.rs\n+++ b/compiler/rustc_resolve/src/diagnostics.rs\n@@ -32,7 +32,9 @@\n use rustc_span::edition::Edition;\n use rustc_span::hygiene::MacroKind;\n use rustc_span::source_map::{SourceMap, Spanned};\n-use rustc_span::{BytePos, Ident, Macros20NormalizedIdent, Span, Symbol, SyntaxContext, kw, sym};\n+use rustc_span::{\n+    BytePos, DUMMY_SP, Ident, Macros20NormalizedIdent, Span, Symbol, SyntaxContext, kw, sym,\n+};\n use thin_vec::{ThinVec, thin_vec};\n use tracing::{debug, instrument};\n \n@@ -1179,6 +1181,7 @@ pub(crate) fn add_scope_set_candidates(\n         ctxt: SyntaxContext,\n         filter_fn: \u0026impl Fn(Res) -\u003e bool,\n     ) {\n+        let ctxt \u003d DUMMY_SP.with_ctxt(ctxt);\n         self.cm().visit_scopes(scope_set, ps, ctxt, None, |this, scope, use_prelude, _| {\n             match scope {\n                 Scope::DeriveHelpers(expn_id) \u003d\u003e {\ndiff --git a/compiler/rustc_resolve/src/ident.rs b/compiler/rustc_resolve/src/ident.rs\nindex 7f04216c555..f7e628048cc 100644\n--- a/compiler/rustc_resolve/src/ident.rs\n+++ b/compiler/rustc_resolve/src/ident.rs\n@@ -53,13 +53,15 @@ pub(crate) fn visit_scopes\u003c\u0027r, T\u003e(\n         mut self: CmResolver\u003c\u0027r, \u0027ra, \u0027tcx\u003e,\n         scope_set: ScopeSet\u003c\u0027ra\u003e,\n         parent_scope: \u0026ParentScope\u003c\u0027ra\u003e,\n-        orig_ctxt: SyntaxContext,\n+        // Location of the span is not significant, but pass a `Span` instead of `SyntaxContext`\n+        // to avoid extracting and re-packaging the syntax context unnecessarily.\n+        orig_ctxt: Span,\n         derive_fallback_lint_id: Option\u003cNodeId\u003e,\n         mut visitor: impl FnMut(\n             \u0026mut CmResolver\u003c\u0027r, \u0027ra, \u0027tcx\u003e,\n             Scope\u003c\u0027ra\u003e,\n             UsePrelude,\n-            SyntaxContext,\n+            Span,\n         ) -\u003e ControlFlow\u003cT\u003e,\n     ) -\u003e Option\u003cT\u003e {\n         // General principles:\n@@ -238,11 +240,12 @@ pub(crate) fn visit_scopes\u003c\u0027r, T\u003e(\n     fn hygienic_lexical_parent(\n         \u0026self,\n         module: Module\u003c\u0027ra\u003e,\n-        ctxt: \u0026mut SyntaxContext,\n+        span: \u0026mut Span,\n         derive_fallback_lint_id: Option\u003cNodeId\u003e,\n     ) -\u003e Option\u003c(Module\u003c\u0027ra\u003e, Option\u003cNodeId\u003e)\u003e {\n-        if !module.expansion.outer_expn_is_descendant_of(*ctxt) {\n-            return Some((self.expn_def_scope(ctxt.remove_mark()), None));\n+        let ctxt \u003d span.ctxt();\n+        if !module.expansion.outer_expn_is_descendant_of(ctxt) {\n+            return Some((self.expn_def_scope(span.remove_mark()), None));\n         }\n \n         if let ModuleKind::Block \u003d module.kind {\n@@ -272,7 +275,7 @@ fn hygienic_lexical_parent(\n             let ext \u003d \u0026self.get_macro_by_def_id(def_id).ext;\n             if ext.builtin_name.is_none()\n                 \u0026\u0026 ext.macro_kinds() \u003d\u003d MacroKinds::DERIVE\n-                \u0026\u0026 parent.expansion.outer_expn_is_descendant_of(*ctxt)\n+                \u0026\u0026 parent.expansion.outer_expn_is_descendant_of(ctxt)\n             {\n                 return Some((parent, derive_fallback_lint_id));\n             }\n@@ -433,10 +436,10 @@ pub(crate) fn resolve_ident_in_scope_set\u003c\u0027r\u003e(\n         let break_result \u003d self.visit_scopes(\n             scope_set,\n             parent_scope,\n-            orig_ident.span.ctxt(),\n+            orig_ident.span,\n             derive_fallback_lint_id,\n             |this, scope, use_prelude, ctxt| {\n-                let ident \u003d Ident::new(orig_ident.name, orig_ident.span.with_ctxt(ctxt));\n+                let ident \u003d Ident::new(orig_ident.name, ctxt);\n                 // The passed `ctxt` is already normalized, so avoid expensive double normalization.\n                 let ident \u003d Macros20NormalizedIdent(ident);\n                 let res \u003d match this.reborrow().resolve_ident_in_scope(\ndiff --git a/compiler/rustc_resolve/src/late.rs b/compiler/rustc_resolve/src/late.rs\nindex 6d009763177..6557e1dea1a 100644\n--- a/compiler/rustc_resolve/src/late.rs\n+++ b/compiler/rustc_resolve/src/late.rs\n@@ -37,9 +37,7 @@\n use rustc_session::lint;\n use rustc_session::parse::feature_err;\n use rustc_span::source_map::{Spanned, respan};\n-use rustc_span::{\n-    BytePos, DUMMY_SP, Ident, Macros20NormalizedIdent, Span, Symbol, SyntaxContext, kw, sym,\n-};\n+use rustc_span::{BytePos, DUMMY_SP, Ident, Macros20NormalizedIdent, Span, Symbol, kw, sym};\n use smallvec::{SmallVec, smallvec};\n use thin_vec::ThinVec;\n use tracing::{debug, instrument, trace};\n@@ -5224,7 +5222,7 @@ fn traits_in_scope(\u0026mut self, ident: Ident, ns: Namespace) -\u003e Vec\u003cTraitCandidate\n         self.r.traits_in_scope(\n             self.current_trait_ref.as_ref().map(|(module, _)| *module),\n             \u0026self.parent_scope,\n-            ident.span.ctxt(),\n+            ident.span,\n             Some((ident.name, ns)),\n         )\n     }\n@@ -5323,7 +5321,7 @@ fn resolve_doc_links(\u0026mut self, attrs: \u0026[Attribute], maybe_exported: MaybeExport\n                 .entry(self.parent_scope.module.nearest_parent_mod().expect_local())\n                 .or_insert_with(|| {\n                     self.r\n-                        .traits_in_scope(None, \u0026self.parent_scope, SyntaxContext::root(), None)\n+                        .traits_in_scope(None, \u0026self.parent_scope, DUMMY_SP, None)\n                         .into_iter()\n                         .filter_map(|tr| {\n                             if self.is_invalid_proc_macro_item_for_doc(tr.def_id) {\ndiff --git a/compiler/rustc_resolve/src/lib.rs b/compiler/rustc_resolve/src/lib.rs\nindex c4c1e06f94a..0939f8cddbe 100644\n--- a/compiler/rustc_resolve/src/lib.rs\n+++ b/compiler/rustc_resolve/src/lib.rs\n@@ -1918,7 +1918,7 @@ fn traits_in_scope(\n         \u0026mut self,\n         current_trait: Option\u003cModule\u003c\u0027ra\u003e\u003e,\n         parent_scope: \u0026ParentScope\u003c\u0027ra\u003e,\n-        ctxt: SyntaxContext,\n+        ctxt: Span,\n         assoc_item: Option\u003c(Symbol, Namespace)\u003e,\n     ) -\u003e Vec\u003cTraitCandidate\u003e {\n         let mut found_traits \u003d Vec::new();","expectedMessage":"resolve: In `visit_scopes` do not extract ctxt out of span unless necessary","repository":"rust","commitHash":"0361bd004a5074e7fddc8479bca9414e03178e04","metadata":{"author":"Vadim Petrochenkov \u003cvadim.petrochenkov@gmail.com\u003e"}}
{"id":"rust-c1bcae06","diff":" library/std/src/sys/thread/unix.rs | 9 +++++++++\n 1 file changed, 9 insertions(+)\n\ndiff --git a/library/std/src/sys/thread/unix.rs b/library/std/src/sys/thread/unix.rs\nindex d0396ed7130..f0cfdb95639 100644\n--- a/library/std/src/sys/thread/unix.rs\n+++ b/library/std/src/sys/thread/unix.rs\n@@ -45,6 +45,15 @@ impl Thread {\n     // unsafe: see thread::Builder::spawn_unchecked for safety requirements\n     #[cfg_attr(miri, track_caller)] // even without panics, this helps for Miri backtraces\n     pub unsafe fn new(stack: usize, init: Box\u003cThreadInit\u003e) -\u003e io::Result\u003cThread\u003e {\n+        // FIXME: remove this block once wasi-sdk is updated with the fix from\n+        // https://github.com/WebAssembly/wasi-libc/pull/716\n+        // WASI does not support threading via pthreads. While wasi-libc provides\n+        // pthread stubs, pthread_create returns EAGAIN, which causes confusing\n+        // errors. We return UNSUPPORTED_PLATFORM directly instead.\n+        if cfg!(target_os \u003d \"wasi\") {\n+            return Err(io::Error::UNSUPPORTED_PLATFORM);\n+        }\n+\n         let data \u003d init;\n         let mut attr: mem::MaybeUninit\u003clibc::pthread_attr_t\u003e \u003d mem::MaybeUninit::uninit();\n         assert_eq!(libc::pthread_attr_init(attr.as_mut_ptr()), 0);","expectedMessage":"Fix WASI threading regression with minimal invasive change","repository":"rust","commitHash":"c1bcae06384b1e6e0c1ddb25970df5eb77024084","metadata":{"author":"Colin Murphy \u003ccolmurph@adobe.com\u003e"}}
{"id":"rust-7d80e7d7","diff":" compiler/rustc_codegen_llvm/src/mono_item.rs | 2 +-\n compiler/rustc_codegen_llvm/src/va_arg.rs    | 9 ---------\n compiler/rustc_span/src/symbol.rs            | 1 -\n compiler/rustc_target/src/asm/mod.rs         | 2 +-\n compiler/rustc_target/src/callconv/mod.rs    | 2 +-\n compiler/rustc_target/src/spec/mod.rs        | 7 ++-----\n compiler/rustc_target/src/target_features.rs | 8 +-------\n src/tools/miri/src/shims/alloc.rs            | 1 -\n 8 files changed, 6 insertions(+), 26 deletions(-)\n\ndiff --git a/compiler/rustc_codegen_llvm/src/mono_item.rs b/compiler/rustc_codegen_llvm/src/mono_item.rs\nindex 1878f4043ee..838db689e72 100644\n--- a/compiler/rustc_codegen_llvm/src/mono_item.rs\n+++ b/compiler/rustc_codegen_llvm/src/mono_item.rs\n@@ -144,7 +144,7 @@ fn should_assume_dso_local(\u0026self, llval: \u0026llvm::Value, is_declaration: bool) -\u003e\n         }\n \n         // PowerPC64 prefers TOC indirection to avoid copy relocations.\n-        if matches!(self.tcx.sess.target.arch, Arch::PowerPC64 | Arch::PowerPC64LE) {\n+        if self.tcx.sess.target.arch \u003d\u003d Arch::PowerPC64 {\n             return false;\n         }\n \ndiff --git a/compiler/rustc_codegen_llvm/src/va_arg.rs b/compiler/rustc_codegen_llvm/src/va_arg.rs\nindex 688f461e747..c7da2457ada 100644\n--- a/compiler/rustc_codegen_llvm/src/va_arg.rs\n+++ b/compiler/rustc_codegen_llvm/src/va_arg.rs\n@@ -1064,15 +1064,6 @@ pub(super) fn emit_va_arg\u003c\u0027ll, \u0027tcx\u003e(\n             AllowHigherAlign::Yes,\n             ForceRightAdjust::Yes,\n         ),\n-        Arch::PowerPC64LE \u003d\u003e emit_ptr_va_arg(\n-            bx,\n-            addr,\n-            target_ty,\n-            PassMode::Direct,\n-            SlotSize::Bytes8,\n-            AllowHigherAlign::Yes,\n-            ForceRightAdjust::No,\n-        ),\n         Arch::LoongArch32 \u003d\u003e emit_ptr_va_arg(\n             bx,\n             addr,\ndiff --git a/compiler/rustc_span/src/symbol.rs b/compiler/rustc_span/src/symbol.rs\nindex b473d36a45f..c4f77cedbe0 100644\n--- a/compiler/rustc_span/src/symbol.rs\n+++ b/compiler/rustc_span/src/symbol.rs\n@@ -1723,7 +1723,6 @@\n         postfix_match,\n         powerpc,\n         powerpc64,\n-        powerpc64le,\n         powerpc_target_feature,\n         powf16,\n         powf32,\ndiff --git a/compiler/rustc_target/src/asm/mod.rs b/compiler/rustc_target/src/asm/mod.rs\nindex 0078866ab95..a10699bbce8 100644\n--- a/compiler/rustc_target/src/asm/mod.rs\n+++ b/compiler/rustc_target/src/asm/mod.rs\n@@ -261,7 +261,7 @@ pub fn from_arch(arch: \u0026Arch) -\u003e Option\u003cSelf\u003e {\n             Arch::Mips | Arch::Mips32r6 \u003d\u003e Some(Self::Mips),\n             Arch::Mips64 | Arch::Mips64r6 \u003d\u003e Some(Self::Mips64),\n             Arch::PowerPC \u003d\u003e Some(Self::PowerPC),\n-            Arch::PowerPC64 | Arch::PowerPC64LE \u003d\u003e Some(Self::PowerPC64),\n+            Arch::PowerPC64 \u003d\u003e Some(Self::PowerPC64),\n             Arch::S390x \u003d\u003e Some(Self::S390x),\n             Arch::Sparc \u003d\u003e Some(Self::Sparc),\n             Arch::Sparc64 \u003d\u003e Some(Self::Sparc64),\ndiff --git a/compiler/rustc_target/src/callconv/mod.rs b/compiler/rustc_target/src/callconv/mod.rs\nindex 6faa57252ca..6c8e0e181c4 100644\n--- a/compiler/rustc_target/src/callconv/mod.rs\n+++ b/compiler/rustc_target/src/callconv/mod.rs\n@@ -702,7 +702,7 @@ pub fn adjust_for_foreign_abi\u003cC\u003e(\u0026mut self, cx: \u0026C, abi: ExternAbi)\n             Arch::RiscV32 | Arch::RiscV64 \u003d\u003e riscv::compute_abi_info(cx, self),\n             Arch::Wasm32 | Arch::Wasm64 \u003d\u003e wasm::compute_abi_info(cx, self),\n             Arch::Bpf \u003d\u003e bpf::compute_abi_info(cx, self),\n-            arch @ (Arch::PowerPC64LE | Arch::SpirV | Arch::Other(_)) \u003d\u003e {\n+            arch @ (Arch::SpirV | Arch::Other(_)) \u003d\u003e {\n                 panic!(\"no lowering implemented for {arch}\")\n             }\n         }\ndiff --git a/compiler/rustc_target/src/spec/mod.rs b/compiler/rustc_target/src/spec/mod.rs\nindex 89c9fdc935c..57effe3a866 100644\n--- a/compiler/rustc_target/src/spec/mod.rs\n+++ b/compiler/rustc_target/src/spec/mod.rs\n@@ -1873,7 +1873,6 @@ pub enum Arch {\n         Nvptx64 \u003d \"nvptx64\",\n         PowerPC \u003d \"powerpc\",\n         PowerPC64 \u003d \"powerpc64\",\n-        PowerPC64LE \u003d \"powerpc64le\",\n         RiscV32 \u003d \"riscv32\",\n         RiscV64 \u003d \"riscv64\",\n         S390x \u003d \"s390x\",\n@@ -1911,7 +1910,6 @@ pub fn desc_symbol(\u0026self) -\u003e Symbol {\n             Self::Nvptx64 \u003d\u003e sym::nvptx64,\n             Self::PowerPC \u003d\u003e sym::powerpc,\n             Self::PowerPC64 \u003d\u003e sym::powerpc64,\n-            Self::PowerPC64LE \u003d\u003e sym::powerpc64le,\n             Self::RiscV32 \u003d\u003e sym::riscv32,\n             Self::RiscV64 \u003d\u003e sym::riscv64,\n             Self::S390x \u003d\u003e sym::s390x,\n@@ -1940,8 +1938,8 @@ pub fn supports_c_variadic_definitions(\u0026self) -\u003e bool {\n \n             AArch64 | AmdGpu | Arm | Arm64EC | Avr | CSky | Hexagon | LoongArch32 | LoongArch64\n             | M68k | Mips | Mips32r6 | Mips64 | Mips64r6 | Msp430 | Nvptx64 | PowerPC\n-            | PowerPC64 | PowerPC64LE | RiscV32 | RiscV64 | S390x | Sparc | Sparc64 | Wasm32\n-            | Wasm64 | X86 | X86_64 | Xtensa \u003d\u003e true,\n+            | PowerPC64 | RiscV32 | RiscV64 | S390x | Sparc | Sparc64 | Wasm32 | Wasm64 | X86\n+            | X86_64 | Xtensa \u003d\u003e true,\n         }\n     }\n }\n@@ -3436,7 +3434,6 @@ pub fn object_architecture(\n             Arch::Arm64EC \u003d\u003e (Architecture::Aarch64, Some(object::SubArchitecture::Arm64EC)),\n             Arch::AmdGpu\n             | Arch::Nvptx64\n-            | Arch::PowerPC64LE\n             | Arch::SpirV\n             | Arch::Wasm32\n             | Arch::Wasm64\ndiff --git a/compiler/rustc_target/src/target_features.rs b/compiler/rustc_target/src/target_features.rs\nindex 40cc4f40a33..4eba426dda5 100644\n--- a/compiler/rustc_target/src/target_features.rs\n+++ b/compiler/rustc_target/src/target_features.rs\n@@ -986,7 +986,6 @@ pub fn rust_target_features(\u0026self) -\u003e \u0026\u0027static [(\u0026\u0027static str, Stability, Implie\n             Arch::AmdGpu\n             | Arch::Avr\n             | Arch::Msp430\n-            | Arch::PowerPC64LE\n             | Arch::SpirV\n             | Arch::Xtensa\n             | Arch::Other(_) \u003d\u003e \u0026[],\n@@ -1015,12 +1014,7 @@ pub fn features_for_correct_fixed_length_vector_abi(\u0026self) -\u003e \u0026\u0027static [(u64, \u0026\u0027\n             Arch::CSky \u003d\u003e CSKY_FEATURES_FOR_CORRECT_FIXED_LENGTH_VECTOR_ABI,\n             // FIXME: for some tier3 targets, we are overly cautious and always give warnings\n             // when passing args in vector registers.\n-            Arch::Avr\n-            | Arch::Msp430\n-            | Arch::PowerPC64LE\n-            | Arch::SpirV\n-            | Arch::Xtensa\n-            | Arch::Other(_) \u003d\u003e \u0026[],\n+            Arch::Avr | Arch::Msp430 | Arch::SpirV | Arch::Xtensa | Arch::Other(_) \u003d\u003e \u0026[],\n         }\n     }\n \ndiff --git a/src/tools/miri/src/shims/alloc.rs b/src/tools/miri/src/shims/alloc.rs\nindex 94649dde473..b4d53c36d19 100644\n--- a/src/tools/miri/src/shims/alloc.rs\n+++ b/src/tools/miri/src/shims/alloc.rs\n@@ -52,7 +52,6 @@ fn malloc_align(\u0026self, size: u64) -\u003e Align {\n             | Arch::Bpf\n             | Arch::Msp430\n             | Arch::Nvptx64\n-            | Arch::PowerPC64LE\n             | Arch::SpirV\n             | Arch::Other(_)) \u003d\u003e bug!(\"unsupported target architecture for malloc: `{arch}`\"),\n         };","expectedMessage":"rustc_target: Remove unused Arch::PowerPC64LE","repository":"rust","commitHash":"7d80e7d720162fed8223407e91912683631c93f2","metadata":{"author":"Taiki Endo \u003cte316e89@gmail.com\u003e"}}
{"id":"rust-2b209a69","diff":" src/bootstrap/Cargo.toml      | 2 +-\n src/build_helper/Cargo.toml   | 7 +++++--\n src/build_helper/src/lib.rs   | 1 +\n src/ci/citool/Cargo.toml      | 2 +-\n src/tools/opt-dist/Cargo.toml | 2 +-\n 5 files changed, 9 insertions(+), 5 deletions(-)\n\ndiff --git a/src/bootstrap/Cargo.toml b/src/bootstrap/Cargo.toml\nindex e1725db60cf..e66c0576e9e 100644\n--- a/src/bootstrap/Cargo.toml\n+++ b/src/bootstrap/Cargo.toml\n@@ -6,7 +6,7 @@ build \u003d \"build.rs\"\n default-run \u003d \"bootstrap\"\n \n [features]\n-build-metrics \u003d [\"sysinfo\"]\n+build-metrics \u003d [\"dep:sysinfo\", \"build_helper/metrics\"]\n tracing \u003d [\"dep:tracing\", \"dep:tracing-chrome\", \"dep:tracing-subscriber\", \"dep:chrono\", \"dep:tempfile\"]\n \n [lib]\ndiff --git a/src/build_helper/Cargo.toml b/src/build_helper/Cargo.toml\nindex 66894e1abc4..2ec44fe2730 100644\n--- a/src/build_helper/Cargo.toml\n+++ b/src/build_helper/Cargo.toml\n@@ -6,5 +6,8 @@ edition \u003d \"2021\"\n # See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n \n [dependencies]\n-serde \u003d \"1\"\n-serde_derive \u003d \"1\"\n+serde \u003d { version \u003d \"1\", optional \u003d true }\n+serde_derive \u003d { version \u003d \"1\", optional \u003d true }\n+\n+[features]\n+metrics \u003d [\"dep:serde\", \"dep:serde_derive\"]\ndiff --git a/src/build_helper/src/lib.rs b/src/build_helper/src/lib.rs\nindex 266eedc6245..e23a158ac05 100644\n--- a/src/build_helper/src/lib.rs\n+++ b/src/build_helper/src/lib.rs\n@@ -4,6 +4,7 @@\n pub mod drop_bomb;\n pub mod fs;\n pub mod git;\n+#[cfg(feature \u003d \"metrics\")]\n pub mod metrics;\n pub mod npm;\n pub mod stage0_parser;\ndiff --git a/src/ci/citool/Cargo.toml b/src/ci/citool/Cargo.toml\nindex 468d8c8a02a..539edf60033 100644\n--- a/src/ci/citool/Cargo.toml\n+++ b/src/ci/citool/Cargo.toml\n@@ -15,7 +15,7 @@ serde_yaml \u003d \"0.9\"\n serde_json \u003d \"1\"\n ureq \u003d { version \u003d \"3\", features \u003d [\"json\"] }\n \n-build_helper \u003d { path \u003d \"../../build_helper\" }\n+build_helper \u003d { path \u003d \"../../build_helper\", features \u003d [\"metrics\"] }\n \n [dev-dependencies]\n insta \u003d \"1\"\ndiff --git a/src/tools/opt-dist/Cargo.toml b/src/tools/opt-dist/Cargo.toml\nindex f4051ae67d7..66c19183f34 100644\n--- a/src/tools/opt-dist/Cargo.toml\n+++ b/src/tools/opt-dist/Cargo.toml\n@@ -4,7 +4,7 @@ version \u003d \"0.1.0\"\n edition \u003d \"2024\"\n \n [dependencies]\n-build_helper \u003d { path \u003d \"../../build_helper\" }\n+build_helper \u003d { path \u003d \"../../build_helper\", features \u003d [\"metrics\"] }\n env_logger \u003d \"0.11\"\n log \u003d \"0.4\"\n anyhow \u003d \"1\"","expectedMessage":"Avoid serde dependency in build_helper when not necessary","repository":"rust","commitHash":"2b209a69cf97c18ecef9043abf3ec8b6fe9867b9","metadata":{"author":"bjorn3 \u003c17426603+bjorn3@users.noreply.github.com\u003e"}}
{"id":"rust-8c52f735","diff":" compiler/rustc_codegen_gcc/src/lib.rs              |   3 +-\n compiler/rustc_codegen_llvm/src/lib.rs             |   2 +-\n .../rustc_codegen_ssa/src/back/symbol_export.rs    |  18 +-\n compiler/rustc_codegen_ssa/src/lib.rs              |   6 +-\n .../rustc_const_eval/src/check_consts/check.rs     |  13 +-\n compiler/rustc_const_eval/src/lib.rs               |  16 +-\n compiler/rustc_interface/src/passes.rs             |  46 ++---\n .../rustc_lint/src/early/diagnostics/check_cfg.rs  |   2 +-\n compiler/rustc_lint/src/transmute.rs               |   4 +-\n compiler/rustc_metadata/src/rmeta/mod.rs           |   2 +-\n compiler/rustc_middle/src/mir/pretty.rs            |   7 +-\n compiler/rustc_middle/src/util/mod.rs              |  17 --\n compiler/rustc_mir_build/src/lib.rs                |  12 +-\n compiler/rustc_mir_transform/src/lib.rs            |   6 +-\n compiler/rustc_monomorphize/src/collector.rs       |   2 +-\n compiler/rustc_monomorphize/src/lib.rs             |   2 +-\n compiler/rustc_monomorphize/src/partitioning.rs    |   8 +-\n compiler/rustc_parse/src/parser/diagnostics.rs     |   4 +-\n compiler/rustc_parse/src/parser/mod.rs             |   7 +-\n compiler/rustc_passes/src/lib.rs                   |   2 +-\n compiler/rustc_resolve/src/build_reduced_graph.rs  |  33 ++--\n compiler/rustc_resolve/src/diagnostics.rs          |  27 +--\n compiler/rustc_resolve/src/errors.rs               |  13 ++\n compiler/rustc_resolve/src/imports.rs              |   9 +-\n compiler/rustc_resolve/src/late/diagnostics.rs     |  35 +++-\n compiler/rustc_resolve/src/lib.rs                  |  31 ++--\n .../error_reporting/traits/fulfillment_errors.rs   |   2 +-\n .../src/error_reporting/traits/suggestions.rs      |  12 +-\n library/alloc/src/collections/binary_heap/mod.rs   |   8 +-\n library/core/src/char/methods.rs                   |   9 +-\n library/core/src/iter/range.rs                     |   7 +\n library/std/src/io/error.rs                        |  12 +-\n library/std/src/io/error/tests.rs                  |   3 +-\n library/std/src/sys/env/uefi.rs                    |   4 +-\n library/std/src/sys/exit_guard.rs                  |   2 +-\n library/std/src/sys/fs/unix.rs                     |   4 +-\n library/std/src/sys/io/error/generic.rs            |  15 ++\n library/std/src/sys/io/error/hermit.rs             |  35 ++++\n library/std/src/sys/io/error/mod.rs                |  55 ++++++\n library/std/src/sys/io/error/motor.rs              |  67 ++++++++\n library/std/src/sys/io/error/sgx.rs                |  65 +++++++\n library/std/src/sys/io/error/solid.rs              |  19 +++\n library/std/src/sys/io/error/teeos.rs              |  64 +++++++\n library/std/src/sys/io/error/uefi.rs               | 104 ++++++++++++\n library/std/src/sys/io/error/unix.rs               | 186 +++++++++++++++++++++\n library/std/src/sys/io/error/wasi.rs               |  80 +++++++++\n library/std/src/sys/io/error/windows.rs            | 140 ++++++++++++++++\n library/std/src/sys/io/error/xous.rs               |  17 ++\n library/std/src/sys/io/mod.rs                      |  20 ++-\n library/std/src/sys/net/connection/socket/unix.rs  |   2 +-\n library/std/src/sys/net/hostname/unix.rs           |   2 +-\n library/std/src/sys/pal/hermit/mod.rs              |  33 +---\n library/std/src/sys/pal/hermit/os.rs               |   8 -\n library/std/src/sys/pal/motor/mod.rs               |  39 -----\n library/std/src/sys/pal/motor/os.rs                |  29 ----\n library/std/src/sys/pal/sgx/mod.rs                 |  50 ------\n library/std/src/sys/pal/sgx/os.rs                  |  18 +-\n library/std/src/sys/pal/solid/mod.rs               |   9 -\n library/std/src/sys/pal/solid/os.rs                |  10 +-\n library/std/src/sys/pal/teeos/mod.rs               |  55 ------\n library/std/src/sys/pal/teeos/os.rs                |   8 -\n library/std/src/sys/pal/uefi/mod.rs                |  50 ------\n library/std/src/sys/pal/uefi/os.rs                 |  53 ------\n library/std/src/sys/pal/unix/futex.rs              |   6 +-\n library/std/src/sys/pal/unix/linux/pidfd.rs        |   2 +-\n library/std/src/sys/pal/unix/linux/pidfd/tests.rs  |   5 +-\n library/std/src/sys/pal/unix/mod.rs                |  61 +------\n library/std/src/sys/pal/unix/os.rs                 | 127 --------------\n .../src/sys/pal/unix/stack_overflow/thread_info.rs |   2 +-\n library/std/src/sys/pal/unsupported/common.rs      |   8 -\n library/std/src/sys/pal/unsupported/os.rs          |   8 -\n library/std/src/sys/pal/vexos/mod.rs               |   4 +-\n library/std/src/sys/pal/vexos/os.rs                |   4 +-\n library/std/src/sys/pal/wasi/helpers.rs            |  56 +------\n library/std/src/sys/pal/wasi/mod.rs                |   2 +-\n library/std/src/sys/pal/wasi/os.rs                 |  30 +---\n library/std/src/sys/pal/windows/mod.rs             |  78 ---------\n library/std/src/sys/pal/windows/os.rs              |  60 -------\n library/std/src/sys/pal/xous/os.rs                 |   9 -\n library/std/src/sys/pal/zkvm/mod.rs                |   8 -\n library/std/src/sys/pal/zkvm/os.rs                 |   8 -\n library/std/src/sys/process/uefi.rs                |   2 +-\n library/std/src/sys/process/unix/common.rs         |   2 +-\n library/std/src/sys/process/unix/unix.rs           |   2 +-\n library/std/src/sys/random/linux.rs                |   2 +-\n library/std/src/sys/sync/condvar/windows7.rs       |   4 +-\n library/std/src/sys/thread/unix.rs                 |   9 +-\n src/librustdoc/core.rs                             |   9 +-\n src/tools/miri/src/bin/miri.rs                     |   2 +-\n .../option-niche-unfixed/option-nonzero-eq.rs      |   7 +-\n .../missing-bound.stderr                           |   5 +-\n tests/ui-fulldeps/obtain-borrowck.rs               |   6 +-\n .../ui-fulldeps/rustc-dev-remap.only-remap.stderr  |   2 +-\n .../rustc-dev-remap.remap-unremap.stderr           |   2 +-\n .../diagnostic-derive-doc-comment-field.stderr     |   4 +-\n .../session-diagnostic/diagnostic-derive.stderr    |   2 +-\n tests/ui/abi/issues/issue-22565-rust-call.stderr   |   4 +-\n tests/ui/async-await/coroutine-not-future.stderr   |   6 +-\n tests/ui/async-await/issue-61076.rs                |   4 +-\n tests/ui/async-await/issue-61076.stderr            |   4 +-\n tests/ui/async-await/issue-84841.stderr            |   2 +-\n tests/ui/async-await/try-in-sync.stderr            |   2 +-\n .../two-phase-reservation-sharing-interference.rs  |   2 +-\n .../adt_const_params/const_param_ty_bad.stderr     |  12 +-\n .../const_param_ty_bad_empty_array.stderr          |   2 +-\n ...onst_param_ty_generic_bounds_do_not_hold.stderr |   6 +-\n .../const_param_ty_impl_no_structural_eq.stderr    |   4 +-\n .../generic_const_exprs/issue-69654.stderr         |   5 +\n tests/ui/coroutine/gen_block_is_coro.stderr        |   6 +-\n tests/ui/error-codes/E0059.stderr                  |   4 +-\n tests/ui/extern/extern-types-unsized.stderr        |   4 +-\n tests/ui/extern/unsized-extern-derefmove.stderr    |   6 +-\n .../feature-gate-sized-hierarchy.stderr            |   2 +-\n .../rust-call-abi-not-a-tuple-ice-81974.stderr     |  16 +-\n tests/ui/mir/validate/validate-unsize-cast.stderr  |   2 +-\n .../ui/overloaded/overloaded-calls-nontuple.stderr |  12 +-\n .../pattern/deref-patterns/recursion-limit.stderr  |   2 +-\n .../deref-patterns/unsatisfied-bounds.stderr       |   2 +-\n tests/ui/proc-macro/quote/not-quotable.stderr      |   2 +-\n tests/ui/range/range-1.rs                          |   2 +-\n tests/ui/range/range-1.stderr                      |   6 +-\n .../disallowed-positions.e2021.stderr              |   6 +-\n .../disallowed-positions.e2024.stderr              |   6 +-\n tests/ui/sized-hierarchy/default-bound.stderr      |   2 +-\n tests/ui/sized-hierarchy/impls.stderr              |  10 +-\n .../ui/sized-hierarchy/pretty-print-opaque.stderr  |   6 +-\n tests/ui/specialization/issue-44861.stderr         |   2 +-\n .../stability-in-private-module.rs                 |   2 +-\n .../stability-in-private-module.stderr             |   2 +-\n tests/ui/suggestions/fn-trait-notation.stderr      |   4 +-\n tests/ui/suggestions/issue-72766.stderr            |   2 +-\n tests/ui/suggestions/issue-97704.stderr            |   2 +-\n .../trait-bounds/unstable-trait-suggestion.stderr  |   7 +-\n tests/ui/traits/issue-71036.rs                     |   2 +-\n tests/ui/traits/issue-71036.stderr                 |   2 +-\n tests/ui/traits/next-solver/coroutine.fail.stderr  |   2 +-\n .../higher-ranked-upcasting-ub.next.stderr         |   2 +-\n .../unsize-goal-escaping-bounds.current.stderr     |   2 +-\n tests/ui/transmutability/assoc-bound.stderr        |   2 +-\n .../dont-assume-err-is-yes-issue-126377.stderr     |   2 +-\n .../transmutability/references/unsafecell.stderr   |   8 +-\n .../try-block-bad-type-heterogeneous.stderr        |   4 +-\n tests/ui/try-block/try-block-bad-type.stderr       |   4 +-\n tests/ui/try-block/try-block-in-while.stderr       |   2 +-\n tests/ui/try-trait/try-operator-on-main.stderr     |   6 +-\n tests/ui/tuple/builtin-fail.stderr                 |   8 +-\n tests/ui/type-inference/box_has_sigdrop.rs         |   2 +-\n tests/ui/type/pattern_types/nested.stderr          |  14 +-\n tests/ui/typeck/issue-57404.stderr                 |   2 +-\n .../non-tupled-arg-mismatch.stderr                 |   2 +-\n 150 files changed, 1254 insertions(+), 1143 deletions(-)","expectedMessage":"Auto merge of #151107 - JonathanBrouwer:rollup-9CIxxuZ, r\u003dJonathanBrouwer","repository":"rust","commitHash":"8c52f735abd1af9a73941b78fe7ed2ab08b9c0dd","metadata":{"author":"bors \u003cbors@rust-lang.org\u003e"}}
{"id":"rust-12b4b727","diff":" tests/ui/const-generics/mgca/tuple_expr_arg_bad-issue-151048.rs   | 8 ++++++++\n .../ui/const-generics/mgca/tuple_expr_arg_bad-issue-151048.stderr | 8 ++++++++\n 2 files changed, 16 insertions(+)\n\ndiff --git a/tests/ui/const-generics/mgca/tuple_expr_arg_bad-issue-151048.rs b/tests/ui/const-generics/mgca/tuple_expr_arg_bad-issue-151048.rs\nnew file mode 100644\nindex 00000000000..4aecd30e86b\n--- /dev/null\n+++ b/tests/ui/const-generics/mgca/tuple_expr_arg_bad-issue-151048.rs\n@@ -0,0 +1,8 @@\n+#![feature(min_generic_const_args)]\n+#![expect(incomplete_features)]\n+\n+struct Y {\n+    stuff: [u8; { ([1, 2], 3, [4, 5]) }], //~ ERROR expected `usize`, found const tuple\n+}\n+\n+fn main() {}\ndiff --git a/tests/ui/const-generics/mgca/tuple_expr_arg_bad-issue-151048.stderr b/tests/ui/const-generics/mgca/tuple_expr_arg_bad-issue-151048.stderr\nnew file mode 100644\nindex 00000000000..468bf703d90\n--- /dev/null\n+++ b/tests/ui/const-generics/mgca/tuple_expr_arg_bad-issue-151048.stderr\n@@ -0,0 +1,8 @@\n+error: expected `usize`, found const tuple\n+  --\u003e $DIR/tuple_expr_arg_bad-issue-151048.rs:5:19\n+   |\n+LL |     stuff: [u8; { ([1, 2], 3, [4, 5]) }],\n+   |                   ^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 1 previous error\n+","expectedMessage":"Add test for issue 151048","repository":"rust","commitHash":"12b4b72715b5814ab48fc4c78169fd6cef0ccc25","metadata":{"author":"mu001999 \u003cmu001999@outlook.com\u003e"}}
{"id":"rust-80bd0691","diff":" compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs |  2 ++\n src/librustdoc/clean/mod.rs                            | 14 +++-----------\n 2 files changed, 5 insertions(+), 11 deletions(-)\n\ndiff --git a/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs b/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\nindex 3dcc0232b30..65d2d61e6fc 100644\n--- a/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\n+++ b/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\n@@ -1283,6 +1283,8 @@ fn probe_single_bound_for_assoc_item\u003cI\u003e(\n                                             )\n                                         });\n \n+                                        // FIXME(mgca): code duplication with other places we lower\n+                                        // the rhs\u0027 of associated const bindings\n                                         let ty \u003d projection_term.map_bound(|alias| {\n                                             tcx.type_of(alias.def_id).instantiate(tcx, alias.args)\n                                         });\ndiff --git a/src/librustdoc/clean/mod.rs b/src/librustdoc/clean/mod.rs\nindex c7c23f75d69..0ad9d2fdbe8 100644\n--- a/src/librustdoc/clean/mod.rs\n+++ b/src/librustdoc/clean/mod.rs\n@@ -471,19 +471,13 @@ fn clean_middle_term\u003c\u0027tcx\u003e(\n fn clean_hir_term\u003c\u0027tcx\u003e(\n     assoc_item: Option\u003cDefId\u003e,\n     term: \u0026hir::Term\u003c\u0027tcx\u003e,\n-    span: rustc_span::Span,\n     cx: \u0026mut DocContext\u003c\u0027tcx\u003e,\n ) -\u003e Term {\n     match term {\n         hir::Term::Ty(ty) \u003d\u003e Term::Type(clean_ty(ty, cx)),\n         hir::Term::Const(c) \u003d\u003e {\n-            let ty \u003d if let Some(assoc_item) \u003d assoc_item {\n-                // FIXME(generic_const_items): this should instantiate with the alias item\u0027s args\n-                cx.tcx.type_of(assoc_item).instantiate_identity()\n-            } else {\n-                Ty::new_error_with_message(cx.tcx, span, \"cannot find the associated constant\")\n-            };\n-\n+            // FIXME(generic_const_items): this should instantiate with the alias item\u0027s args\n+            let ty \u003d cx.tcx.type_of(assoc_item.unwrap()).instantiate_identity();\n             let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, c, ty);\n             Term::Constant(clean_middle_const(ty::Binder::dummy(ct), cx))\n         }\n@@ -3170,9 +3164,7 @@ fn clean_assoc_item_constraint\u003c\u0027tcx\u003e(\n                     .associated_items(trait_did)\n                     .find_by_ident_and_kind(cx.tcx, constraint.ident, assoc_tag, trait_did)\n                     .map(|item| item.def_id);\n-                AssocItemConstraintKind::Equality {\n-                    term: clean_hir_term(assoc_item, term, constraint.span, cx),\n-                }\n+                AssocItemConstraintKind::Equality { term: clean_hir_term(assoc_item, term, cx) }\n             }\n             hir::AssocItemConstraintKind::Bound { bounds } \u003d\u003e AssocItemConstraintKind::Bound {\n                 bounds: bounds.iter().filter_map(|b| clean_generic_bound(b, cx)).collect(),","expectedMessage":"Fix review comments","repository":"rust","commitHash":"80bd069138feba6452059852785bb913a7dba66c","metadata":{"author":"mu001999 \u003cmu001999@outlook.com\u003e"}}
{"id":"rust-37f20b76","diff":" tests/ui/const-generics/associated-const-bindings/ambiguity.stderr | 6 ++++++\n 1 file changed, 6 insertions(+)\n\ndiff --git a/tests/ui/const-generics/associated-const-bindings/ambiguity.stderr b/tests/ui/const-generics/associated-const-bindings/ambiguity.stderr\nindex a14afe9d692..806708f18d6 100644\n--- a/tests/ui/const-generics/associated-const-bindings/ambiguity.stderr\n+++ b/tests/ui/const-generics/associated-const-bindings/ambiguity.stderr\n@@ -27,6 +27,12 @@ LL |     const C: \u0026\u0027static str;\n ...\n LL | fn take1(_: impl Trait1\u003cC \u003d \"?\"\u003e) {}\n    |                         ^^^^^^^ ambiguous associated constant `C`\n+   |\n+   \u003d help: consider introducing a new type parameter `T` and adding `where` constraints:\n+               where\n+                   T: Trait1,\n+                   T: Parent2::C \u003d \"?\",\n+                   T: Parent1::C \u003d \"?\"\n \n error: aborting due to 2 previous errors\n ","expectedMessage":"Bless tests","repository":"rust","commitHash":"37f20b7631c6a6c712f0c19a91531623282d6507","metadata":{"author":"mu001999 \u003cmu001999@outlook.com\u003e"}}
{"id":"rust-e27fcfd2","diff":" compiler/rustc_hir_analysis/src/collect.rs         |  8 +-\n .../src/hir_ty_lowering/bounds.rs                  |  5 +-\n .../rustc_hir_analysis/src/hir_ty_lowering/mod.rs  | 89 +++++-----------------\n compiler/rustc_hir_analysis/src/lib.rs             |  6 +-\n compiler/rustc_hir_typeck/src/expr.rs              |  7 +-\n compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs     | 13 ++--\n compiler/rustc_hir_typeck/src/method/confirm.rs    |  7 +-\n src/librustdoc/clean/mod.rs                        | 22 +-----\n 8 files changed, 48 insertions(+), 109 deletions(-)\n\ndiff --git a/compiler/rustc_hir_analysis/src/collect.rs b/compiler/rustc_hir_analysis/src/collect.rs\nindex bacdf004980..2c025340938 100644\n--- a/compiler/rustc_hir_analysis/src/collect.rs\n+++ b/compiler/rustc_hir_analysis/src/collect.rs\n@@ -47,9 +47,7 @@\n use tracing::{debug, instrument};\n \n use crate::errors;\n-use crate::hir_ty_lowering::{\n-    FeedConstTy, HirTyLowerer, InherentAssocCandidate, RegionInferReason,\n-};\n+use crate::hir_ty_lowering::{HirTyLowerer, InherentAssocCandidate, RegionInferReason};\n \n pub(crate) mod dump;\n mod generics_of;\n@@ -1499,7 +1497,7 @@ fn const_param_default\u003c\u0027tcx\u003e(\n \n     let ct \u003d icx\n         .lowerer()\n-        .lower_const_arg(default_ct, FeedConstTy::with_type_of(tcx, def_id, identity_args));\n+        .lower_const_arg(default_ct, tcx.type_of(def_id).instantiate(tcx, identity_args));\n     ty::EarlyBinder::bind(ct)\n }\n \n@@ -1557,7 +1555,7 @@ fn const_of_item\u003c\u0027tcx\u003e(\n     let identity_args \u003d ty::GenericArgs::identity_for_item(tcx, def_id);\n     let ct \u003d icx\n         .lowerer()\n-        .lower_const_arg(ct_arg, FeedConstTy::with_type_of(tcx, def_id.to_def_id(), identity_args));\n+        .lower_const_arg(ct_arg, tcx.type_of(def_id.to_def_id()).instantiate(tcx, identity_args));\n     if let Err(e) \u003d icx.check_tainted_by_errors()\n         \u0026\u0026 !ct.references_error()\n     {\ndiff --git a/compiler/rustc_hir_analysis/src/hir_ty_lowering/bounds.rs b/compiler/rustc_hir_analysis/src/hir_ty_lowering/bounds.rs\nindex 0a874b88180..d6441702b26 100644\n--- a/compiler/rustc_hir_analysis/src/hir_ty_lowering/bounds.rs\n+++ b/compiler/rustc_hir_analysis/src/hir_ty_lowering/bounds.rs\n@@ -20,7 +20,7 @@\n \n use crate::errors;\n use crate::hir_ty_lowering::{\n-    AssocItemQSelf, FeedConstTy, GenericsArgsErrExtend, HirTyLowerer, ImpliedBoundsContext,\n+    AssocItemQSelf, GenericsArgsErrExtend, HirTyLowerer, ImpliedBoundsContext,\n     OverlappingAsssocItemConstraints, PredicateFilter, RegionInferReason,\n };\n \n@@ -543,7 +543,6 @@ pub(super) fn lower_assoc_item_constraint(\n                 let term \u003d match term {\n                     hir::Term::Ty(ty) \u003d\u003e self.lower_ty(ty).into(),\n                     hir::Term::Const(ct) \u003d\u003e {\n-                        // Provide the resolved type of the associated constant\n                         let ty \u003d projection_term.map_bound(|alias| {\n                             tcx.type_of(alias.def_id).instantiate(tcx, alias.args)\n                         });\n@@ -554,7 +553,7 @@ pub(super) fn lower_assoc_item_constraint(\n                             constraint.hir_id,\n                         );\n \n-                        self.lower_const_arg(ct, FeedConstTy::WithTy(ty)).into()\n+                        self.lower_const_arg(ct, ty).into()\n                     }\n                 };\n \ndiff --git a/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs b/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\nindex be5ac21e2ca..3dcc0232b30 100644\n--- a/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\n+++ b/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\n@@ -253,35 +253,6 @@ fn to_string(\u0026self, tcx: TyCtxt\u003c\u0027_\u003e) -\u003e String {\n     }\n }\n \n-/// In some cases, [`hir::ConstArg`]s that are being used in the type system\n-/// through const generics need to have their type \"fed\" to them\n-/// using the query system.\n-///\n-/// Use this enum with `\u003cdyn HirTyLowerer\u003e::lower_const_arg` to instruct it with the\n-/// desired behavior.\n-#[derive(Debug, Clone, Copy)]\n-pub enum FeedConstTy\u003c\u0027tcx\u003e {\n-    /// Feed the type to the (anno) const arg.\n-    WithTy(Ty\u003c\u0027tcx\u003e),\n-    /// Don\u0027t feed the type.\n-    No,\n-}\n-\n-impl\u003c\u0027tcx\u003e FeedConstTy\u003c\u0027tcx\u003e {\n-    /// The `DefId` belongs to the const param that we are supplying\n-    /// this (anon) const arg to.\n-    ///\n-    /// The list of generic args is used to instantiate the parameters\n-    /// used by the type of the const param specified by `DefId`.\n-    pub fn with_type_of(\n-        tcx: TyCtxt\u003c\u0027tcx\u003e,\n-        def_id: DefId,\n-        generic_args: \u0026[ty::GenericArg\u003c\u0027tcx\u003e],\n-    ) -\u003e Self {\n-        Self::WithTy(tcx.type_of(def_id).instantiate(tcx, generic_args))\n-    }\n-}\n-\n #[derive(Debug, Clone, Copy)]\n enum LowerTypeRelativePathMode {\n     Type(PermitVariants),\n@@ -733,7 +704,7 @@ fn provided_kind(\n                         // Ambig portions of `ConstArg` are handled in the match arm below\n                         .lower_const_arg(\n                             ct.as_unambig_ct(),\n-                            FeedConstTy::with_type_of(tcx, param.def_id, preceding_args),\n+                            tcx.type_of(param.def_id).instantiate(tcx, preceding_args),\n                         )\n                         .into(),\n                     (\u0026GenericParamDefKind::Const { .. }, GenericArg::Infer(inf)) \u003d\u003e {\n@@ -1322,7 +1293,7 @@ fn probe_single_bound_for_assoc_item\u003cI\u003e(\n                                             constraint.hir_id,\n                                         );\n \n-                                        self.lower_const_arg(ct, FeedConstTy::WithTy(ty)).into()\n+                                        self.lower_const_arg(ct, ty).into()\n                                     }\n                                 };\n                                 if term.references_error() {\n@@ -2347,16 +2318,10 @@ pub(crate) fn lower_const_param(\u0026self, param_def_id: DefId, path_hir_id: HirId)\n \n     /// Lower a [`hir::ConstArg`] to a (type-level) [`ty::Const`](Const).\n     #[instrument(skip(self), level \u003d \"debug\")]\n-    pub fn lower_const_arg(\n-        \u0026self,\n-        const_arg: \u0026hir::ConstArg\u003c\u0027tcx\u003e,\n-        feed: FeedConstTy\u003c\u0027tcx\u003e,\n-    ) -\u003e Const\u003c\u0027tcx\u003e {\n+    pub fn lower_const_arg(\u0026self, const_arg: \u0026hir::ConstArg\u003c\u0027tcx\u003e, ty: Ty\u003c\u0027tcx\u003e) -\u003e Const\u003c\u0027tcx\u003e {\n         let tcx \u003d self.tcx();\n \n-        if let FeedConstTy::WithTy(anon_const_type) \u003d feed\n-            \u0026\u0026 let hir::ConstArgKind::Anon(anon) \u003d \u0026const_arg.kind\n-        {\n+        if let hir::ConstArgKind::Anon(anon) \u003d \u0026const_arg.kind {\n             // FIXME(generic_const_parameter_types): Ideally we remove these errors below when\n             // we have the ability to intermix typeck of anon const const args with the parent\n             // bodies typeck.\n@@ -2366,7 +2331,7 @@ pub fn lower_const_arg(\n             // hir typeck was using equality but mir borrowck wound up using subtyping as that could\n             // result in a non-infer in hir typeck but a region variable in borrowck.\n             if tcx.features().generic_const_parameter_types()\n-                \u0026\u0026 (anon_const_type.has_free_regions() || anon_const_type.has_erased_regions())\n+                \u0026\u0026 (ty.has_free_regions() || ty.has_erased_regions())\n             {\n                 let e \u003d self.dcx().span_err(\n                     const_arg.span,\n@@ -2378,7 +2343,7 @@ pub fn lower_const_arg(\n             // We must error if the instantiated type has any inference variables as we will\n             // use this type to feed the `type_of` and query results must not contain inference\n             // variables otherwise we will ICE.\n-            if anon_const_type.has_non_region_infer() {\n+            if ty.has_non_region_infer() {\n                 let e \u003d self.dcx().span_err(\n                     const_arg.span,\n                     \"anonymous constants with inferred types are not yet supported\",\n@@ -2388,7 +2353,7 @@ pub fn lower_const_arg(\n             }\n             // We error when the type contains unsubstituted generics since we do not currently\n             // give the anon const any of the generics from the parent.\n-            if anon_const_type.has_non_region_param() {\n+            if ty.has_non_region_param() {\n                 let e \u003d self.dcx().span_err(\n                     const_arg.span,\n                     \"anonymous constants referencing generics are not yet supported\",\n@@ -2397,12 +2362,12 @@ pub fn lower_const_arg(\n                 return ty::Const::new_error(tcx, e);\n             }\n \n-            tcx.feed_anon_const_type(anon.def_id, ty::EarlyBinder::bind(anon_const_type));\n+            tcx.feed_anon_const_type(anon.def_id, ty::EarlyBinder::bind(ty));\n         }\n \n         let hir_id \u003d const_arg.hir_id;\n         match const_arg.kind {\n-            hir::ConstArgKind::Tup(exprs) \u003d\u003e self.lower_const_arg_tup(exprs, feed, const_arg.span),\n+            hir::ConstArgKind::Tup(exprs) \u003d\u003e self.lower_const_arg_tup(exprs, ty, const_arg.span),\n             hir::ConstArgKind::Path(hir::QPath::Resolved(maybe_qself, path)) \u003d\u003e {\n                 debug!(?maybe_qself, ?path);\n                 let opt_self_ty \u003d maybe_qself.as_ref().map(|qself| self.lower_ty(qself));\n@@ -2426,16 +2391,12 @@ pub fn lower_const_arg(\n             hir::ConstArgKind::TupleCall(qpath, args) \u003d\u003e {\n                 self.lower_const_arg_tuple_call(hir_id, qpath, args, const_arg.span)\n             }\n-            hir::ConstArgKind::Array(array_expr) \u003d\u003e self.lower_const_arg_array(array_expr, feed),\n+            hir::ConstArgKind::Array(array_expr) \u003d\u003e self.lower_const_arg_array(array_expr, ty),\n             hir::ConstArgKind::Anon(anon) \u003d\u003e self.lower_const_arg_anon(anon),\n             hir::ConstArgKind::Infer(()) \u003d\u003e self.ct_infer(None, const_arg.span),\n             hir::ConstArgKind::Error(e) \u003d\u003e ty::Const::new_error(tcx, e),\n-            hir::ConstArgKind::Literal(kind) if let FeedConstTy::WithTy(anon_const_type) \u003d feed \u003d\u003e {\n-                self.lower_const_arg_literal(\u0026kind, anon_const_type, const_arg.span)\n-            }\n-            hir::ConstArgKind::Literal(..) \u003d\u003e {\n-                let e \u003d self.dcx().span_err(const_arg.span, \"literal of unknown type\");\n-                ty::Const::new_error(tcx, e)\n+            hir::ConstArgKind::Literal(kind) \u003d\u003e {\n+                self.lower_const_arg_literal(\u0026kind, ty, const_arg.span)\n             }\n         }\n     }\n@@ -2443,14 +2404,10 @@ pub fn lower_const_arg(\n     fn lower_const_arg_array(\n         \u0026self,\n         array_expr: \u0026\u0027tcx hir::ConstArgArrayExpr\u003c\u0027tcx\u003e,\n-        feed: FeedConstTy\u003c\u0027tcx\u003e,\n+        ty: Ty\u003c\u0027tcx\u003e,\n     ) -\u003e Const\u003c\u0027tcx\u003e {\n         let tcx \u003d self.tcx();\n \n-        let FeedConstTy::WithTy(ty) \u003d feed else {\n-            return Const::new_error_with_message(tcx, array_expr.span, \"unsupported const array\");\n-        };\n-\n         let ty::Array(elem_ty, _) \u003d ty.kind() else {\n             return Const::new_error_with_message(\n                 tcx,\n@@ -2462,7 +2419,7 @@ fn lower_const_arg_array(\n         let elems \u003d array_expr\n             .elems\n             .iter()\n-            .map(|elem| self.lower_const_arg(elem, FeedConstTy::WithTy(*elem_ty)))\n+            .map(|elem| self.lower_const_arg(elem, *elem_ty))\n             .collect::\u003cVec\u003c_\u003e\u003e();\n \n         let valtree \u003d ty::ValTree::from_branches(tcx, elems);\n@@ -2545,7 +2502,7 @@ fn lower_const_arg_tuple_call(\n             .iter()\n             .zip(args)\n             .map(|(field_def, arg)| {\n-                self.lower_const_arg(arg, FeedConstTy::with_type_of(tcx, field_def.did, adt_args))\n+                self.lower_const_arg(arg, tcx.type_of(field_def.did).instantiate(tcx, adt_args))\n             })\n             .collect::\u003cVec\u003c_\u003e\u003e();\n \n@@ -2564,15 +2521,11 @@ fn lower_const_arg_tuple_call(\n     fn lower_const_arg_tup(\n         \u0026self,\n         exprs: \u0026\u0027tcx [\u0026\u0027tcx hir::ConstArg\u003c\u0027tcx\u003e],\n-        feed: FeedConstTy\u003c\u0027tcx\u003e,\n+        ty: Ty\u003c\u0027tcx\u003e,\n         span: Span,\n     ) -\u003e Const\u003c\u0027tcx\u003e {\n         let tcx \u003d self.tcx();\n \n-        let FeedConstTy::WithTy(ty) \u003d feed else {\n-            return Const::new_error_with_message(tcx, span, \"const tuple lack type information\");\n-        };\n-\n         let ty::Tuple(tys) \u003d ty.kind() else {\n             let e \u003d tcx.dcx().span_err(span, format!(\"expected `{}`, found const tuple\", ty));\n             return Const::new_error(tcx, e);\n@@ -2581,7 +2534,7 @@ fn lower_const_arg_tup(\n         let exprs \u003d exprs\n             .iter()\n             .zip(tys.iter())\n-            .map(|(expr, ty)| self.lower_const_arg(expr, FeedConstTy::WithTy(ty)))\n+            .map(|(expr, ty)| self.lower_const_arg(expr, ty))\n             .collect::\u003cVec\u003c_\u003e\u003e();\n \n         let valtree \u003d ty::ValTree::from_branches(tcx, exprs);\n@@ -2668,7 +2621,7 @@ fn lower_const_arg_struct(\n \n                         self.lower_const_arg(\n                             expr.expr,\n-                            FeedConstTy::with_type_of(tcx, field_def.did, adt_args),\n+                            tcx.type_of(field_def.did).instantiate(tcx, adt_args),\n                         )\n                     }\n                     None \u003d\u003e {\n@@ -3030,7 +2983,7 @@ pub fn lower_ty(\u0026self, hir_ty: \u0026hir::Ty\u003c\u0027tcx\u003e) -\u003e Ty\u003c\u0027tcx\u003e {\n                 .unwrap_or_else(|guar| Ty::new_error(tcx, guar))\n             }\n             hir::TyKind::Array(ty, length) \u003d\u003e {\n-                let length \u003d self.lower_const_arg(length, FeedConstTy::WithTy(tcx.types.usize));\n+                let length \u003d self.lower_const_arg(length, tcx.types.usize);\n                 Ty::new_array_with_const_len(tcx, self.lower_ty(ty), length)\n             }\n             hir::TyKind::Infer(()) \u003d\u003e {\n@@ -3070,8 +3023,8 @@ fn lower_pat_ty_pat(\n                     // Keep this list of types in sync with the list of types that\n                     // the `RangePattern` trait is implemented for.\n                     ty::Int(_) | ty::Uint(_) | ty::Char \u003d\u003e {\n-                        let start \u003d self.lower_const_arg(start, FeedConstTy::WithTy(ty));\n-                        let end \u003d self.lower_const_arg(end, FeedConstTy::WithTy(ty));\n+                        let start \u003d self.lower_const_arg(start, ty);\n+                        let end \u003d self.lower_const_arg(end, ty);\n                         Ok(ty::PatternKind::Range { start, end })\n                     }\n                     _ \u003d\u003e Err(self\ndiff --git a/compiler/rustc_hir_analysis/src/lib.rs b/compiler/rustc_hir_analysis/src/lib.rs\nindex 7296ba6f964..a51355adf72 100644\n--- a/compiler/rustc_hir_analysis/src/lib.rs\n+++ b/compiler/rustc_hir_analysis/src/lib.rs\n@@ -101,7 +101,7 @@\n use rustc_trait_selection::traits;\n \n pub use crate::collect::suggest_impl_trait;\n-use crate::hir_ty_lowering::{FeedConstTy, HirTyLowerer};\n+use crate::hir_ty_lowering::HirTyLowerer;\n \n rustc_fluent_macro::fluent_messages! { \"../messages.ftl\" }\n \n@@ -301,8 +301,8 @@ pub fn lower_ty\u003c\u0027tcx\u003e(tcx: TyCtxt\u003c\u0027tcx\u003e, hir_ty: \u0026hir::Ty\u003c\u0027tcx\u003e) -\u003e Ty\u003c\u0027tcx\u003e {\n pub fn lower_const_arg_for_rustdoc\u003c\u0027tcx\u003e(\n     tcx: TyCtxt\u003c\u0027tcx\u003e,\n     hir_ct: \u0026hir::ConstArg\u003c\u0027tcx\u003e,\n-    feed: FeedConstTy\u003c\u0027tcx\u003e,\n+    ty: Ty\u003c\u0027tcx\u003e,\n ) -\u003e Const\u003c\u0027tcx\u003e {\n     let env_def_id \u003d tcx.hir_get_parent_item(hir_ct.hir_id);\n-    collect::ItemCtxt::new(tcx, env_def_id.def_id).lowerer().lower_const_arg(hir_ct, feed)\n+    collect::ItemCtxt::new(tcx, env_def_id.def_id).lowerer().lower_const_arg(hir_ct, ty)\n }\ndiff --git a/compiler/rustc_hir_typeck/src/expr.rs b/compiler/rustc_hir_typeck/src/expr.rs\nindex d7366887d85..9f3ff0b2d03 100644\n--- a/compiler/rustc_hir_typeck/src/expr.rs\n+++ b/compiler/rustc_hir_typeck/src/expr.rs\n@@ -21,7 +21,7 @@\n use rustc_hir::lang_items::LangItem;\n use rustc_hir::{ExprKind, HirId, QPath, find_attr, is_range_literal};\n use rustc_hir_analysis::NoVariantNamed;\n-use rustc_hir_analysis::hir_ty_lowering::{FeedConstTy, HirTyLowerer as _};\n+use rustc_hir_analysis::hir_ty_lowering::HirTyLowerer as _;\n use rustc_infer::infer::{self, DefineOpaqueTypes, InferOk, RegionVariableOrigin};\n use rustc_infer::traits::query::NoSolution;\n use rustc_middle::ty::adjustment::{Adjust, Adjustment, AllowTwoPhase};\n@@ -1749,10 +1749,7 @@ fn check_expr_repeat(\n         let count_span \u003d count.span;\n         let count \u003d self.try_structurally_resolve_const(\n             count_span,\n-            self.normalize(\n-                count_span,\n-                self.lower_const_arg(count, FeedConstTy::WithTy(tcx.types.usize)),\n-            ),\n+            self.normalize(count_span, self.lower_const_arg(count, tcx.types.usize)),\n         );\n \n         if let Some(count) \u003d count.try_to_target_usize(tcx) {\ndiff --git a/compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs b/compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs\nindex a66ff2a23c2..91f91d91144 100644\n--- a/compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs\n+++ b/compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs\n@@ -14,8 +14,8 @@\n     check_generic_arg_count_for_call, lower_generic_args,\n };\n use rustc_hir_analysis::hir_ty_lowering::{\n-    ExplicitLateBound, FeedConstTy, GenericArgCountMismatch, GenericArgCountResult,\n-    GenericArgsLowerer, GenericPathSegment, HirTyLowerer, IsMethodCall, RegionInferReason,\n+    ExplicitLateBound, GenericArgCountMismatch, GenericArgCountResult, GenericArgsLowerer,\n+    GenericPathSegment, HirTyLowerer, IsMethodCall, RegionInferReason,\n };\n use rustc_infer::infer::canonical::{Canonical, OriginalQueryValues, QueryResponse};\n use rustc_infer::infer::{DefineOpaqueTypes, InferResult};\n@@ -525,9 +525,9 @@ pub(super) fn user_args_for_adt(ty: LoweredTy\u003c\u0027tcx\u003e) -\u003e UserArgs\u003c\u0027tcx\u003e {\n     pub(crate) fn lower_const_arg(\n         \u0026self,\n         const_arg: \u0026\u0027tcx hir::ConstArg\u003c\u0027tcx\u003e,\n-        feed: FeedConstTy\u003c\u0027tcx\u003e,\n+        ty: Ty\u003c\u0027tcx\u003e,\n     ) -\u003e ty::Const\u003c\u0027tcx\u003e {\n-        let ct \u003d self.lowerer().lower_const_arg(const_arg, feed);\n+        let ct \u003d self.lowerer().lower_const_arg(const_arg, ty);\n         self.register_wf_obligation(\n             ct.into(),\n             self.tcx.hir_span(const_arg.hir_id),\n@@ -1228,7 +1228,10 @@ fn provided_kind(\n                         // Ambiguous parts of `ConstArg` are handled in the match arms below\n                         .lower_const_arg(\n                             ct.as_unambig_ct(),\n-                            FeedConstTy::with_type_of(self.fcx.tcx, param.def_id, preceding_args),\n+                            self.fcx\n+                                .tcx\n+                                .type_of(param.def_id)\n+                                .instantiate(self.fcx.tcx, preceding_args),\n                         )\n                         .into(),\n                     (\u0026GenericParamDefKind::Const { .. }, GenericArg::Infer(inf)) \u003d\u003e {\ndiff --git a/compiler/rustc_hir_typeck/src/method/confirm.rs b/compiler/rustc_hir_typeck/src/method/confirm.rs\nindex aab4e398555..270f011b2b1 100644\n--- a/compiler/rustc_hir_typeck/src/method/confirm.rs\n+++ b/compiler/rustc_hir_typeck/src/method/confirm.rs\n@@ -7,7 +7,7 @@\n     check_generic_arg_count_for_call, lower_generic_args,\n };\n use rustc_hir_analysis::hir_ty_lowering::{\n-    FeedConstTy, GenericArgsLowerer, HirTyLowerer, IsMethodCall, RegionInferReason,\n+    GenericArgsLowerer, HirTyLowerer, IsMethodCall, RegionInferReason,\n };\n use rustc_infer::infer::{\n     BoundRegionConversionTime, DefineOpaqueTypes, InferOk, RegionVariableOrigin,\n@@ -447,7 +447,10 @@ fn provided_kind(\n                         // We handle the ambig portions of `ConstArg` in the match arms below\n                         .lower_const_arg(\n                             ct.as_unambig_ct(),\n-                            FeedConstTy::with_type_of(self.cfcx.tcx, param.def_id, preceding_args),\n+                            self.cfcx\n+                                .tcx\n+                                .type_of(param.def_id)\n+                                .instantiate(self.cfcx.tcx, preceding_args),\n                         )\n                         .into(),\n                     (GenericParamDefKind::Const { .. }, GenericArg::Infer(inf)) \u003d\u003e {\ndiff --git a/src/librustdoc/clean/mod.rs b/src/librustdoc/clean/mod.rs\nindex ac17014ebfd..c7c23f75d69 100644\n--- a/src/librustdoc/clean/mod.rs\n+++ b/src/librustdoc/clean/mod.rs\n@@ -43,7 +43,6 @@\n use rustc_hir::def::{CtorKind, DefKind, MacroKinds, Res};\n use rustc_hir::def_id::{DefId, DefIdMap, DefIdSet, LOCAL_CRATE, LocalDefId};\n use rustc_hir::{LangItem, PredicateOrigin, find_attr};\n-use rustc_hir_analysis::hir_ty_lowering::FeedConstTy;\n use rustc_hir_analysis::{lower_const_arg_for_rustdoc, lower_ty};\n use rustc_middle::metadata::Reexport;\n use rustc_middle::middle::resolve_bound_vars as rbv;\n@@ -485,7 +484,7 @@ fn clean_hir_term\u003c\u0027tcx\u003e(\n                 Ty::new_error_with_message(cx.tcx, span, \"cannot find the associated constant\")\n             };\n \n-            let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, c, FeedConstTy::WithTy(ty));\n+            let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, c, ty);\n             Term::Constant(clean_middle_const(ty::Binder::dummy(ct), cx))\n         }\n     }\n@@ -663,12 +662,7 @@ fn clean_generic_param\u003c\u0027tcx\u003e(\n                 ty: Box::new(clean_ty(ty, cx)),\n                 default: default.map(|ct| {\n                     Box::new(\n-                        lower_const_arg_for_rustdoc(\n-                            cx.tcx,\n-                            ct,\n-                            FeedConstTy::WithTy(lower_ty(cx.tcx, ty)),\n-                        )\n-                        .to_string(),\n+                        lower_const_arg_for_rustdoc(cx.tcx, ct, lower_ty(cx.tcx, ty)).to_string(),\n                     )\n                 }),\n             },\n@@ -1831,11 +1825,7 @@ pub(crate) fn clean_ty\u003c\u0027tcx\u003e(ty: \u0026hir::Ty\u003c\u0027tcx\u003e, cx: \u0026mut DocContext\u003c\u0027tcx\u003e) -\u003e T\n             let length \u003d match const_arg.kind {\n                 hir::ConstArgKind::Infer(..) | hir::ConstArgKind::Error(..) \u003d\u003e \"_\".to_string(),\n                 hir::ConstArgKind::Anon(hir::AnonConst { def_id, .. }) \u003d\u003e {\n-                    let ct \u003d lower_const_arg_for_rustdoc(\n-                        cx.tcx,\n-                        const_arg,\n-                        FeedConstTy::WithTy(cx.tcx.types.usize),\n-                    );\n+                    let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, const_arg, cx.tcx.types.usize);\n                     let typing_env \u003d ty::TypingEnv::post_analysis(cx.tcx, *def_id);\n                     let ct \u003d cx.tcx.normalize_erasing_regions(typing_env, ct);\n                     print_const(cx, ct)\n@@ -1846,11 +1836,7 @@ pub(crate) fn clean_ty\u003c\u0027tcx\u003e(ty: \u0026hir::Ty\u003c\u0027tcx\u003e, cx: \u0026mut DocContext\u003c\u0027tcx\u003e) -\u003e T\n                 | hir::ConstArgKind::Tup(..)\n                 | hir::ConstArgKind::Array(..)\n                 | hir::ConstArgKind::Literal(..) \u003d\u003e {\n-                    let ct \u003d lower_const_arg_for_rustdoc(\n-                        cx.tcx,\n-                        const_arg,\n-                        FeedConstTy::WithTy(cx.tcx.types.usize),\n-                    );\n+                    let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, const_arg, cx.tcx.types.usize);\n                     print_const(cx, ct)\n                 }\n             };","expectedMessage":"Remove FeedConstTy","repository":"rust","commitHash":"e27fcfd28eb6b185894e38d1f9fbde216f026f3e","metadata":{"author":"mu001999 \u003cmu001999@outlook.com\u003e"}}
{"id":"rust-d0b76036","diff":" .../src/hir_ty_lowering/bounds.rs                  | 34 +++++------\n .../rustc_hir_analysis/src/hir_ty_lowering/mod.rs  | 53 +++++++++++++---\n compiler/rustc_hir_typeck/src/expr.rs              |  5 +-\n src/librustdoc/clean/mod.rs                        | 70 ++++++++++++++++++----\n 4 files changed, 126 insertions(+), 36 deletions(-)\n\ndiff --git a/compiler/rustc_hir_analysis/src/hir_ty_lowering/bounds.rs b/compiler/rustc_hir_analysis/src/hir_ty_lowering/bounds.rs\nindex 72d21371f66..0a874b88180 100644\n--- a/compiler/rustc_hir_analysis/src/hir_ty_lowering/bounds.rs\n+++ b/compiler/rustc_hir_analysis/src/hir_ty_lowering/bounds.rs\n@@ -510,7 +510,7 @@ pub(super) fn lower_assoc_item_constraint(\n             // Create the generic arguments for the associated type or constant by joining the\n             // parent arguments (the arguments of the trait) and the own arguments (the ones of\n             // the associated item itself) and construct an alias type using them.\n-            let alias_term \u003d candidate.map_bound(|trait_ref| {\n+            candidate.map_bound(|trait_ref| {\n                 let item_segment \u003d hir::PathSegment {\n                     ident: constraint.ident,\n                     hir_id: constraint.hir_id,\n@@ -528,20 +528,7 @@ pub(super) fn lower_assoc_item_constraint(\n                 debug!(?alias_args);\n \n                 ty::AliasTerm::new_from_args(tcx, assoc_item.def_id, alias_args)\n-            });\n-\n-            // Provide the resolved type of the associated constant to `type_of(AnonConst)`.\n-            if let Some(const_arg) \u003d constraint.ct()\n-                \u0026\u0026 let hir::ConstArgKind::Anon(anon_const) \u003d const_arg.kind\n-            {\n-                let ty \u003d alias_term\n-                    .map_bound(|alias| tcx.type_of(alias.def_id).instantiate(tcx, alias.args));\n-                let ty \u003d\n-                    check_assoc_const_binding_type(self, constraint.ident, ty, constraint.hir_id);\n-                tcx.feed_anon_const_type(anon_const.def_id, ty::EarlyBinder::bind(ty));\n-            }\n-\n-            alias_term\n+            })\n         };\n \n         match constraint.kind {\n@@ -555,7 +542,20 @@ pub(super) fn lower_assoc_item_constraint(\n             hir::AssocItemConstraintKind::Equality { term } \u003d\u003e {\n                 let term \u003d match term {\n                     hir::Term::Ty(ty) \u003d\u003e self.lower_ty(ty).into(),\n-                    hir::Term::Const(ct) \u003d\u003e self.lower_const_arg(ct, FeedConstTy::No).into(),\n+                    hir::Term::Const(ct) \u003d\u003e {\n+                        // Provide the resolved type of the associated constant\n+                        let ty \u003d projection_term.map_bound(|alias| {\n+                            tcx.type_of(alias.def_id).instantiate(tcx, alias.args)\n+                        });\n+                        let ty \u003d check_assoc_const_binding_type(\n+                            self,\n+                            constraint.ident,\n+                            ty,\n+                            constraint.hir_id,\n+                        );\n+\n+                        self.lower_const_arg(ct, FeedConstTy::WithTy(ty)).into()\n+                    }\n                 };\n \n                 // Find any late-bound regions declared in `ty` that are not\n@@ -871,7 +871,7 @@ fn lower_return_type_notation_ty(\n /// probably gate this behind another feature flag.\n ///\n /// [^1]: \u003chttps://github.com/rust-lang/project-const-generics/issues/28\u003e.\n-fn check_assoc_const_binding_type\u003c\u0027tcx\u003e(\n+pub(crate) fn check_assoc_const_binding_type\u003c\u0027tcx\u003e(\n     cx: \u0026dyn HirTyLowerer\u003c\u0027tcx\u003e,\n     assoc_const: Ident,\n     ty: ty::Binder\u003c\u0027tcx, Ty\u003c\u0027tcx\u003e\u003e,\ndiff --git a/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs b/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\nindex d2cbf89336d..be5ac21e2ca 100644\n--- a/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\n+++ b/compiler/rustc_hir_analysis/src/hir_ty_lowering/mod.rs\n@@ -1269,10 +1269,13 @@ fn probe_single_bound_for_assoc_item\u003cI\u003e(\n             let mut where_bounds \u003d vec![];\n             for bound in [bound, bound2].into_iter().chain(matching_candidates) {\n                 let bound_id \u003d bound.def_id();\n-                let bound_span \u003d tcx\n-                    .associated_items(bound_id)\n-                    .find_by_ident_and_kind(tcx, assoc_ident, assoc_tag, bound_id)\n-                    .and_then(|item| tcx.hir_span_if_local(item.def_id));\n+                let assoc_item \u003d tcx.associated_items(bound_id).find_by_ident_and_kind(\n+                    tcx,\n+                    assoc_ident,\n+                    assoc_tag,\n+                    bound_id,\n+                );\n+                let bound_span \u003d assoc_item.and_then(|item| tcx.hir_span_if_local(item.def_id));\n \n                 if let Some(bound_span) \u003d bound_span {\n                     err.span_label(\n@@ -1285,7 +1288,41 @@ fn probe_single_bound_for_assoc_item\u003cI\u003e(\n                                 let term: ty::Term\u003c\u0027_\u003e \u003d match term {\n                                     hir::Term::Ty(ty) \u003d\u003e self.lower_ty(ty).into(),\n                                     hir::Term::Const(ct) \u003d\u003e {\n-                                        self.lower_const_arg(ct, FeedConstTy::No).into()\n+                                        let assoc_item \u003d\n+                                            assoc_item.expect(\"assoc_item should be present\");\n+                                        let projection_term \u003d bound.map_bound(|trait_ref| {\n+                                            let item_segment \u003d hir::PathSegment {\n+                                                ident: constraint.ident,\n+                                                hir_id: constraint.hir_id,\n+                                                res: Res::Err,\n+                                                args: Some(constraint.gen_args),\n+                                                infer_args: false,\n+                                            };\n+\n+                                            let alias_args \u003d self.lower_generic_args_of_assoc_item(\n+                                                constraint.ident.span,\n+                                                assoc_item.def_id,\n+                                                \u0026item_segment,\n+                                                trait_ref.args,\n+                                            );\n+                                            ty::AliasTerm::new_from_args(\n+                                                tcx,\n+                                                assoc_item.def_id,\n+                                                alias_args,\n+                                            )\n+                                        });\n+\n+                                        let ty \u003d projection_term.map_bound(|alias| {\n+                                            tcx.type_of(alias.def_id).instantiate(tcx, alias.args)\n+                                        });\n+                                        let ty \u003d bounds::check_assoc_const_binding_type(\n+                                            self,\n+                                            constraint.ident,\n+                                            ty,\n+                                            constraint.hir_id,\n+                                        );\n+\n+                                        self.lower_const_arg(ct, FeedConstTy::WithTy(ty)).into()\n                                     }\n                                 };\n                                 if term.references_error() {\n@@ -2993,7 +3030,7 @@ pub fn lower_ty(\u0026self, hir_ty: \u0026hir::Ty\u003c\u0027tcx\u003e) -\u003e Ty\u003c\u0027tcx\u003e {\n                 .unwrap_or_else(|guar| Ty::new_error(tcx, guar))\n             }\n             hir::TyKind::Array(ty, length) \u003d\u003e {\n-                let length \u003d self.lower_const_arg(length, FeedConstTy::No);\n+                let length \u003d self.lower_const_arg(length, FeedConstTy::WithTy(tcx.types.usize));\n                 Ty::new_array_with_const_len(tcx, self.lower_ty(ty), length)\n             }\n             hir::TyKind::Infer(()) \u003d\u003e {\n@@ -3033,8 +3070,8 @@ fn lower_pat_ty_pat(\n                     // Keep this list of types in sync with the list of types that\n                     // the `RangePattern` trait is implemented for.\n                     ty::Int(_) | ty::Uint(_) | ty::Char \u003d\u003e {\n-                        let start \u003d self.lower_const_arg(start, FeedConstTy::No);\n-                        let end \u003d self.lower_const_arg(end, FeedConstTy::No);\n+                        let start \u003d self.lower_const_arg(start, FeedConstTy::WithTy(ty));\n+                        let end \u003d self.lower_const_arg(end, FeedConstTy::WithTy(ty));\n                         Ok(ty::PatternKind::Range { start, end })\n                     }\n                     _ \u003d\u003e Err(self\ndiff --git a/compiler/rustc_hir_typeck/src/expr.rs b/compiler/rustc_hir_typeck/src/expr.rs\nindex 9d7e09b020a..d7366887d85 100644\n--- a/compiler/rustc_hir_typeck/src/expr.rs\n+++ b/compiler/rustc_hir_typeck/src/expr.rs\n@@ -1749,7 +1749,10 @@ fn check_expr_repeat(\n         let count_span \u003d count.span;\n         let count \u003d self.try_structurally_resolve_const(\n             count_span,\n-            self.normalize(count_span, self.lower_const_arg(count, FeedConstTy::No)),\n+            self.normalize(\n+                count_span,\n+                self.lower_const_arg(count, FeedConstTy::WithTy(tcx.types.usize)),\n+            ),\n         );\n \n         if let Some(count) \u003d count.try_to_target_usize(tcx) {\ndiff --git a/src/librustdoc/clean/mod.rs b/src/librustdoc/clean/mod.rs\nindex 597a85f3976..ac17014ebfd 100644\n--- a/src/librustdoc/clean/mod.rs\n+++ b/src/librustdoc/clean/mod.rs\n@@ -469,11 +469,23 @@ fn clean_middle_term\u003c\u0027tcx\u003e(\n     }\n }\n \n-fn clean_hir_term\u003c\u0027tcx\u003e(term: \u0026hir::Term\u003c\u0027tcx\u003e, cx: \u0026mut DocContext\u003c\u0027tcx\u003e) -\u003e Term {\n+fn clean_hir_term\u003c\u0027tcx\u003e(\n+    assoc_item: Option\u003cDefId\u003e,\n+    term: \u0026hir::Term\u003c\u0027tcx\u003e,\n+    span: rustc_span::Span,\n+    cx: \u0026mut DocContext\u003c\u0027tcx\u003e,\n+) -\u003e Term {\n     match term {\n         hir::Term::Ty(ty) \u003d\u003e Term::Type(clean_ty(ty, cx)),\n         hir::Term::Const(c) \u003d\u003e {\n-            let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, c, FeedConstTy::No);\n+            let ty \u003d if let Some(assoc_item) \u003d assoc_item {\n+                // FIXME(generic_const_items): this should instantiate with the alias item\u0027s args\n+                cx.tcx.type_of(assoc_item).instantiate_identity()\n+            } else {\n+                Ty::new_error_with_message(cx.tcx, span, \"cannot find the associated constant\")\n+            };\n+\n+            let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, c, FeedConstTy::WithTy(ty));\n             Term::Constant(clean_middle_const(ty::Binder::dummy(ct), cx))\n         }\n     }\n@@ -650,7 +662,14 @@ fn clean_generic_param\u003c\u0027tcx\u003e(\n             GenericParamDefKind::Const {\n                 ty: Box::new(clean_ty(ty, cx)),\n                 default: default.map(|ct| {\n-                    Box::new(lower_const_arg_for_rustdoc(cx.tcx, ct, FeedConstTy::No).to_string())\n+                    Box::new(\n+                        lower_const_arg_for_rustdoc(\n+                            cx.tcx,\n+                            ct,\n+                            FeedConstTy::WithTy(lower_ty(cx.tcx, ty)),\n+                        )\n+                        .to_string(),\n+                    )\n                 }),\n             },\n         ),\n@@ -1531,7 +1550,7 @@ fn first_non_private_clean_path\u003c\u0027tcx\u003e(\n         \u0026\u0026 path_last.args.is_some()\n     {\n         assert!(new_path_last.args.is_empty());\n-        new_path_last.args \u003d clean_generic_args(path_last_args, cx);\n+        new_path_last.args \u003d clean_generic_args(None, path_last_args, cx);\n     }\n     new_clean_path\n }\n@@ -1812,7 +1831,11 @@ pub(crate) fn clean_ty\u003c\u0027tcx\u003e(ty: \u0026hir::Ty\u003c\u0027tcx\u003e, cx: \u0026mut DocContext\u003c\u0027tcx\u003e) -\u003e T\n             let length \u003d match const_arg.kind {\n                 hir::ConstArgKind::Infer(..) | hir::ConstArgKind::Error(..) \u003d\u003e \"_\".to_string(),\n                 hir::ConstArgKind::Anon(hir::AnonConst { def_id, .. }) \u003d\u003e {\n-                    let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, const_arg, FeedConstTy::No);\n+                    let ct \u003d lower_const_arg_for_rustdoc(\n+                        cx.tcx,\n+                        const_arg,\n+                        FeedConstTy::WithTy(cx.tcx.types.usize),\n+                    );\n                     let typing_env \u003d ty::TypingEnv::post_analysis(cx.tcx, *def_id);\n                     let ct \u003d cx.tcx.normalize_erasing_regions(typing_env, ct);\n                     print_const(cx, ct)\n@@ -1823,7 +1846,11 @@ pub(crate) fn clean_ty\u003c\u0027tcx\u003e(ty: \u0026hir::Ty\u003c\u0027tcx\u003e, cx: \u0026mut DocContext\u003c\u0027tcx\u003e) -\u003e T\n                 | hir::ConstArgKind::Tup(..)\n                 | hir::ConstArgKind::Array(..)\n                 | hir::ConstArgKind::Literal(..) \u003d\u003e {\n-                    let ct \u003d lower_const_arg_for_rustdoc(cx.tcx, const_arg, FeedConstTy::No);\n+                    let ct \u003d lower_const_arg_for_rustdoc(\n+                        cx.tcx,\n+                        const_arg,\n+                        FeedConstTy::WithTy(cx.tcx.types.usize),\n+                    );\n                     print_const(cx, ct)\n                 }\n             };\n@@ -2516,6 +2543,7 @@ fn clean_path\u003c\u0027tcx\u003e(path: \u0026hir::Path\u003c\u0027tcx\u003e, cx: \u0026mut DocContext\u003c\u0027tcx\u003e) -\u003e Path {\n }\n \n fn clean_generic_args\u003c\u0027tcx\u003e(\n+    trait_did: Option\u003cDefId\u003e,\n     generic_args: \u0026hir::GenericArgs\u003c\u0027tcx\u003e,\n     cx: \u0026mut DocContext\u003c\u0027tcx\u003e,\n ) -\u003e GenericArgs {\n@@ -2539,7 +2567,13 @@ fn clean_generic_args\u003c\u0027tcx\u003e(\n             let constraints \u003d generic_args\n                 .constraints\n                 .iter()\n-                .map(|c| clean_assoc_item_constraint(c, cx))\n+                .map(|c| {\n+                    clean_assoc_item_constraint(\n+                        trait_did.expect(\"only trait ref has constraints\"),\n+                        c,\n+                        cx,\n+                    )\n+                })\n                 .collect::\u003cThinVec\u003c_\u003e\u003e();\n             GenericArgs::AngleBracketed { args, constraints }\n         }\n@@ -2562,7 +2596,11 @@ fn clean_path_segment\u003c\u0027tcx\u003e(\n     path: \u0026hir::PathSegment\u003c\u0027tcx\u003e,\n     cx: \u0026mut DocContext\u003c\u0027tcx\u003e,\n ) -\u003e PathSegment {\n-    PathSegment { name: path.ident.name, args: clean_generic_args(path.args(), cx) }\n+    let trait_did \u003d match path.res {\n+        hir::def::Res::Def(DefKind::Trait | DefKind::TraitAlias, did) \u003d\u003e Some(did),\n+        _ \u003d\u003e None,\n+    };\n+    PathSegment { name: path.ident.name, args: clean_generic_args(trait_did, path.args(), cx) }\n }\n \n fn clean_bare_fn_ty\u003c\u0027tcx\u003e(\n@@ -3126,17 +3164,29 @@ fn clean_maybe_renamed_foreign_item\u003c\u0027tcx\u003e(\n }\n \n fn clean_assoc_item_constraint\u003c\u0027tcx\u003e(\n+    trait_did: DefId,\n     constraint: \u0026hir::AssocItemConstraint\u003c\u0027tcx\u003e,\n     cx: \u0026mut DocContext\u003c\u0027tcx\u003e,\n ) -\u003e AssocItemConstraint {\n     AssocItemConstraint {\n         assoc: PathSegment {\n             name: constraint.ident.name,\n-            args: clean_generic_args(constraint.gen_args, cx),\n+            args: clean_generic_args(None, constraint.gen_args, cx),\n         },\n         kind: match constraint.kind {\n             hir::AssocItemConstraintKind::Equality { ref term } \u003d\u003e {\n-                AssocItemConstraintKind::Equality { term: clean_hir_term(term, cx) }\n+                let assoc_tag \u003d match term {\n+                    hir::Term::Ty(_) \u003d\u003e ty::AssocTag::Type,\n+                    hir::Term::Const(_) \u003d\u003e ty::AssocTag::Const,\n+                };\n+                let assoc_item \u003d cx\n+                    .tcx\n+                    .associated_items(trait_did)\n+                    .find_by_ident_and_kind(cx.tcx, constraint.ident, assoc_tag, trait_did)\n+                    .map(|item| item.def_id);\n+                AssocItemConstraintKind::Equality {\n+                    term: clean_hir_term(assoc_item, term, constraint.span, cx),\n+                }\n             }\n             hir::AssocItemConstraintKind::Bound { bounds } \u003d\u003e AssocItemConstraintKind::Bound {\n                 bounds: bounds.iter().filter_map(|b| clean_generic_bound(b, cx)).collect(),","expectedMessage":"Remove all usage of FeedConstTy::No","repository":"rust","commitHash":"d0b760369f46eeb8ded4d7420d67d7bdc9f02dd1","metadata":{"author":"mu001999 \u003cmu001999@outlook.com\u003e"}}
{"id":"rust-db10879f","diff":" compiler/rustc_codegen_gcc/src/lib.rs              |  3 +-\n compiler/rustc_codegen_llvm/src/lib.rs             |  2 +-\n .../rustc_codegen_ssa/src/back/symbol_export.rs    | 18 ++++-----\n compiler/rustc_codegen_ssa/src/lib.rs              |  6 +--\n compiler/rustc_const_eval/src/lib.rs               | 16 ++++----\n compiler/rustc_interface/src/passes.rs             | 46 +++++++++++-----------\n compiler/rustc_metadata/src/rmeta/mod.rs           |  2 +-\n compiler/rustc_middle/src/util/mod.rs              | 17 --------\n compiler/rustc_mir_build/src/lib.rs                | 12 +++---\n compiler/rustc_mir_transform/src/lib.rs            |  6 +--\n compiler/rustc_monomorphize/src/collector.rs       |  2 +-\n compiler/rustc_monomorphize/src/lib.rs             |  2 +-\n compiler/rustc_monomorphize/src/partitioning.rs    |  8 ++--\n compiler/rustc_passes/src/lib.rs                   |  2 +-\n src/librustdoc/core.rs                             |  9 +++--\n src/tools/miri/src/bin/miri.rs                     |  2 +-\n tests/ui-fulldeps/obtain-borrowck.rs               |  6 +--\n 17 files changed, 72 insertions(+), 87 deletions(-)","expectedMessage":"Rollup merge of #151096 - rm-providers-deref, r\u003doli-obk","repository":"rust","commitHash":"db10879fd1ff0861b39da41b47de8a7e44156d2c","metadata":{"author":"Jonathan Brouwer \u003cjonathantbrouwer@gmail.com\u003e"}}
