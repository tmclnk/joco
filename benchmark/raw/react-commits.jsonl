{"id":"react-bb8a76c6","diff":" .../src/devtools/views/Components/Components.css                   | 2 ++\n .../src/devtools/views/Components/Components.js                    | 6 +++++-\n .../src/devtools/views/Components/InspectedElement.css             | 7 +++++--\n .../src/devtools/views/Components/InspectedElement.js              | 4 ++++\n .../src/devtools/views/InspectedElement/InspectedElementPane.js    | 1 +\n .../src/devtools/views/SuspenseTab/SuspenseTab.css                 | 2 ++\n .../src/devtools/views/SuspenseTab/SuspenseTab.js                  | 6 +++++-\n 7 files changed, 24 insertions(+), 4 deletions(-)\n\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Components/Components.css b/packages/react-devtools-shared/src/devtools/views/Components/Components.css\nindex 8df59f7..b977a36 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Components/Components.css\n+++ b/packages/react-devtools-shared/src/devtools/views/Components/Components.css\n@@ -22,6 +22,7 @@\n   flex: 1 1 35%;\n   overflow-x: hidden;\n   overflow-y: auto;\n+  border-left: 1px solid var(--color-border);\n }\n \n .ResizeBarWrapper {\n@@ -55,6 +56,7 @@\n \n   .InspectedElementWrapper {\n     flex: 1 1 50%;\n+    border-left: none;\n   }\n \n   .ResizeBar {\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Components/Components.js b/packages/react-devtools-shared/src/devtools/views/Components/Components.js\nindex 1f0927d..80b6d45 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Components/Components.js\n+++ b/packages/react-devtools-shared/src/devtools/views/Components/Components.js\n@@ -159,7 +159,11 @@ function Components(_: {}) {\n             \u003cdiv className\u003d{styles.InspectedElementWrapper}\u003e\n               \u003cNativeStyleContextController\u003e\n                 \u003cInspectedElementErrorBoundary\u003e\n-                  \u003cInspectedElement /\u003e\n+                  \u003cInspectedElement\n+                    fallbackEmpty\u003d{\n+                      \u0027No React element selected. Select an element in the tree to inspect.\u0027\n+                    }\n+                  /\u003e\n                 \u003c/InspectedElementErrorBoundary\u003e\n               \u003c/NativeStyleContextController\u003e\n             \u003c/div\u003e\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.css b/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.css\nindex 7b00c0c..f9e60f0 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.css\n+++ b/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.css\n@@ -3,7 +3,6 @@\n   flex-direction: column;\n   height: 100%;\n   width: 100%;\n-  border-left: 1px solid var(--color-border);\n   border-top: 1px solid var(--color-border);\n }\n \n@@ -69,7 +68,11 @@\n   padding: 0.25rem;\n   color: var(--color-dimmer);\n   font-style: italic;\n-  border-left: 1px solid var(--color-border);\n+}\n+\n+.NoInspectionFallback {\n+  padding: 0.25rem;\n+  font-style: italic;\n }\n \n .StrictModeNonCompliant {\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.js b/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.js\nindex 7ba7067..af5c8d4 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.js\n+++ b/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.js\n@@ -36,6 +36,8 @@ import Tooltip from \u0027./reach-ui/tooltip\u0027;\n \n export type Props \u003d {\n   actionButtons?: React.Node,\n+  /** fallback to show when no element is inspected */\n+  fallbackEmpty: React.Node,\n };\n \n // TODO Make edits and deletes also use transition API!\n@@ -44,6 +46,7 @@ const noSourcePromise \u003d Promise.resolve(null);\n \n export default function InspectedElementWrapper({\n   actionButtons,\n+  fallbackEmpty,\n }: Props): React.Node {\n   const {inspectedElementID} \u003d useContext(TreeStateContext);\n   const bridge \u003d useContext(BridgeContext);\n@@ -193,6 +196,7 @@ export default function InspectedElementWrapper({\n     return (\n       \u003cdiv className\u003d{styles.InspectedElement}\u003e\n         \u003cdiv className\u003d{styles.TitleRow} /\u003e\n+        \u003cdiv className\u003d{styles.NoInspectionFallback}\u003e{fallbackEmpty}\u003c/div\u003e\n       \u003c/div\u003e\n     );\n   }\ndiff --git a/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.js b/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.js\nindex 0d5b523..a47bffd 100644\n--- a/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.js\n+++ b/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.js\n@@ -25,6 +25,7 @@ function InspectedElementPane() {\n       \u003cdiv className\u003d{styles.InspectedElementPane}\u003e\n         \u003cInspectedElement\n           actionButtons\u003d{!hideSettings \u0026\u0026 \u003cSettingsModalContextToggle /\u003e}\n+          fallbackEmpty\u003d{\"Selected element wasn\u0027t rendered with React.\"}\n         /\u003e\n         \u003cSettingsModal /\u003e\n       \u003c/div\u003e\ndiff --git a/packages/react-devtools-shared/src/devtools/views/SuspenseTab/SuspenseTab.css b/packages/react-devtools-shared/src/devtools/views/SuspenseTab/SuspenseTab.css\nindex 0b1d85b..a7915d0 100644\n--- a/packages/react-devtools-shared/src/devtools/views/SuspenseTab/SuspenseTab.css\n+++ b/packages/react-devtools-shared/src/devtools/views/SuspenseTab/SuspenseTab.css\n@@ -35,6 +35,7 @@\n   flex: 0 0 calc(100% - var(--horizontal-resize-tree-percentage));\n   overflow-x: hidden;\n   overflow-y: auto;\n+  border-left: 1px solid var(--color-border);\n }\n \n .ResizeBarWrapper {\n@@ -70,6 +71,7 @@\n \n   .InspectedElementWrapper {\n     flex: 0 0 calc(100% - var(--vertical-resize-tree-percentage));\n+    border-left: none;\n   }\n \n   .TreeWrapper + .ResizeBarWrapper .ResizeBar {\ndiff --git a/packages/react-devtools-shared/src/devtools/views/SuspenseTab/SuspenseTab.js b/packages/react-devtools-shared/src/devtools/views/SuspenseTab/SuspenseTab.js\nindex 36351f8..bd5de7d 100644\n--- a/packages/react-devtools-shared/src/devtools/views/SuspenseTab/SuspenseTab.js\n+++ b/packages/react-devtools-shared/src/devtools/views/SuspenseTab/SuspenseTab.js\n@@ -543,7 +543,11 @@ function SuspenseTab(_: {}) {\n           className\u003d{styles.InspectedElementWrapper}\n           hidden\u003d{inspectedElementHidden}\u003e\n           \u003cInspectedElementErrorBoundary\u003e\n-            \u003cInspectedElement /\u003e\n+            \u003cInspectedElement\n+              fallbackEmpty\u003d{\n+                \u0027No React element selected. Select a Suspense boundary in the minimap to inspect.\u0027\n+              }\n+            /\u003e\n           \u003c/InspectedElementErrorBoundary\u003e\n         \u003c/div\u003e\n         \u003cSettingsModal /\u003e","expectedMessage":"[DevTools] Show fallback in inspected element pane when no element is selected (#35503)","repository":"react","commitHash":"bb8a76c6cc77ea2976d690ea09f5a1b3d9b1792a","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-fae15df4","diff":" .../src/main/elementSelection.js                   |  2 +-\n .../react-devtools-extensions/src/main/index.js    | 49 ++++++++++++++++++++++\n .../devtools/views/Components/InspectedElement.css |  8 ++++\n .../devtools/views/Components/InspectedElement.js  | 15 ++++++-\n .../src/devtools/views/DevTools.js                 | 11 +++++\n .../InspectedElement/InspectedElementPane.css      | 15 +++++++\n .../views/InspectedElement/InspectedElementPane.js | 34 +++++++++++++++\n 7 files changed, 131 insertions(+), 3 deletions(-)\n\ndiff --git a/packages/react-devtools-extensions/src/main/elementSelection.js b/packages/react-devtools-extensions/src/main/elementSelection.js\nindex 315482e..10dd81d 100644\n--- a/packages/react-devtools-extensions/src/main/elementSelection.js\n+++ b/packages/react-devtools-extensions/src/main/elementSelection.js\n@@ -32,7 +32,7 @@ export function setReactSelectionFromBrowser(bridge) {\n           return;\n         }\n \n-        // Remember to sync the selection next time we show Components tab.\n+        // Remember to sync the selection next time we show inspected element\n         bridge.send(\u0027syncSelectionFromBuiltinElementsPanel\u0027);\n       }\n     },\ndiff --git a/packages/react-devtools-extensions/src/main/index.js b/packages/react-devtools-extensions/src/main/index.js\nindex 03f9c2b..5d7bd37 100644\n--- a/packages/react-devtools-extensions/src/main/index.js\n+++ b/packages/react-devtools-extensions/src/main/index.js\n@@ -206,6 +206,7 @@ function createBridgeAndStore() {\n         bridge,\n         browserTheme: getBrowserTheme(),\n         componentsPortalContainer,\n+        inspectedElementPortalContainer,\n         profilerPortalContainer,\n         editorPortalContainer,\n         currentSelectedSource,\n@@ -278,6 +279,51 @@ function createComponentsPanel() {\n   );\n }\n \n+function createElementsInspectPanel() {\n+  if (inspectedElementPortalContainer) {\n+    // Panel is created and user opened it at least once\n+    ensureInitialHTMLIsCleared(inspectedElementPortalContainer);\n+    render();\n+\n+    return;\n+  }\n+\n+  if (inspectedElementPane) {\n+    // Panel is created, but wasn\u0027t opened yet, so no document is present for it\n+    return;\n+  }\n+\n+  const elementsPanel \u003d chrome.devtools.panels.elements;\n+  if (__IS_FIREFOX__ || !elementsPanel || !elementsPanel.createSidebarPane) {\n+    // Firefox will not pass the window to the onShown listener despite setPage\n+    // being called.\n+    // See https://bugzilla.mozilla.org/show_bug.cgi?id\u003d2010549\n+\n+    // May not be supported in some browsers.\n+    // See https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/devtools/panels/ElementsPanel/createSidebarPane#browser_compatibility\n+    return;\n+  }\n+\n+  elementsPanel.createSidebarPane(\u0027React Element ⚛\u0027, createdPane \u003d\u003e {\n+    inspectedElementPane \u003d createdPane;\n+\n+    createdPane.setPage(\u0027panel.html\u0027);\n+    createdPane.setHeight(\u002775px\u0027);\n+\n+    createdPane.onShown.addListener(portal \u003d\u003e {\n+      inspectedElementPortalContainer \u003d portal.container;\n+      if (inspectedElementPortalContainer !\u003d null \u0026\u0026 render) {\n+        ensureInitialHTMLIsCleared(inspectedElementPortalContainer);\n+\n+        render();\n+        portal.injectStyles(cloneStyleTags);\n+\n+        logEvent({event_name: \u0027selected-inspected-element-pane\u0027});\n+      }\n+    });\n+  });\n+}\n+\n function createProfilerPanel() {\n   if (profilerPortalContainer) {\n     // Panel is created and user opened it at least once\n@@ -508,6 +554,7 @@ function mountReactDevTools() {\n   createComponentsPanel();\n   createProfilerPanel();\n   createSourcesEditorPanel();\n+  createElementsInspectPanel();\n   // Suspense Tab is created via the hook\n   // TODO(enableSuspenseTab): Create eagerly once Suspense tab is stable\n }\n@@ -556,10 +603,12 @@ let componentsPanel \u003d null;\n let profilerPanel \u003d null;\n let suspensePanel \u003d null;\n let editorPane \u003d null;\n+let inspectedElementPane \u003d null;\n let componentsPortalContainer \u003d null;\n let profilerPortalContainer \u003d null;\n let suspensePortalContainer \u003d null;\n let editorPortalContainer \u003d null;\n+let inspectedElementPortalContainer \u003d null;\n \n let mostRecentOverrideTab \u003d null;\n let render \u003d null;\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.css b/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.css\nindex 156b28f..7b00c0c 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.css\n+++ b/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.css\n@@ -77,3 +77,11 @@\n   padding: 0.25rem;\n   color: var(--color-console-error-icon);\n }\n+\n+.VRule {\n+  height: 20px;\n+  width: 1px;\n+  flex: 0 0 1px;\n+  margin: 0 0.5rem;\n+  background-color: var(--color-border);\n+}\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.js b/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.js\nindex 633a4d3..7ba7067 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.js\n+++ b/packages/react-devtools-shared/src/devtools/views/Components/InspectedElement.js\n@@ -34,13 +34,17 @@ import useEditorURL from \u0027../useEditorURL\u0027;\n import styles from \u0027./InspectedElement.css\u0027;\n import Tooltip from \u0027./reach-ui/tooltip\u0027;\n \n-export type Props \u003d {};\n+export type Props \u003d {\n+  actionButtons?: React.Node,\n+};\n \n // TODO Make edits and deletes also use transition API!\n \n const noSourcePromise \u003d Promise.resolve(null);\n \n-export default function InspectedElementWrapper(_: Props): React.Node {\n+export default function InspectedElementWrapper({\n+  actionButtons,\n+}: Props): React.Node {\n   const {inspectedElementID} \u003d useContext(TreeStateContext);\n   const bridge \u003d useContext(BridgeContext);\n   const store \u003d useContext(StoreContext);\n@@ -305,6 +309,13 @@ export default function InspectedElementWrapper(_: Props): React.Node {\n             symbolicatedSourcePromise\u003d{symbolicatedSourcePromise}\n           /\u003e\n         )}\n+\n+        {actionButtons \u0026\u0026 (\n+          \u003c\u003e\n+            \u003cdiv className\u003d{styles.VRule} /\u003e\n+            {actionButtons}\n+          \u003c/\u003e\n+        )}\n       \u003c/div\u003e\n \n       {inspectedElement \u003d\u003d\u003d null \u0026\u0026 (\ndiff --git a/packages/react-devtools-shared/src/devtools/views/DevTools.js b/packages/react-devtools-shared/src/devtools/views/DevTools.js\nindex 6ddacef..dc47157 100644\n--- a/packages/react-devtools-shared/src/devtools/views/DevTools.js\n+++ b/packages/react-devtools-shared/src/devtools/views/DevTools.js\n@@ -26,6 +26,7 @@ import Profiler from \u0027./Profiler/Profiler\u0027;\n import SuspenseTab from \u0027./SuspenseTab/SuspenseTab\u0027;\n import TabBar from \u0027./TabBar\u0027;\n import EditorPane from \u0027./Editor/EditorPane\u0027;\n+import InspectedElementPane from \u0027./InspectedElement/InspectedElementPane\u0027;\n import {SettingsContextController} from \u0027./Settings/SettingsContext\u0027;\n import {TreeContextController} from \u0027./Components/TreeContext\u0027;\n import ViewElementSourceContext from \u0027./Components/ViewElementSourceContext\u0027;\n@@ -100,6 +101,7 @@ export type Props \u003d {\n   // The root \u003cDevTools\u003e app is rendered in the top-level extension window,\n   // but individual tabs (e.g. Components, Profiling) can be rendered into portals within their browser panels.\n   componentsPortalContainer?: Element,\n+  inspectedElementPortalContainer?: Element,\n   profilerPortalContainer?: Element,\n   suspensePortalContainer?: Element,\n   editorPortalContainer?: Element,\n@@ -155,6 +157,7 @@ export default function DevTools({\n   canViewElementSourceFunction,\n   componentsPortalContainer,\n   editorPortalContainer,\n+  inspectedElementPortalContainer,\n   profilerPortalContainer,\n   suspensePortalContainer,\n   currentSelectedSource,\n@@ -379,6 +382,14 @@ export default function DevTools({\n                                       portalContainer\u003d{editorPortalContainer}\n                                     /\u003e\n                                   ) : null}\n+                                  {inspectedElementPortalContainer ? (\n+                                    \u003cInspectedElementPane\n+                                      selectedSource\u003d{currentSelectedSource}\n+                                      portalContainer\u003d{\n+                                        inspectedElementPortalContainer\n+                                      }\n+                                    /\u003e\n+                                  ) : null}\n                                 \u003c/ThemeProvider\u003e\n                               \u003c/SuspenseTreeContextController\u003e\n                             \u003c/InspectedElementContextController\u003e\ndiff --git a/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.css b/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.css\nnew file mode 100644\nindex 0000000..5d0cd2e\n--- /dev/null\n+++ b/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.css\n@@ -0,0 +1,15 @@\n+.InspectedElementPane, .InspectedElementPane * {\n+  box-sizing: border-box;\n+  -webkit-font-smoothing: var(--font-smoothing);\n+}\n+\n+.InspectedElementPane {\n+  position: relative;\n+  width: 100%;\n+  height: 100%;\n+  display: flex;\n+  flex-direction: row;\n+  background-color: var(--color-background);\n+  color: var(--color-text);\n+  font-family: var(--font-family-sans);\n+}\ndiff --git a/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.js b/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.js\nnew file mode 100644\nindex 0000000..0d5b523\n--- /dev/null\n+++ b/packages/react-devtools-shared/src/devtools/views/InspectedElement/InspectedElementPane.js\n@@ -0,0 +1,34 @@\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ *\n+ * @flow\n+ */\n+\n+import * as React from \u0027react\u0027;\n+import {useContext} from \u0027react\u0027;\n+\n+import portaledContent from \u0027react-devtools-shared/src/devtools/views/portaledContent\u0027;\n+import {OptionsContext} from \u0027react-devtools-shared/src/devtools/views/context\u0027;\n+import InspectedElement from \u0027react-devtools-shared/src/devtools/views/Components/InspectedElement\u0027;\n+import SettingsModal from \u0027react-devtools-shared/src/devtools/views/Settings/SettingsModal\u0027;\n+import SettingsModalContextToggle from \u0027react-devtools-shared/src/devtools/views/Settings/SettingsModalContextToggle\u0027;\n+import {SettingsModalContextController} from \u0027react-devtools-shared/src/devtools/views/Settings/SettingsModalContext\u0027;\n+import styles from \u0027./InspectedElementPane.css\u0027;\n+\n+function InspectedElementPane() {\n+  const {hideSettings} \u003d useContext(OptionsContext);\n+  return (\n+    \u003cSettingsModalContextController\u003e\n+      \u003cdiv className\u003d{styles.InspectedElementPane}\u003e\n+        \u003cInspectedElement\n+          actionButtons\u003d{!hideSettings \u0026\u0026 \u003cSettingsModalContextToggle /\u003e}\n+        /\u003e\n+        \u003cSettingsModal /\u003e\n+      \u003c/div\u003e\n+    \u003c/SettingsModalContextController\u003e\n+  );\n+}\n+export default (portaledContent(InspectedElementPane): component());","expectedMessage":"[DevTools] Add React Element pane to browser Elements panel (#35240)","repository":"react","commitHash":"fae15df40ef878fda68756176d501a4cb83cc9bc","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-53daaf5a","diff":" packages/react-debug-tools/src/ReactDebugHooks.js  |   6 +-\n .../__tests__/profilerChangeDescriptions-test.js   |   8 +-\n .../src/__tests__/profilingCache-test.js           | 249 ++++++++++++++++++++-\n .../src/backend/fiber/renderer.js                  |  95 +++-----\n 4 files changed, 290 insertions(+), 68 deletions(-)\n\ndiff --git a/packages/react-debug-tools/src/ReactDebugHooks.js b/packages/react-debug-tools/src/ReactDebugHooks.js\nindex db9495a..b4eb6c2 100644\n--- a/packages/react-debug-tools/src/ReactDebugHooks.js\n+++ b/packages/react-debug-tools/src/ReactDebugHooks.js\n@@ -467,9 +467,11 @@ function useSyncExternalStore\u003cT\u003e(\n   // useSyncExternalStore() composes multiple hooks internally.\n   // Advance the current hook index the same number of times\n   // so that subsequent hooks have the right memoized state.\n-  nextHook(); // SyncExternalStore\n+  const hook \u003d nextHook(); // SyncExternalStore\n   nextHook(); // Effect\n-  const value \u003d getSnapshot();\n+  // Read from hook.memoizedState to get the value that was used during render,\n+  // not the current value from getSnapshot() which may have changed.\n+  const value \u003d hook !\u003d\u003d null ? hook.memoizedState : getSnapshot();\n   hookLog.push({\n     displayName: null,\n     primitive: \u0027SyncExternalStore\u0027,\ndiff --git a/packages/react-devtools-shared/src/__tests__/profilerChangeDescriptions-test.js b/packages/react-devtools-shared/src/__tests__/profilerChangeDescriptions-test.js\nindex 87d8132..4710f5c 100644\n--- a/packages/react-devtools-shared/src/__tests__/profilerChangeDescriptions-test.js\n+++ b/packages/react-devtools-shared/src/__tests__/profilerChangeDescriptions-test.js\n@@ -90,7 +90,7 @@ describe(\u0027Profiler change descriptions\u0027, () \u003d\u003e {\n       {\n         \"context\": true,\n         \"didHooksChange\": false,\n-        \"hooks\": null,\n+        \"hooks\": [],\n         \"isFirstMount\": false,\n         \"props\": [],\n         \"state\": null,\n@@ -110,7 +110,7 @@ describe(\u0027Profiler change descriptions\u0027, () \u003d\u003e {\n       {\n         \"context\": true,\n         \"didHooksChange\": false,\n-        \"hooks\": null,\n+        \"hooks\": [],\n         \"isFirstMount\": false,\n         \"props\": [],\n         \"state\": null,\n@@ -125,7 +125,7 @@ describe(\u0027Profiler change descriptions\u0027, () \u003d\u003e {\n       {\n         \"context\": false,\n         \"didHooksChange\": false,\n-        \"hooks\": null,\n+        \"hooks\": [],\n         \"isFirstMount\": false,\n         \"props\": [],\n         \"state\": null,\n@@ -140,7 +140,7 @@ describe(\u0027Profiler change descriptions\u0027, () \u003d\u003e {\n       {\n         \"context\": true,\n         \"didHooksChange\": false,\n-        \"hooks\": null,\n+        \"hooks\": [],\n         \"isFirstMount\": false,\n         \"props\": [],\n         \"state\": null,\ndiff --git a/packages/react-devtools-shared/src/__tests__/profilingCache-test.js b/packages/react-devtools-shared/src/__tests__/profilingCache-test.js\nindex 428b22d..c17a59c 100644\n--- a/packages/react-devtools-shared/src/__tests__/profilingCache-test.js\n+++ b/packages/react-devtools-shared/src/__tests__/profilingCache-test.js\n@@ -378,6 +378,12 @@ describe(\u0027ProfilingCache\u0027, () \u003d\u003e {\n       ),\n     );\n \n+    // Save references to the real dispatch/setState functions.\n+    // inspectHooks() re-runs the component with a mock dispatcher,\n+    // which would overwrite these variables with mock functions that do nothing.\n+    const realDispatch \u003d dispatch;\n+    const realSetState \u003d setState;\n+\n     // Second render has no changed hooks, only changed props.\n     utils.act(() \u003d\u003e\n       render(\n@@ -388,10 +394,10 @@ describe(\u0027ProfilingCache\u0027, () \u003d\u003e {\n     );\n \n     // Third render has a changed reducer hook.\n-    utils.act(() \u003d\u003e dispatch({type: \u0027invert\u0027}));\n+    utils.act(() \u003d\u003e realDispatch({type: \u0027invert\u0027}));\n \n     // Fourth render has a changed state hook.\n-    utils.act(() \u003d\u003e setState(\u0027def\u0027));\n+    utils.act(() \u003d\u003e realSetState(\u0027def\u0027));\n \n     // Fifth render has a changed context value, but no changed hook.\n     utils.act(() \u003d\u003e\n@@ -521,6 +527,238 @@ describe(\u0027ProfilingCache\u0027, () \u003d\u003e {\n     }\n   });\n \n+  // @reactVersion \u003e\u003d 19.0\n+  it(\u0027should detect what hooks changed in a render with custom and composite hooks\u0027, () \u003d\u003e {\n+    let snapshot \u003d 0;\n+    let syncExternalStoreCallback;\n+\n+    function subscribe(callback) {\n+      syncExternalStoreCallback \u003d callback;\n+      return () \u003d\u003e {};\n+    }\n+\n+    function getSnapshot() {\n+      return snapshot;\n+    }\n+\n+    // Custom hook wrapping multiple primitive hooks\n+    function useCustomHook() {\n+      const [value, setValue] \u003d React.useState(\u0027custom\u0027);\n+      React.useEffect(() \u003d\u003e {}, [value]);\n+      return [value, setValue];\n+    }\n+\n+    let setState \u003d null;\n+    let startTransition \u003d null;\n+    let actionStateDispatch \u003d null;\n+    let setCustomValue \u003d null;\n+    let setFinalState \u003d null;\n+\n+    const Component \u003d () \u003d\u003e {\n+      // Hook 0: useState\n+      const [state, _setState] \u003d React.useState(\u0027initial\u0027);\n+      setState \u003d _setState;\n+\n+      // Hook 1: useSyncExternalStore (composite hook - internally uses multiple hooks)\n+      const storeValue \u003d React.useSyncExternalStore(\n+        subscribe,\n+        getSnapshot,\n+        getSnapshot,\n+      );\n+\n+      // Hook 2: useTransition (composite hook - internally uses multiple hooks)\n+      const [isPending, _startTransition] \u003d React.useTransition();\n+      startTransition \u003d _startTransition;\n+\n+      // Hook 3: useActionState (composite hook - internally uses multiple hooks)\n+      const [actionState, _actionStateDispatch] \u003d React.useActionState(\n+        (_prev, action) \u003d\u003e action,\n+        \u0027action-initial\u0027,\n+      );\n+      actionStateDispatch \u003d _actionStateDispatch;\n+\n+      // Hook 4: useState inside custom hook (flattened)\n+      // Hook 5: useEffect inside custom hook (not stateful, won\u0027t show in changes)\n+      const [customValue, _setCustomValue] \u003d useCustomHook();\n+      setCustomValue \u003d _setCustomValue;\n+\n+      // Hook 6: direct useState at the end\n+      const [finalState, _setFinalState] \u003d React.useState(\u0027final\u0027);\n+      setFinalState \u003d _setFinalState;\n+\n+      return `${state}-${storeValue}-${isPending}-${actionState}-${customValue}-${finalState}`;\n+    };\n+\n+    utils.act(() \u003d\u003e store.profilerStore.startProfiling());\n+    utils.act(() \u003d\u003e render(\u003cComponent /\u003e));\n+\n+    // Save references before inspectHooks() overwrites them\n+    const realSetState \u003d setState;\n+    const realStartTransition \u003d startTransition;\n+    const realActionStateDispatch \u003d actionStateDispatch;\n+    const realSetCustomValue \u003d setCustomValue;\n+    const realSetFinalState \u003d setFinalState;\n+\n+    // 2nd render: change useState (hook 0)\n+    utils.act(() \u003d\u003e realSetState(\u0027changed\u0027));\n+\n+    // 3rd render: change useSyncExternalStore (hook 1)\n+    utils.act(() \u003d\u003e {\n+      snapshot \u003d 1;\n+      syncExternalStoreCallback();\n+    });\n+\n+    // 4th render: trigger useTransition (hook 2)\n+    // Note: useTransition triggers two renders - one when isPending becomes true,\n+    // and another when isPending becomes false after the transition completes\n+    utils.act(() \u003d\u003e {\n+      realStartTransition(() \u003d\u003e {});\n+    });\n+\n+    // 6th render: change useActionState (hook 3)\n+    utils.act(() \u003d\u003e realActionStateDispatch(\u0027action-changed\u0027));\n+\n+    // 7th render: change custom hook\u0027s useState (hook 4)\n+    utils.act(() \u003d\u003e realSetCustomValue(\u0027custom-changed\u0027));\n+\n+    // 8th render: change final useState (hook 6)\n+    utils.act(() \u003d\u003e realSetFinalState(\u0027final-changed\u0027));\n+\n+    utils.act(() \u003d\u003e store.profilerStore.stopProfiling());\n+\n+    const rootID \u003d store.roots[0];\n+\n+    const changeDescriptions \u003d store.profilerStore\n+      .getDataForRoot(rootID)\n+      .commitData.map(commitData \u003d\u003e commitData.changeDescriptions);\n+    expect(changeDescriptions).toHaveLength(8);\n+\n+    // 1st render: Initial mount\n+    expect(changeDescriptions[0]).toMatchInlineSnapshot(`\n+      Map {\n+        2 \u003d\u003e {\n+          \"context\": null,\n+          \"didHooksChange\": false,\n+          \"isFirstMount\": true,\n+          \"props\": null,\n+          \"state\": null,\n+        },\n+      }\n+    `);\n+\n+    // 2nd render: Changed hook 0 (useState)\n+    expect(changeDescriptions[1]).toMatchInlineSnapshot(`\n+      Map {\n+        2 \u003d\u003e {\n+          \"context\": false,\n+          \"didHooksChange\": true,\n+          \"hooks\": [\n+            0,\n+          ],\n+          \"isFirstMount\": false,\n+          \"props\": [],\n+          \"state\": null,\n+        },\n+      }\n+    `);\n+\n+    // 3rd render: Changed hook 1 (useSyncExternalStore)\n+    expect(changeDescriptions[2]).toMatchInlineSnapshot(`\n+      Map {\n+        2 \u003d\u003e {\n+          \"context\": false,\n+          \"didHooksChange\": true,\n+          \"hooks\": [\n+            1,\n+          ],\n+          \"isFirstMount\": false,\n+          \"props\": [],\n+          \"state\": null,\n+        },\n+      }\n+    `);\n+\n+    // 4th render: Changed hook 2 (useTransition - isPending becomes true)\n+    expect(changeDescriptions[3]).toMatchInlineSnapshot(`\n+      Map {\n+        2 \u003d\u003e {\n+          \"context\": false,\n+          \"didHooksChange\": true,\n+          \"hooks\": [\n+            2,\n+          ],\n+          \"isFirstMount\": false,\n+          \"props\": [],\n+          \"state\": null,\n+        },\n+      }\n+    `);\n+\n+    // 5th render: Changed hook 2 (useTransition - isPending becomes false)\n+    expect(changeDescriptions[4]).toMatchInlineSnapshot(`\n+      Map {\n+        2 \u003d\u003e {\n+          \"context\": false,\n+          \"didHooksChange\": true,\n+          \"hooks\": [\n+            2,\n+          ],\n+          \"isFirstMount\": false,\n+          \"props\": [],\n+          \"state\": null,\n+        },\n+      }\n+    `);\n+\n+    // 6th render: Changed hook 3 (useActionState)\n+    expect(changeDescriptions[5]).toMatchInlineSnapshot(`\n+      Map {\n+        2 \u003d\u003e {\n+          \"context\": false,\n+          \"didHooksChange\": true,\n+          \"hooks\": [\n+            3,\n+          ],\n+          \"isFirstMount\": false,\n+          \"props\": [],\n+          \"state\": null,\n+        },\n+      }\n+    `);\n+\n+    // 7th render: Changed hook 4 (useState inside useCustomHook)\n+    expect(changeDescriptions[6]).toMatchInlineSnapshot(`\n+      Map {\n+        2 \u003d\u003e {\n+          \"context\": false,\n+          \"didHooksChange\": true,\n+          \"hooks\": [\n+            4,\n+          ],\n+          \"isFirstMount\": false,\n+          \"props\": [],\n+          \"state\": null,\n+        },\n+      }\n+    `);\n+\n+    // 8th render: Changed hook 6 (final useState)\n+    expect(changeDescriptions[7]).toMatchInlineSnapshot(`\n+      Map {\n+        2 \u003d\u003e {\n+          \"context\": false,\n+          \"didHooksChange\": true,\n+          \"hooks\": [\n+            6,\n+          ],\n+          \"isFirstMount\": false,\n+          \"props\": [],\n+          \"state\": null,\n+        },\n+      }\n+    `);\n+  });\n+\n   // @reactVersion \u003e\u003d 19.0\n   it(\u0027should detect context changes or lack of changes with conditional use()\u0027, () \u003d\u003e {\n     const ContextA \u003d React.createContext(0);\n@@ -553,6 +791,11 @@ describe(\u0027ProfilingCache\u0027, () \u003d\u003e {\n       ),\n     );\n \n+    // Save reference to the real setState function before profiling starts.\n+    // inspectHooks() re-runs the component with a mock dispatcher,\n+    // which would overwrite setState with a mock function that does nothing.\n+    const realSetState \u003d setState;\n+\n     utils.act(() \u003d\u003e store.profilerStore.startProfiling());\n \n     // First render changes Context.\n@@ -567,7 +810,7 @@ describe(\u0027ProfilingCache\u0027, () \u003d\u003e {\n     );\n \n     // Second render has no changed Context, only changed state.\n-    utils.act(() \u003d\u003e setState(\u0027def\u0027));\n+    utils.act(() \u003d\u003e realSetState(\u0027def\u0027));\n \n     utils.act(() \u003d\u003e store.profilerStore.stopProfiling());\n \ndiff --git a/packages/react-devtools-shared/src/backend/fiber/renderer.js b/packages/react-devtools-shared/src/backend/fiber/renderer.js\nindex 6848e32..892a3c6 100644\n--- a/packages/react-devtools-shared/src/backend/fiber/renderer.js\n+++ b/packages/react-devtools-shared/src/backend/fiber/renderer.js\n@@ -18,7 +18,7 @@ import type {\n   Wakeable,\n } from \u0027shared/ReactTypes\u0027;\n \n-import type {HooksTree} from \u0027react-debug-tools/src/ReactDebugHooks\u0027;\n+import type {HooksNode, HooksTree} from \u0027react-debug-tools/src/ReactDebugHooks\u0027;\n \n import {\n   ComponentFilterDisplayName,\n@@ -127,7 +127,6 @@ import {enableStyleXFeatures} from \u0027react-devtools-feature-flags\u0027;\n import {componentInfoToComponentLogsMap} from \u0027../shared/DevToolsServerComponentLogs\u0027;\n \n import is from \u0027shared/objectIs\u0027;\n-import hasOwnProperty from \u0027shared/hasOwnProperty\u0027;\n \n import {getIODescription} from \u0027shared/ReactIODescription\u0027;\n \n@@ -1976,10 +1975,9 @@ export function attach(\n             state: null,\n           };\n         } else {\n-          const indices \u003d getChangedHooksIndices(\n-            prevFiber.memoizedState,\n-            nextFiber.memoizedState,\n-          );\n+          const prevHooks \u003d inspectHooks(prevFiber);\n+          const nextHooks \u003d inspectHooks(nextFiber);\n+          const indices \u003d getChangedHooksIndices(prevHooks, nextHooks);\n           const data: ChangeDescription \u003d {\n             context: getContextChanged(prevFiber, nextFiber),\n             didHooksChange: indices !\u003d\u003d null \u0026\u0026 indices.length \u003e 0,\n@@ -2028,74 +2026,53 @@ export function attach(\n     return false;\n   }\n \n-  function isUseSyncExternalStoreHook(hookObject: any): boolean {\n-    const queue \u003d hookObject.queue;\n-    if (!queue) {\n-      return false;\n-    }\n-\n-    const boundHasOwnProperty \u003d hasOwnProperty.bind(queue);\n-    return (\n-      boundHasOwnProperty(\u0027value\u0027) \u0026\u0026\n-      boundHasOwnProperty(\u0027getSnapshot\u0027) \u0026\u0026\n-      typeof queue.getSnapshot \u003d\u003d\u003d \u0027function\u0027\n-    );\n-  }\n-\n-  function isHookThatCanScheduleUpdate(hookObject: any) {\n-    const queue \u003d hookObject.queue;\n-    if (!queue) {\n-      return false;\n-    }\n-\n-    const boundHasOwnProperty \u003d hasOwnProperty.bind(queue);\n-\n-    // Detect the shape of useState() / useReducer() / useTransition()\n-    // using the attributes that are unique to these hooks\n-    // but also stable (e.g. not tied to current Lanes implementation)\n-    // We don\u0027t check for dispatch property, because useTransition doesn\u0027t have it\n-    if (boundHasOwnProperty(\u0027pending\u0027)) {\n-      return true;\n-    }\n-\n-    return isUseSyncExternalStoreHook(hookObject);\n-  }\n-\n-  function didStatefulHookChange(prev: any, next: any): boolean {\n-    const prevMemoizedState \u003d prev.memoizedState;\n-    const nextMemoizedState \u003d next.memoizedState;\n+  function didStatefulHookChange(prev: HooksNode, next: HooksNode): boolean {\n+    // Detect the shape of useState() / useReducer() / useTransition() / useSyncExternalStore() / useActionState()\n+    const isStatefulHook \u003d\n+      prev.isStateEditable \u003d\u003d\u003d true ||\n+      prev.name \u003d\u003d\u003d \u0027SyncExternalStore\u0027 ||\n+      prev.name \u003d\u003d\u003d \u0027Transition\u0027 ||\n+      prev.name \u003d\u003d\u003d \u0027ActionState\u0027 ||\n+      prev.name \u003d\u003d\u003d \u0027FormState\u0027;\n \n-    if (isHookThatCanScheduleUpdate(prev)) {\n-      return prevMemoizedState !\u003d\u003d nextMemoizedState;\n+    // Compare the values to see if they changed\n+    if (isStatefulHook) {\n+      return prev.value !\u003d\u003d next.value;\n     }\n \n     return false;\n   }\n \n-  function getChangedHooksIndices(prev: any, next: any): null | Array\u003cnumber\u003e {\n-    if (prev \u003d\u003d null || next \u003d\u003d null) {\n+  function getChangedHooksIndices(\n+    prevHooks: HooksTree | null,\n+    nextHooks: HooksTree | null,\n+  ): null | Array\u003cnumber\u003e {\n+    if (prevHooks \u003d\u003d null || nextHooks \u003d\u003d null) {\n       return null;\n     }\n \n-    const indices \u003d [];\n+    const indices: Array\u003cnumber\u003e \u003d [];\n     let index \u003d 0;\n \n-    while (next !\u003d\u003d null) {\n-      if (didStatefulHookChange(prev, next)) {\n-        indices.push(index);\n-      }\n+    function traverse(prevTree: HooksTree, nextTree: HooksTree): void {\n+      for (let i \u003d 0; i \u003c prevTree.length; i++) {\n+        const prevHook \u003d prevTree[i];\n+        const nextHook \u003d nextTree[i];\n \n-      // useSyncExternalStore creates 2 internal hooks, but we only count it as 1 user-facing hook\n-      if (isUseSyncExternalStoreHook(next)) {\n-        next \u003d next.next;\n-        prev \u003d prev.next;\n-      }\n+        if (prevHook.subHooks.length \u003e 0 \u0026\u0026 nextHook.subHooks.length \u003e 0) {\n+          traverse(prevHook.subHooks, nextHook.subHooks);\n+          continue;\n+        }\n \n-      next \u003d next.next;\n-      prev \u003d prev.next;\n-      index++;\n+        if (didStatefulHookChange(prevHook, nextHook)) {\n+          indices.push(index);\n+        }\n+\n+        index++;\n+      }\n     }\n \n+    traverse(prevHooks, nextHooks);\n     return indices;\n   }\n ","expectedMessage":"Improve the detection of changed hooks (#35123)","repository":"react","commitHash":"53daaf5aba1827c2f6c6e01ae1318c36f5a1902e","metadata":{"author":"Błażej Kustra \u003c46095609+blazejkustra@users.noreply.github.com\u003e"}}
{"id":"react-4a3d993e","diff":" packages/react-reconciler/src/ReactFiberCommitViewTransitions.js | 6 +++++-\n 1 file changed, 5 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/react-reconciler/src/ReactFiberCommitViewTransitions.js b/packages/react-reconciler/src/ReactFiberCommitViewTransitions.js\nindex 20abaa6..64940c3 100644\n--- a/packages/react-reconciler/src/ReactFiberCommitViewTransitions.js\n+++ b/packages/react-reconciler/src/ReactFiberCommitViewTransitions.js\n@@ -711,7 +711,11 @@ function measureViewTransitionHostInstancesRecursive(\n         }\n         viewTransitionCancelableChildren.push(\n           instance,\n-          oldName,\n+          viewTransitionHostInstanceIdx \u003d\u003d\u003d 0\n+            ? oldName\n+            : // If we have multiple Host Instances below, we add a suffix to the name to give\n+              // each one a unique name.\n+              oldName + \u0027_\u0027 + viewTransitionHostInstanceIdx,\n           child.memoizedProps,\n         );\n       }","expectedMessage":"Add the suffix to cancelled view transition names (#35485)","repository":"react","commitHash":"4a3d993e52fd6bcadd9c3029c75df3c22684f69c","metadata":{"author":"Sebastian Markbåge \u003csebastian@calyptus.eu\u003e"}}
{"id":"react-c1866240","diff":" ...ReactDOMServerPartialHydration-test.internal.js | 166 +++++++++++++++++++++\n .../src/ReactFiberHydrationContext.js              |  39 +++++\n .../react-reconciler/src/ReactFiberWorkLoop.js     |   9 +-\n 3 files changed, 213 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js b/packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js\nindex d13303f..502ac8c 100644\n--- a/packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js\n+++ b/packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js\n@@ -4063,4 +4063,170 @@ describe(\u0027ReactDOMServerPartialHydration\u0027, () \u003d\u003e {\n     expect(span.style.display).toBe(\u0027\u0027);\n     expect(ref.current).toBe(span);\n   });\n+\n+  // Regression for https://github.com/facebook/react/issues/35210 and other issues where lazy elements created in flight\n+  // caused hydration issues b/c the replay pathway did not correctly reset the hydration cursor\n+  it(\u0027Can hydrate even when lazy content resumes immediately inside a HostComponent\u0027, async () \u003d\u003e {\n+    let resolve;\n+    const promise \u003d new Promise(r \u003d\u003e {\n+      resolve \u003d () \u003d\u003e r({default: \u0027value\u0027});\n+    });\n+\n+    const lazyContent \u003d React.lazy(() \u003d\u003e {\n+      Scheduler.log(\u0027Lazy initializer called\u0027);\n+      return promise;\n+    });\n+\n+    function App() {\n+      return \u003clabel\u003e{lazyContent}\u003c/label\u003e;\n+    }\n+\n+    // Server-rendered HTML\n+    const container \u003d document.createElement(\u0027div\u0027);\n+    container.innerHTML \u003d \u0027\u003clabel\u003evalue\u003c/label\u003e\u0027;\n+\n+    const hydrationErrors \u003d [];\n+\n+    React.startTransition(() \u003d\u003e {\n+      ReactDOMClient.hydrateRoot(container, \u003cApp /\u003e, {\n+        onRecoverableError(error) {\n+          console.log(\u0027[DEBUG] hydration error:\u0027, error.message);\n+          hydrationErrors.push(error.message);\n+        },\n+      });\n+    });\n+\n+    await waitFor([\u0027Lazy initializer called\u0027]);\n+    resolve();\n+    await waitForAll([]);\n+\n+    // Without the fix, hydration cursor is wrong and causes mismatch\n+    expect(hydrationErrors).toEqual([]);\n+    expect(container.innerHTML).toEqual(\u0027\u003clabel\u003evalue\u003c/label\u003e\u0027);\n+  });\n+\n+  it(\u0027Can hydrate even when lazy content resumes immediately inside a HostSingleton\u0027, async () \u003d\u003e {\n+    let resolve;\n+    const promise \u003d new Promise(r \u003d\u003e {\n+      resolve \u003d () \u003d\u003e r({default: \u003cdiv\u003evalue\u003c/div\u003e});\n+    });\n+\n+    const lazyContent \u003d React.lazy(() \u003d\u003e {\n+      Scheduler.log(\u0027Lazy initializer called\u0027);\n+      return promise;\n+    });\n+\n+    function App() {\n+      return (\n+        \u003chtml\u003e\n+          \u003cbody\u003e{lazyContent}\u003c/body\u003e\n+        \u003c/html\u003e\n+      );\n+    }\n+\n+    // Server-rendered HTML\n+    document.body.innerHTML \u003d \u0027\u003cdiv\u003evalue\u003c/div\u003e\u0027;\n+\n+    const hydrationErrors \u003d [];\n+\n+    React.startTransition(() \u003d\u003e {\n+      ReactDOMClient.hydrateRoot(document, \u003cApp /\u003e, {\n+        onRecoverableError(error) {\n+          console.log(\u0027[DEBUG] hydration error:\u0027, error.message);\n+          hydrationErrors.push(error.message);\n+        },\n+      });\n+    });\n+\n+    await waitFor([\u0027Lazy initializer called\u0027]);\n+    resolve();\n+    await waitForAll([]);\n+\n+    expect(hydrationErrors).toEqual([]);\n+    expect(document.documentElement.outerHTML).toEqual(\n+      \u0027\u003chtml\u003e\u003chead\u003e\u003c/head\u003e\u003cbody\u003e\u003cdiv\u003evalue\u003c/div\u003e\u003c/body\u003e\u003c/html\u003e\u0027,\n+    );\n+  });\n+\n+  it(\u0027Can hydrate even when lazy content resumes immediately inside a Suspense\u0027, async () \u003d\u003e {\n+    let resolve;\n+    const promise \u003d new Promise(r \u003d\u003e {\n+      resolve \u003d () \u003d\u003e r({default: \u0027value\u0027});\n+    });\n+\n+    const lazyContent \u003d React.lazy(() \u003d\u003e {\n+      Scheduler.log(\u0027Lazy initializer called\u0027);\n+      return promise;\n+    });\n+\n+    function App() {\n+      return \u003cSuspense\u003e{lazyContent}\u003c/Suspense\u003e;\n+    }\n+\n+    // Server-rendered HTML\n+    const container \u003d document.createElement(\u0027div\u0027);\n+    container.innerHTML \u003d \u0027\u003c!--$--\u003evalue\u003c!--/$--\u003e\u0027;\n+\n+    const hydrationErrors \u003d [];\n+\n+    let root;\n+    React.startTransition(() \u003d\u003e {\n+      root \u003d ReactDOMClient.hydrateRoot(container, \u003cApp /\u003e, {\n+        onRecoverableError(error) {\n+          console.log(\u0027[DEBUG] hydration error:\u0027, error.message);\n+          hydrationErrors.push(error.message);\n+        },\n+      });\n+    });\n+\n+    await waitFor([\u0027Lazy initializer called\u0027]);\n+    resolve();\n+    await waitForAll([]);\n+\n+    expect(hydrationErrors).toEqual([]);\n+    expect(container.innerHTML).toEqual(\u0027\u003c!--$--\u003evalue\u003c!--/$--\u003e\u0027);\n+    root.unmount();\n+    expect(container.innerHTML).toEqual(\u0027\u003c!--$--\u003e\u003c!--/$--\u003e\u0027);\n+  });\n+\n+  it(\u0027Can hydrate even when lazy content resumes immediately inside an Activity\u0027, async () \u003d\u003e {\n+    let resolve;\n+    const promise \u003d new Promise(r \u003d\u003e {\n+      resolve \u003d () \u003d\u003e r({default: \u0027value\u0027});\n+    });\n+\n+    const lazyContent \u003d React.lazy(() \u003d\u003e {\n+      Scheduler.log(\u0027Lazy initializer called\u0027);\n+      return promise;\n+    });\n+\n+    function App() {\n+      return \u003cActivity mode\u003d\"visible\"\u003e{lazyContent}\u003c/Activity\u003e;\n+    }\n+\n+    // Server-rendered HTML\n+    const container \u003d document.createElement(\u0027div\u0027);\n+    container.innerHTML \u003d \u0027\u003c!--\u0026--\u003evalue\u003c!--/\u0026--\u003e\u0027;\n+\n+    const hydrationErrors \u003d [];\n+\n+    let root;\n+    React.startTransition(() \u003d\u003e {\n+      root \u003d ReactDOMClient.hydrateRoot(container, \u003cApp /\u003e, {\n+        onRecoverableError(error) {\n+          console.log(\u0027[DEBUG] hydration error:\u0027, error.message);\n+          hydrationErrors.push(error.message);\n+        },\n+      });\n+    });\n+\n+    await waitFor([\u0027Lazy initializer called\u0027]);\n+    resolve();\n+    await waitForAll([]);\n+\n+    expect(hydrationErrors).toEqual([]);\n+    expect(container.innerHTML).toEqual(\u0027\u003c!--\u0026--\u003evalue\u003c!--/\u0026--\u003e\u0027);\n+    root.unmount();\n+    expect(container.innerHTML).toEqual(\u0027\u003c!--\u0026--\u003e\u003c!--/\u0026--\u003e\u0027);\n+  });\n });\ndiff --git a/packages/react-reconciler/src/ReactFiberHydrationContext.js b/packages/react-reconciler/src/ReactFiberHydrationContext.js\nindex 00e2fcd..0c75820 100644\n--- a/packages/react-reconciler/src/ReactFiberHydrationContext.js\n+++ b/packages/react-reconciler/src/ReactFiberHydrationContext.js\n@@ -173,6 +173,7 @@ function enterHydrationState(fiber: Fiber): boolean {\n   didSuspendOrErrorDEV \u003d false;\n   hydrationDiffRootDEV \u003d null;\n   rootOrSingletonContext \u003d true;\n+\n   return true;\n }\n \n@@ -834,6 +835,43 @@ function resetHydrationState(): void {\n   didSuspendOrErrorDEV \u003d false;\n }\n \n+// Restore the hydration cursor when unwinding a HostComponent that already\n+// claimed a DOM node. This is a fork of popHydrationState that does all the\n+// same validity checks but restores the cursor to this fiber\u0027s DOM node\n+// instead of advancing past it. It also does NOT clear unhydrated tail nodes\n+// or throw on mismatches since we\u0027re unwinding, not completing.\n+//\n+// This is needed when replaySuspendedUnitOfWork calls unwindInterruptedWork\n+// before re-running beginWork on the same fiber, or when throwAndUnwindWorkLoop\n+// calls unwindWork on ancestor fibers.\n+function popHydrationStateOnInterruptedWork(fiber: Fiber): void {\n+  if (!supportsHydration) {\n+    return;\n+  }\n+  if (fiber !\u003d\u003d hydrationParentFiber) {\n+    // We\u0027re deeper than the current hydration context, inside an inserted\n+    // tree. Don\u0027t touch the cursor.\n+    return;\n+  }\n+  if (!isHydrating) {\n+    // If we\u0027re not currently hydrating but we\u0027re in a hydration context, then\n+    // we were an insertion and now need to pop up to reenter hydration of our\n+    // siblings. Same as popHydrationState.\n+    popToNextHostParent(fiber);\n+    isHydrating \u003d true;\n+    return;\n+  }\n+\n+  // We\u0027re in a valid hydration context. Restore the cursor to this fiber\u0027s\n+  // DOM node so that when beginWork re-runs, it can claim the same node.\n+  // Unlike popHydrationState, we do NOT check for unhydrated tail nodes\n+  // or advance the cursor - we\u0027re restoring, not completing.\n+  popToNextHostParent(fiber);\n+  if (fiber.tag \u003d\u003d\u003d HostComponent \u0026\u0026 fiber.stateNode !\u003d null) {\n+    nextHydratableInstance \u003d fiber.stateNode;\n+  }\n+}\n+\n export function upgradeHydrationErrorsToRecoverable(): Array\u003c\n   CapturedValue\u003cmixed\u003e,\n \u003e | null {\n@@ -905,6 +943,7 @@ export {\n   reenterHydrationStateFromDehydratedActivityInstance,\n   reenterHydrationStateFromDehydratedSuspenseInstance,\n   resetHydrationState,\n+  popHydrationStateOnInterruptedWork,\n   claimHydratableSingleton,\n   tryToClaimNextHydratableInstance,\n   tryToClaimNextHydratableTextInstance,\ndiff --git a/packages/react-reconciler/src/ReactFiberWorkLoop.js b/packages/react-reconciler/src/ReactFiberWorkLoop.js\nindex f720045..9f21041 100644\n--- a/packages/react-reconciler/src/ReactFiberWorkLoop.js\n+++ b/packages/react-reconciler/src/ReactFiberWorkLoop.js\n@@ -120,7 +120,10 @@ import {\n \n import {createWorkInProgress, resetWorkInProgress} from \u0027./ReactFiber\u0027;\n import {isRootDehydrated} from \u0027./ReactFiberShellHydration\u0027;\n-import {getIsHydrating} from \u0027./ReactFiberHydrationContext\u0027;\n+import {\n+  getIsHydrating,\n+  popHydrationStateOnInterruptedWork,\n+} from \u0027./ReactFiberHydrationContext\u0027;\n import {\n   NoMode,\n   ProfileMode,\n@@ -3109,6 +3112,10 @@ function replayBeginWork(unitOfWork: Fiber): null | Fiber {\n       // promises that a host component might suspend on are definitely cached\n       // because they are controlled by us. So don\u0027t bother.\n       resetHooksOnUnwind(unitOfWork);\n+      // We are about to retry this host component and need to ensure the hydration\n+      // state is appropriate for hydrating this unit. Other fiber types hydrate differently\n+      // and aren\u0027t reliant on the cursor positioning so this function is only for HostComponent\n+      popHydrationStateOnInterruptedWork(unitOfWork);\n       // Fallthrough to the next branch.\n     }\n     default: {","expectedMessage":"[Fiber] Correctly handle replaying when hydrating (#35494)","repository":"react","commitHash":"c18662405cc436646411647f8a8965c1c0594c3c","metadata":{"author":"Josh Story \u003cstory@hey.com\u003e"}}
{"id":"react-583e2003","diff":" .../background/dynamicallyInjectContentScripts.js  |   8 ++\n .../src/background/messageHandlers.js              |  52 +++++++++\n .../src/contentScripts/fallbackEvalContext.js      |  35 +++++++\n .../src/contentScripts/proxy.js                    |  46 ++++++++\n .../react-devtools-extensions/src/evalScripts.js   | 112 ++++++++++++++++++++\n .../src/main/elementSelection.js                   |  16 ++-\n .../src/main/evalInInspectedWindow.js              | 116 +++++++++++++++++++++\n .../react-devtools-extensions/src/main/index.js    |   3 +-\n .../src/main/reactPolling.js                       |   7 +-\n .../src/main/sourceSelection.js                    |  48 ++-------\n .../react-devtools-extensions/webpack.config.js    |   1 +\n 11 files changed, 390 insertions(+), 54 deletions(-)\n\ndiff --git a/packages/react-devtools-extensions/src/background/dynamicallyInjectContentScripts.js b/packages/react-devtools-extensions/src/background/dynamicallyInjectContentScripts.js\nindex 3e2f6b7..84624b0 100644\n--- a/packages/react-devtools-extensions/src/background/dynamicallyInjectContentScripts.js\n+++ b/packages/react-devtools-extensions/src/background/dynamicallyInjectContentScripts.js\n@@ -17,6 +17,14 @@ const contentScriptsToInject \u003d [\n     runAt: \u0027document_end\u0027,\n     world: chrome.scripting.ExecutionWorld.ISOLATED,\n   },\n+  {\n+    id: \u0027@react-devtools/fallback-eval-context\u0027,\n+    js: [\u0027build/fallbackEvalContext.js\u0027],\n+    matches: [\u0027\u003call_urls\u003e\u0027],\n+    persistAcrossSessions: true,\n+    runAt: \u0027document_start\u0027,\n+    world: chrome.scripting.ExecutionWorld.MAIN,\n+  },\n   {\n     id: \u0027@react-devtools/hook\u0027,\n     js: [\u0027build/installHook.js\u0027],\ndiff --git a/packages/react-devtools-extensions/src/background/messageHandlers.js b/packages/react-devtools-extensions/src/background/messageHandlers.js\nindex 0152418..f762d64 100644\n--- a/packages/react-devtools-extensions/src/background/messageHandlers.js\n+++ b/packages/react-devtools-extensions/src/background/messageHandlers.js\n@@ -97,6 +97,58 @@ export function handleDevToolsPageMessage(message) {\n \n       break;\n     }\n+\n+    case \u0027eval-in-inspected-window\u0027: {\n+      const {\n+        payload: {tabId, requestId, scriptId, args},\n+      } \u003d message;\n+\n+      chrome.tabs\n+        .sendMessage(tabId, {\n+          source: \u0027devtools-page-eval\u0027,\n+          payload: {\n+            scriptId,\n+            args,\n+          },\n+        })\n+        .then(response \u003d\u003e {\n+          if (!response) {\n+            chrome.runtime.sendMessage({\n+              source: \u0027react-devtools-background\u0027,\n+              payload: {\n+                type: \u0027eval-in-inspected-window-response\u0027,\n+                requestId,\n+                result: null,\n+                error: \u0027No response from content script\u0027,\n+              },\n+            });\n+            return;\n+          }\n+          const {result, error} \u003d response;\n+          chrome.runtime.sendMessage({\n+            source: \u0027react-devtools-background\u0027,\n+            payload: {\n+              type: \u0027eval-in-inspected-window-response\u0027,\n+              requestId,\n+              result,\n+              error,\n+            },\n+          });\n+        })\n+        .catch(error \u003d\u003e {\n+          chrome.runtime.sendMessage({\n+            source: \u0027react-devtools-background\u0027,\n+            payload: {\n+              type: \u0027eval-in-inspected-window-response\u0027,\n+              requestId,\n+              result: null,\n+              error: error?.message || String(error),\n+            },\n+          });\n+        });\n+\n+      break;\n+    }\n   }\n }\n \ndiff --git a/packages/react-devtools-extensions/src/contentScripts/fallbackEvalContext.js b/packages/react-devtools-extensions/src/contentScripts/fallbackEvalContext.js\nnew file mode 100644\nindex 0000000..e274f88\n--- /dev/null\n+++ b/packages/react-devtools-extensions/src/contentScripts/fallbackEvalContext.js\n@@ -0,0 +1,35 @@\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ *\n+ * @flow\n+ */\n+\n+import {evalScripts} from \u0027../evalScripts\u0027;\n+\n+window.addEventListener(\u0027message\u0027, event \u003d\u003e {\n+  if (event.data?.source \u003d\u003d\u003d \u0027react-devtools-content-script-eval\u0027) {\n+    const {scriptId, args, requestId} \u003d event.data.payload;\n+    const response \u003d {result: null, error: null};\n+    try {\n+      if (!evalScripts[scriptId]) {\n+        throw new Error(`No eval script with id \"${scriptId}\" exists.`);\n+      }\n+      response.result \u003d evalScripts[scriptId].fn.apply(null, args);\n+    } catch (err) {\n+      response.error \u003d err.message;\n+    }\n+    window.postMessage(\n+      {\n+        source: \u0027react-devtools-content-script-eval-response\u0027,\n+        payload: {\n+          requestId,\n+          response,\n+        },\n+      },\n+      \u0027*\u0027,\n+    );\n+  }\n+});\ndiff --git a/packages/react-devtools-extensions/src/contentScripts/proxy.js b/packages/react-devtools-extensions/src/contentScripts/proxy.js\nindex 02253f6..a4e7dd6 100644\n--- a/packages/react-devtools-extensions/src/contentScripts/proxy.js\n+++ b/packages/react-devtools-extensions/src/contentScripts/proxy.js\n@@ -117,3 +117,49 @@ function connectPort() {\n   // $FlowFixMe[incompatible-use]\n   port.onDisconnect.addListener(handleDisconnect);\n }\n+\n+let evalRequestId \u003d 0;\n+const evalRequestCallbacks \u003d new Map\u003cnumber, Function\u003e();\n+\n+chrome.runtime.onMessage.addListener((msg, sender, sendResponse) \u003d\u003e {\n+  switch (msg?.source) {\n+    case \u0027devtools-page-eval\u0027: {\n+      const {scriptId, args} \u003d msg.payload;\n+      const requestId \u003d evalRequestId++;\n+      window.postMessage(\n+        {\n+          source: \u0027react-devtools-content-script-eval\u0027,\n+          payload: {\n+            requestId,\n+            scriptId,\n+            args,\n+          },\n+        },\n+        \u0027*\u0027,\n+      );\n+      evalRequestCallbacks.set(requestId, sendResponse);\n+      return true; // Indicate we will respond asynchronously\n+    }\n+  }\n+});\n+\n+window.addEventListener(\u0027message\u0027, event \u003d\u003e {\n+  if (event.data?.source \u003d\u003d\u003d \u0027react-devtools-content-script-eval-response\u0027) {\n+    const {requestId, response} \u003d event.data.payload;\n+    const callback \u003d evalRequestCallbacks.get(requestId);\n+    try {\n+      if (!callback)\n+        throw new Error(\n+          `No eval request callback for id \"${requestId}\" exists.`,\n+        );\n+      callback(response);\n+    } catch (e) {\n+      console.warn(\n+        \u0027React DevTools Content Script eval response error occurred:\u0027,\n+        e,\n+      );\n+    } finally {\n+      evalRequestCallbacks.delete(requestId);\n+    }\n+  }\n+});\ndiff --git a/packages/react-devtools-extensions/src/evalScripts.js b/packages/react-devtools-extensions/src/evalScripts.js\nnew file mode 100644\nindex 0000000..60757ca\n--- /dev/null\n+++ b/packages/react-devtools-extensions/src/evalScripts.js\n@@ -0,0 +1,112 @@\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ *\n+ * @flow\n+ */\n+\n+export type EvalScriptIds \u003d\n+  | \u0027checkIfReactPresentInInspectedWindow\u0027\n+  | \u0027reload\u0027\n+  | \u0027setBrowserSelectionFromReact\u0027\n+  | \u0027setReactSelectionFromBrowser\u0027\n+  | \u0027viewAttributeSource\u0027\n+  | \u0027viewElementSource\u0027;\n+\n+/*\n+ .fn for fallback in Content Script context\n+ .code for chrome.devtools.inspectedWindow.eval()\n+*/\n+type EvalScriptEntry \u003d {\n+  fn: (...args: any[]) \u003d\u003e any,\n+  code: (...args: any[]) \u003d\u003e string,\n+};\n+\n+/*\n+  Can not access `Developer Tools Console API` (e.g., inspect(), $0) in this context.\n+  So some fallback functions are no-op or throw error.\n+*/\n+export const evalScripts: {[key: EvalScriptIds]: EvalScriptEntry} \u003d {\n+  checkIfReactPresentInInspectedWindow: {\n+    fn: () \u003d\u003e\n+      window.__REACT_DEVTOOLS_GLOBAL_HOOK__ \u0026\u0026\n+      window.__REACT_DEVTOOLS_GLOBAL_HOOK__.renderers.size \u003e 0,\n+    code: () \u003d\u003e\n+      \u0027window.__REACT_DEVTOOLS_GLOBAL_HOOK__ \u0026\u0026\u0027 +\n+      \u0027window.__REACT_DEVTOOLS_GLOBAL_HOOK__.renderers.size \u003e 0\u0027,\n+  },\n+  reload: {\n+    fn: () \u003d\u003e window.location.reload(),\n+    code: () \u003d\u003e \u0027window.location.reload();\u0027,\n+  },\n+  setBrowserSelectionFromReact: {\n+    fn: () \u003d\u003e {\n+      throw new Error(\u0027Not supported in fallback eval context\u0027);\n+    },\n+    code: () \u003d\u003e\n+      \u0027(window.__REACT_DEVTOOLS_GLOBAL_HOOK__.$0 !\u003d\u003d $0) ?\u0027 +\n+      \u0027(inspect(window.__REACT_DEVTOOLS_GLOBAL_HOOK__.$0), true) :\u0027 +\n+      \u0027false\u0027,\n+  },\n+  setReactSelectionFromBrowser: {\n+    fn: () \u003d\u003e {\n+      throw new Error(\u0027Not supported in fallback eval context\u0027);\n+    },\n+    code: () \u003d\u003e\n+      \u0027(window.__REACT_DEVTOOLS_GLOBAL_HOOK__ \u0026\u0026 window.__REACT_DEVTOOLS_GLOBAL_HOOK__.$0 !\u003d\u003d $0) ?\u0027 +\n+      \u0027(window.__REACT_DEVTOOLS_GLOBAL_HOOK__.$0 \u003d $0, true) :\u0027 +\n+      \u0027false\u0027,\n+  },\n+  viewAttributeSource: {\n+    fn: ({rendererID, elementID, path}) \u003d\u003e {\n+      return false; // Not supported in fallback eval context\n+    },\n+    code: ({rendererID, elementID, path}) \u003d\u003e\n+      \u0027{\u0027 + // The outer block is important because it means we can declare local variables.\n+      \u0027const renderer \u003d window.__REACT_DEVTOOLS_GLOBAL_HOOK__.rendererInterfaces.get(\u0027 +\n+      JSON.stringify(rendererID) +\n+      \u0027);\u0027 +\n+      \u0027if (renderer) {\u0027 +\n+      \u0027  const value \u003d renderer.getElementAttributeByPath(\u0027 +\n+      JSON.stringify(elementID) +\n+      \u0027,\u0027 +\n+      JSON.stringify(path) +\n+      \u0027);\u0027 +\n+      \u0027  if (value) {\u0027 +\n+      \u0027    inspect(value);\u0027 +\n+      \u0027    true;\u0027 +\n+      \u0027  } else {\u0027 +\n+      \u0027    false;\u0027 +\n+      \u0027  }\u0027 +\n+      \u0027} else {\u0027 +\n+      \u0027  false;\u0027 +\n+      \u0027}\u0027 +\n+      \u0027}\u0027,\n+  },\n+  viewElementSource: {\n+    fn: ({rendererID, elementID}) \u003d\u003e {\n+      return false; // Not supported in fallback eval context\n+    },\n+    code: ({rendererID, elementID}) \u003d\u003e\n+      \u0027{\u0027 + // The outer block is important because it means we can declare local variables.\n+      \u0027const renderer \u003d window.__REACT_DEVTOOLS_GLOBAL_HOOK__.rendererInterfaces.get(\u0027 +\n+      JSON.stringify(rendererID) +\n+      \u0027);\u0027 +\n+      \u0027if (renderer) {\u0027 +\n+      \u0027  const value \u003d renderer.getElementSourceFunctionById(\u0027 +\n+      JSON.stringify(elementID) +\n+      \u0027);\u0027 +\n+      \u0027  if (value) {\u0027 +\n+      \u0027    inspect(value);\u0027 +\n+      \u0027    true;\u0027 +\n+      \u0027  } else {\u0027 +\n+      \u0027    false;\u0027 +\n+      \u0027  }\u0027 +\n+      \u0027} else {\u0027 +\n+      \u0027  false;\u0027 +\n+      \u0027}\u0027 +\n+      \u0027}\u0027,\n+  },\n+};\ndiff --git a/packages/react-devtools-extensions/src/main/elementSelection.js b/packages/react-devtools-extensions/src/main/elementSelection.js\nindex 7f9b8ed..315482e 100644\n--- a/packages/react-devtools-extensions/src/main/elementSelection.js\n+++ b/packages/react-devtools-extensions/src/main/elementSelection.js\n@@ -1,13 +1,12 @@\n-/* global chrome */\n+import {evalInInspectedWindow} from \u0027./evalInInspectedWindow\u0027;\n \n export function setBrowserSelectionFromReact() {\n   // This is currently only called on demand when you press \"view DOM\".\n   // In the future, if Chrome adds an inspect() that doesn\u0027t switch tabs,\n   // we could make this happen automatically when you select another component.\n-  chrome.devtools.inspectedWindow.eval(\n-    \u0027(window.__REACT_DEVTOOLS_GLOBAL_HOOK__.$0 !\u003d\u003d $0) ?\u0027 +\n-      \u0027(inspect(window.__REACT_DEVTOOLS_GLOBAL_HOOK__.$0), true) :\u0027 +\n-      \u0027false\u0027,\n+  evalInInspectedWindow(\n+    \u0027setBrowserSelectionFromReact\u0027,\n+    [],\n     (didSelectionChange, evalError) \u003d\u003e {\n       if (evalError) {\n         console.error(evalError);\n@@ -19,10 +18,9 @@ export function setBrowserSelectionFromReact() {\n export function setReactSelectionFromBrowser(bridge) {\n   // When the user chooses a different node in the browser Elements tab,\n   // copy it over to the hook object so that we can sync the selection.\n-  chrome.devtools.inspectedWindow.eval(\n-    \u0027(window.__REACT_DEVTOOLS_GLOBAL_HOOK__ \u0026\u0026 window.__REACT_DEVTOOLS_GLOBAL_HOOK__.$0 !\u003d\u003d $0) ?\u0027 +\n-      \u0027(window.__REACT_DEVTOOLS_GLOBAL_HOOK__.$0 \u003d $0, true) :\u0027 +\n-      \u0027false\u0027,\n+  evalInInspectedWindow(\n+    \u0027setReactSelectionFromBrowser\u0027,\n+    [],\n     (didSelectionChange, evalError) \u003d\u003e {\n       if (evalError) {\n         console.error(evalError);\ndiff --git a/packages/react-devtools-extensions/src/main/evalInInspectedWindow.js b/packages/react-devtools-extensions/src/main/evalInInspectedWindow.js\nnew file mode 100644\nindex 0000000..27a339f\n--- /dev/null\n+++ b/packages/react-devtools-extensions/src/main/evalInInspectedWindow.js\n@@ -0,0 +1,116 @@\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ *\n+ * @flow\n+ */\n+\n+import type {EvalScriptIds} from \u0027../evalScripts\u0027;\n+\n+import {evalScripts} from \u0027../evalScripts\u0027;\n+\n+type ExceptionInfo \u003d {\n+  code: ?string,\n+  description: ?string,\n+  isError: boolean,\n+  isException: boolean,\n+  value: any,\n+};\n+\n+const EVAL_TIMEOUT \u003d 1000 * 10;\n+\n+let evalRequestId \u003d 0;\n+const evalRequestCallbacks \u003d new Map\u003c\n+  number,\n+  (value: {result: any, error: any}) \u003d\u003e void,\n+\u003e();\n+\n+function fallbackEvalInInspectedWindow(\n+  scriptId: EvalScriptIds,\n+  args: any[],\n+  callback: (value: any, exceptionInfo: ?ExceptionInfo) \u003d\u003e void,\n+) {\n+  if (!evalScripts[scriptId]) {\n+    throw new Error(`No eval script with id \"${scriptId}\" exists.`);\n+  }\n+  const code \u003d evalScripts[scriptId].code.apply(null, args);\n+  const tabId \u003d chrome.devtools.inspectedWindow.tabId;\n+  const requestId \u003d evalRequestId++;\n+  chrome.runtime.sendMessage({\n+    source: \u0027devtools-page\u0027,\n+    payload: {\n+      type: \u0027eval-in-inspected-window\u0027,\n+      tabId,\n+      requestId,\n+      scriptId,\n+      args,\n+    },\n+  });\n+  const timeout \u003d setTimeout(() \u003d\u003e {\n+    evalRequestCallbacks.delete(requestId);\n+    if (callback) {\n+      callback(null, {\n+        code,\n+        description:\n+          \u0027Timed out while waiting for eval response from the inspected window.\u0027,\n+        isError: true,\n+        isException: false,\n+        value: undefined,\n+      });\n+    }\n+  }, EVAL_TIMEOUT);\n+  evalRequestCallbacks.set(requestId, ({result, error}) \u003d\u003e {\n+    clearTimeout(timeout);\n+    evalRequestCallbacks.delete(requestId);\n+    if (callback) {\n+      if (error) {\n+        callback(null, {\n+          code,\n+          description: undefined,\n+          isError: false,\n+          isException: true,\n+          value: error,\n+        });\n+        return;\n+      }\n+      callback(result, null);\n+    }\n+  });\n+}\n+\n+export function evalInInspectedWindow(\n+  scriptId: EvalScriptIds,\n+  args: any[],\n+  callback: (value: any, exceptionInfo: ?ExceptionInfo) \u003d\u003e void,\n+) {\n+  if (!evalScripts[scriptId]) {\n+    throw new Error(`No eval script with id \"${scriptId}\" exists.`);\n+  }\n+  const code \u003d evalScripts[scriptId].code.apply(null, args);\n+  chrome.devtools.inspectedWindow.eval(code, (result, exceptionInfo) \u003d\u003e {\n+    if (!exceptionInfo) {\n+      callback(result, exceptionInfo);\n+      return;\n+    }\n+    // If an exception (e.g. CSP Blocked) occurred,\n+    // fallback to the content script eval context\n+    fallbackEvalInInspectedWindow(scriptId, args, callback);\n+  });\n+}\n+\n+chrome.runtime.onMessage.addListener(({payload, source}) \u003d\u003e {\n+  if (source \u003d\u003d\u003d \u0027react-devtools-background\u0027) {\n+    switch (payload?.type) {\n+      case \u0027eval-in-inspected-window-response\u0027: {\n+        const {requestId, result, error} \u003d payload;\n+        const callback \u003d evalRequestCallbacks.get(requestId);\n+        if (callback) {\n+          callback({result, error});\n+        }\n+        break;\n+      }\n+    }\n+  }\n+});\ndiff --git a/packages/react-devtools-extensions/src/main/index.js b/packages/react-devtools-extensions/src/main/index.js\nindex bc948d1..03f9c2b 100644\n--- a/packages/react-devtools-extensions/src/main/index.js\n+++ b/packages/react-devtools-extensions/src/main/index.js\n@@ -32,6 +32,7 @@ import {\n } from \u0027./elementSelection\u0027;\n import {viewAttributeSource} from \u0027./sourceSelection\u0027;\n \n+import {evalInInspectedWindow} from \u0027./evalInInspectedWindow\u0027;\n import {startReactPolling} from \u0027./reactPolling\u0027;\n import {cloneStyleTags} from \u0027./cloneStyleTags\u0027;\n import fetchFileWithCaching from \u0027./fetchFileWithCaching\u0027;\n@@ -70,7 +71,7 @@ function createBridge() {\n \n   bridge.addListener(\u0027reloadAppForProfiling\u0027, () \u003d\u003e {\n     localStorageSetItem(LOCAL_STORAGE_SUPPORTS_PROFILING_KEY, \u0027true\u0027);\n-    chrome.devtools.inspectedWindow.eval(\u0027window.location.reload();\u0027);\n+    evalInInspectedWindow(\u0027reload\u0027, []);\n   });\n \n   bridge.addListener(\ndiff --git a/packages/react-devtools-extensions/src/main/reactPolling.js b/packages/react-devtools-extensions/src/main/reactPolling.js\nindex 9bb034c..d4b3c22 100644\n--- a/packages/react-devtools-extensions/src/main/reactPolling.js\n+++ b/packages/react-devtools-extensions/src/main/reactPolling.js\n@@ -1,4 +1,4 @@\n-/* global chrome */\n+import {evalInInspectedWindow} from \u0027./evalInInspectedWindow\u0027;\n \n class CouldNotFindReactOnThePageError extends Error {\n   constructor() {\n@@ -26,8 +26,9 @@ export function startReactPolling(\n \n   // This function will call onSuccess only if React was found and polling is not aborted, onError will be called for every other case\n   function checkIfReactPresentInInspectedWindow(onSuccess, onError) {\n-    chrome.devtools.inspectedWindow.eval(\n-      \u0027window.__REACT_DEVTOOLS_GLOBAL_HOOK__ \u0026\u0026 window.__REACT_DEVTOOLS_GLOBAL_HOOK__.renderers.size \u003e 0\u0027,\n+    evalInInspectedWindow(\n+      \u0027checkIfReactPresentInInspectedWindow\u0027,\n+      [],\n       (pageHasReact, exceptionInfo) \u003d\u003e {\n         if (status \u003d\u003d\u003d \u0027aborted\u0027) {\n           onError(\ndiff --git a/packages/react-devtools-extensions/src/main/sourceSelection.js b/packages/react-devtools-extensions/src/main/sourceSelection.js\nindex 0534a92..49ee99e 100644\n--- a/packages/react-devtools-extensions/src/main/sourceSelection.js\n+++ b/packages/react-devtools-extensions/src/main/sourceSelection.js\n@@ -1,27 +1,9 @@\n-/* global chrome */\n+import {evalInInspectedWindow} from \u0027./evalInInspectedWindow\u0027;\n \n export function viewAttributeSource(rendererID, elementID, path) {\n-  chrome.devtools.inspectedWindow.eval(\n-    \u0027{\u0027 + // The outer block is important because it means we can declare local variables.\n-      \u0027const renderer \u003d window.__REACT_DEVTOOLS_GLOBAL_HOOK__.rendererInterfaces.get(\u0027 +\n-      JSON.stringify(rendererID) +\n-      \u0027);\u0027 +\n-      \u0027if (renderer) {\u0027 +\n-      \u0027  const value \u003d renderer.getElementAttributeByPath(\u0027 +\n-      JSON.stringify(elementID) +\n-      \u0027,\u0027 +\n-      JSON.stringify(path) +\n-      \u0027);\u0027 +\n-      \u0027  if (value) {\u0027 +\n-      \u0027    inspect(value);\u0027 +\n-      \u0027    true;\u0027 +\n-      \u0027  } else {\u0027 +\n-      \u0027    false;\u0027 +\n-      \u0027  }\u0027 +\n-      \u0027} else {\u0027 +\n-      \u0027  false;\u0027 +\n-      \u0027}\u0027 +\n-      \u0027}\u0027,\n+  evalInInspectedWindow(\n+    \u0027viewAttributeSource\u0027,\n+    [{rendererID, elementID, path}],\n     (didInspect, evalError) \u003d\u003e {\n       if (evalError) {\n         console.error(evalError);\n@@ -31,25 +13,9 @@ export function viewAttributeSource(rendererID, elementID, path) {\n }\n \n export function viewElementSource(rendererID, elementID) {\n-  chrome.devtools.inspectedWindow.eval(\n-    \u0027{\u0027 + // The outer block is important because it means we can declare local variables.\n-      \u0027const renderer \u003d window.__REACT_DEVTOOLS_GLOBAL_HOOK__.rendererInterfaces.get(\u0027 +\n-      JSON.stringify(rendererID) +\n-      \u0027);\u0027 +\n-      \u0027if (renderer) {\u0027 +\n-      \u0027  const value \u003d renderer.getElementSourceFunctionById(\u0027 +\n-      JSON.stringify(elementID) +\n-      \u0027);\u0027 +\n-      \u0027  if (value) {\u0027 +\n-      \u0027    inspect(value);\u0027 +\n-      \u0027    true;\u0027 +\n-      \u0027  } else {\u0027 +\n-      \u0027    false;\u0027 +\n-      \u0027  }\u0027 +\n-      \u0027} else {\u0027 +\n-      \u0027  false;\u0027 +\n-      \u0027}\u0027 +\n-      \u0027}\u0027,\n+  evalInInspectedWindow(\n+    \u0027viewElementSource\u0027,\n+    [{rendererID, elementID}],\n     (didInspect, evalError) \u003d\u003e {\n       if (evalError) {\n         console.error(evalError);\ndiff --git a/packages/react-devtools-extensions/webpack.config.js b/packages/react-devtools-extensions/webpack.config.js\nindex 191eabc..7b5acca 100644\n--- a/packages/react-devtools-extensions/webpack.config.js\n+++ b/packages/react-devtools-extensions/webpack.config.js\n@@ -69,6 +69,7 @@ module.exports \u003d {\n     backend: \u0027./src/backend.js\u0027,\n     background: \u0027./src/background/index.js\u0027,\n     backendManager: \u0027./src/contentScripts/backendManager.js\u0027,\n+    fallbackEvalContext: \u0027./src/contentScripts/fallbackEvalContext.js\u0027,\n     fileFetcher: \u0027./src/contentScripts/fileFetcher.js\u0027,\n     main: \u0027./src/main/index.js\u0027,\n     panel: \u0027./src/panel.js\u0027,","expectedMessage":"[DevTools] Enable minimal support in pages with `sandbox` Content-Security-Policy (#35208)","repository":"react","commitHash":"583e20033220bc17a590a25624f6251c6b101ff4","metadata":{"author":"Yukimasa Funaoka \u003c37928585+mochiya98@users.noreply.github.com\u003e"}}
{"id":"react-8a830737","diff":" .../src/__tests__/store-test.js                    | 95 +++++++++++++++++++++-\n 1 file changed, 93 insertions(+), 2 deletions(-)\n\ndiff --git a/packages/react-devtools-shared/src/__tests__/store-test.js b/packages/react-devtools-shared/src/__tests__/store-test.js\nindex c4fe7d3..8c9beb1 100644\n--- a/packages/react-devtools-shared/src/__tests__/store-test.js\n+++ b/packages/react-devtools-shared/src/__tests__/store-test.js\n@@ -7,7 +7,12 @@\n  * @flow\n  */\n \n+import semver from \u0027semver\u0027;\n+\n import {getVersionedRenderImplementation} from \u0027./utils\u0027;\n+import {ReactVersion} from \u0027../../../../ReactVersions\u0027;\n+\n+const ReactVersionTestingAgainst \u003d process.env.REACT_VERSION || ReactVersion;\n \n describe(\u0027Store\u0027, () \u003d\u003e {\n   let React;\n@@ -3143,8 +3148,9 @@ describe(\u0027Store\u0027, () \u003d\u003e {\n     expect(store).toMatchInlineSnapshot(``);\n   });\n \n-  // @reactVersion \u003e\u003d 17.0\n-  it(\u0027should track suspended by in filtered fallback\u0027, async () \u003d\u003e {\n+  // Can\u0027t suspend the root in React 17.\n+  // @reactVersion \u003e\u003d 18.0\n+  it(\u0027should track suspended-by in filtered fallback suspending the root\u0027, async () \u003d\u003e {\n     function IgnoreMe({promise}) {\n       return readValue(promise);\n     }\n@@ -3196,6 +3202,91 @@ describe(\u0027Store\u0027, () \u003d\u003e {\n     `);\n   });\n \n+  // @reactVersion \u003e\u003d 17.0\n+  it(\u0027should track suspended-by in filtered fallback\u0027, async () \u003d\u003e {\n+    function IgnoreMe({promise}) {\n+      return readValue(promise);\n+    }\n+\n+    function Component({promise}) {\n+      if (promise) {\n+        return readValue(promise);\n+      }\n+      return null;\n+    }\n+\n+    await actAsync(\n+      async () \u003d\u003e\n+        (store.componentFilters \u003d [createDisplayNameFilter(\u0027^IgnoreMe\u0027, true)]),\n+    );\n+\n+    let resolveFallback;\n+    const fallbackPromise \u003d new Promise(resolve \u003d\u003e {\n+      resolveFallback \u003d resolve;\n+    });\n+    let resolveContent;\n+    const contentPromise \u003d new Promise(resolve \u003d\u003e {\n+      resolveContent \u003d resolve;\n+    });\n+\n+    await actAsync(() \u003d\u003e\n+      render(\n+        \u003cReact.Suspense\n+          fallback\u003d{\u003cComponent key\u003d\"root-fallback\" /\u003e}\n+          name\u003d\"root\"\u003e\n+          \u003cReact.Suspense\n+            name\u003d\"main\"\n+            fallback\u003d{\u003cIgnoreMe promise\u003d{fallbackPromise} /\u003e}\u003e\n+            \u003cComponent promise\u003d{contentPromise} /\u003e\n+          \u003c/React.Suspense\u003e\n+        \u003c/React.Suspense\u003e,\n+      ),\n+    );\n+\n+    if (semver.lt(ReactVersionTestingAgainst, \u002718.0.0\u0027)) {\n+      // React 17 commits partial trees hidden which causes the \"main\"\n+      // Suspense boundary to be included.\n+      // React 18 and upwards excluded partial tree entirely.\n+      expect(store).toMatchInlineSnapshot(`\n+        [root]\n+          ▾ \u003cSuspense name\u003d\"root\"\u003e\n+              \u003cComponent key\u003d\"root-fallback\"\u003e\n+        [suspense-root]  rects\u003d{null}\n+          \u003cSuspense name\u003d\"root\" rects\u003d{null}\u003e\n+            \u003cSuspense name\u003d\"main\" rects\u003d{null}\u003e\n+      `);\n+    } else {\n+      expect(store).toMatchInlineSnapshot(`\n+        [root]\n+          ▾ \u003cSuspense name\u003d\"root\"\u003e\n+              \u003cComponent key\u003d\"root-fallback\"\u003e\n+        [suspense-root]  rects\u003d{null}\n+          \u003cSuspense name\u003d\"root\" rects\u003d{null}\u003e\n+      `);\n+    }\n+\n+    await actAsync(() \u003d\u003e resolveFallback(\u0027loading\u0027));\n+    expect(store).toMatchInlineSnapshot(`\n+      [root]\n+        ▾ \u003cSuspense name\u003d\"root\"\u003e\n+            \u003cSuspense name\u003d\"main\"\u003e\n+      [suspense-root]  rects\u003d{null}\n+        \u003cSuspense name\u003d\"root\" rects\u003d{null}\u003e\n+          \u003cSuspense name\u003d\"main\" rects\u003d{null}\u003e\n+    `);\n+\n+    await actAsync(() \u003d\u003e resolveContent(\u0027content\u0027));\n+    expect(store).toMatchInlineSnapshot(`\n+      [root]\n+        ▾ \u003cSuspense name\u003d\"root\"\u003e\n+          ▾ \u003cSuspense name\u003d\"main\"\u003e\n+              \u003cComponent\u003e\n+      [suspense-root]  rects\u003d{null}\n+        \u003cSuspense name\u003d\"root\" rects\u003d{null}\u003e\n+          \u003cSuspense name\u003d\"main\" rects\u003d{null}\u003e\n+    `);\n+  });\n+\n   // @reactVersion \u003e\u003d 19\n   it(\u0027should keep suspended boundaries in the Suspense tree but not hidden Activity\u0027, async () \u003d\u003e {\n     const Activity \u003d React.Activity || React.unstable_Activity;","expectedMessage":"[test] Fix DevTools regression tests (#35501)","repository":"react","commitHash":"8a83073753125156d62db14726e8527706411962","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-5aec1b2a","diff":" .../src/__tests__/store-test.js                    | 53 ++++++++++++++++++++++\n .../src/backend/fiber/renderer.js                  | 26 ++++++++++-\n 2 files changed, 78 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/react-devtools-shared/src/__tests__/store-test.js b/packages/react-devtools-shared/src/__tests__/store-test.js\nindex 37272ea..c4fe7d3 100644\n--- a/packages/react-devtools-shared/src/__tests__/store-test.js\n+++ b/packages/react-devtools-shared/src/__tests__/store-test.js\n@@ -3143,6 +3143,59 @@ describe(\u0027Store\u0027, () \u003d\u003e {\n     expect(store).toMatchInlineSnapshot(``);\n   });\n \n+  // @reactVersion \u003e\u003d 17.0\n+  it(\u0027should track suspended by in filtered fallback\u0027, async () \u003d\u003e {\n+    function IgnoreMe({promise}) {\n+      return readValue(promise);\n+    }\n+\n+    function Component({promise}) {\n+      return readValue(promise);\n+    }\n+\n+    await actAsync(\n+      async () \u003d\u003e\n+        (store.componentFilters \u003d [createDisplayNameFilter(\u0027^IgnoreMe\u0027, true)]),\n+    );\n+\n+    let resolveFallback;\n+    const fallbackPromise \u003d new Promise(resolve \u003d\u003e {\n+      resolveFallback \u003d resolve;\n+    });\n+    let resolveContent;\n+    const contentPromise \u003d new Promise(resolve \u003d\u003e {\n+      resolveContent \u003d resolve;\n+    });\n+\n+    await actAsync(() \u003d\u003e\n+      render(\n+        \u003cReact.Suspense\n+          name\u003d\"main\"\n+          fallback\u003d{\u003cIgnoreMe promise\u003d{fallbackPromise} /\u003e}\u003e\n+          \u003cComponent promise\u003d{contentPromise} /\u003e\n+        \u003c/React.Suspense\u003e,\n+      ),\n+    );\n+    expect(store).toMatchInlineSnapshot(``);\n+\n+    await actAsync(() \u003d\u003e resolveFallback(\u0027loading\u0027));\n+    expect(store).toMatchInlineSnapshot(`\n+      [root]\n+          \u003cSuspense name\u003d\"main\"\u003e\n+      [suspense-root]  rects\u003d{null}\n+        \u003cSuspense name\u003d\"main\" rects\u003d{null}\u003e\n+    `);\n+\n+    await actAsync(() \u003d\u003e resolveContent(\u0027content\u0027));\n+    expect(store).toMatchInlineSnapshot(`\n+      [root]\n+        ▾ \u003cSuspense name\u003d\"main\"\u003e\n+            \u003cComponent\u003e\n+      [suspense-root]  rects\u003d{null}\n+        \u003cSuspense name\u003d\"main\" rects\u003d{null}\u003e\n+    `);\n+  });\n+\n   // @reactVersion \u003e\u003d 19\n   it(\u0027should keep suspended boundaries in the Suspense tree but not hidden Activity\u0027, async () \u003d\u003e {\n     const Activity \u003d React.Activity || React.unstable_Activity;\ndiff --git a/packages/react-devtools-shared/src/backend/fiber/renderer.js b/packages/react-devtools-shared/src/backend/fiber/renderer.js\nindex 4f755fd..6848e32 100644\n--- a/packages/react-devtools-shared/src/backend/fiber/renderer.js\n+++ b/packages/react-devtools-shared/src/backend/fiber/renderer.js\n@@ -2992,6 +2992,30 @@ export function attach(\n     ) {\n       parentInstance \u003d parentInstance.parent;\n     }\n+    if (parentInstance.kind \u003d\u003d\u003d FIBER_INSTANCE) {\n+      const fiber \u003d parentInstance.data;\n+\n+      if (\n+        fiber.tag \u003d\u003d\u003d SuspenseComponent \u0026\u0026\n+        parentInstance !\u003d\u003d parentSuspenseNode.instance\n+      ) {\n+        // We\u0027re about to attach async info to a Suspense boundary we\u0027re not\n+        // actually considering the parent Suspense boundary for this async info.\n+        // We must have not found a suitable Fiber inside the fallback (e.g. due to filtering).\n+        // Use the parent of this instance instead since we treat async info\n+        // attached to a Suspense boundary as that async info triggering the\n+        // fallback of that boundary.\n+        const parent \u003d parentInstance.parent;\n+        if (parent \u003d\u003d\u003d null) {\n+          // This shouldn\u0027t happen. Any \u003cSuspense\u003e would have at least have the\n+          // host root as the parent which can\u0027t have a fallback.\n+          throw new Error(\n+            \u0027Did not find a suitable instance for this async info. This is a bug in React.\u0027,\n+          );\n+        }\n+        parentInstance \u003d parent;\n+      }\n+    }\n \n     const suspenseNodeSuspendedBy \u003d parentSuspenseNode.suspendedBy;\n     const ioInfo \u003d asyncInfo.awaited;\n@@ -5255,9 +5279,9 @@ export function attach(\n       // It might even result in a bad user experience for e.g. node selection in the Elements panel.\n       // The easiest fix is to strip out the intermediate Fragment fibers,\n       // so the Elements panel and Profiler don\u0027t need to special case them.\n-      // Suspense components only have a non-null memoizedState if they\u0027re timed-out.\n       const isLegacySuspense \u003d\n         nextFiber.tag \u003d\u003d\u003d SuspenseComponent \u0026\u0026 OffscreenComponent \u003d\u003d\u003d -1;\n+      // Suspense components only have a non-null memoizedState if they\u0027re timed-out.\n       const prevDidTimeout \u003d\n         isLegacySuspense \u0026\u0026 prevFiber.memoizedState !\u003d\u003d null;\n       const nextDidTimeOut \u003d","expectedMessage":"[DevTools] Attach async info in filtered fallback to parent of Suspense (#35456)","repository":"react","commitHash":"5aec1b2a8d1bcafb43a7ddb64dc37eacad081bea","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-d6cae440","diff":" scripts/jest/config.base.js           |  1 +\n scripts/jest/sizeBalancedSequencer.js | 28 ++++++++++++++++++++++++++++\n 2 files changed, 29 insertions(+)\n\ndiff --git a/scripts/jest/config.base.js b/scripts/jest/config.base.js\nindex ba001e1..12b5fc4 100644\n--- a/scripts/jest/config.base.js\n+++ b/scripts/jest/config.base.js\n@@ -2,6 +2,7 @@\n \n module.exports \u003d {\n   globalSetup: require.resolve(\u0027./setupGlobal.js\u0027),\n+  testSequencer: require.resolve(\u0027./sizeBalancedSequencer.js\u0027),\n   modulePathIgnorePatterns: [\n     \u0027\u003crootDir\u003e/scripts/rollup/shims/\u0027,\n     \u0027\u003crootDir\u003e/scripts/bench/\u0027,\ndiff --git a/scripts/jest/sizeBalancedSequencer.js b/scripts/jest/sizeBalancedSequencer.js\nnew file mode 100644\nindex 0000000..318cd13\n--- /dev/null\n+++ b/scripts/jest/sizeBalancedSequencer.js\n@@ -0,0 +1,28 @@\n+\u0027use strict\u0027;\n+\n+const Sequencer \u003d require(\u0027@jest/test-sequencer\u0027).default;\n+const fs \u003d require(\u0027fs\u0027);\n+\n+class SizeBalancedSequencer extends Sequencer {\n+  shard(tests, {shardIndex, shardCount}) {\n+    const shards \u003d Array.from({length: shardCount}, () \u003d\u003e ({\n+      tests: [],\n+      size: 0,\n+    }));\n+    const sorted \u003d [...tests].sort(\n+      (a, b) \u003d\u003e fs.statSync(b.path).size - fs.statSync(a.path).size\n+    );\n+\n+    for (let i \u003d 0; i \u003c sorted.length; i++) {\n+      const test \u003d sorted[i];\n+      const size \u003d fs.statSync(test.path).size;\n+      const smallest \u003d shards.reduce((min, s) \u003d\u003e (s.size \u003c min.size ? s : min));\n+      smallest.tests.push(test);\n+      smallest.size +\u003d size;\n+    }\n+\n+    return shards[shardIndex - 1].tests;\n+  }\n+}\n+\n+module.exports \u003d SizeBalancedSequencer;","expectedMessage":"[ci] Add size-balanced test sequencer for better shard distribution (#35458)","repository":"react","commitHash":"d6cae440e34c6250928e18bed4a16480f83ae18a","metadata":{"author":"lauren \u003cpoteto@users.noreply.github.com\u003e"}}
{"id":"react-00908be9","diff":" .github/workflows/runtime_build_and_test.yml                      | 8 +++++---\n .../react-devtools-shared/src/__tests__/profilerContext-test.js   | 2 +-\n 2 files changed, 6 insertions(+), 4 deletions(-)\n\ndiff --git a/.github/workflows/runtime_build_and_test.yml b/.github/workflows/runtime_build_and_test.yml\nindex 735ac6e..25282e8 100644\n--- a/.github/workflows/runtime_build_and_test.yml\n+++ b/.github/workflows/runtime_build_and_test.yml\n@@ -454,9 +454,11 @@ jobs:\n       fail-fast: false\n       matrix:\n         shard:\n-          - 1/3\n-          - 2/3\n-          - 3/3\n+          - 1/5\n+          - 2/5\n+          - 3/5\n+          - 4/5\n+          - 5/5\n     runs-on: ubuntu-latest\n     steps:\n       - uses: actions/checkout@v4\ndiff --git a/packages/react-devtools-shared/src/__tests__/profilerContext-test.js b/packages/react-devtools-shared/src/__tests__/profilerContext-test.js\nindex 7864f97..a1e47de 100644\n--- a/packages/react-devtools-shared/src/__tests__/profilerContext-test.js\n+++ b/packages/react-devtools-shared/src/__tests__/profilerContext-test.js\n@@ -654,7 +654,7 @@ describe(\u0027ProfilerContext\u0027, () \u003d\u003e {\n     expect(store.profilerStore.isProfilingBasedOnUserInput).toBe(false);\n \n     document.body.removeChild(profilerContainer);\n-  });\n+  }, 20000);\n \n   it(\u0027should navigate between commits when the keyboard shortcut is pressed\u0027, async () \u003d\u003e {\n     const Parent \u003d () \u003d\u003e \u003cChild /\u003e;","expectedMessage":"[ci] Increase DevTools test shards and bump timeout (#35459)","repository":"react","commitHash":"00908be9ff2d033ab5340e2a250b6288909d41a0","metadata":{"author":"lauren \u003cpoteto@users.noreply.github.com\u003e"}}
{"id":"react-0e180141","diff":" .github/workflows/runtime_build_and_test.yml | 45 ++++++++++++++++++++++++++--\n 1 file changed, 42 insertions(+), 3 deletions(-)\n\ndiff --git a/.github/workflows/runtime_build_and_test.yml b/.github/workflows/runtime_build_and_test.yml\nindex c1cc8df..735ac6e 100644\n--- a/.github/workflows/runtime_build_and_test.yml\n+++ b/.github/workflows/runtime_build_and_test.yml\n@@ -382,9 +382,6 @@ jobs:\n           -r\u003dexperimental --env\u003ddevelopment,\n           -r\u003dexperimental --env\u003dproduction,\n \n-          # Dev Tools\n-          --project\u003ddevtools -r\u003dexperimental,\n-\n           # TODO: Update test config to support www build tests\n           # - \"-r\u003dwww-classic --env\u003ddevelopment --variant\u003dfalse\"\n           # - \"-r\u003dwww-classic --env\u003dproduction --variant\u003dfalse\"\n@@ -450,6 +447,48 @@ jobs:\n         run: ls -R build\n       - run: yarn test --build ${{ matrix.test_params }} --shard\u003d${{ matrix.shard }} --ci\n \n+  test_build_devtools:\n+    name: yarn test-build (devtools)\n+    needs: [build_and_lint, runtime_node_modules_cache]\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        shard:\n+          - 1/3\n+          - 2/3\n+          - 3/3\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v4\n+        with:\n+          ref: ${{ github.event.inputs.commit_sha !\u003d \u0027\u0027 \u0026\u0026 github.event.inputs.commit_sha || github.event.pull_request.head.sha || github.sha }}\n+      - uses: actions/setup-node@v4\n+        with:\n+          node-version-file: \u0027.nvmrc\u0027\n+          cache: yarn\n+          cache-dependency-path: yarn.lock\n+      - name: Restore cached node_modules\n+        uses: actions/cache/restore@v4\n+        id: node_modules\n+        with:\n+          path: |\n+            **/node_modules\n+          key: runtime-node_modules-v7-${{ runner.arch }}-${{ runner.os }}-${{ hashFiles(\u0027yarn.lock\u0027) }}\n+          # Don\u0027t use restore-keys here. Otherwise the cache grows indefinitely.\n+      - name: Ensure clean build directory\n+        run: rm -rf build\n+      - run: yarn install --frozen-lockfile\n+        if: steps.node_modules.outputs.cache-hit !\u003d \u0027true\u0027\n+      - name: Restore archived build\n+        uses: actions/download-artifact@v4\n+        with:\n+          pattern: _build_*\n+          path: build\n+          merge-multiple: true\n+      - name: Display structure of build\n+        run: ls -R build\n+      - run: yarn test --build --project\u003ddevtools -r\u003dexperimental --shard\u003d${{ matrix.shard }} --ci\n+\n   process_artifacts_combined:\n     name: Process artifacts combined\n     needs: [build_and_lint, runtime_node_modules_cache]","expectedMessage":"[ci] Separate DevTools test-build into dedicated job with fewer shards (#35457)","repository":"react","commitHash":"0e180141bf9b859efdbe067cf1eb850e22048bf8","metadata":{"author":"lauren \u003cpoteto@users.noreply.github.com\u003e"}}
{"id":"react-65eec428","diff":" .../src/events/plugins/FormActionEventPlugin.js    | 32 ++--------------------\n .../ReactDOMFizzInstructionSetInlineCodeStrings.js |  2 +-\n .../ReactDOMFizzInstructionSetShared.js            | 20 +-------------\n .../react-dom/src/__tests__/ReactDOMForm-test.js   | 24 ++++++++++++----\n .../src/__tests__/ReactFlightDOMForm-test.js       | 12 +-------\n 5 files changed, 24 insertions(+), 66 deletions(-)\n\ndiff --git a/packages/react-dom-bindings/src/events/plugins/FormActionEventPlugin.js b/packages/react-dom-bindings/src/events/plugins/FormActionEventPlugin.js\nindex 496b55e..420d1d1 100644\n--- a/packages/react-dom-bindings/src/events/plugins/FormActionEventPlugin.js\n+++ b/packages/react-dom-bindings/src/events/plugins/FormActionEventPlugin.js\n@@ -45,30 +45,6 @@ function coerceFormActionProp(\n   }\n }\n \n-function createFormDataWithSubmitter(\n-  form: HTMLFormElement,\n-  submitter: HTMLInputElement | HTMLButtonElement,\n-) {\n-  // The submitter\u0027s value should be included in the FormData.\n-  // It should be in the document order in the form.\n-  // Since the FormData constructor invokes the formdata event it also\n-  // needs to be available before that happens so after construction it\u0027s too\n-  // late. We use a temporary fake node for the duration of this event.\n-  // TODO: FormData takes a second argument that it\u0027s the submitter but this\n-  // is fairly new so not all browsers support it yet. Switch to that technique\n-  // when available.\n-  const temp \u003d submitter.ownerDocument.createElement(\u0027input\u0027);\n-  temp.name \u003d submitter.name;\n-  temp.value \u003d submitter.value;\n-  if (form.id) {\n-    temp.setAttribute(\u0027form\u0027, form.id);\n-  }\n-  (submitter.parentNode: any).insertBefore(temp, submitter);\n-  const formData \u003d new FormData(form);\n-  (temp.parentNode: any).removeChild(temp);\n-  return formData;\n-}\n-\n /**\n  * This plugin invokes action functions on forms, inputs and buttons if\n  * the form doesn\u0027t prevent default.\n@@ -129,9 +105,7 @@ function extractEvents(\n       if (didCurrentEventScheduleTransition()) {\n         // We\u0027re going to set the pending form status, but because the submission\n         // was prevented, we should not fire the action function.\n-        const formData \u003d submitter\n-          ? createFormDataWithSubmitter(form, submitter)\n-          : new FormData(form);\n+        const formData \u003d new FormData(form, submitter);\n         const pendingState: FormStatus \u003d {\n           pending: true,\n           data: formData,\n@@ -160,9 +134,7 @@ function extractEvents(\n       event.preventDefault();\n \n       // Dispatch the action and set a pending form status.\n-      const formData \u003d submitter\n-        ? createFormDataWithSubmitter(form, submitter)\n-        : new FormData(form);\n+      const formData \u003d new FormData(form, submitter);\n       const pendingState: FormStatus \u003d {\n         pending: true,\n         data: formData,\ndiff --git a/packages/react-dom-bindings/src/server/fizz-instruction-set/ReactDOMFizzInstructionSetInlineCodeStrings.js b/packages/react-dom-bindings/src/server/fizz-instruction-set/ReactDOMFizzInstructionSetInlineCodeStrings.js\nindex cac2283..eca449b 100644\n--- a/packages/react-dom-bindings/src/server/fizz-instruction-set/ReactDOMFizzInstructionSetInlineCodeStrings.js\n+++ b/packages/react-dom-bindings/src/server/fizz-instruction-set/ReactDOMFizzInstructionSetInlineCodeStrings.js\n@@ -14,4 +14,4 @@ export const completeBoundaryWithStyles \u003d\n export const completeSegment \u003d\n   \u0027$RS\u003dfunction(a,b){a\u003ddocument.getElementById(a);b\u003ddocument.getElementById(b);for(a.parentNode.removeChild(a);a.firstChild;)b.parentNode.insertBefore(a.firstChild,b);b.parentNode.removeChild(b)};\u0027;\n export const formReplaying \u003d\n-  \u0027addEventListener(\"submit\",function(a){if(!a.defaultPrevented){var c\u003da.target,d\u003da.submitter,e\u003dc.action,b\u003dd;if(d){var f\u003dd.getAttribute(\"formAction\");null!\u003df\u0026\u0026(e\u003df,b\u003dnull)}\"javascript:throw new Error(\\\u0027React form unexpectedly submitted.\\\u0027)\"\u003d\u003d\u003de\u0026\u0026(a.preventDefault(),b?(a\u003ddocument.createElement(\"input\"),a.name\u003db.name,a.value\u003db.value,b.parentNode.insertBefore(a,b),b\u003dnew FormData(c),a.parentNode.removeChild(a)):b\u003dnew FormData(c),a\u003dc.ownerDocument||c,(a.$$reactFormReplay\u003da.$$reactFormReplay||[]).push(c,d,b))}});\u0027;\n+  \u0027addEventListener(\"submit\",function(a){if(!a.defaultPrevented){var b\u003da.target,d\u003da.submitter,c\u003db.action,e\u003dd;if(d){var f\u003dd.getAttribute(\"formAction\");null!\u003df\u0026\u0026(c\u003df,e\u003dnull)}\"javascript:throw new Error(\\\u0027React form unexpectedly submitted.\\\u0027)\"\u003d\u003d\u003dc\u0026\u0026(a.preventDefault(),a\u003dnew FormData(b,e),c\u003db.ownerDocument||b,(c.$$reactFormReplay\u003dc.$$reactFormReplay||[]).push(b,d,a))}});\u0027;\ndiff --git a/packages/react-dom-bindings/src/server/fizz-instruction-set/ReactDOMFizzInstructionSetShared.js b/packages/react-dom-bindings/src/server/fizz-instruction-set/ReactDOMFizzInstructionSetShared.js\nindex efe3ad4..86d8801 100644\n--- a/packages/react-dom-bindings/src/server/fizz-instruction-set/ReactDOMFizzInstructionSetShared.js\n+++ b/packages/react-dom-bindings/src/server/fizz-instruction-set/ReactDOMFizzInstructionSetShared.js\n@@ -634,25 +634,7 @@ export function listenToFormSubmissionsForReplaying() {\n     event.preventDefault();\n \n     // Take a snapshot of the FormData at the time of the event.\n-    let formData;\n-    if (formDataSubmitter) {\n-      // The submitter\u0027s value should be included in the FormData.\n-      // It should be in the document order in the form.\n-      // Since the FormData constructor invokes the formdata event it also\n-      // needs to be available before that happens so after construction it\u0027s too\n-      // late. We use a temporary fake node for the duration of this event.\n-      // TODO: FormData takes a second argument that it\u0027s the submitter but this\n-      // is fairly new so not all browsers support it yet. Switch to that technique\n-      // when available.\n-      const temp \u003d document.createElement(\u0027input\u0027);\n-      temp.name \u003d formDataSubmitter.name;\n-      temp.value \u003d formDataSubmitter.value;\n-      formDataSubmitter.parentNode.insertBefore(temp, formDataSubmitter);\n-      formData \u003d new FormData(form);\n-      temp.parentNode.removeChild(temp);\n-    } else {\n-      formData \u003d new FormData(form);\n-    }\n+    const formData \u003d new FormData(form, formDataSubmitter);\n \n     // Queue for replaying later. This field could potentially be shared with multiple\n     // Reacts on the same page since each one will preventDefault for the next one.\ndiff --git a/packages/react-dom/src/__tests__/ReactDOMForm-test.js b/packages/react-dom/src/__tests__/ReactDOMForm-test.js\nindex 96021e3..21995b6 100644\n--- a/packages/react-dom/src/__tests__/ReactDOMForm-test.js\n+++ b/packages/react-dom/src/__tests__/ReactDOMForm-test.js\n@@ -14,8 +14,8 @@ global.IS_REACT_ACT_ENVIRONMENT \u003d true;\n // Our current version of JSDOM doesn\u0027t implement the event dispatching\n // so we polyfill it.\n const NativeFormData \u003d global.FormData;\n-const FormDataPolyfill \u003d function FormData(form) {\n-  const formData \u003d new NativeFormData(form);\n+const FormDataPolyfill \u003d function FormData(form, submitter) {\n+  const formData \u003d new NativeFormData(form, submitter);\n   const formDataEvent \u003d new Event(\u0027formdata\u0027, {\n     bubbles: true,\n     cancelable: false,\n@@ -489,11 +489,16 @@ describe(\u0027ReactDOMForm\u0027, () \u003d\u003e {\n     const inputRef \u003d React.createRef();\n     const buttonRef \u003d React.createRef();\n     const outsideButtonRef \u003d React.createRef();\n+    const imageButtonRef \u003d React.createRef();\n     let button;\n+    let buttonX;\n+    let buttonY;\n     let title;\n \n     function action(formData) {\n       button \u003d formData.get(\u0027button\u0027);\n+      buttonX \u003d formData.get(\u0027button.x\u0027);\n+      buttonY \u003d formData.get(\u0027button.y\u0027);\n       title \u003d formData.get(\u0027title\u0027);\n     }\n \n@@ -508,6 +513,12 @@ describe(\u0027ReactDOMForm\u0027, () \u003d\u003e {\n             \u003cbutton name\u003d\"button\" value\u003d\"edit\" ref\u003d{buttonRef}\u003e\n               Edit\n             \u003c/button\u003e\n+            \u003cinput\n+              type\u003d\"image\"\n+              name\u003d\"button\"\n+              href\u003d\"/some/image.png\"\n+              ref\u003d{imageButtonRef}\n+            /\u003e\n           \u003c/form\u003e\n           \u003cform id\u003d\"form\" action\u003d{action}\u003e\n             \u003cinput type\u003d\"text\" name\u003d\"title\" defaultValue\u003d\"hello\" /\u003e\n@@ -546,9 +557,12 @@ describe(\u0027ReactDOMForm\u0027, () \u003d\u003e {\n     expect(button).toBe(\u0027outside\u0027);\n     expect(title).toBe(\u0027hello\u0027);\n \n-    // Ensure that the type field got correctly restored\n-    expect(inputRef.current.getAttribute(\u0027type\u0027)).toBe(\u0027submit\u0027);\n-    expect(buttonRef.current.getAttribute(\u0027type\u0027)).toBe(null);\n+    await submit(imageButtonRef.current);\n+\n+    expect(button).toBe(null);\n+    expect(buttonX).toBe(\u00270\u0027);\n+    expect(buttonY).toBe(\u00270\u0027);\n+    expect(title).toBe(\u0027hello\u0027);\n   });\n \n   it(\u0027excludes the submitter name when the submitter is a function action\u0027, async () \u003d\u003e {\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMForm-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMForm-test.js\nindex bb7c2c9..5cb8504 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMForm-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMForm-test.js\n@@ -121,17 +121,7 @@ describe(\u0027ReactFlightDOMForm\u0027, () \u003d\u003e {\n       const method \u003d (submitter \u0026\u0026 submitter.formMethod) || form.method;\n       const encType \u003d (submitter \u0026\u0026 submitter.formEnctype) || form.enctype;\n       if (method \u003d\u003d\u003d \u0027post\u0027 \u0026\u0026 encType \u003d\u003d\u003d \u0027multipart/form-data\u0027) {\n-        let formData;\n-        if (submitter) {\n-          const temp \u003d document.createElement(\u0027input\u0027);\n-          temp.name \u003d submitter.name;\n-          temp.value \u003d submitter.value;\n-          submitter.parentNode.insertBefore(temp, submitter);\n-          formData \u003d new FormData(form);\n-          temp.parentNode.removeChild(temp);\n-        } else {\n-          formData \u003d new FormData(form);\n-        }\n+        const formData \u003d new FormData(form, submitter);\n         return POST(formData);\n       }\n       throw new Error(\u0027Navigate to: \u0027 + action);","expectedMessage":"Use `FormData` `submitter` parameter (#29028)","repository":"react","commitHash":"65eec428c40d542d4d5a9c1af5c3f406aecf3440","metadata":{"author":"Jon Jensen \u003cjenseng@gmail.com\u003e"}}
{"id":"react-454fc41f","diff":" .../react-client/src/__tests__/ReactFlight-test.js    | 19 +++++++++++++++++++\n .../src/__tests__/ReactFlightDOMReply-test.js         | 11 +++++++++++\n 2 files changed, 30 insertions(+)\n\ndiff --git a/packages/react-client/src/__tests__/ReactFlight-test.js b/packages/react-client/src/__tests__/ReactFlight-test.js\nindex b2dcd69..b4a0723 100644\n--- a/packages/react-client/src/__tests__/ReactFlight-test.js\n+++ b/packages/react-client/src/__tests__/ReactFlight-test.js\n@@ -724,6 +724,25 @@ describe(\u0027ReactFlight\u0027, () \u003d\u003e {\n     });\n   });\n \n+  it(\u0027can transport cyclic arrays\u0027, async () \u003d\u003e {\n+    function ComponentClient({prop, obj}) {\n+      expect(prop[1]).toBe(prop);\n+      expect(prop[0]).toBe(obj);\n+    }\n+    const Component \u003d clientReference(ComponentClient);\n+\n+    const obj \u003d {};\n+    const cyclic \u003d [obj];\n+    cyclic[1] \u003d cyclic;\n+    const model \u003d \u003cComponent prop\u003d{cyclic} obj\u003d{obj} /\u003e;\n+\n+    const transport \u003d ReactNoopFlightServer.render(model);\n+\n+    await act(async () \u003d\u003e {\n+      ReactNoop.render(await ReactNoopFlightClient.read(transport));\n+    });\n+  });\n+\n   it(\u0027can render a lazy component as a shared component on the server\u0027, async () \u003d\u003e {\n     function SharedComponent({text}) {\n       return (\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js\nindex 2181eb5..4097189 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js\n@@ -650,6 +650,17 @@ describe(\u0027ReactFlightDOMReply\u0027, () \u003d\u003e {\n     expect(root.prop.obj).toBe(root.prop);\n   });\n \n+  it(\u0027can transport cyclic arrays\u0027, async () \u003d\u003e {\n+    const obj \u003d {};\n+    const cyclic \u003d [obj];\n+    cyclic[1] \u003d cyclic;\n+\n+    const body \u003d await ReactServerDOMClient.encodeReply({prop: cyclic, obj});\n+    const root \u003d await ReactServerDOMServer.decodeReply(body, webpackServerMap);\n+    expect(root.prop[1]).toBe(root.prop);\n+    expect(root.prop[0]).toBe(root.obj);\n+  });\n+\n   it(\u0027can abort an unresolved model and get the partial result\u0027, async () \u003d\u003e {\n     const promise \u003d new Promise(r \u003d\u003e {});\n     const controller \u003d new AbortController();","expectedMessage":"[test] Add tests for cyclic arrays in Flight and Flight Reply (#35347)","repository":"react","commitHash":"454fc41fc7d50f8abbcfb9595b01e8ea8bfcc265","metadata":{"author":"Hendrik Liebau \u003cmail@hendrik-liebau.de\u003e"}}
{"id":"react-f93b9fd4","diff":" .../src/client/ReactDOMComponent.js                | 77 ++++++++++++++++++++--\n 1 file changed, 71 insertions(+), 6 deletions(-)\n\ndiff --git a/packages/react-dom-bindings/src/client/ReactDOMComponent.js b/packages/react-dom-bindings/src/client/ReactDOMComponent.js\nindex 549b279..1b25e37 100644\n--- a/packages/react-dom-bindings/src/client/ReactDOMComponent.js\n+++ b/packages/react-dom-bindings/src/client/ReactDOMComponent.js\n@@ -235,6 +235,31 @@ function warnForPropDifference(\n   }\n }\n \n+function hasViewTransition(htmlElement: HTMLElement): boolean {\n+  return !!(\n+    htmlElement.getAttribute(\u0027vt-share\u0027) ||\n+    htmlElement.getAttribute(\u0027vt-exit\u0027) ||\n+    htmlElement.getAttribute(\u0027vt-enter\u0027) ||\n+    htmlElement.getAttribute(\u0027vt-update\u0027)\n+  );\n+}\n+\n+function isExpectedViewTransitionName(htmlElement: HTMLElement): boolean {\n+  if (!hasViewTransition(htmlElement)) {\n+    // We didn\u0027t expect to see a view transition name applied.\n+    return false;\n+  }\n+  const expectedVtName \u003d htmlElement.getAttribute(\u0027vt-name\u0027);\n+  const actualVtName: string \u003d (htmlElement.style: any)[\u0027view-transition-name\u0027];\n+  if (expectedVtName) {\n+    return expectedVtName \u003d\u003d\u003d actualVtName;\n+  } else {\n+    // Auto-generated name.\n+    // TODO: If Fizz starts applying a prefix to this name, we need to consider that.\n+    return actualVtName.startsWith(\u0027_T_\u0027);\n+  }\n+}\n+\n function warnForExtraAttributes(\n   domElement: Element,\n   attributeNames: Set\u003cstring\u003e,\n@@ -242,10 +267,28 @@ function warnForExtraAttributes(\n ) {\n   if (__DEV__) {\n     attributeNames.forEach(function (attributeName) {\n-      serverDifferences[getPropNameFromAttributeName(attributeName)] \u003d\n-        attributeName \u003d\u003d\u003d \u0027style\u0027\n-          ? getStylesObjectFromElement(domElement)\n-          : domElement.getAttribute(attributeName);\n+      if (attributeName \u003d\u003d\u003d \u0027style\u0027) {\n+        if (domElement.getAttribute(attributeName) \u003d\u003d\u003d \u0027\u0027) {\n+          // Skip empty style. It\u0027s fine.\n+          return;\n+        }\n+        const htmlElement \u003d ((domElement: any): HTMLElement);\n+        const style \u003d htmlElement.style;\n+        const isOnlyVTStyles \u003d\n+          (style.length \u003d\u003d\u003d 1 \u0026\u0026 style[0] \u003d\u003d\u003d \u0027view-transition-name\u0027) ||\n+          (style.length \u003d\u003d\u003d 2 \u0026\u0026\n+            style[0] \u003d\u003d\u003d \u0027view-transition-class\u0027 \u0026\u0026\n+            style[1] \u003d\u003d\u003d \u0027view-transition-name\u0027);\n+        if (isOnlyVTStyles \u0026\u0026 isExpectedViewTransitionName(htmlElement)) {\n+          // If the only extra style was the view-transition-name that we applied from the Fizz\n+          // runtime, then we should ignore it.\n+        } else {\n+          serverDifferences.style \u003d getStylesObjectFromElement(domElement);\n+        }\n+      } else {\n+        serverDifferences[getPropNameFromAttributeName(attributeName)] \u003d\n+          domElement.getAttribute(attributeName);\n+      }\n     });\n   }\n }\n@@ -1977,13 +2020,21 @@ function getStylesObjectFromElement(domElement: Element): {\n   [styleName: string]: string,\n } {\n   const serverValueInObjectForm: {[prop: string]: string} \u003d {};\n-  const style \u003d ((domElement: any): HTMLElement).style;\n+  const htmlElement: HTMLElement \u003d (domElement: any);\n+  const style \u003d htmlElement.style;\n   for (let i \u003d 0; i \u003c style.length; i++) {\n     const styleName: string \u003d style[i];\n     // TODO: We should use the original prop value here if it is equivalent.\n     // TODO: We could use the original client capitalization if the equivalent\n     // other capitalization exists in the DOM.\n-    serverValueInObjectForm[styleName] \u003d style.getPropertyValue(styleName);\n+    if (\n+      styleName \u003d\u003d\u003d \u0027view-transition-name\u0027 \u0026\u0026\n+      isExpectedViewTransitionName(htmlElement)\n+    ) {\n+      // This is a view transition name added by the Fizz runtime, not the user\u0027s props.\n+    } else {\n+      serverValueInObjectForm[styleName] \u003d style.getPropertyValue(styleName);\n+    }\n   }\n   return serverValueInObjectForm;\n }\n@@ -2018,6 +2069,20 @@ function diffHydratedStyles(\n     return;\n   }\n \n+  if (\n+    // Trailing semi-colon means this was regenerated.\n+    normalizedServerValue[normalizedServerValue.length - 1] \u003d\u003d\u003d \u0027;\u0027 \u0026\u0026\n+    // TODO: Should we just ignore any style if the style as been manipulated?\n+    hasViewTransition((domElement: any))\n+  ) {\n+    // If this had a view transition we might have applied a view transition\n+    // name/class and removed it. If that happens, the style attribute gets\n+    // regenerated from the style object. This means we\u0027ve lost the format\n+    // that we sent from the server and is unable to diff it. We just treat\n+    // it as passing even if it should be a mismatch in this edge case.\n+    return;\n+  }\n+\n   // Otherwise, we create the object from the DOM for the diff view.\n   serverDifferences.style \u003d getStylesObjectFromElement(domElement);\n }","expectedMessage":"Skip hydration errors when a view transition has been applied (#35380)","repository":"react","commitHash":"f93b9fd44b576c1e0233f854cd986cbf08b7a5c4","metadata":{"author":"Sebastian Markbåge \u003csebastian@calyptus.eu\u003e"}}
{"id":"react-b731fe28","diff":" packages/react-server/src/ReactFlightReplyServer.js | 8 +++++++-\n 1 file changed, 7 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/react-server/src/ReactFlightReplyServer.js b/packages/react-server/src/ReactFlightReplyServer.js\nindex 4d5a6da..88781cc 100644\n--- a/packages/react-server/src/ReactFlightReplyServer.js\n+++ b/packages/react-server/src/ReactFlightReplyServer.js\n@@ -133,14 +133,20 @@ ReactPromise.prototype.then \u003d function \u003cT\u003e(\n         // Recursively check if the value is itself a ReactPromise and if so if it points\n         // back to itself. This helps catch recursive thenables early error.\n         let cycleProtection \u003d 0;\n+        const visited \u003d new Set\u003ctypeof ReactPromise\u003e();\n         while (inspectedValue instanceof ReactPromise) {\n           cycleProtection++;\n-          if (inspectedValue \u003d\u003d\u003d chunk || cycleProtection \u003e 1000) {\n+          if (\n+            inspectedValue \u003d\u003d\u003d chunk ||\n+            visited.has(inspectedValue) ||\n+            cycleProtection \u003e 1000\n+          ) {\n             if (typeof reject \u003d\u003d\u003d \u0027function\u0027) {\n               reject(new Error(\u0027Cannot have cyclic thenables.\u0027));\n             }\n             return;\n           }\n+          visited.add(inspectedValue);\n           if (inspectedValue.status \u003d\u003d\u003d INITIALIZED) {\n             inspectedValue \u003d inspectedValue.value;\n           } else {","expectedMessage":"Improve cyclic thenable detection in ReactFlightReplyServer (#35369)","repository":"react","commitHash":"b731fe28cc492cb36c51c89866f5b63a3ffae2aa","metadata":{"author":"Christian Van \u003c113378434+cvan20191@users.noreply.github.com\u003e"}}
{"id":"react-88ee1f59","diff":" .../src/HIR/Environment.ts                         |  9 ++-\n .../Validation/ValidateExhaustiveDependencies.ts   | 35 +++++++--\n .../error.exhaustive-deps-effect-events.expect.md  |  2 +-\n .../error.exhaustive-deps-effect-events.js         |  2 +-\n ...lid-exhaustive-effect-deps-extra-only.expect.md | 83 +++++++++++++++++++++\n ...or.invalid-exhaustive-effect-deps-extra-only.js | 24 +++++++\n ...d-exhaustive-effect-deps-missing-only.expect.md | 84 ++++++++++++++++++++++\n ....invalid-exhaustive-effect-deps-missing-only.js | 24 +++++++\n .../error.invalid-exhaustive-effect-deps.expect.md |  2 +-\n .../error.invalid-exhaustive-effect-deps.js        |  2 +-\n ...onreactive-stable-types-as-extra-deps.expect.md |  4 +-\n ...allow-nonreactive-stable-types-as-extra-deps.js |  2 +-\n .../exhaustive-deps-effect-events.expect.md        |  4 +-\n .../exhaustive-deps-effect-events.js               |  2 +-\n fixtures/eslint-v9/index.js                        | 13 ++++\n fixtures/eslint-v9/yarn.lock                       | 22 ++++--\n .../src/shared/RunReactCompiler.ts                 |  1 +\n 17 files changed, 293 insertions(+), 22 deletions(-)\n\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts b/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\nindex 05105ae..d6c0e24 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\n@@ -225,8 +225,15 @@ export const EnvironmentConfigSchema \u003d z.object({\n \n   /**\n    * Validate that dependencies supplied to effect hooks are exhaustive.\n+   * Can be:\n+   * - \u0027off\u0027: No validation (default)\n+   * - \u0027all\u0027: Validate and report both missing and extra dependencies\n+   * - \u0027missing-only\u0027: Only report missing dependencies\n+   * - \u0027extra-only\u0027: Only report extra/unnecessary dependencies\n    */\n-  validateExhaustiveEffectDependencies: z.boolean().default(false),\n+  validateExhaustiveEffectDependencies: z\n+    .enum([\u0027off\u0027, \u0027all\u0027, \u0027missing-only\u0027, \u0027extra-only\u0027])\n+    .default(\u0027off\u0027),\n \n   /**\n    * When this is true, rather than pruning existing manual memoization but ensuring or validating\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\nindex e364c02..e72de6c 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\n@@ -141,6 +141,7 @@ export function validateExhaustiveDependencies(\n         reactive,\n         startMemo.depsLoc,\n         ErrorCategory.MemoDependencies,\n+        \u0027all\u0027,\n       );\n       if (diagnostic !\u003d null) {\n         error.pushDiagnostic(diagnostic);\n@@ -159,7 +160,7 @@ export function validateExhaustiveDependencies(\n       onStartMemoize,\n       onFinishMemoize,\n       onEffect: (inferred, manual, manualMemoLoc) \u003d\u003e {\n-        if (env.config.validateExhaustiveEffectDependencies \u003d\u003d\u003d false) {\n+        if (env.config.validateExhaustiveEffectDependencies \u003d\u003d\u003d \u0027off\u0027) {\n           return;\n         }\n         if (DEBUG) {\n@@ -195,12 +196,17 @@ export function validateExhaustiveDependencies(\n             });\n           }\n         }\n+        const effectReportMode \u003d\n+          typeof env.config.validateExhaustiveEffectDependencies \u003d\u003d\u003d \u0027string\u0027\n+            ? env.config.validateExhaustiveEffectDependencies\n+            : \u0027all\u0027;\n         const diagnostic \u003d validateDependencies(\n           Array.from(inferred),\n           manualDeps,\n           reactive,\n           manualMemoLoc,\n           ErrorCategory.EffectExhaustiveDependencies,\n+          effectReportMode,\n         );\n         if (diagnostic !\u003d null) {\n           error.pushDiagnostic(diagnostic);\n@@ -220,6 +226,7 @@ function validateDependencies(\n   category:\n     | ErrorCategory.MemoDependencies\n     | ErrorCategory.EffectExhaustiveDependencies,\n+  exhaustiveDepsReportMode: \u0027all\u0027 | \u0027missing-only\u0027 | \u0027extra-only\u0027,\n ): CompilerDiagnostic | null {\n   // Sort dependencies by name and path, with shorter/non-optional paths first\n   inferred.sort((a, b) \u003d\u003e {\n@@ -370,9 +377,20 @@ function validateDependencies(\n     extra.push(dep);\n   }\n \n-  if (missing.length !\u003d\u003d 0 || extra.length !\u003d\u003d 0) {\n+  // Filter based on report mode\n+  const filteredMissing \u003d\n+    exhaustiveDepsReportMode \u003d\u003d\u003d \u0027extra-only\u0027 ? [] : missing;\n+  const filteredExtra \u003d\n+    exhaustiveDepsReportMode \u003d\u003d\u003d \u0027missing-only\u0027 ? [] : extra;\n+\n+  if (filteredMissing.length !\u003d\u003d 0 || filteredExtra.length !\u003d\u003d 0) {\n     let suggestion: CompilerSuggestion | null \u003d null;\n-    if (manualMemoLoc !\u003d null \u0026\u0026 typeof manualMemoLoc !\u003d\u003d \u0027symbol\u0027) {\n+    if (\n+      manualMemoLoc !\u003d null \u0026\u0026\n+      typeof manualMemoLoc !\u003d\u003d \u0027symbol\u0027 \u0026\u0026\n+      manualMemoLoc.start.index !\u003d null \u0026\u0026\n+      manualMemoLoc.end.index !\u003d null\n+    ) {\n       suggestion \u003d {\n         description: \u0027Update dependencies\u0027,\n         range: [manualMemoLoc.start.index, manualMemoLoc.end.index],\n@@ -388,8 +406,13 @@ function validateDependencies(\n           .join(\u0027, \u0027)}]`,\n       };\n     }\n-    const diagnostic \u003d createDiagnostic(category, missing, extra, suggestion);\n-    for (const dep of missing) {\n+    const diagnostic \u003d createDiagnostic(\n+      category,\n+      filteredMissing,\n+      filteredExtra,\n+      suggestion,\n+    );\n+    for (const dep of filteredMissing) {\n       let reactiveStableValueHint \u003d \u0027\u0027;\n       if (isStableType(dep.identifier)) {\n         reactiveStableValueHint \u003d\n@@ -402,7 +425,7 @@ function validateDependencies(\n         loc: dep.loc,\n       });\n     }\n-    for (const dep of extra) {\n+    for (const dep of filteredExtra) {\n       if (dep.root.kind \u003d\u003d\u003d \u0027Global\u0027) {\n         diagnostic.withDetails({\n           kind: \u0027error\u0027,\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.exhaustive-deps-effect-events.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.exhaustive-deps-effect-events.expect.md\nindex e2ab53d..d0a626e 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.exhaustive-deps-effect-events.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.exhaustive-deps-effect-events.expect.md\n@@ -2,7 +2,7 @@\n ## Input\n \n ```javascript\n-// @validateExhaustiveEffectDependencies\n+// @validateExhaustiveEffectDependencies:\"all\"\n import {useEffect, useEffectEvent} from \u0027react\u0027;\n \n function Component({x, y, z}) {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.exhaustive-deps-effect-events.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.exhaustive-deps-effect-events.js\nindex f8e9c8d..03e4a32 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.exhaustive-deps-effect-events.js\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.exhaustive-deps-effect-events.js\n@@ -1,4 +1,4 @@\n-// @validateExhaustiveEffectDependencies\n+// @validateExhaustiveEffectDependencies:\"all\"\n import {useEffect, useEffectEvent} from \u0027react\u0027;\n \n function Component({x, y, z}) {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-extra-only.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-extra-only.expect.md\nnew file mode 100644\nindex 0000000..f9aac96\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-extra-only.expect.md\n@@ -0,0 +1,83 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveEffectDependencies:\"extra-only\"\n+import {useEffect} from \u0027react\u0027;\n+\n+function Component({x, y, z}) {\n+  // no error: missing dep not reported in extra-only mode\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, []);\n+\n+  // error: extra dep - y\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, [x, y]);\n+\n+  // error: extra dep - y (missing dep - z not reported)\n+  useEffect(() \u003d\u003e {\n+    log(x, z);\n+  }, [x, y]);\n+\n+  // error: extra dep - x.y\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, [x.y]);\n+}\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 3 errors:\n+\n+Error: Found extra effect dependencies\n+\n+Extra dependencies can cause an effect to fire more often than it should, resulting in performance problems such as excessive renders and side effects.\n+\n+error.invalid-exhaustive-effect-deps-extra-only.ts:13:9\n+  11 |   useEffect(() \u003d\u003e {\n+  12 |     log(x);\n+\u003e 13 |   }, [x, y]);\n+     |          ^ Unnecessary dependency `y`\n+  14 |\n+  15 |   // error: extra dep - y (missing dep - z not reported)\n+  16 |   useEffect(() \u003d\u003e {\n+\n+Inferred dependencies: `[x]`\n+\n+Error: Found extra effect dependencies\n+\n+Extra dependencies can cause an effect to fire more often than it should, resulting in performance problems such as excessive renders and side effects.\n+\n+error.invalid-exhaustive-effect-deps-extra-only.ts:18:9\n+  16 |   useEffect(() \u003d\u003e {\n+  17 |     log(x, z);\n+\u003e 18 |   }, [x, y]);\n+     |          ^ Unnecessary dependency `y`\n+  19 |\n+  20 |   // error: extra dep - x.y\n+  21 |   useEffect(() \u003d\u003e {\n+\n+Inferred dependencies: `[x, z]`\n+\n+Error: Found extra effect dependencies\n+\n+Extra dependencies can cause an effect to fire more often than it should, resulting in performance problems such as excessive renders and side effects.\n+\n+error.invalid-exhaustive-effect-deps-extra-only.ts:23:6\n+  21 |   useEffect(() \u003d\u003e {\n+  22 |     log(x);\n+\u003e 23 |   }, [x.y]);\n+     |       ^^^ Overly precise dependency `x.y`, use `x` instead\n+  24 | }\n+  25 |\n+\n+Inferred dependencies: `[x]`\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-extra-only.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-extra-only.js\nnew file mode 100644\nindex 0000000..fcdc4c1\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-extra-only.js\n@@ -0,0 +1,24 @@\n+// @validateExhaustiveEffectDependencies:\"extra-only\"\n+import {useEffect} from \u0027react\u0027;\n+\n+function Component({x, y, z}) {\n+  // no error: missing dep not reported in extra-only mode\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, []);\n+\n+  // error: extra dep - y\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, [x, y]);\n+\n+  // error: extra dep - y (missing dep - z not reported)\n+  useEffect(() \u003d\u003e {\n+    log(x, z);\n+  }, [x, y]);\n+\n+  // error: extra dep - x.y\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, [x.y]);\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-missing-only.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-missing-only.expect.md\nnew file mode 100644\nindex 0000000..5a104f5\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-missing-only.expect.md\n@@ -0,0 +1,84 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveEffectDependencies:\"missing-only\"\n+import {useEffect} from \u0027react\u0027;\n+\n+function Component({x, y, z}) {\n+  // error: missing dep - x\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, []);\n+\n+  // no error: extra dep not reported in missing-only mode\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, [x, y]);\n+\n+  // error: missing dep - z (extra dep - y not reported)\n+  useEffect(() \u003d\u003e {\n+    log(x, z);\n+  }, [x, y]);\n+\n+  // error: missing dep x\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, [x.y]);\n+}\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 3 errors:\n+\n+Error: Found missing effect dependencies\n+\n+Missing dependencies can cause an effect to fire less often than it should.\n+\n+error.invalid-exhaustive-effect-deps-missing-only.ts:7:8\n+   5 |   // error: missing dep - x\n+   6 |   useEffect(() \u003d\u003e {\n+\u003e  7 |     log(x);\n+     |         ^ Missing dependency `x`\n+   8 |   }, []);\n+   9 |\n+  10 |   // no error: extra dep not reported in missing-only mode\n+\n+Inferred dependencies: `[x]`\n+\n+Error: Found missing effect dependencies\n+\n+Missing dependencies can cause an effect to fire less often than it should.\n+\n+error.invalid-exhaustive-effect-deps-missing-only.ts:17:11\n+  15 |   // error: missing dep - z (extra dep - y not reported)\n+  16 |   useEffect(() \u003d\u003e {\n+\u003e 17 |     log(x, z);\n+     |            ^ Missing dependency `z`\n+  18 |   }, [x, y]);\n+  19 |\n+  20 |   // error: missing dep x\n+\n+Inferred dependencies: `[x, z]`\n+\n+Error: Found missing effect dependencies\n+\n+Missing dependencies can cause an effect to fire less often than it should.\n+\n+error.invalid-exhaustive-effect-deps-missing-only.ts:22:8\n+  20 |   // error: missing dep x\n+  21 |   useEffect(() \u003d\u003e {\n+\u003e 22 |     log(x);\n+     |         ^ Missing dependency `x`\n+  23 |   }, [x.y]);\n+  24 | }\n+  25 |\n+\n+Inferred dependencies: `[x]`\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-missing-only.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-missing-only.js\nnew file mode 100644\nindex 0000000..7b333f9\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps-missing-only.js\n@@ -0,0 +1,24 @@\n+// @validateExhaustiveEffectDependencies:\"missing-only\"\n+import {useEffect} from \u0027react\u0027;\n+\n+function Component({x, y, z}) {\n+  // error: missing dep - x\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, []);\n+\n+  // no error: extra dep not reported in missing-only mode\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, [x, y]);\n+\n+  // error: missing dep - z (extra dep - y not reported)\n+  useEffect(() \u003d\u003e {\n+    log(x, z);\n+  }, [x, y]);\n+\n+  // error: missing dep x\n+  useEffect(() \u003d\u003e {\n+    log(x);\n+  }, [x.y]);\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps.expect.md\nindex 78332c7..55dcd92 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps.expect.md\n@@ -2,7 +2,7 @@\n ## Input\n \n ```javascript\n-// @validateExhaustiveEffectDependencies\n+// @validateExhaustiveEffectDependencies:\"all\"\n import {useEffect} from \u0027react\u0027;\n \n function Component({x, y, z}) {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps.js\nindex b508117..e810fd3 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps.js\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-effect-deps.js\n@@ -1,4 +1,4 @@\n-// @validateExhaustiveEffectDependencies\n+// @validateExhaustiveEffectDependencies:\"all\"\n import {useEffect} from \u0027react\u0027;\n \n function Component({x, y, z}) {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.expect.md\nindex 2c449dd..a5b500d 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.expect.md\n@@ -2,7 +2,7 @@\n ## Input\n \n ```javascript\n-// @validateExhaustiveMemoizationDependencies @validateExhaustiveEffectDependencies\n+// @validateExhaustiveMemoizationDependencies @validateExhaustiveEffectDependencies:\"all\"\n import {\n   useCallback,\n   useTransition,\n@@ -69,7 +69,7 @@ export const FIXTURE_ENTRYPOINT \u003d {\n ## Code\n \n ```javascript\n-import { c as _c } from \"react/compiler-runtime\"; // @validateExhaustiveMemoizationDependencies @validateExhaustiveEffectDependencies\n+import { c as _c } from \"react/compiler-runtime\"; // @validateExhaustiveMemoizationDependencies @validateExhaustiveEffectDependencies:\"all\"\n import {\n   useCallback,\n   useTransition,\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.js\nindex 721832e..75ea6ed 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.js\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.js\n@@ -1,4 +1,4 @@\n-// @validateExhaustiveMemoizationDependencies @validateExhaustiveEffectDependencies\n+// @validateExhaustiveMemoizationDependencies @validateExhaustiveEffectDependencies:\"all\"\n import {\n   useCallback,\n   useTransition,\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-effect-events.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-effect-events.expect.md\nindex 3b0e696..a633db2 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-effect-events.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-effect-events.expect.md\n@@ -2,7 +2,7 @@\n ## Input\n \n ```javascript\n-// @validateExhaustiveEffectDependencies\n+// @validateExhaustiveEffectDependencies:\"all\"\n import {useEffect, useEffectEvent} from \u0027react\u0027;\n \n function Component({x, y, z}) {\n@@ -30,7 +30,7 @@ function Component({x, y, z}) {\n ## Code\n \n ```javascript\n-import { c as _c } from \"react/compiler-runtime\"; // @validateExhaustiveEffectDependencies\n+import { c as _c } from \"react/compiler-runtime\"; // @validateExhaustiveEffectDependencies:\"all\"\n import { useEffect, useEffectEvent } from \"react\";\n \n function Component(t0) {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-effect-events.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-effect-events.js\nindex 1c8c710..ef3853b 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-effect-events.js\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-effect-events.js\n@@ -1,4 +1,4 @@\n-// @validateExhaustiveEffectDependencies\n+// @validateExhaustiveEffectDependencies:\"all\"\n import {useEffect, useEffectEvent} from \u0027react\u0027;\n \n function Component({x, y, z}) {\ndiff --git a/fixtures/eslint-v9/index.js b/fixtures/eslint-v9/index.js\nindex 5a43235..601b68a 100644\n--- a/fixtures/eslint-v9/index.js\n+++ b/fixtures/eslint-v9/index.js\n@@ -167,3 +167,16 @@ function InvalidUseMemo({items}) {\n   const sorted \u003d useMemo(() \u003d\u003e [...items].sort(), []);\n   return \u003cdiv\u003e{sorted.length}\u003c/div\u003e;\n }\n+\n+// Invalid: missing/extra deps in useEffect\n+function InvalidEffectDeps({a, b}) {\n+  useEffect(() \u003d\u003e {\n+    console.log(a);\n+    // eslint-disable-next-line react-hooks/exhaustive-deps\n+  }, []);\n+\n+  useEffect(() \u003d\u003e {\n+    console.log(a);\n+    // TODO: eslint-disable-next-line react-hooks/exhaustive-effect-dependencies\n+  }, [a, b]);\n+}\ndiff --git a/fixtures/eslint-v9/yarn.lock b/fixtures/eslint-v9/yarn.lock\nindex 936b533..964edad 100644\n--- a/fixtures/eslint-v9/yarn.lock\n+++ b/fixtures/eslint-v9/yarn.lock\n@@ -603,6 +603,18 @@ has-flag@^4.0.0:\n   resolved \"https://registry.yarnpkg.com/has-flag/-/has-flag-4.0.0.tgz#944771fd9c81c81265c4d6941860da06bb59479b\"\n   integrity sha512-EykJT/Q1KjTWctppgIAgfSO0tKVuZUjhgMr17kqTumMl6Afv3EISleU7qZUzoXDFTAHTDC4NOoG/ZxU3EvlMPQ\u003d\u003d\n \n+hermes-estree@0.25.1:\n+  version \"0.25.1\"\n+  resolved \"https://registry.yarnpkg.com/hermes-estree/-/hermes-estree-0.25.1.tgz#6aeec17d1983b4eabf69721f3aa3eb705b17f480\"\n+  integrity sha512-0wUoCcLp+5Ev5pDW2OriHC2MJCbwLwuRx+gAqMTOkGKJJiBCLjtrvy4PWUGn6MIVefecRpzoOZ/UV6iGdOr+Cw\u003d\u003d\n+\n+hermes-parser@^0.25.1:\n+  version \"0.25.1\"\n+  resolved \"https://registry.yarnpkg.com/hermes-parser/-/hermes-parser-0.25.1.tgz#5be0e487b2090886c62bd8a11724cd766d5f54d1\"\n+  integrity sha512-6pEjquH3rqaI6cYAXYPcz9MS4rY6R4ngRgrgfDshRptUZIc3lw0MCIJIGDj9++mfySOuPTHB4nrSW99BCvOPIA\u003d\u003d\n+  dependencies:\n+    hermes-estree \"0.25.1\"\n+\n ignore@^5.2.0:\n   version \"5.3.2\"\n   resolved \"https://registry.yarnpkg.com/ignore/-/ignore-5.3.2.tgz#3cd40e729f3643fd87cb04e50bf0eb722bc596f5\"\n@@ -877,12 +889,12 @@ yocto-queue@^0.1.0:\n   resolved \"https://registry.yarnpkg.com/yocto-queue/-/yocto-queue-0.1.0.tgz#0294eb3dee05028d31ee1a5fa2c556a6aaf10a1b\"\n   integrity sha512-rVksvsnNCdJ/ohGc6xgPwyN8eheCxsiLM8mxuE/t/mOVqJewPuO1miLpTHQiRgTKCLexL4MeAFVagts7HmNZ2Q\u003d\u003d\n \n-\"zod-validation-error@^3.0.3 || ^4.0.0\":\n+\"zod-validation-error@^3.5.0 || ^4.0.0\":\n   version \"4.0.2\"\n   resolved \"https://registry.yarnpkg.com/zod-validation-error/-/zod-validation-error-4.0.2.tgz#bc605eba49ce0fcd598c127fee1c236be3f22918\"\n   integrity sha512-Q6/nZLe6jxuU80qb/4uJ4t5v2VEZ44lzQjPDhYJNztRQ4wyWc6VF3D3Kb/fAuPetZQnhS3hnajCf9CsWesghLQ\u003d\u003d\n \n-\"zod@^3.22.4 || ^4.0.0\":\n-  version \"4.1.11\"\n-  resolved \"https://registry.yarnpkg.com/zod/-/zod-4.1.11.tgz#4aab62f76cfd45e6c6166519ba31b2ea019f75f5\"\n-  integrity sha512-WPsqwxITS2tzx1bzhIKsEs19ABD5vmCVa4xBo2tq/SrV4RNZtfws1EnCWQXM6yh8bD08a1idvkB5MZSBiZsjwg\u003d\u003d\n+\"zod@^3.25.0 || ^4.0.0\":\n+  version \"4.2.0\"\n+  resolved \"https://registry.yarnpkg.com/zod/-/zod-4.2.0.tgz#01e86f2c2b6d525a1b9fa6dbe78beccad082118f\"\n+  integrity sha512-Bd5fw9wlIhtqCCxotZgdTOMwGm1a0u75wARVEY9HMs1X17trvA/lMi4+MGK5EUfYkXVTbX8UDiDKW4OgzHVUZw\u003d\u003d\ndiff --git a/packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts b/packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts\nindex 1cf08cb..acd50a3 100644\n--- a/packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts\n+++ b/packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts\n@@ -42,6 +42,7 @@ const COMPILER_OPTIONS: PluginOptions \u003d {\n     // Temporarily enabled for internal testing\n     enableUseKeyedState: true,\n     enableVerboseNoSetStateInEffect: true,\n+    validateExhaustiveEffectDependencies: \u0027extra-only\u0027,\n   },\n };\n ","expectedMessage":"Add reporting modes for react-hooks/exhaustive-effect-dependencies and temporarily enable (#35365)","repository":"react","commitHash":"88ee1f595572b1dcf8f45897cb115b4bbd1aefb8","metadata":{"author":"Jack Pope \u003cjackpope1@gmail.com\u003e"}}
{"id":"react-bcf97c75","diff":" packages/react-devtools-core/README.md             |  4 +-\n .../src/contentScripts/hookSettingsInjector.js     |  5 ++\n packages/react-devtools-inline/src/backend.js      |  5 ++\n .../src/__tests__/console-test.js                  | 81 ++++++++++++++++++++++\n .../src/__tests__/setupTests.js                    |  1 +\n .../react-devtools-shared/src/backend/types.js     |  1 +\n .../devtools/views/Settings/DebuggingSettings.js   | 47 ++++++++++++-\n .../src/devtools/views/Settings/SettingsShared.css |  5 ++\n packages/react-devtools-shared/src/hook.js         | 31 ++++++---\n 9 files changed, 165 insertions(+), 15 deletions(-)\n\ndiff --git a/packages/react-devtools-core/README.md b/packages/react-devtools-core/README.md\nindex f3487fe..21f4f69 100644\n--- a/packages/react-devtools-core/README.md\n+++ b/packages/react-devtools-core/README.md\n@@ -32,7 +32,7 @@ if (process.env.NODE_ENV !\u003d\u003d \u0027production\u0027) {\n #### `Settings`\n | Spec                                                                                                                                                                           | Default value                                                                                                                                                        |\n |--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n-| \u003cpre\u003e{\u003cbr\u003e  appendComponentStack: boolean,\u003cbr\u003e  breakOnConsoleErrors: boolean,\u003cbr\u003e  showInlineWarningsAndErrors: boolean,\u003cbr\u003e  hideConsoleLogsInStrictMode: boolean\u003cbr\u003e}\u003c/pre\u003e | \u003cpre\u003e{\u003cbr\u003e  appendComponentStack: true,\u003cbr\u003e  breakOnConsoleErrors: false,\u003cbr\u003e  showInlineWarningsAndErrors: true,\u003cbr\u003e  hideConsoleLogsInStrictMode: false\u003cbr\u003e}\u003c/pre\u003e |\n+| \u003cpre\u003e{\u003cbr\u003e  appendComponentStack: boolean,\u003cbr\u003e  breakOnConsoleErrors: boolean,\u003cbr\u003e  showInlineWarningsAndErrors: boolean,\u003cbr\u003e  hideConsoleLogsInStrictMode: boolean,\u003cbr\u003e  disableSecondConsoleLogDimmingInStrictMode: boolean\u003cbr\u003e}\u003c/pre\u003e | \u003cpre\u003e{\u003cbr\u003e  appendComponentStack: true,\u003cbr\u003e  breakOnConsoleErrors: false,\u003cbr\u003e  showInlineWarningsAndErrors: true,\u003cbr\u003e  hideConsoleLogsInStrictMode: false,\u003cbr\u003e  disableSecondConsoleLogDimmingInStrictMode: false\u003cbr\u003e}\u003c/pre\u003e |\n \n ### `connectToDevTools` options\n | Prop                   | Default       | Description                                                                                                               |\n@@ -53,7 +53,7 @@ if (process.env.NODE_ENV !\u003d\u003d \u0027production\u0027) {\n | `onSubscribe`       | Function, which receives listener (function, with a single argument) as an argument. Called when backend subscribes to messages from the other end (frontend). |\n | `onUnsubscribe`     | Function, which receives listener (function) as an argument. Called when backend unsubscribes to messages from the other end (frontend).                       |\n | `onMessage`         | Function, which receives 2 arguments: event (string) and payload (any). Called when backend emits a message, which should be sent to the frontend.             |\n-| `onSettingsUpdated` | A callback that will be called when the user updates the settings in the UI. You can use it for persisting user settings.                                      |       \n+| `onSettingsUpdated` | A callback that will be called when the user updates the settings in the UI. You can use it for persisting user settings.                                      |\n \n Unlike `connectToDevTools`, `connectWithCustomMessagingProtocol` returns a callback, which can be used for unsubscribing the backend from the global DevTools hook.\n \ndiff --git a/packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js b/packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js\nindex e26108e..da809f6 100644\n--- a/packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js\n+++ b/packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js\n@@ -24,6 +24,11 @@ async function messageListener(event: MessageEvent) {\n       if (typeof settings.hideConsoleLogsInStrictMode !\u003d\u003d \u0027boolean\u0027) {\n         settings.hideConsoleLogsInStrictMode \u003d false;\n       }\n+      if (\n+        typeof settings.disableSecondConsoleLogDimmingInStrictMode !\u003d\u003d \u0027boolean\u0027\n+      ) {\n+        settings.disableSecondConsoleLogDimmingInStrictMode \u003d false;\n+      }\n \n       window.postMessage({\n         source: \u0027react-devtools-hook-settings-injector\u0027,\ndiff --git a/packages/react-devtools-inline/src/backend.js b/packages/react-devtools-inline/src/backend.js\nindex 3549704..849e103 100644\n--- a/packages/react-devtools-inline/src/backend.js\n+++ b/packages/react-devtools-inline/src/backend.js\n@@ -27,6 +27,7 @@ function startActivation(contentWindow: any, bridge: BackendBridge) {\n       componentFilters,\n       showInlineWarningsAndErrors,\n       hideConsoleLogsInStrictMode,\n+      disableSecondConsoleLogDimmingInStrictMode,\n     } \u003d data;\n \n     contentWindow.__REACT_DEVTOOLS_APPEND_COMPONENT_STACK__ \u003d\n@@ -38,6 +39,8 @@ function startActivation(contentWindow: any, bridge: BackendBridge) {\n       showInlineWarningsAndErrors;\n     contentWindow.__REACT_DEVTOOLS_HIDE_CONSOLE_LOGS_IN_STRICT_MODE__ \u003d\n       hideConsoleLogsInStrictMode;\n+    contentWindow.__REACT_DEVTOOLS_DISABLE_SECOND_CONSOLE_LOG_DIMMING_IN_STRICT_MODE__ \u003d\n+      disableSecondConsoleLogDimmingInStrictMode;\n \n     // TRICKY\n     // The backend entry point may be required in the context of an iframe or the parent window.\n@@ -53,6 +56,8 @@ function startActivation(contentWindow: any, bridge: BackendBridge) {\n         showInlineWarningsAndErrors;\n       window.__REACT_DEVTOOLS_HIDE_CONSOLE_LOGS_IN_STRICT_MODE__ \u003d\n         hideConsoleLogsInStrictMode;\n+      window.__REACT_DEVTOOLS_DISABLE_SECOND_CONSOLE_LOG_DIMMING_IN_STRICT_MODE__ \u003d\n+        disableSecondConsoleLogDimmingInStrictMode;\n     }\n \n     finishActivation(contentWindow, bridge);\ndiff --git a/packages/react-devtools-shared/src/__tests__/console-test.js b/packages/react-devtools-shared/src/__tests__/console-test.js\nindex 00d6d97..c37285e 100644\n--- a/packages/react-devtools-shared/src/__tests__/console-test.js\n+++ b/packages/react-devtools-shared/src/__tests__/console-test.js\n@@ -733,4 +733,85 @@ describe(\u0027console\u0027, () \u003d\u003e {\n         : \u0027in Child (at **)\\n    in Intermediate (at **)\\n    in Parent (at **)\u0027,\n     ]);\n   });\n+\n+  it(\u0027should not dim console logs if disableSecondConsoleLogDimmingInStrictMode is enabled\u0027, () \u003d\u003e {\n+    global.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings.appendComponentStack \u003d false;\n+    global.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings.hideConsoleLogsInStrictMode \u003d\n+      false;\n+    global.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings.disableSecondConsoleLogDimmingInStrictMode \u003d\n+      true;\n+\n+    const container \u003d document.createElement(\u0027div\u0027);\n+    const root \u003d ReactDOMClient.createRoot(container);\n+\n+    function App() {\n+      console.log(\u0027log\u0027);\n+      console.warn(\u0027warn\u0027);\n+      console.error(\u0027error\u0027);\n+      return \u003cdiv /\u003e;\n+    }\n+\n+    act(() \u003d\u003e\n+      root.render(\n+        \u003cReact.StrictMode\u003e\n+          \u003cApp /\u003e\n+        \u003c/React.StrictMode\u003e,\n+      ),\n+    );\n+\n+    // Both logs should be called (double logging)\n+    expect(global.consoleLogMock).toHaveBeenCalledTimes(2);\n+    expect(global.consoleWarnMock).toHaveBeenCalledTimes(2);\n+    expect(global.consoleErrorMock).toHaveBeenCalledTimes(2);\n+\n+    // The second log should NOT have dimming (no ANSI codes)\n+    expect(global.consoleLogMock.mock.calls[1]).toEqual([\u0027log\u0027]);\n+    expect(global.consoleWarnMock.mock.calls[1]).toEqual([\u0027warn\u0027]);\n+    expect(global.consoleErrorMock.mock.calls[1]).toEqual([\u0027error\u0027]);\n+  });\n+\n+  it(\u0027should dim console logs if disableSecondConsoleLogDimmingInStrictMode is disabled\u0027, () \u003d\u003e {\n+    global.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings.appendComponentStack \u003d false;\n+    global.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings.hideConsoleLogsInStrictMode \u003d\n+      false;\n+    global.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings.disableSecondConsoleLogDimmingInStrictMode \u003d\n+      false;\n+\n+    const container \u003d document.createElement(\u0027div\u0027);\n+    const root \u003d ReactDOMClient.createRoot(container);\n+\n+    function App() {\n+      console.log(\u0027log\u0027);\n+      console.warn(\u0027warn\u0027);\n+      console.error(\u0027error\u0027);\n+      return \u003cdiv /\u003e;\n+    }\n+\n+    act(() \u003d\u003e\n+      root.render(\n+        \u003cReact.StrictMode\u003e\n+          \u003cApp /\u003e\n+        \u003c/React.StrictMode\u003e,\n+      ),\n+    );\n+\n+    // Both logs should be called (double logging)\n+    expect(global.consoleLogMock).toHaveBeenCalledTimes(2);\n+    expect(global.consoleWarnMock).toHaveBeenCalledTimes(2);\n+    expect(global.consoleErrorMock).toHaveBeenCalledTimes(2);\n+\n+    // The second log should have dimming (ANSI codes present)\n+    expect(global.consoleLogMock.mock.calls[1]).toEqual([\n+      \u0027\\x1b[2;38;2;124;124;124m%s\\x1b[0m\u0027,\n+      \u0027log\u0027,\n+    ]);\n+    expect(global.consoleWarnMock.mock.calls[1]).toEqual([\n+      \u0027\\x1b[2;38;2;124;124;124m%s\\x1b[0m\u0027,\n+      \u0027warn\u0027,\n+    ]);\n+    expect(global.consoleErrorMock.mock.calls[1]).toEqual([\n+      \u0027\\x1b[2;38;2;124;124;124m%s\\x1b[0m\u0027,\n+      \u0027error\u0027,\n+    ]);\n+  });\n });\ndiff --git a/packages/react-devtools-shared/src/__tests__/setupTests.js b/packages/react-devtools-shared/src/__tests__/setupTests.js\nindex aad3fbc..6efcefe 100644\n--- a/packages/react-devtools-shared/src/__tests__/setupTests.js\n+++ b/packages/react-devtools-shared/src/__tests__/setupTests.js\n@@ -248,6 +248,7 @@ beforeEach(() \u003d\u003e {\n     breakOnConsoleErrors: false,\n     showInlineWarningsAndErrors: true,\n     hideConsoleLogsInStrictMode: false,\n+    disableSecondConsoleLogDimmingInStrictMode: false,\n   });\n \n   const bridgeListeners \u003d [];\ndiff --git a/packages/react-devtools-shared/src/backend/types.js b/packages/react-devtools-shared/src/backend/types.js\nindex 67d6a5f..00c6635 100644\n--- a/packages/react-devtools-shared/src/backend/types.js\n+++ b/packages/react-devtools-shared/src/backend/types.js\n@@ -597,4 +597,5 @@ export type DevToolsHookSettings \u003d {\n   breakOnConsoleErrors: boolean,\n   showInlineWarningsAndErrors: boolean,\n   hideConsoleLogsInStrictMode: boolean,\n+  disableSecondConsoleLogDimmingInStrictMode: boolean,\n };\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Settings/DebuggingSettings.js b/packages/react-devtools-shared/src/devtools/views/Settings/DebuggingSettings.js\nindex 5dfce3a..34b08c5 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Settings/DebuggingSettings.js\n+++ b/packages/react-devtools-shared/src/devtools/views/Settings/DebuggingSettings.js\n@@ -36,6 +36,10 @@ export default function DebuggingSettings({\n     useState(usedHookSettings.hideConsoleLogsInStrictMode);\n   const [showInlineWarningsAndErrors, setShowInlineWarningsAndErrors] \u003d\n     useState(usedHookSettings.showInlineWarningsAndErrors);\n+  const [\n+    disableSecondConsoleLogDimmingInStrictMode,\n+    setDisableSecondConsoleLogDimmingInStrictMode,\n+  ] \u003d useState(usedHookSettings.disableSecondConsoleLogDimmingInStrictMode);\n \n   useEffect(() \u003d\u003e {\n     store.setShouldShowWarningsAndErrors(showInlineWarningsAndErrors);\n@@ -47,6 +51,7 @@ export default function DebuggingSettings({\n       breakOnConsoleErrors,\n       showInlineWarningsAndErrors,\n       hideConsoleLogsInStrictMode,\n+      disableSecondConsoleLogDimmingInStrictMode,\n     });\n   }, [\n     store,\n@@ -54,6 +59,7 @@ export default function DebuggingSettings({\n     breakOnConsoleErrors,\n     showInlineWarningsAndErrors,\n     hideConsoleLogsInStrictMode,\n+    disableSecondConsoleLogDimmingInStrictMode,\n   ]);\n \n   return (\n@@ -105,12 +111,49 @@ export default function DebuggingSettings({\n           \u003cinput\n             type\u003d\"checkbox\"\n             checked\u003d{hideConsoleLogsInStrictMode}\n+            onChange\u003d{({currentTarget}) \u003d\u003e {\n+              setHideConsoleLogsInStrictMode(currentTarget.checked);\n+              if (currentTarget.checked) {\n+                setDisableSecondConsoleLogDimmingInStrictMode(false);\n+              }\n+            }}\n+            className\u003d{styles.SettingRowCheckbox}\n+          /\u003e\n+          Hide logs during additional invocations in\u0026nbsp;\n+          \u003ca\n+            className\u003d{styles.StrictModeLink}\n+            target\u003d\"_blank\"\n+            rel\u003d\"noopener noreferrer\"\n+            href\u003d\"https://react.dev/reference/react/StrictMode\"\u003e\n+            Strict Mode\n+          \u003c/a\u003e\n+        \u003c/label\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv\n+        className\u003d{\n+          hideConsoleLogsInStrictMode\n+            ? `${styles.SettingDisabled} ${styles.SettingWrapper}`\n+            : styles.SettingWrapper\n+        }\u003e\n+        \u003clabel\n+          className\u003d{\n+            hideConsoleLogsInStrictMode\n+              ? `${styles.SettingDisabled} ${styles.SettingRow}`\n+              : styles.SettingRow\n+          }\u003e\n+          \u003cinput\n+            type\u003d\"checkbox\"\n+            checked\u003d{disableSecondConsoleLogDimmingInStrictMode}\n+            disabled\u003d{hideConsoleLogsInStrictMode}\n             onChange\u003d{({currentTarget}) \u003d\u003e\n-              setHideConsoleLogsInStrictMode(currentTarget.checked)\n+              setDisableSecondConsoleLogDimmingInStrictMode(\n+                currentTarget.checked,\n+              )\n             }\n             className\u003d{styles.SettingRowCheckbox}\n           /\u003e\n-          Hide logs during additional invocations in\u0026nbsp;\n+          Disable log dimming during additional invocations in\u0026nbsp;\n           \u003ca\n             className\u003d{styles.StrictModeLink}\n             target\u003d\"_blank\"\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Settings/SettingsShared.css b/packages/react-devtools-shared/src/devtools/views/Settings/SettingsShared.css\nindex 41cd23c..71c5332 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Settings/SettingsShared.css\n+++ b/packages/react-devtools-shared/src/devtools/views/Settings/SettingsShared.css\n@@ -26,6 +26,11 @@\n   margin: 0.125rem 0.25rem 0.125rem 0;\n }\n \n+.SettingDisabled {\n+  opacity: 0.5;\n+  cursor: not-allowed;\n+}\n+\n .OptionGroup {\n   display: inline-flex;\n   flex-direction: row;\ndiff --git a/packages/react-devtools-shared/src/hook.js b/packages/react-devtools-shared/src/hook.js\nindex 699d230..97f8230 100644\n--- a/packages/react-devtools-shared/src/hook.js\n+++ b/packages/react-devtools-shared/src/hook.js\n@@ -367,17 +367,22 @@ export function installHook(\n           return;\n         }\n \n-        // Dim the text color of the double logs if we\u0027re not hiding them.\n-        // Firefox doesn\u0027t support ANSI escape sequences\n-        if (__IS_FIREFOX__) {\n-          originalMethod(\n-            ...formatWithStyles(args, FIREFOX_CONSOLE_DIMMING_COLOR),\n-          );\n+        if (settings.disableSecondConsoleLogDimmingInStrictMode) {\n+          // Don\u0027t dim the console logs\n+          originalMethod(...args);\n         } else {\n-          originalMethod(\n-            ANSI_STYLE_DIMMING_TEMPLATE,\n-            ...formatConsoleArguments(...args),\n-          );\n+          // Dim the text color of the double logs if we\u0027re not hiding them.\n+          // Firefox doesn\u0027t support ANSI escape sequences\n+          if (__IS_FIREFOX__) {\n+            originalMethod(\n+              ...formatWithStyles(args, FIREFOX_CONSOLE_DIMMING_COLOR),\n+            );\n+          } else {\n+            originalMethod(\n+              ANSI_STYLE_DIMMING_TEMPLATE,\n+              ...formatConsoleArguments(...args),\n+            );\n+          }\n         }\n       };\n \n@@ -579,7 +584,10 @@ export function installHook(\n           debugger;\n         }\n \n-        if (isRunningDuringStrictModeInvocation) {\n+        if (\n+          isRunningDuringStrictModeInvocation \u0026\u0026\n+          !settings.disableSecondConsoleLogDimmingInStrictMode\n+        ) {\n           // Dim the text color of the double logs if we\u0027re not hiding them.\n           // Firefox doesn\u0027t support ANSI escape sequences\n           if (__IS_FIREFOX__) {\n@@ -667,6 +675,7 @@ export function installHook(\n       breakOnConsoleErrors: false,\n       showInlineWarningsAndErrors: true,\n       hideConsoleLogsInStrictMode: false,\n+      disableSecondConsoleLogDimmingInStrictMode: false,\n     };\n     patchConsoleForErrorsAndWarnings();\n   } else {","expectedMessage":"Devtools disable log dimming strict mode setting (#35207)","repository":"react","commitHash":"bcf97c7564cbe0c903a16a8d6ff52f124f2f06ff","metadata":{"author":"emily8rown \u003cemilybrown02b28@gmail.com\u003e"}}
{"id":"react-ba5b8436","diff":" .eslintrc.js                                       |  1 +\n packages/internal-test-utils/debugInfo.js          |  6 +----\n .../react-client/src/__tests__/ReactFlight-test.js |  5 +---\n .../src/__tests__/ReactFlightDOMEdge-test.js       | 28 +++++++++++++++-------\n scripts/jest/setupTests.js                         |  4 ++++\n 5 files changed, 27 insertions(+), 17 deletions(-)\n\ndiff --git a/.eslintrc.js b/.eslintrc.js\nindex 86ad482..dec7cd8 100644\n--- a/.eslintrc.js\n+++ b/.eslintrc.js\n@@ -635,6 +635,7 @@ module.exports \u003d {\n     FocusOptions: \u0027readonly\u0027,\n     OptionalEffectTiming: \u0027readonly\u0027,\n \n+    __REACT_ROOT_PATH_TEST__: \u0027readonly\u0027,\n     spyOnDev: \u0027readonly\u0027,\n     spyOnDevAndProd: \u0027readonly\u0027,\n     spyOnProd: \u0027readonly\u0027,\ndiff --git a/packages/internal-test-utils/debugInfo.js b/packages/internal-test-utils/debugInfo.js\nindex 75183ce..b749c8d 100644\n--- a/packages/internal-test-utils/debugInfo.js\n+++ b/packages/internal-test-utils/debugInfo.js\n@@ -1,9 +1,5 @@\n \u0027use strict\u0027;\n \n-const path \u003d require(\u0027path\u0027);\n-\n-const repoRoot \u003d path.resolve(__dirname, \u0027../../\u0027);\n-\n type DebugInfoConfig \u003d {\n   ignoreProps?: boolean,\n   ignoreRscStreamInfo?: boolean,\n@@ -34,7 +30,7 @@ function normalizeStack(stack) {\n     const [name, file, line, col, enclosingLine, enclosingCol] \u003d stack[i];\n     copy.push([\n       name,\n-      file.replace(repoRoot, \u0027\u0027),\n+      file.replace(__REACT_ROOT_PATH_TEST__, \u0027\u0027),\n       line,\n       col,\n       enclosingLine,\ndiff --git a/packages/react-client/src/__tests__/ReactFlight-test.js b/packages/react-client/src/__tests__/ReactFlight-test.js\nindex d642a02..b2dcd69 100644\n--- a/packages/react-client/src/__tests__/ReactFlight-test.js\n+++ b/packages/react-client/src/__tests__/ReactFlight-test.js\n@@ -10,8 +10,6 @@\n \n \u0027use strict\u0027;\n \n-const path \u003d require(\u0027path\u0027);\n-\n if (typeof Blob \u003d\u003d\u003d \u0027undefined\u0027) {\n   global.Blob \u003d require(\u0027buffer\u0027).Blob;\n }\n@@ -33,9 +31,8 @@ function normalizeCodeLocInfo(str) {\n   );\n }\n \n-const repoRoot \u003d path.resolve(__dirname, \u0027../../../../\u0027);\n function normalizeReactCodeLocInfo(str) {\n-  const repoRootForRegexp \u003d repoRoot.replace(/\\//g, \u0027\\\\/\u0027);\n+  const repoRootForRegexp \u003d __REACT_ROOT_PATH_TEST__.replace(/\\//g, \u0027\\\\/\u0027);\n   const repoFileLocMatch \u003d new RegExp(`${repoRootForRegexp}.+?:\\\\d+:\\\\d+`, \u0027g\u0027);\n   return str \u0026\u0026 str.replace(repoFileLocMatch, \u0027**\u0027);\n }\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js\nindex a7290f9..995f0da 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js\n@@ -39,6 +39,10 @@ function normalizeCodeLocInfo(str) {\n   );\n }\n \n+function normalizeSerializedContent(str) {\n+  return str.replaceAll(__REACT_ROOT_PATH_TEST__, \u0027**\u0027);\n+}\n+\n describe(\u0027ReactFlightDOMEdge\u0027, () \u003d\u003e {\n   beforeEach(() \u003d\u003e {\n     // Mock performance.now for timing tests\n@@ -481,8 +485,10 @@ describe(\u0027ReactFlightDOMEdge\u0027, () \u003d\u003e {\n     );\n     const [stream1, stream2] \u003d passThrough(stream).tee();\n \n-    const serializedContent \u003d await readResult(stream1);\n-    expect(serializedContent.length).toBeLessThan(1100);\n+    const serializedContent \u003d normalizeSerializedContent(\n+      await readResult(stream1),\n+    );\n+    expect(serializedContent.length).toBeLessThan(1075);\n \n     const result \u003d await ReactServerDOMClient.createFromReadableStream(\n       stream2,\n@@ -551,9 +557,11 @@ describe(\u0027ReactFlightDOMEdge\u0027, () \u003d\u003e {\n     );\n     const [stream1, stream2] \u003d passThrough(stream).tee();\n \n-    const serializedContent \u003d await readResult(stream1);\n+    const serializedContent \u003d normalizeSerializedContent(\n+      await readResult(stream1),\n+    );\n \n-    expect(serializedContent.length).toBeLessThan(490);\n+    expect(serializedContent.length).toBeLessThan(465);\n     expect(timesRendered).toBeLessThan(5);\n \n     const model \u003d await ReactServerDOMClient.createFromReadableStream(stream2, {\n@@ -623,8 +631,10 @@ describe(\u0027ReactFlightDOMEdge\u0027, () \u003d\u003e {\n     );\n     const [stream1, stream2] \u003d passThrough(stream).tee();\n \n-    const serializedContent \u003d await readResult(stream1);\n-    expect(serializedContent.length).toBeLessThan(__DEV__ ? 680 : 400);\n+    const serializedContent \u003d normalizeSerializedContent(\n+      await readResult(stream1),\n+    );\n+    expect(serializedContent.length).toBeLessThan(__DEV__ ? 630 : 400);\n     expect(timesRendered).toBeLessThan(5);\n \n     const model \u003d await serverAct(() \u003d\u003e\n@@ -657,8 +667,10 @@ describe(\u0027ReactFlightDOMEdge\u0027, () \u003d\u003e {\n         \u003cServerComponent recurse\u003d{20} /\u003e,\n       ),\n     );\n-    const serializedContent \u003d await readResult(stream);\n-    const expectedDebugInfoSize \u003d __DEV__ ? 320 * 20 : 0;\n+    const serializedContent \u003d normalizeSerializedContent(\n+      await readResult(stream),\n+    );\n+    const expectedDebugInfoSize \u003d __DEV__ ? 295 * 20 : 0;\n     expect(serializedContent.length).toBeLessThan(150 + expectedDebugInfoSize);\n   });\n \ndiff --git a/scripts/jest/setupTests.js b/scripts/jest/setupTests.js\nindex 758ac5e..c3d3408 100644\n--- a/scripts/jest/setupTests.js\n+++ b/scripts/jest/setupTests.js\n@@ -6,6 +6,7 @@ const {\n   resetAllUnexpectedConsoleCalls,\n   patchConsoleMethods,\n } \u003d require(\u0027internal-test-utils/consoleMock\u0027);\n+const path \u003d require(\u0027path\u0027);\n \n if (process.env.REACT_CLASS_EQUIVALENCE_TEST) {\n   // Inside the class equivalence tester, we have a custom environment, let\u0027s\n@@ -18,6 +19,9 @@ if (process.env.REACT_CLASS_EQUIVALENCE_TEST) {\n   const spyOn \u003d jest.spyOn;\n   const noop \u003d jest.fn;\n \n+  // Can be used to normalize paths in stackframes\n+  global.__REACT_ROOT_PATH_TEST__ \u003d path.resolve(__dirname, \u0027../..\u0027);\n+\n   // Spying on console methods in production builds can mask errors.\n   // This is why we added an explicit spyOnDev() helper.\n   // It\u0027s too easy to accidentally use the more familiar spyOn() helper though,","expectedMessage":"[test] Exclude repository root from assertions (#35361)","repository":"react","commitHash":"ba5b843692519a226347aecfb789d90fcb24b4bc","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-b061b597","diff":" compiler/apps/playground/package.json |  6 +++---\n compiler/apps/playground/yarn.lock    | 34 +++++++++++++++++-----------------\n 2 files changed, 20 insertions(+), 20 deletions(-)\n\ndiff --git a/compiler/apps/playground/package.json b/compiler/apps/playground/package.json\nindex e92826c..217153e 100644\n--- a/compiler/apps/playground/package.json\n+++ b/compiler/apps/playground/package.json\n@@ -35,13 +35,13 @@\n     \"lru-cache\": \"^11.2.2\",\n     \"lz-string\": \"^1.5.0\",\n     \"monaco-editor\": \"^0.52.0\",\n-    \"next\": \"15.5.7\",\n+    \"next\": \"15.5.9\",\n     \"notistack\": \"^3.0.0-alpha.7\",\n     \"prettier\": \"^3.3.3\",\n     \"pretty-format\": \"^29.3.1\",\n     \"re-resizable\": \"^6.9.16\",\n-    \"react\": \"19.2\",\n-    \"react-dom\": \"19.2\"\n+    \"react\": \"19.2.3\",\n+    \"react-dom\": \"19.2.3\"\n   },\n   \"devDependencies\": {\n     \"@types/node\": \"18.11.9\",\ndiff --git a/compiler/apps/playground/yarn.lock b/compiler/apps/playground/yarn.lock\nindex ce4928e..be63ac5 100644\n--- a/compiler/apps/playground/yarn.lock\n+++ b/compiler/apps/playground/yarn.lock\n@@ -715,10 +715,10 @@\n   dependencies:\n     \"@monaco-editor/loader\" \"^1.6.1\"\n \n-\"@next/env@15.5.7\":\n-  version \"15.5.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/env/-/env-15.5.7.tgz#4168db34ae3bc9fd9ad3b951d327f4cfc38d4362\"\n-  integrity sha512-4h6Y2NyEkIEN7Z8YxkA27pq6zTkS09bUSYC0xjd0NpwFxjnIKeZEeH591o5WECSmjpUhLn3H2QLJcDye3Uzcvg\u003d\u003d\n+\"@next/env@15.5.9\":\n+  version \"15.5.9\"\n+  resolved \"https://registry.yarnpkg.com/@next/env/-/env-15.5.9.tgz#53c2c34dc17cd87b61f70c6cc211e303123b2ab8\"\n+  integrity sha512-4GlTZ+EJM7WaW2HEZcyU317tIQDjkQIyENDLxYJfSWlfqguN+dHkZgyQTV/7ykvobU7yEH5gKvreNrH4B6QgIg\u003d\u003d\n \n \"@next/eslint-plugin-next@15.5.2\":\n   version \"15.5.2\"\n@@ -3204,12 +3204,12 @@ natural-compare@^1.4.0:\n   resolved \"https://registry.yarnpkg.com/natural-compare/-/natural-compare-1.4.0.tgz#4abebfeed7541f2c27acfb29bdbbd15c8d5ba4f7\"\n   integrity sha512-OWND8ei3VtNC9h7V60qff3SVobHr996CTwgxubgyQYEpg290h9J0buyECNNJexkFm5sOajh5G116RYA1c8ZMSw\u003d\u003d\n \n-next@15.5.7:\n-  version \"15.5.7\"\n-  resolved \"https://registry.yarnpkg.com/next/-/next-15.5.7.tgz#4507700b2bbcaf2c9fb7a9ad25c0dac2ba4a9a75\"\n-  integrity sha512-+t2/0jIJ48kUpGKkdlhgkv+zPTEOoXyr60qXe68eB/pl3CMJaLeIGjzp5D6Oqt25hCBiBTt8wEeeAzfJvUKnPQ\u003d\u003d\n+next@15.5.9:\n+  version \"15.5.9\"\n+  resolved \"https://registry.yarnpkg.com/next/-/next-15.5.9.tgz#1b80d05865cc27e710fb4dcfc6fd9e726ed12ad4\"\n+  integrity sha512-agNLK89seZEtC5zUHwtut0+tNrc0Xw4FT/Dg+B/VLEo9pAcS9rtTKpek3V6kVcVwsB2YlqMaHdfZL4eLEVYuCg\u003d\u003d\n   dependencies:\n-    \"@next/env\" \"15.5.7\"\n+    \"@next/env\" \"15.5.9\"\n     \"@swc/helpers\" \"0.5.15\"\n     caniuse-lite \"^1.0.30001579\"\n     postcss \"8.4.31\"\n@@ -3582,10 +3582,10 @@ re-resizable@^6.9.16:\n   resolved \"https://registry.yarnpkg.com/re-resizable/-/re-resizable-6.10.0.tgz#d684a096ab438f1a93f59ad3a580a206b0ce31ee\"\n   integrity sha512-hysSK0xmA5nz24HBVztlk4yCqCLCvS32E6ZpWxVKop9x3tqCa4yAj1++facrmkOf62JsJHjmjABdKxXofYioCw\u003d\u003d\n \n-react-dom@19.2:\n-  version \"19.2.0\"\n-  resolved \"https://registry.npmjs.org/react-dom/-/react-dom-19.2.0.tgz#00ed1e959c365e9a9d48f8918377465466ec3af8\"\n-  integrity sha512-UlbRu4cAiGaIewkPyiRGJk0imDN2T3JjieT6spoL2UeSf5od4n5LB/mQ4ejmxhCFT1tYe8IvaFulzynWovsEFQ\u003d\u003d\n+react-dom@19.2.3:\n+  version \"19.2.3\"\n+  resolved \"https://registry.yarnpkg.com/react-dom/-/react-dom-19.2.3.tgz#f0b61d7e5c4a86773889fcc1853af3ed5f215b17\"\n+  integrity sha512-yELu4WmLPw5Mr/lmeEpox5rw3RETacE++JgHqQzd2dg+YbJuat3jH4ingc+WPZhxaoFzdv9y33G+F7Nl5O0GBg\u003d\u003d\n   dependencies:\n     scheduler \"^0.27.0\"\n \n@@ -3599,10 +3599,10 @@ react-is@^18.0.0:\n   resolved \"https://registry.yarnpkg.com/react-is/-/react-is-18.3.1.tgz#e83557dc12eae63a99e003a46388b1dcbb44db7e\"\n   integrity sha512-/LLMVyas0ljjAtoYiPqYiL8VWXzUUdThrmU5+n20DZv+a+ClRoevUzw5JxU+Ieh5/c87ytoTBV9G1FiKfNJdmg\u003d\u003d\n \n-react@19.2:\n-  version \"19.2.0\"\n-  resolved \"https://registry.npmjs.org/react/-/react-19.2.0.tgz#d33dd1721698f4376ae57a54098cb47fc75d93a5\"\n-  integrity sha512-tmbWg6W31tQLeB5cdIBOicJDJRR2KzXsV7uSK9iNfLWQ5bIZfxuPEHp7M8wiHyHnn0DD1i7w3Zmin0FtkrwoCQ\u003d\u003d\n+react@19.2.3:\n+  version \"19.2.3\"\n+  resolved \"https://registry.yarnpkg.com/react/-/react-19.2.3.tgz#d83e5e8e7a258cf6b4fe28640515f99b87cd19b8\"\n+  integrity sha512-Ku/hhYbVjOQnXDZFv2+RibmLFGwFdeeKHFcOTlrt7xplBnya5OGn/hIRDsqDiSUcfORsDC7MPxwork8jBwsIWA\u003d\u003d\n \n read-cache@^1.0.0:\n   version \"1.0.0\"","expectedMessage":"Upgrade nextjs for compiler playground (#35353)","repository":"react","commitHash":"b061b597f77c979531a3f2c9c04ba435342b0043","metadata":{"author":"Jack Pope \u003cjackpope1@gmail.com\u003e"}}
{"id":"react-b45bb335","diff":" packages/react-server/src/ReactFlightReplyServer.js | 4 +++-\n 1 file changed, 3 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/react-server/src/ReactFlightReplyServer.js b/packages/react-server/src/ReactFlightReplyServer.js\nindex 1831a35..4d5a6da 100644\n--- a/packages/react-server/src/ReactFlightReplyServer.js\n+++ b/packages/react-server/src/ReactFlightReplyServer.js\n@@ -132,8 +132,10 @@ ReactPromise.prototype.then \u003d function \u003cT\u003e(\n         let inspectedValue \u003d chunk.value;\n         // Recursively check if the value is itself a ReactPromise and if so if it points\n         // back to itself. This helps catch recursive thenables early error.\n+        let cycleProtection \u003d 0;\n         while (inspectedValue instanceof ReactPromise) {\n-          if (inspectedValue \u003d\u003d\u003d chunk) {\n+          cycleProtection++;\n+          if (inspectedValue \u003d\u003d\u003d chunk || cycleProtection \u003e 1000) {\n             if (typeof reject \u003d\u003d\u003d \u0027function\u0027) {\n               reject(new Error(\u0027Cannot have cyclic thenables.\u0027));\n             }","expectedMessage":"[Flight] Add extra loop protection (#35351)","repository":"react","commitHash":"b45bb335db5b3632329d6b41e5a790ff6f1a7ff7","metadata":{"author":"Sebastian Markbåge \u003csebastian@calyptus.eu\u003e"}}
{"id":"react-894bc73c","diff":" packages/react-client/src/ReactFlightClient.js     | 271 +++++++++++----------\n .../react-client/src/ReactFlightReplyClient.js     |  30 ++-\n .../src/ReactFlightESMReferences.js                |   8 +\n .../src/ReactFlightParcelReferences.js             |   8 +\n .../src/ReactFlightTurbopackReferences.js          |   8 +\n .../src/ReactFlightUnbundledReferences.js          |   8 +\n .../src/ReactFlightWebpackReferences.js            |   8 +\n .../src/__tests__/ReactFlightDOM-test.js           |  19 +-\n .../src/__tests__/ReactFlightDOMEdge-test.js       |  32 ++-\n .../src/__tests__/ReactFlightDOMNode-test.js       |  50 ++--\n .../src/__tests__/ReactFlightDOMReplyEdge-test.js  |  49 +++-\n .../react-server/src/ReactFlightReplyServer.js     | 182 +++++++-------\n packages/react-server/src/ReactFlightServer.js     |   2 +-\n scripts/error-codes/codes.json                     |   6 +-\n 14 files changed, 441 insertions(+), 240 deletions(-)\n\ndiff --git a/packages/react-client/src/ReactFlightClient.js b/packages/react-client/src/ReactFlightClient.js\nindex 49da30c..0db63ec 100644\n--- a/packages/react-client/src/ReactFlightClient.js\n+++ b/packages/react-client/src/ReactFlightClient.js\n@@ -894,6 +894,7 @@ function resolveModuleChunk\u003cT\u003e(\n   const resolvedChunk: ResolvedModuleChunk\u003cT\u003e \u003d (chunk: any);\n   resolvedChunk.status \u003d RESOLVED_MODULE;\n   resolvedChunk.value \u003d value;\n+  resolvedChunk.reason \u003d null;\n   if (__DEV__) {\n     const debugInfo \u003d getModuleDebugInfo(value);\n     if (debugInfo !\u003d\u003d null) {\n@@ -1114,6 +1115,8 @@ export function reportGlobalError(\n     // because we won\u0027t be getting any new data to resolve it.\n     if (chunk.status \u003d\u003d\u003d PENDING) {\n       triggerErrorOnChunk(response, chunk, error);\n+    } else if (chunk.status \u003d\u003d\u003d INITIALIZED \u0026\u0026 chunk.reason !\u003d\u003d null) {\n+      chunk.reason.error(error);\n     }\n   });\n   if (__DEV__) {\n@@ -1462,15 +1465,95 @@ function fulfillReference(\n ): void {\n   const {handler, parentObject, key, map, path} \u003d reference;\n \n-  for (let i \u003d 1; i \u003c path.length; i++) {\n+  try {\n+    for (let i \u003d 1; i \u003c path.length; i++) {\n+      while (\n+        typeof value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026\n+        value !\u003d\u003d null \u0026\u0026\n+        value.$$typeof \u003d\u003d\u003d REACT_LAZY_TYPE\n+      ) {\n+        // We never expect to see a Lazy node on this path because we encode those as\n+        // separate models. This must mean that we have inserted an extra lazy node\n+        // e.g. to replace a blocked element. We must instead look for it inside.\n+        const referencedChunk: SomeChunk\u003cany\u003e \u003d value._payload;\n+        if (referencedChunk \u003d\u003d\u003d handler.chunk) {\n+          // This is a reference to the thing we\u0027re currently blocking. We can peak\n+          // inside of it to get the value.\n+          value \u003d handler.value;\n+          continue;\n+        } else {\n+          switch (referencedChunk.status) {\n+            case RESOLVED_MODEL:\n+              initializeModelChunk(referencedChunk);\n+              break;\n+            case RESOLVED_MODULE:\n+              initializeModuleChunk(referencedChunk);\n+              break;\n+          }\n+          switch (referencedChunk.status) {\n+            case INITIALIZED: {\n+              value \u003d referencedChunk.value;\n+              continue;\n+            }\n+            case BLOCKED: {\n+              // It is possible that we\u0027re blocked on our own chunk if it\u0027s a cycle.\n+              // Before adding the listener to the inner chunk, let\u0027s check if it would\n+              // result in a cycle.\n+              const cyclicHandler \u003d resolveBlockedCycle(\n+                referencedChunk,\n+                reference,\n+              );\n+              if (cyclicHandler !\u003d\u003d null) {\n+                // This reference points back to this chunk. We can resolve the cycle by\n+                // using the value from that handler.\n+                value \u003d cyclicHandler.value;\n+                continue;\n+              }\n+              // Fallthrough\n+            }\n+            case PENDING: {\n+              // If we\u0027re not yet initialized we need to skip what we\u0027ve already drilled\n+              // through and then wait for the next value to become available.\n+              path.splice(0, i - 1);\n+              // Add \"listener\" to our new chunk dependency.\n+              if (referencedChunk.value \u003d\u003d\u003d null) {\n+                referencedChunk.value \u003d [reference];\n+              } else {\n+                referencedChunk.value.push(reference);\n+              }\n+              if (referencedChunk.reason \u003d\u003d\u003d null) {\n+                referencedChunk.reason \u003d [reference];\n+              } else {\n+                referencedChunk.reason.push(reference);\n+              }\n+              return;\n+            }\n+            case HALTED: {\n+              // Do nothing. We couldn\u0027t fulfill.\n+              // TODO: Mark downstreams as halted too.\n+              return;\n+            }\n+            default: {\n+              rejectReference(\n+                response,\n+                reference.handler,\n+                referencedChunk.reason,\n+              );\n+              return;\n+            }\n+          }\n+        }\n+      }\n+      value \u003d value[path[i]];\n+    }\n+\n     while (\n       typeof value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026\n       value !\u003d\u003d null \u0026\u0026\n       value.$$typeof \u003d\u003d\u003d REACT_LAZY_TYPE\n     ) {\n-      // We never expect to see a Lazy node on this path because we encode those as\n-      // separate models. This must mean that we have inserted an extra lazy node\n-      // e.g. to replace a blocked element. We must instead look for it inside.\n+      // If what we\u0027re referencing is a Lazy it must be because we inserted one as a virtual node\n+      // while it was blocked by other data. If it\u0027s no longer blocked, we can unwrap it.\n       const referencedChunk: SomeChunk\u003cany\u003e \u003d value._payload;\n       if (referencedChunk \u003d\u003d\u003d handler.chunk) {\n         // This is a reference to the thing we\u0027re currently blocking. We can peak\n@@ -1491,132 +1574,57 @@ function fulfillReference(\n             value \u003d referencedChunk.value;\n             continue;\n           }\n-          case BLOCKED: {\n-            // It is possible that we\u0027re blocked on our own chunk if it\u0027s a cycle.\n-            // Before adding the listener to the inner chunk, let\u0027s check if it would\n-            // result in a cycle.\n-            const cyclicHandler \u003d resolveBlockedCycle(\n-              referencedChunk,\n-              reference,\n-            );\n-            if (cyclicHandler !\u003d\u003d null) {\n-              // This reference points back to this chunk. We can resolve the cycle by\n-              // using the value from that handler.\n-              value \u003d cyclicHandler.value;\n-              continue;\n-            }\n-            // Fallthrough\n-          }\n-          case PENDING: {\n-            // If we\u0027re not yet initialized we need to skip what we\u0027ve already drilled\n-            // through and then wait for the next value to become available.\n-            path.splice(0, i - 1);\n-            // Add \"listener\" to our new chunk dependency.\n-            if (referencedChunk.value \u003d\u003d\u003d null) {\n-              referencedChunk.value \u003d [reference];\n-            } else {\n-              referencedChunk.value.push(reference);\n-            }\n-            if (referencedChunk.reason \u003d\u003d\u003d null) {\n-              referencedChunk.reason \u003d [reference];\n-            } else {\n-              referencedChunk.reason.push(reference);\n-            }\n-            return;\n-          }\n-          case HALTED: {\n-            // Do nothing. We couldn\u0027t fulfill.\n-            // TODO: Mark downstreams as halted too.\n-            return;\n-          }\n-          default: {\n-            rejectReference(\n-              response,\n-              reference.handler,\n-              referencedChunk.reason,\n-            );\n-            return;\n-          }\n         }\n       }\n+      break;\n     }\n-    value \u003d value[path[i]];\n-  }\n \n-  while (\n-    typeof value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026\n-    value !\u003d\u003d null \u0026\u0026\n-    value.$$typeof \u003d\u003d\u003d REACT_LAZY_TYPE\n-  ) {\n-    // If what we\u0027re referencing is a Lazy it must be because we inserted one as a virtual node\n-    // while it was blocked by other data. If it\u0027s no longer blocked, we can unwrap it.\n-    const referencedChunk: SomeChunk\u003cany\u003e \u003d value._payload;\n-    if (referencedChunk \u003d\u003d\u003d handler.chunk) {\n-      // This is a reference to the thing we\u0027re currently blocking. We can peak\n-      // inside of it to get the value.\n-      value \u003d handler.value;\n-      continue;\n-    } else {\n-      switch (referencedChunk.status) {\n-        case RESOLVED_MODEL:\n-          initializeModelChunk(referencedChunk);\n+    const mappedValue \u003d map(response, value, parentObject, key);\n+    parentObject[key] \u003d mappedValue;\n+\n+    // If this is the root object for a model reference, where `handler.value`\n+    // is a stale `null`, the resolved value can be used directly.\n+    if (key \u003d\u003d\u003d \u0027\u0027 \u0026\u0026 handler.value \u003d\u003d\u003d null) {\n+      handler.value \u003d mappedValue;\n+    }\n+\n+    // If the parent object is an unparsed React element tuple, we also need to\n+    // update the props and owner of the parsed element object (i.e.\n+    // handler.value).\n+    if (\n+      parentObject[0] \u003d\u003d\u003d REACT_ELEMENT_TYPE \u0026\u0026\n+      typeof handler.value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026\n+      handler.value !\u003d\u003d null \u0026\u0026\n+      handler.value.$$typeof \u003d\u003d\u003d REACT_ELEMENT_TYPE\n+    ) {\n+      const element: any \u003d handler.value;\n+      switch (key) {\n+        case \u00273\u0027:\n+          transferReferencedDebugInfo(handler.chunk, fulfilledChunk);\n+          element.props \u003d mappedValue;\n+          break;\n+        case \u00274\u0027:\n+          // This path doesn\u0027t call transferReferencedDebugInfo because this reference is to a debug chunk.\n+          if (__DEV__) {\n+            element._owner \u003d mappedValue;\n+          }\n           break;\n-        case RESOLVED_MODULE:\n-          initializeModuleChunk(referencedChunk);\n+        case \u00275\u0027:\n+          // This path doesn\u0027t call transferReferencedDebugInfo because this reference is to a debug chunk.\n+          if (__DEV__) {\n+            element._debugStack \u003d mappedValue;\n+          }\n+          break;\n+        default:\n+          transferReferencedDebugInfo(handler.chunk, fulfilledChunk);\n           break;\n       }\n-      switch (referencedChunk.status) {\n-        case INITIALIZED: {\n-          value \u003d referencedChunk.value;\n-          continue;\n-        }\n-      }\n-    }\n-    break;\n-  }\n-\n-  const mappedValue \u003d map(response, value, parentObject, key);\n-  parentObject[key] \u003d mappedValue;\n-\n-  // If this is the root object for a model reference, where `handler.value`\n-  // is a stale `null`, the resolved value can be used directly.\n-  if (key \u003d\u003d\u003d \u0027\u0027 \u0026\u0026 handler.value \u003d\u003d\u003d null) {\n-    handler.value \u003d mappedValue;\n-  }\n-\n-  // If the parent object is an unparsed React element tuple, we also need to\n-  // update the props and owner of the parsed element object (i.e.\n-  // handler.value).\n-  if (\n-    parentObject[0] \u003d\u003d\u003d REACT_ELEMENT_TYPE \u0026\u0026\n-    typeof handler.value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026\n-    handler.value !\u003d\u003d null \u0026\u0026\n-    handler.value.$$typeof \u003d\u003d\u003d REACT_ELEMENT_TYPE\n-  ) {\n-    const element: any \u003d handler.value;\n-    switch (key) {\n-      case \u00273\u0027:\n-        transferReferencedDebugInfo(handler.chunk, fulfilledChunk);\n-        element.props \u003d mappedValue;\n-        break;\n-      case \u00274\u0027:\n-        // This path doesn\u0027t call transferReferencedDebugInfo because this reference is to a debug chunk.\n-        if (__DEV__) {\n-          element._owner \u003d mappedValue;\n-        }\n-        break;\n-      case \u00275\u0027:\n-        // This path doesn\u0027t call transferReferencedDebugInfo because this reference is to a debug chunk.\n-        if (__DEV__) {\n-          element._debugStack \u003d mappedValue;\n-        }\n-        break;\n-      default:\n-        transferReferencedDebugInfo(handler.chunk, fulfilledChunk);\n-        break;\n+    } else if (__DEV__ \u0026\u0026 !reference.isDebug) {\n+      transferReferencedDebugInfo(handler.chunk, fulfilledChunk);\n     }\n-  } else if (__DEV__ \u0026\u0026 !reference.isDebug) {\n-    transferReferencedDebugInfo(handler.chunk, fulfilledChunk);\n+  } catch (error) {\n+    rejectReference(response, reference.handler, error);\n+    return;\n   }\n \n   handler.deps--;\n@@ -1882,6 +1890,7 @@ function loadServerReference\u003cA: Iterable\u003cany\u003e, T\u003e(\n       const initializedChunk: InitializedChunk\u003cT\u003e \u003d (chunk: any);\n       initializedChunk.status \u003d INITIALIZED;\n       initializedChunk.value \u003d handler.value;\n+      initializedChunk.reason \u003d null;\n       if (resolveListeners !\u003d\u003d null) {\n         wakeChunk(response, resolveListeners, handler.value, initializedChunk);\n       } else {\n@@ -2359,7 +2368,7 @@ function parseModelString(\n         // Symbol\n         return Symbol.for(value.slice(2));\n       }\n-      case \u0027F\u0027: {\n+      case \u0027h\u0027: {\n         // Server Reference\n         const ref \u003d value.slice(2);\n         return getOutlinedModel(\n@@ -3138,6 +3147,7 @@ function startReadableStream\u003cT\u003e(\n   streamState: StreamState,\n ): void {\n   let controller: ReadableStreamController \u003d (null: any);\n+  let closed \u003d false;\n   const stream \u003d new ReadableStream({\n     type: type,\n     start(c) {\n@@ -3195,6 +3205,10 @@ function startReadableStream\u003cT\u003e(\n       }\n     },\n     close(json: UninitializedModel): void {\n+      if (closed) {\n+        return;\n+      }\n+      closed \u003d true;\n       if (previousBlockedChunk \u003d\u003d\u003d null) {\n         controller.close();\n       } else {\n@@ -3205,6 +3219,10 @@ function startReadableStream\u003cT\u003e(\n       }\n     },\n     error(error: mixed): void {\n+      if (closed) {\n+        return;\n+      }\n+      closed \u003d true;\n       if (previousBlockedChunk \u003d\u003d\u003d null) {\n         // $FlowFixMe[incompatible-call]\n         controller.error(error);\n@@ -3265,6 +3283,7 @@ function startAsyncIterable\u003cT\u003e(\n           (chunk: any);\n         initializedChunk.status \u003d INITIALIZED;\n         initializedChunk.value \u003d {done: false, value: value};\n+        initializedChunk.reason \u003d null;\n         if (resolveListeners !\u003d\u003d null) {\n           wakeChunkIfInitialized(\n             response,\n@@ -3294,6 +3313,9 @@ function startAsyncIterable\u003cT\u003e(\n       nextWriteIndex++;\n     },\n     close(value: UninitializedModel): void {\n+      if (closed) {\n+        return;\n+      }\n       closed \u003d true;\n       if (nextWriteIndex \u003d\u003d\u003d buffer.length) {\n         buffer[nextWriteIndex] \u003d createResolvedIteratorResultChunk(\n@@ -3321,6 +3343,9 @@ function startAsyncIterable\u003cT\u003e(\n       }\n     },\n     error(error: Error): void {\n+      if (closed) {\n+        return;\n+      }\n       closed \u003d true;\n       if (nextWriteIndex \u003d\u003d\u003d buffer.length) {\n         buffer[nextWriteIndex] \u003d\ndiff --git a/packages/react-client/src/ReactFlightReplyClient.js b/packages/react-client/src/ReactFlightReplyClient.js\nindex f75f54f..4dc13ce 100644\n--- a/packages/react-client/src/ReactFlightReplyClient.js\n+++ b/packages/react-client/src/ReactFlightReplyClient.js\n@@ -104,7 +104,7 @@ function serializePromiseID(id: number): string {\n }\n \n function serializeServerReferenceID(id: number): string {\n-  return \u0027$F\u0027 + id.toString(16);\n+  return \u0027$h\u0027 + id.toString(16);\n }\n \n function serializeTemporaryReferenceMarker(): string {\n@@ -112,7 +112,6 @@ function serializeTemporaryReferenceMarker(): string {\n }\n \n function serializeFormDataReference(id: number): string {\n-  // Why K? F is \"Function\". D is \"Date\". What else?\n   return \u0027$K\u0027 + id.toString(16);\n }\n \n@@ -474,8 +473,22 @@ export function processReply(\n         }\n       }\n \n+      const existingReference \u003d writtenObjects.get(value);\n+\n       // $FlowFixMe[method-unbinding]\n       if (typeof value.then \u003d\u003d\u003d \u0027function\u0027) {\n+        if (existingReference !\u003d\u003d undefined) {\n+          if (modelRoot \u003d\u003d\u003d value) {\n+            // This is the ID we\u0027re currently emitting so we need to write it\n+            // once but if we discover it again, we refer to it by id.\n+            modelRoot \u003d null;\n+          } else {\n+            // We\u0027ve already emitted this as an outlined object, so we can\n+            // just refer to that by its existing ID.\n+            return existingReference;\n+          }\n+        }\n+\n         // We assume that any object with a .then property is a \"Thenable\" type,\n         // or a Promise type. Either of which can be represented by a Promise.\n         if (formData \u003d\u003d\u003d null) {\n@@ -484,11 +497,19 @@ export function processReply(\n         }\n         pendingParts++;\n         const promiseId \u003d nextPartId++;\n+        const promiseReference \u003d serializePromiseID(promiseId);\n+        writtenObjects.set(value, promiseReference);\n         const thenable: Thenable\u003cany\u003e \u003d (value: any);\n         thenable.then(\n           partValue \u003d\u003e {\n             try {\n-              const partJSON \u003d serializeModel(partValue, promiseId);\n+              const previousReference \u003d writtenObjects.get(partValue);\n+              let partJSON;\n+              if (previousReference !\u003d\u003d undefined) {\n+                partJSON \u003d JSON.stringify(previousReference);\n+              } else {\n+                partJSON \u003d serializeModel(partValue, promiseId);\n+              }\n               // $FlowFixMe[incompatible-type] We know it\u0027s not null because we assigned it above.\n               const data: FormData \u003d formData;\n               data.append(formFieldPrefix + promiseId, partJSON);\n@@ -504,10 +525,9 @@ export function processReply(\n           // that throws on the server instead.\n           reject,\n         );\n-        return serializePromiseID(promiseId);\n+        return promiseReference;\n       }\n \n-      const existingReference \u003d writtenObjects.get(value);\n       if (existingReference !\u003d\u003d undefined) {\n         if (modelRoot \u003d\u003d\u003d value) {\n           // This is the ID we\u0027re currently emitting so we need to write it\ndiff --git a/packages/react-server-dom-esm/src/ReactFlightESMReferences.js b/packages/react-server-dom-esm/src/ReactFlightESMReferences.js\nindex 6c2737e..8ad9f22 100644\n--- a/packages/react-server-dom-esm/src/ReactFlightESMReferences.js\n+++ b/packages/react-server-dom-esm/src/ReactFlightESMReferences.js\n@@ -88,6 +88,12 @@ function bind(this: ServerReference\u003cany\u003e): any {\n   return newFn;\n }\n \n+const serverReferenceToString \u003d {\n+  value: () \u003d\u003e \u0027function () { [omitted code] }\u0027,\n+  configurable: true,\n+  writable: true,\n+};\n+\n export function registerServerReference\u003cT: Function\u003e(\n   reference: T,\n   id: string,\n@@ -111,12 +117,14 @@ export function registerServerReference\u003cT: Function\u003e(\n             configurable: true,\n           },\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         }\n       : {\n           $$typeof,\n           $$id,\n           $$bound,\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         }) as PropertyDescriptorMap,\n   );\n }\ndiff --git a/packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js b/packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js\nindex 3e7b603..3dd67e7 100644\n--- a/packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js\n+++ b/packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js\n@@ -95,6 +95,12 @@ function bind(this: ServerReference\u003cany\u003e): any {\n   return newFn;\n }\n \n+const serverReferenceToString \u003d {\n+  value: () \u003d\u003e \u0027function () { [omitted code] }\u0027,\n+  configurable: true,\n+  writable: true,\n+};\n+\n export function registerServerReference\u003cT\u003e(\n   reference: ServerReference\u003cT\u003e,\n   id: string,\n@@ -118,12 +124,14 @@ export function registerServerReference\u003cT\u003e(\n             configurable: true,\n           },\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         }\n       : {\n           $$typeof,\n           $$id,\n           $$bound,\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         }) as PropertyDescriptorMap,\n   );\n }\ndiff --git a/packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js b/packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js\nindex 1b4525a..082a9c0 100644\n--- a/packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js\n+++ b/packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js\n@@ -102,6 +102,12 @@ function bind(this: ServerReference\u003cany\u003e): any {\n   return newFn;\n }\n \n+const serverReferenceToString \u003d {\n+  value: () \u003d\u003e \u0027function () { [omitted code] }\u0027,\n+  configurable: true,\n+  writable: true,\n+};\n+\n export function registerServerReference\u003cT: Function\u003e(\n   reference: T,\n   id: string,\n@@ -125,12 +131,14 @@ export function registerServerReference\u003cT: Function\u003e(\n             configurable: true,\n           },\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         }\n       : {\n           $$typeof,\n           $$id,\n           $$bound,\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         }) as PropertyDescriptorMap,\n   );\n }\ndiff --git a/packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js b/packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js\nindex de43741..07646e1 100644\n--- a/packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js\n+++ b/packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js\n@@ -102,6 +102,12 @@ function bind(this: ServerReference\u003cany\u003e): any {\n   return newFn;\n }\n \n+const serverReferenceToString \u003d {\n+  value: () \u003d\u003e \u0027function () { [omitted code] }\u0027,\n+  configurable: true,\n+  writable: true,\n+};\n+\n export function registerServerReference\u003cT: Function\u003e(\n   reference: T,\n   id: string,\n@@ -125,12 +131,14 @@ export function registerServerReference\u003cT: Function\u003e(\n             configurable: true,\n           },\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         } as PropertyDescriptorMap)\n       : ({\n           $$typeof,\n           $$id,\n           $$bound,\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         } as PropertyDescriptorMap),\n   );\n }\ndiff --git a/packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js b/packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js\nindex de43741..07646e1 100644\n--- a/packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js\n+++ b/packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js\n@@ -102,6 +102,12 @@ function bind(this: ServerReference\u003cany\u003e): any {\n   return newFn;\n }\n \n+const serverReferenceToString \u003d {\n+  value: () \u003d\u003e \u0027function () { [omitted code] }\u0027,\n+  configurable: true,\n+  writable: true,\n+};\n+\n export function registerServerReference\u003cT: Function\u003e(\n   reference: T,\n   id: string,\n@@ -125,12 +131,14 @@ export function registerServerReference\u003cT: Function\u003e(\n             configurable: true,\n           },\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         } as PropertyDescriptorMap)\n       : ({\n           $$typeof,\n           $$id,\n           $$bound,\n           bind: {value: bind, configurable: true},\n+          toString: serverReferenceToString,\n         } as PropertyDescriptorMap),\n   );\n }\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js\nindex f1a8e41..6aa3758 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js\n@@ -156,6 +156,23 @@ describe(\u0027ReactFlightDOM\u0027, () \u003d\u003e {\n     };\n   }\n \n+  function createUnclosingStream(\n+    stream: ReadableStream\u003cUint8Array\u003e,\n+  ): ReadableStream\u003cUint8Array\u003e {\n+    const reader \u003d stream.getReader();\n+\n+    const s \u003d new ReadableStream({\n+      async pull(controller) {\n+        const {done, value} \u003d await reader.read();\n+        if (!done) {\n+          controller.enqueue(value);\n+        }\n+      },\n+    });\n+\n+    return s;\n+  }\n+\n   const theInfinitePromise \u003d new Promise(() \u003d\u003e {});\n   function InfiniteSuspend() {\n     throw theInfinitePromise;\n@@ -2970,7 +2987,7 @@ describe(\u0027ReactFlightDOM\u0027, () \u003d\u003e {\n     const {prelude} \u003d await pendingResult;\n \n     const result \u003d await ReactServerDOMClient.createFromReadableStream(\n-      Readable.toWeb(prelude),\n+      createUnclosingStream(Readable.toWeb(prelude)),\n     );\n \n     const iterator \u003d result.multiShotIterable[Symbol.asyncIterator]();\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js\nindex 5f7dfa5..a7290f9 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js\n@@ -228,7 +228,7 @@ describe(\u0027ReactFlightDOMEdge\u0027, () \u003d\u003e {\n \n   async function createBufferedUnclosingStream(\n     stream: ReadableStream\u003cUint8Array\u003e,\n-  ): ReadableStream\u003cUint8Array\u003e {\n+  ): Promise\u003cReadableStream\u003cUint8Array\u003e\u003e {\n     const chunks: Array\u003cUint8Array\u003e \u003d [];\n     const reader \u003d stream.getReader();\n     while (true) {\n@@ -2309,4 +2309,34 @@ describe(\u0027ReactFlightDOMEdge\u0027, () \u003d\u003e {\n     const result \u003d await response;\n     expect(result).toEqual({obj: obj, node: \u0027hi\u0027});\n   });\n+\n+  it(\u0027does not leak the server reference code\u0027, async () \u003d\u003e {\n+    function foo() {\n+      return \u0027foo\u0027;\n+    }\n+\n+    const bar \u003d () \u003d\u003e {\n+      return \u0027bar\u0027;\n+    };\n+\n+    const anonymous \u003d (\n+      () \u003d\u003e () \u003d\u003e\n+        \u0027anonymous\u0027\n+    )();\n+\n+    expect(\n+      ReactServerDOMServer.registerServerReference(foo, \u0027foo-id\u0027).toString(),\n+    ).toBe(\u0027function () { [omitted code] }\u0027);\n+\n+    expect(\n+      ReactServerDOMServer.registerServerReference(bar, \u0027bar-id\u0027).toString(),\n+    ).toBe(\u0027function () { [omitted code] }\u0027);\n+\n+    expect(\n+      ReactServerDOMServer.registerServerReference(\n+        anonymous,\n+        \u0027anonymous-id\u0027,\n+      ).toString(),\n+    ).toBe(\u0027function () { [omitted code] }\u0027);\n+  });\n });\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js\nindex 805d204..bca803c 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js\n@@ -140,7 +140,7 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n \n   async function createBufferedUnclosingStream(\n     stream: ReadableStream\u003cUint8Array\u003e,\n-  ): ReadableStream\u003cUint8Array\u003e {\n+  ): Promise\u003cReadableStream\u003cUint8Array\u003e\u003e {\n     const chunks: Array\u003cUint8Array\u003e \u003d [];\n     const reader \u003d stream.getReader();\n     while (true) {\n@@ -407,7 +407,7 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n     );\n   });\n \n-  it(\u0027should cancels the underlying ReadableStream when we are cancelled\u0027, async () \u003d\u003e {\n+  it(\u0027should cancel the underlying and transported ReadableStreams when we are cancelled\u0027, async () \u003d\u003e {\n     let controller;\n     let cancelReason;\n     const s \u003d new ReadableStream({\n@@ -431,16 +431,30 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n       ),\n     );\n \n-    const writable \u003d new Stream.PassThrough(streamOptions);\n-    rscStream.pipe(writable);\n+    const readable \u003d new Stream.PassThrough(streamOptions);\n+    rscStream.pipe(readable);\n+\n+    const result \u003d await ReactServerDOMClient.createFromNodeStream(readable, {\n+      moduleMap: {},\n+      moduleLoading: webpackModuleLoading,\n+    });\n+    const reader \u003d result.getReader();\n \n     controller.enqueue(\u0027hi\u0027);\n \n+    await serverAct(async () \u003d\u003e {\n+      // We should be able to read the part we already emitted before the abort\n+      expect(await reader.read()).toEqual({\n+        value: \u0027hi\u0027,\n+        done: false,\n+      });\n+    });\n+\n     const reason \u003d new Error(\u0027aborted\u0027);\n-    writable.destroy(reason);\n+    readable.destroy(reason);\n \n     await new Promise(resolve \u003d\u003e {\n-      writable.on(\u0027error\u0027, () \u003d\u003e {\n+      readable.on(\u0027error\u0027, () \u003d\u003e {\n         resolve();\n       });\n     });\n@@ -448,9 +462,17 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n     expect(cancelReason.message).toBe(\n       \u0027The destination stream errored while writing data.\u0027,\n     );\n+\n+    let error \u003d null;\n+    try {\n+      await reader.read();\n+    } catch (x) {\n+      error \u003d x;\n+    }\n+    expect(error).toBe(reason);\n   });\n \n-  it(\u0027should cancels the underlying ReadableStream when we abort\u0027, async () \u003d\u003e {\n+  it(\u0027should cancel the underlying and transported ReadableStreams when we abort\u0027, async () \u003d\u003e {\n     const errors \u003d [];\n     let controller;\n     let cancelReason;\n@@ -1342,12 +1364,12 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n           \u0027\\n\u0027 +\n             \u0027    in Dynamic\u0027 +\n             (gate(flags \u003d\u003e flags.enableAsyncDebugInfo)\n-              ? \u0027 (file://ReactFlightDOMNode-test.js:1216:27)\\n\u0027\n+              ? \u0027 (file://ReactFlightDOMNode-test.js:1238:27)\\n\u0027\n               : \u0027\\n\u0027) +\n             \u0027    in body\\n\u0027 +\n             \u0027    in html\\n\u0027 +\n-            \u0027    in App (file://ReactFlightDOMNode-test.js:1229:25)\\n\u0027 +\n-            \u0027    in ClientRoot (ReactFlightDOMNode-test.js:1304:16)\u0027,\n+            \u0027    in App (file://ReactFlightDOMNode-test.js:1251:25)\\n\u0027 +\n+            \u0027    in ClientRoot (ReactFlightDOMNode-test.js:1326:16)\u0027,\n         );\n       } else {\n         expect(\n@@ -1356,7 +1378,7 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n           \u0027\\n\u0027 +\n             \u0027    in body\\n\u0027 +\n             \u0027    in html\\n\u0027 +\n-            \u0027    in ClientRoot (ReactFlightDOMNode-test.js:1304:16)\u0027,\n+            \u0027    in ClientRoot (ReactFlightDOMNode-test.js:1326:16)\u0027,\n         );\n       }\n \n@@ -1366,8 +1388,8 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n             normalizeCodeLocInfo(ownerStack, {preserveLocation: true}),\n           ).toBe(\n             \u0027\\n\u0027 +\n-              \u0027    in Dynamic (file://ReactFlightDOMNode-test.js:1216:27)\\n\u0027 +\n-              \u0027    in App (file://ReactFlightDOMNode-test.js:1229:25)\u0027,\n+              \u0027    in Dynamic (file://ReactFlightDOMNode-test.js:1238:27)\\n\u0027 +\n+              \u0027    in App (file://ReactFlightDOMNode-test.js:1251:25)\u0027,\n           );\n         } else {\n           expect(\n@@ -1375,7 +1397,7 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n           ).toBe(\n             \u0027\u0027 +\n               \u0027\\n\u0027 +\n-              \u0027    in App (file://ReactFlightDOMNode-test.js:1229:25)\u0027,\n+              \u0027    in App (file://ReactFlightDOMNode-test.js:1251:25)\u0027,\n           );\n         }\n       } else {\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js\nindex b874383..ac5aff0 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js\n@@ -135,7 +135,7 @@ describe(\u0027ReactFlightDOMReplyEdge\u0027, () \u003d\u003e {\n     expect(await resultBlob.arrayBuffer()).toEqual(await blob.arrayBuffer());\n   });\n \n-  it(\u0027should supports ReadableStreams with typed arrays\u0027, async () \u003d\u003e {\n+  it(\u0027should support ReadableStreams with typed arrays\u0027, async () \u003d\u003e {\n     const buffer \u003d new Uint8Array([\n       123, 4, 10, 5, 100, 255, 244, 45, 56, 67, 43, 124, 67, 89, 100, 20,\n     ]).buffer;\n@@ -239,6 +239,53 @@ describe(\u0027ReactFlightDOMReplyEdge\u0027, () \u003d\u003e {\n     expect(streamedBuffers.flatMap(t \u003d\u003e Array.from(t))).toEqual(expectedBytes);\n   });\n \n+  it(\u0027should cancel the transported ReadableStream when we are cancelled\u0027, async () \u003d\u003e {\n+    const s \u003d new ReadableStream({\n+      start(controller) {\n+        controller.enqueue(\u0027hi\u0027);\n+        controller.close();\n+      },\n+    });\n+\n+    const body \u003d await ReactServerDOMClient.encodeReply(s);\n+\n+    const iterable \u003d {\n+      async *[Symbol.asyncIterator]() {\n+        // eslint-disable-next-line no-for-of-loops/no-for-of-loops\n+        for (const entry of body) {\n+          if (entry[1] \u003d\u003d\u003d \u0027C\u0027) {\n+            // Return before finishing the stream.\n+            return;\n+          }\n+          yield entry;\n+        }\n+      },\n+    };\n+\n+    const result \u003d await ReactServerDOMServer.decodeReplyFromAsyncIterable(\n+      iterable,\n+      webpackServerMap,\n+    );\n+\n+    const reader \u003d result.getReader();\n+\n+    // We should be able to read the part we already emitted before the abort\n+    expect(await reader.read()).toEqual({\n+      value: \u0027hi\u0027,\n+      done: false,\n+    });\n+\n+    let error \u003d null;\n+    try {\n+      await reader.read();\n+    } catch (x) {\n+      error \u003d x;\n+    }\n+\n+    expect(error).not.toBe(null);\n+    expect(error.message).toBe(\u0027Connection closed.\u0027);\n+  });\n+\n   it(\u0027should abort when parsing an incomplete payload\u0027, async () \u003d\u003e {\n     const infinitePromise \u003d new Promise(() \u003d\u003e {});\n     const controller \u003d new AbortController();\ndiff --git a/packages/react-server/src/ReactFlightReplyServer.js b/packages/react-server/src/ReactFlightReplyServer.js\nindex 742cae6..1831a35 100644\n--- a/packages/react-server/src/ReactFlightReplyServer.js\n+++ b/packages/react-server/src/ReactFlightReplyServer.js\n@@ -33,6 +33,7 @@ import {\n import {ASYNC_ITERATOR} from \u0027shared/ReactSymbols\u0027;\n \n import hasOwnProperty from \u0027shared/hasOwnProperty\u0027;\n+import getPrototypeOf from \u0027shared/getPrototypeOf\u0027;\n \n interface FlightStreamController {\n   enqueueModel(json: string): void;\n@@ -128,6 +129,24 @@ ReactPromise.prototype.then \u003d function \u003cT\u003e(\n   switch (chunk.status) {\n     case INITIALIZED:\n       if (typeof resolve \u003d\u003d\u003d \u0027function\u0027) {\n+        let inspectedValue \u003d chunk.value;\n+        // Recursively check if the value is itself a ReactPromise and if so if it points\n+        // back to itself. This helps catch recursive thenables early error.\n+        while (inspectedValue instanceof ReactPromise) {\n+          if (inspectedValue \u003d\u003d\u003d chunk) {\n+            if (typeof reject \u003d\u003d\u003d \u0027function\u0027) {\n+              reject(new Error(\u0027Cannot have cyclic thenables.\u0027));\n+            }\n+            return;\n+          }\n+          if (inspectedValue.status \u003d\u003d\u003d INITIALIZED) {\n+            inspectedValue \u003d inspectedValue.value;\n+          } else {\n+            // If this is lazily resolved, pending or blocked, it\u0027ll eventually become\n+            // initialized and break the loop. Rejected also breaks it.\n+            break;\n+          }\n+        }\n         resolve(chunk.value);\n       }\n       break;\n@@ -156,6 +175,9 @@ ReactPromise.prototype.then \u003d function \u003cT\u003e(\n   }\n };\n \n+const ObjectPrototype \u003d Object.prototype;\n+const ArrayPrototype \u003d Array.prototype;\n+\n export type Response \u003d {\n   _bundlerConfig: ServerManifest,\n   _prefix: string,\n@@ -506,6 +528,7 @@ function loadServerReference\u003cA: Iterable\u003cany\u003e, T\u003e(\n       const initializedChunk: InitializedChunk\u003cT\u003e \u003d (chunk: any);\n       initializedChunk.status \u003d INITIALIZED;\n       initializedChunk.value \u003d handler.value;\n+      initializedChunk.reason \u003d null;\n       if (resolveListeners !\u003d\u003d null) {\n         wakeChunk(response, resolveListeners, handler.value);\n       }\n@@ -674,6 +697,7 @@ function initializeModelChunk\u003cT\u003e(chunk: ResolvedModelChunk\u003cT\u003e): void {\n     const initializedChunk: InitializedChunk\u003cT\u003e \u003d (chunk: any);\n     initializedChunk.status \u003d INITIALIZED;\n     initializedChunk.value \u003d value;\n+    initializedChunk.reason \u003d null;\n   } catch (error) {\n     const erroredChunk: ErroredChunk\u003cT\u003e \u003d (chunk: any);\n     erroredChunk.status \u003d ERRORED;\n@@ -694,6 +718,8 @@ export function reportGlobalError(response: Response, error: Error): void {\n     // because we won\u0027t be getting any new data to resolve it.\n     if (chunk.status \u003d\u003d\u003d PENDING) {\n       triggerErrorOnChunk(response, chunk, error);\n+    } else if (chunk.status \u003d\u003d\u003d INITIALIZED \u0026\u0026 chunk.reason !\u003d\u003d null) {\n+      chunk.reason.error(error);\n     }\n   });\n }\n@@ -728,57 +754,34 @@ function fulfillReference(\n ): void {\n   const {handler, parentObject, key, map, path} \u003d reference;\n \n-  for (let i \u003d 1; i \u003c path.length; i++) {\n-    // The server doesn\u0027t have any lazy references but we unwrap Chunks here in the same way as the client.\n-    while (value instanceof ReactPromise) {\n-      const referencedChunk: SomeChunk\u003cany\u003e \u003d value;\n-      switch (referencedChunk.status) {\n-        case RESOLVED_MODEL:\n-          initializeModelChunk(referencedChunk);\n-          break;\n-      }\n-      switch (referencedChunk.status) {\n-        case INITIALIZED: {\n-          value \u003d referencedChunk.value;\n-          continue;\n-        }\n-        case BLOCKED:\n-        case PENDING: {\n-          // If we\u0027re not yet initialized we need to skip what we\u0027ve already drilled\n-          // through and then wait for the next value to become available.\n-          path.splice(0, i - 1);\n-          // Add \"listener\" to our new chunk dependency.\n-          if (referencedChunk.value \u003d\u003d\u003d null) {\n-            referencedChunk.value \u003d [reference];\n-          } else {\n-            referencedChunk.value.push(reference);\n-          }\n-          if (referencedChunk.reason \u003d\u003d\u003d null) {\n-            referencedChunk.reason \u003d [reference];\n-          } else {\n-            referencedChunk.reason.push(reference);\n-          }\n-          return;\n-        }\n-        default: {\n-          rejectReference(response, reference.handler, referencedChunk.reason);\n-          return;\n-        }\n+  try {\n+    for (let i \u003d 1; i \u003c path.length; i++) {\n+      // The server doesn\u0027t have any lazy references so we don\u0027t expect to go through a Promise.\n+      const name \u003d path[i];\n+      if (\n+        typeof value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026\n+        value !\u003d\u003d null \u0026\u0026\n+        (getPrototypeOf(value) \u003d\u003d\u003d ObjectPrototype ||\n+          getPrototypeOf(value) \u003d\u003d\u003d ArrayPrototype) \u0026\u0026\n+        hasOwnProperty.call(value, name)\n+      ) {\n+        value \u003d value[name];\n+      } else {\n+        throw new Error(\u0027Invalid reference.\u0027);\n       }\n     }\n-    const name \u003d path[i];\n-    if (typeof value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026 hasOwnProperty.call(value, name)) {\n-      value \u003d value[name];\n-    }\n-  }\n \n-  const mappedValue \u003d map(response, value, parentObject, key);\n-  parentObject[key] \u003d mappedValue;\n+    const mappedValue \u003d map(response, value, parentObject, key);\n+    parentObject[key] \u003d mappedValue;\n \n-  // If this is the root object for a model reference, where `handler.value`\n-  // is a stale `null`, the resolved value can be used directly.\n-  if (key \u003d\u003d\u003d \u0027\u0027 \u0026\u0026 handler.value \u003d\u003d\u003d null) {\n-    handler.value \u003d mappedValue;\n+    // If this is the root object for a model reference, where `handler.value`\n+    // is a stale `null`, the resolved value can be used directly.\n+    if (key \u003d\u003d\u003d \u0027\u0027 \u0026\u0026 handler.value \u003d\u003d\u003d null) {\n+      handler.value \u003d mappedValue;\n+    }\n+  } catch (error) {\n+    rejectReference(response, reference.handler, error);\n+    return;\n   }\n \n   // There are no Elements or Debug Info to transfer here.\n@@ -889,53 +892,17 @@ function getOutlinedModel\u003cT\u003e(\n     case INITIALIZED:\n       let value \u003d chunk.value;\n       for (let i \u003d 1; i \u003c path.length; i++) {\n-        // The server doesn\u0027t have any lazy references but we unwrap Chunks here in the same way as the client.\n-        while (value instanceof ReactPromise) {\n-          const referencedChunk: SomeChunk\u003cany\u003e \u003d value;\n-          switch (referencedChunk.status) {\n-            case RESOLVED_MODEL:\n-              initializeModelChunk(referencedChunk);\n-              break;\n-          }\n-          switch (referencedChunk.status) {\n-            case INITIALIZED: {\n-              value \u003d referencedChunk.value;\n-              break;\n-            }\n-            case BLOCKED:\n-            case PENDING: {\n-              return waitForReference(\n-                referencedChunk,\n-                parentObject,\n-                key,\n-                response,\n-                map,\n-                path.slice(i - 1),\n-              );\n-            }\n-            default: {\n-              // This is an error. Instead of erroring directly, we\u0027re going to encode this on\n-              // an initialization handler so that we can catch it at the nearest Element.\n-              if (initializingHandler) {\n-                initializingHandler.errored \u003d true;\n-                initializingHandler.value \u003d null;\n-                initializingHandler.reason \u003d referencedChunk.reason;\n-              } else {\n-                initializingHandler \u003d {\n-                  chunk: null,\n-                  value: null,\n-                  reason: referencedChunk.reason,\n-                  deps: 0,\n-                  errored: true,\n-                };\n-              }\n-              return (null: any);\n-            }\n-          }\n-        }\n         const name \u003d path[i];\n-        if (typeof value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026 hasOwnProperty.call(value, name)) {\n+        if (\n+          typeof value \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026\n+          value !\u003d\u003d null \u0026\u0026\n+          (getPrototypeOf(value) \u003d\u003d\u003d ObjectPrototype ||\n+            getPrototypeOf(value) \u003d\u003d\u003d ArrayPrototype) \u0026\u0026\n+          hasOwnProperty.call(value, name)\n+        ) {\n           value \u003d value[name];\n+        } else {\n+          throw new Error(\u0027Invalid reference.\u0027);\n         }\n       }\n       const chunkValue \u003d map(response, value, parentObject, key);\n@@ -1006,6 +973,11 @@ function parseTypedArray\u003cT: $ArrayBufferView | ArrayBuffer\u003e(\n   const id \u003d parseInt(reference.slice(2), 16);\n   const prefix \u003d response._prefix;\n   const key \u003d prefix + id;\n+  const chunks \u003d response._chunks;\n+  if (chunks.has(id)) {\n+    throw new Error(\u0027Already initialized typed array.\u0027);\n+  }\n+\n   // We should have this backingEntry in the store already because we emitted\n   // it before referencing it. It should be a Blob.\n   // TODO: Use getOutlinedModel to allow us to emit the Blob later. We should be able to do that now.\n@@ -1055,6 +1027,7 @@ function parseTypedArray\u003cT: $ArrayBufferView | ArrayBuffer\u003e(\n       const initializedChunk: InitializedChunk\u003cT\u003e \u003d (chunk: any);\n       initializedChunk.status \u003d INITIALIZED;\n       initializedChunk.value \u003d handler.value;\n+      initializedChunk.reason \u003d null;\n       if (resolveListeners !\u003d\u003d null) {\n         wakeChunk(response, resolveListeners, handler.value);\n       }\n@@ -1116,8 +1089,13 @@ function parseReadableStream\u003cT\u003e(\n   parentKey: string,\n ): ReadableStream {\n   const id \u003d parseInt(reference.slice(2), 16);\n+  const chunks \u003d response._chunks;\n+  if (chunks.has(id)) {\n+    throw new Error(\u0027Already initialized stream.\u0027);\n+  }\n \n   let controller: ReadableStreamController \u003d (null: any);\n+  let closed \u003d false;\n   const stream \u003d new ReadableStream({\n     type: type,\n     start(c) {\n@@ -1166,6 +1144,10 @@ function parseReadableStream\u003cT\u003e(\n       }\n     },\n     close(json: string): void {\n+      if (closed) {\n+        return;\n+      }\n+      closed \u003d true;\n       if (previousBlockedChunk \u003d\u003d\u003d null) {\n         controller.close();\n       } else {\n@@ -1176,6 +1158,10 @@ function parseReadableStream\u003cT\u003e(\n       }\n     },\n     error(error: mixed): void {\n+      if (closed) {\n+        return;\n+      }\n+      closed \u003d true;\n       if (previousBlockedChunk \u003d\u003d\u003d null) {\n         // $FlowFixMe[incompatible-call]\n         controller.error(error);\n@@ -1218,6 +1204,10 @@ function parseAsyncIterable\u003cT\u003e(\n   parentKey: string,\n ): $AsyncIterable\u003cT, T, void\u003e | $AsyncIterator\u003cT, T, void\u003e {\n   const id \u003d parseInt(reference.slice(2), 16);\n+  const chunks \u003d response._chunks;\n+  if (chunks.has(id)) {\n+    throw new Error(\u0027Already initialized stream.\u0027);\n+  }\n \n   const buffer: Array\u003cSomeChunk\u003cIteratorResult\u003cT, T\u003e\u003e\u003e \u003d [];\n   let closed \u003d false;\n@@ -1241,6 +1231,9 @@ function parseAsyncIterable\u003cT\u003e(\n       nextWriteIndex++;\n     },\n     close(value: string): void {\n+      if (closed) {\n+        return;\n+      }\n       closed \u003d true;\n       if (nextWriteIndex \u003d\u003d\u003d buffer.length) {\n         buffer[nextWriteIndex] \u003d createResolvedIteratorResultChunk(\n@@ -1268,6 +1261,9 @@ function parseAsyncIterable\u003cT\u003e(\n       }\n     },\n     error(error: Error): void {\n+      if (closed) {\n+        return;\n+      }\n       closed \u003d true;\n       if (nextWriteIndex \u003d\u003d\u003d buffer.length) {\n         buffer[nextWriteIndex] \u003d\n@@ -1329,7 +1325,7 @@ function parseModelString(\n         const chunk \u003d getChunk(response, id);\n         return chunk;\n       }\n-      case \u0027F\u0027: {\n+      case \u0027h\u0027: {\n         // Server Reference\n         const ref \u003d value.slice(2);\n         return getOutlinedModel(response, ref, obj, key, loadServerReference);\ndiff --git a/packages/react-server/src/ReactFlightServer.js b/packages/react-server/src/ReactFlightServer.js\nindex d5b534a..0219136 100644\n--- a/packages/react-server/src/ReactFlightServer.js\n+++ b/packages/react-server/src/ReactFlightServer.js\n@@ -2797,7 +2797,7 @@ function serializePromiseID(id: number): string {\n }\n \n function serializeServerReferenceID(id: number): string {\n-  return \u0027$F\u0027 + id.toString(16);\n+  return \u0027$h\u0027 + id.toString(16);\n }\n \n function serializeSymbolReference(name: string): string {\ndiff --git a/scripts/error-codes/codes.json b/scripts/error-codes/codes.json\nindex e87d750..d8c8e0b 100644\n--- a/scripts/error-codes/codes.json\n+++ b/scripts/error-codes/codes.json\n@@ -551,5 +551,9 @@\n   \"563\": \"This render completed successfully. All cacheSignals are now aborted to allow clean up of any unused resources.\",\n   \"564\": \"Unknown command. The debugChannel was not wired up properly.\",\n   \"565\": \"resolveDebugMessage/closeDebugChannel should not be called for a Request that wasn\u0027t kept alive. This is a bug in React.\",\n-  \"566\": \"FragmentInstance.scrollIntoView() does not support scrollIntoViewOptions. Use the alignToTop boolean instead.\"\n+  \"566\": \"FragmentInstance.scrollIntoView() does not support scrollIntoViewOptions. Use the alignToTop boolean instead.\",\n+  \"567\": \"Already initialized stream.\",\n+  \"568\": \"Already initialized typed array.\",\n+  \"569\": \"Cannot have cyclic thenables.\",\n+  \"570\": \"Invalid reference.\"\n }","expectedMessage":"[Flight] Patch Promise cycles and toString on Server Functions (#35345)","repository":"react","commitHash":"894bc73cb493487c48d57f4508e6278db58e673a","metadata":{"author":"Sebastian Markbåge \u003csebastian@calyptus.eu\u003e"}}
{"id":"react-37bcdcde","diff":" .../react-devtools-shared/src/backend/views/Highlighter/index.js   | 7 +++++--\n 1 file changed, 5 insertions(+), 2 deletions(-)\n\ndiff --git a/packages/react-devtools-shared/src/backend/views/Highlighter/index.js b/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\nindex f1711e0..0339701 100644\n--- a/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\n+++ b/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\n@@ -96,8 +96,11 @@ export default function setupHighlighter(\n     applyingScroll \u003d false;\n   }\n \n-  // $FlowFixMe[method-unbinding]\n-  if (document \u0026\u0026 typeof document.addEventListener \u003d\u003d\u003d \u0027function\u0027) {\n+  if (\n+    typeof document \u003d\u003d\u003d \u0027object\u0027 \u0026\u0026\n+    // $FlowFixMe[method-unbinding]\n+    typeof document.addEventListener \u003d\u003d\u003d \u0027function\u0027\n+  ) {\n     document.addEventListener(\u0027scroll\u0027, () \u003d\u003e {\n       if (!scrollTimer) {\n         // Periodically synchronize the scroll while scrolling.","expectedMessage":"fix[devtools]: feature-check document with typeof instead of direct reference (#35343)","repository":"react","commitHash":"37bcdcde044131d49f11b2f62873a200a94ec756","metadata":{"author":"Ruslan Lesiutin \u003c28902667+hoxyq@users.noreply.github.com\u003e"}}
{"id":"react-5a970933","diff":" .../src/backend/utils/parseStackTrace.js           | 60 +++++++++++++++++-----\n 1 file changed, 47 insertions(+), 13 deletions(-)\n\ndiff --git a/packages/react-devtools-shared/src/backend/utils/parseStackTrace.js b/packages/react-devtools-shared/src/backend/utils/parseStackTrace.js\nindex 300bfbe..e18c2d7 100644\n--- a/packages/react-devtools-shared/src/backend/utils/parseStackTrace.js\n+++ b/packages/react-devtools-shared/src/backend/utils/parseStackTrace.js\n@@ -154,41 +154,73 @@ function collectStackTrace(\n   // We mirror how V8 serializes stack frames and how we later parse them.\n   for (let i \u003d framesToSkip; i \u003c structuredStackTrace.length; i++) {\n     const callSite \u003d structuredStackTrace[i];\n-    let name \u003d callSite.getFunctionName() || \u0027\u003canonymous\u003e\u0027;\n+    let name \u003d\n+      // $FlowFixMe[method-unbinding]\n+      typeof callSite.getFunctionName \u003d\u003d\u003d \u0027function\u0027\n+        ? callSite.getFunctionName() || \u0027\u003canonymous\u003e\u0027\n+        : \u0027\u0027;\n     if (\n       name.includes(\u0027react_stack_bottom_frame\u0027) ||\n       name.includes(\u0027react-stack-bottom-frame\u0027)\n     ) {\n       // Skip everything after the bottom frame since it\u0027ll be internals.\n       break;\n-    } else if (callSite.isNative()) {\n-      // $FlowFixMe[prop-missing]\n-      const isAsync \u003d callSite.isAsync();\n+      // $FlowFixMe[method-unbinding]\n+    } else if (typeof callSite.isNative \u003d\u003d\u003d \u0027function\u0027 \u0026\u0026 callSite.isNative()) {\n+      const isAsync \u003d\n+        // $FlowFixMe[prop-missing]\n+        // $FlowFixMe[incompatible-use]\n+        typeof callSite.isAsync \u003d\u003d\u003d \u0027function\u0027 \u0026\u0026 callSite.isAsync();\n       result.push([name, \u0027\u0027, 0, 0, 0, 0, isAsync]);\n     } else {\n       // We encode complex function calls as if they\u0027re part of the function\n       // name since we cannot simulate the complex ones and they look the same\n       // as function names in UIs on the client as well as stacks.\n-      if (callSite.isConstructor()) {\n+      if (\n+        // $FlowFixMe[method-unbinding]\n+        typeof callSite.isConstructor \u003d\u003d\u003d \u0027function\u0027 \u0026\u0026\n+        callSite.isConstructor()\n+      ) {\n         name \u003d \u0027new \u0027 + name;\n-      } else if (!callSite.isToplevel()) {\n+      } else if (\n+        // $FlowFixMe[method-unbinding]\n+        typeof callSite.isToplevel \u003d\u003d\u003d \u0027function\u0027 \u0026\u0026\n+        !callSite.isToplevel()\n+      ) {\n         name \u003d getMethodCallName(callSite);\n       }\n       if (name \u003d\u003d\u003d \u0027\u003canonymous\u003e\u0027) {\n         name \u003d \u0027\u0027;\n       }\n-      let filename \u003d callSite.getScriptNameOrSourceURL() || \u0027\u003canonymous\u003e\u0027;\n+      let filename \u003d\n+        // $FlowFixMe[method-unbinding]\n+        typeof callSite.getScriptNameOrSourceURL \u003d\u003d\u003d \u0027function\u0027\n+          ? callSite.getScriptNameOrSourceURL() || \u0027\u003canonymous\u003e\u0027\n+          : \u0027\u0027;\n       if (filename \u003d\u003d\u003d \u0027\u003canonymous\u003e\u0027) {\n         filename \u003d \u0027\u0027;\n-        if (callSite.isEval()) {\n-          const origin \u003d callSite.getEvalOrigin();\n+        // $FlowFixMe[method-unbinding]\n+        if (typeof callSite.isEval \u003d\u003d\u003d \u0027function\u0027 \u0026\u0026 callSite.isEval()) {\n+          const origin \u003d\n+            // $FlowFixMe[method-unbinding]\n+            typeof callSite.getEvalOrigin \u003d\u003d\u003d \u0027function\u0027\n+              ? callSite.getEvalOrigin()\n+              : null;\n           if (origin) {\n             filename \u003d origin.toString() + \u0027, \u003canonymous\u003e\u0027;\n           }\n         }\n       }\n-      const line \u003d callSite.getLineNumber() || 0;\n-      const col \u003d callSite.getColumnNumber() || 0;\n+      const line \u003d\n+        // $FlowFixMe[method-unbinding]\n+        (typeof callSite.getLineNumber \u003d\u003d\u003d \u0027function\u0027 \u0026\u0026\n+          callSite.getLineNumber()) ||\n+        0;\n+      const col \u003d\n+        // $FlowFixMe[method-unbinding]\n+        (typeof callSite.getColumnNumber \u003d\u003d\u003d \u0027function\u0027 \u0026\u0026\n+          callSite.getColumnNumber()) ||\n+        0;\n       const enclosingLine: number \u003d\n         // $FlowFixMe[prop-missing]\n         typeof callSite.getEnclosingLineNumber \u003d\u003d\u003d \u0027function\u0027\n@@ -199,8 +231,10 @@ function collectStackTrace(\n         typeof callSite.getEnclosingColumnNumber \u003d\u003d\u003d \u0027function\u0027\n           ? (callSite: any).getEnclosingColumnNumber() || 0\n           : 0;\n-      // $FlowFixMe[prop-missing]\n-      const isAsync \u003d callSite.isAsync();\n+      const isAsync \u003d\n+        // $FlowFixMe[prop-missing]\n+        // $FlowFixMe[incompatible-use]\n+        typeof callSite.isAsync \u003d\u003d\u003d \u0027function\u0027 \u0026\u0026 callSite.isAsync();\n       result.push([\n         name,\n         filename,","expectedMessage":"fix[devtools]: feature-check structure stack trace methods (#35293)","repository":"react","commitHash":"5a970933c0aa5c5cfb9793cce49f3a282b191716","metadata":{"author":"Ruslan Lesiutin \u003c28902667+hoxyq@users.noreply.github.com\u003e"}}
{"id":"react-5d801243","diff":" .../src/backend/views/Highlighter/index.js                    | 11 +++++------\n 1 file changed, 5 insertions(+), 6 deletions(-)\n\ndiff --git a/packages/react-devtools-shared/src/backend/views/Highlighter/index.js b/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\nindex 34a81f3..f1711e0 100644\n--- a/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\n+++ b/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\n@@ -202,13 +202,12 @@ export default function setupHighlighter(\n           typeof node.getClientRects \u003d\u003d\u003d \u0027function\u0027\n             ? node.getClientRects()\n             : [];\n-        // If this is currently display: none, then try another node.\n-        // This can happen when one of the host instances is a hoistable.\n         if (\n-          nodeRects.length \u003e 0 \u0026\u0026\n-          (nodeRects.length \u003e 2 ||\n-            nodeRects[0].width \u003e 0 ||\n-            nodeRects[0].height \u003e 0)\n+          typeof node.getClientRects \u003d\u003d\u003d \u0027undefined\u0027 || // If Host doesn\u0027t implement getClientRects, try to show the overlay.\n+          (nodeRects.length \u003e 0 \u0026\u0026 //                      If this is currently display: none, then try another node.\n+            (nodeRects.length \u003e 2 || //                    This can happen when one of the host instances is a hoistable.\n+              nodeRects[0].width \u003e 0 ||\n+              nodeRects[0].height \u003e 0))\n         ) {\n           // $FlowFixMe[method-unbinding]\n           if (scrollIntoView \u0026\u0026 typeof node.scrollIntoView \u003d\u003d\u003d \u0027function\u0027) {","expectedMessage":"fix[devtools]: still show overlay, if getClientRects is not implemented (#35294)","repository":"react","commitHash":"5d801243459cc18a768c9b291355943366730539","metadata":{"author":"Ruslan Lesiutin \u003c28902667+hoxyq@users.noreply.github.com\u003e"}}
{"id":"react-eade0d0f","diff":" packages/react-dom-bindings/src/client/ReactDOMComponentTree.js | 6 ++++++\n 1 file changed, 6 insertions(+)\n\ndiff --git a/packages/react-dom-bindings/src/client/ReactDOMComponentTree.js b/packages/react-dom-bindings/src/client/ReactDOMComponentTree.js\nindex 2063e5e..01e4fcd 100644\n--- a/packages/react-dom-bindings/src/client/ReactDOMComponentTree.js\n+++ b/packages/react-dom-bindings/src/client/ReactDOMComponentTree.js\n@@ -75,6 +75,9 @@ export function detachDeletedInstance(node: Instance): void {\n     delete (node: any)[internalEventHandlerListenersKey];\n     delete (node: any)[internalEventHandlesSetKey];\n     delete (node: any)[internalRootNodeResourcesKey];\n+    if (__DEV__) {\n+      delete (node: any)[internalInstanceKey];\n+    }\n     return;\n   }\n   // TODO: This function is only called on host components. I don\u0027t think all of\n@@ -97,6 +100,9 @@ export function precacheFiberNode(\n ): void {\n   if (enableInternalInstanceMap) {\n     internalInstanceMap.set(node, hostInst);\n+    if (__DEV__) {\n+      (node: any)[internalInstanceKey] \u003d hostInst;\n+    }\n     return;\n   }\n   (node: any)[internalInstanceKey] \u003d hostInst;","expectedMessage":"Attach instance handle to DOM in DEV for enableInternalInstanceMap (#35341)","repository":"react","commitHash":"eade0d0fb78e327c5624f53753126687f05c0d16","metadata":{"author":"Jack Pope \u003cjackpope1@gmail.com\u003e"}}
{"id":"react-d763f313","diff":" .../src/__tests__/profilerContext-test.js          | 284 +++++++++++++++++++++\n .../src/devtools/views/Profiler/Profiler.js        |  22 +-\n .../src/devtools/views/Profiler/ProfilerContext.js | 105 ++++++--\n .../devtools/views/Profiler/SnapshotSelector.js    |  78 +-----\n .../Profiler/useCommitFilteringAndNavigation.js    | 199 +++++++++++++++\n 5 files changed, 595 insertions(+), 93 deletions(-)\n\ndiff --git a/packages/react-devtools-shared/src/__tests__/profilerContext-test.js b/packages/react-devtools-shared/src/__tests__/profilerContext-test.js\nindex 2cd2340..7864f97 100644\n--- a/packages/react-devtools-shared/src/__tests__/profilerContext-test.js\n+++ b/packages/react-devtools-shared/src/__tests__/profilerContext-test.js\n@@ -655,4 +655,288 @@ describe(\u0027ProfilerContext\u0027, () \u003d\u003e {\n \n     document.body.removeChild(profilerContainer);\n   });\n+\n+  it(\u0027should navigate between commits when the keyboard shortcut is pressed\u0027, async () \u003d\u003e {\n+    const Parent \u003d () \u003d\u003e \u003cChild /\u003e;\n+    const Child \u003d () \u003d\u003e null;\n+\n+    const container \u003d document.createElement(\u0027div\u0027);\n+    const root \u003d ReactDOMClient.createRoot(container);\n+    utils.act(() \u003d\u003e root.render(\u003cParent /\u003e));\n+\n+    // Profile and record multiple commits\n+    await utils.actAsync(() \u003d\u003e store.profilerStore.startProfiling());\n+    await utils.actAsync(() \u003d\u003e root.render(\u003cParent /\u003e)); // Commit 1\n+    await utils.actAsync(() \u003d\u003e root.render(\u003cParent /\u003e)); // Commit 2\n+    await utils.actAsync(() \u003d\u003e root.render(\u003cParent /\u003e)); // Commit 3\n+    await utils.actAsync(() \u003d\u003e store.profilerStore.stopProfiling());\n+\n+    const Profiler \u003d\n+      require(\u0027react-devtools-shared/src/devtools/views/Profiler/Profiler\u0027).default;\n+    const {\n+      TimelineContextController,\n+    } \u003d require(\u0027react-devtools-timeline/src/TimelineContext\u0027);\n+    const {\n+      SettingsContextController,\n+    } \u003d require(\u0027react-devtools-shared/src/devtools/views/Settings/SettingsContext\u0027);\n+    const {\n+      ModalDialogContextController,\n+    } \u003d require(\u0027react-devtools-shared/src/devtools/views/ModalDialog\u0027);\n+\n+    let context: Context \u003d ((null: any): Context);\n+    function ContextReader() {\n+      context \u003d React.useContext(ProfilerContext);\n+      return null;\n+    }\n+\n+    const profilerContainer \u003d document.createElement(\u0027div\u0027);\n+    document.body.appendChild(profilerContainer);\n+\n+    const profilerRoot \u003d ReactDOMClient.createRoot(profilerContainer);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      profilerRoot.render(\n+        \u003cContexts\u003e\n+          \u003cSettingsContextController browserTheme\u003d\"light\"\u003e\n+            \u003cModalDialogContextController\u003e\n+              \u003cTimelineContextController\u003e\n+                \u003cProfiler /\u003e\n+                \u003cContextReader /\u003e\n+              \u003c/TimelineContextController\u003e\n+            \u003c/ModalDialogContextController\u003e\n+          \u003c/SettingsContextController\u003e\n+        \u003c/Contexts\u003e,\n+      );\n+    });\n+\n+    // Verify we have profiling data with 3 commits\n+    expect(context.didRecordCommits).toBe(true);\n+    expect(context.profilingData).not.toBeNull();\n+    const rootID \u003d context.rootID;\n+    expect(rootID).not.toBeNull();\n+    const dataForRoot \u003d context.profilingData.dataForRoots.get(rootID);\n+    expect(dataForRoot.commitData.length).toBe(3);\n+    // Should start at the first commit\n+    expect(context.selectedCommitIndex).toBe(0);\n+\n+    const ownerWindow \u003d profilerContainer.ownerDocument.defaultView;\n+    const isMac \u003d\n+      typeof navigator !\u003d\u003d \u0027undefined\u0027 \u0026\u0026\n+      navigator.platform.toUpperCase().indexOf(\u0027MAC\u0027) \u003e\u003d 0;\n+\n+    // Test ArrowRight navigation (forward) with correct modifier\n+    const arrowRightEvent \u003d new KeyboardEvent(\u0027keydown\u0027, {\n+      key: \u0027ArrowRight\u0027,\n+      metaKey: isMac,\n+      ctrlKey: !isMac,\n+      bubbles: true,\n+    });\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowRightEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(1);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowRightEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(2);\n+\n+    // Test wrap-around (last -\u003e first)\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowRightEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(0);\n+\n+    // Test ArrowLeft navigation (backward) with correct modifier\n+    const arrowLeftEvent \u003d new KeyboardEvent(\u0027keydown\u0027, {\n+      key: \u0027ArrowLeft\u0027,\n+      metaKey: isMac,\n+      ctrlKey: !isMac,\n+      bubbles: true,\n+    });\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowLeftEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(2);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowLeftEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(1);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowLeftEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(0);\n+\n+    // Cleanup\n+    await utils.actAsync(() \u003d\u003e profilerRoot.unmount());\n+    document.body.removeChild(profilerContainer);\n+  });\n+\n+  it(\u0027should handle commit selection edge cases when filtering commits\u0027, async () \u003d\u003e {\n+    const Scheduler \u003d require(\u0027scheduler\u0027);\n+\n+    // Create components that do varying amounts of work to generate different commit durations\n+    const Parent \u003d ({count}) \u003d\u003e {\n+      Scheduler.unstable_advanceTime(10);\n+      const items \u003d [];\n+      for (let i \u003d 0; i \u003c count; i++) {\n+        items.push(\u003cChild key\u003d{i} duration\u003d{i} /\u003e);\n+      }\n+      return \u003cdiv\u003e{items}\u003c/div\u003e;\n+    };\n+    const Child \u003d ({duration}) \u003d\u003e {\n+      Scheduler.unstable_advanceTime(duration);\n+      return \u003cspan\u003e{duration}\u003c/span\u003e;\n+    };\n+\n+    const container \u003d document.createElement(\u0027div\u0027);\n+    const root \u003d ReactDOMClient.createRoot(container);\n+    utils.act(() \u003d\u003e root.render(\u003cParent count\u003d{1} /\u003e));\n+\n+    // Profile and record multiple commits with different amounts of work\n+    await utils.actAsync(() \u003d\u003e store.profilerStore.startProfiling());\n+    await utils.actAsync(() \u003d\u003e root.render(\u003cParent count\u003d{5} /\u003e)); // Commit 1 - 20ms\n+    await utils.actAsync(() \u003d\u003e root.render(\u003cParent count\u003d{20} /\u003e)); // Commit 2 - 200ms\n+    await utils.actAsync(() \u003d\u003e root.render(\u003cParent count\u003d{50} /\u003e)); // Commit 3 - 1235ms\n+    await utils.actAsync(() \u003d\u003e root.render(\u003cParent count\u003d{10} /\u003e)); // Commit 4 - 55ms\n+    await utils.actAsync(() \u003d\u003e store.profilerStore.stopProfiling());\n+\n+    // Context providers\n+    const Profiler \u003d\n+      require(\u0027react-devtools-shared/src/devtools/views/Profiler/Profiler\u0027).default;\n+    const {\n+      TimelineContextController,\n+    } \u003d require(\u0027react-devtools-timeline/src/TimelineContext\u0027);\n+    const {\n+      SettingsContextController,\n+    } \u003d require(\u0027react-devtools-shared/src/devtools/views/Settings/SettingsContext\u0027);\n+    const {\n+      ModalDialogContextController,\n+    } \u003d require(\u0027react-devtools-shared/src/devtools/views/ModalDialog\u0027);\n+\n+    let context: Context \u003d ((null: any): Context);\n+    function ContextReader() {\n+      context \u003d React.useContext(ProfilerContext);\n+      return null;\n+    }\n+\n+    const profilerContainer \u003d document.createElement(\u0027div\u0027);\n+    document.body.appendChild(profilerContainer);\n+\n+    const profilerRoot \u003d ReactDOMClient.createRoot(profilerContainer);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      profilerRoot.render(\n+        \u003cContexts\u003e\n+          \u003cSettingsContextController browserTheme\u003d\"light\"\u003e\n+            \u003cModalDialogContextController\u003e\n+              \u003cTimelineContextController\u003e\n+                \u003cProfiler /\u003e\n+                \u003cContextReader /\u003e\n+              \u003c/TimelineContextController\u003e\n+            \u003c/ModalDialogContextController\u003e\n+          \u003c/SettingsContextController\u003e\n+        \u003c/Contexts\u003e,\n+      );\n+    });\n+\n+    // Verify we have profiling data with 4 commits\n+    expect(context.didRecordCommits).toBe(true);\n+    expect(context.profilingData).not.toBeNull();\n+    const rootID \u003d context.rootID;\n+    expect(rootID).not.toBeNull();\n+    const dataForRoot \u003d context.profilingData.dataForRoots.get(rootID);\n+    expect(dataForRoot.commitData.length).toBe(4);\n+    // Edge case 1: Should start at the first commit\n+    expect(context.selectedCommitIndex).toBe(0);\n+\n+    const ownerWindow \u003d profilerContainer.ownerDocument.defaultView;\n+    const isMac \u003d\n+      typeof navigator !\u003d\u003d \u0027undefined\u0027 \u0026\u0026\n+      navigator.platform.toUpperCase().indexOf(\u0027MAC\u0027) \u003e\u003d 0;\n+\n+    const arrowRightEvent \u003d new KeyboardEvent(\u0027keydown\u0027, {\n+      key: \u0027ArrowRight\u0027,\n+      metaKey: isMac,\n+      ctrlKey: !isMac,\n+      bubbles: true,\n+    });\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowRightEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(1);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      context.setIsCommitFilterEnabled(true);\n+    });\n+\n+    // Edge case 2:  When filtering is enabled, selected commit should remain if it\u0027s still visible\n+    expect(context.filteredCommitIndices.length).toBe(4);\n+    expect(context.selectedCommitIndex).toBe(1);\n+    expect(context.selectedFilteredCommitIndex).toBe(1);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      context.setMinCommitDuration(1000000);\n+    });\n+\n+    // Edge case 3: When all commits are filtered out, selection should be null\n+    expect(context.filteredCommitIndices).toEqual([]);\n+    expect(context.selectedCommitIndex).toBe(null);\n+    expect(context.selectedFilteredCommitIndex).toBe(null);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      context.setMinCommitDuration(0);\n+    });\n+\n+    // Edge case 4: After restoring commits, first commit should be auto-selected\n+    expect(context.filteredCommitIndices.length).toBe(4);\n+    expect(context.selectedCommitIndex).toBe(0);\n+    expect(context.selectedFilteredCommitIndex).toBe(0);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowRightEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(1);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowRightEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(2);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      ownerWindow.dispatchEvent(arrowRightEvent);\n+    }, false);\n+    expect(context.selectedCommitIndex).toBe(3);\n+\n+    // Filter out the currently selected commit using actual commit data\n+    const commitDurations \u003d dataForRoot.commitData.map(\n+      commit \u003d\u003e commit.duration,\n+    );\n+    const selectedCommitDuration \u003d commitDurations[3];\n+    const filterThreshold \u003d selectedCommitDuration + 0.001;\n+    await utils.actAsync(() \u003d\u003e {\n+      context.setMinCommitDuration(filterThreshold);\n+    });\n+\n+    // Edge case 5: Should auto-select first available commit when current one is filtered\n+    expect(context.selectedCommitIndex).not.toBe(null);\n+    expect(context.selectedFilteredCommitIndex).toBe(1);\n+\n+    await utils.actAsync(() \u003d\u003e {\n+      context.setIsCommitFilterEnabled(false);\n+    });\n+\n+    // Edge case 6: When filtering is disabled, selected commit should remain\n+    expect(context.filteredCommitIndices.length).toBe(4);\n+    expect(context.selectedCommitIndex).toBe(2);\n+    expect(context.selectedFilteredCommitIndex).toBe(2);\n+\n+    await utils.actAsync(() \u003d\u003e profilerRoot.unmount());\n+    document.body.removeChild(profilerContainer);\n+  });\n });\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Profiler/Profiler.js b/packages/react-devtools-shared/src/devtools/views/Profiler/Profiler.js\nindex 5e33063..6254be0 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Profiler/Profiler.js\n+++ b/packages/react-devtools-shared/src/devtools/views/Profiler/Profiler.js\n@@ -54,6 +54,8 @@ function Profiler(_: {}) {\n     supportsProfiling,\n     startProfiling,\n     stopProfiling,\n+    selectPrevCommitIndex,\n+    selectNextCommitIndex,\n   } \u003d useContext(ProfilerContext);\n \n   const {file: timelineTraceEventData, searchInputContainerRef} \u003d\n@@ -63,9 +65,9 @@ function Profiler(_: {}) {\n \n   const isLegacyProfilerSelected \u003d selectedTabID !\u003d\u003d \u0027timeline\u0027;\n \n-  // Cmd+E to start/stop profiler recording\n   const handleKeyDown \u003d useEffectEvent((event: KeyboardEvent) \u003d\u003e {\n     const correctModifier \u003d isMac ? event.metaKey : event.ctrlKey;\n+    // Cmd+E to start/stop profiler recording\n     if (correctModifier \u0026\u0026 event.key \u003d\u003d\u003d \u0027e\u0027) {\n       if (isProfiling) {\n         stopProfiling();\n@@ -74,6 +76,24 @@ function Profiler(_: {}) {\n       }\n       event.preventDefault();\n       event.stopPropagation();\n+    } else if (\n+      isLegacyProfilerSelected \u0026\u0026\n+      didRecordCommits \u0026\u0026\n+      selectedCommitIndex !\u003d\u003d null\n+    ) {\n+      // Cmd+Left/Right (Mac) or Ctrl+Left/Right (Windows/Linux) to navigate commits\n+      if (\n+        correctModifier \u0026\u0026\n+        (event.key \u003d\u003d\u003d \u0027ArrowLeft\u0027 || event.key \u003d\u003d\u003d \u0027ArrowRight\u0027)\n+      ) {\n+        if (event.key \u003d\u003d\u003d \u0027ArrowLeft\u0027) {\n+          selectPrevCommitIndex();\n+        } else {\n+          selectNextCommitIndex();\n+        }\n+        event.preventDefault();\n+        event.stopPropagation();\n+      }\n     }\n   });\n \ndiff --git a/packages/react-devtools-shared/src/devtools/views/Profiler/ProfilerContext.js b/packages/react-devtools-shared/src/devtools/views/Profiler/ProfilerContext.js\nindex a9225c3..d593558 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Profiler/ProfilerContext.js\n+++ b/packages/react-devtools-shared/src/devtools/views/Profiler/ProfilerContext.js\n@@ -10,7 +10,14 @@\n import type {ReactContext} from \u0027shared/ReactTypes\u0027;\n \n import * as React from \u0027react\u0027;\n-import {createContext, useCallback, useContext, useMemo, useState} from \u0027react\u0027;\n+import {\n+  createContext,\n+  useCallback,\n+  useContext,\n+  useMemo,\n+  useState,\n+  useEffect,\n+} from \u0027react\u0027;\n import {useLocalStorage, useSubscription} from \u0027../hooks\u0027;\n import {\n   TreeDispatcherContext,\n@@ -18,8 +25,9 @@ import {\n } from \u0027../Components/TreeContext\u0027;\n import {StoreContext} from \u0027../context\u0027;\n import {logEvent} from \u0027react-devtools-shared/src/Logger\u0027;\n+import {useCommitFilteringAndNavigation} from \u0027./useCommitFilteringAndNavigation\u0027;\n \n-import type {ProfilingDataFrontend} from \u0027./types\u0027;\n+import type {CommitDataFrontend, ProfilingDataFrontend} from \u0027./types\u0027;\n \n export type TabID \u003d \u0027flame-chart\u0027 | \u0027ranked-chart\u0027 | \u0027timeline\u0027;\n \n@@ -61,6 +69,12 @@ export type Context \u003d {\n   // It impacts the flame graph and ranked charts.\n   selectedCommitIndex: number | null,\n   selectCommitIndex: (value: number | null) \u003d\u003e void,\n+  selectNextCommitIndex(): void,\n+  selectPrevCommitIndex(): void,\n+\n+  // Which commits are currently filtered by duration?\n+  filteredCommitIndices: Array\u003cnumber\u003e,\n+  selectedFilteredCommitIndex: number | null,\n \n   // Which fiber is currently selected in the Ranked or Flamegraph charts?\n   selectedFiberID: number | null,\n@@ -164,6 +178,7 @@ function ProfilerContextController({children}: Props): React.Node {\n     [setRootID, selectFiber],\n   );\n \n+  // Sync rootID with profilingData changes.\n   if (prevProfilingData !\u003d\u003d profilingData) {\n     setPrevProfilingData(profilingData);\n \n@@ -189,16 +204,6 @@ function ProfilerContextController({children}: Props): React.Node {\n     }\n   }\n \n-  const [isCommitFilterEnabled, setIsCommitFilterEnabled] \u003d\n-    useLocalStorage\u003cboolean\u003e(\u0027React::DevTools::isCommitFilterEnabled\u0027, false);\n-  const [minCommitDuration, setMinCommitDuration] \u003d useLocalStorage\u003cnumber\u003e(\n-    \u0027minCommitDuration\u0027,\n-    0,\n-  );\n-\n-  const [selectedCommitIndex, selectCommitIndex] \u003d useState\u003cnumber | null\u003e(\n-    null,\n-  );\n   const [selectedTabID, selectTab] \u003d useLocalStorage\u003cTabID\u003e(\n     \u0027React::DevTools::Profiler::defaultTab\u0027,\n     \u0027flame-chart\u0027,\n@@ -212,27 +217,66 @@ function ProfilerContextController({children}: Props): React.Node {\n     },\n   );\n \n-  const startProfiling \u003d useCallback(() \u003d\u003e {\n-    logEvent({\n-      event_name: \u0027profiling-start\u0027,\n-      metadata: {current_tab: selectedTabID},\n-    });\n-    store.profilerStore.startProfiling();\n-  }, [store, selectedTabID]);\n   const stopProfiling \u003d useCallback(\n     () \u003d\u003e store.profilerStore.stopProfiling(),\n     [store],\n   );\n \n-  if (isProfiling) {\n-    if (selectedCommitIndex !\u003d\u003d null) {\n-      selectCommitIndex(null);\n+  // Get commit data for the current root\n+  // NOTE: Unlike profilerStore.getDataForRoot() which uses Suspense (throws when data unavailable),\n+  // this uses subscription pattern and returns [] when data isn\u0027t ready.\n+  // Always check didRecordCommits before using commitData or filteredCommitIndices.\n+  const commitData \u003d useMemo(() \u003d\u003e {\n+    if (!didRecordCommits || rootID \u003d\u003d\u003d null || profilingData \u003d\u003d\u003d null) {\n+      return ([]: Array\u003cCommitDataFrontend\u003e);\n     }\n-    if (selectedFiberID !\u003d\u003d null) {\n-      selectFiberID(null);\n-      selectFiberName(null);\n+    const dataForRoot \u003d profilingData.dataForRoots.get(rootID);\n+    return dataForRoot\n+      ? dataForRoot.commitData\n+      : ([]: Array\u003cCommitDataFrontend\u003e);\n+  }, [didRecordCommits, rootID, profilingData]);\n+\n+  // Commit filtering and navigation\n+  const {\n+    isCommitFilterEnabled,\n+    setIsCommitFilterEnabled,\n+    minCommitDuration,\n+    setMinCommitDuration,\n+    selectedCommitIndex,\n+    selectCommitIndex,\n+    filteredCommitIndices,\n+    selectedFilteredCommitIndex,\n+    selectNextCommitIndex,\n+    selectPrevCommitIndex,\n+  } \u003d useCommitFilteringAndNavigation(commitData);\n+\n+  const startProfiling \u003d useCallback(() \u003d\u003e {\n+    logEvent({\n+      event_name: \u0027profiling-start\u0027,\n+      metadata: {current_tab: selectedTabID},\n+    });\n+\n+    // Clear selections when starting a new profiling session\n+    selectCommitIndex(null);\n+    selectFiberID(null);\n+    selectFiberName(null);\n+\n+    store.profilerStore.startProfiling();\n+  }, [store, selectedTabID, selectCommitIndex]);\n+\n+  // Auto-select first commit when profiling data becomes available and no commit is selected.\n+  useEffect(() \u003d\u003e {\n+    if (\n+      profilingData !\u003d\u003d null \u0026\u0026\n+      selectedCommitIndex \u003d\u003d\u003d null \u0026\u0026\n+      rootID !\u003d\u003d null\n+    ) {\n+      const dataForRoot \u003d profilingData.dataForRoots.get(rootID);\n+      if (dataForRoot \u0026\u0026 dataForRoot.commitData.length \u003e 0) {\n+        selectCommitIndex(0);\n+      }\n     }\n-  }\n+  }, [profilingData, rootID, selectCommitIndex]);\n \n   const value \u003d useMemo(\n     () \u003d\u003e ({\n@@ -257,6 +301,10 @@ function ProfilerContextController({children}: Props): React.Node {\n \n       selectedCommitIndex,\n       selectCommitIndex,\n+      selectNextCommitIndex,\n+      selectPrevCommitIndex,\n+      filteredCommitIndices,\n+      selectedFilteredCommitIndex,\n \n       selectedFiberID,\n       selectedFiberName,\n@@ -275,7 +323,6 @@ function ProfilerContextController({children}: Props): React.Node {\n       supportsProfiling,\n \n       rootID,\n-      setRootID,\n       setRootIDAndClearFiber,\n \n       isCommitFilterEnabled,\n@@ -285,6 +332,10 @@ function ProfilerContextController({children}: Props): React.Node {\n \n       selectedCommitIndex,\n       selectCommitIndex,\n+      selectNextCommitIndex,\n+      selectPrevCommitIndex,\n+      filteredCommitIndices,\n+      selectedFilteredCommitIndex,\n \n       selectedFiberID,\n       selectedFiberName,\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Profiler/SnapshotSelector.js b/packages/react-devtools-shared/src/devtools/views/Profiler/SnapshotSelector.js\nindex 088ca03..0d470dd 100644\n--- a/packages/react-devtools-shared/src/devtools/views/Profiler/SnapshotSelector.js\n+++ b/packages/react-devtools-shared/src/devtools/views/Profiler/SnapshotSelector.js\n@@ -8,7 +8,7 @@\n  */\n \n import * as React from \u0027react\u0027;\n-import {Fragment, useContext, useMemo} from \u0027react\u0027;\n+import {Fragment, useContext} from \u0027react\u0027;\n import Button from \u0027../Button\u0027;\n import ButtonIcon from \u0027../ButtonIcon\u0027;\n import {ProfilerContext} from \u0027./ProfilerContext\u0027;\n@@ -22,11 +22,13 @@ export type Props \u003d {};\n \n export default function SnapshotSelector(_: Props): React.Node {\n   const {\n-    isCommitFilterEnabled,\n-    minCommitDuration,\n     rootID,\n     selectedCommitIndex,\n     selectCommitIndex,\n+    selectPrevCommitIndex,\n+    selectNextCommitIndex,\n+    filteredCommitIndices,\n+    selectedFilteredCommitIndex,\n   } \u003d useContext(ProfilerContext);\n \n   const {profilerStore} \u003d useContext(StoreContext);\n@@ -43,47 +45,8 @@ export default function SnapshotSelector(_: Props): React.Node {\n     commitTimes.push(commitDatum.timestamp);\n   });\n \n-  const filteredCommitIndices \u003d useMemo(\n-    () \u003d\u003e\n-      commitData.reduce((reduced: $FlowFixMe, commitDatum, index) \u003d\u003e {\n-        if (\n-          !isCommitFilterEnabled ||\n-          commitDatum.duration \u003e\u003d minCommitDuration\n-        ) {\n-          reduced.push(index);\n-        }\n-        return reduced;\n-      }, []),\n-    [commitData, isCommitFilterEnabled, minCommitDuration],\n-  );\n-\n   const numFilteredCommits \u003d filteredCommitIndices.length;\n \n-  // Map the (unfiltered) selected commit index to an index within the filtered data.\n-  const selectedFilteredCommitIndex \u003d useMemo(() \u003d\u003e {\n-    if (selectedCommitIndex !\u003d\u003d null) {\n-      for (let i \u003d 0; i \u003c filteredCommitIndices.length; i++) {\n-        if (filteredCommitIndices[i] \u003d\u003d\u003d selectedCommitIndex) {\n-          return i;\n-        }\n-      }\n-    }\n-    return null;\n-  }, [filteredCommitIndices, selectedCommitIndex]);\n-\n-  // TODO (ProfilerContext) This should be managed by the context controller (reducer).\n-  // It doesn\u0027t currently know about the filtered commits though (since it doesn\u0027t suspend).\n-  // Maybe this component should pass filteredCommitIndices up?\n-  if (selectedFilteredCommitIndex \u003d\u003d\u003d null) {\n-    if (numFilteredCommits \u003e 0) {\n-      selectCommitIndex(0);\n-    } else {\n-      selectCommitIndex(null);\n-    }\n-  } else if (selectedFilteredCommitIndex \u003e\u003d numFilteredCommits) {\n-    selectCommitIndex(numFilteredCommits \u003d\u003d\u003d 0 ? null : numFilteredCommits - 1);\n-  }\n-\n   let label \u003d null;\n   if (numFilteredCommits \u003e 0) {\n     // $FlowFixMe[missing-local-annot]\n@@ -110,11 +73,11 @@ export default function SnapshotSelector(_: Props): React.Node {\n     const handleKeyDown \u003d event \u003d\u003e {\n       switch (event.key) {\n         case \u0027ArrowDown\u0027:\n-          viewPrevCommit();\n+          selectPrevCommitIndex();\n           event.stopPropagation();\n           break;\n         case \u0027ArrowUp\u0027:\n-          viewNextCommit();\n+          selectNextCommitIndex();\n           event.stopPropagation();\n           break;\n         default:\n@@ -147,30 +110,15 @@ export default function SnapshotSelector(_: Props): React.Node {\n     );\n   }\n \n-  const viewNextCommit \u003d () \u003d\u003e {\n-    let nextCommitIndex \u003d ((selectedFilteredCommitIndex: any): number) + 1;\n-    if (nextCommitIndex \u003d\u003d\u003d filteredCommitIndices.length) {\n-      nextCommitIndex \u003d 0;\n-    }\n-    selectCommitIndex(filteredCommitIndices[nextCommitIndex]);\n-  };\n-  const viewPrevCommit \u003d () \u003d\u003e {\n-    let nextCommitIndex \u003d ((selectedFilteredCommitIndex: any): number) - 1;\n-    if (nextCommitIndex \u003c 0) {\n-      nextCommitIndex \u003d filteredCommitIndices.length - 1;\n-    }\n-    selectCommitIndex(filteredCommitIndices[nextCommitIndex]);\n-  };\n-\n   // $FlowFixMe[missing-local-annot]\n   const handleKeyDown \u003d event \u003d\u003e {\n     switch (event.key) {\n       case \u0027ArrowLeft\u0027:\n-        viewPrevCommit();\n+        selectPrevCommitIndex();\n         event.stopPropagation();\n         break;\n       case \u0027ArrowRight\u0027:\n-        viewNextCommit();\n+        selectNextCommitIndex();\n         event.stopPropagation();\n         break;\n       default:\n@@ -193,8 +141,8 @@ export default function SnapshotSelector(_: Props): React.Node {\n         className\u003d{styles.Button}\n         data-testname\u003d\"SnapshotSelector-PreviousButton\"\n         disabled\u003d{numFilteredCommits \u003d\u003d\u003d 0}\n-        onClick\u003d{viewPrevCommit}\n-        title\u003d\"Select previous commit\"\u003e\n+        onClick\u003d{selectPrevCommitIndex}\n+        title\u003d\"Select previous commit ←\"\u003e\n         \u003cButtonIcon type\u003d\"previous\" /\u003e\n       \u003c/Button\u003e\n       \u003cdiv\n@@ -227,8 +175,8 @@ export default function SnapshotSelector(_: Props): React.Node {\n         className\u003d{styles.Button}\n         data-testname\u003d\"SnapshotSelector-NextButton\"\n         disabled\u003d{numFilteredCommits \u003d\u003d\u003d 0}\n-        onClick\u003d{viewNextCommit}\n-        title\u003d\"Select next commit\"\u003e\n+        onClick\u003d{selectNextCommitIndex}\n+        title\u003d\"Select next commit →\"\u003e\n         \u003cButtonIcon type\u003d\"next\" /\u003e\n       \u003c/Button\u003e\n     \u003c/Fragment\u003e\ndiff --git a/packages/react-devtools-shared/src/devtools/views/Profiler/useCommitFilteringAndNavigation.js b/packages/react-devtools-shared/src/devtools/views/Profiler/useCommitFilteringAndNavigation.js\nnew file mode 100644\nindex 0000000..e309e6a\n--- /dev/null\n+++ b/packages/react-devtools-shared/src/devtools/views/Profiler/useCommitFilteringAndNavigation.js\n@@ -0,0 +1,199 @@\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ *\n+ * @flow\n+ */\n+\n+import {useCallback, useMemo, useState} from \u0027react\u0027;\n+import {useLocalStorage} from \u0027../hooks\u0027;\n+\n+import type {CommitDataFrontend} from \u0027./types\u0027;\n+\n+export type CommitFilteringAndNavigation \u003d {\n+  isCommitFilterEnabled: boolean,\n+  setIsCommitFilterEnabled: (value: boolean) \u003d\u003e void,\n+  minCommitDuration: number,\n+  setMinCommitDuration: (value: number) \u003d\u003e void,\n+\n+  // Selection state\n+  selectedCommitIndex: number | null,\n+  selectCommitIndex: (value: number | null) \u003d\u003e void,\n+\n+  // Filtered data\n+  filteredCommitIndices: Array\u003cnumber\u003e,\n+  selectedFilteredCommitIndex: number | null,\n+\n+  // Navigation\n+  selectNextCommitIndex: () \u003d\u003e void,\n+  selectPrevCommitIndex: () \u003d\u003e void,\n+};\n+\n+export function useCommitFilteringAndNavigation(\n+  commitData: Array\u003cCommitDataFrontend\u003e,\n+): CommitFilteringAndNavigation {\n+  // Filter settings persisted to localStorage\n+  const [isCommitFilterEnabled, setIsCommitFilterEnabledValue] \u003d\n+    useLocalStorage\u003cboolean\u003e(\u0027React::DevTools::isCommitFilterEnabled\u0027, false);\n+  const [minCommitDuration, setMinCommitDurationValue] \u003d\n+    useLocalStorage\u003cnumber\u003e(\u0027minCommitDuration\u0027, 0);\n+\n+  // Currently selected commit index (in the unfiltered list)\n+  const [selectedCommitIndex, selectCommitIndex] \u003d useState\u003cnumber | null\u003e(\n+    null,\n+  );\n+\n+  const calculateFilteredIndices \u003d useCallback(\n+    (enabled: boolean, minDuration: number): Array\u003cnumber\u003e \u003d\u003e {\n+      return commitData.reduce((reduced: Array\u003cnumber\u003e, commitDatum, index) \u003d\u003e {\n+        if (!enabled || commitDatum.duration \u003e\u003d minDuration) {\n+          reduced.push(index);\n+        }\n+        return reduced;\n+      }, ([]: Array\u003cnumber\u003e));\n+    },\n+    [commitData],\n+  );\n+\n+  const findFilteredIndex \u003d useCallback(\n+    (commitIndex: number | null, filtered: Array\u003cnumber\u003e): number | null \u003d\u003e {\n+      if (commitIndex \u003d\u003d\u003d null) return null;\n+      for (let i \u003d 0; i \u003c filtered.length; i++) {\n+        if (filtered[i] \u003d\u003d\u003d commitIndex) {\n+          return i;\n+        }\n+      }\n+      return null;\n+    },\n+    [],\n+  );\n+\n+  // Adjust selection when filter settings change to keep a valid selection\n+  const adjustSelectionAfterFilterChange \u003d useCallback(\n+    (newFilteredIndices: Array\u003cnumber\u003e) \u003d\u003e {\n+      const currentSelectedIndex \u003d selectedCommitIndex;\n+      const selectedFilteredIndex \u003d findFilteredIndex(\n+        currentSelectedIndex,\n+        newFilteredIndices,\n+      );\n+\n+      if (newFilteredIndices.length \u003d\u003d\u003d 0) {\n+        // No commits pass the filter - clear selection\n+        selectCommitIndex(null);\n+      } else if (currentSelectedIndex \u003d\u003d\u003d null) {\n+        // No commit was selected - select first available\n+        selectCommitIndex(newFilteredIndices[0]);\n+      } else if (selectedFilteredIndex \u003d\u003d\u003d null) {\n+        // Currently selected commit was filtered out - find closest commit before it\n+        let closestBefore \u003d null;\n+        for (let i \u003d newFilteredIndices.length - 1; i \u003e\u003d 0; i--) {\n+          if (newFilteredIndices[i] \u003c currentSelectedIndex) {\n+            closestBefore \u003d newFilteredIndices[i];\n+            break;\n+          }\n+        }\n+        // If no commit before it, use the first available\n+        selectCommitIndex(\n+          closestBefore !\u003d\u003d null ? closestBefore : newFilteredIndices[0],\n+        );\n+      } else if (selectedFilteredIndex \u003e\u003d newFilteredIndices.length) {\n+        // Filtered position is out of bounds - clamp to last available\n+        selectCommitIndex(newFilteredIndices[newFilteredIndices.length - 1]);\n+      }\n+      // Otherwise, the current selection is still valid in the filtered list, keep it\n+    },\n+    [findFilteredIndex, selectedCommitIndex, selectCommitIndex],\n+  );\n+\n+  const filteredCommitIndices \u003d useMemo(\n+    () \u003d\u003e calculateFilteredIndices(isCommitFilterEnabled, minCommitDuration),\n+    [calculateFilteredIndices, isCommitFilterEnabled, minCommitDuration],\n+  );\n+\n+  const selectedFilteredCommitIndex \u003d useMemo(\n+    () \u003d\u003e findFilteredIndex(selectedCommitIndex, filteredCommitIndices),\n+    [findFilteredIndex, selectedCommitIndex, filteredCommitIndices],\n+  );\n+\n+  const selectNextCommitIndex \u003d useCallback(() \u003d\u003e {\n+    if (\n+      selectedFilteredCommitIndex \u003d\u003d\u003d null ||\n+      filteredCommitIndices.length \u003d\u003d\u003d 0\n+    ) {\n+      return;\n+    }\n+    let nextCommitIndex \u003d selectedFilteredCommitIndex + 1;\n+    if (nextCommitIndex \u003d\u003d\u003d filteredCommitIndices.length) {\n+      nextCommitIndex \u003d 0;\n+    }\n+    selectCommitIndex(filteredCommitIndices[nextCommitIndex]);\n+  }, [selectedFilteredCommitIndex, filteredCommitIndices, selectCommitIndex]);\n+\n+  const selectPrevCommitIndex \u003d useCallback(() \u003d\u003e {\n+    if (\n+      selectedFilteredCommitIndex \u003d\u003d\u003d null ||\n+      filteredCommitIndices.length \u003d\u003d\u003d 0\n+    ) {\n+      return;\n+    }\n+    let prevCommitIndex \u003d selectedFilteredCommitIndex - 1;\n+    if (prevCommitIndex \u003c 0) {\n+      prevCommitIndex \u003d filteredCommitIndices.length - 1;\n+    }\n+    selectCommitIndex(filteredCommitIndices[prevCommitIndex]);\n+  }, [selectedFilteredCommitIndex, filteredCommitIndices, selectCommitIndex]);\n+\n+  // Setters that also adjust selection when filter changes\n+  const setIsCommitFilterEnabled \u003d useCallback(\n+    (value: boolean) \u003d\u003e {\n+      setIsCommitFilterEnabledValue(value);\n+\n+      const newFilteredIndices \u003d calculateFilteredIndices(\n+        value,\n+        minCommitDuration,\n+      );\n+\n+      adjustSelectionAfterFilterChange(newFilteredIndices);\n+    },\n+    [\n+      setIsCommitFilterEnabledValue,\n+      calculateFilteredIndices,\n+      minCommitDuration,\n+      adjustSelectionAfterFilterChange,\n+    ],\n+  );\n+\n+  const setMinCommitDuration \u003d useCallback(\n+    (value: number) \u003d\u003e {\n+      setMinCommitDurationValue(value);\n+\n+      const newFilteredIndices \u003d calculateFilteredIndices(\n+        isCommitFilterEnabled,\n+        value,\n+      );\n+\n+      adjustSelectionAfterFilterChange(newFilteredIndices);\n+    },\n+    [\n+      setMinCommitDurationValue,\n+      calculateFilteredIndices,\n+      isCommitFilterEnabled,\n+      adjustSelectionAfterFilterChange,\n+    ],\n+  );\n+\n+  return {\n+    isCommitFilterEnabled,\n+    setIsCommitFilterEnabled,\n+    minCommitDuration,\n+    setMinCommitDuration,\n+    selectedCommitIndex,\n+    selectCommitIndex,\n+    filteredCommitIndices,\n+    selectedFilteredCommitIndex,\n+    selectNextCommitIndex,\n+    selectPrevCommitIndex,\n+  };\n+}","expectedMessage":"[Devtools] Navigating commits performance panel hotkey (#35238)","repository":"react","commitHash":"d763f3131e689d077a93fd45c1fdf220be796279","metadata":{"author":"emily8rown \u003cemilybrown02b28@gmail.com\u003e"}}
{"id":"react-734f1bf1","diff":" packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts | 3 +++\n 1 file changed, 3 insertions(+)\n\ndiff --git a/packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts b/packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts\nindex f206249..1cf08cb 100644\n--- a/packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts\n+++ b/packages/eslint-plugin-react-hooks/src/shared/RunReactCompiler.ts\n@@ -39,6 +39,9 @@ const COMPILER_OPTIONS: PluginOptions \u003d {\n     validateNoCapitalizedCalls: [],\n     validateHooksUsage: true,\n     validateNoDerivedComputationsInEffects: true,\n+    // Temporarily enabled for internal testing\n+    enableUseKeyedState: true,\n+    enableVerboseNoSetStateInEffect: true,\n   },\n };\n ","expectedMessage":"[eprh] Enable enableUseKeyedState and enableVerboseNoSetStateInEffect (#35338)","repository":"react","commitHash":"734f1bf1ac2a065f9ae9c74b94560b2b5239bee7","metadata":{"author":"lauren \u003cpoteto@users.noreply.github.com\u003e"}}
{"id":"react-61331f3c","diff":" .../src/client/ReactFiberConfigDOM.js              | 39 ++++++++++------------\n 1 file changed, 17 insertions(+), 22 deletions(-)\n\ndiff --git a/packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js b/packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js\nindex e4c45cc..66e4696 100644\n--- a/packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js\n+++ b/packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js\n@@ -1996,26 +1996,6 @@ export function hasInstanceAffectedParent(\n   return oldRect.height !\u003d\u003d newRect.height || oldRect.width !\u003d\u003d newRect.width;\n }\n \n-function cancelAllViewTransitionAnimations(scope: Element) {\n-  // In Safari, we need to manually cancel all manually start animations\n-  // or it\u0027ll block or interfer with future transitions.\n-  // $FlowFixMe[prop-missing]\n-  const animations \u003d scope.getAnimations({subtree: true});\n-  for (let i \u003d 0; i \u003c animations.length; i++) {\n-    const anim \u003d animations[i];\n-    const effect: KeyframeEffect \u003d (anim.effect: any);\n-    // $FlowFixMe\n-    const pseudo: ?string \u003d effect.pseudoElement;\n-    if (\n-      pseudo !\u003d null \u0026\u0026\n-      pseudo.startsWith(\u0027::view-transition\u0027) \u0026\u0026\n-      effect.target \u003d\u003d\u003d scope\n-    ) {\n-      anim.cancel();\n-    }\n-  }\n-}\n-\n // How long to wait for new fonts to load before just committing anyway.\n // This freezes the screen. It needs to be short enough that it doesn\u0027t cause too much of\n // an issue when it\u0027s a new load and slow, yet long enough that you have a chance to load\n@@ -2210,6 +2190,8 @@ export function startViewTransition(\n     // $FlowFixMe[prop-missing]\n     ownerDocument.__reactViewTransition \u003d transition;\n \n+    const viewTransitionAnimations: Array\u003cAnimation\u003e \u003d [];\n+\n     const readyCallback \u003d () \u003d\u003e {\n       const documentElement: Element \u003d (ownerDocument.documentElement: any);\n       // Loop through all View Transition Animations.\n@@ -2224,6 +2206,7 @@ export function startViewTransition(\n           pseudoElement !\u003d null \u0026\u0026\n           pseudoElement.startsWith(\u0027::view-transition\u0027)\n         ) {\n+          viewTransitionAnimations.push(animation);\n           const keyframes \u003d effect.getKeyframes();\n           // Next, we\u0027re going to try to optimize this animation in case the auto-generated\n           // width/height keyframes are unnecessary.\n@@ -2315,7 +2298,12 @@ export function startViewTransition(\n     };\n     transition.ready.then(readyCallback, handleError);\n     transition.finished.finally(() \u003d\u003e {\n-      cancelAllViewTransitionAnimations((ownerDocument.documentElement: any));\n+      for (let i \u003d 0; i \u003c viewTransitionAnimations.length; i++) {\n+        // In Safari, we need to manually cancel all manually started animations\n+        // or it\u0027ll block or interfer with future transitions.\n+        // We can\u0027t use getAnimations() due to #35336 so we collect them in an array.\n+        viewTransitionAnimations[i].cancel();\n+      }\n       // $FlowFixMe[prop-missing]\n       if (ownerDocument.__reactViewTransition \u003d\u003d\u003d transition) {\n         // $FlowFixMe[prop-missing]\n@@ -2549,6 +2537,7 @@ export function startGestureTransition(\n     // $FlowFixMe[prop-missing]\n     ownerDocument.__reactViewTransition \u003d transition;\n     const customTimelineCleanup: Array\u003c() \u003d\u003e void\u003e \u003d []; // Cleanup Animations started in a CustomTimeline\n+    const viewTransitionAnimations: Array\u003cAnimation\u003e \u003d [];\n     const readyCallback \u003d () \u003d\u003e {\n       const documentElement: Element \u003d (ownerDocument.documentElement: any);\n       // Loop through all View Transition Animations.\n@@ -2566,6 +2555,7 @@ export function startGestureTransition(\n         const pseudoElement: ?string \u003d effect.pseudoElement;\n         if (pseudoElement \u003d\u003d null) {\n         } else if (pseudoElement.startsWith(\u0027::view-transition\u0027)) {\n+          viewTransitionAnimations.push(animations[i]);\n           const timing \u003d effect.getTiming();\n           const duration \u003d\n             // $FlowFixMe[prop-missing]\n@@ -2743,7 +2733,12 @@ export function startGestureTransition(\n     };\n     transition.ready.then(readyForAnimations, handleError);\n     transition.finished.finally(() \u003d\u003e {\n-      cancelAllViewTransitionAnimations((ownerDocument.documentElement: any));\n+      for (let i \u003d 0; i \u003c viewTransitionAnimations.length; i++) {\n+        // In Safari, we need to manually cancel all manually started animations\n+        // or it\u0027ll block or interfer with future transitions.\n+        // We can\u0027t use getAnimations() due to #35336 so we collect them in an array.\n+        viewTransitionAnimations[i].cancel();\n+      }\n       for (let i \u003d 0; i \u003c customTimelineCleanup.length; i++) {\n         const cleanup \u003d customTimelineCleanup[i];\n         cleanup();","expectedMessage":"Fix ViewTransition crash in Mobile Safari (#35337)","repository":"react","commitHash":"61331f3c9e9ea93d866273567d38e23ef4bc4c5b","metadata":{"author":"dan \u003cdan.abramov@me.com\u003e"}}
{"id":"react-55480b4d","diff":" compiler/apps/playground/.gitignore                |   1 +\n .../playground/components/Editor/ConfigEditor.tsx  |  25 +++--\n compiler/apps/playground/next-env.d.ts             |   6 --\n compiler/apps/playground/package.json              |   2 +-\n compiler/apps/playground/tsconfig.json             |   2 +-\n compiler/apps/playground/yarn.lock                 | 112 ++++++++++-----------\n 6 files changed, 77 insertions(+), 71 deletions(-)\n\ndiff --git a/compiler/apps/playground/.gitignore b/compiler/apps/playground/.gitignore\nindex 2d1f4fd..38f7fe0 100644\n--- a/compiler/apps/playground/.gitignore\n+++ b/compiler/apps/playground/.gitignore\n@@ -12,6 +12,7 @@\n # next.js\n /.next/\n /out/\n+/next-env.d.ts\n \n # production\n /build\ndiff --git a/compiler/apps/playground/components/Editor/ConfigEditor.tsx b/compiler/apps/playground/components/Editor/ConfigEditor.tsx\nindex cf80b48..e78ff35 100644\n--- a/compiler/apps/playground/components/Editor/ConfigEditor.tsx\n+++ b/compiler/apps/playground/components/Editor/ConfigEditor.tsx\n@@ -14,7 +14,6 @@ import React, {\n   unstable_ViewTransition as ViewTransition,\n   unstable_addTransitionType as addTransitionType,\n   startTransition,\n-  Activity,\n } from \u0027react\u0027;\n import {Resizable} from \u0027re-resizable\u0027;\n import {useStore, useStoreDispatch} from \u0027../StoreContext\u0027;\n@@ -34,9 +33,14 @@ export default function ConfigEditor({\n }): React.ReactElement {\n   const [isExpanded, setIsExpanded] \u003d useState(false);\n \n+  // TODO: Add back \u003cActivity\u003e after upgrading next.js\n   return (\n     \u003c\u003e\n-      \u003cActivity mode\u003d{isExpanded ? \u0027visible\u0027 : \u0027hidden\u0027}\u003e\n+      \u003cdiv\n+        style\u003d{{\n+          display: isExpanded ? \u0027block\u0027 : \u0027none\u0027,\n+        }}\u003e\n+        {/* \u003cActivity mode\u003d{isExpanded ? \u0027visible\u0027 : \u0027hidden\u0027}\u003e */}\n         \u003cExpandedEditor\n           onToggle\u003d{() \u003d\u003e {\n             startTransition(() \u003d\u003e {\n@@ -46,8 +50,13 @@ export default function ConfigEditor({\n           }}\n           formattedAppliedConfig\u003d{formattedAppliedConfig}\n         /\u003e\n-      \u003c/Activity\u003e\n-      \u003cActivity mode\u003d{isExpanded ? \u0027hidden\u0027 : \u0027visible\u0027}\u003e\n+      \u003c/div\u003e\n+      \u003cdiv\n+        style\u003d{{\n+          display: !isExpanded ? \u0027block\u0027 : \u0027none\u0027,\n+        }}\u003e\n+        {/* \u003c/Activity\u003e\n+        \u003cActivity mode\u003d{isExpanded ? \u0027hidden\u0027 : \u0027visible\u0027}\u003e\u003c/Activity\u003e */}\n         \u003cCollapsedEditor\n           onToggle\u003d{() \u003d\u003e {\n             startTransition(() \u003d\u003e {\n@@ -56,7 +65,8 @@ export default function ConfigEditor({\n             });\n           }}\n         /\u003e\n-      \u003c/Activity\u003e\n+      \u003c/div\u003e\n+      {/* \u003c/Activity\u003e */}\n     \u003c/\u003e\n   );\n }\n@@ -116,8 +126,9 @@ function ExpandedEditor({\n \n   return (\n     \u003cViewTransition\n-      enter\u003d{{[CONFIG_PANEL_TRANSITION]: \u0027slide-in\u0027, default: \u0027none\u0027}}\n-      exit\u003d{{[CONFIG_PANEL_TRANSITION]: \u0027slide-out\u0027, default: \u0027none\u0027}}\u003e\n+      update\u003d{{[CONFIG_PANEL_TRANSITION]: \u0027slide-in\u0027, default: \u0027none\u0027}}\u003e\n+      {/* enter\u003d{{[CONFIG_PANEL_TRANSITION]: \u0027slide-in\u0027, default: \u0027none\u0027}}\n+      exit\u003d{{[CONFIG_PANEL_TRANSITION]: \u0027slide-out\u0027, default: \u0027none\u0027}}\u003e */}\n       \u003cResizable\n         minWidth\u003d{300}\n         maxWidth\u003d{600}\ndiff --git a/compiler/apps/playground/next-env.d.ts b/compiler/apps/playground/next-env.d.ts\ndeleted file mode 100644\nindex 9edff1c..0000000\n--- a/compiler/apps/playground/next-env.d.ts\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-/// \u003creference types\u003d\"next\" /\u003e\n-/// \u003creference types\u003d\"next/image-types/global\" /\u003e\n-import \"./.next/types/routes.d.ts\";\n-\n-// NOTE: This file should not be edited\n-// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.\ndiff --git a/compiler/apps/playground/package.json b/compiler/apps/playground/package.json\nindex 23b192f..e92826c 100644\n--- a/compiler/apps/playground/package.json\n+++ b/compiler/apps/playground/package.json\n@@ -35,7 +35,7 @@\n     \"lru-cache\": \"^11.2.2\",\n     \"lz-string\": \"^1.5.0\",\n     \"monaco-editor\": \"^0.52.0\",\n-    \"next\": \"15.6.0-canary.7\",\n+    \"next\": \"15.5.7\",\n     \"notistack\": \"^3.0.0-alpha.7\",\n     \"prettier\": \"^3.3.3\",\n     \"pretty-format\": \"^29.3.1\",\ndiff --git a/compiler/apps/playground/tsconfig.json b/compiler/apps/playground/tsconfig.json\nindex 4f70dce..1ead55c 100644\n--- a/compiler/apps/playground/tsconfig.json\n+++ b/compiler/apps/playground/tsconfig.json\n@@ -19,7 +19,7 @@\n     \"moduleResolution\": \"node\",\n     \"resolveJsonModule\": true,\n     \"isolatedModules\": true,\n-    \"jsx\": \"react-jsx\",\n+    \"jsx\": \"preserve\",\n     \"incremental\": true,\n     \"plugins\": [\n       {\ndiff --git a/compiler/apps/playground/yarn.lock b/compiler/apps/playground/yarn.lock\nindex 42e8deb..ce4928e 100644\n--- a/compiler/apps/playground/yarn.lock\n+++ b/compiler/apps/playground/yarn.lock\n@@ -715,10 +715,10 @@\n   dependencies:\n     \"@monaco-editor/loader\" \"^1.6.1\"\n \n-\"@next/env@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/env/-/env-15.6.0-canary.7.tgz#cdbf2967a9437ef09eef755e203f315acc4d8d8f\"\n-  integrity sha512-LNZ7Yd3Cl9rKvjYdeJmszf2HmSDP76SQmfafKep2Ux16ZXKoN5OjwVHFTltKNdsB3vt2t+XJzLP2rhw5lBoFBA\u003d\u003d\n+\"@next/env@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/env/-/env-15.5.7.tgz#4168db34ae3bc9fd9ad3b951d327f4cfc38d4362\"\n+  integrity sha512-4h6Y2NyEkIEN7Z8YxkA27pq6zTkS09bUSYC0xjd0NpwFxjnIKeZEeH591o5WECSmjpUhLn3H2QLJcDye3Uzcvg\u003d\u003d\n \n \"@next/eslint-plugin-next@15.5.2\":\n   version \"15.5.2\"\n@@ -727,45 +727,45 @@\n   dependencies:\n     fast-glob \"3.3.1\"\n \n-\"@next/swc-darwin-arm64@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/swc-darwin-arm64/-/swc-darwin-arm64-15.6.0-canary.7.tgz#628cd34ce9120000f1cb5b08963426431174fc57\"\n-  integrity sha512-POsBrxhrR3qvqXV+JZ6ZoBc8gJf8rhYe+OedceI1piPVqtJYOJa3EB4eaqcc+kMsllKRrH/goNlhLwtyhE+0Qg\u003d\u003d\n-\n-\"@next/swc-darwin-x64@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/swc-darwin-x64/-/swc-darwin-x64-15.6.0-canary.7.tgz#37d4ebab14da74a2f8028daf6d76aab410153e06\"\n-  integrity sha512-lmk9ysBuSiPlAJZTCo/3O4mXNFosg6EDIf4GrmynIwCG2as6/KxzyD1WqFp56Exp8eFDjP7SFapD10sV43vCsA\u003d\u003d\n-\n-\"@next/swc-linux-arm64-gnu@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/swc-linux-arm64-gnu/-/swc-linux-arm64-gnu-15.6.0-canary.7.tgz#ce700cc0e0d24763136838223105a524b36694fa\"\n-  integrity sha512-why8k6d0SBm3AKoOD5S7ir3g+BF34l9oFKIoZrLaZaKBvNGpFcjc7Ovc2TunNMeaMJzv9k1dHYSap0EI5oSuzg\u003d\u003d\n-\n-\"@next/swc-linux-arm64-musl@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/swc-linux-arm64-musl/-/swc-linux-arm64-musl-15.6.0-canary.7.tgz#c791b8e15bf2c338b4cc0387fe7afb3ef83ecfcf\"\n-  integrity sha512-HzvTRsKvYj32Va4YuJN3n3xOxvk+6QwB63d/EsgmdkeA/vrqciUAmJDYpuzZEvRc3Yp2nyPq8KZxtHAr6ISZ2Q\u003d\u003d\n-\n-\"@next/swc-linux-x64-gnu@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/swc-linux-x64-gnu/-/swc-linux-x64-gnu-15.6.0-canary.7.tgz#c01c3a3d8e71660c49298dd053d078379b6b5919\"\n-  integrity sha512-6yRFrg2qWXOqa+1BI53J9EmHWFzKg9U2r+5R7n7BFUp8PH5SC92WBsmYTnh/RkvAYvdupiVzMervwwswCs6kFg\u003d\u003d\n-\n-\"@next/swc-linux-x64-musl@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/swc-linux-x64-musl/-/swc-linux-x64-musl-15.6.0-canary.7.tgz#3f4b39faef4a5f88b13e4c726b008ddc9717f819\"\n-  integrity sha512-O/JjvOvNK/Wao/OIQaA6evDkxkmFFQgJ1/hI1dVk6/PAeKmW2/Q+6Dodh97eAkOwedS1ZdQl2mojf87TzLvzdQ\u003d\u003d\n-\n-\"@next/swc-win32-arm64-msvc@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/swc-win32-arm64-msvc/-/swc-win32-arm64-msvc-15.6.0-canary.7.tgz#9bc5da0907b7ce67eedda02a6d56a09d9a539ccf\"\n-  integrity sha512-p9DvrDgnePofZCtiWVY7qZtwXxiOGJlAyy2LoGPYSGOUDhjbTG8j6XMUFXpV9UwpH+l7st522psO1BVzbpT8IQ\u003d\u003d\n-\n-\"@next/swc-win32-x64-msvc@15.6.0-canary.7\":\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/@next/swc-win32-x64-msvc/-/swc-win32-x64-msvc-15.6.0-canary.7.tgz#5b271c591ccbe67d5fa966dd22db86c547414fd1\"\n-  integrity sha512-f1ywT3xWu4StWKA1mZRyGfelu/h+W0OEEyBxQNXzXyYa0VGZb9LyCNb5cYoNKBm0Bw18Hp1PVe0bHuusemGCcw\u003d\u003d\n+\"@next/swc-darwin-arm64@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/swc-darwin-arm64/-/swc-darwin-arm64-15.5.7.tgz#f0c9ccfec2cd87cbd4b241ce4c779a7017aed958\"\n+  integrity sha512-IZwtxCEpI91HVU/rAUOOobWSZv4P2DeTtNaCdHqLcTJU4wdNXgAySvKa/qJCgR5m6KI8UsKDXtO2B31jcaw1Yw\u003d\u003d\n+\n+\"@next/swc-darwin-x64@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/swc-darwin-x64/-/swc-darwin-x64-15.5.7.tgz#18009e9fcffc5c0687cc9db24182ddeac56280d9\"\n+  integrity sha512-UP6CaDBcqaCBuiq/gfCEJw7sPEoX1aIjZHnBWN9v9qYHQdMKvCKcAVs4OX1vIjeE+tC5EIuwDTVIoXpUes29lg\u003d\u003d\n+\n+\"@next/swc-linux-arm64-gnu@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/swc-linux-arm64-gnu/-/swc-linux-arm64-gnu-15.5.7.tgz#fe7c7e08264cf522d4e524299f6d3e63d68d579a\"\n+  integrity sha512-NCslw3GrNIw7OgmRBxHtdWFQYhexoUCq+0oS2ccjyYLtcn1SzGzeM54jpTFonIMUjNbHmpKpziXnpxhSWLcmBA\u003d\u003d\n+\n+\"@next/swc-linux-arm64-musl@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/swc-linux-arm64-musl/-/swc-linux-arm64-musl-15.5.7.tgz#94228fe293475ec34a5a54284e1056876f43a3cf\"\n+  integrity sha512-nfymt+SE5cvtTrG9u1wdoxBr9bVB7mtKTcj0ltRn6gkP/2Nu1zM5ei8rwP9qKQP0Y//umK+TtkKgNtfboBxRrw\u003d\u003d\n+\n+\"@next/swc-linux-x64-gnu@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/swc-linux-x64-gnu/-/swc-linux-x64-gnu-15.5.7.tgz#078c71201dfe7fcfb8fa6dc92aae6c94bc011cdc\"\n+  integrity sha512-hvXcZvCaaEbCZcVzcY7E1uXN9xWZfFvkNHwbe/n4OkRhFWrs1J1QV+4U1BN06tXLdaS4DazEGXwgqnu/VMcmqw\u003d\u003d\n+\n+\"@next/swc-linux-x64-musl@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/swc-linux-x64-musl/-/swc-linux-x64-musl-15.5.7.tgz#72947f5357f9226292353e0bb775643da3c7a182\"\n+  integrity sha512-4IUO539b8FmF0odY6/SqANJdgwn1xs1GkPO5doZugwZ3ETF6JUdckk7RGmsfSf7ws8Qb2YB5It33mvNL/0acqA\u003d\u003d\n+\n+\"@next/swc-win32-arm64-msvc@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/swc-win32-arm64-msvc/-/swc-win32-arm64-msvc-15.5.7.tgz#397b912cd51c6a80e32b9c0507ecd82514353941\"\n+  integrity sha512-CpJVTkYI3ZajQkC5vajM7/ApKJUOlm6uP4BknM3XKvJ7VXAvCqSjSLmM0LKdYzn6nBJVSjdclx8nYJSa3xlTgQ\u003d\u003d\n+\n+\"@next/swc-win32-x64-msvc@15.5.7\":\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/@next/swc-win32-x64-msvc/-/swc-win32-x64-msvc-15.5.7.tgz#e02b543d9dc6c1631d4ac239cb1177245dfedfe4\"\n+  integrity sha512-gMzgBX164I6DN+9/PGA+9dQiwmTkE4TloBNx8Kv9UiGARsr9Nba7IpcBRA1iTV9vwlYnrE3Uy6I7Aj6qLjQuqw\u003d\u003d\n \n \"@nodelib/fs.scandir@2.1.5\":\n   version \"2.1.5\"\n@@ -3204,25 +3204,25 @@ natural-compare@^1.4.0:\n   resolved \"https://registry.yarnpkg.com/natural-compare/-/natural-compare-1.4.0.tgz#4abebfeed7541f2c27acfb29bdbbd15c8d5ba4f7\"\n   integrity sha512-OWND8ei3VtNC9h7V60qff3SVobHr996CTwgxubgyQYEpg290h9J0buyECNNJexkFm5sOajh5G116RYA1c8ZMSw\u003d\u003d\n \n-next@15.6.0-canary.7:\n-  version \"15.6.0-canary.7\"\n-  resolved \"https://registry.yarnpkg.com/next/-/next-15.6.0-canary.7.tgz#bfc2ac3c9a78e23d550c303d18247a263e6b5bc1\"\n-  integrity sha512-4ukX2mxat9wWT6E0Gw/3TOR9ULV1q399E42F86cwsPSFgTWa04ABhcTqO0r9J/QR1YWPR8WEgh9qUzmWA/1yEw\u003d\u003d\n+next@15.5.7:\n+  version \"15.5.7\"\n+  resolved \"https://registry.yarnpkg.com/next/-/next-15.5.7.tgz#4507700b2bbcaf2c9fb7a9ad25c0dac2ba4a9a75\"\n+  integrity sha512-+t2/0jIJ48kUpGKkdlhgkv+zPTEOoXyr60qXe68eB/pl3CMJaLeIGjzp5D6Oqt25hCBiBTt8wEeeAzfJvUKnPQ\u003d\u003d\n   dependencies:\n-    \"@next/env\" \"15.6.0-canary.7\"\n+    \"@next/env\" \"15.5.7\"\n     \"@swc/helpers\" \"0.5.15\"\n     caniuse-lite \"^1.0.30001579\"\n     postcss \"8.4.31\"\n     styled-jsx \"5.1.6\"\n   optionalDependencies:\n-    \"@next/swc-darwin-arm64\" \"15.6.0-canary.7\"\n-    \"@next/swc-darwin-x64\" \"15.6.0-canary.7\"\n-    \"@next/swc-linux-arm64-gnu\" \"15.6.0-canary.7\"\n-    \"@next/swc-linux-arm64-musl\" \"15.6.0-canary.7\"\n-    \"@next/swc-linux-x64-gnu\" \"15.6.0-canary.7\"\n-    \"@next/swc-linux-x64-musl\" \"15.6.0-canary.7\"\n-    \"@next/swc-win32-arm64-msvc\" \"15.6.0-canary.7\"\n-    \"@next/swc-win32-x64-msvc\" \"15.6.0-canary.7\"\n+    \"@next/swc-darwin-arm64\" \"15.5.7\"\n+    \"@next/swc-darwin-x64\" \"15.5.7\"\n+    \"@next/swc-linux-arm64-gnu\" \"15.5.7\"\n+    \"@next/swc-linux-arm64-musl\" \"15.5.7\"\n+    \"@next/swc-linux-x64-gnu\" \"15.5.7\"\n+    \"@next/swc-linux-x64-musl\" \"15.5.7\"\n+    \"@next/swc-win32-arm64-msvc\" \"15.5.7\"\n+    \"@next/swc-win32-x64-msvc\" \"15.5.7\"\n     sharp \"^0.34.3\"\n \n node-releases@^2.0.18:","expectedMessage":"[playground] Downgrade Next.js to a secure version (#35317)","repository":"react","commitHash":"55480b4d228986e502f4651f8e53a6f264a1858e","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-3640f38a","diff":" .../src/CompilerError.ts                           |  4 +-\n .../src/HIR/Environment.ts                         | 10 +++\n .../src/Validation/ValidateNoSetStateInEffects.ts  | 72 +++++++++++-----\n ...state-in-effect-verbose-derived-event.expect.md | 74 +++++++++++++++++\n ...id-set-state-in-effect-verbose-derived-event.js | 18 ++++\n ...-state-in-effect-verbose-force-update.expect.md | 97 ++++++++++++++++++++++\n ...lid-set-state-in-effect-verbose-force-update.js | 28 +++++++\n ...e-in-effect-verbose-non-local-derived.expect.md | 68 +++++++++++++++\n ...et-state-in-effect-verbose-non-local-derived.js | 15 ++++\n 9 files changed, 365 insertions(+), 21 deletions(-)\n\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/CompilerError.ts b/compiler/packages/babel-plugin-react-compiler/src/CompilerError.ts\nindex a8869fd..a61967e 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/CompilerError.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/CompilerError.ts\n@@ -869,7 +869,9 @@ function getRuleForCategoryImpl(category: ErrorCategory): LintRule {\n         severity: ErrorSeverity.Error,\n         name: \u0027set-state-in-effect\u0027,\n         description:\n-          \u0027Validates against calling setState synchronously in an effect, which can lead to re-renders that degrade performance\u0027,\n+          \u0027Validates against calling setState synchronously in an effect. \u0027 +\n+          \u0027This can indicate non-local derived data, a derived event pattern, or \u0027 +\n+          \u0027improper external data synchronization.\u0027,\n         preset: LintRulePreset.Recommended,\n       };\n     }\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts b/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\nindex 87737f0..05105ae 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\n@@ -700,6 +700,16 @@ export const EnvironmentConfigSchema \u003d z.object({\n    */\n   enableAllowSetStateFromRefsInEffects: z.boolean().default(true),\n \n+  /**\n+   * When enabled, provides verbose error messages for setState calls within effects,\n+   * presenting multiple possible fixes to the user/agent since we cannot statically\n+   * determine which specific use-case applies:\n+   * 1. Non-local derived data - requires restructuring state ownership\n+   * 2. Derived event pattern - detecting when a prop changes\n+   * 3. Force update / external sync - should use useSyncExternalStore\n+   */\n+  enableVerboseNoSetStateInEffect: z.boolean().default(false),\n+\n   /**\n    * Enables inference of event handler types for JSX props on built-in DOM elements.\n    * When enabled, functions passed to event handler props (props starting with \"on\")\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInEffects.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInEffects.ts\nindex 86070e2..91de8f2 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInEffects.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInEffects.ts\n@@ -121,26 +121,58 @@ export function validateNoSetStateInEffects(\n             if (arg !\u003d\u003d undefined \u0026\u0026 arg.kind \u003d\u003d\u003d \u0027Identifier\u0027) {\n               const setState \u003d setStateFunctions.get(arg.identifier.id);\n               if (setState !\u003d\u003d undefined) {\n-                errors.pushDiagnostic(\n-                  CompilerDiagnostic.create({\n-                    category: ErrorCategory.EffectSetState,\n-                    reason:\n-                      \u0027Calling setState synchronously within an effect can trigger cascading renders\u0027,\n-                    description:\n-                      \u0027Effects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. \u0027 +\n-                      \u0027In general, the body of an effect should do one or both of the following:\\n\u0027 +\n-                      \u0027* Update external systems with the latest state from React.\\n\u0027 +\n-                      \u0027* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\\n\\n\u0027 +\n-                      \u0027Calling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. \u0027 +\n-                      \u0027(https://react.dev/learn/you-might-not-need-an-effect)\u0027,\n-                    suggestions: null,\n-                  }).withDetails({\n-                    kind: \u0027error\u0027,\n-                    loc: setState.loc,\n-                    message:\n-                      \u0027Avoid calling setState() directly within an effect\u0027,\n-                  }),\n-                );\n+                const enableVerbose \u003d\n+                  env.config.enableVerboseNoSetStateInEffect;\n+                if (enableVerbose) {\n+                  errors.pushDiagnostic(\n+                    CompilerDiagnostic.create({\n+                      category: ErrorCategory.EffectSetState,\n+                      reason:\n+                        \u0027Calling setState synchronously within an effect can trigger cascading renders\u0027,\n+                      description:\n+                        \u0027Effects are intended to synchronize state between React and external systems. \u0027 +\n+                        \u0027Calling setState synchronously causes cascading renders that hurt performance.\\n\\n\u0027 +\n+                        \u0027This pattern may indicate one of several issues:\\n\\n\u0027 +\n+                        \u0027**1. Non-local derived data**: If the value being set could be computed from props/state \u0027 +\n+                        \u0027but requires data from a parent component, consider restructuring state ownership so the \u0027 +\n+                        \u0027derivation can happen during render in the component that owns the relevant state.\\n\\n\u0027 +\n+                        \"**2. Derived event pattern**: If you\u0027re detecting when a prop changes (e.g., `isPlaying` \" +\n+                        \u0027transitioning from false to true), this often indicates the parent should provide an event \u0027 +\n+                        \u0027callback (like `onPlay`) instead of just the current state. Request access to the original event.\\n\\n\u0027 +\n+                        \"**3. Force update / external sync**: If you\u0027re forcing a re-render to sync with an external \" +\n+                        \u0027data source (mutable values outside React), use `useSyncExternalStore` to properly subscribe \u0027 +\n+                        \u0027to external state changes.\\n\\n\u0027 +\n+                        \u0027See: https://react.dev/learn/you-might-not-need-an-effect\u0027,\n+                      suggestions: null,\n+                    }).withDetails({\n+                      kind: \u0027error\u0027,\n+                      loc: setState.loc,\n+                      message:\n+                        \u0027Avoid calling setState() directly within an effect\u0027,\n+                    }),\n+                  );\n+                } else {\n+                  errors.pushDiagnostic(\n+                    CompilerDiagnostic.create({\n+                      category: ErrorCategory.EffectSetState,\n+                      reason:\n+                        \u0027Calling setState synchronously within an effect can trigger cascading renders\u0027,\n+                      description:\n+                        \u0027Effects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. \u0027 +\n+                        \u0027In general, the body of an effect should do one or both of the following:\\n\u0027 +\n+                        \u0027* Update external systems with the latest state from React.\\n\u0027 +\n+                        \u0027* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\\n\\n\u0027 +\n+                        \u0027Calling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. \u0027 +\n+                        \u0027(https://react.dev/learn/you-might-not-need-an-effect)\u0027,\n+                      suggestions: null,\n+                    }).withDetails({\n+                      kind: \u0027error\u0027,\n+                      loc: setState.loc,\n+                      message:\n+                        \u0027Avoid calling setState() directly within an effect\u0027,\n+                    }),\n+                  );\n+                }\n               }\n             }\n           }\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-derived-event.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-derived-event.expect.md\nnew file mode 100644\nindex 0000000..60479b8\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-derived-event.expect.md\n@@ -0,0 +1,74 @@\n+\n+## Input\n+\n+```javascript\n+// @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import {useState, useEffect} from \u0027react\u0027;\n+\n+function VideoPlayer({isPlaying}) {\n+  const [wasPlaying, setWasPlaying] \u003d useState(isPlaying);\n+  useEffect(() \u003d\u003e {\n+    if (isPlaying !\u003d\u003d wasPlaying) {\n+      setWasPlaying(isPlaying);\n+      console.log(\u0027Play state changed!\u0027);\n+    }\n+  }, [isPlaying, wasPlaying]);\n+  return \u003cvideo /\u003e;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: VideoPlayer,\n+  params: [{isPlaying: true}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import { useState, useEffect } from \"react\";\n+\n+function VideoPlayer(t0) {\n+  const $ \u003d _c(5);\n+  const { isPlaying } \u003d t0;\n+  const [wasPlaying, setWasPlaying] \u003d useState(isPlaying);\n+  let t1;\n+  let t2;\n+  if ($[0] !\u003d\u003d isPlaying || $[1] !\u003d\u003d wasPlaying) {\n+    t1 \u003d () \u003d\u003e {\n+      if (isPlaying !\u003d\u003d wasPlaying) {\n+        setWasPlaying(isPlaying);\n+        console.log(\"Play state changed!\");\n+      }\n+    };\n+\n+    t2 \u003d [isPlaying, wasPlaying];\n+    $[0] \u003d isPlaying;\n+    $[1] \u003d wasPlaying;\n+    $[2] \u003d t1;\n+    $[3] \u003d t2;\n+  } else {\n+    t1 \u003d $[2];\n+    t2 \u003d $[3];\n+  }\n+  useEffect(t1, t2);\n+  let t3;\n+  if ($[4] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t3 \u003d \u003cvideo /\u003e;\n+    $[4] \u003d t3;\n+  } else {\n+    t3 \u003d $[4];\n+  }\n+  return t3;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: VideoPlayer,\n+  params: [{ isPlaying: true }],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) \u003cvideo\u003e\u003c/video\u003e\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-derived-event.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-derived-event.js\nnew file mode 100644\nindex 0000000..4928dbe\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-derived-event.js\n@@ -0,0 +1,18 @@\n+// @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import {useState, useEffect} from \u0027react\u0027;\n+\n+function VideoPlayer({isPlaying}) {\n+  const [wasPlaying, setWasPlaying] \u003d useState(isPlaying);\n+  useEffect(() \u003d\u003e {\n+    if (isPlaying !\u003d\u003d wasPlaying) {\n+      setWasPlaying(isPlaying);\n+      console.log(\u0027Play state changed!\u0027);\n+    }\n+  }, [isPlaying, wasPlaying]);\n+  return \u003cvideo /\u003e;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: VideoPlayer,\n+  params: [{isPlaying: true}],\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-force-update.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-force-update.expect.md\nnew file mode 100644\nindex 0000000..131eb99\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-force-update.expect.md\n@@ -0,0 +1,97 @@\n+\n+## Input\n+\n+```javascript\n+// @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import {useState, useEffect} from \u0027react\u0027;\n+\n+const externalStore \u003d {\n+  value: 0,\n+  subscribe(callback) {\n+    return () \u003d\u003e {};\n+  },\n+  getValue() {\n+    return this.value;\n+  },\n+};\n+\n+function ExternalDataComponent() {\n+  const [, forceUpdate] \u003d useState({});\n+  useEffect(() \u003d\u003e {\n+    const unsubscribe \u003d externalStore.subscribe(() \u003d\u003e {\n+      forceUpdate({});\n+    });\n+    return unsubscribe;\n+  }, []);\n+  return \u003cdiv\u003e{externalStore.getValue()}\u003c/div\u003e;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: ExternalDataComponent,\n+  params: [],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import { useState, useEffect } from \"react\";\n+\n+const externalStore \u003d {\n+  value: 0,\n+  subscribe(callback) {\n+    return () \u003d\u003e {};\n+  },\n+  getValue() {\n+    return this.value;\n+  },\n+};\n+\n+function ExternalDataComponent() {\n+  const $ \u003d _c(4);\n+  let t0;\n+  if ($[0] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t0 \u003d {};\n+    $[0] \u003d t0;\n+  } else {\n+    t0 \u003d $[0];\n+  }\n+  const [, forceUpdate] \u003d useState(t0);\n+  let t1;\n+  let t2;\n+  if ($[1] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t1 \u003d () \u003d\u003e {\n+      const unsubscribe \u003d externalStore.subscribe(() \u003d\u003e {\n+        forceUpdate({});\n+      });\n+      return unsubscribe;\n+    };\n+    t2 \u003d [];\n+    $[1] \u003d t1;\n+    $[2] \u003d t2;\n+  } else {\n+    t1 \u003d $[1];\n+    t2 \u003d $[2];\n+  }\n+  useEffect(t1, t2);\n+  let t3;\n+  if ($[3] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t3 \u003d \u003cdiv\u003e{externalStore.getValue()}\u003c/div\u003e;\n+    $[3] \u003d t3;\n+  } else {\n+    t3 \u003d $[3];\n+  }\n+  return t3;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: ExternalDataComponent,\n+  params: [],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) \u003cdiv\u003e0\u003c/div\u003e\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-force-update.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-force-update.js\nnew file mode 100644\nindex 0000000..e7653d1\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-force-update.js\n@@ -0,0 +1,28 @@\n+// @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import {useState, useEffect} from \u0027react\u0027;\n+\n+const externalStore \u003d {\n+  value: 0,\n+  subscribe(callback) {\n+    return () \u003d\u003e {};\n+  },\n+  getValue() {\n+    return this.value;\n+  },\n+};\n+\n+function ExternalDataComponent() {\n+  const [, forceUpdate] \u003d useState({});\n+  useEffect(() \u003d\u003e {\n+    const unsubscribe \u003d externalStore.subscribe(() \u003d\u003e {\n+      forceUpdate({});\n+    });\n+    return unsubscribe;\n+  }, []);\n+  return \u003cdiv\u003e{externalStore.getValue()}\u003c/div\u003e;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: ExternalDataComponent,\n+  params: [],\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-non-local-derived.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-non-local-derived.expect.md\nnew file mode 100644\nindex 0000000..35cdeb2\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-non-local-derived.expect.md\n@@ -0,0 +1,68 @@\n+\n+## Input\n+\n+```javascript\n+// @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import {useState, useEffect} from \u0027react\u0027;\n+\n+function Child({firstName, lastName}) {\n+  const [fullName, setFullName] \u003d useState(\u0027\u0027);\n+  useEffect(() \u003d\u003e {\n+    setFullName(firstName + \u0027 \u0027 + lastName);\n+  }, [firstName, lastName]);\n+  return \u003cdiv\u003e{fullName}\u003c/div\u003e;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Child,\n+  params: [{firstName: \u0027John\u0027, lastName: \u0027Doe\u0027}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import { useState, useEffect } from \"react\";\n+\n+function Child(t0) {\n+  const $ \u003d _c(6);\n+  const { firstName, lastName } \u003d t0;\n+  const [fullName, setFullName] \u003d useState(\"\");\n+  let t1;\n+  let t2;\n+  if ($[0] !\u003d\u003d firstName || $[1] !\u003d\u003d lastName) {\n+    t1 \u003d () \u003d\u003e {\n+      setFullName(firstName + \" \" + lastName);\n+    };\n+    t2 \u003d [firstName, lastName];\n+    $[0] \u003d firstName;\n+    $[1] \u003d lastName;\n+    $[2] \u003d t1;\n+    $[3] \u003d t2;\n+  } else {\n+    t1 \u003d $[2];\n+    t2 \u003d $[3];\n+  }\n+  useEffect(t1, t2);\n+  let t3;\n+  if ($[4] !\u003d\u003d fullName) {\n+    t3 \u003d \u003cdiv\u003e{fullName}\u003c/div\u003e;\n+    $[4] \u003d fullName;\n+    $[5] \u003d t3;\n+  } else {\n+    t3 \u003d $[5];\n+  }\n+  return t3;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Child,\n+  params: [{ firstName: \"John\", lastName: \"Doe\" }],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) \u003cdiv\u003eJohn Doe\u003c/div\u003e\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-non-local-derived.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-non-local-derived.js\nnew file mode 100644\nindex 0000000..eba6b5c\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-set-state-in-effect-verbose-non-local-derived.js\n@@ -0,0 +1,15 @@\n+// @validateNoSetStateInEffects @enableVerboseNoSetStateInEffect\n+import {useState, useEffect} from \u0027react\u0027;\n+\n+function Child({firstName, lastName}) {\n+  const [fullName, setFullName] \u003d useState(\u0027\u0027);\n+  useEffect(() \u003d\u003e {\n+    setFullName(firstName + \u0027 \u0027 + lastName);\n+  }, [firstName, lastName]);\n+  return \u003cdiv\u003e{fullName}\u003c/div\u003e;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Child,\n+  params: [{firstName: \u0027John\u0027, lastName: \u0027Doe\u0027}],\n+};","expectedMessage":"[compiler] Add enableVerboseNoSetStateInEffect to suggest options to user/agent (#35306)","repository":"react","commitHash":"3640f38a728f3a057649cf7aec65a6ce14c2eac0","metadata":{"author":"lauren \u003cpoteto@users.noreply.github.com\u003e"}}
{"id":"react-380778d2","diff":" .../src/__tests__/ReactFlightDOMBrowser-test.js    | 33 ++++++----------------\n .../src/__tests__/ReactFlightDOMNode-test.js       | 16 ++++-------\n .../__tests__/ReactFlightAsyncDebugInfo-test.js    |  8 +++---\n 3 files changed, 19 insertions(+), 38 deletions(-)\n\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js\nindex e2c1e74..412ec0c 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js\n@@ -2820,15 +2820,16 @@ describe(\u0027ReactFlightDOMBrowser\u0027, () \u003d\u003e {\n       },\n     });\n \n+    const app \u003d ReactServer.createElement(\n+      ReactServer.Fragment,\n+      null,\n+      ReactServer.createElement(Paragraph, null, \u0027foo\u0027),\n+      ReactServer.createElement(Paragraph, null, \u0027bar\u0027),\n+    );\n     const stream \u003d await serverAct(() \u003d\u003e\n       ReactServerDOMServer.renderToReadableStream(\n         {\n-          root: ReactServer.createElement(\n-            ReactServer.Fragment,\n-            null,\n-            ReactServer.createElement(Paragraph, null, \u0027foo\u0027),\n-            ReactServer.createElement(Paragraph, null, \u0027bar\u0027),\n-          ),\n+          root: app,\n         },\n         webpackMap,\n         {\n@@ -2900,27 +2901,11 @@ describe(\u0027ReactFlightDOMBrowser\u0027, () \u003d\u003e {\n             \"name\": \"Paragraph\",\n             \"props\": {},\n             \"stack\": [\n-              [\n-                \"\",\n-                \"/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js\",\n-                2829,\n-                27,\n-                2823,\n-                34,\n-              ],\n-              [\n-                \"serverAct\",\n-                \"/packages/internal-test-utils/internalAct.js\",\n-                270,\n-                19,\n-                231,\n-                1,\n-              ],\n               [\n                 \"Object.\u003canonymous\u003e\",\n                 \"/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js\",\n-                2823,\n-                18,\n+                2826,\n+                19,\n                 2810,\n                 89,\n               ],\ndiff --git a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js\nindex 1fe1cb1..805d204 100644\n--- a/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js\n+++ b/packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js\n@@ -1216,11 +1216,7 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n         const data1 \u003d await getDynamicData1();\n         const data2 \u003d await getDynamicData2();\n \n-        return (\n-          \u003cp\u003e\n-            {data1} {data2}\n-          \u003c/p\u003e\n-        );\n+        return ReactServer.createElement(\u0027p\u0027, null, data1, \u0027 \u0027, data2);\n       }\n \n       function App() {\n@@ -1350,8 +1346,8 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n               : \u0027\\n\u0027) +\n             \u0027    in body\\n\u0027 +\n             \u0027    in html\\n\u0027 +\n-            \u0027    in App (file://ReactFlightDOMNode-test.js:1233:25)\\n\u0027 +\n-            \u0027    in ClientRoot (ReactFlightDOMNode-test.js:1308:16)\u0027,\n+            \u0027    in App (file://ReactFlightDOMNode-test.js:1229:25)\\n\u0027 +\n+            \u0027    in ClientRoot (ReactFlightDOMNode-test.js:1304:16)\u0027,\n         );\n       } else {\n         expect(\n@@ -1360,7 +1356,7 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n           \u0027\\n\u0027 +\n             \u0027    in body\\n\u0027 +\n             \u0027    in html\\n\u0027 +\n-            \u0027    in ClientRoot (ReactFlightDOMNode-test.js:1308:16)\u0027,\n+            \u0027    in ClientRoot (ReactFlightDOMNode-test.js:1304:16)\u0027,\n         );\n       }\n \n@@ -1371,7 +1367,7 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n           ).toBe(\n             \u0027\\n\u0027 +\n               \u0027    in Dynamic (file://ReactFlightDOMNode-test.js:1216:27)\\n\u0027 +\n-              \u0027    in App (file://ReactFlightDOMNode-test.js:1233:25)\u0027,\n+              \u0027    in App (file://ReactFlightDOMNode-test.js:1229:25)\u0027,\n           );\n         } else {\n           expect(\n@@ -1379,7 +1375,7 @@ describe(\u0027ReactFlightDOMNode\u0027, () \u003d\u003e {\n           ).toBe(\n             \u0027\u0027 +\n               \u0027\\n\u0027 +\n-              \u0027    in App (file://ReactFlightDOMNode-test.js:1233:25)\u0027,\n+              \u0027    in App (file://ReactFlightDOMNode-test.js:1229:25)\u0027,\n           );\n         }\n       } else {\ndiff --git a/packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js b/packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js\nindex 465eac9..2570c0d 100644\n--- a/packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js\n+++ b/packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js\n@@ -3155,7 +3155,7 @@ describe(\u0027ReactFlightAsyncDebugInfo\u0027, () \u003d\u003e {\n     }\n \n     const stream \u003d ReactServerDOMServer.renderToPipeableStream(\n-      \u003cComponent /\u003e,\n+      ReactServer.createElement(Component),\n       {},\n     );\n \n@@ -3192,7 +3192,7 @@ describe(\u0027ReactFlightAsyncDebugInfo\u0027, () \u003d\u003e {\n                 \"Object.\u003canonymous\u003e\",\n                 \"/packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js\",\n                 3158,\n-                40,\n+                19,\n                 3146,\n                 36,\n               ],\n@@ -3216,7 +3216,7 @@ describe(\u0027ReactFlightAsyncDebugInfo\u0027, () \u003d\u003e {\n                     \"Object.\u003canonymous\u003e\",\n                     \"/packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js\",\n                     3158,\n-                    40,\n+                    19,\n                     3146,\n                     36,\n                   ],\n@@ -3248,7 +3248,7 @@ describe(\u0027ReactFlightAsyncDebugInfo\u0027, () \u003d\u003e {\n                   \"Object.\u003canonymous\u003e\",\n                   \"/packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js\",\n                   3158,\n-                  40,\n+                  19,\n                   3146,\n                   36,\n                 ],","expectedMessage":"[test] Cleanup stack assertions in tests mixing React Server and Client (#35316)","repository":"react","commitHash":"380778d296478d675846668f96b0ee3e8f7fe810","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-41745339","diff":" .github/workflows/runtime_build_and_test.yml | 4 ++++\n 1 file changed, 4 insertions(+)\n\ndiff --git a/.github/workflows/runtime_build_and_test.yml b/.github/workflows/runtime_build_and_test.yml\nindex 6e5332e..c1cc8df 100644\n--- a/.github/workflows/runtime_build_and_test.yml\n+++ b/.github/workflows/runtime_build_and_test.yml\n@@ -3,6 +3,10 @@ name: (Runtime) Build and Test\n on:\n   push:\n     branches: [main]\n+    tags:\n+      # To get CI for backport releases.\n+      # This will duplicate CI for releases from main which is acceptable\n+      - \"v*\"\n   pull_request:\n     paths-ignore:\n       - compiler/**","expectedMessage":"Run CI for backport releases (#35313)","repository":"react","commitHash":"41745339cd258065e47a692bb29d925561b70f08","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-2cb08e65","diff":" .../ReactiveScopes/InferReactiveScopeVariables.ts  |  8 --\n ...repro-stale-closure-forward-reference.expect.md | 94 ++++++++++++++++++++++\n .../repro-stale-closure-forward-reference.js       | 32 ++++++++\n 3 files changed, 126 insertions(+), 8 deletions(-)\n\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/ReactiveScopes/InferReactiveScopeVariables.ts b/compiler/packages/babel-plugin-react-compiler/src/ReactiveScopes/InferReactiveScopeVariables.ts\nindex 300115c..b034ee8 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/ReactiveScopes/InferReactiveScopeVariables.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/ReactiveScopes/InferReactiveScopeVariables.ts\n@@ -389,14 +389,6 @@ export function findDisjointMutableValues(\n              */\n             operand.identifier.mutableRange.start \u003e 0\n           ) {\n-            if (\n-              instr.value.kind \u003d\u003d\u003d \u0027FunctionExpression\u0027 ||\n-              instr.value.kind \u003d\u003d\u003d \u0027ObjectMethod\u0027\n-            ) {\n-              if (operand.identifier.type.kind \u003d\u003d\u003d \u0027Primitive\u0027) {\n-                continue;\n-              }\n-            }\n             operands.push(operand.identifier);\n           }\n         }\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/repro-stale-closure-forward-reference.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/repro-stale-closure-forward-reference.expect.md\nnew file mode 100644\nindex 0000000..01d1fe6\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/repro-stale-closure-forward-reference.expect.md\n@@ -0,0 +1,94 @@\n+\n+## Input\n+\n+```javascript\n+import {useState} from \u0027react\u0027;\n+\n+/**\n+ * Repro for https://github.com/facebook/react/issues/35122\n+ *\n+ * InferReactiveScopeVariables was excluding primitive operands\n+ * when considering operands for merging. We previously did not\n+ * infer types for context variables (StoreContext etc), but later\n+ * started inferring types in cases of `const` context variables,\n+ * since the type cannot change.\n+ *\n+ * In this example, this meant that we skipped the `isExpired`\n+ * operand of the onClick function expression when considering\n+ * scopes to merge.\n+ */\n+function Test1() {\n+  const [expire, setExpire] \u003d useState(5);\n+\n+  const onClick \u003d () \u003d\u003e {\n+    // Reference to isExpired prior to declaration\n+    console.log(\u0027isExpired\u0027, isExpired);\n+  };\n+\n+  const isExpired \u003d expire \u003d\u003d\u003d 0;\n+\n+  return \u003cdiv onClick\u003d{onClick}\u003e{expire}\u003c/div\u003e;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Test1,\n+  params: [{}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\";\n+import { useState } from \"react\";\n+\n+/**\n+ * Repro for https://github.com/facebook/react/issues/35122\n+ *\n+ * InferReactiveScopeVariables was excluding primitive operands\n+ * when considering operands for merging. We previously did not\n+ * infer types for context variables (StoreContext etc), but later\n+ * started inferring types in cases of `const` context variables,\n+ * since the type cannot change.\n+ *\n+ * In this example, this meant that we skipped the `isExpired`\n+ * operand of the onClick function expression when considering\n+ * scopes to merge.\n+ */\n+function Test1() {\n+  const $ \u003d _c(5);\n+  const [expire] \u003d useState(5);\n+  let onClick;\n+  if ($[0] !\u003d\u003d expire) {\n+    onClick \u003d () \u003d\u003e {\n+      console.log(\"isExpired\", isExpired);\n+    };\n+\n+    const isExpired \u003d expire \u003d\u003d\u003d 0;\n+    $[0] \u003d expire;\n+    $[1] \u003d onClick;\n+  } else {\n+    onClick \u003d $[1];\n+  }\n+  let t0;\n+  if ($[2] !\u003d\u003d expire || $[3] !\u003d\u003d onClick) {\n+    t0 \u003d \u003cdiv onClick\u003d{onClick}\u003e{expire}\u003c/div\u003e;\n+    $[2] \u003d expire;\n+    $[3] \u003d onClick;\n+    $[4] \u003d t0;\n+  } else {\n+    t0 \u003d $[4];\n+  }\n+  return t0;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Test1,\n+  params: [{}],\n+};\n+\n+```\n+      \n+### Eval output\n+(kind: ok) \u003cdiv\u003e5\u003c/div\u003e\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/repro-stale-closure-forward-reference.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/repro-stale-closure-forward-reference.js\nnew file mode 100644\nindex 0000000..035640f\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/repro-stale-closure-forward-reference.js\n@@ -0,0 +1,32 @@\n+import {useState} from \u0027react\u0027;\n+\n+/**\n+ * Repro for https://github.com/facebook/react/issues/35122\n+ *\n+ * InferReactiveScopeVariables was excluding primitive operands\n+ * when considering operands for merging. We previously did not\n+ * infer types for context variables (StoreContext etc), but later\n+ * started inferring types in cases of `const` context variables,\n+ * since the type cannot change.\n+ *\n+ * In this example, this meant that we skipped the `isExpired`\n+ * operand of the onClick function expression when considering\n+ * scopes to merge.\n+ */\n+function Test1() {\n+  const [expire, setExpire] \u003d useState(5);\n+\n+  const onClick \u003d () \u003d\u003e {\n+    // Reference to isExpired prior to declaration\n+    console.log(\u0027isExpired\u0027, isExpired);\n+  };\n+\n+  const isExpired \u003d expire \u003d\u003d\u003d 0;\n+\n+  return \u003cdiv onClick\u003d{onClick}\u003e{expire}\u003c/div\u003e;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Test1,\n+  params: [{}],\n+};","expectedMessage":"[compiler] Fix bug w functions depending on hoisted primitives (#35284)","repository":"react","commitHash":"2cb08e65b39d1bd184803cc8e4d1081f9c801f69","metadata":{"author":"Joseph Savona \u003c6425824+josephsavona@users.noreply.github.com\u003e"}}
{"id":"react-ad5971fe","diff":" .../src/backend/views/Highlighter/index.js         | 33 +++++++++++++++++-----\n 1 file changed, 26 insertions(+), 7 deletions(-)\n\ndiff --git a/packages/react-devtools-shared/src/backend/views/Highlighter/index.js b/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\nindex 0adf3ff..34a81f3 100644\n--- a/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\n+++ b/packages/react-devtools-shared/src/backend/views/Highlighter/index.js\n@@ -9,6 +9,7 @@\n \n import Agent from \u0027react-devtools-shared/src/backend/agent\u0027;\n import {hideOverlay, showOverlay} from \u0027./Highlighter\u0027;\n+import {isReactNativeEnvironment} from \u0027react-devtools-shared/src/backend/utils\u0027;\n \n import type {HostInstance} from \u0027react-devtools-shared/src/backend/types\u0027;\n import type {BackendBridge} from \u0027react-devtools-shared/src/bridge\u0027;\n@@ -49,6 +50,11 @@ export default function setupHighlighter(\n     right: number,\n     bottom: number,\n   }) {\n+    if (isReactNativeEnvironment()) {\n+      // Not implemented.\n+      return;\n+    }\n+\n     if (\n       left \u003d\u003d\u003d Math.round(window.scrollX) \u0026\u0026\n       top \u003d\u003d\u003d Math.round(window.scrollY)\n@@ -65,6 +71,11 @@ export default function setupHighlighter(\n \n   let scrollTimer \u003d null;\n   function sendScroll() {\n+    if (isReactNativeEnvironment()) {\n+      // Not implemented.\n+      return;\n+    }\n+\n     if (scrollTimer) {\n       clearTimeout(scrollTimer);\n       scrollTimer \u003d null;\n@@ -85,14 +96,17 @@ export default function setupHighlighter(\n     applyingScroll \u003d false;\n   }\n \n-  document.addEventListener(\u0027scroll\u0027, () \u003d\u003e {\n-    if (!scrollTimer) {\n-      // Periodically synchronize the scroll while scrolling.\n-      scrollTimer \u003d setTimeout(sendScroll, 400);\n-    }\n-  });\n+  // $FlowFixMe[method-unbinding]\n+  if (document \u0026\u0026 typeof document.addEventListener \u003d\u003d\u003d \u0027function\u0027) {\n+    document.addEventListener(\u0027scroll\u0027, () \u003d\u003e {\n+      if (!scrollTimer) {\n+        // Periodically synchronize the scroll while scrolling.\n+        scrollTimer \u003d setTimeout(sendScroll, 400);\n+      }\n+    });\n \n-  document.addEventListener(\u0027scrollend\u0027, scrollEnd);\n+    document.addEventListener(\u0027scrollend\u0027, scrollEnd);\n+  }\n \n   function startInspectingHost(onlySuspenseNodes: boolean) {\n     inspectOnlySuspenseNodes \u003d onlySuspenseNodes;\n@@ -319,6 +333,11 @@ export default function setupHighlighter(\n     // with the scrollIntoView option.\n     hideOverlay(agent);\n \n+    if (isReactNativeEnvironment()) {\n+      // Not implemented.\n+      return;\n+    }\n+\n     if (scrollDelayTimer) {\n       clearTimeout(scrollDelayTimer);\n       scrollDelayTimer \u003d null;","expectedMessage":"fix[devtools]: no-op unsupported backend bridge events (#35296)","repository":"react","commitHash":"ad5971febdf6cc3103fa51121d4015832f2af5f8","metadata":{"author":"Ruslan Lesiutin \u003c28902667+hoxyq@users.noreply.github.com\u003e"}}
{"id":"react-3016ff87","diff":" packages/react-server/src/ReactFlightReplyServer.js | 17 ++++++++++++++++-\n 1 file changed, 16 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/react-server/src/ReactFlightReplyServer.js b/packages/react-server/src/ReactFlightReplyServer.js\nindex 39734da..742cae6 100644\n--- a/packages/react-server/src/ReactFlightReplyServer.js\n+++ b/packages/react-server/src/ReactFlightReplyServer.js\n@@ -437,6 +437,11 @@ function loadServerReference\u003cA: Iterable\u003cany\u003e, T\u003e(\n   if (typeof id !\u003d\u003d \u0027string\u0027) {\n     return (null: any);\n   }\n+  if (key \u003d\u003d\u003d \u0027then\u0027) {\n+    // This should never happen because we always serialize objects with then-functions\n+    // as \"thenable\" which reduces to ReactPromise with no other fields.\n+    return (null: any);\n+  }\n   const serverReference: ServerReference\u003cT\u003e \u003d\n     resolveServerReference\u003c$FlowFixMe\u003e(response._bundlerConfig, id);\n   // We expect most servers to not really need this because you\u0027d just have all\n@@ -976,7 +981,17 @@ function extractIterator(response: Response, model: Array\u003cany\u003e): Iterator\u003cany\u003e {\n   return model[Symbol.iterator]();\n }\n \n-function createModel(response: Response, model: any): any {\n+function createModel(\n+  response: Response,\n+  model: any,\n+  parentObject: Object,\n+  key: string,\n+): any {\n+  if (key \u003d\u003d\u003d \u0027then\u0027 \u0026\u0026 typeof model \u003d\u003d\u003d \u0027function\u0027) {\n+    // This should never happen because we always serialize objects with then-functions\n+    // as \"thenable\" which reduces to ReactPromise with no other fields.\n+    return null;\n+  }\n   return model;\n }\n ","expectedMessage":"[Flight] Never parse \"then\" functions (#35289)","repository":"react","commitHash":"3016ff87d87aeff5181d95348d609039fdcad94a","metadata":{"author":"Sebastian Markbåge \u003csebastian@calyptus.eu\u003e"}}
{"id":"react-f99241b2","diff":" .../src/HIR/Environment.ts                         |  6 +++\n .../src/Validation/ValidateNoSetStateInRender.ts   | 48 +++++++++++++++-------\n ...alid-setState-in-render-unbound-state.expect.md |  6 ++-\n ...tstate-unconditional-with-keyed-state.expect.md | 44 ++++++++++++++++++++\n ...alid-setstate-unconditional-with-keyed-state.js | 14 +++++++\n ...ional-set-state-hook-return-in-render.expect.md | 12 ++++--\n ...lid-unconditional-set-state-in-render.expect.md | 12 ++++--\n ...nconditional-set-state-prop-in-render.expect.md | 12 ++++--\n ...-set-state-in-render-after-loop-break.expect.md |  6 ++-\n ...tional-set-state-in-render-after-loop.expect.md |  6 ++-\n ...l-set-state-in-render-with-loop-throw.expect.md |  6 ++-\n .../error.unconditional-set-state-lambda.expect.md |  6 ++-\n ...set-state-nested-function-expressions.expect.md |  6 ++-\n 13 files changed, 146 insertions(+), 38 deletions(-)\n\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts b/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\nindex fc5ba40..17dd53a 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/HIR/Environment.ts\n@@ -318,6 +318,12 @@ export const EnvironmentConfigSchema \u003d z.object({\n    */\n   validateNoSetStateInRender: z.boolean().default(true),\n \n+  /**\n+   * When enabled, changes the behavior of validateNoSetStateInRender to recommend\n+   * using useKeyedState instead of the manual pattern for resetting state.\n+   */\n+  enableUseKeyedState: z.boolean().default(false),\n+\n   /**\n    * Validates that setState is not called synchronously within an effect (useEffect and friends).\n    * Scheduling a setState (with an event listener, subscription, etc) is valid.\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInRender.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInRender.ts\nindex a1a05b2..e0d34d5 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInRender.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInRender.ts\n@@ -155,20 +155,40 @@ function validateNoSetStateInRenderImpl(\n                 }),\n               );\n             } else if (unconditionalBlocks.has(block.id)) {\n-              errors.pushDiagnostic(\n-                CompilerDiagnostic.create({\n-                  category: ErrorCategory.RenderSetState,\n-                  reason:\n-                    \u0027Calling setState during render may trigger an infinite loop\u0027,\n-                  description:\n-                    \u0027Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState)\u0027,\n-                  suggestions: null,\n-                }).withDetails({\n-                  kind: \u0027error\u0027,\n-                  loc: callee.loc,\n-                  message: \u0027Found setState() in render\u0027,\n-                }),\n-              );\n+              const enableUseKeyedState \u003d fn.env.config.enableUseKeyedState;\n+              if (enableUseKeyedState) {\n+                errors.pushDiagnostic(\n+                  CompilerDiagnostic.create({\n+                    category: ErrorCategory.RenderSetState,\n+                    reason: \u0027Cannot call setState during render\u0027,\n+                    description:\n+                      \u0027Calling setState during render may trigger an infinite loop.\\n\u0027 +\n+                      \u0027* To reset state when other state/props change, use `const [state, setState] \u003d useKeyedState(initialState, key)` to reset `state` when `key` changes.\\n\u0027 +\n+                      \u0027* To derive data from other state/props, compute the derived data during render without using state\u0027,\n+                    suggestions: null,\n+                  }).withDetails({\n+                    kind: \u0027error\u0027,\n+                    loc: callee.loc,\n+                    message: \u0027Found setState() in render\u0027,\n+                  }),\n+                );\n+              } else {\n+                errors.pushDiagnostic(\n+                  CompilerDiagnostic.create({\n+                    category: ErrorCategory.RenderSetState,\n+                    reason: \u0027Cannot call setState during render\u0027,\n+                    description:\n+                      \u0027Calling setState during render may trigger an infinite loop.\\n\u0027 +\n+                      \u0027* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\\n\u0027 +\n+                      \u0027* To derive data from other state/props, compute the derived data during render without using state\u0027,\n+                    suggestions: null,\n+                  }).withDetails({\n+                    kind: \u0027error\u0027,\n+                    loc: callee.loc,\n+                    message: \u0027Found setState() in render\u0027,\n+                  }),\n+                );\n+              }\n             }\n           }\n           break;\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setState-in-render-unbound-state.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setState-in-render-unbound-state.expect.md\nindex 423076c..43ae7d0 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setState-in-render-unbound-state.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setState-in-render-unbound-state.expect.md\n@@ -24,9 +24,11 @@ export const FIXTURE_ENTRYPOINT \u003d {\n ```\n Found 1 error:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.invalid-setState-in-render-unbound-state.ts:5:2\n   3 |   // infer the type of destructured properties after a hole in the array\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setstate-unconditional-with-keyed-state.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setstate-unconditional-with-keyed-state.expect.md\nnew file mode 100644\nindex 0000000..7caed10\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setstate-unconditional-with-keyed-state.expect.md\n@@ -0,0 +1,44 @@\n+\n+## Input\n+\n+```javascript\n+// @validateNoSetStateInRender @enableUseKeyedState\n+import {useState} from \u0027react\u0027;\n+\n+function Component() {\n+  const [total, setTotal] \u003d useState(0);\n+  setTotal(42);\n+  return total;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Component,\n+  params: [],\n+  isComponent: true,\n+};\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 1 error:\n+\n+Error: Cannot call setState during render\n+\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, use `const [state, setState] \u003d useKeyedState(initialState, key)` to reset `state` when `key` changes.\n+* To derive data from other state/props, compute the derived data during render without using state.\n+\n+error.invalid-setstate-unconditional-with-keyed-state.ts:6:2\n+  4 | function Component() {\n+  5 |   const [total, setTotal] \u003d useState(0);\n+\u003e 6 |   setTotal(42);\n+    |   ^^^^^^^^ Found setState() in render\n+  7 |   return total;\n+  8 | }\n+  9 |\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setstate-unconditional-with-keyed-state.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setstate-unconditional-with-keyed-state.js\nnew file mode 100644\nindex 0000000..46393b5\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-setstate-unconditional-with-keyed-state.js\n@@ -0,0 +1,14 @@\n+// @validateNoSetStateInRender @enableUseKeyedState\n+import {useState} from \u0027react\u0027;\n+\n+function Component() {\n+  const [total, setTotal] \u003d useState(0);\n+  setTotal(42);\n+  return total;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Component,\n+  params: [],\n+  isComponent: true,\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-hook-return-in-render.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-hook-return-in-render.expect.md\nindex fcd2f7c..cb52054 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-hook-return-in-render.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-hook-return-in-render.expect.md\n@@ -25,9 +25,11 @@ function useCustomState(init) {\n ```\n Found 2 errors:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.invalid-unconditional-set-state-hook-return-in-render.ts:6:2\n   4 |   const aliased \u003d setState;\n@@ -38,9 +40,11 @@ error.invalid-unconditional-set-state-hook-return-in-render.ts:6:2\n   8 |\n   9 |   return state;\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.invalid-unconditional-set-state-hook-return-in-render.ts:7:2\n    5 |\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-in-render.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-in-render.expect.md\nindex 78deea8..9155951 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-in-render.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-in-render.expect.md\n@@ -21,9 +21,11 @@ function Component(props) {\n ```\n Found 2 errors:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.invalid-unconditional-set-state-in-render.ts:6:2\n   4 |   const aliased \u003d setX;\n@@ -34,9 +36,11 @@ error.invalid-unconditional-set-state-in-render.ts:6:2\n   8 |\n   9 |   return x;\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.invalid-unconditional-set-state-in-render.ts:7:2\n    5 |\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-prop-in-render.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-prop-in-render.expect.md\nindex 1a3eb1b..8c46cba 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-prop-in-render.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-unconditional-set-state-prop-in-render.expect.md\n@@ -20,9 +20,11 @@ function Component({setX}) {\n ```\n Found 2 errors:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.invalid-unconditional-set-state-prop-in-render.ts:5:2\n   3 |   const aliased \u003d setX;\n@@ -33,9 +35,11 @@ error.invalid-unconditional-set-state-prop-in-render.ts:5:2\n   7 |\n   8 |   return x;\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.invalid-unconditional-set-state-prop-in-render.ts:6:2\n   4 |\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-after-loop-break.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-after-loop-break.expect.md\nindex 8ccb4f2..ad39cbc 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-after-loop-break.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-after-loop-break.expect.md\n@@ -24,9 +24,11 @@ function Component(props) {\n ```\n Found 1 error:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.unconditional-set-state-in-render-after-loop-break.ts:11:2\n    9 |     }\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-after-loop.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-after-loop.expect.md\nindex df805b4..066c185 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-after-loop.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-after-loop.expect.md\n@@ -19,9 +19,11 @@ function Component(props) {\n ```\n Found 1 error:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.unconditional-set-state-in-render-after-loop.ts:6:2\n   4 |   for (const _ of props) {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-with-loop-throw.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-with-loop-throw.expect.md\nindex 313b2ed..82d7cfb 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-with-loop-throw.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-in-render-with-loop-throw.expect.md\n@@ -24,9 +24,11 @@ function Component(props) {\n ```\n Found 1 error:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.unconditional-set-state-in-render-with-loop-throw.ts:11:2\n    9 |     }\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-lambda.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-lambda.expect.md\nindex 1c89b5c..1ebd422 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-lambda.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-lambda.expect.md\n@@ -22,9 +22,11 @@ function Component(props) {\n ```\n Found 1 error:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.unconditional-set-state-lambda.ts:8:2\n    6 |     setX(1);\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-nested-function-expressions.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-nested-function-expressions.expect.md\nindex fceed8b..4736e66 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-nested-function-expressions.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.unconditional-set-state-nested-function-expressions.expect.md\n@@ -30,9 +30,11 @@ function Component(props) {\n ```\n Found 1 error:\n \n-Error: Calling setState during render may trigger an infinite loop\n+Error: Cannot call setState during render\n \n-Calling setState during render will trigger another render, and can lead to infinite loops. (https://react.dev/reference/react/useState).\n+Calling setState during render may trigger an infinite loop.\n+* To reset state when other state/props change, store the previous value in state and update conditionally: https://react.dev/reference/react/useState#storing-information-from-previous-renders\n+* To derive data from other state/props, compute the derived data during render without using state.\n \n error.unconditional-set-state-nested-function-expressions.ts:16:2\n   14 |     bar();","expectedMessage":"[compiler] Add enableUseKeyedState flag and improve setState-in-render errors (#35230)","repository":"react","commitHash":"f99241b2e6cec825dfbdbb878755f12e1f510ca9","metadata":{"author":"lauren \u003cpoteto@users.noreply.github.com\u003e"}}
{"id":"react-66ae640b","diff":" packages/eslint-plugin-react-hooks/src/shared/ReactCompiler.ts | 1 +\n 1 file changed, 1 insertion(+)\n\ndiff --git a/packages/eslint-plugin-react-hooks/src/shared/ReactCompiler.ts b/packages/eslint-plugin-react-hooks/src/shared/ReactCompiler.ts\nindex 854e261..b35e626 100644\n--- a/packages/eslint-plugin-react-hooks/src/shared/ReactCompiler.ts\n+++ b/packages/eslint-plugin-react-hooks/src/shared/ReactCompiler.ts\n@@ -151,6 +151,7 @@ function makeRule(rule: LintRule): Rule.RuleModule {\n       docs: {\n         description: rule.description,\n         recommended: rule.preset \u003d\u003d\u003d LintRulePreset.Recommended,\n+        url: `https://react.dev/reference/eslint-plugin-react-hooks/lints/${rule.name}`,\n       },\n       fixable: \u0027code\u0027,\n       hasSuggestions: true,","expectedMessage":"[eprh] fix react-compiler rules missing `meta.docs.url` property (#35258)","repository":"react","commitHash":"66ae640b362d75555649701e91c5ae26363db45b","metadata":{"author":"Kyℓe Hensel \u003ck-yle@users.noreply.github.com\u003e"}}
{"id":"react-bf1afade","diff":" packages/react-dom/package.json | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/packages/react-dom/package.json b/packages/react-dom/package.json\nindex 77776a7..351ed06 100644\n--- a/packages/react-dom/package.json\n+++ b/packages/react-dom/package.json\n@@ -61,7 +61,7 @@\n       \"react-server\": \"./server.react-server.js\",\n       \"workerd\": \"./server.edge.js\",\n       \"bun\": \"./server.bun.js\",\n-      \"deno\": \"./server.browser.js\",\n+      \"deno\": \"./server.node.js\",\n       \"worker\": \"./server.browser.js\",\n       \"node\": \"./server.node.js\",\n       \"edge-light\": \"./server.edge.js\",","expectedMessage":"[react-dom/server] Fix hanging on Deno (#35235)","repository":"react","commitHash":"bf1afade8d95d2ef6e862d995ee74921ca8d47c7","metadata":{"author":"Felipe Cardozo \u003cfraifelipe@gmail.com\u003e"}}
{"id":"react-0526c799","diff":" CHANGELOG.md | 18 ++++++++++++++++++\n 1 file changed, 18 insertions(+)\n\ndiff --git a/CHANGELOG.md b/CHANGELOG.md\nindex 85d8f54..5953faf 100644\n--- a/CHANGELOG.md\n+++ b/CHANGELOG.md\n@@ -1,3 +1,9 @@\n+## 19.2.1 (Dec 3, 2025)\n+\n+### React Server Components\n+\n+- Bring React Server Component fixes to Server Actions (@sebmarkbage [#35277](https://github.com/facebook/react/pull/35277))\n+\n ## 19.2.0 (October 1st, 2025)\n \n Below is a list of all new features, APIs, and bug fixes.\n@@ -71,6 +77,12 @@ Read the [React 19.2 release post](https://react.dev/blog/2025/10/01/react-19-2)\n \n - [createContainer](https://github.com/facebook/react/blob/v19.2.0/packages/react-reconciler/src/ReactFiberReconciler.js#L255-L261) and [createHydrationContainer](https://github.com/facebook/react/blob/v19.2.0/packages/react-reconciler/src/ReactFiberReconciler.js#L305-L312) had their parameter order adjusted after `on*` handlers to account for upcoming experimental APIs\n \n+## 19.1.2 (Dec 3, 2025)\n+\n+### React Server Components\n+\n+- Bring React Server Component fixes to Server Actions (@sebmarkbage [#35277](https://github.com/facebook/react/pull/35277))\n+\n ## 19.1.1 (July 28, 2025)\n \n ### React\n@@ -123,6 +135,12 @@ An Owner Stack is a string representing the components that are directly respons\n * Exposed `registerServerReference` in client builds to handle server references in different environments. [#32534](https://github.com/facebook/react/pull/32534)\n * Added react-server-dom-parcel package which integrates Server Components with the [Parcel bundler](https://parceljs.org/) [#31725](https://github.com/facebook/react/pull/31725), [#32132](https://github.com/facebook/react/pull/32132), [#31799](https://github.com/facebook/react/pull/31799), [#32294](https://github.com/facebook/react/pull/32294), [#31741](https://github.com/facebook/react/pull/31741)\n \n+## 19.0.1 (Dec 3, 2025)\n+\n+### React Server Components\n+\n+- Bring React Server Component fixes to Server Actions (@sebmarkbage [#35277](https://github.com/facebook/react/pull/35277))\n+\n ## 19.0.0 (December 5, 2024)\n \n Below is a list of all new features, APIs, deprecations, and breaking changes. Read [React 19 release post](https://react.dev/blog/2024/04/25/react-19) and [React 19 upgrade guide](https://react.dev/blog/2024/04/25/react-19-upgrade-guide) for more information.","expectedMessage":"Update changelog with latest releases (#35279)","repository":"react","commitHash":"0526c799d4df2815aed73912bfbd26fc0102ffc3","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-36df5e8b","diff":" package.json                                 |  2 +-\n scripts/rollup/build-all-release-channels.js | 47 +++++++++++++++++-----------\n 2 files changed, 29 insertions(+), 20 deletions(-)\n\ndiff --git a/package.json b/package.json\nindex 1b88aa1..0108818 100644\n--- a/package.json\n+++ b/package.json\n@@ -123,7 +123,7 @@\n   \"scripts\": {\n     \"prebuild\": \"./scripts/react-compiler/link-compiler.sh\",\n     \"build\": \"node ./scripts/rollup/build-all-release-channels.js\",\n-    \"build-for-devtools\": \"cross-env RELEASE_CHANNEL\u003dexperimental yarn build react/index,react/jsx,react/compiler-runtime,react-dom/index,react-dom/client,react-dom/unstable_testing,react-dom/test-utils,react-is,react-debug-tools,scheduler,react-test-renderer,react-refresh,react-art --type\u003dNODE\",\n+    \"build-for-devtools\": \"cross-env yarn build react/index,react/jsx,react/compiler-runtime,react-dom/index,react-dom/client,react-dom/unstable_testing,react-dom/test-utils,react-is,react-debug-tools,scheduler,react-test-renderer,react-refresh,react-art --type\u003dNODE --release-channel\u003dexperimental\",\n     \"build-for-devtools-dev\": \"yarn build-for-devtools --type\u003dNODE_DEV\",\n     \"build-for-devtools-prod\": \"yarn build-for-devtools --type\u003dNODE_PROD\",\n     \"build-for-flight-dev\": \"cross-env RELEASE_CHANNEL\u003dexperimental node ./scripts/rollup/build.js react/index,react/jsx,react.react-server,react-dom/index,react-dom/client,react-dom/server,react-dom.react-server,react-dom-server.node,react-dom-server-legacy.node,scheduler,react-server-dom-webpack/ --type\u003dNODE_DEV,ESM_PROD,NODE_ES2015 \u0026\u0026 mv ./build/node_modules ./build/oss-experimental\",\ndiff --git a/scripts/rollup/build-all-release-channels.js b/scripts/rollup/build-all-release-channels.js\nindex 47d3ac9..95aef66 100644\n--- a/scripts/rollup/build-all-release-channels.js\n+++ b/scripts/rollup/build-all-release-channels.js\n@@ -124,25 +124,34 @@ async function main() {\n         throw new Error(`Unknown release channel ${argv.releaseChannel}`);\n     }\n   } else {\n-    // Running locally, no concurrency. Move each channel\u0027s build artifacts into\n-    // a temporary directory so that they don\u0027t conflict.\n-    buildForChannel(\u0027stable\u0027, \u0027\u0027, \u0027\u0027);\n-    const stableDir \u003d tmp.dirSync().name;\n-    crossDeviceRenameSync(\u0027./build\u0027, stableDir);\n-    processStable(stableDir);\n-    buildForChannel(\u0027experimental\u0027, \u0027\u0027, \u0027\u0027);\n-    const experimentalDir \u003d tmp.dirSync().name;\n-    crossDeviceRenameSync(\u0027./build\u0027, experimentalDir);\n-    processExperimental(experimentalDir);\n-\n-    // Then merge the experimental folder into the stable one. processExperimental\n-    // will have already removed conflicting files.\n-    //\n-    // In CI, merging is handled by the GitHub Download Artifacts plugin.\n-    mergeDirsSync(experimentalDir + \u0027/\u0027, stableDir + \u0027/\u0027);\n-\n-    // Now restore the combined directory back to its original name\n-    crossDeviceRenameSync(stableDir, \u0027./build\u0027);\n+    const releaseChannel \u003d argv.releaseChannel;\n+    if (releaseChannel \u003d\u003d\u003d \u0027stable\u0027) {\n+      buildForChannel(\u0027stable\u0027, \u0027\u0027, \u0027\u0027);\n+      processStable(\u0027./build\u0027);\n+    } else if (releaseChannel \u003d\u003d\u003d \u0027experimental\u0027) {\n+      buildForChannel(\u0027experimental\u0027, \u0027\u0027, \u0027\u0027);\n+      processExperimental(\u0027./build\u0027);\n+    } else {\n+      // Running locally, no concurrency. Move each channel\u0027s build artifacts into\n+      // a temporary directory so that they don\u0027t conflict.\n+      buildForChannel(\u0027stable\u0027, \u0027\u0027, \u0027\u0027);\n+      const stableDir \u003d tmp.dirSync().name;\n+      crossDeviceRenameSync(\u0027./build\u0027, stableDir);\n+      processStable(stableDir);\n+      buildForChannel(\u0027experimental\u0027, \u0027\u0027, \u0027\u0027);\n+      const experimentalDir \u003d tmp.dirSync().name;\n+      crossDeviceRenameSync(\u0027./build\u0027, experimentalDir);\n+      processExperimental(experimentalDir);\n+\n+      // Then merge the experimental folder into the stable one. processExperimental\n+      // will have already removed conflicting files.\n+      //\n+      // In CI, merging is handled by the GitHub Download Artifacts plugin.\n+      mergeDirsSync(experimentalDir + \u0027/\u0027, stableDir + \u0027/\u0027);\n+\n+      // Now restore the combined directory back to its original name\n+      crossDeviceRenameSync(stableDir, \u0027./build\u0027);\n+    }\n   }\n }\n ","expectedMessage":"[release] Allow building single release channel with processed versions (#35270)","repository":"react","commitHash":"36df5e8b42a97df4092f9584e4695bf4537853d5","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-09f05694","diff":" .../babel-plugin-react-compiler/src/HIR/HIR.ts     |   5 +\n .../src/Validation/ValidateNoSetStateInEffects.ts  |  16 +-\n ...State-in-useEffect-via-useEffectEvent.expect.md |  71 ++++++++\n ...lid-setState-in-useEffect-via-useEffectEvent.js |  13 ++\n ...useEffect-via-useEffectEvent-listener.expect.md | 116 +++++++++++++\n ...ate-in-useEffect-via-useEffectEvent-listener.js |  29 ++++\n ...useEffect-via-useEffectEvent-with-ref.expect.md | 192 +++++++++++++++++++++\n ...ate-in-useEffect-via-useEffectEvent-with-ref.js |  59 +++++++\n 8 files changed, 500 insertions(+), 1 deletion(-)\n\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts b/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\nindex 3e4cbb9..fe850f9 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\n@@ -2023,6 +2023,11 @@ export function isUseInsertionEffectHookType(id: Identifier): boolean {\n     id.type.shapeId \u003d\u003d\u003d \u0027BuiltInUseInsertionEffectHook\u0027\n   );\n }\n+export function isUseEffectEventType(id: Identifier): boolean {\n+  return (\n+    id.type.kind \u003d\u003d\u003d \u0027Function\u0027 \u0026\u0026 id.type.shapeId \u003d\u003d\u003d \u0027BuiltInUseEffectEvent\u0027\n+  );\n+}\n \n export function isUseContextHookType(id: Identifier): boolean {\n   return (\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInEffects.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInEffects.ts\nindex 795969b..86070e2 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInEffects.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateNoSetStateInEffects.ts\n@@ -16,6 +16,7 @@ import {\n   IdentifierId,\n   isSetStateType,\n   isUseEffectHookType,\n+  isUseEffectEventType,\n   isUseInsertionEffectHookType,\n   isUseLayoutEffectHookType,\n   isUseRefType,\n@@ -98,7 +99,20 @@ export function validateNoSetStateInEffects(\n             instr.value.kind \u003d\u003d\u003d \u0027MethodCall\u0027\n               ? instr.value.receiver\n               : instr.value.callee;\n-          if (\n+\n+          if (isUseEffectEventType(callee.identifier)) {\n+            const arg \u003d instr.value.args[0];\n+            if (arg !\u003d\u003d undefined \u0026\u0026 arg.kind \u003d\u003d\u003d \u0027Identifier\u0027) {\n+              const setState \u003d setStateFunctions.get(arg.identifier.id);\n+              if (setState !\u003d\u003d undefined) {\n+                /**\n+                 * This effect event function calls setState synchonously,\n+                 * treat it as a setState function for transitive tracking\n+                 */\n+                setStateFunctions.set(instr.lvalue.identifier.id, setState);\n+              }\n+            }\n+          } else if (\n             isUseEffectHookType(callee.identifier) ||\n             isUseLayoutEffectHookType(callee.identifier) ||\n             isUseInsertionEffectHookType(callee.identifier)\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-setState-in-useEffect-via-useEffectEvent.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-setState-in-useEffect-via-useEffectEvent.expect.md\nnew file mode 100644\nindex 0000000..9461692\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-setState-in-useEffect-via-useEffectEvent.expect.md\n@@ -0,0 +1,71 @@\n+\n+## Input\n+\n+```javascript\n+// @loggerTestOnly @validateNoSetStateInEffects\n+import {useEffect, useEffectEvent, useState} from \u0027react\u0027;\n+\n+function Component() {\n+  const [state, setState] \u003d useState(0);\n+  const effectEvent \u003d useEffectEvent(() \u003d\u003e {\n+    setState(true);\n+  });\n+  useEffect(() \u003d\u003e {\n+    effectEvent();\n+  }, []);\n+  return state;\n+}\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @loggerTestOnly @validateNoSetStateInEffects\n+import { useEffect, useEffectEvent, useState } from \"react\";\n+\n+function Component() {\n+  const $ \u003d _c(4);\n+  const [state, setState] \u003d useState(0);\n+  let t0;\n+  if ($[0] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t0 \u003d () \u003d\u003e {\n+      setState(true);\n+    };\n+    $[0] \u003d t0;\n+  } else {\n+    t0 \u003d $[0];\n+  }\n+  const effectEvent \u003d useEffectEvent(t0);\n+  let t1;\n+  if ($[1] !\u003d\u003d effectEvent) {\n+    t1 \u003d () \u003d\u003e {\n+      effectEvent();\n+    };\n+    $[1] \u003d effectEvent;\n+    $[2] \u003d t1;\n+  } else {\n+    t1 \u003d $[2];\n+  }\n+  let t2;\n+  if ($[3] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t2 \u003d [];\n+    $[3] \u003d t2;\n+  } else {\n+    t2 \u003d $[3];\n+  }\n+  useEffect(t1, t2);\n+  return state;\n+}\n+\n+```\n+\n+## Logs\n+\n+```\n+{\"kind\":\"CompileError\",\"detail\":{\"options\":{\"category\":\"EffectSetState\",\"reason\":\"Calling setState synchronously within an effect can trigger cascading renders\",\"description\":\"Effects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\\n* Update external systems with the latest state from React.\\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\\n\\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect)\",\"suggestions\":null,\"details\":[{\"kind\":\"error\",\"loc\":{\"start\":{\"line\":10,\"column\":4,\"index\":267},\"end\":{\"line\":10,\"column\":15,\"index\":278},\"filename\":\"invalid-setState-in-useEffect-via-useEffectEvent.ts\",\"identifierName\":\"effectEvent\"},\"message\":\"Avoid calling setState() directly within an effect\"}]}},\"fnLoc\":null}\n+{\"kind\":\"CompileSuccess\",\"fnLoc\":{\"start\":{\"line\":4,\"column\":0,\"index\":108},\"end\":{\"line\":13,\"column\":1,\"index\":309},\"filename\":\"invalid-setState-in-useEffect-via-useEffectEvent.ts\"},\"fnName\":\"Component\",\"memoSlots\":4,\"memoBlocks\":3,\"memoValues\":3,\"prunedMemoBlocks\":0,\"prunedMemoValues\":0}\n+```\n+      \n+### Eval output\n+(kind: exception) Fixture not implemented\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-setState-in-useEffect-via-useEffectEvent.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-setState-in-useEffect-via-useEffectEvent.js\nnew file mode 100644\nindex 0000000..a838e58\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/invalid-setState-in-useEffect-via-useEffectEvent.js\n@@ -0,0 +1,13 @@\n+// @loggerTestOnly @validateNoSetStateInEffects\n+import {useEffect, useEffectEvent, useState} from \u0027react\u0027;\n+\n+function Component() {\n+  const [state, setState] \u003d useState(0);\n+  const effectEvent \u003d useEffectEvent(() \u003d\u003e {\n+    setState(true);\n+  });\n+  useEffect(() \u003d\u003e {\n+    effectEvent();\n+  }, []);\n+  return state;\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-listener.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-listener.expect.md\nnew file mode 100644\nindex 0000000..d426c74\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-listener.expect.md\n@@ -0,0 +1,116 @@\n+\n+## Input\n+\n+```javascript\n+// @validateNoSetStateInEffects @loggerTestOnly @compilationMode:\"infer\"\n+import {useEffect, useEffectEvent, useState} from \u0027react\u0027;\n+\n+const shouldSetState \u003d false;\n+\n+function Component() {\n+  const [state, setState] \u003d useState(0);\n+  const effectEvent \u003d useEffectEvent(() \u003d\u003e {\n+    setState(10);\n+  });\n+  useEffect(() \u003d\u003e {\n+    setTimeout(effectEvent, 10);\n+  });\n+\n+  const effectEventWithTimeout \u003d useEffectEvent(() \u003d\u003e {\n+    setTimeout(() \u003d\u003e {\n+      setState(20);\n+    }, 10);\n+  });\n+  useEffect(() \u003d\u003e {\n+    effectEventWithTimeout();\n+  }, []);\n+  return state;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Component,\n+  params: [{}],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @validateNoSetStateInEffects @loggerTestOnly @compilationMode:\"infer\"\n+import { useEffect, useEffectEvent, useState } from \"react\";\n+\n+const shouldSetState \u003d false;\n+\n+function Component() {\n+  const $ \u003d _c(7);\n+  const [state, setState] \u003d useState(0);\n+  let t0;\n+  if ($[0] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t0 \u003d () \u003d\u003e {\n+      setState(10);\n+    };\n+    $[0] \u003d t0;\n+  } else {\n+    t0 \u003d $[0];\n+  }\n+  const effectEvent \u003d useEffectEvent(t0);\n+  let t1;\n+  if ($[1] !\u003d\u003d effectEvent) {\n+    t1 \u003d () \u003d\u003e {\n+      setTimeout(effectEvent, 10);\n+    };\n+    $[1] \u003d effectEvent;\n+    $[2] \u003d t1;\n+  } else {\n+    t1 \u003d $[2];\n+  }\n+  useEffect(t1);\n+  let t2;\n+  if ($[3] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t2 \u003d () \u003d\u003e {\n+      setTimeout(() \u003d\u003e {\n+        setState(20);\n+      }, 10);\n+    };\n+    $[3] \u003d t2;\n+  } else {\n+    t2 \u003d $[3];\n+  }\n+  const effectEventWithTimeout \u003d useEffectEvent(t2);\n+  let t3;\n+  if ($[4] !\u003d\u003d effectEventWithTimeout) {\n+    t3 \u003d () \u003d\u003e {\n+      effectEventWithTimeout();\n+    };\n+    $[4] \u003d effectEventWithTimeout;\n+    $[5] \u003d t3;\n+  } else {\n+    t3 \u003d $[5];\n+  }\n+  let t4;\n+  if ($[6] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t4 \u003d [];\n+    $[6] \u003d t4;\n+  } else {\n+    t4 \u003d $[6];\n+  }\n+  useEffect(t3, t4);\n+  return state;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Component,\n+  params: [{}],\n+};\n+\n+```\n+\n+## Logs\n+\n+```\n+{\"kind\":\"CompileSuccess\",\"fnLoc\":{\"start\":{\"line\":6,\"column\":0,\"index\":164},\"end\":{\"line\":24,\"column\":1,\"index\":551},\"filename\":\"valid-setState-in-useEffect-via-useEffectEvent-listener.ts\"},\"fnName\":\"Component\",\"memoSlots\":7,\"memoBlocks\":5,\"memoValues\":5,\"prunedMemoBlocks\":0,\"prunedMemoValues\":0}\n+```\n+      \n+### Eval output\n+(kind: exception) (0 , _react.useEffectEvent) is not a function\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-listener.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-listener.js\nnew file mode 100644\nindex 0000000..e2ebd7f\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-listener.js\n@@ -0,0 +1,29 @@\n+// @validateNoSetStateInEffects @loggerTestOnly @compilationMode:\"infer\"\n+import {useEffect, useEffectEvent, useState} from \u0027react\u0027;\n+\n+const shouldSetState \u003d false;\n+\n+function Component() {\n+  const [state, setState] \u003d useState(0);\n+  const effectEvent \u003d useEffectEvent(() \u003d\u003e {\n+    setState(10);\n+  });\n+  useEffect(() \u003d\u003e {\n+    setTimeout(effectEvent, 10);\n+  });\n+\n+  const effectEventWithTimeout \u003d useEffectEvent(() \u003d\u003e {\n+    setTimeout(() \u003d\u003e {\n+      setState(20);\n+    }, 10);\n+  });\n+  useEffect(() \u003d\u003e {\n+    effectEventWithTimeout();\n+  }, []);\n+  return state;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Component,\n+  params: [{}],\n+};\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-with-ref.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-with-ref.expect.md\nnew file mode 100644\nindex 0000000..f24c39c\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-with-ref.expect.md\n@@ -0,0 +1,192 @@\n+\n+## Input\n+\n+```javascript\n+// @validateNoSetStateInEffects @enableAllowSetStateFromRefsInEffects @loggerTestOnly @compilationMode:\"infer\"\n+import {useState, useRef, useEffect, useEffectEvent} from \u0027react\u0027;\n+\n+function Component({x, y}) {\n+  const previousXRef \u003d useRef(null);\n+  const previousYRef \u003d useRef(null);\n+\n+  const [data, setData] \u003d useState(null);\n+\n+  const effectEvent \u003d useEffectEvent(() \u003d\u003e {\n+    const data \u003d load({x, y});\n+    setData(data);\n+  });\n+\n+  useEffect(() \u003d\u003e {\n+    const previousX \u003d previousXRef.current;\n+    previousXRef.current \u003d x;\n+    const previousY \u003d previousYRef.current;\n+    previousYRef.current \u003d y;\n+    if (!areEqual(x, previousX) || !areEqual(y, previousY)) {\n+      effectEvent();\n+    }\n+  }, [x, y]);\n+\n+  const effectEvent2 \u003d useEffectEvent((xx, yy) \u003d\u003e {\n+    const previousX \u003d previousXRef.current;\n+    previousXRef.current \u003d xx;\n+    const previousY \u003d previousYRef.current;\n+    previousYRef.current \u003d yy;\n+    if (!areEqual(xx, previousX) || !areEqual(yy, previousY)) {\n+      const data \u003d load({x: xx, y: yy});\n+      setData(data);\n+    }\n+  });\n+\n+  useEffect(() \u003d\u003e {\n+    effectEvent2(x, y);\n+  }, [x, y]);\n+\n+  return data;\n+}\n+\n+function areEqual(a, b) {\n+  return a \u003d\u003d\u003d b;\n+}\n+\n+function load({x, y}) {\n+  return x * y;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Component,\n+  params: [{x: 0, y: 0}],\n+  sequentialRenders: [\n+    {x: 0, y: 0},\n+    {x: 1, y: 0},\n+    {x: 1, y: 1},\n+  ],\n+};\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @validateNoSetStateInEffects @enableAllowSetStateFromRefsInEffects @loggerTestOnly @compilationMode:\"infer\"\n+import { useState, useRef, useEffect, useEffectEvent } from \"react\";\n+\n+function Component(t0) {\n+  const $ \u003d _c(18);\n+  const { x, y } \u003d t0;\n+  const previousXRef \u003d useRef(null);\n+  const previousYRef \u003d useRef(null);\n+\n+  const [data, setData] \u003d useState(null);\n+  let t1;\n+  if ($[0] !\u003d\u003d x || $[1] !\u003d\u003d y) {\n+    t1 \u003d () \u003d\u003e {\n+      const data_0 \u003d load({ x, y });\n+      setData(data_0);\n+    };\n+    $[0] \u003d x;\n+    $[1] \u003d y;\n+    $[2] \u003d t1;\n+  } else {\n+    t1 \u003d $[2];\n+  }\n+  const effectEvent \u003d useEffectEvent(t1);\n+  let t2;\n+  if ($[3] !\u003d\u003d effectEvent || $[4] !\u003d\u003d x || $[5] !\u003d\u003d y) {\n+    t2 \u003d () \u003d\u003e {\n+      const previousX \u003d previousXRef.current;\n+      previousXRef.current \u003d x;\n+      const previousY \u003d previousYRef.current;\n+      previousYRef.current \u003d y;\n+      if (!areEqual(x, previousX) || !areEqual(y, previousY)) {\n+        effectEvent();\n+      }\n+    };\n+    $[3] \u003d effectEvent;\n+    $[4] \u003d x;\n+    $[5] \u003d y;\n+    $[6] \u003d t2;\n+  } else {\n+    t2 \u003d $[6];\n+  }\n+  let t3;\n+  if ($[7] !\u003d\u003d x || $[8] !\u003d\u003d y) {\n+    t3 \u003d [x, y];\n+    $[7] \u003d x;\n+    $[8] \u003d y;\n+    $[9] \u003d t3;\n+  } else {\n+    t3 \u003d $[9];\n+  }\n+  useEffect(t2, t3);\n+  let t4;\n+  if ($[10] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t4 \u003d (xx, yy) \u003d\u003e {\n+      const previousX_0 \u003d previousXRef.current;\n+      previousXRef.current \u003d xx;\n+      const previousY_0 \u003d previousYRef.current;\n+      previousYRef.current \u003d yy;\n+      if (!areEqual(xx, previousX_0) || !areEqual(yy, previousY_0)) {\n+        const data_1 \u003d load({ x: xx, y: yy });\n+        setData(data_1);\n+      }\n+    };\n+    $[10] \u003d t4;\n+  } else {\n+    t4 \u003d $[10];\n+  }\n+  const effectEvent2 \u003d useEffectEvent(t4);\n+  let t5;\n+  if ($[11] !\u003d\u003d effectEvent2 || $[12] !\u003d\u003d x || $[13] !\u003d\u003d y) {\n+    t5 \u003d () \u003d\u003e {\n+      effectEvent2(x, y);\n+    };\n+    $[11] \u003d effectEvent2;\n+    $[12] \u003d x;\n+    $[13] \u003d y;\n+    $[14] \u003d t5;\n+  } else {\n+    t5 \u003d $[14];\n+  }\n+  let t6;\n+  if ($[15] !\u003d\u003d x || $[16] !\u003d\u003d y) {\n+    t6 \u003d [x, y];\n+    $[15] \u003d x;\n+    $[16] \u003d y;\n+    $[17] \u003d t6;\n+  } else {\n+    t6 \u003d $[17];\n+  }\n+  useEffect(t5, t6);\n+  return data;\n+}\n+\n+function areEqual(a, b) {\n+  return a \u003d\u003d\u003d b;\n+}\n+\n+function load({ x, y }) {\n+  return x * y;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Component,\n+  params: [{ x: 0, y: 0 }],\n+  sequentialRenders: [\n+    { x: 0, y: 0 },\n+    { x: 1, y: 0 },\n+    { x: 1, y: 1 },\n+  ],\n+};\n+\n+```\n+\n+## Logs\n+\n+```\n+{\"kind\":\"CompileSuccess\",\"fnLoc\":{\"start\":{\"line\":4,\"column\":0,\"index\":179},\"end\":{\"line\":41,\"column\":1,\"index\":1116},\"filename\":\"valid-setState-in-useEffect-via-useEffectEvent-with-ref.ts\"},\"fnName\":\"Component\",\"memoSlots\":18,\"memoBlocks\":6,\"memoValues\":6,\"prunedMemoBlocks\":0,\"prunedMemoValues\":0}\n+```\n+      \n+### Eval output\n+(kind: ok) [[ (exception in render) TypeError: (0 , _react.useEffectEvent) is not a function ]]\n+[[ (exception in render) TypeError: (0 , _react.useEffectEvent) is not a function ]]\n+[[ (exception in render) TypeError: (0 , _react.useEffectEvent) is not a function ]]\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-with-ref.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-with-ref.js\nnew file mode 100644\nindex 0000000..1436edf\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/valid-setState-in-useEffect-via-useEffectEvent-with-ref.js\n@@ -0,0 +1,59 @@\n+// @validateNoSetStateInEffects @enableAllowSetStateFromRefsInEffects @loggerTestOnly @compilationMode:\"infer\"\n+import {useState, useRef, useEffect, useEffectEvent} from \u0027react\u0027;\n+\n+function Component({x, y}) {\n+  const previousXRef \u003d useRef(null);\n+  const previousYRef \u003d useRef(null);\n+\n+  const [data, setData] \u003d useState(null);\n+\n+  const effectEvent \u003d useEffectEvent(() \u003d\u003e {\n+    const data \u003d load({x, y});\n+    setData(data);\n+  });\n+\n+  useEffect(() \u003d\u003e {\n+    const previousX \u003d previousXRef.current;\n+    previousXRef.current \u003d x;\n+    const previousY \u003d previousYRef.current;\n+    previousYRef.current \u003d y;\n+    if (!areEqual(x, previousX) || !areEqual(y, previousY)) {\n+      effectEvent();\n+    }\n+  }, [x, y]);\n+\n+  const effectEvent2 \u003d useEffectEvent((xx, yy) \u003d\u003e {\n+    const previousX \u003d previousXRef.current;\n+    previousXRef.current \u003d xx;\n+    const previousY \u003d previousYRef.current;\n+    previousYRef.current \u003d yy;\n+    if (!areEqual(xx, previousX) || !areEqual(yy, previousY)) {\n+      const data \u003d load({x: xx, y: yy});\n+      setData(data);\n+    }\n+  });\n+\n+  useEffect(() \u003d\u003e {\n+    effectEvent2(x, y);\n+  }, [x, y]);\n+\n+  return data;\n+}\n+\n+function areEqual(a, b) {\n+  return a \u003d\u003d\u003d b;\n+}\n+\n+function load({x, y}) {\n+  return x * y;\n+}\n+\n+export const FIXTURE_ENTRYPOINT \u003d {\n+  fn: Component,\n+  params: [{x: 0, y: 0}],\n+  sequentialRenders: [\n+    {x: 0, y: 0},\n+    {x: 1, y: 0},\n+    {x: 1, y: 1},\n+  ],\n+};","expectedMessage":"[compiler] Extend setState in effect validation to useEffectEvent (#35214)","repository":"react","commitHash":"09f05694a25578c46e846e4ff9495f7c1352c29c","metadata":{"author":"Jack Pope \u003cjackpope1@gmail.com\u003e"}}
{"id":"react-0af4fd80","diff":" fixtures/eslint-v6/index.js | 4 ++--\n fixtures/eslint-v7/index.js | 4 ++--\n fixtures/eslint-v8/index.js | 4 ++--\n fixtures/eslint-v9/index.js | 6 ++++--\n 4 files changed, 10 insertions(+), 8 deletions(-)\n\ndiff --git a/fixtures/eslint-v6/index.js b/fixtures/eslint-v6/index.js\nindex 23af473..143228e 100644\n--- a/fixtures/eslint-v6/index.js\n+++ b/fixtures/eslint-v6/index.js\n@@ -159,9 +159,9 @@ function InvalidGlobals() {\n   return \u003cdiv\u003eDone\u003c/div\u003e;\n }\n \n-// Invalid: useMemo with wrong deps - triggers preserve-manual-memoization\n+// Invalid: useMemo with wrong deps\n function InvalidUseMemo({items}) {\n-  // eslint-disable-next-line react-hooks/preserve-manual-memoization, react-hooks/exhaustive-deps\n+  // eslint-disable-next-line react-hooks/exhaustive-deps\n   const sorted \u003d useMemo(() \u003d\u003e [...items].sort(), []);\n   return \u003cdiv\u003e{sorted.length}\u003c/div\u003e;\n }\ndiff --git a/fixtures/eslint-v7/index.js b/fixtures/eslint-v7/index.js\nindex 23af473..143228e 100644\n--- a/fixtures/eslint-v7/index.js\n+++ b/fixtures/eslint-v7/index.js\n@@ -159,9 +159,9 @@ function InvalidGlobals() {\n   return \u003cdiv\u003eDone\u003c/div\u003e;\n }\n \n-// Invalid: useMemo with wrong deps - triggers preserve-manual-memoization\n+// Invalid: useMemo with wrong deps\n function InvalidUseMemo({items}) {\n-  // eslint-disable-next-line react-hooks/preserve-manual-memoization, react-hooks/exhaustive-deps\n+  // eslint-disable-next-line react-hooks/exhaustive-deps\n   const sorted \u003d useMemo(() \u003d\u003e [...items].sort(), []);\n   return \u003cdiv\u003e{sorted.length}\u003c/div\u003e;\n }\ndiff --git a/fixtures/eslint-v8/index.js b/fixtures/eslint-v8/index.js\nindex 23af473..143228e 100644\n--- a/fixtures/eslint-v8/index.js\n+++ b/fixtures/eslint-v8/index.js\n@@ -159,9 +159,9 @@ function InvalidGlobals() {\n   return \u003cdiv\u003eDone\u003c/div\u003e;\n }\n \n-// Invalid: useMemo with wrong deps - triggers preserve-manual-memoization\n+// Invalid: useMemo with wrong deps\n function InvalidUseMemo({items}) {\n-  // eslint-disable-next-line react-hooks/preserve-manual-memoization, react-hooks/exhaustive-deps\n+  // eslint-disable-next-line react-hooks/exhaustive-deps\n   const sorted \u003d useMemo(() \u003d\u003e [...items].sort(), []);\n   return \u003cdiv\u003e{sorted.length}\u003c/div\u003e;\n }\ndiff --git a/fixtures/eslint-v9/index.js b/fixtures/eslint-v9/index.js\nindex 23af473..5a43235 100644\n--- a/fixtures/eslint-v9/index.js\n+++ b/fixtures/eslint-v9/index.js\n@@ -70,6 +70,7 @@ function ComponentWithoutDeclaringPropAsDep(props) {\n     console.log(props.foo);\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, []);\n+  // eslint-disable-next-line react-hooks/void-use-memo\n   useMemo(() \u003d\u003e {\n     console.log(props.foo);\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n@@ -82,6 +83,7 @@ function ComponentWithoutDeclaringPropAsDep(props) {\n     console.log(props.foo);\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n   }, []);\n+  // eslint-disable-next-line react-hooks/void-use-memo\n   React.useMemo(() \u003d\u003e {\n     console.log(props.foo);\n     // eslint-disable-next-line react-hooks/exhaustive-deps\n@@ -159,9 +161,9 @@ function InvalidGlobals() {\n   return \u003cdiv\u003eDone\u003c/div\u003e;\n }\n \n-// Invalid: useMemo with wrong deps - triggers preserve-manual-memoization\n+// Invalid: useMemo with wrong deps\n function InvalidUseMemo({items}) {\n-  // eslint-disable-next-line react-hooks/preserve-manual-memoization, react-hooks/exhaustive-deps\n+  // eslint-disable-next-line react-hooks/exhaustive-deps\n   const sorted \u003d useMemo(() \u003d\u003e [...items].sort(), []);\n   return \u003cdiv\u003e{sorted.length}\u003c/div\u003e;\n }","expectedMessage":"[test] Update ESLint e2e tests (#35233)","repository":"react","commitHash":"0af4fd80ed0ceb85b472b079c94a96b8526fcd06","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-1721e73e","diff":" scripts/jest/setupTests.js | 7 +++++++\n 1 file changed, 7 insertions(+)\n\ndiff --git a/scripts/jest/setupTests.js b/scripts/jest/setupTests.js\nindex 1e8d8e5..758ac5e 100644\n--- a/scripts/jest/setupTests.js\n+++ b/scripts/jest/setupTests.js\n@@ -136,6 +136,13 @@ if (process.env.REACT_CLASS_EQUIVALENCE_TEST) {\n           }\n           return Reflect.set(target, key, value, receiver);\n         },\n+        get(target, key, receiver) {\n+          if (key \u003d\u003d\u003d \u0027stack\u0027) {\n+            // https://github.com/nodejs/node/issues/60862\n+            return Reflect.get(target, key);\n+          }\n+          return Reflect.get(target, key, receiver);\n+        },\n       });\n       originalErrorInstances.set(proxy, error);\n       return proxy;","expectedMessage":"[test] Fix Error Proxy in Node.js 21+ (#35227)","repository":"react","commitHash":"1721e73e149d482a4421d4ea9f76d36a2c79ad02","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-6875c3ea","diff":" .../react-devtools-shared/src/__tests__/storeComponentFilters-test.js   | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/packages/react-devtools-shared/src/__tests__/storeComponentFilters-test.js b/packages/react-devtools-shared/src/__tests__/storeComponentFilters-test.js\nindex 45b89ec..16b013c 100644\n--- a/packages/react-devtools-shared/src/__tests__/storeComponentFilters-test.js\n+++ b/packages/react-devtools-shared/src/__tests__/storeComponentFilters-test.js\n@@ -753,7 +753,7 @@ describe(\u0027Store component filters\u0027, () \u003d\u003e {\n     });\n   });\n \n-  // @reactVersion \u003e\u003d 16.6\n+  // @reactVersion \u003e\u003d 18.0\n   it(\u0027resets forced error and fallback states when filters are changed\u0027, async () \u003d\u003e {\n     store.componentFilters \u003d [];\n     class ErrorBoundary extends React.Component {","expectedMessage":"[test] Only run tests overriding fallback and error states in supported versions (#35234)","repository":"react","commitHash":"6875c3eab48179f3c74a8a9f825c09554f683d7d","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-74fa1667","diff":" .../src/devtools/views/SuspenseTab/ActivityList.js | 85 ++++++++++++----------\n 1 file changed, 47 insertions(+), 38 deletions(-)\n\ndiff --git a/packages/react-devtools-shared/src/devtools/views/SuspenseTab/ActivityList.js b/packages/react-devtools-shared/src/devtools/views/SuspenseTab/ActivityList.js\nindex 3a6935b..acef66d 100644\n--- a/packages/react-devtools-shared/src/devtools/views/SuspenseTab/ActivityList.js\n+++ b/packages/react-devtools-shared/src/devtools/views/SuspenseTab/ActivityList.js\n@@ -30,8 +30,6 @@ import {\n } from \u0027../Components/TreeContext\u0027;\n import {useHighlightHostInstance} from \u0027../hooks\u0027;\n import {StoreContext} from \u0027../context\u0027;\n-import ButtonIcon from \u0027../ButtonIcon\u0027;\n-import Button from \u0027../Button\u0027;\n \n export function useChangeActivitySliceAction(): (\n   id: Element[\u0027id\u0027] | null,\n@@ -118,6 +116,8 @@ export default function ActivityList({\n     useTransition();\n   const changeActivitySliceAction \u003d useChangeActivitySliceAction();\n \n+  const includeAllOption \u003d activityID !\u003d\u003d null;\n+\n   function handleKeyDown(event: SyntheticKeyboardEvent) {\n     switch (event.key) {\n       case \u0027Escape\u0027:\n@@ -128,15 +128,16 @@ export default function ActivityList({\n         break;\n       case \u0027Enter\u0027:\n       case \u0027 \u0027:\n-        if (inspectedElementID !\u003d\u003d null) {\n-          startActivitySliceSelection(() \u003d\u003e {\n-            changeActivitySliceAction(inspectedElementID);\n-          });\n-        }\n+        startActivitySliceSelection(() \u003d\u003e {\n+          changeActivitySliceAction(inspectedElementID);\n+        });\n         event.preventDefault();\n         break;\n       case \u0027Home\u0027:\n-        treeDispatch({type: \u0027SELECT_ELEMENT_BY_ID\u0027, payload: activities[0].id});\n+        treeDispatch({\n+          type: \u0027SELECT_ELEMENT_BY_ID\u0027,\n+          payload: includeAllOption ? null : activities[0].id,\n+        });\n         event.preventDefault();\n         break;\n       case \u0027End\u0027:\n@@ -150,15 +151,21 @@ export default function ActivityList({\n         const currentIndex \u003d activities.findIndex(\n           activity \u003d\u003e activity.id \u003d\u003d\u003d selectedActivityID,\n         );\n-        if (currentIndex !\u003d\u003d undefined) {\n-          const nextIndex \u003d\n-            (currentIndex + activities.length - 1) % activities.length;\n-\n-          treeDispatch({\n-            type: \u0027SELECT_ELEMENT_BY_ID\u0027,\n-            payload: activities[nextIndex].id,\n-          });\n+        let nextIndex: number;\n+        if (currentIndex \u003d\u003d\u003d -1) {\n+          // Currently selecting \"All\", wrap around to last Activity.\n+          nextIndex \u003d activities.length - 1;\n+        } else {\n+          nextIndex \u003d currentIndex - 1;\n+          if (!includeAllOption) {\n+            nextIndex \u003d (nextIndex + activities.length) % activities.length;\n+          }\n         }\n+\n+        treeDispatch({\n+          type: \u0027SELECT_ELEMENT_BY_ID\u0027,\n+          payload: nextIndex \u003d\u003d\u003d -1 ? null : activities[nextIndex].id,\n+        });\n         event.preventDefault();\n         break;\n       }\n@@ -166,14 +173,17 @@ export default function ActivityList({\n         const currentIndex \u003d activities.findIndex(\n           activity \u003d\u003e activity.id \u003d\u003d\u003d selectedActivityID,\n         );\n-        if (currentIndex !\u003d\u003d undefined) {\n-          const nextIndex \u003d (currentIndex + 1) % activities.length;\n-\n-          treeDispatch({\n-            type: \u0027SELECT_ELEMENT_BY_ID\u0027,\n-            payload: activities[nextIndex].id,\n-          });\n+        let nextIndex: number;\n+        if (includeAllOption \u0026\u0026 currentIndex \u003d\u003d\u003d activities.length - 1) {\n+          // Currently selecting last Activity, wrap around to \"All\".\n+          nextIndex \u003d -1;\n+        } else {\n+          nextIndex \u003d (currentIndex + 1) % activities.length;\n         }\n+        treeDispatch({\n+          type: \u0027SELECT_ELEMENT_BY_ID\u0027,\n+          payload: nextIndex \u003d\u003d\u003d -1 ? null : activities[nextIndex].id,\n+        });\n         event.preventDefault();\n         break;\n       }\n@@ -182,7 +192,7 @@ export default function ActivityList({\n     }\n   }\n \n-  function handleClick(id: Element[\u0027id\u0027], event: SyntheticMouseEvent) {\n+  function handleClick(id: Element[\u0027id\u0027] | null, event: SyntheticMouseEvent) {\n     event.preventDefault();\n     treeDispatch({type: \u0027SELECT_ELEMENT_BY_ID\u0027, payload: id});\n   }\n@@ -195,25 +205,24 @@ export default function ActivityList({\n \n   return (\n     \u003cdiv className\u003d{styles.ActivityListContaier}\u003e\n-      \u003cdiv className\u003d{styles.ActivityListHeader}\u003e\n-        {activityID !\u003d\u003d null \u0026\u0026 (\n-          // TODO: Obsolete once filtered Activities are included in this list.\n-          \u003cButton\n-            onClick\u003d{startActivitySliceSelection.bind(\n-              null,\n-              changeActivitySliceAction.bind(null, null),\n-            )}\n-            title\u003d\"Back to full tree view\"\u003e\n-            \u003cButtonIcon type\u003d\"previous\" /\u003e\n-          \u003c/Button\u003e\n-        )}\n-      \u003c/div\u003e\n+      \u003cdiv className\u003d{styles.ActivityListHeader} /\u003e\n       \u003col\n         role\u003d\"listbox\"\n         className\u003d{styles.ActivityListList}\n         data-pending-activity-slice-selection\u003d{isPendingActivitySliceSelection}\n         tabIndex\u003d{0}\n         onKeyDown\u003d{handleKeyDown}\u003e\n+        {includeAllOption \u0026\u0026 (\n+          // TODO: Obsolete once filtered Activities are included in this list.\n+          \u003cli\n+            role\u003d\"option\"\n+            aria-selected\u003d{null \u003d\u003d\u003d selectedActivityID ? \u0027true\u0027 : \u0027false\u0027}\n+            className\u003d{styles.ActivityListItem}\n+            onClick\u003d{handleClick.bind(null, null)}\n+            onDoubleClick\u003d{handleDoubleClick}\u003e\n+            All\n+          \u003c/li\u003e\n+        )}\n         {activities.map(({id, depth}) \u003d\u003e {\n           const activity \u003d store.getElementByID(id);\n           if (activity \u003d\u003d\u003d null) {\n@@ -244,7 +253,7 @@ export default function ActivityList({\n                 false,\n               )}\n               onPointerLeave\u003d{clearHighlightHostInstance}\u003e\n-              {\u0027\\u00A0\u0027.repeat(depth) + name}\n+              {\u0027\\u00A0\u0027.repeat(depth + (includeAllOption ? 1 : 0)) + name}\n             \u003c/li\u003e\n           );\n         })}","expectedMessage":"[DevTools] Move \"Back to full tree view\" into Activity list item (#35164)","repository":"react","commitHash":"74fa1667a7355fd55591d82b0e1e992909b1dca0","metadata":{"author":"Sebastian \"Sebbie\" Silbermann \u003csebastian.silbermann@vercel.com\u003e"}}
{"id":"react-627b5836","diff":" compiler/packages/snap/src/fixture-utils.ts | 30 ++++++++++-------------------\n 1 file changed, 10 insertions(+), 20 deletions(-)\n\ndiff --git a/compiler/packages/snap/src/fixture-utils.ts b/compiler/packages/snap/src/fixture-utils.ts\nindex ebf6a34..fae6afe 100644\n--- a/compiler/packages/snap/src/fixture-utils.ts\n+++ b/compiler/packages/snap/src/fixture-utils.ts\n@@ -44,21 +44,6 @@ function stripExtension(filename: string, extensions: Array\u003cstring\u003e): string {\n   return filename;\n }\n \n-/**\n- * Strip all extensions from a filename\n- * e.g., \"foo.expect.md\" -\u003e \"foo\"\n- */\n-function stripAllExtensions(filename: string): string {\n-  let result \u003d filename;\n-  while (true) {\n-    const extension \u003d path.extname(result);\n-    if (extension \u003d\u003d\u003d \u0027\u0027) {\n-      return result;\n-    }\n-    result \u003d path.basename(result, extension);\n-  }\n-}\n-\n export async function readTestFilter(): Promise\u003cTestFilter | null\u003e {\n   if (!(await exists(FILTER_PATH))) {\n     throw new Error(`testfilter file not found at \\`${FILTER_PATH}\\``);\n@@ -134,13 +119,15 @@ async function readInputFixtures(\n           // `alias-while` \u003d\u003e search for `alias-while{.js,.jsx,.ts,.tsx}`\n           // `alias-while.js` \u003d\u003e search as-is\n           // `alias-while.expect.md` \u003d\u003e search for `alias-while{.js,.jsx,.ts,.tsx}`\n-          const basename \u003d path.basename(pattern);\n-          const basenameWithoutExt \u003d stripAllExtensions(basename);\n-          const hasExtension \u003d basename !\u003d\u003d basenameWithoutExt;\n+          const patternWithoutExt \u003d stripExtension(pattern, [\n+            ...INPUT_EXTENSIONS,\n+            SNAPSHOT_EXTENSION,\n+          ]);\n+          const hasExtension \u003d pattern !\u003d\u003d patternWithoutExt;\n           const globPattern \u003d\n             hasExtension \u0026\u0026 !pattern.endsWith(SNAPSHOT_EXTENSION)\n               ? pattern\n-              : `${basenameWithoutExt}{${INPUT_EXTENSIONS.join(\u0027,\u0027)}}`;\n+              : `${patternWithoutExt}{${INPUT_EXTENSIONS.join(\u0027,\u0027)}}`;\n           return glob.glob(globPattern, {\n             cwd: rootDir,\n           });\n@@ -181,7 +168,10 @@ async function readOutputFixtures(\n       await Promise.all(\n         filter.paths.map(pattern \u003d\u003e {\n           // Strip all extensions and find matching .expect.md files\n-          const basenameWithoutExt \u003d stripAllExtensions(pattern);\n+          const basenameWithoutExt \u003d stripExtension(pattern, [\n+            ...INPUT_EXTENSIONS,\n+            SNAPSHOT_EXTENSION,\n+          ]);\n           return glob.glob(`${basenameWithoutExt}${SNAPSHOT_EXTENSION}`, {\n             cwd: rootDir,\n           });","expectedMessage":"[compiler][snap] Fix for filter mode with nested files, \u0027error.\u0027 prefix (#35215)","repository":"react","commitHash":"627b583650078514eff22498514682a8522282b1","metadata":{"author":"Joseph Savona \u003c6425824+josephsavona@users.noreply.github.com\u003e"}}
{"id":"react-fb18ad3f","diff":" .../babel-plugin-react-compiler/src/HIR/HIR.ts     |   1 +\n .../src/Inference/DropManualMemoization.ts         |   3 +\n .../Validation/ValidateExhaustiveDependencies.ts   | 148 ++++++++++-----\n .../ValidatePreservedManualMemoization.ts          |   4 +\n .../error.invalid-exhaustive-deps.expect.md        | 109 -----------\n ...-exhaustive-deps-violation-in-effects.expect.md |   0\n ...es-with-exhaustive-deps-violation-in-effects.js |   0\n ...rror.invalid-dep-on-ref-current-value.expect.md |  40 ++++\n .../error.invalid-dep-on-ref-current-value.js      |  10 +\n ...ive-deps-disallow-unused-stable-types.expect.md |  10 +-\n ...exhaustive-deps-disallow-unused-stable-types.js |   0\n .../error.invalid-exhaustive-deps.expect.md        | 204 +++++++++++++++++++++\n .../error.invalid-exhaustive-deps.js               |   0\n ...issing-nonreactive-dep-inner-function.expect.md |  43 +++++\n ...valid-missing-nonreactive-dep-inner-function.js |  15 ++\n ...id-missing-nonreactive-dep-unmemoized.expect.md |  43 +++++\n ...r.invalid-missing-nonreactive-dep-unmemoized.js |  13 ++\n ...error.invalid-missing-nonreactive-dep.expect.md |  40 ++++\n .../error.invalid-missing-nonreactive-dep.js       |  10 +\n .../error.sketchy-code-exhaustive-deps.expect.md   |   6 +-\n .../error.sketchy-code-exhaustive-deps.js          |   0\n ...ive-deps-allow-constant-folded-values.expect.md |   0\n ...exhaustive-deps-allow-constant-folded-values.js |   0\n ...onreactive-stable-types-as-extra-deps.expect.md |   0\n ...allow-nonreactive-stable-types-as-extra-deps.js |   0\n .../exhaustive-deps.expect.md                      |   0\n .../{ \u003d\u003e exhaustive-deps}/exhaustive-deps.js       |   0\n ...seMemo-unrelated-mutation-in-depslist.expect.md |   6 +-\n 28 files changed, 545 insertions(+), 160 deletions(-)\n\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts b/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\nindex 9fb360c..3e4cbb9 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\n@@ -807,6 +807,7 @@ export type ManualMemoDependency \u003d {\n       }\n     | {kind: \u0027Global\u0027; identifierName: string};\n   path: DependencyPath;\n+  loc: SourceLocation;\n };\n \n export type StartMemoize \u003d {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Inference/DropManualMemoization.ts b/compiler/packages/babel-plugin-react-compiler/src/Inference/DropManualMemoization.ts\nindex 0138e52..647562a 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Inference/DropManualMemoization.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Inference/DropManualMemoization.ts\n@@ -65,6 +65,7 @@ export function collectMaybeMemoDependencies(\n           identifierName: value.binding.name,\n         },\n         path: [],\n+        loc: value.loc,\n       };\n     }\n     case \u0027PropertyLoad\u0027: {\n@@ -74,6 +75,7 @@ export function collectMaybeMemoDependencies(\n           root: object.root,\n           // TODO: determine if the access is optional\n           path: [...object.path, {property: value.property, optional}],\n+          loc: value.loc,\n         };\n       }\n       break;\n@@ -95,6 +97,7 @@ export function collectMaybeMemoDependencies(\n             constant: false,\n           },\n           path: [],\n+          loc: value.place.loc,\n         };\n       }\n       break;\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\nindex 5035fa9..2e6217b 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\n@@ -241,11 +241,10 @@ export function validateExhaustiveDependencies(\n           matched.add(manualDependency);\n         }\n       }\n-      const isOptionalDependency \u003d\n-        !reactive.has(inferredDependency.identifier.id) \u0026\u0026\n-        (isStableType(inferredDependency.identifier) ||\n-          isPrimitiveType(inferredDependency.identifier));\n-      if (hasMatchingManualDependency || isOptionalDependency) {\n+      if (\n+        hasMatchingManualDependency ||\n+        isOptionalDependency(inferredDependency, reactive)\n+      ) {\n         continue;\n       }\n       missing.push(inferredDependency);\n@@ -274,54 +273,106 @@ export function validateExhaustiveDependencies(\n     }\n \n     if (missing.length !\u003d\u003d 0 || extra.length !\u003d\u003d 0) {\n-      let suggestions: Array\u003cCompilerSuggestion\u003e | null \u003d null;\n+      let suggestion: CompilerSuggestion | null \u003d null;\n       if (startMemo.depsLoc !\u003d null \u0026\u0026 typeof startMemo.depsLoc !\u003d\u003d \u0027symbol\u0027) {\n-        suggestions \u003d [\n-          {\n-            description: \u0027Update dependencies\u0027,\n-            range: [startMemo.depsLoc.start.index, startMemo.depsLoc.end.index],\n-            op: CompilerSuggestionOperation.Replace,\n-            text: `[${inferred.map(printInferredDependency).join(\u0027, \u0027)}]`,\n-          },\n-        ];\n+        suggestion \u003d {\n+          description: \u0027Update dependencies\u0027,\n+          range: [startMemo.depsLoc.start.index, startMemo.depsLoc.end.index],\n+          op: CompilerSuggestionOperation.Replace,\n+          text: `[${inferred\n+            .filter(\n+              dep \u003d\u003e\n+                dep.kind \u003d\u003d\u003d \u0027Local\u0027 \u0026\u0026 !isOptionalDependency(dep, reactive),\n+            )\n+            .map(printInferredDependency)\n+            .join(\u0027, \u0027)}]`,\n+        };\n       }\n-      if (missing.length !\u003d\u003d 0) {\n-        const diagnostic \u003d CompilerDiagnostic.create({\n-          category: ErrorCategory.MemoDependencies,\n-          reason: \u0027Found missing memoization dependencies\u0027,\n-          description:\n-            \u0027Missing dependencies can cause a value not to update when those inputs change, \u0027 +\n-            \u0027resulting in stale UI\u0027,\n-          suggestions,\n+      const diagnostic \u003d CompilerDiagnostic.create({\n+        category: ErrorCategory.MemoDependencies,\n+        reason: \u0027Found missing/extra memoization dependencies\u0027,\n+        description: [\n+          missing.length !\u003d\u003d 0\n+            ? \u0027Missing dependencies can cause a value to update less often than it should, \u0027 +\n+              \u0027resulting in stale UI\u0027\n+            : null,\n+          extra.length !\u003d\u003d 0\n+            ? \u0027Extra dependencies can cause a value to update more often than it should, \u0027 +\n+              \u0027resulting in performance problems such as excessive renders or effects firing too often\u0027\n+            : null,\n+        ]\n+          .filter(Boolean)\n+          .join(\u0027. \u0027),\n+        suggestions: suggestion !\u003d null ? [suggestion] : null,\n+      });\n+      for (const dep of missing) {\n+        let reactiveStableValueHint \u003d \u0027\u0027;\n+        if (isStableType(dep.identifier)) {\n+          reactiveStableValueHint \u003d\n+            \u0027. Refs, setState functions, and other \"stable\" values generally do not need to be added \u0027 +\n+            \u0027as dependencies, but this variable may change over time to point to different values\u0027;\n+        }\n+        diagnostic.withDetails({\n+          kind: \u0027error\u0027,\n+          message: `Missing dependency \\`${printInferredDependency(dep)}\\`${reactiveStableValueHint}`,\n+          loc: dep.loc,\n         });\n-        for (const dep of missing) {\n-          let reactiveStableValueHint \u003d \u0027\u0027;\n-          if (isStableType(dep.identifier)) {\n-            reactiveStableValueHint \u003d\n-              \u0027. Refs, setState functions, and other \"stable\" values generally do not need to be added as dependencies, but this variable may change over time to point to different values\u0027;\n-          }\n+      }\n+      for (const dep of extra) {\n+        if (dep.root.kind \u003d\u003d\u003d \u0027Global\u0027) {\n           diagnostic.withDetails({\n             kind: \u0027error\u0027,\n-            message: `Missing dependency \\`${printInferredDependency(dep)}\\`${reactiveStableValueHint}`,\n-            loc: dep.loc,\n+            message:\n+              `Unnecessary dependency \\`${printManualMemoDependency(dep)}\\`. ` +\n+              \u0027Values declared outside of a component/hook should not be listed as \u0027 +\n+              \u0027dependencies as the component will not re-render if they change\u0027,\n+            loc: dep.loc ?? startMemo.depsLoc ?? value.loc,\n           });\n+          error.pushDiagnostic(diagnostic);\n+        } else {\n+          const root \u003d dep.root.value;\n+          const matchingInferred \u003d inferred.find(\n+            (\n+              inferredDep,\n+            ): inferredDep is Extract\u003cInferredDependency, {kind: \u0027Local\u0027}\u003e \u003d\u003e {\n+              return (\n+                inferredDep.kind \u003d\u003d\u003d \u0027Local\u0027 \u0026\u0026\n+                inferredDep.identifier.id \u003d\u003d\u003d root.identifier.id \u0026\u0026\n+                isSubPathIgnoringOptionals(inferredDep.path, dep.path)\n+              );\n+            },\n+          );\n+          if (\n+            matchingInferred !\u003d null \u0026\u0026\n+            !isOptionalDependency(matchingInferred, reactive)\n+          ) {\n+            diagnostic.withDetails({\n+              kind: \u0027error\u0027,\n+              message:\n+                `Overly precise dependency \\`${printManualMemoDependency(dep)}\\`, ` +\n+                `use \\`${printInferredDependency(matchingInferred)}\\` instead`,\n+              loc: dep.loc ?? startMemo.depsLoc ?? value.loc,\n+            });\n+          } else {\n+            /**\n+             * Else this dependency doesn\u0027t correspond to anything referenced in the memo function,\n+             * or is an optional dependency so we don\u0027t want to suggest adding it\n+             */\n+            diagnostic.withDetails({\n+              kind: \u0027error\u0027,\n+              message: `Unnecessary dependency \\`${printManualMemoDependency(dep)}\\``,\n+              loc: dep.loc ?? startMemo.depsLoc ?? value.loc,\n+            });\n+          }\n         }\n-        error.pushDiagnostic(diagnostic);\n-      } else if (extra.length !\u003d\u003d 0) {\n-        const diagnostic \u003d CompilerDiagnostic.create({\n-          category: ErrorCategory.MemoDependencies,\n-          reason: \u0027Found unnecessary memoization dependencies\u0027,\n-          description:\n-            \u0027Unnecessary dependencies can cause a value to update more often than necessary, \u0027 +\n-            \u0027causing performance regressions and effects to fire more often than expected\u0027,\n-        });\n+      }\n+      if (suggestion !\u003d null) {\n         diagnostic.withDetails({\n-          kind: \u0027error\u0027,\n-          message: `Unnecessary dependencies ${extra.map(dep \u003d\u003e `\\`${printManualMemoDependency(dep)}\\``).join(\u0027, \u0027)}`,\n-          loc: startMemo.depsLoc ?? value.loc,\n+          kind: \u0027hint\u0027,\n+          message: `Inferred dependencies: \\`${suggestion.text}\\``,\n         });\n-        error.pushDiagnostic(diagnostic);\n       }\n+      error.pushDiagnostic(diagnostic);\n     }\n \n     dependencies.clear();\n@@ -826,3 +877,14 @@ export function findOptionalPlaces(\n   }\n   return optionals;\n }\n+\n+function isOptionalDependency(\n+  inferredDependency: Extract\u003cInferredDependency, {kind: \u0027Local\u0027}\u003e,\n+  reactive: Set\u003cIdentifierId\u003e,\n+): boolean {\n+  return (\n+    !reactive.has(inferredDependency.identifier.id) \u0026\u0026\n+    (isStableType(inferredDependency.identifier) ||\n+      isPrimitiveType(inferredDependency.identifier))\n+  );\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidatePreservedManualMemoization.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidatePreservedManualMemoization.ts\nindex 48cec3c..9b1bf22 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidatePreservedManualMemoization.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidatePreservedManualMemoization.ts\n@@ -242,6 +242,7 @@ function validateInferredDep(\n     normalizedDep \u003d {\n       root: maybeNormalizedRoot.root,\n       path: [...maybeNormalizedRoot.path, ...dep.path],\n+      loc: maybeNormalizedRoot.loc,\n     };\n   } else {\n     CompilerError.invariant(dep.identifier.name?.kind \u003d\u003d\u003d \u0027named\u0027, {\n@@ -270,6 +271,7 @@ function validateInferredDep(\n         constant: false,\n       },\n       path: [...dep.path],\n+      loc: GeneratedSource,\n     };\n   }\n   for (const decl of declsWithinMemoBlock) {\n@@ -383,6 +385,7 @@ class Visitor extends ReactiveFunctionVisitor\u003cVisitorState\u003e {\n                   constant: false,\n                 },\n                 path: [],\n+                loc: storeTarget.loc,\n               });\n             }\n           }\n@@ -413,6 +416,7 @@ class Visitor extends ReactiveFunctionVisitor\u003cVisitorState\u003e {\n           constant: false,\n         },\n         path: [],\n+        loc: lvalue.loc,\n       });\n     }\n   }\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.expect.md\ndeleted file mode 100644\nindex ed317be..0000000\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.expect.md\n+++ /dev/null\n@@ -1,109 +0,0 @@\n-\n-## Input\n-\n-```javascript\n-// @validateExhaustiveMemoizationDependencies\n-import {useMemo} from \u0027react\u0027;\n-import {Stringify} from \u0027shared-runtime\u0027;\n-\n-function Component({x, y, z}) {\n-  const a \u003d useMemo(() \u003d\u003e {\n-    return x?.y.z?.a;\n-    // error: too precise\n-  }, [x?.y.z?.a.b]);\n-  const b \u003d useMemo(() \u003d\u003e {\n-    return x.y.z?.a;\n-    // ok, not our job to type check nullability\n-  }, [x.y.z.a]);\n-  const c \u003d useMemo(() \u003d\u003e {\n-    return x?.y.z.a?.b;\n-    // error: too precise\n-  }, [x?.y.z.a?.b.z]);\n-  const d \u003d useMemo(() \u003d\u003e {\n-    return x?.y?.[(console.log(y), z?.b)];\n-    // ok\n-  }, [x?.y, y, z?.b]);\n-  const e \u003d useMemo(() \u003d\u003e {\n-    const e \u003d [];\n-    e.push(x);\n-    return e;\n-    // ok\n-  }, [x]);\n-  const f \u003d useMemo(() \u003d\u003e {\n-    return [];\n-    // error: unnecessary\n-  }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n-  const ref1 \u003d useRef(null);\n-  const ref2 \u003d useRef(null);\n-  const ref \u003d z ? ref1 : ref2;\n-  const cb \u003d useMemo(() \u003d\u003e {\n-    return () \u003d\u003e {\n-      return ref.current;\n-    };\n-    // error: ref is a stable type but reactive\n-  }, []);\n-  return \u003cStringify results\u003d{[a, b, c, d, e, f, cb]} /\u003e;\n-}\n-\n-```\n-\n-\n-## Error\n-\n-```\n-Found 4 errors:\n-\n-Error: Found missing memoization dependencies\n-\n-Missing dependencies can cause a value not to update when those inputs change, resulting in stale UI.\n-\n-error.invalid-exhaustive-deps.ts:7:11\n-   5 | function Component({x, y, z}) {\n-   6 |   const a \u003d useMemo(() \u003d\u003e {\n-\u003e  7 |     return x?.y.z?.a;\n-     |            ^^^^^^^^^ Missing dependency `x?.y.z?.a`\n-   8 |     // error: too precise\n-   9 |   }, [x?.y.z?.a.b]);\n-  10 |   const b \u003d useMemo(() \u003d\u003e {\n-\n-Error: Found missing memoization dependencies\n-\n-Missing dependencies can cause a value not to update when those inputs change, resulting in stale UI.\n-\n-error.invalid-exhaustive-deps.ts:15:11\n-  13 |   }, [x.y.z.a]);\n-  14 |   const c \u003d useMemo(() \u003d\u003e {\n-\u003e 15 |     return x?.y.z.a?.b;\n-     |            ^^^^^^^^^^^ Missing dependency `x?.y.z.a?.b`\n-  16 |     // error: too precise\n-  17 |   }, [x?.y.z.a?.b.z]);\n-  18 |   const d \u003d useMemo(() \u003d\u003e {\n-\n-Error: Found unnecessary memoization dependencies\n-\n-Unnecessary dependencies can cause a value to update more often than necessary, causing performance regressions and effects to fire more often than expected.\n-\n-error.invalid-exhaustive-deps.ts:31:5\n-  29 |     return [];\n-  30 |     // error: unnecessary\n-\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n-     |      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Unnecessary dependencies `x`, `y.z`, `z?.y?.a`, `UNUSED_GLOBAL`\n-  32 |   const ref1 \u003d useRef(null);\n-  33 |   const ref2 \u003d useRef(null);\n-  34 |   const ref \u003d z ? ref1 : ref2;\n-\n-Error: Found missing memoization dependencies\n-\n-Missing dependencies can cause a value not to update when those inputs change, resulting in stale UI.\n-\n-error.invalid-exhaustive-deps.ts:37:13\n-  35 |   const cb \u003d useMemo(() \u003d\u003e {\n-  36 |     return () \u003d\u003e {\n-\u003e 37 |       return ref.current;\n-     |              ^^^ Missing dependency `ref`. Refs, setState functions, and other \"stable\" values generally do not need to be added as dependencies, but this variable may change over time to point to different values\n-  38 |     };\n-  39 |     // error: ref is a stable type but reactive\n-  40 |   }, []);\n-```\n-          \n-      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/compile-files-with-exhaustive-deps-violation-in-effects.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/compile-files-with-exhaustive-deps-violation-in-effects.expect.md\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/compile-files-with-exhaustive-deps-violation-in-effects.expect.md\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/compile-files-with-exhaustive-deps-violation-in-effects.expect.md\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/compile-files-with-exhaustive-deps-violation-in-effects.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/compile-files-with-exhaustive-deps-violation-in-effects.js\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/compile-files-with-exhaustive-deps-violation-in-effects.js\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/compile-files-with-exhaustive-deps-violation-in-effects.js\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-dep-on-ref-current-value.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-dep-on-ref-current-value.expect.md\nnew file mode 100644\nindex 0000000..ab9b408\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-dep-on-ref-current-value.expect.md\n@@ -0,0 +1,40 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveMemoizationDependencies\n+\n+function Component() {\n+  const ref \u003d useRef(null);\n+  const onChange \u003d useCallback(() \u003d\u003e {\n+    return ref.current.value;\n+  }, [ref.current.value]);\n+\n+  return \u003cinput ref\u003d{ref} onChange\u003d{onChange} /\u003e;\n+}\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 1 error:\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Extra dependencies can cause a value to update more often than it should, resulting in performance problems such as excessive renders or effects firing too often.\n+\n+error.invalid-dep-on-ref-current-value.ts:7:6\n+   5 |   const onChange \u003d useCallback(() \u003d\u003e {\n+   6 |     return ref.current.value;\n+\u003e  7 |   }, [ref.current.value]);\n+     |       ^^^^^^^^^^^^^^^^^ Unnecessary dependency `ref.current.value`\n+   8 |\n+   9 |   return \u003cinput ref\u003d{ref} onChange\u003d{onChange} /\u003e;\n+  10 | }\n+\n+Inferred dependencies: `[]`\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-dep-on-ref-current-value.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-dep-on-ref-current-value.js\nnew file mode 100644\nindex 0000000..f7a3ee4\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-dep-on-ref-current-value.js\n@@ -0,0 +1,10 @@\n+// @validateExhaustiveMemoizationDependencies\n+\n+function Component() {\n+  const ref \u003d useRef(null);\n+  const onChange \u003d useCallback(() \u003d\u003e {\n+    return ref.current.value;\n+  }, [ref.current.value]);\n+\n+  return \u003cinput ref\u003d{ref} onChange\u003d{onChange} /\u003e;\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md\nsimilarity index 67%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md\nindex b6d8a46..30ab558 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md\n@@ -25,18 +25,20 @@ function Component() {\n ```\n Found 1 error:\n \n-Error: Found unnecessary memoization dependencies\n+Error: Found missing/extra memoization dependencies\n \n-Unnecessary dependencies can cause a value to update more often than necessary, causing performance regressions and effects to fire more often than expected.\n+Extra dependencies can cause a value to update more often than it should, resulting in performance problems such as excessive renders or effects firing too often.\n \n-error.invalid-exhaustive-deps-disallow-unused-stable-types.ts:11:5\n+error.invalid-exhaustive-deps-disallow-unused-stable-types.ts:11:13\n    9 |     return [state];\n   10 |     // error: `setState` is a stable type, but not actually referenced\n \u003e 11 |   }, [state, setState]);\n-     |      ^^^^^^^^^^^^^^^^^ Unnecessary dependencies `setState`\n+     |              ^^^^^^^^ Unnecessary dependency `setState`\n   12 |\n   13 |   return \u0027oops\u0027;\n   14 | }\n+\n+Inferred dependencies: `[state]`\n ```\n           \n       \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps-disallow-unused-stable-types.js\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.js\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps-disallow-unused-stable-types.js\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps.expect.md\nnew file mode 100644\nindex 0000000..7f94c03\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps.expect.md\n@@ -0,0 +1,204 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveMemoizationDependencies\n+import {useMemo} from \u0027react\u0027;\n+import {Stringify} from \u0027shared-runtime\u0027;\n+\n+function Component({x, y, z}) {\n+  const a \u003d useMemo(() \u003d\u003e {\n+    return x?.y.z?.a;\n+    // error: too precise\n+  }, [x?.y.z?.a.b]);\n+  const b \u003d useMemo(() \u003d\u003e {\n+    return x.y.z?.a;\n+    // ok, not our job to type check nullability\n+  }, [x.y.z.a]);\n+  const c \u003d useMemo(() \u003d\u003e {\n+    return x?.y.z.a?.b;\n+    // error: too precise\n+  }, [x?.y.z.a?.b.z]);\n+  const d \u003d useMemo(() \u003d\u003e {\n+    return x?.y?.[(console.log(y), z?.b)];\n+    // ok\n+  }, [x?.y, y, z?.b]);\n+  const e \u003d useMemo(() \u003d\u003e {\n+    const e \u003d [];\n+    e.push(x);\n+    return e;\n+    // ok\n+  }, [x]);\n+  const f \u003d useMemo(() \u003d\u003e {\n+    return [];\n+    // error: unnecessary\n+  }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+  const ref1 \u003d useRef(null);\n+  const ref2 \u003d useRef(null);\n+  const ref \u003d z ? ref1 : ref2;\n+  const cb \u003d useMemo(() \u003d\u003e {\n+    return () \u003d\u003e {\n+      return ref.current;\n+    };\n+    // error: ref is a stable type but reactive\n+  }, []);\n+  return \u003cStringify results\u003d{[a, b, c, d, e, f, cb]} /\u003e;\n+}\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 5 errors:\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Missing dependencies can cause a value to update less often than it should, resulting in stale UI. Extra dependencies can cause a value to update more often than it should, resulting in performance problems such as excessive renders or effects firing too often.\n+\n+error.invalid-exhaustive-deps.ts:7:11\n+   5 | function Component({x, y, z}) {\n+   6 |   const a \u003d useMemo(() \u003d\u003e {\n+\u003e  7 |     return x?.y.z?.a;\n+     |            ^^^^^^^^^ Missing dependency `x?.y.z?.a`\n+   8 |     // error: too precise\n+   9 |   }, [x?.y.z?.a.b]);\n+  10 |   const b \u003d useMemo(() \u003d\u003e {\n+\n+error.invalid-exhaustive-deps.ts:9:6\n+   7 |     return x?.y.z?.a;\n+   8 |     // error: too precise\n+\u003e  9 |   }, [x?.y.z?.a.b]);\n+     |       ^^^^^^^^^^^ Overly precise dependency `x?.y.z?.a.b`, use `x?.y.z?.a` instead\n+  10 |   const b \u003d useMemo(() \u003d\u003e {\n+  11 |     return x.y.z?.a;\n+  12 |     // ok, not our job to type check nullability\n+\n+Inferred dependencies: `[x?.y.z?.a]`\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Missing dependencies can cause a value to update less often than it should, resulting in stale UI. Extra dependencies can cause a value to update more often than it should, resulting in performance problems such as excessive renders or effects firing too often.\n+\n+error.invalid-exhaustive-deps.ts:15:11\n+  13 |   }, [x.y.z.a]);\n+  14 |   const c \u003d useMemo(() \u003d\u003e {\n+\u003e 15 |     return x?.y.z.a?.b;\n+     |            ^^^^^^^^^^^ Missing dependency `x?.y.z.a?.b`\n+  16 |     // error: too precise\n+  17 |   }, [x?.y.z.a?.b.z]);\n+  18 |   const d \u003d useMemo(() \u003d\u003e {\n+\n+error.invalid-exhaustive-deps.ts:17:6\n+  15 |     return x?.y.z.a?.b;\n+  16 |     // error: too precise\n+\u003e 17 |   }, [x?.y.z.a?.b.z]);\n+     |       ^^^^^^^^^^^^^ Overly precise dependency `x?.y.z.a?.b.z`, use `x?.y.z.a?.b` instead\n+  18 |   const d \u003d useMemo(() \u003d\u003e {\n+  19 |     return x?.y?.[(console.log(y), z?.b)];\n+  20 |     // ok\n+\n+Inferred dependencies: `[x?.y.z.a?.b]`\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Extra dependencies can cause a value to update more often than it should, resulting in performance problems such as excessive renders or effects firing too often.\n+\n+error.invalid-exhaustive-deps.ts:31:6\n+  29 |     return [];\n+  30 |     // error: unnecessary\n+\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+     |       ^ Unnecessary dependency `x`\n+  32 |   const ref1 \u003d useRef(null);\n+  33 |   const ref2 \u003d useRef(null);\n+  34 |   const ref \u003d z ? ref1 : ref2;\n+\n+error.invalid-exhaustive-deps.ts:31:9\n+  29 |     return [];\n+  30 |     // error: unnecessary\n+\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+     |          ^^^ Unnecessary dependency `y.z`\n+  32 |   const ref1 \u003d useRef(null);\n+  33 |   const ref2 \u003d useRef(null);\n+  34 |   const ref \u003d z ? ref1 : ref2;\n+\n+error.invalid-exhaustive-deps.ts:31:14\n+  29 |     return [];\n+  30 |     // error: unnecessary\n+\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+     |               ^^^^^^^ Unnecessary dependency `z?.y?.a`\n+  32 |   const ref1 \u003d useRef(null);\n+  33 |   const ref2 \u003d useRef(null);\n+  34 |   const ref \u003d z ? ref1 : ref2;\n+\n+error.invalid-exhaustive-deps.ts:31:23\n+  29 |     return [];\n+  30 |     // error: unnecessary\n+\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+     |                        ^^^^^^^^^^^^^ Unnecessary dependency `UNUSED_GLOBAL`. Values declared outside of a component/hook should not be listed as dependencies as the component will not re-render if they change\n+  32 |   const ref1 \u003d useRef(null);\n+  33 |   const ref2 \u003d useRef(null);\n+  34 |   const ref \u003d z ? ref1 : ref2;\n+\n+Inferred dependencies: `[]`\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Extra dependencies can cause a value to update more often than it should, resulting in performance problems such as excessive renders or effects firing too often.\n+\n+error.invalid-exhaustive-deps.ts:31:6\n+  29 |     return [];\n+  30 |     // error: unnecessary\n+\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+     |       ^ Unnecessary dependency `x`\n+  32 |   const ref1 \u003d useRef(null);\n+  33 |   const ref2 \u003d useRef(null);\n+  34 |   const ref \u003d z ? ref1 : ref2;\n+\n+error.invalid-exhaustive-deps.ts:31:9\n+  29 |     return [];\n+  30 |     // error: unnecessary\n+\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+     |          ^^^ Unnecessary dependency `y.z`\n+  32 |   const ref1 \u003d useRef(null);\n+  33 |   const ref2 \u003d useRef(null);\n+  34 |   const ref \u003d z ? ref1 : ref2;\n+\n+error.invalid-exhaustive-deps.ts:31:14\n+  29 |     return [];\n+  30 |     // error: unnecessary\n+\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+     |               ^^^^^^^ Unnecessary dependency `z?.y?.a`\n+  32 |   const ref1 \u003d useRef(null);\n+  33 |   const ref2 \u003d useRef(null);\n+  34 |   const ref \u003d z ? ref1 : ref2;\n+\n+error.invalid-exhaustive-deps.ts:31:23\n+  29 |     return [];\n+  30 |     // error: unnecessary\n+\u003e 31 |   }, [x, y.z, z?.y?.a, UNUSED_GLOBAL]);\n+     |                        ^^^^^^^^^^^^^ Unnecessary dependency `UNUSED_GLOBAL`. Values declared outside of a component/hook should not be listed as dependencies as the component will not re-render if they change\n+  32 |   const ref1 \u003d useRef(null);\n+  33 |   const ref2 \u003d useRef(null);\n+  34 |   const ref \u003d z ? ref1 : ref2;\n+\n+Inferred dependencies: `[]`\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Missing dependencies can cause a value to update less often than it should, resulting in stale UI.\n+\n+error.invalid-exhaustive-deps.ts:37:13\n+  35 |   const cb \u003d useMemo(() \u003d\u003e {\n+  36 |     return () \u003d\u003e {\n+\u003e 37 |       return ref.current;\n+     |              ^^^ Missing dependency `ref`. Refs, setState functions, and other \"stable\" values generally do not need to be added as dependencies, but this variable may change over time to point to different values\n+  38 |     };\n+  39 |     // error: ref is a stable type but reactive\n+  40 |   }, []);\n+\n+Inferred dependencies: `[ref]`\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps.js\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.js\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-exhaustive-deps.js\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-inner-function.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-inner-function.expect.md\nnew file mode 100644\nindex 0000000..6d03fb4\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-inner-function.expect.md\n@@ -0,0 +1,43 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveMemoizationDependencies\n+\n+import {useMemo} from \u0027react\u0027;\n+import {makeObject_Primitives} from \u0027shared-runtime\u0027;\n+\n+function useHook() {\n+  const object \u003d makeObject_Primitives();\n+  const fn \u003d useCallback(() \u003d\u003e {\n+    const g \u003d () \u003d\u003e {\n+      return [object];\n+    };\n+    return g;\n+  });\n+  return fn;\n+}\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 1 error:\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Missing dependencies can cause a value to update less often than it should, resulting in stale UI.\n+\n+error.invalid-missing-nonreactive-dep-inner-function.ts:10:14\n+   8 |   const fn \u003d useCallback(() \u003d\u003e {\n+   9 |     const g \u003d () \u003d\u003e {\n+\u003e 10 |       return [object];\n+     |               ^^^^^^ Missing dependency `object`\n+  11 |     };\n+  12 |     return g;\n+  13 |   });\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-inner-function.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-inner-function.js\nnew file mode 100644\nindex 0000000..02ba7b8\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-inner-function.js\n@@ -0,0 +1,15 @@\n+// @validateExhaustiveMemoizationDependencies\n+\n+import {useMemo} from \u0027react\u0027;\n+import {makeObject_Primitives} from \u0027shared-runtime\u0027;\n+\n+function useHook() {\n+  const object \u003d makeObject_Primitives();\n+  const fn \u003d useCallback(() \u003d\u003e {\n+    const g \u003d () \u003d\u003e {\n+      return [object];\n+    };\n+    return g;\n+  });\n+  return fn;\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-unmemoized.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-unmemoized.expect.md\nnew file mode 100644\nindex 0000000..a6868ef\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-unmemoized.expect.md\n@@ -0,0 +1,43 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveMemoizationDependencies\n+\n+import {useMemo} from \u0027react\u0027;\n+import {makeObject_Primitives, useIdentity} from \u0027shared-runtime\u0027;\n+\n+function useHook() {\n+  // object is non-reactive but not memoized bc the mutation surrounds a hook\n+  const object \u003d makeObject_Primitives();\n+  useIdentity();\n+  object.x \u003d 0;\n+  const array \u003d useMemo(() \u003d\u003e [object], []);\n+  return array;\n+}\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 1 error:\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Missing dependencies can cause a value to update less often than it should, resulting in stale UI.\n+\n+error.invalid-missing-nonreactive-dep-unmemoized.ts:11:31\n+   9 |   useIdentity();\n+  10 |   object.x \u003d 0;\n+\u003e 11 |   const array \u003d useMemo(() \u003d\u003e [object], []);\n+     |                                ^^^^^^ Missing dependency `object`\n+  12 |   return array;\n+  13 | }\n+  14 |\n+\n+Inferred dependencies: `[object]`\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-unmemoized.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-unmemoized.js\nnew file mode 100644\nindex 0000000..c790ce1\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep-unmemoized.js\n@@ -0,0 +1,13 @@\n+// @validateExhaustiveMemoizationDependencies\n+\n+import {useMemo} from \u0027react\u0027;\n+import {makeObject_Primitives, useIdentity} from \u0027shared-runtime\u0027;\n+\n+function useHook() {\n+  // object is non-reactive but not memoized bc the mutation surrounds a hook\n+  const object \u003d makeObject_Primitives();\n+  useIdentity();\n+  object.x \u003d 0;\n+  const array \u003d useMemo(() \u003d\u003e [object], []);\n+  return array;\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep.expect.md\nnew file mode 100644\nindex 0000000..f342349\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep.expect.md\n@@ -0,0 +1,40 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveMemoizationDependencies\n+\n+import {useMemo} from \u0027react\u0027;\n+import {makeObject_Primitives} from \u0027shared-runtime\u0027;\n+\n+function useHook() {\n+  const object \u003d makeObject_Primitives();\n+  const array \u003d useMemo(() \u003d\u003e [object], []);\n+  return array;\n+}\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 1 error:\n+\n+Error: Found missing/extra memoization dependencies\n+\n+Missing dependencies can cause a value to update less often than it should, resulting in stale UI.\n+\n+error.invalid-missing-nonreactive-dep.ts:8:31\n+   6 | function useHook() {\n+   7 |   const object \u003d makeObject_Primitives();\n+\u003e  8 |   const array \u003d useMemo(() \u003d\u003e [object], []);\n+     |                                ^^^^^^ Missing dependency `object`\n+   9 |   return array;\n+  10 | }\n+  11 |\n+\n+Inferred dependencies: `[object]`\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep.js\nnew file mode 100644\nindex 0000000..bfc81d9\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.invalid-missing-nonreactive-dep.js\n@@ -0,0 +1,10 @@\n+// @validateExhaustiveMemoizationDependencies\n+\n+import {useMemo} from \u0027react\u0027;\n+import {makeObject_Primitives} from \u0027shared-runtime\u0027;\n+\n+function useHook() {\n+  const object \u003d makeObject_Primitives();\n+  const array \u003d useMemo(() \u003d\u003e [object], []);\n+  return array;\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.sketchy-code-exhaustive-deps.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.sketchy-code-exhaustive-deps.expect.md\nsimilarity index 77%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.sketchy-code-exhaustive-deps.expect.md\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.sketchy-code-exhaustive-deps.expect.md\nindex 332fee9..0422a07 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.sketchy-code-exhaustive-deps.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.sketchy-code-exhaustive-deps.expect.md\n@@ -25,9 +25,9 @@ function Component() {\n ```\n Found 1 error:\n \n-Error: Found missing memoization dependencies\n+Error: Found missing/extra memoization dependencies\n \n-Missing dependencies can cause a value not to update when those inputs change, resulting in stale UI.\n+Missing dependencies can cause a value to update less often than it should, resulting in stale UI.\n \n error.sketchy-code-exhaustive-deps.ts:8:16\n    6 |   const foo \u003d useCallback(\n@@ -37,6 +37,8 @@ error.sketchy-code-exhaustive-deps.ts:8:16\n    9 |     }, // eslint-disable-next-line react-hooks/exhaustive-deps\n   10 |     []\n   11 |   );\n+\n+Inferred dependencies: `[item]`\n ```\n           \n       \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.sketchy-code-exhaustive-deps.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.sketchy-code-exhaustive-deps.js\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.sketchy-code-exhaustive-deps.js\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/error.sketchy-code-exhaustive-deps.js\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-constant-folded-values.expect.md\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.expect.md\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-constant-folded-values.expect.md\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-constant-folded-values.js\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.js\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-constant-folded-values.js\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.expect.md\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.expect.md\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.expect.md\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.js\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.js\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps-allow-nonreactive-stable-types-as-extra-deps.js\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps.expect.md\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps.expect.md\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps.expect.md\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps.js\nsimilarity index 100%\nrename from compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps.js\nrename to compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps/exhaustive-deps.js\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/error.useMemo-unrelated-mutation-in-depslist.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/error.useMemo-unrelated-mutation-in-depslist.expect.md\nindex 7d21252..7831aea 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/error.useMemo-unrelated-mutation-in-depslist.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/error.useMemo-unrelated-mutation-in-depslist.expect.md\n@@ -32,9 +32,9 @@ function useFoo(input1) {\n ```\n Found 1 error:\n \n-Error: Found missing memoization dependencies\n+Error: Found missing/extra memoization dependencies\n \n-Missing dependencies can cause a value not to update when those inputs change, resulting in stale UI.\n+Missing dependencies can cause a value to update less often than it should, resulting in stale UI.\n \n error.useMemo-unrelated-mutation-in-depslist.ts:18:14\n   16 |   const memoized \u003d useMemo(() \u003d\u003e {\n@@ -44,6 +44,8 @@ error.useMemo-unrelated-mutation-in-depslist.ts:18:14\n   19 |\n   20 |   return [x, memoized];\n   21 | }\n+\n+Inferred dependencies: `[x, y]`\n ```\n           \n       \n\\ No newline at end of file","expectedMessage":"[compiler] Exhaustive deps: extra tests, improve diagnostic (#35213)","repository":"react","commitHash":"fb18ad3fd372623190a8f74387b79e28151cefc4","metadata":{"author":"Joseph Savona \u003c6425824+josephsavona@users.noreply.github.com\u003e"}}
{"id":"react-d39a1d6b","diff":" .../babel-plugin-react-compiler/src/HIR/HIR.ts     |  1 +\n .../src/Inference/DropManualMemoization.ts         |  1 +\n .../src/Optimization/ConstantPropagation.ts        | 13 +++++\n .../Validation/ValidateExhaustiveDependencies.ts   | 66 ++++++++++++----------\n .../ValidatePreservedManualMemoization.ts          |  3 +\n .../context-variable-as-jsx-element-tag.expect.md  |  3 +-\n .../context-variable-as-jsx-element-tag.js         |  2 +-\n ...ive-deps-disallow-unused-stable-types.expect.md | 42 ++++++++++++++\n ...exhaustive-deps-disallow-unused-stable-types.js | 14 +++++\n ...ive-deps-allow-constant-folded-values.expect.md | 41 ++++++++++++++\n ...exhaustive-deps-allow-constant-folded-values.js | 11 ++++\n ...nsure-constant-prop-decls-get-removed.expect.md |  4 +-\n .../todo-ensure-constant-prop-decls-get-removed.ts |  2 +-\n ...riable-preserve-memoization-guarantee.expect.md |  2 +-\n ...free-variable-preserve-memoization-guarantee.js |  2 +-\n 15 files changed, 169 insertions(+), 38 deletions(-)\n\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts b/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\nindex 55bcd0b..9fb360c 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/HIR/HIR.ts\n@@ -803,6 +803,7 @@ export type ManualMemoDependency \u003d {\n     | {\n         kind: \u0027NamedLocal\u0027;\n         value: Place;\n+        constant: boolean;\n       }\n     | {kind: \u0027Global\u0027; identifierName: string};\n   path: DependencyPath;\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Inference/DropManualMemoization.ts b/compiler/packages/babel-plugin-react-compiler/src/Inference/DropManualMemoization.ts\nindex bcfc534..0138e52 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Inference/DropManualMemoization.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Inference/DropManualMemoization.ts\n@@ -92,6 +92,7 @@ export function collectMaybeMemoDependencies(\n           root: {\n             kind: \u0027NamedLocal\u0027,\n             value: {...value.place},\n+            constant: false,\n           },\n           path: [],\n         };\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Optimization/ConstantPropagation.ts b/compiler/packages/babel-plugin-react-compiler/src/Optimization/ConstantPropagation.ts\nindex ca2f6e0..7330b63 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Optimization/ConstantPropagation.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Optimization/ConstantPropagation.ts\n@@ -609,6 +609,19 @@ function evaluateInstruction(\n       constantPropagationImpl(value.loweredFunc.func, constants);\n       return null;\n     }\n+    case \u0027StartMemoize\u0027: {\n+      if (value.deps !\u003d null) {\n+        for (const dep of value.deps) {\n+          if (dep.root.kind \u003d\u003d\u003d \u0027NamedLocal\u0027) {\n+            const placeValue \u003d read(constants, dep.root.value);\n+            if (placeValue !\u003d null \u0026\u0026 placeValue.kind \u003d\u003d\u003d \u0027Primitive\u0027) {\n+              dep.root.constant \u003d true;\n+            }\n+          }\n+        }\n+      }\n+      return null;\n+    }\n     default: {\n       // TODO: handle more cases\n       return null;\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\nindex b3a68fc..5035fa9 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\n@@ -22,6 +22,7 @@ import {\n   Identifier,\n   IdentifierId,\n   InstructionKind,\n+  isPrimitiveType,\n   isStableType,\n   isSubPath,\n   isSubPathIgnoringOptionals,\n@@ -53,20 +54,18 @@ const DEBUG \u003d false;\n  * - If the manual dependencies had extraneous deps, then auto memoization\n  *   will remove them and cause the value to update *less* frequently.\n  *\n- * We consider a value V as missing if ALL of the following conditions are met:\n- * - V is reactive\n- * - There is no manual dependency path P such that whenever V would change,\n- *   P would also change. If V is `x.y.z`, this means there must be some\n- *   path P that is either `x.y.z`, `x.y`, or `x`. Note that we assume no\n- *   interior mutability, such that a shorter path \"covers\" changes to longer\n- *   more precise paths.\n- *\n- * We consider a value V extraneous if either of the folowing are true:\n- * - V is a reactive local that is unreferenced\n- * - V is a global that is unreferenced\n- *\n- * In other words, we allow extraneous non-reactive values since we know they cannot\n- * impact how often the memoization would run.\n+ * The implementation compares the manual dependencies against the values\n+ * actually used within the memoization function\n+ * - For each value V referenced in the memo function, either:\n+ *   - If the value is non-reactive *and* a known stable type, then the\n+ *     value may optionally be specified as an exact dependency.\n+ *   - Otherwise, report an error unless there is a manual dependency that will\n+ *     invalidate whenever V invalidates. If `x.y.z` is referenced, there must\n+ *     be a manual dependency for `x.y.z`, `x.y`, or `x`. Note that we assume\n+ *     no interior mutability, ie we assume that any changes to inner paths must\n+ *     always cause the other path to change as well.\n+ * - Any dependencies that do not correspond to a value referenced in the memo\n+ *   function are considered extraneous and throw an error\n  *\n  * ## TODO: Invalid, Complex Deps\n  *\n@@ -226,9 +225,6 @@ export function validateExhaustiveDependencies(\n         reason: \u0027Unexpected function dependency\u0027,\n         loc: value.loc,\n       });\n-      const isRequiredDependency \u003d reactive.has(\n-        inferredDependency.identifier.id,\n-      );\n       let hasMatchingManualDependency \u003d false;\n       for (const manualDependency of manualDependencies) {\n         if (\n@@ -243,32 +239,40 @@ export function validateExhaustiveDependencies(\n         ) {\n           hasMatchingManualDependency \u003d true;\n           matched.add(manualDependency);\n-          if (!isRequiredDependency) {\n-            extra.push(manualDependency);\n-          }\n         }\n       }\n-      if (isRequiredDependency \u0026\u0026 !hasMatchingManualDependency) {\n-        missing.push(inferredDependency);\n+      const isOptionalDependency \u003d\n+        !reactive.has(inferredDependency.identifier.id) \u0026\u0026\n+        (isStableType(inferredDependency.identifier) ||\n+          isPrimitiveType(inferredDependency.identifier));\n+      if (hasMatchingManualDependency || isOptionalDependency) {\n+        continue;\n       }\n+      missing.push(inferredDependency);\n     }\n \n     for (const dep of startMemo.deps ?? []) {\n       if (matched.has(dep)) {\n         continue;\n       }\n+      if (dep.root.kind \u003d\u003d\u003d \u0027NamedLocal\u0027 \u0026\u0026 dep.root.constant) {\n+        CompilerError.simpleInvariant(\n+          !dep.root.value.reactive \u0026\u0026\n+            isPrimitiveType(dep.root.value.identifier),\n+          {\n+            reason: \u0027Expected constant-folded dependency to be non-reactive\u0027,\n+            loc: dep.root.value.loc,\n+          },\n+        );\n+        /*\n+         * Constant primitives can get constant-folded, which means we won\u0027t\n+         * see a LoadLocal for the value within the memo function.\n+         */\n+        continue;\n+      }\n       extra.push(dep);\n     }\n \n-    /**\n-     * Per docblock, we only consider dependencies as extraneous if\n-     * they are unused globals or reactive locals. Notably, this allows\n-     * non-reactive locals.\n-     */\n-    retainWhere(extra, dep \u003d\u003e {\n-      return dep.root.kind \u003d\u003d\u003d \u0027Global\u0027 || dep.root.value.reactive;\n-    });\n-\n     if (missing.length !\u003d\u003d 0 || extra.length !\u003d\u003d 0) {\n       let suggestions: Array\u003cCompilerSuggestion\u003e | null \u003d null;\n       if (startMemo.depsLoc !\u003d null \u0026\u0026 typeof startMemo.depsLoc !\u003d\u003d \u0027symbol\u0027) {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidatePreservedManualMemoization.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidatePreservedManualMemoization.ts\nindex 19af0ed..48cec3c 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidatePreservedManualMemoization.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidatePreservedManualMemoization.ts\n@@ -267,6 +267,7 @@ function validateInferredDep(\n           effect: Effect.Read,\n           reactive: false,\n         },\n+        constant: false,\n       },\n       path: [...dep.path],\n     };\n@@ -379,6 +380,7 @@ class Visitor extends ReactiveFunctionVisitor\u003cVisitorState\u003e {\n                 root: {\n                   kind: \u0027NamedLocal\u0027,\n                   value: storeTarget,\n+                  constant: false,\n                 },\n                 path: [],\n               });\n@@ -408,6 +410,7 @@ class Visitor extends ReactiveFunctionVisitor\u003cVisitorState\u003e {\n         root: {\n           kind: \u0027NamedLocal\u0027,\n           value: {...lvalue},\n+          constant: false,\n         },\n         path: [],\n       });\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/context-variable-as-jsx-element-tag.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/context-variable-as-jsx-element-tag.expect.md\nindex 407fdcb..636bc53 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/context-variable-as-jsx-element-tag.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/context-variable-as-jsx-element-tag.expect.md\n@@ -11,7 +11,7 @@ function Component(props) {\n \n   Component \u003d useMemo(() \u003d\u003e {\n     return Component;\n-  });\n+  }, [Component]);\n \n   return \u003cComponent {...props} /\u003e;\n }\n@@ -36,6 +36,7 @@ function Component(props) {\n   if ($[0] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n     Component \u003d Stringify;\n \n+    Component;\n     Component \u003d Component;\n     $[0] \u003d Component;\n   } else {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/context-variable-as-jsx-element-tag.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/context-variable-as-jsx-element-tag.js\nindex 5ed1a91..49cf336 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/context-variable-as-jsx-element-tag.js\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/context-variable-as-jsx-element-tag.js\n@@ -7,7 +7,7 @@ function Component(props) {\n \n   Component \u003d useMemo(() \u003d\u003e {\n     return Component;\n-  });\n+  }, [Component]);\n \n   return \u003cComponent {...props} /\u003e;\n }\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md\nnew file mode 100644\nindex 0000000..b6d8a46\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.expect.md\n@@ -0,0 +1,42 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveMemoizationDependencies\n+\n+import {useState} from \u0027react\u0027;\n+import {Stringify} from \u0027shared-runtime\u0027;\n+\n+function Component() {\n+  const [state, setState] \u003d useState(0);\n+  const x \u003d useMemo(() \u003d\u003e {\n+    return [state];\n+    // error: `setState` is a stable type, but not actually referenced\n+  }, [state, setState]);\n+\n+  return \u0027oops\u0027;\n+}\n+\n+```\n+\n+\n+## Error\n+\n+```\n+Found 1 error:\n+\n+Error: Found unnecessary memoization dependencies\n+\n+Unnecessary dependencies can cause a value to update more often than necessary, causing performance regressions and effects to fire more often than expected.\n+\n+error.invalid-exhaustive-deps-disallow-unused-stable-types.ts:11:5\n+   9 |     return [state];\n+  10 |     // error: `setState` is a stable type, but not actually referenced\n+\u003e 11 |   }, [state, setState]);\n+     |      ^^^^^^^^^^^^^^^^^ Unnecessary dependencies `setState`\n+  12 |\n+  13 |   return \u0027oops\u0027;\n+  14 | }\n+```\n+          \n+      \n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.js\nnew file mode 100644\nindex 0000000..2bb03c3\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps-disallow-unused-stable-types.js\n@@ -0,0 +1,14 @@\n+// @validateExhaustiveMemoizationDependencies\n+\n+import {useState} from \u0027react\u0027;\n+import {Stringify} from \u0027shared-runtime\u0027;\n+\n+function Component() {\n+  const [state, setState] \u003d useState(0);\n+  const x \u003d useMemo(() \u003d\u003e {\n+    return [state];\n+    // error: `setState` is a stable type, but not actually referenced\n+  }, [state, setState]);\n+\n+  return \u0027oops\u0027;\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.expect.md\nnew file mode 100644\nindex 0000000..bda2b03\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.expect.md\n@@ -0,0 +1,41 @@\n+\n+## Input\n+\n+```javascript\n+// @validateExhaustiveMemoizationDependencies\n+\n+function Component() {\n+  const x \u003d 0;\n+  const y \u003d useMemo(() \u003d\u003e {\n+    return [x];\n+    // x gets constant-folded but shouldn\u0027t count as extraneous,\n+    // it was referenced in the memo block\n+  }, [x]);\n+  return y;\n+}\n+\n+```\n+\n+## Code\n+\n+```javascript\n+import { c as _c } from \"react/compiler-runtime\"; // @validateExhaustiveMemoizationDependencies\n+\n+function Component() {\n+  const $ \u003d _c(1);\n+  const x \u003d 0;\n+  let t0;\n+  if ($[0] \u003d\u003d\u003d Symbol.for(\"react.memo_cache_sentinel\")) {\n+    t0 \u003d [0];\n+    $[0] \u003d t0;\n+  } else {\n+    t0 \u003d $[0];\n+  }\n+  const y \u003d t0;\n+  return y;\n+}\n+\n+```\n+      \n+### Eval output\n+(kind: exception) Fixture not implemented\n\\ No newline at end of file\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.js\nnew file mode 100644\nindex 0000000..6ee141c\n--- /dev/null\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/exhaustive-deps-allow-constant-folded-values.js\n@@ -0,0 +1,11 @@\n+// @validateExhaustiveMemoizationDependencies\n+\n+function Component() {\n+  const x \u003d 0;\n+  const y \u003d useMemo(() \u003d\u003e {\n+    return [x];\n+    // x gets constant-folded but shouldn\u0027t count as extraneous,\n+    // it was referenced in the memo block\n+  }, [x]);\n+  return y;\n+}\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/todo-ensure-constant-prop-decls-get-removed.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/todo-ensure-constant-prop-decls-get-removed.expect.md\nindex cf36d6e..f23cf84 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/todo-ensure-constant-prop-decls-get-removed.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/todo-ensure-constant-prop-decls-get-removed.expect.md\n@@ -2,7 +2,7 @@\n ## Input\n \n ```javascript\n-// @validatePreserveExistingMemoizationGuarantees\n+// @validatePreserveExistingMemoizationGuarantees @validateExhaustiveMemoizationDependencies:false\n \n import {useMemo} from \u0027react\u0027;\n \n@@ -27,7 +27,7 @@ export const FIXTURE_ENTRYPOINT \u003d {\n ## Code\n \n ```javascript\n-import { c as _c } from \"react/compiler-runtime\"; // @validatePreserveExistingMemoizationGuarantees\n+import { c as _c } from \"react/compiler-runtime\"; // @validatePreserveExistingMemoizationGuarantees @validateExhaustiveMemoizationDependencies:false\n \n import { useMemo } from \"react\";\n \ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/todo-ensure-constant-prop-decls-get-removed.ts b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/todo-ensure-constant-prop-decls-get-removed.ts\nindex b0c0139..bfbc0ab 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/todo-ensure-constant-prop-decls-get-removed.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/preserve-memo-validation/todo-ensure-constant-prop-decls-get-removed.ts\n@@ -1,4 +1,4 @@\n-// @validatePreserveExistingMemoizationGuarantees\n+// @validatePreserveExistingMemoizationGuarantees @validateExhaustiveMemoizationDependencies:false\n \n import {useMemo} from \u0027react\u0027;\n \ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/useCallback-maybe-modify-free-variable-preserve-memoization-guarantee.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/useCallback-maybe-modify-free-variable-preserve-memoization-guarantee.expect.md\nindex 43b3b59..16169a7 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/useCallback-maybe-modify-free-variable-preserve-memoization-guarantee.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/useCallback-maybe-modify-free-variable-preserve-memoization-guarantee.expect.md\n@@ -15,7 +15,7 @@ function Component(props) {\n     const x \u003d makeObject_Primitives();\n     x.value \u003d props.value;\n     mutate(x, free, part);\n-  }, [props.value]);\n+  }, [props.value, free, part]);\n   mutate(free, part);\n   return callback;\n }\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/useCallback-maybe-modify-free-variable-preserve-memoization-guarantee.js b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/useCallback-maybe-modify-free-variable-preserve-memoization-guarantee.js\nindex 662162e..e9d1152 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/useCallback-maybe-modify-free-variable-preserve-memoization-guarantee.js\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/useCallback-maybe-modify-free-variable-preserve-memoization-guarantee.js\n@@ -11,7 +11,7 @@ function Component(props) {\n     const x \u003d makeObject_Primitives();\n     x.value \u003d props.value;\n     mutate(x, free, part);\n-  }, [props.value]);\n+  }, [props.value, free, part]);\n   mutate(free, part);\n   return callback;\n }","expectedMessage":"[compiler] Distingush optional/extraneous deps (#35204)","repository":"react","commitHash":"d39a1d6b638de6b990ea783544df775b8be59f1a","metadata":{"author":"Joseph Savona \u003c6425824+josephsavona@users.noreply.github.com\u003e"}}
{"id":"react-16e16ec6","diff":" compiler/.claude/settings.local.json    |   9 +\n compiler/scripts/enable-feature-flag.js | 347 ++++++++++++++++++++++++++++++++\n 2 files changed, 356 insertions(+)\n\ndiff --git a/compiler/.claude/settings.local.json b/compiler/.claude/settings.local.json\nnew file mode 100644\nindex 0000000..9bbd188\n--- /dev/null\n+++ b/compiler/.claude/settings.local.json\n@@ -0,0 +1,9 @@\n+{\n+  \"permissions\": {\n+    \"allow\": [\n+      \"Bash(node scripts/enable-feature-flag.js:*)\"\n+    ],\n+    \"deny\": [],\n+    \"ask\": []\n+  }\n+}\ndiff --git a/compiler/scripts/enable-feature-flag.js b/compiler/scripts/enable-feature-flag.js\nnew file mode 100755\nindex 0000000..f51c5b4\n--- /dev/null\n+++ b/compiler/scripts/enable-feature-flag.js\n@@ -0,0 +1,347 @@\n+#!/usr/bin/env node\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ */\n+\n+\u0027use strict\u0027;\n+\n+const fs \u003d require(\u0027fs\u0027);\n+const path \u003d require(\u0027path\u0027);\n+const {execSync} \u003d require(\u0027child_process\u0027);\n+const yargs \u003d require(\u0027yargs/yargs\u0027);\n+const {hideBin} \u003d require(\u0027yargs/helpers\u0027);\n+\n+// Constants\n+const COMPILER_ROOT \u003d path.resolve(__dirname, \u0027..\u0027);\n+const ENVIRONMENT_TS_PATH \u003d path.join(\n+  COMPILER_ROOT,\n+  \u0027packages/babel-plugin-react-compiler/src/HIR/Environment.ts\u0027\n+);\n+const FIXTURES_PATH \u003d path.join(\n+  COMPILER_ROOT,\n+  \u0027packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler\u0027\n+);\n+const FIXTURE_EXTENSIONS \u003d [\u0027.js\u0027, \u0027.jsx\u0027, \u0027.ts\u0027, \u0027.tsx\u0027];\n+\n+/**\n+ * Parse command line arguments\n+ */\n+function parseArgs() {\n+  const argv \u003d yargs(hideBin(process.argv))\n+    .usage(\u0027Usage: $0 \u003cflag-name\u003e\u0027)\n+    .command(\u0027$0 \u003cflag-name\u003e\u0027, \u0027Enable a feature flag by default\u0027, yargs \u003d\u003e {\n+      yargs.positional(\u0027flag-name\u0027, {\n+        describe: \u0027Name of the feature flag to enable\u0027,\n+        type: \u0027string\u0027,\n+      });\n+    })\n+    .example(\n+      \u0027$0 validateExhaustiveMemoizationDependencies\u0027,\n+      \u0027Enable the validateExhaustiveMemoizationDependencies flag\u0027\n+    )\n+    .help(\u0027h\u0027)\n+    .alias(\u0027h\u0027, \u0027help\u0027)\n+    .strict()\n+    .parseSync();\n+\n+  return argv[\u0027flag-name\u0027];\n+}\n+\n+/**\n+ * Enable a feature flag in Environment.ts by changing default(false) to default(true)\n+ */\n+function enableFlagInEnvironment(flagName) {\n+  console.log(`\\nEnabling flag \"${flagName}\" in Environment.ts...`);\n+\n+  const content \u003d fs.readFileSync(ENVIRONMENT_TS_PATH, \u0027utf8\u0027);\n+\n+  // Check if the flag exists with default(false)\n+  const flagPatternFalse \u003d new RegExp(\n+    `(${escapeRegex(flagName)}:\\\\s*z\\\\.boolean\\\\(\\\\)\\\\.default\\\\()false(\\\\))`,\n+    \u0027g\u0027\n+  );\n+\n+  if (!flagPatternFalse.test(content)) {\n+    // Check if flag exists at all\n+    const flagExistsPattern \u003d new RegExp(\n+      `${escapeRegex(flagName)}:\\\\s*z\\\\.boolean\\\\(\\\\)`,\n+      \u0027g\u0027\n+    );\n+    if (flagExistsPattern.test(content)) {\n+      // Check if it\u0027s already true\n+      const flagPatternTrue \u003d new RegExp(\n+        `${escapeRegex(flagName)}:\\\\s*z\\\\.boolean\\\\(\\\\)\\\\.default\\\\(true\\\\)`,\n+        \u0027g\u0027\n+      );\n+      if (flagPatternTrue.test(content)) {\n+        console.error(`Error: Flag \"${flagName}\" already has default(true)`);\n+        process.exit(1);\n+      }\n+      console.error(\n+        `Error: Flag \"${flagName}\" exists but doesn\u0027t have default(false)`\n+      );\n+      process.exit(1);\n+    }\n+    console.error(`Error: Flag \"${flagName}\" not found in Environment.ts`);\n+    process.exit(1);\n+  }\n+\n+  // Perform the replacement\n+  const newContent \u003d content.replace(flagPatternFalse, \u0027$1true$2\u0027);\n+\n+  // Verify the replacement worked\n+  if (content \u003d\u003d\u003d newContent) {\n+    console.error(`Error: Failed to replace flag \"${flagName}\"`);\n+    process.exit(1);\n+  }\n+\n+  fs.writeFileSync(ENVIRONMENT_TS_PATH, newContent, \u0027utf8\u0027);\n+  console.log(`Successfully enabled \"${flagName}\" in Environment.ts`);\n+}\n+\n+/**\n+ * Helper to escape regex special characters\n+ */\n+function escapeRegex(string) {\n+  return string.replace(/[.*+?^${}()|[\\]\\\\]/g, \u0027\\\\$\u0026\u0027);\n+}\n+\n+/**\n+ * Run yarn snap and capture output\n+ */\n+function runTests() {\n+  console.log(\u0027\\nRunning test suite (yarn snap)...\u0027);\n+\n+  try {\n+    const output \u003d execSync(\u0027yarn snap\u0027, {\n+      cwd: COMPILER_ROOT,\n+      encoding: \u0027utf8\u0027,\n+      stdio: \u0027pipe\u0027,\n+      maxBuffer: 10 * 1024 * 1024, // 10MB buffer\n+    });\n+    return {success: true, output};\n+  } catch (error) {\n+    // yarn snap exits with code 1 when tests fail, which throws an error\n+    return {success: false, output: error.stdout || error.message};\n+  }\n+}\n+\n+/**\n+ * Parse failing test names from test output\n+ */\n+function parseFailingTests(output) {\n+  const failingTests \u003d [];\n+\n+  // Look for lines that contain \"FAIL:\" followed by the test name\n+  // Format: \"FAIL: test-name\" or with ANSI codes\n+  const lines \u003d output.split(\u0027\\n\u0027);\n+  for (const line of lines) {\n+    // Remove ANSI codes for easier parsing\n+    const cleanLine \u003d line.replace(/\\x1b\\[[0-9;]*m/g, \u0027\u0027);\n+\n+    // Match \"FAIL: test-name\"\n+    const match \u003d cleanLine.match(/^FAIL:\\s*(.+)$/);\n+    if (match) {\n+      failingTests.push(match[1].trim());\n+    }\n+  }\n+\n+  return failingTests;\n+}\n+\n+/**\n+ * Find the fixture file for a given test name\n+ */\n+function findFixtureFile(testName) {\n+  const basePath \u003d path.join(FIXTURES_PATH, testName);\n+\n+  for (const ext of FIXTURE_EXTENSIONS) {\n+    const filePath \u003d basePath + ext;\n+    if (fs.existsSync(filePath)) {\n+      return filePath;\n+    }\n+  }\n+\n+  return null;\n+}\n+\n+/**\n+ * Add pragma to disable the feature flag in a fixture file\n+ */\n+function addPragmaToFixture(filePath, flagName) {\n+  const content \u003d fs.readFileSync(filePath, \u0027utf8\u0027);\n+  const lines \u003d content.split(\u0027\\n\u0027);\n+\n+  if (lines.length \u003d\u003d\u003d 0) {\n+    console.warn(`Warning: Empty file ${filePath}`);\n+    return false;\n+  }\n+\n+  const firstLine \u003d lines[0];\n+  const pragma \u003d `@${flagName}:false`;\n+\n+  // Check if pragma already exists\n+  if (firstLine.includes(pragma)) {\n+    return false; // Already has the pragma\n+  }\n+\n+  // Check if first line is a single-line comment\n+  if (firstLine.trim().startsWith(\u0027//\u0027)) {\n+    // Append pragma to existing comment\n+    lines[0] \u003d firstLine + \u0027 \u0027 + pragma;\n+  } else if (firstLine.trim().startsWith(\u0027/*\u0027)) {\n+    // Multi-line comment - insert new line before it\n+    lines.unshift(\u0027// \u0027 + pragma);\n+  } else {\n+    // No comment - insert new comment as first line\n+    lines.unshift(\u0027// \u0027 + pragma);\n+  }\n+\n+  fs.writeFileSync(filePath, lines.join(\u0027\\n\u0027), \u0027utf8\u0027);\n+  return true;\n+}\n+\n+/**\n+ * Update snapshot files\n+ */\n+function updateSnapshots() {\n+  console.log(\u0027\\nUpdating snapshots (yarn snap -u)...\u0027);\n+\n+  try {\n+    execSync(\u0027yarn snap -u\u0027, {\n+      cwd: COMPILER_ROOT,\n+      encoding: \u0027utf8\u0027,\n+      stdio: \u0027pipe\u0027,\n+      maxBuffer: 10 * 1024 * 1024,\n+    });\n+    console.log(\u0027Snapshots updated successfully\u0027);\n+    return true;\n+  } catch (error) {\n+    console.error(\u0027Error updating snapshots:\u0027, error.message);\n+    return false;\n+  }\n+}\n+\n+/**\n+ * Verify all tests pass\n+ */\n+function verifyAllTestsPass() {\n+  console.log(\u0027\\nRunning final verification (yarn snap)...\u0027);\n+\n+  const {success, output} \u003d runTests();\n+\n+  // Parse summary line: \"N Tests, N Passed, N Failed\"\n+  const summaryMatch \u003d output.match(\n+    /(\\d+)\\s+Tests,\\s+(\\d+)\\s+Passed,\\s+(\\d+)\\s+Failed/\n+  );\n+\n+  if (summaryMatch) {\n+    const [, total, passed, failed] \u003d summaryMatch;\n+    console.log(\n+      `\\nTest Results: ${total} Tests, ${passed} Passed, ${failed} Failed`\n+    );\n+\n+    if (failed \u003d\u003d\u003d \u00270\u0027) {\n+      console.log(\u0027All tests passed!\u0027);\n+      return true;\n+    } else {\n+      console.error(`${failed} tests still failing`);\n+      const failingTests \u003d parseFailingTests(output);\n+      if (failingTests.length \u003e 0) {\n+        console.error(\u0027\\nFailing tests:\u0027);\n+        failingTests.forEach(test \u003d\u003e console.error(`  - ${test}`));\n+      }\n+      return false;\n+    }\n+  }\n+\n+  return success;\n+}\n+\n+/**\n+ * Main function\n+ */\n+async function main() {\n+  const flagName \u003d parseArgs();\n+\n+  console.log(`\\nEnabling flag: \u0027${flagName}\u0027`);\n+\n+  try {\n+    // Step 1: Enable flag in Environment.ts\n+    enableFlagInEnvironment(flagName);\n+\n+    // Step 2: Run tests to find failures\n+    const {output} \u003d runTests();\n+    const failingTests \u003d parseFailingTests(output);\n+\n+    console.log(`\\nFound ${failingTests.length} failing tests`);\n+\n+    if (failingTests.length \u003d\u003d\u003d 0) {\n+      console.log(\u0027No failing tests! Feature flag enabled successfully.\u0027);\n+      process.exit(0);\n+    }\n+\n+    // Step 3: Add pragma to each failing fixture\n+    console.log(`\\nAdding \u0027@${flagName}:false\u0027 pragma to failing fixtures...`);\n+\n+    const notFound \u003d [];\n+    let notFoundCount \u003d 0;\n+\n+    for (const testName of failingTests) {\n+      const fixturePath \u003d findFixtureFile(testName);\n+\n+      if (!fixturePath) {\n+        console.warn(`Could not find fixture file for: ${testName}`);\n+        notFound.push(fixturePath);\n+        continue;\n+      }\n+\n+      const updated \u003d addPragmaToFixture(fixturePath, flagName);\n+      if (updated) {\n+        updatedCount++;\n+        console.log(`  Updated: ${testName}`);\n+      }\n+    }\n+\n+    console.log(\n+      `\\nSummary: Updated ${updatedCount} fixtures, ${notFoundCount} not found`\n+    );\n+\n+    if (notFoundCount.length !\u003d\u003d 0) {\n+      console.error(\n+        \u0027\\nFailed to update snapshots, could not find:\\n\u0027 + notFound.join(\u0027\\n\u0027)\n+      );\n+      process.exit(1);\n+    }\n+\n+    // Step 4: Update snapshots\n+    if (!updateSnapshots()) {\n+      console.error(\u0027\\nFailed to update snapshots\u0027);\n+      process.exit(1);\n+    }\n+\n+    // Step 5: Verify all tests pass\n+    if (!verifyAllTestsPass()) {\n+      console.error(\u0027\\nVerification failed: Some tests are still failing\u0027);\n+      process.exit(1);\n+    }\n+\n+    console.log(\u0027\\nSuccess! Feature flag enabled and all tests passing.\u0027);\n+    console.log(`\\nSummary:`);\n+    console.log(`  - Enabled \"${flagName}\" in Environment.ts`);\n+    console.log(`  - Updated ${updatedCount} fixture files with pragma`);\n+    console.log(`  - All tests passing`);\n+\n+    process.exit(0);\n+  } catch (error) {\n+    console.error(\u0027\\nFatal error:\u0027, error.message);\n+    console.error(error.stack);\n+    process.exit(1);\n+  }\n+}\n+\n+// Run the script\n+main();","expectedMessage":"[compiler] Script to enable a feature by default and update tests (#35202)","repository":"react","commitHash":"16e16ec6ffe159ba831203eeeb7efe72df82c4be","metadata":{"author":"Joseph Savona \u003c6425824+josephsavona@users.noreply.github.com\u003e"}}
{"id":"react-9599e7a7","diff":" .../packages/babel-plugin-react-compiler/src/CompilerError.ts  | 10 +++++++++-\n .../babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts     |  8 +++++---\n .../src/Validation/ValidateExhaustiveDependencies.ts           |  4 ++--\n .../fixtures/compiler/error.invalid-exhaustive-deps.expect.md  |  8 ++++----\n 4 files changed, 20 insertions(+), 10 deletions(-)\n\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/CompilerError.ts b/compiler/packages/babel-plugin-react-compiler/src/CompilerError.ts\nindex 352d31b..c7c8d6a 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/CompilerError.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/CompilerError.ts\n@@ -1067,7 +1067,15 @@ function getRuleForCategoryImpl(category: ErrorCategory): LintRule {\n         name: \u0027memo-dependencies\u0027,\n         description:\n           \u0027Validates that useMemo() and useCallback() specify comprehensive dependencies without extraneous values. See [`useMemo()` docs](https://react.dev/reference/react/useMemo) for more information.\u0027,\n-        preset: LintRulePreset.RecommendedLatest,\n+        /**\n+         * TODO: the \"MemoDependencies\" rule largely reimplements the \"exhaustive-deps\" non-compiler rule,\n+         * allowing the compiler to ensure it does not regress change behavior due to different dependencies.\n+         * We previously relied on the source having ESLint suppressions for any exhaustive-deps violations,\n+         * but it\u0027s more reliable to verify it within the compiler.\n+         *\n+         * Long-term we should de-duplicate these implementations.\n+         */\n+        preset: LintRulePreset.Off,\n       };\n     }\n     case ErrorCategory.IncompatibleLibrary: {\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts b/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts\nindex 3d97d4d..1b76dfb 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Entrypoint/Pipeline.ts\n@@ -303,9 +303,11 @@ function runWithEnvironment(\n   inferReactivePlaces(hir);\n   log({kind: \u0027hir\u0027, name: \u0027InferReactivePlaces\u0027, value: hir});\n \n-  if (env.config.validateExhaustiveMemoizationDependencies) {\n-    // NOTE: this relies on reactivity inference running first\n-    validateExhaustiveDependencies(hir).unwrap();\n+  if (env.enableValidations) {\n+    if (env.config.validateExhaustiveMemoizationDependencies) {\n+      // NOTE: this relies on reactivity inference running first\n+      validateExhaustiveDependencies(hir).unwrap();\n+    }\n   }\n \n   rewriteInstructionKindsBasedOnReassignment(hir);\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\nindex d5f9ab2..b3a68fc 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\n+++ b/compiler/packages/babel-plugin-react-compiler/src/Validation/ValidateExhaustiveDependencies.ts\n@@ -284,7 +284,7 @@ export function validateExhaustiveDependencies(\n       if (missing.length !\u003d\u003d 0) {\n         const diagnostic \u003d CompilerDiagnostic.create({\n           category: ErrorCategory.MemoDependencies,\n-          reason: \u0027Found non-exhaustive dependencies\u0027,\n+          reason: \u0027Found missing memoization dependencies\u0027,\n           description:\n             \u0027Missing dependencies can cause a value not to update when those inputs change, \u0027 +\n             \u0027resulting in stale UI\u0027,\n@@ -309,7 +309,7 @@ export function validateExhaustiveDependencies(\n           reason: \u0027Found unnecessary memoization dependencies\u0027,\n           description:\n             \u0027Unnecessary dependencies can cause a value to update more often than necessary, \u0027 +\n-            \u0027which can cause effects to run more than expected\u0027,\n+            \u0027causing performance regressions and effects to fire more often than expected\u0027,\n         });\n         diagnostic.withDetails({\n           kind: \u0027error\u0027,\ndiff --git a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.expect.md b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.expect.md\nindex bca95a8..ed317be 100644\n--- a/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.expect.md\n+++ b/compiler/packages/babel-plugin-react-compiler/src/__tests__/fixtures/compiler/error.invalid-exhaustive-deps.expect.md\n@@ -53,7 +53,7 @@ function Component({x, y, z}) {\n ```\n Found 4 errors:\n \n-Error: Found non-exhaustive dependencies\n+Error: Found missing memoization dependencies\n \n Missing dependencies can cause a value not to update when those inputs change, resulting in stale UI.\n \n@@ -66,7 +66,7 @@ error.invalid-exhaustive-deps.ts:7:11\n    9 |   }, [x?.y.z?.a.b]);\n   10 |   const b \u003d useMemo(() \u003d\u003e {\n \n-Error: Found non-exhaustive dependencies\n+Error: Found missing memoization dependencies\n \n Missing dependencies can cause a value not to update when those inputs change, resulting in stale UI.\n \n@@ -81,7 +81,7 @@ error.invalid-exhaustive-deps.ts:15:11\n \n Error: Found unnecessary memoization dependencies\n \n-Unnecessary dependencies can cause a value to update more often than necessary, which can cause effects to run more than expected.\n+Unnecessary dependencies can cause a value to update more often than necessary, causing performance regressions and effects to fire more often than expected.\n \n error.invalid-exhaustive-deps.ts:31:5\n   29 |     return [];\n@@ -92,7 +92,7 @@ error.invalid-exhaustive-deps.ts:31:5\n   33 |   const ref2 \u003d useRef(null);\n   34 |   const ref \u003d z ? ref1 : ref2;\n \n-Error: Found non-exhaustive dependencies\n+Error: Found missing memoization dependencies\n \n Missing dependencies can cause a value not to update when those inputs change, resulting in stale UI.\n ","expectedMessage":"[compiler] Adjustments to exhaustive deps messages, disable the lint rule (#35192)","repository":"react","commitHash":"9599e7a787cce2a41c35d783d45a160dfebab277","metadata":{"author":"Joseph Savona \u003c6425824+josephsavona@users.noreply.github.com\u003e"}}
