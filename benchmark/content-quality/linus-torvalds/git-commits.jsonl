{"id":"git-linus-04ede972","diff":" builtin/symbolic-ref.c  |  2 ++\n t/t1401-symbolic-ref.sh | 10 ++++++++++\n t/t4202-log.sh          |  4 ++--\n 3 files changed, 14 insertions(+), 2 deletions(-)\n\ndiff --git a/builtin/symbolic-ref.c b/builtin/symbolic-ref.c\nindex e547a08d6c..1b0f10225f 100644\n--- a/builtin/symbolic-ref.c\n+++ b/builtin/symbolic-ref.c\n@@ -71,6 +71,8 @@ int cmd_symbolic_ref(int argc, const char **argv, const char *prefix)\n \t\tif (!strcmp(argv[0], \"HEAD\") \u0026\u0026\n \t\t    !starts_with(argv[1], \"refs/\"))\n \t\t\tdie(\"Refusing to point HEAD outside of refs/\");\n+\t\tif (check_refname_format(argv[1], REFNAME_ALLOW_ONELEVEL) \u003c 0)\n+\t\t\tdie(\"Refusing to set \u0027%s\u0027 to invalid ref \u0027%s\u0027\", argv[0], argv[1]);\n \t\tret \u003d !!create_symref(argv[0], argv[1], msg);\n \t\tbreak;\n \tdefault:\ndiff --git a/t/t1401-symbolic-ref.sh b/t/t1401-symbolic-ref.sh\nindex 9fb0b90f25..0c204089b8 100755\n--- a/t/t1401-symbolic-ref.sh\n+++ b/t/t1401-symbolic-ref.sh\n@@ -165,4 +165,14 @@ test_expect_success \u0027symbolic-ref can resolve d/f name (ENOTDIR)\u0027 \u0027\n \ttest_cmp expect actual\n \u0027\n \n+test_expect_success \u0027symbolic-ref refuses invalid target for non-HEAD\u0027 \u0027\n+\ttest_must_fail git symbolic-ref refs/heads/invalid foo..bar\n+\u0027\n+\n+test_expect_success \u0027symbolic-ref allows top-level target for non-HEAD\u0027 \u0027\n+\tgit symbolic-ref refs/heads/top-level FETCH_HEAD \u0026\u0026\n+\tgit update-ref FETCH_HEAD HEAD \u0026\u0026\n+\ttest_cmp_rev top-level HEAD\n+\u0027\n+\n test_done\ndiff --git a/t/t4202-log.sh b/t/t4202-log.sh\nindex 6e66352558..f0aaa1fa02 100755\n--- a/t/t4202-log.sh\n+++ b/t/t4202-log.sh\n@@ -2112,9 +2112,9 @@ test_expect_success REFFILES \u0027log diagnoses bogus HEAD hash\u0027 \u0027\n \ttest_i18ngrep broken stderr\n \u0027\n \n-test_expect_success \u0027log diagnoses bogus HEAD symref\u0027 \u0027\n+test_expect_success REFFILES \u0027log diagnoses bogus HEAD symref\u0027 \u0027\n \tgit init empty \u0026\u0026\n-\tgit --git-dir empty/.git symbolic-ref HEAD refs/heads/invalid.lock \u0026\u0026\n+\techo \"ref: refs/heads/invalid.lock\" \u003e empty/.git/HEAD \u0026\u0026\n \ttest_must_fail git -C empty log 2\u003estderr \u0026\u0026\n \ttest_i18ngrep broken stderr \u0026\u0026\n \ttest_must_fail git -C empty log --default totally-bogus 2\u003estderr \u0026\u0026","expectedMessage":"symbolic-ref: refuse to set syntactically invalid target","repository":"git-linus","commitHash":"04ede97211c132f4d71c96c61f5124cbb3ebdc77","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-acdd3776","diff":" builtin/blame.c |   4 ++\n cache.h         |   1 +\n date.c          | 130 +++++++++++++++++++++++++++++++++++++++++++++++---------\n 3 files changed, 115 insertions(+), 20 deletions(-)\n\ndiff --git a/builtin/blame.c b/builtin/blame.c\nindex 5a0388aaef..7b6235321c 100644\n--- a/builtin/blame.c\n+++ b/builtin/blame.c\n@@ -917,6 +917,10 @@ int cmd_blame(int argc, const char **argv, const char *prefix)\n \t\t */\n \t\tblame_date_width \u003d utf8_strwidth(_(\"4 years, 11 months ago\")) + 1; /* add the null */\n \t\tbreak;\n+\tcase DATE_HUMAN:\n+\t\t/* If the year is shown, no time is shown */\n+\t\tblame_date_width \u003d sizeof(\"Thu Oct 19 16:00\");\n+\t\tbreak;\n \tcase DATE_NORMAL:\n \t\tblame_date_width \u003d sizeof(\"Thu Oct 19 16:00:04 2006 -0700\");\n \t\tbreak;\ndiff --git a/cache.h b/cache.h\nindex d49092d94d..8a6810ee6a 100644\n--- a/cache.h\n+++ b/cache.h\n@@ -1428,6 +1428,7 @@ extern struct object *peel_to_type(const char *name, int namelen,\n struct date_mode {\n \tenum date_mode_type {\n \t\tDATE_NORMAL \u003d 0,\n+\t\tDATE_HUMAN,\n \t\tDATE_RELATIVE,\n \t\tDATE_SHORT,\n \t\tDATE_ISO8601,\ndiff --git a/date.c b/date.c\nindex 49f943e25b..4486c028ac 100644\n--- a/date.c\n+++ b/date.c\n@@ -77,22 +77,16 @@ static struct tm *time_to_tm_local(timestamp_t time)\n }\n \n /*\n- * What value of \"tz\" was in effect back then at \"time\" in the\n- * local timezone?\n+ * Fill in the localtime \u0027struct tm\u0027 for the supplied time,\n+ * and return the local tz.\n  */\n-static int local_tzoffset(timestamp_t time)\n+static int local_time_tzoffset(time_t t, struct tm *tm)\n {\n-\ttime_t t, t_local;\n-\tstruct tm tm;\n+\ttime_t t_local;\n \tint offset, eastwest;\n \n-\tif (date_overflows(time))\n-\t\tdie(\"Timestamp too large for this system: %\"PRItime, time);\n-\n-\tt \u003d (time_t)time;\n-\tlocaltime_r(\u0026t, \u0026tm);\n-\tt_local \u003d tm_to_time_t(\u0026tm);\n-\n+\tlocaltime_r(\u0026t, tm);\n+\tt_local \u003d tm_to_time_t(tm);\n \tif (t_local \u003d\u003d -1)\n \t\treturn 0; /* error; just use +0000 */\n \tif (t_local \u003c t) {\n@@ -107,6 +101,20 @@ static int local_tzoffset(timestamp_t time)\n \treturn offset * eastwest;\n }\n \n+/*\n+ * What value of \"tz\" was in effect back then at \"time\" in the\n+ * local timezone?\n+ */\n+static int local_tzoffset(timestamp_t time)\n+{\n+\tstruct tm tm;\n+\n+\tif (date_overflows(time))\n+\t\tdie(\"Timestamp too large for this system: %\"PRItime, time);\n+\n+\treturn local_time_tzoffset((time_t)time, \u0026tm);\n+}\n+\n void show_date_relative(timestamp_t time, int tz,\n \t\t\t       const struct timeval *now,\n \t\t\t       struct strbuf *timebuf)\n@@ -191,9 +199,80 @@ struct date_mode *date_mode_from_type(enum date_mode_type type)\n \treturn \u0026mode;\n }\n \n+static void show_date_normal(struct strbuf *buf, timestamp_t time, struct tm *tm, int tz, struct tm *human_tm, int human_tz, int local)\n+{\n+\tstruct {\n+\t\tunsigned int\tyear:1,\n+\t\t\t\tdate:1,\n+\t\t\t\twday:1,\n+\t\t\t\ttime:1,\n+\t\t\t\tseconds:1,\n+\t\t\t\ttz:1;\n+\t} hide \u003d { 0 };\n+\n+\thide.tz \u003d local || tz \u003d\u003d human_tz;\n+\thide.year \u003d tm-\u003etm_year \u003d\u003d human_tm-\u003etm_year;\n+\tif (hide.year) {\n+\t\tif (tm-\u003etm_mon \u003d\u003d human_tm-\u003etm_mon) {\n+\t\t\tif (tm-\u003etm_mday \u003e human_tm-\u003etm_mday) {\n+\t\t\t\t/* Future date: think timezones */\n+\t\t\t} else if (tm-\u003etm_mday \u003d\u003d human_tm-\u003etm_mday) {\n+\t\t\t\thide.date \u003d hide.wday \u003d 1;\n+\t\t\t} else if (tm-\u003etm_mday + 5 \u003e human_tm-\u003etm_mday) {\n+\t\t\t\t/* Leave just weekday if it was a few days ago */\n+\t\t\t\thide.date \u003d 1;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/* Show \"today\" times as just relative times */\n+\tif (hide.wday) {\n+\t\tstruct timeval now;\n+\t\tgettimeofday(\u0026now, NULL);\n+\t\tshow_date_relative(time, tz, \u0026now, buf);\n+\t\treturn;\n+\t}\n+\n+\t/*\n+\t * Always hide seconds for human-readable.\n+\t * Hide timezone if showing date.\n+\t * Hide weekday and time if showing year.\n+\t *\n+\t * The logic here is two-fold:\n+\t *  (a) only show details when recent enough to matter\n+\t *  (b) keep the maximum length \"similar\", and in check\n+\t */\n+\tif (human_tm-\u003etm_year) {\n+\t\thide.seconds \u003d 1;\n+\t\thide.tz |\u003d !hide.date;\n+\t\thide.wday \u003d hide.time \u003d !hide.year;\n+\t}\n+\n+\tif (!hide.wday)\n+\t\tstrbuf_addf(buf, \"%.3s \", weekday_names[tm-\u003etm_wday]);\n+\tif (!hide.date)\n+\t\tstrbuf_addf(buf, \"%.3s %d \", month_names[tm-\u003etm_mon], tm-\u003etm_mday);\n+\n+\t/* Do we want AM/PM depending on locale? */\n+\tif (!hide.time) {\n+\t\tstrbuf_addf(buf, \"%02d:%02d\", tm-\u003etm_hour, tm-\u003etm_min);\n+\t\tif (!hide.seconds)\n+\t\t\tstrbuf_addf(buf, \":%02d\", tm-\u003etm_sec);\n+\t} else\n+\t\tstrbuf_rtrim(buf);\n+\n+\tif (!hide.year)\n+\t\tstrbuf_addf(buf, \" %d\", tm-\u003etm_year + 1900);\n+\n+\tif (!hide.tz)\n+\t\tstrbuf_addf(buf, \" %+05d\", tz);\n+}\n+\n const char *show_date(timestamp_t time, int tz, const struct date_mode *mode)\n {\n \tstruct tm *tm;\n+\tstruct tm human_tm \u003d { 0 };\n+\tint human_tz \u003d -1;\n \tstatic struct strbuf timebuf \u003d STRBUF_INIT;\n \n \tif (mode-\u003etype \u003d\u003d DATE_UNIX) {\n@@ -202,6 +281,15 @@ const char *show_date(timestamp_t time, int tz, const struct date_mode *mode)\n \t\treturn timebuf.buf;\n \t}\n \n+\tif (mode-\u003etype \u003d\u003d DATE_HUMAN) {\n+\t\tstruct timeval now;\n+\n+\t\tgettimeofday(\u0026now, NULL);\n+\n+\t\t/* Fill in the data for \"current time\" in human_tz and human_tm */\n+\t\thuman_tz \u003d local_time_tzoffset(now.tv_sec, \u0026human_tm);\n+\t}\n+\n \tif (mode-\u003elocal)\n \t\ttz \u003d local_tzoffset(time);\n \n@@ -258,14 +346,7 @@ const char *show_date(timestamp_t time, int tz, const struct date_mode *mode)\n \t\tstrbuf_addftime(\u0026timebuf, mode-\u003estrftime_fmt, tm, tz,\n \t\t\t\t!mode-\u003elocal);\n \telse\n-\t\tstrbuf_addf(\u0026timebuf, \"%.3s %.3s %d %02d:%02d:%02d %d%c%+05d\",\n-\t\t\t\tweekday_names[tm-\u003etm_wday],\n-\t\t\t\tmonth_names[tm-\u003etm_mon],\n-\t\t\t\ttm-\u003etm_mday,\n-\t\t\t\ttm-\u003etm_hour, tm-\u003etm_min, tm-\u003etm_sec,\n-\t\t\t\ttm-\u003etm_year + 1900,\n-\t\t\t\tmode-\u003elocal ? 0 : \u0027 \u0027,\n-\t\t\t\ttz);\n+\t\tshow_date_normal(\u0026timebuf, time, tm, tz, \u0026human_tm, human_tz, mode-\u003elocal);\n \treturn timebuf.buf;\n }\n \n@@ -802,6 +883,11 @@ int parse_date(const char *date, struct strbuf *result)\n \treturn 0;\n }\n \n+static int auto_date_style(void)\n+{\n+\treturn (isatty(1) || pager_in_use()) ? DATE_HUMAN : DATE_NORMAL;\n+}\n+\n static enum date_mode_type parse_date_type(const char *format, const char **end)\n {\n \tif (skip_prefix(format, \"relative\", end))\n@@ -819,6 +905,10 @@ static enum date_mode_type parse_date_type(const char *format, const char **end)\n \t\treturn DATE_SHORT;\n \tif (skip_prefix(format, \"default\", end))\n \t\treturn DATE_NORMAL;\n+\tif (skip_prefix(format, \"human\", end))\n+\t\treturn DATE_HUMAN;\n+\tif (skip_prefix(format, \"auto\", end))\n+\t\treturn auto_date_style();\n \tif (skip_prefix(format, \"raw\", end))\n \t\treturn DATE_RAW;\n \tif (skip_prefix(format, \"unix\", end))","expectedMessage":"Add \u0027human\u0027 date format","repository":"git-linus","commitHash":"acdd37769de8b0fe37a74bfc0475b63bdc55e9dc","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-fd1062e5","diff":" mailinfo.c    | 7 ++++++-\n t/t4150-am.sh | 6 ++++--\n 2 files changed, 10 insertions(+), 3 deletions(-)\n\ndiff --git a/mailinfo.c b/mailinfo.c\nindex 2275b285f0..1e4e283099 100644\n--- a/mailinfo.c\n+++ b/mailinfo.c\n@@ -674,8 +674,13 @@ static int handle_commit_msg(struct mailinfo *mi, struct strbuf *line)\n \tassert(!mi-\u003efilter_stage);\n \n \tif (mi-\u003eheader_stage) {\n-\t\tif (!line-\u003elen || (line-\u003elen \u003d\u003d 1 \u0026\u0026 line-\u003ebuf[0] \u003d\u003d \u0027\\n\u0027))\n+\t\tif (!line-\u003elen || (line-\u003elen \u003d\u003d 1 \u0026\u0026 line-\u003ebuf[0] \u003d\u003d \u0027\\n\u0027)) {\n+\t\t\tif (mi-\u003einbody_header_accum.len) {\n+\t\t\t\tflush_inbody_header_accum(mi);\n+\t\t\t\tmi-\u003eheader_stage \u003d 0;\n+\t\t\t}\n \t\t\treturn 0;\n+\t\t}\n \t}\n \n \tif (mi-\u003euse_inbody_headers \u0026\u0026 mi-\u003eheader_stage) {\ndiff --git a/t/t4150-am.sh b/t/t4150-am.sh\nindex 89a5bacac5..44807e218d 100755\n--- a/t/t4150-am.sh\n+++ b/t/t4150-am.sh\n@@ -983,7 +983,9 @@ test_expect_success \u0027am works with multi-line in-body headers\u0027 \u0027\n \trm -fr .git/rebase-apply \u0026\u0026\n \tgit checkout -f first \u0026\u0026\n \techo one \u003e\u003e file \u0026\u0026\n-\tgit commit -am \"$LONG\" --author\u003d\"$LONG \u003clong@example.com\u003e\" \u0026\u0026\n+\tgit commit -am \"$LONG\n+\n+    Body test\" --author\u003d\"$LONG \u003clong@example.com\u003e\" \u0026\u0026\n \tgit format-patch --stdout -1 \u003epatch \u0026\u0026\n \t# bump from, date, and subject down to in-body header\n \tperl -lpe \"\n@@ -997,7 +999,7 @@ test_expect_success \u0027am works with multi-line in-body headers\u0027 \u0027\n \tgit am msg \u0026\u0026\n \t# Ensure that the author and full message are present\n \tgit cat-file commit HEAD | grep \"^author.*long@example.com\" \u0026\u0026\n-\tgit cat-file commit HEAD | grep \"^$LONG\"\n+\tgit cat-file commit HEAD | grep \"^$LONG$\"\n \u0027\n \n test_done","expectedMessage":"mailinfo: fix in-body header continuations","repository":"git-linus","commitHash":"fd1062e52e1a7ed3be443a320708ed849958c1bf","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-859b7f1d","diff":" Documentation/glossary-content.txt |  4 +++-\n pathspec.c                         | 15 ++++++++++-----\n t/t6132-pathspec-exclude.sh        |  6 ++++--\n 3 files changed, 17 insertions(+), 8 deletions(-)\n\ndiff --git a/Documentation/glossary-content.txt b/Documentation/glossary-content.txt\nindex 822ca83264..fc9320e59e 100644\n--- a/Documentation/glossary-content.txt\n+++ b/Documentation/glossary-content.txt\n@@ -387,7 +387,9 @@ Glob magic is incompatible with literal magic.\n exclude;;\n \tAfter a path matches any non-exclude pathspec, it will be run\n \tthrough all exclude pathspec (magic signature: `!` or its\n-\tsynonym `^`). If it matches, the path is ignored.\n+\tsynonym `^`). If it matches, the path is ignored.  When there\n+\tis no non-exclude pathspec, the exclusion is applied to the\n+\tresult set as if invoked without any pathspec.\n --\n \n [[def_parent]]parent::\ndiff --git a/pathspec.c b/pathspec.c\nindex ecad034063..b961f00c8c 100644\n--- a/pathspec.c\n+++ b/pathspec.c\n@@ -522,7 +522,7 @@ void parse_pathspec(struct pathspec *pathspec,\n \t}\n \n \tpathspec-\u003enr \u003d n;\n-\tALLOC_ARRAY(pathspec-\u003eitems, n);\n+\tALLOC_ARRAY(pathspec-\u003eitems, n + 1);\n \titem \u003d pathspec-\u003eitems;\n \tprefixlen \u003d prefix ? strlen(prefix) : 0;\n \n@@ -546,10 +546,15 @@ void parse_pathspec(struct pathspec *pathspec,\n \t\tpathspec-\u003emagic |\u003d item[i].magic;\n \t}\n \n-\tif (nr_exclude \u003d\u003d n)\n-\t\tdie(_(\"There is nothing to exclude from by :(exclude) patterns.\\n\"\n-\t\t      \"Perhaps you forgot to add either \u0027:/\u0027 or \u0027.\u0027 ?\"));\n-\n+\t/*\n+\t * If everything is an exclude pattern, add one positive pattern\n+\t * that matches everyting. We allocated an extra one for this.\n+\t */\n+\tif (nr_exclude \u003d\u003d n) {\n+\t\tint plen \u003d (!(flags \u0026 PATHSPEC_PREFER_CWD)) ? 0 : prefixlen;\n+\t\tinit_pathspec_item(item + n, 0, prefix, plen, \"\");\n+\t\tpathspec-\u003enr++;\n+\t}\n \n \tif (pathspec-\u003emagic \u0026 PATHSPEC_MAXDEPTH) {\n \t\tif (flags \u0026 PATHSPEC_KEEP_ORDER)\ndiff --git a/t/t6132-pathspec-exclude.sh b/t/t6132-pathspec-exclude.sh\nindex d51595cf6b..9dd5cde5fc 100755\n--- a/t/t6132-pathspec-exclude.sh\n+++ b/t/t6132-pathspec-exclude.sh\n@@ -25,8 +25,10 @@ EOF\n \ttest_cmp expect actual\n \u0027\n \n-test_expect_success \u0027exclude only should error out\u0027 \u0027\n-\ttest_must_fail git log --oneline --format\u003d%s -- \":(exclude)sub\"\n+test_expect_success \u0027exclude only no longer errors out\u0027 \u0027\n+\tgit log --oneline --format\u003d%s -- . \":(exclude)sub\" \u003eexpect \u0026\u0026\n+\tgit log --oneline --format\u003d%s -- \":(exclude)sub\" \u003eactual \u0026\u0026\n+\ttest_cmp expect actual\n \u0027\n \n test_expect_success \u0027t_e_i() exclude sub\u0027 \u0027","expectedMessage":"pathspec: don\u0027t error out on all-exclusionary pathspec patterns","repository":"git-linus","commitHash":"859b7f1d0e742493d2a9396794cd9040213ad846","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-42ebeb9d","diff":" Documentation/glossary-content.txt | 4 ++--\n pathspec.c                         | 6 ++++++\n 2 files changed, 8 insertions(+), 2 deletions(-)\n\ndiff --git a/Documentation/glossary-content.txt b/Documentation/glossary-content.txt\nindex 8ad29e61a9..822ca83264 100644\n--- a/Documentation/glossary-content.txt\n+++ b/Documentation/glossary-content.txt\n@@ -386,8 +386,8 @@ Glob magic is incompatible with literal magic.\n \n exclude;;\n \tAfter a path matches any non-exclude pathspec, it will be run\n-\tthrough all exclude pathspec (magic signature: `!`). If it\n-\tmatches, the path is ignored.\n+\tthrough all exclude pathspec (magic signature: `!` or its\n+\tsynonym `^`). If it matches, the path is ignored.\n --\n \n [[def_parent]]parent::\ndiff --git a/pathspec.c b/pathspec.c\nindex 7ababb3159..ecad034063 100644\n--- a/pathspec.c\n+++ b/pathspec.c\n@@ -224,6 +224,12 @@ static const char *parse_short_magic(unsigned *magic, const char *elem)\n \t\tchar ch \u003d *pos;\n \t\tint i;\n \n+\t\t/* Special case alias for \u0027!\u0027 */\n+\t\tif (ch \u003d\u003d \u0027^\u0027) {\n+\t\t\t*magic |\u003d PATHSPEC_EXCLUDE;\n+\t\t\tcontinue;\n+\t\t}\n+\n \t\tif (!is_pathspec_magic(ch))\n \t\t\tbreak;\n ","expectedMessage":"pathspec magic: add \u0027^\u0027 as alias for \u0027!\u0027","repository":"git-linus","commitHash":"42ebeb9d07de3c6d3a263f8ebce0508e489e5cc9","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-fbfda15f","diff":" builtin/shortlog.c | 15 ++++++++++++---\n shortlog.h         |  1 +\n 2 files changed, 13 insertions(+), 3 deletions(-)\n\ndiff --git a/builtin/shortlog.c b/builtin/shortlog.c\nindex ba0e1154a9..c9585d475d 100644\n--- a/builtin/shortlog.c\n+++ b/builtin/shortlog.c\n@@ -117,11 +117,15 @@ static void read_from_stdin(struct shortlog *log)\n {\n \tstruct strbuf author \u003d STRBUF_INIT;\n \tstruct strbuf oneline \u003d STRBUF_INIT;\n+\tstatic const char *author_match[2] \u003d { \"Author: \", \"author \" };\n+\tstatic const char *committer_match[2] \u003d { \"Commit: \", \"committer \" };\n+\tconst char **match;\n \n+\tmatch \u003d log-\u003ecommitter ? committer_match : author_match;\n \twhile (strbuf_getline_lf(\u0026author, stdin) !\u003d EOF) {\n \t\tconst char *v;\n-\t\tif (!skip_prefix(author.buf, \"Author: \", \u0026v) \u0026\u0026\n-\t\t    !skip_prefix(author.buf, \"author \", \u0026v))\n+\t\tif (!skip_prefix(author.buf, match[0], \u0026v) \u0026\u0026\n+\t\t    !skip_prefix(author.buf, match[1], \u0026v))\n \t\t\tcontinue;\n \t\twhile (strbuf_getline_lf(\u0026oneline, stdin) !\u003d EOF \u0026\u0026\n \t\t       oneline.len)\n@@ -140,6 +144,7 @@ void shortlog_add_commit(struct shortlog *log, struct commit *commit)\n \tstruct strbuf author \u003d STRBUF_INIT;\n \tstruct strbuf oneline \u003d STRBUF_INIT;\n \tstruct pretty_print_context ctx \u003d {0};\n+\tconst char *fmt;\n \n \tctx.fmt \u003d CMIT_FMT_USERFORMAT;\n \tctx.abbrev \u003d log-\u003eabbrev;\n@@ -148,7 +153,9 @@ void shortlog_add_commit(struct shortlog *log, struct commit *commit)\n \tctx.date_mode.type \u003d DATE_NORMAL;\n \tctx.output_encoding \u003d get_log_output_encoding();\n \n-\tformat_commit_message(commit, \"%an \u003c%ae\u003e\", \u0026author, \u0026ctx);\n+\tfmt \u003d log-\u003ecommitter ? \"%cn \u003c%ce\u003e\" : \"%an \u003c%ae\u003e\";\n+\n+\tformat_commit_message(commit, fmt, \u0026author, \u0026ctx);\n \tif (!log-\u003esummary) {\n \t\tif (log-\u003euser_format)\n \t\t\tpretty_print_commit(\u0026ctx, commit, \u0026oneline);\n@@ -238,6 +245,8 @@ int cmd_shortlog(int argc, const char **argv, const char *prefix)\n \tint nongit \u003d !startup_info-\u003ehave_repository;\n \n \tconst struct option options[] \u003d {\n+\t\tOPT_BOOL(\u0027c\u0027, \"committer\", \u0026log.committer,\n+\t\t\t N_(\"Group by committer rather than author\")),\n \t\tOPT_BOOL(\u0027n\u0027, \"numbered\", \u0026log.sort_by_number,\n \t\t\t N_(\"sort output according to the number of commits per author\")),\n \t\tOPT_BOOL(\u0027s\u0027, \"summary\", \u0026log.summary,\ndiff --git a/shortlog.h b/shortlog.h\nindex 5a326c6860..5d64cfe929 100644\n--- a/shortlog.h\n+++ b/shortlog.h\n@@ -13,6 +13,7 @@ struct shortlog {\n \tint in2;\n \tint user_format;\n \tint abbrev;\n+\tint committer;\n \n \tchar *common_repo_prefix;\n \tint email;","expectedMessage":"shortlog: group by committer information","repository":"git-linus","commitHash":"fbfda15fb8daf7388a19b8bed2f319a8c1b6c5f1","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-e6c587c7","diff":" cache.h       |  1 +\n environment.c |  2 +-\n sha1_name.c   | 28 +++++++++++++++++++++++++++-\n 3 files changed, 29 insertions(+), 2 deletions(-)\n\ndiff --git a/cache.h b/cache.h\nindex 5a651b8435..0e2a0595e5 100644\n--- a/cache.h\n+++ b/cache.h\n@@ -1204,6 +1204,7 @@ struct object_context {\n #define GET_SHA1_TREEISH          020\n #define GET_SHA1_BLOB             040\n #define GET_SHA1_FOLLOW_SYMLINKS 0100\n+#define GET_SHA1_AUTOMATIC\t 0200\n #define GET_SHA1_ONLY_TO_DIE    04000\n \n #define GET_SHA1_DISAMBIGUATORS \\\ndiff --git a/environment.c b/environment.c\nindex 44fb107b8a..6f9d290563 100644\n--- a/environment.c\n+++ b/environment.c\n@@ -16,7 +16,7 @@ int trust_executable_bit \u003d 1;\n int trust_ctime \u003d 1;\n int check_stat \u003d 1;\n int has_symlinks \u003d 1;\n-int minimum_abbrev \u003d 4, default_abbrev \u003d FALLBACK_DEFAULT_ABBREV;\n+int minimum_abbrev \u003d 4, default_abbrev \u003d -1;\n int ignore_case;\n int assume_unchanged;\n int prefer_symlink_refs;\ndiff --git a/sha1_name.c b/sha1_name.c\nindex 3b647fd7cf..beb7ab588b 100644\n--- a/sha1_name.c\n+++ b/sha1_name.c\n@@ -15,6 +15,7 @@ typedef int (*disambiguate_hint_fn)(const unsigned char *, void *);\n \n struct disambiguate_state {\n \tint len; /* length of prefix in hex chars */\n+\tunsigned int nrobjects;\n \tchar hex_pfx[GIT_SHA1_HEXSZ + 1];\n \tunsigned char bin_pfx[GIT_SHA1_RAWSZ];\n \n@@ -118,6 +119,14 @@ static void find_short_object_filename(struct disambiguate_state *ds)\n \n \t\t\tif (strlen(de-\u003ed_name) !\u003d 38)\n \t\t\t\tcontinue;\n+\n+\t\t\t/*\n+\t\t\t * We only look at the one subdirectory, and we assume\n+\t\t\t * each subdirectory is roughly similar, so each\n+\t\t\t * object we find probably has 255 other objects in\n+\t\t\t * the other fan-out directories.\n+\t\t\t */\n+\t\t\tds-\u003enrobjects +\u003d 256;\n \t\t\tif (memcmp(de-\u003ed_name, ds-\u003ehex_pfx + 2, ds-\u003elen - 2))\n \t\t\t\tcontinue;\n \t\t\tmemcpy(hex + 2, de-\u003ed_name, 38);\n@@ -151,6 +160,7 @@ static void unique_in_pack(struct packed_git *p,\n \n \topen_pack_index(p);\n \tnum \u003d p-\u003enum_objects;\n+\tds-\u003enrobjects +\u003d num;\n \tlast \u003d num;\n \twhile (first \u003c last) {\n \t\tuint32_t mid \u003d (first + last) / 2;\n@@ -380,6 +390,9 @@ static int show_ambiguous_object(const unsigned char *sha1, void *data)\n \treturn 0;\n }\n \n+/* start from our historical default before the automatic abbreviation */\n+static int default_automatic_abbrev \u003d FALLBACK_DEFAULT_ABBREV;\n+\n static int get_short_sha1(const char *name, int len, unsigned char *sha1,\n \t\t\t  unsigned flags)\n {\n@@ -426,6 +439,14 @@ static int get_short_sha1(const char *name, int len, unsigned char *sha1,\n \t\tfor_each_abbrev(ds.hex_pfx, show_ambiguous_object, \u0026ds);\n \t}\n \n+\tif (len \u003c 16 \u0026\u0026 !status \u0026\u0026 (flags \u0026 GET_SHA1_AUTOMATIC)) {\n+\t\tunsigned int expect_collision \u003d 1 \u003c\u003c (len * 2);\n+\t\tif (ds.nrobjects \u003e expect_collision) {\n+\t\t\tdefault_automatic_abbrev \u003d len+1;\n+\t\t\treturn SHORT_NAME_AMBIGUOUS;\n+\t\t}\n+\t}\n+\n \treturn status;\n }\n \n@@ -458,14 +479,19 @@ int for_each_abbrev(const char *prefix, each_abbrev_fn fn, void *cb_data)\n int find_unique_abbrev_r(char *hex, const unsigned char *sha1, int len)\n {\n \tint status, exists;\n+\tint flags \u003d GET_SHA1_QUIETLY;\n \n+\tif (len \u003c 0) {\n+\t\tflags |\u003d GET_SHA1_AUTOMATIC;\n+\t\tlen \u003d default_automatic_abbrev;\n+\t}\n \tsha1_to_hex_r(hex, sha1);\n \tif (len \u003d\u003d 40 || !len)\n \t\treturn 40;\n \texists \u003d has_sha1_file(sha1);\n \twhile (len \u003c 40) {\n \t\tunsigned char sha1_ret[20];\n-\t\tstatus \u003d get_short_sha1(hex, len, sha1_ret, GET_SHA1_QUIETLY);\n+\t\tstatus \u003d get_short_sha1(hex, len, sha1_ret, flags);\n \t\tif (exists\n \t\t    ? !status\n \t\t    : status \u003d\u003d SHORT_NAME_NOT_FOUND) {","expectedMessage":"abbrev: auto size the default abbreviation","repository":"git-linus","commitHash":"e6c587c733b4634030b353f4024794b08bc86892","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-b624a3e6","diff":" gpg-interface.c | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\ndiff --git a/gpg-interface.c b/gpg-interface.c\nindex 3dc2fe397e..f6d9d87270 100644\n--- a/gpg-interface.c\n+++ b/gpg-interface.c\n@@ -210,7 +210,7 @@ int verify_signed_buffer(const char *payload, size_t payload_size,\n \t\t\t struct strbuf *gpg_output, struct strbuf *gpg_status)\n {\n \tstruct child_process gpg \u003d CHILD_PROCESS_INIT;\n-\tconst char *args_gpg[] \u003d {NULL, \"--status-fd\u003d1\", \"--verify\", \"FILE\", \"-\", NULL};\n+\tconst char *args_gpg[] \u003d {NULL, \"--status-fd\u003d1\", \"--keyid-format\u003dlong\", \"--verify\", \"FILE\", \"-\", NULL};\n \tchar path[PATH_MAX];\n \tint fd, ret;\n \tstruct strbuf buf \u003d STRBUF_INIT;\n@@ -231,7 +231,7 @@ int verify_signed_buffer(const char *payload, size_t payload_size,\n \tgpg.out \u003d -1;\n \tif (gpg_output)\n \t\tgpg.err \u003d -1;\n-\targs_gpg[3] \u003d path;\n+\targs_gpg[4] \u003d path;\n \tif (start_command(\u0026gpg)) {\n \t\tunlink(path);\n \t\treturn error(_(\"could not run gpg.\"));","expectedMessage":"gpg-interface: prefer \"long\" key format output when verifying pgp signatures","repository":"git-linus","commitHash":"b624a3e67f498cb41f704c9bd28e7d53076611c8","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-7cc13c71","diff":" Documentation/pretty-options.txt |  5 +++\n commit.h                         |  1 +\n log-tree.c                       |  1 +\n pretty.c                         | 71 ++++++++++++++++++++++++++++++++++++++--\n revision.c                       |  2 ++\n revision.h                       |  1 +\n 6 files changed, 79 insertions(+), 2 deletions(-)\n\ndiff --git a/Documentation/pretty-options.txt b/Documentation/pretty-options.txt\nindex 4b659ac1a6..d820653784 100644\n--- a/Documentation/pretty-options.txt\n+++ b/Documentation/pretty-options.txt\n@@ -42,6 +42,11 @@ people using 80-column terminals.\n \tverbatim; this means that invalid sequences in the original\n \tcommit may be copied to the output.\n \n+--expand-tabs::\n+\tPerform a tab expansion (replace each tab with enough spaces\n+\tto fill to the next display column that is multiple of 8)\n+\tin the log message before showing it in the output.\n+\n ifndef::git-rev-list[]\n --notes[\u003d\u003cref\u003e]::\n \tShow the notes (see linkgit:git-notes[1]) that annotate the\ndiff --git a/commit.h b/commit.h\nindex 5d58be0017..a7ef682b5a 100644\n--- a/commit.h\n+++ b/commit.h\n@@ -147,6 +147,7 @@ struct pretty_print_context {\n \tint preserve_subject;\n \tstruct date_mode date_mode;\n \tunsigned date_mode_explicit:1;\n+\tunsigned expand_tabs_in_log:1;\n \tint need_8bit_cte;\n \tchar *notes_message;\n \tstruct reflog_walk_info *reflog_info;\ndiff --git a/log-tree.c b/log-tree.c\nindex 60f983934d..78a5381d0e 100644\n--- a/log-tree.c\n+++ b/log-tree.c\n@@ -683,6 +683,7 @@ void show_log(struct rev_info *opt)\n \tctx.fmt \u003d opt-\u003ecommit_format;\n \tctx.mailmap \u003d opt-\u003emailmap;\n \tctx.color \u003d opt-\u003ediffopt.use_color;\n+\tctx.expand_tabs_in_log \u003d opt-\u003eexpand_tabs_in_log;\n \tctx.output_encoding \u003d get_log_output_encoding();\n \tif (opt-\u003efrom_ident.mail_begin \u0026\u0026 opt-\u003efrom_ident.name_begin)\n \t\tctx.from_ident \u003d \u0026opt-\u003efrom_ident;\ndiff --git a/pretty.c b/pretty.c\nindex 92b2870a7e..c8b075d91b 100644\n--- a/pretty.c\n+++ b/pretty.c\n@@ -1629,6 +1629,72 @@ void pp_title_line(struct pretty_print_context *pp,\n \tstrbuf_release(\u0026title);\n }\n \n+static int pp_utf8_width(const char *start, const char *end)\n+{\n+\tint width \u003d 0;\n+\tsize_t remain \u003d end - start;\n+\n+\twhile (remain) {\n+\t\tint n \u003d utf8_width(\u0026start, \u0026remain);\n+\t\tif (n \u003c 0 || !start)\n+\t\t\treturn -1;\n+\t\twidth +\u003d n;\n+\t}\n+\treturn width;\n+}\n+\n+static void strbuf_add_tabexpand(struct strbuf *sb,\n+\t\t\t\t const char *line, int linelen)\n+{\n+\tconst char *tab;\n+\n+\twhile ((tab \u003d memchr(line, \u0027\\t\u0027, linelen)) !\u003d NULL) {\n+\t\tint width \u003d pp_utf8_width(line, tab);\n+\n+\t\t/*\n+\t\t * If it wasn\u0027t well-formed utf8, or it\n+\t\t * had characters with badly defined\n+\t\t * width (control characters etc), just\n+\t\t * give up on trying to align things.\n+\t\t */\n+\t\tif (width \u003c 0)\n+\t\t\tbreak;\n+\n+\t\t/* Output the data .. */\n+\t\tstrbuf_add(sb, line, tab - line);\n+\n+\t\t/* .. and the de-tabified tab */\n+\t\tstrbuf_addchars(sb, \u0027 \u0027, 8 - (width % 8));\n+\n+\t\t/* Skip over the printed part .. */\n+\t\tlinelen -\u003d tab + 1 - line;\n+\t\tline \u003d tab + 1;\n+\t}\n+\n+\t/*\n+\t * Print out everything after the last tab without\n+\t * worrying about width - there\u0027s nothing more to\n+\t * align.\n+\t */\n+\tstrbuf_add(sb, line, linelen);\n+}\n+\n+/*\n+ * pp_handle_indent() prints out the intendation, and\n+ * the whole line (without the final newline), after\n+ * de-tabifying.\n+ */\n+static void pp_handle_indent(struct pretty_print_context *pp,\n+\t\t\t     struct strbuf *sb, int indent,\n+\t\t\t     const char *line, int linelen)\n+{\n+\tstrbuf_addchars(sb, \u0027 \u0027, indent);\n+\tif (pp-\u003eexpand_tabs_in_log)\n+\t\tstrbuf_add_tabexpand(sb, line, linelen);\n+\telse\n+\t\tstrbuf_add(sb, line, linelen);\n+}\n+\n void pp_remainder(struct pretty_print_context *pp,\n \t\t  const char **msg_p,\n \t\t  struct strbuf *sb,\n@@ -1653,8 +1719,9 @@ void pp_remainder(struct pretty_print_context *pp,\n \n \t\tstrbuf_grow(sb, linelen + indent + 20);\n \t\tif (indent)\n-\t\t\tstrbuf_addchars(sb, \u0027 \u0027, indent);\n-\t\tstrbuf_add(sb, line, linelen);\n+\t\t\tpp_handle_indent(pp, sb, indent, line, linelen);\n+\t\telse\n+\t\t\tstrbuf_add(sb, line, linelen);\n \t\tstrbuf_addch(sb, \u0027\\n\u0027);\n \t}\n }\ndiff --git a/revision.c b/revision.c\nindex df56fcea0e..e662230ff1 100644\n--- a/revision.c\n+++ b/revision.c\n@@ -1915,6 +1915,8 @@ static int handle_revision_opt(struct rev_info *revs, int argc, const char **arg\n \t\trevs-\u003everbose_header \u003d 1;\n \t\trevs-\u003epretty_given \u003d 1;\n \t\tget_commit_format(arg+9, revs);\n+\t} else if (!strcmp(arg, \"--expand-tabs\")) {\n+\t\trevs-\u003eexpand_tabs_in_log \u003d 1;\n \t} else if (!strcmp(arg, \"--show-notes\") || !strcmp(arg, \"--notes\")) {\n \t\trevs-\u003eshow_notes \u003d 1;\n \t\trevs-\u003eshow_notes_given \u003d 1;\ndiff --git a/revision.h b/revision.h\nindex 23857c0ed1..40797535fa 100644\n--- a/revision.h\n+++ b/revision.h\n@@ -133,6 +133,7 @@ struct rev_info {\n \t\t\tshow_notes_given:1,\n \t\t\tshow_signature:1,\n \t\t\tpretty_given:1,\n+\t\t\texpand_tabs_in_log:1,\n \t\t\tabbrev_commit:1,\n \t\t\tabbrev_commit_given:1,\n \t\t\tzero_commit:1,","expectedMessage":"pretty: expand tabs in indented logs to make things line up properly","repository":"git-linus","commitHash":"7cc13c717b52d3539e76f087d747f96d0d24a914","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-15715866","diff":" builtin/log.c | 2 ++\n 1 file changed, 2 insertions(+)\n\ndiff --git a/builtin/log.c b/builtin/log.c\nindex 39e8836352..df6396c9c3 100644\n--- a/builtin/log.c\n+++ b/builtin/log.c\n@@ -63,6 +63,8 @@ static int parse_decoration_style(const char *var, const char *value)\n \t\treturn DECORATE_FULL_REFS;\n \telse if (!strcmp(value, \"short\"))\n \t\treturn DECORATE_SHORT_REFS;\n+\telse if (!strcmp(value, \"auto\"))\n+\t\treturn (isatty(1) || pager_in_use()) ? DECORATE_SHORT_REFS : 0;\n \treturn -1;\n }\n ","expectedMessage":"git log: support \"auto\" decorations","repository":"git-linus","commitHash":"1571586648da4e2d759bce1146d5585c91aca8d6","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-dc2eacc5","diff":" git-request-pull.sh | 50 +++++++++++++++++++++++++++++---------------------\n 1 file changed, 29 insertions(+), 21 deletions(-)\n\ndiff --git a/git-request-pull.sh b/git-request-pull.sh\nindex 659a412155..c8ab0e9120 100755\n--- a/git-request-pull.sh\n+++ b/git-request-pull.sh\n@@ -47,19 +47,23 @@ fi\n \n #\n # $3 must be a symbolic ref, a unique ref, or\n-# a SHA object expression\n+# a SHA object expression. It can also be of\n+# the format \u0027local-name:remote-name\u0027.\n #\n-head\u003d$(git symbolic-ref -q \"${3-HEAD}\")\n-head\u003d${head:-$(git show-ref \"${3-HEAD}\" | cut -d\u0027 \u0027 -f2)}\n-head\u003d${head:-$(git rev-parse --quiet --verify \"$3\")}\n+local\u003d${3%:*}\n+local\u003d${local:-HEAD}\n+remote\u003d${3#*:}\n+head\u003d$(git symbolic-ref -q \"$local\")\n+head\u003d${head:-$(git show-ref --heads --tags \"$local\" | cut -d\u0027 \u0027 -f2)}\n+head\u003d${head:-$(git rev-parse --quiet --verify \"$local\")}\n \n # None of the above? Bad.\n-test -z \"$head\" \u0026\u0026 die \"fatal: Not a valid revision: $3\"\n+test -z \"$head\" \u0026\u0026 die \"fatal: Not a valid revision: $local\"\n \n # This also verifies that the resulting head is unique:\n # \"git show-ref\" could have shown multiple matching refs..\n headrev\u003d$(git rev-parse --verify --quiet \"$head\"^0)\n-test -z \"$headrev\" \u0026\u0026 die \"fatal: Ambiguous revision: $3\"\n+test -z \"$headrev\" \u0026\u0026 die \"fatal: Ambiguous revision: $local\"\n \n # Was it a branch with a description?\n branch_name\u003d${head#refs/heads/}\n@@ -69,9 +73,6 @@ then\n \tbranch_name\u003d\n fi\n \n-prettyhead\u003d${head#refs/}\n-prettyhead\u003d${prettyhead#heads/}\n-\n merge_base\u003d$(git merge-base $baserev $headrev) ||\n die \"fatal: No commits in common between $base and $head\"\n \n@@ -81,30 +82,37 @@ die \"fatal: No commits in common between $base and $head\"\n #\n # Otherwise find a random ref that matches $headrev.\n find_matching_ref\u003d\u0027\n-\tmy ($exact,$found);\n+\tmy ($head,$headrev) \u003d (@ARGV);\n+\tmy ($found);\n+\n \twhile (\u003cSTDIN\u003e) {\n+\t\tchomp;\n \t\tmy ($sha1, $ref, $deref) \u003d /^(\\S+)\\s+([^^]+)(\\S*)$/;\n-\t\tnext unless ($sha1 eq $ARGV[1]);\n-\t\tif ($ref eq $ARGV[0]) {\n-\t\t\t$exact \u003d $ref;\n+\t\tmy ($pattern);\n+\t\tnext unless ($sha1 eq $headrev);\n+\n+\t\t$pattern\u003d\"/$head\\$\";\n+\t\tif ($ref eq $head) {\n+\t\t\t$found \u003d $ref;\n+\t\t}\n+\t\tif ($ref \u003d~ /$pattern/) {\n+\t\t\t$found \u003d $ref;\n \t\t}\n-\t\tif ($sha1 eq $ARGV[0]) {\n+\t\tif ($sha1 eq $head) {\n \t\t\t$found \u003d $sha1;\n \t\t}\n \t}\n-\tif ($exact) {\n-\t\tprint \"$exact\\n\";\n-\t} elsif ($found) {\n+\tif ($found) {\n \t\tprint \"$found\\n\";\n \t}\n \u0027\n \n-ref\u003d$(git ls-remote \"$url\" | @@PERL@@ -e \"$find_matching_ref\" \"$head\" \"$headrev\")\n+ref\u003d$(git ls-remote \"$url\" | @@PERL@@ -e \"$find_matching_ref\" \"${remote:-HEAD}\" \"$headrev\")\n \n if test -z \"$ref\"\n then\n-\techo \"warn: No match for $prettyhead found at $url\" \u003e\u00262\n-\techo \"warn: Are you sure you pushed \u0027$prettyhead\u0027 there?\" \u003e\u00262\n+\techo \"warn: No match for commit $headrev found at $url\" \u003e\u00262\n+\techo \"warn: Are you sure you pushed \u0027${remote:-HEAD}\u0027 there?\" \u003e\u00262\n \tstatus\u003d1\n fi\n \n@@ -116,7 +124,7 @@ git show -s --format\u003d\u0027The following changes since commit %H:\n \n are available in the git repository at:\n \u0027 $merge_base \u0026\u0026\n-echo \"  $url $prettyhead\" \u0026\u0026\n+echo \"  $url $remote\" \u0026\u0026\n git show -s --format\u003d\u0027\n for you to fetch changes up to %H:\n ","expectedMessage":"request-pull: allow \"local:remote\" to specify names on both ends","repository":"git-linus","commitHash":"dc2eacc58c1118ad68b9d6973033a60b6ed9be1f","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-024d34cb","diff":" git-request-pull.sh | 110 ++++++++++++++++++++--------------------------------\n 1 file changed, 43 insertions(+), 67 deletions(-)\n\ndiff --git a/git-request-pull.sh b/git-request-pull.sh\nindex fe21d5db63..659a412155 100755\n--- a/git-request-pull.sh\n+++ b/git-request-pull.sh\n@@ -35,20 +35,7 @@ do\n \tshift\n done\n \n-base\u003d$1 url\u003d$2 head\u003d${3-HEAD} status\u003d0 branch_name\u003d\n-\n-headref\u003d$(git symbolic-ref -q \"$head\")\n-if git show-ref -q --verify \"$headref\"\n-then\n-\tbranch_name\u003d${headref#refs/heads/}\n-\tif test \"z$branch_name\" \u003d \"z$headref\" ||\n-\t\t! git config \"branch.$branch_name.description\" \u003e/dev/null\n-\tthen\n-\t\tbranch_name\u003d\n-\tfi\n-fi\n-\n-tag_name\u003d$(git describe --exact \"$head^0\" 2\u003e/dev/null)\n+base\u003d$1 url\u003d$2 status\u003d0\n \n test -n \"$base\" \u0026\u0026 test -n \"$url\" || usage\n \n@@ -58,55 +45,68 @@ then\n     die \"fatal: Not a valid revision: $base\"\n fi\n \n+#\n+# $3 must be a symbolic ref, a unique ref, or\n+# a SHA object expression\n+#\n+head\u003d$(git symbolic-ref -q \"${3-HEAD}\")\n+head\u003d${head:-$(git show-ref \"${3-HEAD}\" | cut -d\u0027 \u0027 -f2)}\n+head\u003d${head:-$(git rev-parse --quiet --verify \"$3\")}\n+\n+# None of the above? Bad.\n+test -z \"$head\" \u0026\u0026 die \"fatal: Not a valid revision: $3\"\n+\n+# This also verifies that the resulting head is unique:\n+# \"git show-ref\" could have shown multiple matching refs..\n headrev\u003d$(git rev-parse --verify --quiet \"$head\"^0)\n-if test -z \"$headrev\"\n+test -z \"$headrev\" \u0026\u0026 die \"fatal: Ambiguous revision: $3\"\n+\n+# Was it a branch with a description?\n+branch_name\u003d${head#refs/heads/}\n+if test \"z$branch_name\" \u003d \"z$headref\" ||\n+\t! git config \"branch.$branch_name.description\" \u003e/dev/null\n then\n-    die \"fatal: Not a valid revision: $head\"\n+\tbranch_name\u003d\n fi\n \n+prettyhead\u003d${head#refs/}\n+prettyhead\u003d${prettyhead#heads/}\n+\n merge_base\u003d$(git merge-base $baserev $headrev) ||\n die \"fatal: No commits in common between $base and $head\"\n \n-# $head is the token given from the command line, and $tag_name, if\n-# exists, is the tag we are going to show the commit information for.\n-# If that tag exists at the remote and it points at the commit, use it.\n-# Otherwise, if a branch with the same name as $head exists at the remote\n-# and their values match, use that instead.\n+# $head is the refname from the command line.\n+# If a ref with the same name as $head exists at the remote\n+# and their values match, use that.\n #\n # Otherwise find a random ref that matches $headrev.\n find_matching_ref\u003d\u0027\n-\tsub abbr {\n-\t\tmy $ref \u003d shift;\n-\t\tif ($ref \u003d~ s|^refs/heads/|| || $ref \u003d~ s|^refs/tags/|tags/|) {\n-\t\t\treturn $ref;\n-\t\t} else {\n-\t\t\treturn $ref;\n-\t\t}\n-\t}\n-\n-\tmy ($tagged, $branch, $found);\n+\tmy ($exact,$found);\n \twhile (\u003cSTDIN\u003e) {\n-\t\tmy ($sha1, $ref, $deref) \u003d /^(\\S+)\\s+(\\S+?)(\\^\\{\\})?$/;\n+\t\tmy ($sha1, $ref, $deref) \u003d /^(\\S+)\\s+([^^]+)(\\S*)$/;\n \t\tnext unless ($sha1 eq $ARGV[1]);\n-\t\t$found \u003d abbr($ref);\n-\t\tif ($deref \u0026\u0026 $ref eq \"tags/$ARGV[2]\") {\n-\t\t\t$tagged \u003d $found;\n-\t\t\tlast;\n+\t\tif ($ref eq $ARGV[0]) {\n+\t\t\t$exact \u003d $ref;\n \t\t}\n-\t\tif ($ref \u003d~ m|/\\Q$ARGV[0]\\E$|) {\n-\t\t\t$exact \u003d $found;\n+\t\tif ($sha1 eq $ARGV[0]) {\n+\t\t\t$found \u003d $sha1;\n \t\t}\n \t}\n-\tif ($tagged) {\n-\t\tprint \"$tagged\\n\";\n-\t} elsif ($exact) {\n+\tif ($exact) {\n \t\tprint \"$exact\\n\";\n \t} elsif ($found) {\n \t\tprint \"$found\\n\";\n \t}\n \u0027\n \n-ref\u003d$(git ls-remote \"$url\" | @@PERL@@ -e \"$find_matching_ref\" \"$head\" \"$headrev\" \"$tag_name\")\n+ref\u003d$(git ls-remote \"$url\" | @@PERL@@ -e \"$find_matching_ref\" \"$head\" \"$headrev\")\n+\n+if test -z \"$ref\"\n+then\n+\techo \"warn: No match for $prettyhead found at $url\" \u003e\u00262\n+\techo \"warn: Are you sure you pushed \u0027$prettyhead\u0027 there?\" \u003e\u00262\n+\tstatus\u003d1\n+fi\n \n url\u003d$(git ls-remote --get-url \"$url\")\n \n@@ -116,7 +116,7 @@ git show -s --format\u003d\u0027The following changes since commit %H:\n \n are available in the git repository at:\n \u0027 $merge_base \u0026\u0026\n-echo \"  $url${ref+ $ref}\" \u0026\u0026\n+echo \"  $url $prettyhead\" \u0026\u0026\n git show -s --format\u003d\u0027\n for you to fetch changes up to %H:\n \n@@ -129,34 +129,10 @@ then\n \techo \"(from the branch description for $branch_name local branch)\"\n \techo\n \tgit config \"branch.$branch_name.description\"\n-fi \u0026\u0026\n-\n-if test -n \"$tag_name\"\n-then\n-\tif test -z \"$ref\" || test \"$ref\" !\u003d \"tags/$tag_name\"\n-\tthen\n-\t\techo \u003e\u00262 \"warn: You locally have $tag_name but it does not (yet)\"\n-\t\techo \u003e\u00262 \"warn: appear to be at $url\"\n-\t\techo \u003e\u00262 \"warn: Do you want to push it there, perhaps?\"\n-\tfi\n-\tgit cat-file tag \"$tag_name\" |\n-\tsed -n -e \u00271,/^$/d\u0027 -e \u0027/^-----BEGIN PGP /q\u0027 -e p\n-\techo\n-fi \u0026\u0026\n-\n-if test -n \"$branch_name\" || test -n \"$tag_name\"\n-then\n \techo \"----------------------------------------------------------------\"\n fi \u0026\u0026\n \n git shortlog ^$baserev $headrev \u0026\u0026\n git diff -M --stat --summary $patch $merge_base..$headrev || status\u003d1\n \n-if test -z \"$ref\"\n-then\n-\techo \"warn: No branch of $url is at:\" \u003e\u00262\n-\tgit show -s --format\u003d\u0027warn:   %h: %s\u0027 $headrev \u003e\u00262\n-\techo \"warn: Are you sure you pushed \u0027$head\u0027 there?\" \u003e\u00262\n-\tstatus\u003d1\n-fi\n exit $status","expectedMessage":"request-pull: more strictly match local/remote branches","repository":"git-linus","commitHash":"024d34cb0813e098c5c0e4ccdacb6a461d34cb6b","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-74faaa16","diff":" diff.c                        | 25 +++++++++++++----------\n t/t4006-diff-mode.sh          | 46 +++++++++++++++++++++----------------------\n t/t4049-diff-stat-count.sh    |  3 ++-\n t/t4205-log-pretty-formats.sh |  4 ++--\n 4 files changed, 42 insertions(+), 36 deletions(-)\n\ndiff --git a/diff.c b/diff.c\nindex 35d3f07385..95bbad66c6 100644\n--- a/diff.c\n+++ b/diff.c\n@@ -1300,6 +1300,7 @@ struct diffstat_t {\n \t\tunsigned is_unmerged:1;\n \t\tunsigned is_binary:1;\n \t\tunsigned is_renamed:1;\n+\t\tunsigned is_interesting:1;\n \t\tuintmax_t added, deleted;\n \t} **files;\n };\n@@ -1469,7 +1470,7 @@ static void show_stats(struct diffstat_t *data, struct diff_options *options)\n \tfor (i \u003d 0; (i \u003c count) \u0026\u0026 (i \u003c data-\u003enr); i++) {\n \t\tstruct diffstat_file *file \u003d data-\u003efiles[i];\n \t\tuintmax_t change \u003d file-\u003eadded + file-\u003edeleted;\n-\t\tif (!data-\u003efiles[i]-\u003eis_renamed \u0026\u0026\n+\t\tif (!data-\u003efiles[i]-\u003eis_interesting \u0026\u0026\n \t\t\t (change \u003d\u003d 0)) {\n \t\t\tcount++; /* not shown \u003d\u003d room for one more */\n \t\t\tcontinue;\n@@ -1590,7 +1591,7 @@ static void show_stats(struct diffstat_t *data, struct diff_options *options)\n \t\tuintmax_t deleted \u003d data-\u003efiles[i]-\u003edeleted;\n \t\tint name_len;\n \n-\t\tif (!data-\u003efiles[i]-\u003eis_renamed \u0026\u0026\n+\t\tif (!data-\u003efiles[i]-\u003eis_interesting \u0026\u0026\n \t\t\t (added + deleted \u003d\u003d 0)) {\n \t\t\ttotal_files--;\n \t\t\tcontinue;\n@@ -1669,7 +1670,7 @@ static void show_stats(struct diffstat_t *data, struct diff_options *options)\n \tfor (i \u003d count; i \u003c data-\u003enr; i++) {\n \t\tuintmax_t added \u003d data-\u003efiles[i]-\u003eadded;\n \t\tuintmax_t deleted \u003d data-\u003efiles[i]-\u003edeleted;\n-\t\tif (!data-\u003efiles[i]-\u003eis_renamed \u0026\u0026\n+\t\tif (!data-\u003efiles[i]-\u003eis_interesting \u0026\u0026\n \t\t\t (added + deleted \u003d\u003d 0)) {\n \t\t\ttotal_files--;\n \t\t\tcontinue;\n@@ -1697,7 +1698,7 @@ static void show_shortstats(struct diffstat_t *data, struct diff_options *option\n \n \t\tif (data-\u003efiles[i]-\u003eis_unmerged)\n \t\t\tcontinue;\n-\t\tif (!data-\u003efiles[i]-\u003eis_renamed \u0026\u0026 (added + deleted \u003d\u003d 0)) {\n+\t\tif (!data-\u003efiles[i]-\u003eis_interesting \u0026\u0026 (added + deleted \u003d\u003d 0)) {\n \t\t\ttotal_files--;\n \t\t} else if (!data-\u003efiles[i]-\u003eis_binary) { /* don\u0027t count bytes */\n \t\t\tadds +\u003d added;\n@@ -2397,13 +2398,20 @@ static void builtin_diffstat(const char *name_a, const char *name_b,\n \t\t\t     struct diff_filespec *two,\n \t\t\t     struct diffstat_t *diffstat,\n \t\t\t     struct diff_options *o,\n-\t\t\t     int complete_rewrite)\n+\t\t\t     struct diff_filepair *p)\n {\n \tmmfile_t mf1, mf2;\n \tstruct diffstat_file *data;\n \tint same_contents;\n+\tint complete_rewrite \u003d 0;\n+\n+\tif (!DIFF_PAIR_UNMERGED(p)) {\n+\t\tif (p-\u003estatus \u003d\u003d DIFF_STATUS_MODIFIED \u0026\u0026 p-\u003escore)\n+\t\t\tcomplete_rewrite \u003d 1;\n+\t}\n \n \tdata \u003d diffstat_add(diffstat, name_a, name_b);\n+\tdata-\u003eis_interesting \u003d p-\u003estatus !\u003d 0;\n \n \tif (!one || !two) {\n \t\tdata-\u003eis_unmerged \u003d 1;\n@@ -3114,11 +3122,10 @@ static void run_diffstat(struct diff_filepair *p, struct diff_options *o,\n {\n \tconst char *name;\n \tconst char *other;\n-\tint complete_rewrite \u003d 0;\n \n \tif (DIFF_PAIR_UNMERGED(p)) {\n \t\t/* unmerged */\n-\t\tbuiltin_diffstat(p-\u003eone-\u003epath, NULL, NULL, NULL, diffstat, o, 0);\n+\t\tbuiltin_diffstat(p-\u003eone-\u003epath, NULL, NULL, NULL, diffstat, o, p);\n \t\treturn;\n \t}\n \n@@ -3131,9 +3138,7 @@ static void run_diffstat(struct diff_filepair *p, struct diff_options *o,\n \tdiff_fill_sha1_info(p-\u003eone);\n \tdiff_fill_sha1_info(p-\u003etwo);\n \n-\tif (p-\u003estatus \u003d\u003d DIFF_STATUS_MODIFIED \u0026\u0026 p-\u003escore)\n-\t\tcomplete_rewrite \u003d 1;\n-\tbuiltin_diffstat(name, other, p-\u003eone, p-\u003etwo, diffstat, o, complete_rewrite);\n+\tbuiltin_diffstat(name, other, p-\u003eone, p-\u003etwo, diffstat, o, p);\n }\n \n static void run_checkdiff(struct diff_filepair *p, struct diff_options *o)\ndiff --git a/t/t4006-diff-mode.sh b/t/t4006-diff-mode.sh\nindex 3d4b1ba23f..05911492ca 100755\n--- a/t/t4006-diff-mode.sh\n+++ b/t/t4006-diff-mode.sh\n@@ -32,28 +32,28 @@ test_expect_success \u0027prepare binary file\u0027 \u0027\n \tgit commit -m binbin\n \u0027\n \n-test_expect_success \u0027--stat output after text chmod\u0027 \u0027\n-\ttest_chmod -x rezrov \u0026\u0026\n-\techo \" 0 files changed\" \u003eexpect \u0026\u0026\n-\tgit diff HEAD --stat \u003eactual \u0026\u0026\n-\ttest_i18ncmp expect actual\n-\u0027\n-\n-test_expect_success \u0027--shortstat output after text chmod\u0027 \u0027\n-\tgit diff HEAD --shortstat \u003eactual \u0026\u0026\n-\ttest_i18ncmp expect actual\n-\u0027\n-\n-test_expect_success \u0027--stat output after binary chmod\u0027 \u0027\n-\ttest_chmod +x binbin \u0026\u0026\n-\techo \" 0 files changed\" \u003eexpect \u0026\u0026\n-\tgit diff HEAD --stat \u003eactual \u0026\u0026\n-\ttest_i18ncmp expect actual\n-\u0027\n-\n-test_expect_success \u0027--shortstat output after binary chmod\u0027 \u0027\n-\tgit diff HEAD --shortstat \u003eactual \u0026\u0026\n-\ttest_i18ncmp expect actual\n-\u0027\n+# test_expect_success \u0027--stat output after text chmod\u0027 \u0027\n+# \ttest_chmod -x rezrov \u0026\u0026\n+# \techo \" 0 files changed\" \u003eexpect \u0026\u0026\n+# \tgit diff HEAD --stat \u003eactual \u0026\u0026\n+#\ttest_i18ncmp expect actual\n+# \u0027\n+#\n+# test_expect_success \u0027--shortstat output after text chmod\u0027 \u0027\n+# \tgit diff HEAD --shortstat \u003eactual \u0026\u0026\n+# \ttest_i18ncmp expect actual\n+# \u0027\n+#\n+# test_expect_success \u0027--stat output after binary chmod\u0027 \u0027\n+# \ttest_chmod +x binbin \u0026\u0026\n+# \techo \" 0 files changed\" \u003eexpect \u0026\u0026\n+# \tgit diff HEAD --stat \u003eactual \u0026\u0026\n+# \ttest_i18ncmp expect actual\n+# \u0027\n+#\n+# test_expect_success \u0027--shortstat output after binary chmod\u0027 \u0027\n+# \tgit diff HEAD --shortstat \u003eactual \u0026\u0026\n+# \ttest_i18ncmp expect actual\n+# \u0027\n \n test_done\ndiff --git a/t/t4049-diff-stat-count.sh b/t/t4049-diff-stat-count.sh\nindex b41eb61ca8..7b3ef00533 100755\n--- a/t/t4049-diff-stat-count.sh\n+++ b/t/t4049-diff-stat-count.sh\n@@ -16,7 +16,8 @@ test_expect_success setup \u0027\n \tcat \u003eexpect \u003c\u003c-\\EOF\n \t a | 1 +\n \t b | 1 +\n-\t 2 files changed, 2 insertions(+)\n+\t ...\n+\t 4 files changed, 2 insertions(+)\n \tEOF\n \tgit diff --stat --stat-count\u003d2 \u003eactual \u0026\u0026\n \ttest_i18ncmp expect actual\ndiff --git a/t/t4205-log-pretty-formats.sh b/t/t4205-log-pretty-formats.sh\nindex 2c45de7aea..98a43d457a 100755\n--- a/t/t4205-log-pretty-formats.sh\n+++ b/t/t4205-log-pretty-formats.sh\n@@ -85,7 +85,7 @@ test_expect_success \u0027NUL termination\u0027 \u0027\n \n test_expect_success \u0027NUL separation with --stat\u0027 \u0027\n \tstat0_part\u003d$(git diff --stat HEAD^ HEAD) \u0026\u0026\n-\tstat1_part\u003d$(git diff --stat --root HEAD^) \u0026\u0026\n+\tstat1_part\u003d$(git diff-tree --no-commit-id --stat --root HEAD^) \u0026\u0026\n \tprintf \"add bar\\n$stat0_part\\n\\0initial\\n$stat1_part\\n\" \u003eexpected \u0026\u0026\n \tgit log -z --stat --pretty\u003d\"format:%s\" \u003eactual \u0026\u0026\n \ttest_i18ncmp expected actual\n@@ -93,7 +93,7 @@ test_expect_success \u0027NUL separation with --stat\u0027 \u0027\n \n test_expect_failure \u0027NUL termination with --stat\u0027 \u0027\n \tstat0_part\u003d$(git diff --stat HEAD^ HEAD) \u0026\u0026\n-\tstat1_part\u003d$(git diff --stat --root HEAD^) \u0026\u0026\n+\tstat1_part\u003d$(git diff-tree --no-commit-id --stat --root HEAD^) \u0026\u0026\n \tprintf \"add bar\\n$stat0_part\\n\\0initial\\n$stat1_part\\n\\0\" \u003eexpected \u0026\u0026\n \tgit log -z --stat --pretty\u003d\"tformat:%s\" \u003eactual \u0026\u0026\n \ttest_i18ncmp expected actual","expectedMessage":"Fix \"git diff --stat\" for interesting - but empty - file changes","repository":"git-linus","commitHash":"74faaa16f016af9fc429770ba701f2aa598d9f21","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-9d55b2e1","diff":" builtin/mailinfo.c | 11 -----------\n 1 file changed, 11 deletions(-)\n\ndiff --git a/builtin/mailinfo.c b/builtin/mailinfo.c\nindex bfb32b7233..2405040ad3 100644\n--- a/builtin/mailinfo.c\n+++ b/builtin/mailinfo.c\n@@ -19,9 +19,6 @@ static struct strbuf email \u003d STRBUF_INIT;\n static enum  {\n \tTE_DONTCARE, TE_QP, TE_BASE64\n } transfer_encoding;\n-static enum  {\n-\tTYPE_TEXT, TYPE_OTHER\n-} message_type;\n \n static struct strbuf charset \u003d STRBUF_INIT;\n static int patch_lines;\n@@ -185,8 +182,6 @@ static void handle_content_type(struct strbuf *line)\n \tstruct strbuf *boundary \u003d xmalloc(sizeof(struct strbuf));\n \tstrbuf_init(boundary, line-\u003elen);\n \n-\tif (!strcasestr(line-\u003ebuf, \"text/\"))\n-\t\t message_type \u003d TYPE_OTHER;\n \tif (slurp_attr(line-\u003ebuf, \"boundary\u003d\", boundary)) {\n \t\tstrbuf_insert(boundary, 0, \"--\", 2);\n \t\tif (++content_top \u003e \u0026content[MAX_BOUNDARIES]) {\n@@ -671,7 +666,6 @@ static int handle_boundary(void)\n \t/* set some defaults */\n \ttransfer_encoding \u003d TE_DONTCARE;\n \tstrbuf_reset(\u0026charset);\n-\tmessage_type \u003d TYPE_TEXT;\n \n \t/* slurp in this section\u0027s info */\n \twhile (read_one_header_line(\u0026line, fin))\n@@ -885,11 +879,6 @@ static void handle_body(void)\n \t\t\tstrbuf_insert(\u0026line, 0, prev.buf, prev.len);\n \t\t\tstrbuf_reset(\u0026prev);\n \n-\t\t\t/* binary data most likely doesn\u0027t have newlines */\n-\t\t\tif (message_type !\u003d TYPE_TEXT) {\n-\t\t\t\thandle_filter(\u0026line);\n-\t\t\t\tbreak;\n-\t\t\t}\n \t\t\t/*\n \t\t\t * This is a decoded line that may contain\n \t\t\t * multiple new lines.  Pass only one chunk","expectedMessage":"mailinfo: don\u0027t require \"text\" mime type for attachments","repository":"git-linus","commitHash":"9d55b2e12f82b344709b0f2981eaf142b0b1f7a8","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-08a94a14","diff":" builtin/mailinfo.c | 28 ++---------------\n commit.c           | 88 ++++++++++++++++++++++++++++++++++++++++++++++++++++--\n 2 files changed, 88 insertions(+), 28 deletions(-)\n\ndiff --git a/builtin/mailinfo.c b/builtin/mailinfo.c\nindex eaf9e157a3..dd4f925475 100644\n--- a/builtin/mailinfo.c\n+++ b/builtin/mailinfo.c\n@@ -481,36 +481,12 @@ static struct strbuf *decode_b_segment(const struct strbuf *b_seg)\n \treturn out;\n }\n \n-/*\n- * When there is no known charset, guess.\n- *\n- * Right now we assume that if the target is UTF-8 (the default),\n- * and it already looks like UTF-8 (which includes US-ASCII as its\n- * subset, of course) then that is what it is and there is nothing\n- * to do.\n- *\n- * Otherwise, we default to assuming it is Latin1 for historical\n- * reasons.\n- */\n-static const char *guess_charset(const struct strbuf *line, const char *target_charset)\n-{\n-\tif (is_encoding_utf8(target_charset)) {\n-\t\tif (is_utf8(line-\u003ebuf))\n-\t\t\treturn NULL;\n-\t}\n-\treturn \"ISO8859-1\";\n-}\n-\n static void convert_to_utf8(struct strbuf *line, const char *charset)\n {\n \tchar *out;\n \n-\tif (!charset || !*charset) {\n-\t\tcharset \u003d guess_charset(line, metainfo_charset);\n-\t\tif (!charset)\n-\t\t\treturn;\n-\t}\n-\n+\tif (!charset || !*charset)\n+\t\treturn;\n \tif (!strcasecmp(metainfo_charset, charset))\n \t\treturn;\n \tout \u003d reencode_string(line-\u003ebuf, metainfo_charset, charset);\ndiff --git a/commit.c b/commit.c\nindex 8248a994a5..1360bbd2cb 100644\n--- a/commit.c\n+++ b/commit.c\n@@ -1112,8 +1112,92 @@ int commit_tree(const struct strbuf *msg, unsigned char *tree,\n \treturn result;\n }\n \n+static int find_invalid_utf8(const char *buf, int len)\n+{\n+\tint offset \u003d 0;\n+\n+\twhile (len) {\n+\t\tunsigned char c \u003d *buf++;\n+\t\tint bytes, bad_offset;\n+\n+\t\tlen--;\n+\t\toffset++;\n+\n+\t\t/* Simple US-ASCII? No worries. */\n+\t\tif (c \u003c 0x80)\n+\t\t\tcontinue;\n+\n+\t\tbad_offset \u003d offset-1;\n+\n+\t\t/*\n+\t\t * Count how many more high bits set: that\u0027s how\n+\t\t * many more bytes this sequence should have.\n+\t\t */\n+\t\tbytes \u003d 0;\n+\t\twhile (c \u0026 0x40) {\n+\t\t\tc \u003c\u003c\u003d 1;\n+\t\t\tbytes++;\n+\t\t}\n+\n+\t\t/* Must be between 1 and 5 more bytes */\n+\t\tif (bytes \u003c 1 || bytes \u003e 5)\n+\t\t\treturn bad_offset;\n+\n+\t\t/* Do we *have* that many bytes? */\n+\t\tif (len \u003c bytes)\n+\t\t\treturn bad_offset;\n+\n+\t\toffset +\u003d bytes;\n+\t\tlen -\u003d bytes;\n+\n+\t\t/* And verify that they are good continuation bytes */\n+\t\tdo {\n+\t\t\tif ((*buf++ \u0026 0xc0) !\u003d 0x80)\n+\t\t\t\treturn bad_offset;\n+\t\t} while (--bytes);\n+\n+\t\t/* We could/should check the value and length here too */\n+\t}\n+\treturn -1;\n+}\n+\n+/*\n+ * This verifies that the buffer is in proper utf8 format.\n+ *\n+ * If it isn\u0027t, it assumes any non-utf8 characters are Latin1,\n+ * and does the conversion.\n+ *\n+ * Fixme: we should probably also disallow overlong forms and\n+ * invalid characters. But we don\u0027t do that currently.\n+ */\n+static int verify_utf8(struct strbuf *buf)\n+{\n+\tint ok \u003d 1;\n+\tlong pos \u003d 0;\n+\n+\tfor (;;) {\n+\t\tint bad;\n+\t\tunsigned char c;\n+\t\tunsigned char replace[2];\n+\n+\t\tbad \u003d find_invalid_utf8(buf-\u003ebuf + pos, buf-\u003elen - pos);\n+\t\tif (bad \u003c 0)\n+\t\t\treturn ok;\n+\t\tpos +\u003d bad;\n+\t\tok \u003d 0;\n+\t\tc \u003d buf-\u003ebuf[pos];\n+\t\tstrbuf_remove(buf, pos, 1);\n+\n+\t\t/* We know \u0027c\u0027 must be in the range 128-255 */\n+\t\treplace[0] \u003d 0xc0 + (c \u003e\u003e 6);\n+\t\treplace[1] \u003d 0x80 + (c \u0026 0x3f);\n+\t\tstrbuf_insert(buf, pos, replace, 2);\n+\t\tpos +\u003d 2;\n+\t}\n+}\n+\n static const char commit_utf8_warn[] \u003d\n-\"Warning: commit message does not conform to UTF-8.\\n\"\n+\"Warning: commit message did not conform to UTF-8.\\n\"\n \"You may want to amend it after fixing the message, or set the config\\n\"\n \"variable i18n.commitencoding to the encoding your project uses.\\n\";\n \n@@ -1170,7 +1254,7 @@ int commit_tree_extended(const struct strbuf *msg, unsigned char *tree,\n \tstrbuf_addbuf(\u0026buffer, msg);\n \n \t/* And check the encoding */\n-\tif (encoding_is_utf8 \u0026\u0026 !is_utf8(buffer.buf))\n+\tif (encoding_is_utf8 \u0026\u0026 !verify_utf8(\u0026buffer))\n \t\tfprintf(stderr, commit_utf8_warn);\n \n \tif (sign_commit \u0026\u0026 do_sign_commit(\u0026buffer, sign_commit))","expectedMessage":"commit/commit-tree: correct latin1 to utf-8","repository":"git-linus","commitHash":"08a94a145c3231c0fa36469682591a3c45222271","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-a3347b98","diff":" builtin/fmt-merge-msg.c | 8 +++++---\n 1 file changed, 5 insertions(+), 3 deletions(-)\n\ndiff --git a/builtin/fmt-merge-msg.c b/builtin/fmt-merge-msg.c\nindex fc083e3c5c..fb1ebcbe68 100644\n--- a/builtin/fmt-merge-msg.c\n+++ b/builtin/fmt-merge-msg.c\n@@ -356,7 +356,10 @@ static void fmt_tag_signature(struct strbuf *tagbuf,\n \t\tstrbuf_add(tagbuf, tag_body, buf + len - tag_body);\n \t}\n \tstrbuf_complete_line(tagbuf);\n-\tstrbuf_add_lines(tagbuf, \"# \", sig-\u003ebuf, sig-\u003elen);\n+\tif (sig-\u003elen) {\n+\t\tstrbuf_addch(tagbuf, \u0027\\n\u0027);\n+\t\tstrbuf_add_lines(tagbuf, \"# \", sig-\u003ebuf, sig-\u003elen);\n+\t}\n }\n \n static void fmt_merge_msg_sigs(struct strbuf *out)\n@@ -521,8 +524,7 @@ int fmt_merge_msg(struct strbuf *in, struct strbuf *out,\n \t\trev.ignore_merges \u003d 1;\n \t\trev.limited \u003d 1;\n \n-\t\tif (suffixcmp(out-\u003ebuf, \"\\n\"))\n-\t\t\tstrbuf_addch(out, \u0027\\n\u0027);\n+\t\tstrbuf_complete_line(out);\n \n \t\tfor (i \u003d 0; i \u003c origins.nr; i++)\n \t\t\tshortlog(origins.items[i].string,","expectedMessage":"fmt-merge-message: add empty line between tag and signature verification","repository":"git-linus","commitHash":"a3347b988a338e95b7f3b11eda776ac0d7b84dd0","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-85808300","diff":" git-pull.sh | 8 ++++++--\n 1 file changed, 6 insertions(+), 2 deletions(-)\n\ndiff --git a/git-pull.sh b/git-pull.sh\nindex d8b64d7a67..434c139f07 100755\n--- a/git-pull.sh\n+++ b/git-pull.sh\n@@ -40,7 +40,7 @@ test -f \"$GIT_DIR/MERGE_HEAD\" \u0026\u0026 die_merge\n \n strategy_args\u003d diffstat\u003d no_commit\u003d squash\u003d no_ff\u003d ff_only\u003d\n log_arg\u003d verbosity\u003d progress\u003d recurse_submodules\u003d\n-merge_args\u003d\n+merge_args\u003d edit\u003d\n curr_branch\u003d$(git symbolic-ref -q HEAD)\n curr_branch_short\u003d\"${curr_branch#refs/heads/}\"\n rebase\u003d$(git config --bool branch.$curr_branch_short.rebase)\n@@ -70,6 +70,10 @@ do\n \t\tno_commit\u003d--no-commit ;;\n \t--c|--co|--com|--comm|--commi|--commit)\n \t\tno_commit\u003d--commit ;;\n+\t-e|--edit)\n+\t\tedit\u003d--edit ;;\n+\t--no-edit)\n+\t\tedit\u003d--no-edit ;;\n \t--sq|--squ|--squa|--squas|--squash)\n \t\tsquash\u003d--squash ;;\n \t--no-sq|--no-squ|--no-squa|--no-squas|--no-squash)\n@@ -278,7 +282,7 @@ true)\n \teval\u003d\"$eval --onto $merge_head ${oldremoteref:-$merge_head}\"\n \t;;\n *)\n-\teval\u003d\"git-merge $diffstat $no_commit $squash $no_ff $ff_only\"\n+\teval\u003d\"git-merge $diffstat $no_commit $edit $squash $no_ff $ff_only\"\n \teval\u003d\"$eval  $log_arg $strategy_args $merge_args $verbosity $progress\"\n \teval\u003d\"$eval \\\"\\$merge_name\\\" HEAD $merge_head\"\n \t;;","expectedMessage":"\"git pull\" doesn\u0027t know \"--edit\"","repository":"git-linus","commitHash":"8580830084c8917ac41d18e39dba276b237f598e","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-dce96489","diff":" Documentation/config.txt | 6 ++++++\n builtin/describe.c       | 6 +++++-\n cache.h                  | 5 +++--\n config.c                 | 8 ++++++++\n environment.c            | 1 +\n 5 files changed, 23 insertions(+), 3 deletions(-)\n\ndiff --git a/Documentation/config.txt b/Documentation/config.txt\nindex c5e183516a..30afde98ae 100644\n--- a/Documentation/config.txt\n+++ b/Documentation/config.txt\n@@ -567,6 +567,12 @@ core.sparseCheckout::\n \tEnable \"sparse checkout\" feature. See section \"Sparse checkout\" in\n \tlinkgit:git-read-tree[1] for more information.\n \n+core.abbrevLength::\n+\tSet the length object names are abbreviated to.  If unspecified,\n+\tmany commands abbreviate to 7 hexdigits, which may not be enough\n+\tfor abbreviated object names to stay unique for sufficiently long\n+\ttime.\n+\n add.ignore-errors::\n add.ignoreErrors::\n \tTells \u0027git add\u0027 to continue adding files when some files cannot be\ndiff --git a/builtin/describe.c b/builtin/describe.c\nindex 342129fdbd..95915960d4 100644\n--- a/builtin/describe.c\n+++ b/builtin/describe.c\n@@ -21,7 +21,7 @@ static int debug;\t/* Display lots of verbose info */\n static int all;\t/* Any valid ref can be used */\n static int tags;\t/* Allow lightweight tags */\n static int longformat;\n-static int abbrev \u003d DEFAULT_ABBREV;\n+static int abbrev \u003d -1; /* unspecified */\n static int max_candidates \u003d 10;\n static struct hash_table names;\n static int have_util;\n@@ -420,7 +420,11 @@ int cmd_describe(int argc, const char **argv, const char *prefix)\n \t\tOPT_END(),\n \t};\n \n+\tgit_config(git_default_config, NULL);\n \targc \u003d parse_options(argc, argv, prefix, options, describe_usage, 0);\n+\tif (abbrev \u003c 0)\n+\t\tabbrev \u003d DEFAULT_ABBREV;\n+\n \tif (max_candidates \u003c 0)\n \t\tmax_candidates \u003d 0;\n \telse if (max_candidates \u003e MAX_TAGS)\ndiff --git a/cache.h b/cache.h\nindex d83d68c859..8d73d88962 100644\n--- a/cache.h\n+++ b/cache.h\n@@ -540,6 +540,7 @@ extern int trust_executable_bit;\n extern int trust_ctime;\n extern int quote_path_fully;\n extern int has_symlinks;\n+extern int minimum_abbrev, default_abbrev;\n extern int ignore_case;\n extern int assume_unchanged;\n extern int prefer_symlink_refs;\n@@ -758,8 +759,8 @@ static inline unsigned int hexval(unsigned char c)\n }\n \n /* Convert to/from hex/sha1 representation */\n-#define MINIMUM_ABBREV 4\n-#define DEFAULT_ABBREV 7\n+#define MINIMUM_ABBREV minimum_abbrev\n+#define DEFAULT_ABBREV default_abbrev\n \n struct object_context {\n \tunsigned char tree[20];\ndiff --git a/config.c b/config.c\nindex 625e051876..e8a6e56795 100644\n--- a/config.c\n+++ b/config.c\n@@ -531,6 +531,14 @@ static int git_default_core_config(const char *var, const char *value)\n \t\treturn 0;\n \t}\n \n+\tif (!strcmp(var, \"core.abbrevlength\")) {\n+\t\tint abbrev \u003d git_config_int(var, value);\n+\t\tif (abbrev \u003c minimum_abbrev || abbrev \u003e 40)\n+\t\t\treturn -1;\n+\t\tdefault_abbrev \u003d abbrev;\n+\t\treturn 0;\n+\t}\n+\n \tif (!strcmp(var, \"core.loosecompression\")) {\n \t\tint level \u003d git_config_int(var, value);\n \t\tif (level \u003d\u003d -1)\ndiff --git a/environment.c b/environment.c\nindex 9564475f42..f2d90a807b 100644\n--- a/environment.c\n+++ b/environment.c\n@@ -15,6 +15,7 @@ int user_ident_explicitly_given;\n int trust_executable_bit \u003d 1;\n int trust_ctime \u003d 1;\n int has_symlinks \u003d 1;\n+int minimum_abbrev \u003d 4, default_abbrev \u003d 7;\n int ignore_case;\n int assume_unchanged;\n int prefer_symlink_refs;","expectedMessage":"Make the default abbrev length configurable","repository":"git-linus","commitHash":"dce96489162b05ae3463741f7f0365ff56f0de36","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-3a4d6769","diff":" diffcore-rename.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/diffcore-rename.c b/diffcore-rename.c\nindex b9b039d4a3..0cd4c1305b 100644\n--- a/diffcore-rename.c\n+++ b/diffcore-rename.c\n@@ -170,7 +170,7 @@ static int estimate_similarity(struct diff_filespec *src,\n \t * and the final score computation below would not have a\n \t * divide-by-zero issue.\n \t */\n-\tif (base_size * (MAX_SCORE-minimum_score) \u003c delta_size * MAX_SCORE)\n+\tif (max_size * (MAX_SCORE-minimum_score) \u003c delta_size * MAX_SCORE)\n \t\treturn 0;\n \n \tif (!src-\u003ecnt_data \u0026\u0026 diff_populate_filespec(src, 0))","expectedMessage":"diffcore-rename: improve estimate_similarity() heuristics","repository":"git-linus","commitHash":"3a4d67692b5a80213ca47a603fa5505a5990cc87","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-0940e5f2","diff":" diffcore-rename.c              | 53 +++++++++++++++++++++---------------------\n t/t4003-diff-rename-1.sh       |  2 +-\n t/t4004-diff-rename-symlink.sh |  2 +-\n t/t4005-diff-rename-2.sh       |  2 +-\n t/t4008-diff-break-rewrite.sh  |  4 ++--\n t/t4009-diff-rename-4.sh       |  2 +-\n 6 files changed, 32 insertions(+), 33 deletions(-)\n\ndiff --git a/diffcore-rename.c b/diffcore-rename.c\nindex e5e88feb54..b9b039d4a3 100644\n--- a/diffcore-rename.c\n+++ b/diffcore-rename.c\n@@ -278,6 +278,8 @@ static int find_identical_files(struct file_similarity *src,\n \t\t\t}\n \t\t\t/* Give higher scores to sources that haven\u0027t been used already */\n \t\t\tscore \u003d !source-\u003erename_used;\n+\t\t\tif (source-\u003erename_used \u0026\u0026 options-\u003edetect_rename !\u003d DIFF_DETECT_COPY)\n+\t\t\t\tcontinue;\n \t\t\tscore +\u003d basename_same(source, target);\n \t\t\tif (score \u003e best_score) {\n \t\t\t\tbest \u003d p;\n@@ -416,6 +418,27 @@ static void record_if_better(struct diff_score m[], struct diff_score *o)\n \t\tm[worst] \u003d *o;\n }\n \n+static int find_renames(struct diff_score *mx, int dst_cnt, int minimum_score, int copies)\n+{\n+\tint count \u003d 0, i;\n+\n+\tfor (i \u003d 0; i \u003c dst_cnt * NUM_CANDIDATE_PER_DST; i++) {\n+\t\tstruct diff_rename_dst *dst;\n+\n+\t\tif ((mx[i].dst \u003c 0) ||\n+\t\t    (mx[i].score \u003c minimum_score))\n+\t\t\tbreak; /* there is no more usable pair. */\n+\t\tdst \u003d \u0026rename_dst[mx[i].dst];\n+\t\tif (dst-\u003epair)\n+\t\t\tcontinue; /* already done, either exact or fuzzy. */\n+\t\tif (!copies \u0026\u0026 rename_src[mx[i].src].one-\u003erename_used)\n+\t\t\tcontinue;\n+\t\trecord_rename_pair(mx[i].dst, mx[i].src, mx[i].score);\n+\t\tcount++;\n+\t}\n+\treturn count;\n+}\n+\n void diffcore_rename(struct diff_options *options)\n {\n \tint detect_rename \u003d options-\u003edetect_rename;\n@@ -538,33 +561,9 @@ void diffcore_rename(struct diff_options *options)\n \t/* cost matrix sorted by most to least similar pair */\n \tqsort(mx, dst_cnt * NUM_CANDIDATE_PER_DST, sizeof(*mx), score_compare);\n \n-\tfor (i \u003d 0; i \u003c dst_cnt * NUM_CANDIDATE_PER_DST; i++) {\n-\t\tstruct diff_rename_dst *dst;\n-\n-\t\tif ((mx[i].dst \u003c 0) ||\n-\t\t    (mx[i].score \u003c minimum_score))\n-\t\t\tbreak; /* there is no more usable pair. */\n-\t\tdst \u003d \u0026rename_dst[mx[i].dst];\n-\t\tif (dst-\u003epair)\n-\t\t\tcontinue; /* already done, either exact or fuzzy. */\n-\t\tif (rename_src[mx[i].src].one-\u003erename_used)\n-\t\t\tcontinue;\n-\t\trecord_rename_pair(mx[i].dst, mx[i].src, mx[i].score);\n-\t\trename_count++;\n-\t}\n-\n-\tfor (i \u003d 0; i \u003c dst_cnt * NUM_CANDIDATE_PER_DST; i++) {\n-\t\tstruct diff_rename_dst *dst;\n-\n-\t\tif ((mx[i].dst \u003c 0) ||\n-\t\t    (mx[i].score \u003c minimum_score))\n-\t\t\tbreak; /* there is no more usable pair. */\n-\t\tdst \u003d \u0026rename_dst[mx[i].dst];\n-\t\tif (dst-\u003epair)\n-\t\t\tcontinue; /* already done, either exact or fuzzy. */\n-\t\trecord_rename_pair(mx[i].dst, mx[i].src, mx[i].score);\n-\t\trename_count++;\n-\t}\n+\trename_count +\u003d find_renames(mx, dst_cnt, minimum_score, 0);\n+\tif (detect_rename \u003d\u003d DIFF_DETECT_COPY)\n+\t\trename_count +\u003d find_renames(mx, dst_cnt, minimum_score, 1);\n \tfree(mx);\n \n  cleanup:\ndiff --git a/t/t4003-diff-rename-1.sh b/t/t4003-diff-rename-1.sh\nindex c6130c4019..bfa8835638 100755\n--- a/t/t4003-diff-rename-1.sh\n+++ b/t/t4003-diff-rename-1.sh\n@@ -29,7 +29,7 @@ test_expect_success \\\n # copy-and-edit one, and rename-and-edit the other.  We do not say\n # anything about rezrov.\n \n-GIT_DIFF_OPTS\u003d--unified\u003d0 git diff-index -M -p $tree \u003ecurrent\n+GIT_DIFF_OPTS\u003d--unified\u003d0 git diff-index -C -p $tree \u003ecurrent\n cat \u003eexpected \u003c\u003c\\EOF\n diff --git a/COPYING b/COPYING.1\n copy from COPYING\ndiff --git a/t/t4004-diff-rename-symlink.sh b/t/t4004-diff-rename-symlink.sh\nindex 92a65f4852..6e562c80d1 100755\n--- a/t/t4004-diff-rename-symlink.sh\n+++ b/t/t4004-diff-rename-symlink.sh\n@@ -35,7 +35,7 @@ test_expect_success SYMLINKS \\\n # a new creation.\n \n test_expect_success SYMLINKS \u0027setup diff output\u0027 \"\n-    GIT_DIFF_OPTS\u003d--unified\u003d0 git diff-index -M -p $tree \u003ecurrent \u0026\u0026\n+    GIT_DIFF_OPTS\u003d--unified\u003d0 git diff-index -C -p $tree \u003ecurrent \u0026\u0026\n     cat \u003eexpected \u003c\u003c\\EOF\n diff --git a/bozbar b/bozbar\n new file mode 120000\ndiff --git a/t/t4005-diff-rename-2.sh b/t/t4005-diff-rename-2.sh\nindex 1ba359d478..77d7f4946f 100755\n--- a/t/t4005-diff-rename-2.sh\n+++ b/t/t4005-diff-rename-2.sh\n@@ -29,7 +29,7 @@ test_expect_success \\\n # and COPYING.2 are based on COPYING, and do not say anything about\n # rezrov.\n \n-git diff-index -M $tree \u003ecurrent\n+git diff-index -C $tree \u003ecurrent\n \n cat \u003eexpected \u003c\u003c\\EOF\n :100644 100644 6ff87c4664981e4397625791c8ea3bbb5f2279a3 0603b3238a076dc6c8022aedc6648fa523a17178 C1234\tCOPYING\tCOPYING.1\ndiff --git a/t/t4008-diff-break-rewrite.sh b/t/t4008-diff-break-rewrite.sh\nindex d79d9e1e71..73b4a24f5e 100755\n--- a/t/t4008-diff-break-rewrite.sh\n+++ b/t/t4008-diff-break-rewrite.sh\n@@ -173,8 +173,8 @@ test_expect_success \\\n     \u0027compare_diff_raw expected current\u0027\n \n test_expect_success \\\n-    \u0027run diff with -B -M\u0027 \\\n-    \u0027git diff-index -B -M \"$tree\" \u003ecurrent\u0027\n+    \u0027run diff with -B -C\u0027 \\\n+    \u0027git diff-index -B -C \"$tree\" \u003ecurrent\u0027\n \n cat \u003eexpected \u003c\u003c\\EOF\n :100644 100644 f5deac7be59e7eeab8657fd9ae706fd6a57daed2 08bb2fb671deff4c03a4d4a0a1315dff98d5732c C095\tfile0\tfile1\ndiff --git a/t/t4009-diff-rename-4.sh b/t/t4009-diff-rename-4.sh\nindex de3f17478e..f22c8e3dba 100755\n--- a/t/t4009-diff-rename-4.sh\n+++ b/t/t4009-diff-rename-4.sh\n@@ -29,7 +29,7 @@ test_expect_success \\\n # and COPYING.2 are based on COPYING, and do not say anything about\n # rezrov.\n \n-git diff-index -z -M $tree \u003ecurrent\n+git diff-index -z -C $tree \u003ecurrent\n \n cat \u003eexpected \u003c\u003c\\EOF\n :100644 100644 6ff87c4664981e4397625791c8ea3bbb5f2279a3 0603b3238a076dc6c8022aedc6648fa523a17178 C1234","expectedMessage":"diffcore-rename: properly honor the difference between -M and -C","repository":"git-linus","commitHash":"0940e5f211452ec2520d1b04233acddf0a872c06","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-11f944dd","diff":" builtin/describe.c |  4 ++--\n diffcore-rename.c  | 14 ++++++++------\n hash.c             |  4 ++--\n hash.h             |  2 +-\n 4 files changed, 13 insertions(+), 11 deletions(-)\n\ndiff --git a/builtin/describe.c b/builtin/describe.c\nindex 342129fdbd..3ba26dc819 100644\n--- a/builtin/describe.c\n+++ b/builtin/describe.c\n@@ -63,7 +63,7 @@ static inline struct commit_name *find_commit_name(const unsigned char *peeled)\n \treturn n;\n }\n \n-static int set_util(void *chain)\n+static int set_util(void *chain, void *data)\n {\n \tstruct commit_name *n;\n \tfor (n \u003d chain; n; n \u003d n-\u003enext) {\n@@ -289,7 +289,7 @@ static void describe(const char *arg, int last_one)\n \t\tfprintf(stderr, \"searching to describe %s\\n\", arg);\n \n \tif (!have_util) {\n-\t\tfor_each_hash(\u0026names, set_util);\n+\t\tfor_each_hash(\u0026names, set_util, NULL);\n \t\thave_util \u003d 1;\n \t}\n \ndiff --git a/diffcore-rename.c b/diffcore-rename.c\nindex df41be56de..e5e88feb54 100644\n--- a/diffcore-rename.c\n+++ b/diffcore-rename.c\n@@ -247,7 +247,8 @@ struct file_similarity {\n };\n \n static int find_identical_files(struct file_similarity *src,\n-\t\t\t\tstruct file_similarity *dst)\n+\t\t\t\tstruct file_similarity *dst,\n+\t\t\t\tstruct diff_options *options)\n {\n \tint renames \u003d 0;\n \n@@ -306,11 +307,12 @@ static void free_similarity_list(struct file_similarity *p)\n \t}\n }\n \n-static int find_same_files(void *ptr)\n+static int find_same_files(void *ptr, void *data)\n {\n \tint ret;\n \tstruct file_similarity *p \u003d ptr;\n \tstruct file_similarity *src \u003d NULL, *dst \u003d NULL;\n+\tstruct diff_options *options \u003d data;\n \n \t/* Split the hash list up into sources and destinations */\n \tdo {\n@@ -329,7 +331,7 @@ static int find_same_files(void *ptr)\n \t * If we have both sources *and* destinations, see if\n \t * we can match them up\n \t */\n-\tret \u003d (src \u0026\u0026 dst) ? find_identical_files(src, dst) : 0;\n+\tret \u003d (src \u0026\u0026 dst) ? find_identical_files(src, dst, options) : 0;\n \n \t/* Free the hashes and return the number of renames found */\n \tfree_similarity_list(src);\n@@ -377,7 +379,7 @@ static void insert_file_table(struct hash_table *table, int src_dst, int index,\n  * and then during the second round we try to match\n  * cache-dirty entries as well.\n  */\n-static int find_exact_renames(void)\n+static int find_exact_renames(struct diff_options *options)\n {\n \tint i;\n \tstruct hash_table file_table;\n@@ -390,7 +392,7 @@ static int find_exact_renames(void)\n \t\tinsert_file_table(\u0026file_table, 1, i, rename_dst[i].two);\n \n \t/* Find the renames */\n-\ti \u003d for_each_hash(\u0026file_table, find_same_files);\n+\ti \u003d for_each_hash(\u0026file_table, find_same_files, options);\n \n \t/* .. and free the hash data structure */\n \tfree_hash(\u0026file_table);\n@@ -467,7 +469,7 @@ void diffcore_rename(struct diff_options *options)\n \t * We really want to cull the candidates list early\n \t * with cheap tests in order to avoid doing deltas.\n \t */\n-\trename_count \u003d find_exact_renames();\n+\trename_count \u003d find_exact_renames(options);\n \n \t/* Did we only want exact renames? */\n \tif (minimum_score \u003d\u003d MAX_SCORE)\ndiff --git a/hash.c b/hash.c\nindex 1cd4c9d5c0..749ecfe484 100644\n--- a/hash.c\n+++ b/hash.c\n@@ -81,7 +81,7 @@ void **insert_hash(unsigned int hash, void *ptr, struct hash_table *table)\n \treturn insert_hash_entry(hash, ptr, table);\n }\n \n-int for_each_hash(const struct hash_table *table, int (*fn)(void *))\n+int for_each_hash(const struct hash_table *table, int (*fn)(void *, void *), void *data)\n {\n \tint sum \u003d 0;\n \tunsigned int i;\n@@ -92,7 +92,7 @@ int for_each_hash(const struct hash_table *table, int (*fn)(void *))\n \t\tvoid *ptr \u003d array-\u003eptr;\n \t\tarray++;\n \t\tif (ptr) {\n-\t\t\tint val \u003d fn(ptr);\n+\t\t\tint val \u003d fn(ptr, data);\n \t\t\tif (val \u003c 0)\n \t\t\t\treturn val;\n \t\t\tsum +\u003d val;\ndiff --git a/hash.h b/hash.h\nindex 69e33a47b9..b875ce67c4 100644\n--- a/hash.h\n+++ b/hash.h\n@@ -30,7 +30,7 @@ struct hash_table {\n \n extern void *lookup_hash(unsigned int hash, const struct hash_table *table);\n extern void **insert_hash(unsigned int hash, void *ptr, struct hash_table *table);\n-extern int for_each_hash(const struct hash_table *table, int (*fn)(void *));\n+extern int for_each_hash(const struct hash_table *table, int (*fn)(void *, void *), void *data);\n extern void free_hash(struct hash_table *table);\n \n static inline void init_hash(struct hash_table *table)","expectedMessage":"for_each_hash: allow passing a \u0027void *data\u0027 pointer to callback","repository":"git-linus","commitHash":"11f944dd6bdabd003325c85dc60b16389d012361","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-442cb08f","diff":" Documentation/git-checkout.txt | 16 ++++++++--------\n 1 file changed, 8 insertions(+), 8 deletions(-)\n\ndiff --git a/Documentation/git-checkout.txt b/Documentation/git-checkout.txt\nindex f88e9977d1..22d36114df 100644\n--- a/Documentation/git-checkout.txt\n+++ b/Documentation/git-checkout.txt\n@@ -45,14 +45,14 @@ successful.\n \n \u0027git checkout\u0027 [--patch] [\u003ctree-ish\u003e] [--] \u003cpathspec\u003e...::\n \n-\tWhen \u003cpaths\u003e or `--patch` are given, \u0027git checkout\u0027 *not* switch\n-\tbranches.  It updates the named paths in the working tree from\n-\tthe index file or from a named \u003ctree-ish\u003e (most often a commit).  In\n-\tthis case, the `-b` and `--track` options are meaningless and giving\n-\teither of them results in an error. The \u003ctree-ish\u003e argument can be\n-\tused to specify a specific tree-ish (i.e. commit, tag or tree)\n-\tto update the index for the given paths before updating the\n-\tworking tree.\n+\tWhen \u003cpaths\u003e or `--patch` are given, \u0027git checkout\u0027 does *not*\n+\tswitch branches.  It updates the named paths in the working tree\n+\tfrom the index file or from a named \u003ctree-ish\u003e (most often a\n+\tcommit).  In this case, the `-b` and `--track` options are\n+\tmeaningless and giving either of them results in an error.  The\n+\t\u003ctree-ish\u003e argument can be used to specify a specific tree-ish\n+\t(i.e.  commit, tag or tree) to update the index for the given\n+\tpaths before updating the working tree.\n +\n The index may contain unmerged entries because of a previous failed merge.\n By default, if you try to check out such an entry from the index, the","expectedMessage":"Fix missing \u0027does\u0027 in man-page for \u0027git checkout\u0027","repository":"git-linus","commitHash":"442cb08fa0dca38c99cf1ff8a5654a95a5cad7a4","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-1fda91b5","diff":" builtin/log.c | 7 +------\n git.c         | 6 +++---\n 2 files changed, 4 insertions(+), 9 deletions(-)\n\ndiff --git a/builtin/log.c b/builtin/log.c\nindex 08b872263c..eaa1ee0fa7 100644\n--- a/builtin/log.c\n+++ b/builtin/log.c\n@@ -125,6 +125,7 @@ static void cmd_log_init(int argc, const char **argv, const char *prefix,\n \t\trev-\u003eshow_decorations \u003d 1;\n \t\tload_ref_decorations(decoration_style);\n \t}\n+\tsetup_pager();\n }\n \n /*\n@@ -491,12 +492,6 @@ int cmd_log_reflog(int argc, const char **argv, const char *prefix)\n \trev.use_terminator \u003d 1;\n \trev.always_show_header \u003d 1;\n \n-\t/*\n-\t * We get called through \"git reflog\", so unlike the other log\n-\t * routines, we need to set up our pager manually..\n-\t */\n-\tsetup_pager();\n-\n \treturn cmd_log_walk(\u0026rev);\n }\n \ndiff --git a/git.c b/git.c\nindex f37028b3b7..b83c1d17ab 100644\n--- a/git.c\n+++ b/git.c\n@@ -336,7 +336,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"index-pack\", cmd_index_pack },\n \t\t{ \"init\", cmd_init_db },\n \t\t{ \"init-db\", cmd_init_db },\n-\t\t{ \"log\", cmd_log, RUN_SETUP | USE_PAGER },\n+\t\t{ \"log\", cmd_log, RUN_SETUP },\n \t\t{ \"ls-files\", cmd_ls_files, RUN_SETUP },\n \t\t{ \"ls-tree\", cmd_ls_tree, RUN_SETUP },\n \t\t{ \"ls-remote\", cmd_ls_remote },\n@@ -380,7 +380,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"send-pack\", cmd_send_pack, RUN_SETUP },\n \t\t{ \"shortlog\", cmd_shortlog, USE_PAGER },\n \t\t{ \"show-branch\", cmd_show_branch, RUN_SETUP },\n-\t\t{ \"show\", cmd_show, RUN_SETUP | USE_PAGER },\n+\t\t{ \"show\", cmd_show, RUN_SETUP },\n \t\t{ \"status\", cmd_status, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"stripspace\", cmd_stripspace },\n \t\t{ \"symbolic-ref\", cmd_symbolic_ref, RUN_SETUP },\n@@ -395,7 +395,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"var\", cmd_var },\n \t\t{ \"verify-tag\", cmd_verify_tag, RUN_SETUP },\n \t\t{ \"version\", cmd_version },\n-\t\t{ \"whatchanged\", cmd_whatchanged, RUN_SETUP | USE_PAGER },\n+\t\t{ \"whatchanged\", cmd_whatchanged, RUN_SETUP },\n \t\t{ \"write-tree\", cmd_write_tree, RUN_SETUP },\n \t\t{ \"verify-pack\", cmd_verify_pack },\n \t\t{ \"show-ref\", cmd_show_ref, RUN_SETUP },","expectedMessage":"Fix \u0027git log\u0027 early pager startup error case","repository":"git-linus","commitHash":"1fda91b511c76eb233f99877c60d1c5f7801f647","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-57895105","diff":" sha1_name.c | 12 +++++++++---\n 1 file changed, 9 insertions(+), 3 deletions(-)\n\ndiff --git a/sha1_name.c b/sha1_name.c\nindex bf92417838..8cf635af54 100644\n--- a/sha1_name.c\n+++ b/sha1_name.c\n@@ -679,8 +679,8 @@ static int handle_one_ref(const char *path,\n \n /*\n  * This interprets names like \u0027:/Initial revision of \"git\"\u0027 by searching\n- * through history and returning the first commit whose message starts\n- * with the given string.\n+ * through history and returning the first commit whose message matches\n+ * the given regular expression.\n  *\n  * For future extension, \u0027:/!\u0027 is reserved. If you want to match a message\n  * beginning with a \u0027!\u0027, you have to repeat the exclamation mark.\n@@ -692,12 +692,17 @@ static int get_sha1_oneline(const char *prefix, unsigned char *sha1)\n \tstruct commit_list *list \u003d NULL, *backup \u003d NULL, *l;\n \tint retval \u003d -1;\n \tchar *temp_commit_buffer \u003d NULL;\n+\tregex_t regex;\n \n \tif (prefix[0] \u003d\u003d \u0027!\u0027) {\n \t\tif (prefix[1] !\u003d \u0027!\u0027)\n \t\t\tdie (\"Invalid search pattern: %s\", prefix);\n \t\tprefix++;\n \t}\n+\n+\tif (regcomp(\u0026regex, prefix, REG_EXTENDED))\n+\t\tdie(\"Invalid search pattern: %s\", prefix);\n+\n \tfor_each_ref(handle_one_ref, \u0026list);\n \tfor (l \u003d list; l; l \u003d l-\u003enext)\n \t\tcommit_list_insert(l-\u003eitem, \u0026backup);\n@@ -721,12 +726,13 @@ static int get_sha1_oneline(const char *prefix, unsigned char *sha1)\n \t\t}\n \t\tif (!(p \u003d strstr(p, \"\\n\\n\")))\n \t\t\tcontinue;\n-\t\tif (!prefixcmp(p + 2, prefix)) {\n+\t\tif (!regexec(\u0026regex, p + 2, 0, NULL, 0)) {\n \t\t\thashcpy(sha1, commit-\u003eobject.sha1);\n \t\t\tretval \u003d 0;\n \t\t\tbreak;\n \t\t}\n \t}\n+\tregfree(\u0026regex);\n \tfree(temp_commit_buffer);\n \tfree_commit_list(list);\n \tfor (l \u003d backup; l; l \u003d l-\u003enext)","expectedMessage":"Make :/ accept a regex rather than a fixed pattern","repository":"git-linus","commitHash":"57895105c4ff083d7c9bc59b2b88b9b5176c1915","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-81b50f3c","diff":" Makefile                                           | 194 ++++++++++-----------\n builtin-add.c \u003d\u003e builtin/add.c                     |   0\n builtin-annotate.c \u003d\u003e builtin/annotate.c           |   0\n builtin-apply.c \u003d\u003e builtin/apply.c                 |   0\n builtin-archive.c \u003d\u003e builtin/archive.c             |   0\n .../bisect--helper.c                               |   0\n builtin-blame.c \u003d\u003e builtin/blame.c                 |   0\n builtin-branch.c \u003d\u003e builtin/branch.c               |   0\n builtin-bundle.c \u003d\u003e builtin/bundle.c               |   0\n builtin-cat-file.c \u003d\u003e builtin/cat-file.c           |   0\n builtin-check-attr.c \u003d\u003e builtin/check-attr.c       |   0\n .../check-ref-format.c                             |   0\n .../checkout-index.c                               |   0\n builtin-checkout.c \u003d\u003e builtin/checkout.c           |   0\n builtin-clean.c \u003d\u003e builtin/clean.c                 |   0\n builtin-clone.c \u003d\u003e builtin/clone.c                 |   0\n builtin-commit-tree.c \u003d\u003e builtin/commit-tree.c     |   0\n builtin-commit.c \u003d\u003e builtin/commit.c               |   0\n builtin-config.c \u003d\u003e builtin/config.c               |   0\n builtin-count-objects.c \u003d\u003e builtin/count-objects.c |   0\n builtin-describe.c \u003d\u003e builtin/describe.c           |   0\n builtin-diff-files.c \u003d\u003e builtin/diff-files.c       |   0\n builtin-diff-index.c \u003d\u003e builtin/diff-index.c       |   0\n builtin-diff-tree.c \u003d\u003e builtin/diff-tree.c         |   0\n builtin-diff.c \u003d\u003e builtin/diff.c                   |   0\n builtin-fast-export.c \u003d\u003e builtin/fast-export.c     |   0\n builtin-fetch-pack.c \u003d\u003e builtin/fetch-pack.c       |   0\n builtin-fetch.c \u003d\u003e builtin/fetch.c                 |   0\n builtin-fmt-merge-msg.c \u003d\u003e builtin/fmt-merge-msg.c |   0\n builtin-for-each-ref.c \u003d\u003e builtin/for-each-ref.c   |   0\n builtin-fsck.c \u003d\u003e builtin/fsck.c                   |   0\n builtin-gc.c \u003d\u003e builtin/gc.c                       |   0\n builtin-grep.c \u003d\u003e builtin/grep.c                   |   0\n builtin-hash-object.c \u003d\u003e builtin/hash-object.c     |   0\n builtin-help.c \u003d\u003e builtin/help.c                   |   0\n builtin-index-pack.c \u003d\u003e builtin/index-pack.c       |   0\n builtin-init-db.c \u003d\u003e builtin/init-db.c             |   0\n builtin-log.c \u003d\u003e builtin/log.c                     |   0\n builtin-ls-files.c \u003d\u003e builtin/ls-files.c           |   0\n builtin-ls-remote.c \u003d\u003e builtin/ls-remote.c         |   0\n builtin-ls-tree.c \u003d\u003e builtin/ls-tree.c             |   0\n builtin-mailinfo.c \u003d\u003e builtin/mailinfo.c           |   0\n builtin-mailsplit.c \u003d\u003e builtin/mailsplit.c         |   0\n builtin-merge-base.c \u003d\u003e builtin/merge-base.c       |   0\n builtin-merge-file.c \u003d\u003e builtin/merge-file.c       |   0\n builtin-merge-index.c \u003d\u003e builtin/merge-index.c     |   0\n builtin-merge-ours.c \u003d\u003e builtin/merge-ours.c       |   0\n .../merge-recursive.c                              |   0\n builtin-merge-tree.c \u003d\u003e builtin/merge-tree.c       |   0\n builtin-merge.c \u003d\u003e builtin/merge.c                 |   0\n builtin-mktag.c \u003d\u003e builtin/mktag.c                 |   0\n builtin-mktree.c \u003d\u003e builtin/mktree.c               |   0\n builtin-mv.c \u003d\u003e builtin/mv.c                       |   0\n builtin-name-rev.c \u003d\u003e builtin/name-rev.c           |   0\n builtin-pack-objects.c \u003d\u003e builtin/pack-objects.c   |   0\n .../pack-redundant.c                               |   0\n builtin-pack-refs.c \u003d\u003e builtin/pack-refs.c         |   0\n builtin-patch-id.c \u003d\u003e builtin/patch-id.c           |   0\n builtin-prune-packed.c \u003d\u003e builtin/prune-packed.c   |   0\n builtin-prune.c \u003d\u003e builtin/prune.c                 |   0\n builtin-push.c \u003d\u003e builtin/push.c                   |   0\n builtin-read-tree.c \u003d\u003e builtin/read-tree.c         |   0\n builtin-receive-pack.c \u003d\u003e builtin/receive-pack.c   |   0\n builtin-reflog.c \u003d\u003e builtin/reflog.c               |   0\n builtin-remote.c \u003d\u003e builtin/remote.c               |   0\n builtin-replace.c \u003d\u003e builtin/replace.c             |   0\n builtin-rerere.c \u003d\u003e builtin/rerere.c               |   0\n builtin-reset.c \u003d\u003e builtin/reset.c                 |   0\n builtin-rev-list.c \u003d\u003e builtin/rev-list.c           |   0\n builtin-rev-parse.c \u003d\u003e builtin/rev-parse.c         |   0\n builtin-revert.c \u003d\u003e builtin/revert.c               |   0\n builtin-rm.c \u003d\u003e builtin/rm.c                       |   0\n builtin-send-pack.c \u003d\u003e builtin/send-pack.c         |   0\n builtin-shortlog.c \u003d\u003e builtin/shortlog.c           |   0\n builtin-show-branch.c \u003d\u003e builtin/show-branch.c     |   0\n builtin-show-ref.c \u003d\u003e builtin/show-ref.c           |   0\n builtin-stripspace.c \u003d\u003e builtin/stripspace.c       |   0\n builtin-symbolic-ref.c \u003d\u003e builtin/symbolic-ref.c   |   0\n builtin-tag.c \u003d\u003e builtin/tag.c                     |   0\n builtin-tar-tree.c \u003d\u003e builtin/tar-tree.c           |   0\n builtin-unpack-file.c \u003d\u003e builtin/unpack-file.c     |   0\n .../unpack-objects.c                               |   0\n builtin-update-index.c \u003d\u003e builtin/update-index.c   |   0\n builtin-update-ref.c \u003d\u003e builtin/update-ref.c       |   0\n .../update-server-info.c                           |   0\n .../upload-archive.c                               |   0\n builtin-var.c \u003d\u003e builtin/var.c                     |   0\n builtin-verify-pack.c \u003d\u003e builtin/verify-pack.c     |   0\n builtin-verify-tag.c \u003d\u003e builtin/verify-tag.c       |   0\n builtin-write-tree.c \u003d\u003e builtin/write-tree.c       |   0\n 90 files changed, 97 insertions(+), 97 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex afedb54b48..f1025d5c03 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -301,7 +301,7 @@ SPARSE_FLAGS \u003d -D__BIG_ENDIAN__ -D__powerpc__\n # Those must not be GNU-specific; they are shared with perl/ which may\n # be built by a different compiler. (Note that this is an artifact now\n # but it still might be nice to keep that distinction.)\n-BASIC_CFLAGS \u003d\n+BASIC_CFLAGS \u003d -I.\n BASIC_LDFLAGS \u003d\n \n # Guard against environment variables\n@@ -370,8 +370,8 @@ PROGRAMS +\u003d git-upload-pack$X\n PROGRAMS +\u003d git-http-backend$X\n \n # List built-in command $C whose implementation cmd_$C() is not in\n-# builtin-$C.o but is linked in as part of some other command.\n-BUILT_INS +\u003d $(patsubst builtin-%.o,git-%$X,$(BUILTIN_OBJS))\n+# builtin/$C.o but is linked in as part of some other command.\n+BUILT_INS +\u003d $(patsubst builtin/%.o,git-%$X,$(BUILTIN_OBJS))\n \n BUILT_INS +\u003d git-cherry$X\n BUILT_INS +\u003d git-cherry-pick$X\n@@ -594,95 +594,95 @@ LIB_OBJS +\u003d ws.o\n LIB_OBJS +\u003d wt-status.o\n LIB_OBJS +\u003d xdiff-interface.o\n \n-BUILTIN_OBJS +\u003d builtin-add.o\n-BUILTIN_OBJS +\u003d builtin-annotate.o\n-BUILTIN_OBJS +\u003d builtin-apply.o\n-BUILTIN_OBJS +\u003d builtin-archive.o\n-BUILTIN_OBJS +\u003d builtin-bisect--helper.o\n-BUILTIN_OBJS +\u003d builtin-blame.o\n-BUILTIN_OBJS +\u003d builtin-branch.o\n-BUILTIN_OBJS +\u003d builtin-bundle.o\n-BUILTIN_OBJS +\u003d builtin-cat-file.o\n-BUILTIN_OBJS +\u003d builtin-check-attr.o\n-BUILTIN_OBJS +\u003d builtin-check-ref-format.o\n-BUILTIN_OBJS +\u003d builtin-checkout-index.o\n-BUILTIN_OBJS +\u003d builtin-checkout.o\n-BUILTIN_OBJS +\u003d builtin-clean.o\n-BUILTIN_OBJS +\u003d builtin-clone.o\n-BUILTIN_OBJS +\u003d builtin-commit-tree.o\n-BUILTIN_OBJS +\u003d builtin-commit.o\n-BUILTIN_OBJS +\u003d builtin-config.o\n-BUILTIN_OBJS +\u003d builtin-count-objects.o\n-BUILTIN_OBJS +\u003d builtin-describe.o\n-BUILTIN_OBJS +\u003d builtin-diff-files.o\n-BUILTIN_OBJS +\u003d builtin-diff-index.o\n-BUILTIN_OBJS +\u003d builtin-diff-tree.o\n-BUILTIN_OBJS +\u003d builtin-diff.o\n-BUILTIN_OBJS +\u003d builtin-fast-export.o\n-BUILTIN_OBJS +\u003d builtin-fetch-pack.o\n-BUILTIN_OBJS +\u003d builtin-fetch.o\n-BUILTIN_OBJS +\u003d builtin-fmt-merge-msg.o\n-BUILTIN_OBJS +\u003d builtin-for-each-ref.o\n-BUILTIN_OBJS +\u003d builtin-fsck.o\n-BUILTIN_OBJS +\u003d builtin-gc.o\n-BUILTIN_OBJS +\u003d builtin-grep.o\n-BUILTIN_OBJS +\u003d builtin-hash-object.o\n-BUILTIN_OBJS +\u003d builtin-help.o\n-BUILTIN_OBJS +\u003d builtin-index-pack.o\n-BUILTIN_OBJS +\u003d builtin-init-db.o\n-BUILTIN_OBJS +\u003d builtin-log.o\n-BUILTIN_OBJS +\u003d builtin-ls-files.o\n-BUILTIN_OBJS +\u003d builtin-ls-remote.o\n-BUILTIN_OBJS +\u003d builtin-ls-tree.o\n-BUILTIN_OBJS +\u003d builtin-mailinfo.o\n-BUILTIN_OBJS +\u003d builtin-mailsplit.o\n-BUILTIN_OBJS +\u003d builtin-merge.o\n-BUILTIN_OBJS +\u003d builtin-merge-base.o\n-BUILTIN_OBJS +\u003d builtin-merge-file.o\n-BUILTIN_OBJS +\u003d builtin-merge-index.o\n-BUILTIN_OBJS +\u003d builtin-merge-ours.o\n-BUILTIN_OBJS +\u003d builtin-merge-recursive.o\n-BUILTIN_OBJS +\u003d builtin-merge-tree.o\n-BUILTIN_OBJS +\u003d builtin-mktag.o\n-BUILTIN_OBJS +\u003d builtin-mktree.o\n-BUILTIN_OBJS +\u003d builtin-mv.o\n-BUILTIN_OBJS +\u003d builtin-name-rev.o\n-BUILTIN_OBJS +\u003d builtin-pack-objects.o\n-BUILTIN_OBJS +\u003d builtin-pack-redundant.o\n-BUILTIN_OBJS +\u003d builtin-pack-refs.o\n-BUILTIN_OBJS +\u003d builtin-patch-id.o\n-BUILTIN_OBJS +\u003d builtin-prune-packed.o\n-BUILTIN_OBJS +\u003d builtin-prune.o\n-BUILTIN_OBJS +\u003d builtin-push.o\n-BUILTIN_OBJS +\u003d builtin-read-tree.o\n-BUILTIN_OBJS +\u003d builtin-receive-pack.o\n-BUILTIN_OBJS +\u003d builtin-reflog.o\n-BUILTIN_OBJS +\u003d builtin-remote.o\n-BUILTIN_OBJS +\u003d builtin-replace.o\n-BUILTIN_OBJS +\u003d builtin-rerere.o\n-BUILTIN_OBJS +\u003d builtin-reset.o\n-BUILTIN_OBJS +\u003d builtin-rev-list.o\n-BUILTIN_OBJS +\u003d builtin-rev-parse.o\n-BUILTIN_OBJS +\u003d builtin-revert.o\n-BUILTIN_OBJS +\u003d builtin-rm.o\n-BUILTIN_OBJS +\u003d builtin-send-pack.o\n-BUILTIN_OBJS +\u003d builtin-shortlog.o\n-BUILTIN_OBJS +\u003d builtin-show-branch.o\n-BUILTIN_OBJS +\u003d builtin-show-ref.o\n-BUILTIN_OBJS +\u003d builtin-stripspace.o\n-BUILTIN_OBJS +\u003d builtin-symbolic-ref.o\n-BUILTIN_OBJS +\u003d builtin-tag.o\n-BUILTIN_OBJS +\u003d builtin-tar-tree.o\n-BUILTIN_OBJS +\u003d builtin-unpack-file.o\n-BUILTIN_OBJS +\u003d builtin-unpack-objects.o\n-BUILTIN_OBJS +\u003d builtin-update-index.o\n-BUILTIN_OBJS +\u003d builtin-update-ref.o\n-BUILTIN_OBJS +\u003d builtin-update-server-info.o\n-BUILTIN_OBJS +\u003d builtin-upload-archive.o\n-BUILTIN_OBJS +\u003d builtin-var.o\n-BUILTIN_OBJS +\u003d builtin-verify-pack.o\n-BUILTIN_OBJS +\u003d builtin-verify-tag.o\n-BUILTIN_OBJS +\u003d builtin-write-tree.o\n+BUILTIN_OBJS +\u003d builtin/add.o\n+BUILTIN_OBJS +\u003d builtin/annotate.o\n+BUILTIN_OBJS +\u003d builtin/apply.o\n+BUILTIN_OBJS +\u003d builtin/archive.o\n+BUILTIN_OBJS +\u003d builtin/bisect--helper.o\n+BUILTIN_OBJS +\u003d builtin/blame.o\n+BUILTIN_OBJS +\u003d builtin/branch.o\n+BUILTIN_OBJS +\u003d builtin/bundle.o\n+BUILTIN_OBJS +\u003d builtin/cat-file.o\n+BUILTIN_OBJS +\u003d builtin/check-attr.o\n+BUILTIN_OBJS +\u003d builtin/check-ref-format.o\n+BUILTIN_OBJS +\u003d builtin/checkout-index.o\n+BUILTIN_OBJS +\u003d builtin/checkout.o\n+BUILTIN_OBJS +\u003d builtin/clean.o\n+BUILTIN_OBJS +\u003d builtin/clone.o\n+BUILTIN_OBJS +\u003d builtin/commit-tree.o\n+BUILTIN_OBJS +\u003d builtin/commit.o\n+BUILTIN_OBJS +\u003d builtin/config.o\n+BUILTIN_OBJS +\u003d builtin/count-objects.o\n+BUILTIN_OBJS +\u003d builtin/describe.o\n+BUILTIN_OBJS +\u003d builtin/diff-files.o\n+BUILTIN_OBJS +\u003d builtin/diff-index.o\n+BUILTIN_OBJS +\u003d builtin/diff-tree.o\n+BUILTIN_OBJS +\u003d builtin/diff.o\n+BUILTIN_OBJS +\u003d builtin/fast-export.o\n+BUILTIN_OBJS +\u003d builtin/fetch-pack.o\n+BUILTIN_OBJS +\u003d builtin/fetch.o\n+BUILTIN_OBJS +\u003d builtin/fmt-merge-msg.o\n+BUILTIN_OBJS +\u003d builtin/for-each-ref.o\n+BUILTIN_OBJS +\u003d builtin/fsck.o\n+BUILTIN_OBJS +\u003d builtin/gc.o\n+BUILTIN_OBJS +\u003d builtin/grep.o\n+BUILTIN_OBJS +\u003d builtin/hash-object.o\n+BUILTIN_OBJS +\u003d builtin/help.o\n+BUILTIN_OBJS +\u003d builtin/index-pack.o\n+BUILTIN_OBJS +\u003d builtin/init-db.o\n+BUILTIN_OBJS +\u003d builtin/log.o\n+BUILTIN_OBJS +\u003d builtin/ls-files.o\n+BUILTIN_OBJS +\u003d builtin/ls-remote.o\n+BUILTIN_OBJS +\u003d builtin/ls-tree.o\n+BUILTIN_OBJS +\u003d builtin/mailinfo.o\n+BUILTIN_OBJS +\u003d builtin/mailsplit.o\n+BUILTIN_OBJS +\u003d builtin/merge.o\n+BUILTIN_OBJS +\u003d builtin/merge-base.o\n+BUILTIN_OBJS +\u003d builtin/merge-file.o\n+BUILTIN_OBJS +\u003d builtin/merge-index.o\n+BUILTIN_OBJS +\u003d builtin/merge-ours.o\n+BUILTIN_OBJS +\u003d builtin/merge-recursive.o\n+BUILTIN_OBJS +\u003d builtin/merge-tree.o\n+BUILTIN_OBJS +\u003d builtin/mktag.o\n+BUILTIN_OBJS +\u003d builtin/mktree.o\n+BUILTIN_OBJS +\u003d builtin/mv.o\n+BUILTIN_OBJS +\u003d builtin/name-rev.o\n+BUILTIN_OBJS +\u003d builtin/pack-objects.o\n+BUILTIN_OBJS +\u003d builtin/pack-redundant.o\n+BUILTIN_OBJS +\u003d builtin/pack-refs.o\n+BUILTIN_OBJS +\u003d builtin/patch-id.o\n+BUILTIN_OBJS +\u003d builtin/prune-packed.o\n+BUILTIN_OBJS +\u003d builtin/prune.o\n+BUILTIN_OBJS +\u003d builtin/push.o\n+BUILTIN_OBJS +\u003d builtin/read-tree.o\n+BUILTIN_OBJS +\u003d builtin/receive-pack.o\n+BUILTIN_OBJS +\u003d builtin/reflog.o\n+BUILTIN_OBJS +\u003d builtin/remote.o\n+BUILTIN_OBJS +\u003d builtin/replace.o\n+BUILTIN_OBJS +\u003d builtin/rerere.o\n+BUILTIN_OBJS +\u003d builtin/reset.o\n+BUILTIN_OBJS +\u003d builtin/rev-list.o\n+BUILTIN_OBJS +\u003d builtin/rev-parse.o\n+BUILTIN_OBJS +\u003d builtin/revert.o\n+BUILTIN_OBJS +\u003d builtin/rm.o\n+BUILTIN_OBJS +\u003d builtin/send-pack.o\n+BUILTIN_OBJS +\u003d builtin/shortlog.o\n+BUILTIN_OBJS +\u003d builtin/show-branch.o\n+BUILTIN_OBJS +\u003d builtin/show-ref.o\n+BUILTIN_OBJS +\u003d builtin/stripspace.o\n+BUILTIN_OBJS +\u003d builtin/symbolic-ref.o\n+BUILTIN_OBJS +\u003d builtin/tag.o\n+BUILTIN_OBJS +\u003d builtin/tar-tree.o\n+BUILTIN_OBJS +\u003d builtin/unpack-file.o\n+BUILTIN_OBJS +\u003d builtin/unpack-objects.o\n+BUILTIN_OBJS +\u003d builtin/update-index.o\n+BUILTIN_OBJS +\u003d builtin/update-ref.o\n+BUILTIN_OBJS +\u003d builtin/update-server-info.o\n+BUILTIN_OBJS +\u003d builtin/upload-archive.o\n+BUILTIN_OBJS +\u003d builtin/var.o\n+BUILTIN_OBJS +\u003d builtin/verify-pack.o\n+BUILTIN_OBJS +\u003d builtin/verify-tag.o\n+BUILTIN_OBJS +\u003d builtin/write-tree.o\n \n GITLIBS \u003d $(LIB_FILE) $(XDIFF_LIB)\n EXTLIBS \u003d\n@@ -1447,8 +1447,8 @@ git$X: git.o $(BUILTIN_OBJS) $(GITLIBS)\n \t$(QUIET_LINK)$(CC) $(ALL_CFLAGS) -o $@ git.o \\\n \t\t$(BUILTIN_OBJS) $(ALL_LDFLAGS) $(LIBS)\n \n-builtin-help.o: common-cmds.h\n-builtin-help.s builtin-help.o: ALL_CFLAGS +\u003d \\\n+builtin/help.o: common-cmds.h\n+builtin/help.s builtin/help.o: ALL_CFLAGS +\u003d \\\n \t\u0027-DGIT_HTML_PATH\u003d\"$(htmldir_SQ)\"\u0027 \\\n \t\u0027-DGIT_MAN_PATH\u003d\"$(mandir_SQ)\"\u0027 \\\n \t\u0027-DGIT_INFO_PATH\u003d\"$(infodir_SQ)\"\u0027\n@@ -1604,7 +1604,7 @@ exec_cmd.s exec_cmd.o: ALL_CFLAGS +\u003d \\\n \t\u0027-DBINDIR\u003d\"$(bindir_relative_SQ)\"\u0027 \\\n \t\u0027-DPREFIX\u003d\"$(prefix_SQ)\"\u0027\n \n-builtin-init-db.s builtin-init-db.o: ALL_CFLAGS +\u003d \\\n+builtin/init-db.s builtin/init-db.o: ALL_CFLAGS +\u003d \\\n \t-DDEFAULT_GIT_TEMPLATE_DIR\u003d\u0027\"$(template_dir_SQ)\"\u0027\n \n config.s config.o: ALL_CFLAGS +\u003d -DETC_GITCONFIG\u003d\u0027\"$(ETC_GITCONFIG_SQ)\"\u0027\n@@ -1646,7 +1646,7 @@ $(REMOTE_CURL_PRIMARY): remote-curl.o http.o http-walker.o $(GITLIBS)\n \n $(LIB_OBJS) $(BUILTIN_OBJS): $(LIB_H)\n $(patsubst git-%$X,%.o,$(PROGRAMS)) git.o: $(LIB_H) $(wildcard */*.h)\n-builtin-revert.o wt-status.o: wt-status.h\n+builtin/revert.o wt-status.o: wt-status.h\n \n $(LIB_FILE): $(LIB_OBJS)\n \t$(QUIET_AR)$(RM) $@ \u0026\u0026 $(AR) rcs $@ $(LIB_OBJS)\n@@ -1934,7 +1934,7 @@ distclean: clean\n \n clean:\n \t$(RM) *.o block-sha1/*.o ppc/*.o compat/*.o compat/*/*.o xdiff/*.o \\\n-\t\t$(LIB_FILE) $(XDIFF_LIB)\n+\t\tbuiltin/*.o $(LIB_FILE) $(XDIFF_LIB)\n \t$(RM) $(ALL_PROGRAMS) $(SCRIPT_LIB) $(BUILT_INS) git$X\n \t$(RM) $(TEST_PROGRAMS)\n \t$(RM) -r bin-wrappers\ndiff --git a/builtin-add.c b/builtin/add.c\nsimilarity index 100%\nrename from builtin-add.c\nrename to builtin/add.c\ndiff --git a/builtin-annotate.c b/builtin/annotate.c\nsimilarity index 100%\nrename from builtin-annotate.c\nrename to builtin/annotate.c\ndiff --git a/builtin-apply.c b/builtin/apply.c\nsimilarity index 100%\nrename from builtin-apply.c\nrename to builtin/apply.c\ndiff --git a/builtin-archive.c b/builtin/archive.c\nsimilarity index 100%\nrename from builtin-archive.c\nrename to builtin/archive.c\ndiff --git a/builtin-bisect--helper.c b/builtin/bisect--helper.c\nsimilarity index 100%\nrename from builtin-bisect--helper.c\nrename to builtin/bisect--helper.c\ndiff --git a/builtin-blame.c b/builtin/blame.c\nsimilarity index 100%\nrename from builtin-blame.c\nrename to builtin/blame.c\ndiff --git a/builtin-branch.c b/builtin/branch.c\nsimilarity index 100%\nrename from builtin-branch.c\nrename to builtin/branch.c\ndiff --git a/builtin-bundle.c b/builtin/bundle.c\nsimilarity index 100%\nrename from builtin-bundle.c\nrename to builtin/bundle.c\ndiff --git a/builtin-cat-file.c b/builtin/cat-file.c\nsimilarity index 100%\nrename from builtin-cat-file.c\nrename to builtin/cat-file.c\ndiff --git a/builtin-check-attr.c b/builtin/check-attr.c\nsimilarity index 100%\nrename from builtin-check-attr.c\nrename to builtin/check-attr.c\ndiff --git a/builtin-check-ref-format.c b/builtin/check-ref-format.c\nsimilarity index 100%\nrename from builtin-check-ref-format.c\nrename to builtin/check-ref-format.c\ndiff --git a/builtin-checkout-index.c b/builtin/checkout-index.c\nsimilarity index 100%\nrename from builtin-checkout-index.c\nrename to builtin/checkout-index.c\ndiff --git a/builtin-checkout.c b/builtin/checkout.c\nsimilarity index 100%\nrename from builtin-checkout.c\nrename to builtin/checkout.c\ndiff --git a/builtin-clean.c b/builtin/clean.c\nsimilarity index 100%\nrename from builtin-clean.c\nrename to builtin/clean.c\ndiff --git a/builtin-clone.c b/builtin/clone.c\nsimilarity index 100%\nrename from builtin-clone.c\nrename to builtin/clone.c\ndiff --git a/builtin-commit-tree.c b/builtin/commit-tree.c\nsimilarity index 100%\nrename from builtin-commit-tree.c\nrename to builtin/commit-tree.c\ndiff --git a/builtin-commit.c b/builtin/commit.c\nsimilarity index 100%\nrename from builtin-commit.c\nrename to builtin/commit.c\ndiff --git a/builtin-config.c b/builtin/config.c\nsimilarity index 100%\nrename from builtin-config.c\nrename to builtin/config.c\ndiff --git a/builtin-count-objects.c b/builtin/count-objects.c\nsimilarity index 100%\nrename from builtin-count-objects.c\nrename to builtin/count-objects.c\ndiff --git a/builtin-describe.c b/builtin/describe.c\nsimilarity index 100%\nrename from builtin-describe.c\nrename to builtin/describe.c\ndiff --git a/builtin-diff-files.c b/builtin/diff-files.c\nsimilarity index 100%\nrename from builtin-diff-files.c\nrename to builtin/diff-files.c\ndiff --git a/builtin-diff-index.c b/builtin/diff-index.c\nsimilarity index 100%\nrename from builtin-diff-index.c\nrename to builtin/diff-index.c\ndiff --git a/builtin-diff-tree.c b/builtin/diff-tree.c\nsimilarity index 100%\nrename from builtin-diff-tree.c\nrename to builtin/diff-tree.c\ndiff --git a/builtin-diff.c b/builtin/diff.c\nsimilarity index 100%\nrename from builtin-diff.c\nrename to builtin/diff.c\ndiff --git a/builtin-fast-export.c b/builtin/fast-export.c\nsimilarity index 100%\nrename from builtin-fast-export.c\nrename to builtin/fast-export.c\ndiff --git a/builtin-fetch-pack.c b/builtin/fetch-pack.c\nsimilarity index 100%\nrename from builtin-fetch-pack.c\nrename to builtin/fetch-pack.c\ndiff --git a/builtin-fetch.c b/builtin/fetch.c\nsimilarity index 100%\nrename from builtin-fetch.c\nrename to builtin/fetch.c\ndiff --git a/builtin-fmt-merge-msg.c b/builtin/fmt-merge-msg.c\nsimilarity index 100%\nrename from builtin-fmt-merge-msg.c\nrename to builtin/fmt-merge-msg.c\ndiff --git a/builtin-for-each-ref.c b/builtin/for-each-ref.c\nsimilarity index 100%\nrename from builtin-for-each-ref.c\nrename to builtin/for-each-ref.c\ndiff --git a/builtin-fsck.c b/builtin/fsck.c\nsimilarity index 100%\nrename from builtin-fsck.c\nrename to builtin/fsck.c\ndiff --git a/builtin-gc.c b/builtin/gc.c\nsimilarity index 100%\nrename from builtin-gc.c\nrename to builtin/gc.c\ndiff --git a/builtin-grep.c b/builtin/grep.c\nsimilarity index 100%\nrename from builtin-grep.c\nrename to builtin/grep.c\ndiff --git a/builtin-hash-object.c b/builtin/hash-object.c\nsimilarity index 100%\nrename from builtin-hash-object.c\nrename to builtin/hash-object.c\ndiff --git a/builtin-help.c b/builtin/help.c\nsimilarity index 100%\nrename from builtin-help.c\nrename to builtin/help.c\ndiff --git a/builtin-index-pack.c b/builtin/index-pack.c\nsimilarity index 100%\nrename from builtin-index-pack.c\nrename to builtin/index-pack.c\ndiff --git a/builtin-init-db.c b/builtin/init-db.c\nsimilarity index 100%\nrename from builtin-init-db.c\nrename to builtin/init-db.c\ndiff --git a/builtin-log.c b/builtin/log.c\nsimilarity index 100%\nrename from builtin-log.c\nrename to builtin/log.c\ndiff --git a/builtin-ls-files.c b/builtin/ls-files.c\nsimilarity index 100%\nrename from builtin-ls-files.c\nrename to builtin/ls-files.c\ndiff --git a/builtin-ls-remote.c b/builtin/ls-remote.c\nsimilarity index 100%\nrename from builtin-ls-remote.c\nrename to builtin/ls-remote.c\ndiff --git a/builtin-ls-tree.c b/builtin/ls-tree.c\nsimilarity index 100%\nrename from builtin-ls-tree.c\nrename to builtin/ls-tree.c\ndiff --git a/builtin-mailinfo.c b/builtin/mailinfo.c\nsimilarity index 100%\nrename from builtin-mailinfo.c\nrename to builtin/mailinfo.c\ndiff --git a/builtin-mailsplit.c b/builtin/mailsplit.c\nsimilarity index 100%\nrename from builtin-mailsplit.c\nrename to builtin/mailsplit.c\ndiff --git a/builtin-merge-base.c b/builtin/merge-base.c\nsimilarity index 100%\nrename from builtin-merge-base.c\nrename to builtin/merge-base.c\ndiff --git a/builtin-merge-file.c b/builtin/merge-file.c\nsimilarity index 100%\nrename from builtin-merge-file.c\nrename to builtin/merge-file.c\ndiff --git a/builtin-merge-index.c b/builtin/merge-index.c\nsimilarity index 100%\nrename from builtin-merge-index.c\nrename to builtin/merge-index.c\ndiff --git a/builtin-merge-ours.c b/builtin/merge-ours.c\nsimilarity index 100%\nrename from builtin-merge-ours.c\nrename to builtin/merge-ours.c\ndiff --git a/builtin-merge-recursive.c b/builtin/merge-recursive.c\nsimilarity index 100%\nrename from builtin-merge-recursive.c\nrename to builtin/merge-recursive.c\ndiff --git a/builtin-merge-tree.c b/builtin/merge-tree.c\nsimilarity index 100%\nrename from builtin-merge-tree.c\nrename to builtin/merge-tree.c\ndiff --git a/builtin-merge.c b/builtin/merge.c\nsimilarity index 100%\nrename from builtin-merge.c\nrename to builtin/merge.c\ndiff --git a/builtin-mktag.c b/builtin/mktag.c\nsimilarity index 100%\nrename from builtin-mktag.c\nrename to builtin/mktag.c\ndiff --git a/builtin-mktree.c b/builtin/mktree.c\nsimilarity index 100%\nrename from builtin-mktree.c\nrename to builtin/mktree.c\ndiff --git a/builtin-mv.c b/builtin/mv.c\nsimilarity index 100%\nrename from builtin-mv.c\nrename to builtin/mv.c\ndiff --git a/builtin-name-rev.c b/builtin/name-rev.c\nsimilarity index 100%\nrename from builtin-name-rev.c\nrename to builtin/name-rev.c\ndiff --git a/builtin-pack-objects.c b/builtin/pack-objects.c\nsimilarity index 100%\nrename from builtin-pack-objects.c\nrename to builtin/pack-objects.c\ndiff --git a/builtin-pack-redundant.c b/builtin/pack-redundant.c\nsimilarity index 100%\nrename from builtin-pack-redundant.c\nrename to builtin/pack-redundant.c\ndiff --git a/builtin-pack-refs.c b/builtin/pack-refs.c\nsimilarity index 100%\nrename from builtin-pack-refs.c\nrename to builtin/pack-refs.c\ndiff --git a/builtin-patch-id.c b/builtin/patch-id.c\nsimilarity index 100%\nrename from builtin-patch-id.c\nrename to builtin/patch-id.c\ndiff --git a/builtin-prune-packed.c b/builtin/prune-packed.c\nsimilarity index 100%\nrename from builtin-prune-packed.c\nrename to builtin/prune-packed.c\ndiff --git a/builtin-prune.c b/builtin/prune.c\nsimilarity index 100%\nrename from builtin-prune.c\nrename to builtin/prune.c\ndiff --git a/builtin-push.c b/builtin/push.c\nsimilarity index 100%\nrename from builtin-push.c\nrename to builtin/push.c\ndiff --git a/builtin-read-tree.c b/builtin/read-tree.c\nsimilarity index 100%\nrename from builtin-read-tree.c\nrename to builtin/read-tree.c\ndiff --git a/builtin-receive-pack.c b/builtin/receive-pack.c\nsimilarity index 100%\nrename from builtin-receive-pack.c\nrename to builtin/receive-pack.c\ndiff --git a/builtin-reflog.c b/builtin/reflog.c\nsimilarity index 100%\nrename from builtin-reflog.c\nrename to builtin/reflog.c\ndiff --git a/builtin-remote.c b/builtin/remote.c\nsimilarity index 100%\nrename from builtin-remote.c\nrename to builtin/remote.c\ndiff --git a/builtin-replace.c b/builtin/replace.c\nsimilarity index 100%\nrename from builtin-replace.c\nrename to builtin/replace.c\ndiff --git a/builtin-rerere.c b/builtin/rerere.c\nsimilarity index 100%\nrename from builtin-rerere.c\nrename to builtin/rerere.c\ndiff --git a/builtin-reset.c b/builtin/reset.c\nsimilarity index 100%\nrename from builtin-reset.c\nrename to builtin/reset.c\ndiff --git a/builtin-rev-list.c b/builtin/rev-list.c\nsimilarity index 100%\nrename from builtin-rev-list.c\nrename to builtin/rev-list.c\ndiff --git a/builtin-rev-parse.c b/builtin/rev-parse.c\nsimilarity index 100%\nrename from builtin-rev-parse.c\nrename to builtin/rev-parse.c\ndiff --git a/builtin-revert.c b/builtin/revert.c\nsimilarity index 100%\nrename from builtin-revert.c\nrename to builtin/revert.c\ndiff --git a/builtin-rm.c b/builtin/rm.c\nsimilarity index 100%\nrename from builtin-rm.c\nrename to builtin/rm.c\ndiff --git a/builtin-send-pack.c b/builtin/send-pack.c\nsimilarity index 100%\nrename from builtin-send-pack.c\nrename to builtin/send-pack.c\ndiff --git a/builtin-shortlog.c b/builtin/shortlog.c\nsimilarity index 100%\nrename from builtin-shortlog.c\nrename to builtin/shortlog.c\ndiff --git a/builtin-show-branch.c b/builtin/show-branch.c\nsimilarity index 100%\nrename from builtin-show-branch.c\nrename to builtin/show-branch.c\ndiff --git a/builtin-show-ref.c b/builtin/show-ref.c\nsimilarity index 100%\nrename from builtin-show-ref.c\nrename to builtin/show-ref.c\ndiff --git a/builtin-stripspace.c b/builtin/stripspace.c\nsimilarity index 100%\nrename from builtin-stripspace.c\nrename to builtin/stripspace.c\ndiff --git a/builtin-symbolic-ref.c b/builtin/symbolic-ref.c\nsimilarity index 100%\nrename from builtin-symbolic-ref.c\nrename to builtin/symbolic-ref.c\ndiff --git a/builtin-tag.c b/builtin/tag.c\nsimilarity index 100%\nrename from builtin-tag.c\nrename to builtin/tag.c\ndiff --git a/builtin-tar-tree.c b/builtin/tar-tree.c\nsimilarity index 100%\nrename from builtin-tar-tree.c\nrename to builtin/tar-tree.c\ndiff --git a/builtin-unpack-file.c b/builtin/unpack-file.c\nsimilarity index 100%\nrename from builtin-unpack-file.c\nrename to builtin/unpack-file.c\ndiff --git a/builtin-unpack-objects.c b/builtin/unpack-objects.c\nsimilarity index 100%\nrename from builtin-unpack-objects.c\nrename to builtin/unpack-objects.c\ndiff --git a/builtin-update-index.c b/builtin/update-index.c\nsimilarity index 100%\nrename from builtin-update-index.c\nrename to builtin/update-index.c\ndiff --git a/builtin-update-ref.c b/builtin/update-ref.c\nsimilarity index 100%\nrename from builtin-update-ref.c\nrename to builtin/update-ref.c\ndiff --git a/builtin-update-server-info.c b/builtin/update-server-info.c\nsimilarity index 100%\nrename from builtin-update-server-info.c\nrename to builtin/update-server-info.c\ndiff --git a/builtin-upload-archive.c b/builtin/upload-archive.c\nsimilarity index 100%\nrename from builtin-upload-archive.c\nrename to builtin/upload-archive.c\ndiff --git a/builtin-var.c b/builtin/var.c\nsimilarity index 100%\nrename from builtin-var.c\nrename to builtin/var.c\ndiff --git a/builtin-verify-pack.c b/builtin/verify-pack.c\nsimilarity index 100%\nrename from builtin-verify-pack.c\nrename to builtin/verify-pack.c\ndiff --git a/builtin-verify-tag.c b/builtin/verify-tag.c\nsimilarity index 100%\nrename from builtin-verify-tag.c\nrename to builtin/verify-tag.c\ndiff --git a/builtin-write-tree.c b/builtin/write-tree.c\nsimilarity index 100%\nrename from builtin-write-tree.c\nrename to builtin/write-tree.c","expectedMessage":"Move \u0027builtin-*\u0027 into a \u0027builtin/\u0027 subdirectory","repository":"git-linus","commitHash":"81b50f3ce40bfdd66e5d967bf82be001039a9a98","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-3bb72562","diff":" Makefile                             |  2 +-\n index-pack.c \u003d\u003e builtin-index-pack.c | 16 +++++++---------\n builtin-pack-objects.c               |  5 +++--\n builtin.h                            |  1 +\n git.c                                |  1 +\n pack-write.c                         |  4 ++--\n pack.h                               |  2 +-\n 7 files changed, 16 insertions(+), 15 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex 33f9870886..c0dbee2ae4 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -388,7 +388,6 @@ EXTRA_PROGRAMS \u003d\n PROGRAMS +\u003d $(EXTRA_PROGRAMS)\n PROGRAMS +\u003d git-fast-import$X\n PROGRAMS +\u003d git-imap-send$X\n-PROGRAMS +\u003d git-index-pack$X\n PROGRAMS +\u003d git-shell$X\n PROGRAMS +\u003d git-show-index$X\n PROGRAMS +\u003d git-upload-pack$X\n@@ -653,6 +652,7 @@ BUILTIN_OBJS +\u003d builtin-gc.o\n BUILTIN_OBJS +\u003d builtin-grep.o\n BUILTIN_OBJS +\u003d builtin-hash-object.o\n BUILTIN_OBJS +\u003d builtin-help.o\n+BUILTIN_OBJS +\u003d builtin-index-pack.o\n BUILTIN_OBJS +\u003d builtin-init-db.o\n BUILTIN_OBJS +\u003d builtin-log.o\n BUILTIN_OBJS +\u003d builtin-ls-files.o\ndiff --git a/index-pack.c b/builtin-index-pack.c\nsimilarity index 98%\nrename from index-pack.c\nrename to builtin-index-pack.c\nindex 190f372dd8..b4cf8c53e0 100644\n--- a/index-pack.c\n+++ b/builtin-index-pack.c\n@@ -166,7 +166,7 @@ static void use(int bytes)\n \tconsumed_bytes +\u003d bytes;\n }\n \n-static char *open_pack_file(char *pack_name)\n+static const char *open_pack_file(const char *pack_name)\n {\n \tif (from_stdin) {\n \t\tinput_fd \u003d 0;\n@@ -870,18 +870,16 @@ static int git_index_pack_config(const char *k, const char *v, void *cb)\n \treturn git_default_config(k, v, cb);\n }\n \n-int main(int argc, char **argv)\n+int cmd_index_pack(int argc, const char **argv, const char *prefix)\n {\n \tint i, fix_thin_pack \u003d 0;\n-\tchar *curr_pack, *pack_name \u003d NULL;\n-\tchar *curr_index, *index_name \u003d NULL;\n+\tconst char *curr_pack, *curr_index;\n+\tconst char *index_name \u003d NULL, *pack_name \u003d NULL;\n \tconst char *keep_name \u003d NULL, *keep_msg \u003d NULL;\n \tchar *index_name_buf \u003d NULL, *keep_name_buf \u003d NULL;\n \tstruct pack_idx_entry **idx_objects;\n \tunsigned char pack_sha1[20];\n \n-\tgit_extract_argv0_path(argv[0]);\n-\n \tif (argc \u003d\u003d 2 \u0026\u0026 !strcmp(argv[1], \"-h\"))\n \t\tusage(index_pack_usage);\n \n@@ -906,7 +904,7 @@ int main(int argc, char **argv)\n \t}\n \n \tfor (i \u003d 1; i \u003c argc; i++) {\n-\t\tchar *arg \u003d argv[i];\n+\t\tconst char *arg \u003d argv[i];\n \n \t\tif (*arg \u003d\u003d \u0027-\u0027) {\n \t\t\tif (!strcmp(arg, \"--stdin\")) {\n@@ -1039,9 +1037,9 @@ int main(int argc, char **argv)\n \tfree(index_name_buf);\n \tfree(keep_name_buf);\n \tif (pack_name \u003d\u003d NULL)\n-\t\tfree(curr_pack);\n+\t\tfree((void *) curr_pack);\n \tif (index_name \u003d\u003d NULL)\n-\t\tfree(curr_index);\n+\t\tfree((void *) curr_index);\n \n \treturn 0;\n }\ndiff --git a/builtin-pack-objects.c b/builtin-pack-objects.c\nindex 59b07fe491..b0887d759d 100644\n--- a/builtin-pack-objects.c\n+++ b/builtin-pack-objects.c\n@@ -525,7 +525,8 @@ static void write_pack_file(void)\n \t\tif (!pack_to_stdout) {\n \t\t\tmode_t mode \u003d umask(0);\n \t\t\tstruct stat st;\n-\t\t\tchar *idx_tmp_name, tmpname[PATH_MAX];\n+\t\t\tconst char *idx_tmp_name;\n+\t\t\tchar tmpname[PATH_MAX];\n \n \t\t\tumask(mode);\n \t\t\tmode \u003d 0444 \u0026 ~mode;\n@@ -569,7 +570,7 @@ static void write_pack_file(void)\n \t\t\tif (rename(idx_tmp_name, tmpname))\n \t\t\t\tdie_errno(\"unable to rename temporary index file\");\n \n-\t\t\tfree(idx_tmp_name);\n+\t\t\tfree((void *) idx_tmp_name);\n \t\t\tfree(pack_tmp_name);\n \t\t\tputs(sha1_to_hex(sha1));\n \t\t}\ndiff --git a/builtin.h b/builtin.h\nindex bd7f737485..e8202f3f5e 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -58,6 +58,7 @@ extern int cmd_grep(int argc, const char **argv, const char *prefix);\n extern int cmd_hash_object(int argc, const char **argv, const char *prefix);\n extern int cmd_help(int argc, const char **argv, const char *prefix);\n extern int cmd_http_fetch(int argc, const char **argv, const char *prefix);\n+extern int cmd_index_pack(int argc, const char **argv, const char *prefix);\n extern int cmd_init_db(int argc, const char **argv, const char *prefix);\n extern int cmd_log(int argc, const char **argv, const char *prefix);\n extern int cmd_log_reflog(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex 6cc1eba29e..b3e23f1044 100644\n--- a/git.c\n+++ b/git.c\n@@ -320,6 +320,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"grep\", cmd_grep, USE_PAGER },\n \t\t{ \"hash-object\", cmd_hash_object },\n \t\t{ \"help\", cmd_help },\n+\t\t{ \"index-pack\", cmd_index_pack },\n \t\t{ \"init\", cmd_init_db },\n \t\t{ \"init-db\", cmd_init_db },\n \t\t{ \"log\", cmd_log, RUN_SETUP | USE_PAGER },\ndiff --git a/pack-write.c b/pack-write.c\nindex 741efcd93b..9f47cf9961 100644\n--- a/pack-write.c\n+++ b/pack-write.c\n@@ -17,8 +17,8 @@ static int sha1_compare(const void *_a, const void *_b)\n  * the SHA1 hash of sorted object names. The objects array passed in\n  * will be sorted by SHA1 on exit.\n  */\n-char *write_idx_file(char *index_name, struct pack_idx_entry **objects,\n-\t\t     int nr_objects, unsigned char *sha1)\n+const char *write_idx_file(const char *index_name, struct pack_idx_entry **objects,\n+\t\t\t   int nr_objects, unsigned char *sha1)\n {\n \tstruct sha1file *f;\n \tstruct pack_idx_entry **sorted_by_sha, **list, **last;\ndiff --git a/pack.h b/pack.h\nindex a883334b26..b759a23d4d 100644\n--- a/pack.h\n+++ b/pack.h\n@@ -55,7 +55,7 @@ struct pack_idx_entry {\n \toff_t offset;\n };\n \n-extern char *write_idx_file(char *index_name, struct pack_idx_entry **objects, int nr_objects, unsigned char *sha1);\n+extern const char *write_idx_file(const char *index_name, struct pack_idx_entry **objects, int nr_objects, unsigned char *sha1);\n extern int check_pack_crc(struct packed_git *p, struct pack_window **w_curs, off_t offset, off_t len, unsigned int nr);\n extern int verify_pack(struct packed_git *);\n extern void fixup_pack_header_footer(int, unsigned char *, const char *, uint32_t, unsigned char *, off_t);","expectedMessage":"make \"index-pack\" a built-in","repository":"git-linus","commitHash":"3bb7256281bb1d291bb705a57dc3f30b26b7c127","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-377d0276","diff":" Makefile                                     | 2 +-\n pack-redundant.c \u003d\u003e builtin-pack-redundant.c | 8 ++------\n builtin.h                                    | 1 +\n git.c                                        | 1 +\n 4 files changed, 5 insertions(+), 7 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex 88e2f8fd49..33f9870886 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -389,7 +389,6 @@ PROGRAMS +\u003d $(EXTRA_PROGRAMS)\n PROGRAMS +\u003d git-fast-import$X\n PROGRAMS +\u003d git-imap-send$X\n PROGRAMS +\u003d git-index-pack$X\n-PROGRAMS +\u003d git-pack-redundant$X\n PROGRAMS +\u003d git-shell$X\n PROGRAMS +\u003d git-show-index$X\n PROGRAMS +\u003d git-upload-pack$X\n@@ -673,6 +672,7 @@ BUILTIN_OBJS +\u003d builtin-mktree.o\n BUILTIN_OBJS +\u003d builtin-mv.o\n BUILTIN_OBJS +\u003d builtin-name-rev.o\n BUILTIN_OBJS +\u003d builtin-pack-objects.o\n+BUILTIN_OBJS +\u003d builtin-pack-redundant.o\n BUILTIN_OBJS +\u003d builtin-pack-refs.o\n BUILTIN_OBJS +\u003d builtin-patch-id.o\n BUILTIN_OBJS +\u003d builtin-prune-packed.o\ndiff --git a/pack-redundant.c b/builtin-pack-redundant.c\nsimilarity index 99%\nrename from pack-redundant.c\nrename to builtin-pack-redundant.c\nindex 21c61dbbe9..41e1615a28 100644\n--- a/pack-redundant.c\n+++ b/builtin-pack-redundant.c\n@@ -568,7 +568,7 @@ static struct pack_list * add_pack(struct packed_git *p)\n \t\treturn pack_list_insert(\u0026altodb_packs, \u0026l);\n }\n \n-static struct pack_list * add_pack_file(char *filename)\n+static struct pack_list * add_pack_file(const char *filename)\n {\n \tstruct packed_git *p \u003d packed_git;\n \n@@ -593,7 +593,7 @@ static void load_all(void)\n \t}\n }\n \n-int main(int argc, char **argv)\n+int cmd_pack_redundant(int argc, const char **argv, const char *prefix)\n {\n \tint i;\n \tstruct pack_list *min, *red, *pl;\n@@ -601,13 +601,9 @@ int main(int argc, char **argv)\n \tunsigned char *sha1;\n \tchar buf[42]; /* 40 byte sha1 + \\n + \\0 */\n \n-\tgit_extract_argv0_path(argv[0]);\n-\n \tif (argc \u003d\u003d 2 \u0026\u0026 !strcmp(argv[1], \"-h\"))\n \t\tusage(pack_redundant_usage);\n \n-\tsetup_git_directory();\n-\n \tfor (i \u003d 1; i \u003c argc; i++) {\n \t\tconst char *arg \u003d argv[i];\n \t\tif (!strcmp(arg, \"--\")) {\ndiff --git a/builtin.h b/builtin.h\nindex d4fec89a15..bd7f737485 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -78,6 +78,7 @@ extern int cmd_mktree(int argc, const char **argv, const char *prefix);\n extern int cmd_mv(int argc, const char **argv, const char *prefix);\n extern int cmd_name_rev(int argc, const char **argv, const char *prefix);\n extern int cmd_pack_objects(int argc, const char **argv, const char *prefix);\n+extern int cmd_pack_redundant(int argc, const char **argv, const char *prefix);\n extern int cmd_patch_id(int argc, const char **argv, const char *prefix);\n extern int cmd_pickaxe(int argc, const char **argv, const char *prefix);\n extern int cmd_prune(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex 832bd2d535..6cc1eba29e 100644\n--- a/git.c\n+++ b/git.c\n@@ -343,6 +343,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"mv\", cmd_mv, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"name-rev\", cmd_name_rev, RUN_SETUP },\n \t\t{ \"pack-objects\", cmd_pack_objects, RUN_SETUP },\n+\t\t{ \"pack-redundant\", cmd_pack_redundant, RUN_SETUP },\n \t\t{ \"patch-id\", cmd_patch_id },\n \t\t{ \"peek-remote\", cmd_ls_remote },\n \t\t{ \"pickaxe\", cmd_blame, RUN_SETUP },","expectedMessage":"make \"git pack-redundant\" a built-in","repository":"git-linus","commitHash":"377d0276ca7446ce9fb2f6987b1e6b4ba9e7cf29","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-b5325818","diff":" Makefile                               | 2 +-\n unpack-file.c \u003d\u003e builtin-unpack-file.c | 5 +----\n builtin.h                              | 1 +\n git.c                                  | 1 +\n 4 files changed, 4 insertions(+), 5 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex c5a1190ebe..88e2f8fd49 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -392,7 +392,6 @@ PROGRAMS +\u003d git-index-pack$X\n PROGRAMS +\u003d git-pack-redundant$X\n PROGRAMS +\u003d git-shell$X\n PROGRAMS +\u003d git-show-index$X\n-PROGRAMS +\u003d git-unpack-file$X\n PROGRAMS +\u003d git-upload-pack$X\n PROGRAMS +\u003d git-http-backend$X\n \n@@ -698,6 +697,7 @@ BUILTIN_OBJS +\u003d builtin-stripspace.o\n BUILTIN_OBJS +\u003d builtin-symbolic-ref.o\n BUILTIN_OBJS +\u003d builtin-tag.o\n BUILTIN_OBJS +\u003d builtin-tar-tree.o\n+BUILTIN_OBJS +\u003d builtin-unpack-file.o\n BUILTIN_OBJS +\u003d builtin-unpack-objects.o\n BUILTIN_OBJS +\u003d builtin-update-index.o\n BUILTIN_OBJS +\u003d builtin-update-ref.o\ndiff --git a/unpack-file.c b/builtin-unpack-file.c\nsimilarity index 89%\nrename from unpack-file.c\nrename to builtin-unpack-file.c\nindex e9d8934691..608590ada8 100644\n--- a/unpack-file.c\n+++ b/builtin-unpack-file.c\n@@ -22,18 +22,15 @@ static char *create_temp_file(unsigned char *sha1)\n \treturn path;\n }\n \n-int main(int argc, char **argv)\n+int cmd_unpack_file(int argc, const char **argv, const char *prefix)\n {\n \tunsigned char sha1[20];\n \n-\tgit_extract_argv0_path(argv[0]);\n-\n \tif (argc !\u003d 2 || !strcmp(argv[1], \"-h\"))\n \t\tusage(\"git unpack-file \u003csha1\u003e\");\n \tif (get_sha1(argv[1], sha1))\n \t\tdie(\"Not a valid object name %s\", argv[1]);\n \n-\tsetup_git_directory();\n \tgit_config(git_default_config, NULL);\n \n \tputs(create_temp_file(sha1));\ndiff --git a/builtin.h b/builtin.h\nindex 2aaef74e02..d4fec89a15 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -103,6 +103,7 @@ extern int cmd_stripspace(int argc, const char **argv, const char *prefix);\n extern int cmd_symbolic_ref(int argc, const char **argv, const char *prefix);\n extern int cmd_tag(int argc, const char **argv, const char *prefix);\n extern int cmd_tar_tree(int argc, const char **argv, const char *prefix);\n+extern int cmd_unpack_file(int argc, const char **argv, const char *prefix);\n extern int cmd_unpack_objects(int argc, const char **argv, const char *prefix);\n extern int cmd_update_index(int argc, const char **argv, const char *prefix);\n extern int cmd_update_ref(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex 0b8f8a731e..832bd2d535 100644\n--- a/git.c\n+++ b/git.c\n@@ -370,6 +370,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"symbolic-ref\", cmd_symbolic_ref, RUN_SETUP },\n \t\t{ \"tag\", cmd_tag, RUN_SETUP },\n \t\t{ \"tar-tree\", cmd_tar_tree },\n+\t\t{ \"unpack-file\", cmd_unpack_file, RUN_SETUP },\n \t\t{ \"unpack-objects\", cmd_unpack_objects, RUN_SETUP },\n \t\t{ \"update-index\", cmd_update_index, RUN_SETUP },\n \t\t{ \"update-ref\", cmd_update_ref, RUN_SETUP },","expectedMessage":"make \"git unpack-file\" a built-in","repository":"git-linus","commitHash":"b53258182bf90b4fb922a20d164a02e6f0e9afd1","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-112dd514","diff":" Makefile                   | 2 +-\n mktag.c \u003d\u003e builtin-mktag.c | 6 +-----\n builtin.h                  | 1 +\n git.c                      | 1 +\n 4 files changed, 4 insertions(+), 6 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex 70ac4b3e23..c5a1190ebe 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -389,7 +389,6 @@ PROGRAMS +\u003d $(EXTRA_PROGRAMS)\n PROGRAMS +\u003d git-fast-import$X\n PROGRAMS +\u003d git-imap-send$X\n PROGRAMS +\u003d git-index-pack$X\n-PROGRAMS +\u003d git-mktag$X\n PROGRAMS +\u003d git-pack-redundant$X\n PROGRAMS +\u003d git-shell$X\n PROGRAMS +\u003d git-show-index$X\n@@ -670,6 +669,7 @@ BUILTIN_OBJS +\u003d builtin-merge-index.o\n BUILTIN_OBJS +\u003d builtin-merge-ours.o\n BUILTIN_OBJS +\u003d builtin-merge-recursive.o\n BUILTIN_OBJS +\u003d builtin-merge-tree.o\n+BUILTIN_OBJS +\u003d builtin-mktag.o\n BUILTIN_OBJS +\u003d builtin-mktree.o\n BUILTIN_OBJS +\u003d builtin-mv.o\n BUILTIN_OBJS +\u003d builtin-name-rev.o\ndiff --git a/mktag.c b/builtin-mktag.c\nsimilarity index 98%\nrename from mktag.c\nrename to builtin-mktag.c\nindex a3b4270c18..1cb0f3f2a7 100644\n--- a/mktag.c\n+++ b/builtin-mktag.c\n@@ -153,7 +153,7 @@ static int verify_tag(char *buffer, unsigned long size)\n \n #undef PD_FMT\n \n-int main(int argc, char **argv)\n+int cmd_mktag(int argc, const char **argv, const char *prefix)\n {\n \tstruct strbuf buf \u003d STRBUF_INIT;\n \tunsigned char result_sha1[20];\n@@ -161,10 +161,6 @@ int main(int argc, char **argv)\n \tif (argc !\u003d 1)\n \t\tusage(\"git mktag \u003c signaturefile\");\n \n-\tgit_extract_argv0_path(argv[0]);\n-\n-\tsetup_git_directory();\n-\n \tif (strbuf_read(\u0026buf, 0, 4096) \u003c 0) {\n \t\tdie_errno(\"could not read from stdin\");\n \t}\ndiff --git a/builtin.h b/builtin.h\nindex e961b33424..2aaef74e02 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -73,6 +73,7 @@ extern int cmd_merge_ours(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_file(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_recursive(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_tree(int argc, const char **argv, const char *prefix);\n+extern int cmd_mktag(int argc, const char **argv, const char *prefix);\n extern int cmd_mktree(int argc, const char **argv, const char *prefix);\n extern int cmd_mv(int argc, const char **argv, const char *prefix);\n extern int cmd_name_rev(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex eae12e32ea..0b8f8a731e 100644\n--- a/git.c\n+++ b/git.c\n@@ -338,6 +338,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"merge-recursive-theirs\", cmd_merge_recursive, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"merge-subtree\", cmd_merge_recursive, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"merge-tree\", cmd_merge_tree, RUN_SETUP },\n+\t\t{ \"mktag\", cmd_mktag, RUN_SETUP },\n \t\t{ \"mktree\", cmd_mktree, RUN_SETUP },\n \t\t{ \"mv\", cmd_mv, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"name-rev\", cmd_name_rev, RUN_SETUP },","expectedMessage":"make \"mktag\" a built-in","repository":"git-linus","commitHash":"112dd5146589ecb76d52bf349bd51dbe2936e936","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-0ecace72","diff":" Makefile                               | 2 +-\n merge-index.c \u003d\u003e builtin-merge-index.c | 7 ++-----\n builtin.h                              | 1 +\n git.c                                  | 1 +\n 4 files changed, 5 insertions(+), 6 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex e1c7ae5850..70ac4b3e23 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -389,7 +389,6 @@ PROGRAMS +\u003d $(EXTRA_PROGRAMS)\n PROGRAMS +\u003d git-fast-import$X\n PROGRAMS +\u003d git-imap-send$X\n PROGRAMS +\u003d git-index-pack$X\n-PROGRAMS +\u003d git-merge-index$X\n PROGRAMS +\u003d git-mktag$X\n PROGRAMS +\u003d git-pack-redundant$X\n PROGRAMS +\u003d git-shell$X\n@@ -667,6 +666,7 @@ BUILTIN_OBJS +\u003d builtin-mailsplit.o\n BUILTIN_OBJS +\u003d builtin-merge.o\n BUILTIN_OBJS +\u003d builtin-merge-base.o\n BUILTIN_OBJS +\u003d builtin-merge-file.o\n+BUILTIN_OBJS +\u003d builtin-merge-index.o\n BUILTIN_OBJS +\u003d builtin-merge-ours.o\n BUILTIN_OBJS +\u003d builtin-merge-recursive.o\n BUILTIN_OBJS +\u003d builtin-merge-tree.o\ndiff --git a/merge-index.c b/builtin-merge-index.c\nsimilarity index 94%\nrename from merge-index.c\nrename to builtin-merge-index.c\nindex 19ddd03e0b..2c4cf5e559 100644\n--- a/merge-index.c\n+++ b/builtin-merge-index.c\n@@ -66,7 +66,7 @@ static void merge_all(void)\n \t}\n }\n \n-int main(int argc, char **argv)\n+int cmd_merge_index(int argc, const char **argv, const char *prefix)\n {\n \tint i, force_file \u003d 0;\n \n@@ -78,9 +78,6 @@ int main(int argc, char **argv)\n \tif (argc \u003c 3)\n \t\tusage(\"git merge-index [-o] [-q] \u003cmerge-program\u003e (-a | [--] \u003cfilename\u003e*)\");\n \n-\tgit_extract_argv0_path(argv[0]);\n-\n-\tsetup_git_directory();\n \tread_cache();\n \n \ti \u003d 1;\n@@ -94,7 +91,7 @@ int main(int argc, char **argv)\n \t}\n \tpgm \u003d argv[i++];\n \tfor (; i \u003c argc; i++) {\n-\t\tchar *arg \u003d argv[i];\n+\t\tconst char *arg \u003d argv[i];\n \t\tif (!force_file \u0026\u0026 *arg \u003d\u003d \u0027-\u0027) {\n \t\t\tif (!strcmp(arg, \"--\")) {\n \t\t\t\tforce_file \u003d 1;\ndiff --git a/builtin.h b/builtin.h\nindex cb8489f97e..e961b33424 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -68,6 +68,7 @@ extern int cmd_mailinfo(int argc, const char **argv, const char *prefix);\n extern int cmd_mailsplit(int argc, const char **argv, const char *prefix);\n extern int cmd_merge(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_base(int argc, const char **argv, const char *prefix);\n+extern int cmd_merge_index(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_ours(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_file(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_recursive(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex b60999ca9e..eae12e32ea 100644\n--- a/git.c\n+++ b/git.c\n@@ -331,6 +331,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"merge\", cmd_merge, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"merge-base\", cmd_merge_base, RUN_SETUP },\n \t\t{ \"merge-file\", cmd_merge_file },\n+\t\t{ \"merge-index\", cmd_merge_index, RUN_SETUP },\n \t\t{ \"merge-ours\", cmd_merge_ours, RUN_SETUP },\n \t\t{ \"merge-recursive\", cmd_merge_recursive, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"merge-recursive-ours\", cmd_merge_recursive, RUN_SETUP | NEED_WORK_TREE },","expectedMessage":"make \"merge-index\" a built-in","repository":"git-linus","commitHash":"0ecace728f8e48b87f81433b053d7f277f22e674","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-dedc0ec5","diff":" Makefile                         | 2 +-\n patch-id.c \u003d\u003e builtin-patch-id.c | 4 +---\n builtin.h                        | 1 +\n git.c                            | 1 +\n 4 files changed, 4 insertions(+), 4 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex 4558c4627b..e1c7ae5850 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -392,7 +392,6 @@ PROGRAMS +\u003d git-index-pack$X\n PROGRAMS +\u003d git-merge-index$X\n PROGRAMS +\u003d git-mktag$X\n PROGRAMS +\u003d git-pack-redundant$X\n-PROGRAMS +\u003d git-patch-id$X\n PROGRAMS +\u003d git-shell$X\n PROGRAMS +\u003d git-show-index$X\n PROGRAMS +\u003d git-unpack-file$X\n@@ -676,6 +675,7 @@ BUILTIN_OBJS +\u003d builtin-mv.o\n BUILTIN_OBJS +\u003d builtin-name-rev.o\n BUILTIN_OBJS +\u003d builtin-pack-objects.o\n BUILTIN_OBJS +\u003d builtin-pack-refs.o\n+BUILTIN_OBJS +\u003d builtin-patch-id.o\n BUILTIN_OBJS +\u003d builtin-prune-packed.o\n BUILTIN_OBJS +\u003d builtin-prune.o\n BUILTIN_OBJS +\u003d builtin-push.o\ndiff --git a/patch-id.c b/builtin-patch-id.c\nsimilarity index 95%\nrename from patch-id.c\nrename to builtin-patch-id.c\nindex 0df4cb086b..af0911e4bd 100644\n--- a/patch-id.c\n+++ b/builtin-patch-id.c\n@@ -75,13 +75,11 @@ static void generate_id_list(void)\n \n static const char patch_id_usage[] \u003d \"git patch-id \u003c patch\";\n \n-int main(int argc, char **argv)\n+int cmd_patch_id(int argc, const char **argv, const char *prefix)\n {\n \tif (argc !\u003d 1)\n \t\tusage(patch_id_usage);\n \n-\tgit_extract_argv0_path(argv[0]);\n-\n \tgenerate_id_list();\n \treturn 0;\n }\ndiff --git a/builtin.h b/builtin.h\nindex 2d95c3b2fe..cb8489f97e 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -76,6 +76,7 @@ extern int cmd_mktree(int argc, const char **argv, const char *prefix);\n extern int cmd_mv(int argc, const char **argv, const char *prefix);\n extern int cmd_name_rev(int argc, const char **argv, const char *prefix);\n extern int cmd_pack_objects(int argc, const char **argv, const char *prefix);\n+extern int cmd_patch_id(int argc, const char **argv, const char *prefix);\n extern int cmd_pickaxe(int argc, const char **argv, const char *prefix);\n extern int cmd_prune(int argc, const char **argv, const char *prefix);\n extern int cmd_prune_packed(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex cf7dd5d26c..b60999ca9e 100644\n--- a/git.c\n+++ b/git.c\n@@ -341,6 +341,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"mv\", cmd_mv, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"name-rev\", cmd_name_rev, RUN_SETUP },\n \t\t{ \"pack-objects\", cmd_pack_objects, RUN_SETUP },\n+\t\t{ \"patch-id\", cmd_patch_id },\n \t\t{ \"peek-remote\", cmd_ls_remote },\n \t\t{ \"pickaxe\", cmd_blame, RUN_SETUP },\n \t\t{ \"prune\", cmd_prune, RUN_SETUP },","expectedMessage":"make \"git patch-id\" a built-in","repository":"git-linus","commitHash":"dedc0ec5d778214528dae3bddf60d77cfcde4bd4","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-55b6745d","diff":" Makefile               | 2 +-\n var.c \u003d\u003e builtin-var.c | 4 +---\n builtin.h              | 1 +\n git.c                  | 1 +\n 4 files changed, 4 insertions(+), 4 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex 6e7431e5b3..4558c4627b 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -397,7 +397,6 @@ PROGRAMS +\u003d git-shell$X\n PROGRAMS +\u003d git-show-index$X\n PROGRAMS +\u003d git-unpack-file$X\n PROGRAMS +\u003d git-upload-pack$X\n-PROGRAMS +\u003d git-var$X\n PROGRAMS +\u003d git-http-backend$X\n \n # List built-in command $C whose implementation cmd_$C() is not in\n@@ -704,6 +703,7 @@ BUILTIN_OBJS +\u003d builtin-update-index.o\n BUILTIN_OBJS +\u003d builtin-update-ref.o\n BUILTIN_OBJS +\u003d builtin-update-server-info.o\n BUILTIN_OBJS +\u003d builtin-upload-archive.o\n+BUILTIN_OBJS +\u003d builtin-var.o\n BUILTIN_OBJS +\u003d builtin-verify-pack.o\n BUILTIN_OBJS +\u003d builtin-verify-tag.o\n BUILTIN_OBJS +\u003d builtin-write-tree.o\ndiff --git a/var.c b/builtin-var.c\nsimilarity index 96%\nrename from var.c\nrename to builtin-var.c\nindex d9892f85ce..2280518190 100644\n--- a/var.c\n+++ b/builtin-var.c\n@@ -72,7 +72,7 @@ static int show_config(const char *var, const char *value, void *cb)\n \treturn git_default_config(var, value, cb);\n }\n \n-int main(int argc, char **argv)\n+int cmd_var(int argc, const char **argv, const char *prefix)\n {\n \tconst char *val;\n \tint nongit;\n@@ -80,8 +80,6 @@ int main(int argc, char **argv)\n \t\tusage(var_usage);\n \t}\n \n-\tgit_extract_argv0_path(argv[0]);\n-\n \tsetup_git_directory_gently(\u0026nongit);\n \tval \u003d NULL;\n \ndiff --git a/builtin.h b/builtin.h\nindex f525e92a28..2d95c3b2fe 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -106,6 +106,7 @@ extern int cmd_update_ref(int argc, const char **argv, const char *prefix);\n extern int cmd_update_server_info(int argc, const char **argv, const char *prefix);\n extern int cmd_upload_archive(int argc, const char **argv, const char *prefix);\n extern int cmd_upload_tar(int argc, const char **argv, const char *prefix);\n+extern int cmd_var(int argc, const char **argv, const char *prefix);\n extern int cmd_verify_tag(int argc, const char **argv, const char *prefix);\n extern int cmd_version(int argc, const char **argv, const char *prefix);\n extern int cmd_whatchanged(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex c13ec72731..cf7dd5d26c 100644\n--- a/git.c\n+++ b/git.c\n@@ -372,6 +372,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"update-ref\", cmd_update_ref, RUN_SETUP },\n \t\t{ \"update-server-info\", cmd_update_server_info, RUN_SETUP },\n \t\t{ \"upload-archive\", cmd_upload_archive },\n+\t\t{ \"var\", cmd_var },\n \t\t{ \"verify-tag\", cmd_verify_tag, RUN_SETUP },\n \t\t{ \"version\", cmd_version },\n \t\t{ \"whatchanged\", cmd_whatchanged, RUN_SETUP | USE_PAGER },","expectedMessage":"make \"git var\" a built-in","repository":"git-linus","commitHash":"55b6745d633b9501576eb02183da0b0fb1cee964","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-b28a1ce0","diff":" Makefile                               | 2 +-\n hash-object.c \u003d\u003e builtin-hash-object.c | 5 +----\n builtin.h                              | 1 +\n git.c                                  | 1 +\n 4 files changed, 4 insertions(+), 5 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex 969adc7e20..6e7431e5b3 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -387,7 +387,6 @@ EXTRA_PROGRAMS \u003d\n # ... and all the rest that could be moved out of bindir to gitexecdir\n PROGRAMS +\u003d $(EXTRA_PROGRAMS)\n PROGRAMS +\u003d git-fast-import$X\n-PROGRAMS +\u003d git-hash-object$X\n PROGRAMS +\u003d git-imap-send$X\n PROGRAMS +\u003d git-index-pack$X\n PROGRAMS +\u003d git-merge-index$X\n@@ -658,6 +657,7 @@ BUILTIN_OBJS +\u003d builtin-for-each-ref.o\n BUILTIN_OBJS +\u003d builtin-fsck.o\n BUILTIN_OBJS +\u003d builtin-gc.o\n BUILTIN_OBJS +\u003d builtin-grep.o\n+BUILTIN_OBJS +\u003d builtin-hash-object.o\n BUILTIN_OBJS +\u003d builtin-help.o\n BUILTIN_OBJS +\u003d builtin-init-db.o\n BUILTIN_OBJS +\u003d builtin-log.o\ndiff --git a/hash-object.c b/builtin-hash-object.c\nsimilarity index 97%\nrename from hash-object.c\nrename to builtin-hash-object.c\nindex 9455dd0709..6a5f5b5f0e 100644\n--- a/hash-object.c\n+++ b/builtin-hash-object.c\n@@ -73,17 +73,14 @@ static const struct option hash_object_options[] \u003d {\n \tOPT_END()\n };\n \n-int main(int argc, const char **argv)\n+int cmd_hash_object(int argc, const char **argv, const char *prefix)\n {\n \tint i;\n-\tconst char *prefix \u003d NULL;\n \tint prefix_length \u003d -1;\n \tconst char *errstr \u003d NULL;\n \n \ttype \u003d blob_type;\n \n-\tgit_extract_argv0_path(argv[0]);\n-\n \targc \u003d parse_options(argc, argv, NULL, hash_object_options,\n \t\t\t     hash_object_usage, 0);\n \ndiff --git a/builtin.h b/builtin.h\nindex 0936ad2667..f525e92a28 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -55,6 +55,7 @@ extern int cmd_fsck(int argc, const char **argv, const char *prefix);\n extern int cmd_gc(int argc, const char **argv, const char *prefix);\n extern int cmd_get_tar_commit_id(int argc, const char **argv, const char *prefix);\n extern int cmd_grep(int argc, const char **argv, const char *prefix);\n+extern int cmd_hash_object(int argc, const char **argv, const char *prefix);\n extern int cmd_help(int argc, const char **argv, const char *prefix);\n extern int cmd_http_fetch(int argc, const char **argv, const char *prefix);\n extern int cmd_init_db(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex 15b13bd1b9..c13ec72731 100644\n--- a/git.c\n+++ b/git.c\n@@ -318,6 +318,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"gc\", cmd_gc, RUN_SETUP },\n \t\t{ \"get-tar-commit-id\", cmd_get_tar_commit_id },\n \t\t{ \"grep\", cmd_grep, USE_PAGER },\n+\t\t{ \"hash-object\", cmd_hash_object },\n \t\t{ \"help\", cmd_help },\n \t\t{ \"init\", cmd_init_db },\n \t\t{ \"init-db\", cmd_init_db },","expectedMessage":"make \"git hash-object\" a built-in","repository":"git-linus","commitHash":"b28a1ce04cdafbd3b470ec43c0f562054bd45d4d","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-907a7cb5","diff":" Makefile                             | 2 +-\n merge-tree.c \u003d\u003e builtin-merge-tree.c | 4 +---\n builtin.h                            | 1 +\n git.c                                | 1 +\n 4 files changed, 4 insertions(+), 4 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex a041b69561..969adc7e20 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -391,7 +391,6 @@ PROGRAMS +\u003d git-hash-object$X\n PROGRAMS +\u003d git-imap-send$X\n PROGRAMS +\u003d git-index-pack$X\n PROGRAMS +\u003d git-merge-index$X\n-PROGRAMS +\u003d git-merge-tree$X\n PROGRAMS +\u003d git-mktag$X\n PROGRAMS +\u003d git-pack-redundant$X\n PROGRAMS +\u003d git-patch-id$X\n@@ -672,6 +671,7 @@ BUILTIN_OBJS +\u003d builtin-merge-base.o\n BUILTIN_OBJS +\u003d builtin-merge-file.o\n BUILTIN_OBJS +\u003d builtin-merge-ours.o\n BUILTIN_OBJS +\u003d builtin-merge-recursive.o\n+BUILTIN_OBJS +\u003d builtin-merge-tree.o\n BUILTIN_OBJS +\u003d builtin-mktree.o\n BUILTIN_OBJS +\u003d builtin-mv.o\n BUILTIN_OBJS +\u003d builtin-name-rev.o\ndiff --git a/merge-tree.c b/builtin-merge-tree.c\nsimilarity index 99%\nrename from merge-tree.c\nrename to builtin-merge-tree.c\nindex 37b94d976c..8e16c3edad 100644\n--- a/merge-tree.c\n+++ b/builtin-merge-tree.c\n@@ -337,7 +337,7 @@ static void *get_tree_descriptor(struct tree_desc *desc, const char *rev)\n \treturn buf;\n }\n \n-int main(int argc, char **argv)\n+int cmd_merge_tree(int argc, const char **argv, const char *prefix)\n {\n \tstruct tree_desc t[3];\n \tvoid *buf1, *buf2, *buf3;\n@@ -347,8 +347,6 @@ int main(int argc, char **argv)\n \n \tgit_extract_argv0_path(argv[0]);\n \n-\tsetup_git_directory();\n-\n \tbuf1 \u003d get_tree_descriptor(t+0, argv[1]);\n \tbuf2 \u003d get_tree_descriptor(t+1, argv[2]);\n \tbuf3 \u003d get_tree_descriptor(t+2, argv[3]);\ndiff --git a/builtin.h b/builtin.h\nindex c3f83c093f..0936ad2667 100644\n--- a/builtin.h\n+++ b/builtin.h\n@@ -70,6 +70,7 @@ extern int cmd_merge_base(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_ours(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_file(int argc, const char **argv, const char *prefix);\n extern int cmd_merge_recursive(int argc, const char **argv, const char *prefix);\n+extern int cmd_merge_tree(int argc, const char **argv, const char *prefix);\n extern int cmd_mktree(int argc, const char **argv, const char *prefix);\n extern int cmd_mv(int argc, const char **argv, const char *prefix);\n extern int cmd_name_rev(int argc, const char **argv, const char *prefix);\ndiff --git a/git.c b/git.c\nindex 194471f5b1..15b13bd1b9 100644\n--- a/git.c\n+++ b/git.c\n@@ -335,6 +335,7 @@ static void handle_internal_command(int argc, const char **argv)\n \t\t{ \"merge-recursive-ours\", cmd_merge_recursive, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"merge-recursive-theirs\", cmd_merge_recursive, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"merge-subtree\", cmd_merge_recursive, RUN_SETUP | NEED_WORK_TREE },\n+\t\t{ \"merge-tree\", cmd_merge_tree, RUN_SETUP },\n \t\t{ \"mktree\", cmd_mktree, RUN_SETUP },\n \t\t{ \"mv\", cmd_mv, RUN_SETUP | NEED_WORK_TREE },\n \t\t{ \"name-rev\", cmd_name_rev, RUN_SETUP },","expectedMessage":"make \"git merge-tree\" a built-in","repository":"git-linus","commitHash":"907a7cb51c6c44d25f4c734a46d5174363190a84","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-a5031214","diff":" Makefile     |  1 +\n hex.c        | 67 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n sha1_file.c  | 66 -----------------------------------------------------------\n show-index.c |  2 +-\n 4 files changed, 69 insertions(+), 67 deletions(-)\n\ndiff --git a/Makefile b/Makefile\nindex ad890ec925..a041b69561 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -559,6 +559,7 @@ LIB_OBJS +\u003d graph.o\n LIB_OBJS +\u003d grep.o\n LIB_OBJS +\u003d hash.o\n LIB_OBJS +\u003d help.o\n+LIB_OBJS +\u003d hex.o\n LIB_OBJS +\u003d ident.o\n LIB_OBJS +\u003d levenshtein.o\n LIB_OBJS +\u003d list-objects.o\ndiff --git a/hex.c b/hex.c\nnew file mode 100644\nindex 0000000000..bb402fbaa2\n--- /dev/null\n+++ b/hex.c\n@@ -0,0 +1,67 @@\n+#include \"cache.h\"\n+\n+const signed char hexval_table[256] \u003d {\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 00-07 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 08-0f */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 10-17 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 18-1f */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 20-27 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 28-2f */\n+\t  0,  1,  2,  3,  4,  5,  6,  7,\t\t/* 30-37 */\n+\t  8,  9, -1, -1, -1, -1, -1, -1,\t\t/* 38-3f */\n+\t -1, 10, 11, 12, 13, 14, 15, -1,\t\t/* 40-47 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 48-4f */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 50-57 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 58-5f */\n+\t -1, 10, 11, 12, 13, 14, 15, -1,\t\t/* 60-67 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 68-67 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 70-77 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 78-7f */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 80-87 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 88-8f */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 90-97 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 98-9f */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* a0-a7 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* a8-af */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* b0-b7 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* b8-bf */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* c0-c7 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* c8-cf */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* d0-d7 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* d8-df */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* e0-e7 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* e8-ef */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* f0-f7 */\n+\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* f8-ff */\n+};\n+\n+int get_sha1_hex(const char *hex, unsigned char *sha1)\n+{\n+\tint i;\n+\tfor (i \u003d 0; i \u003c 20; i++) {\n+\t\tunsigned int val \u003d (hexval(hex[0]) \u003c\u003c 4) | hexval(hex[1]);\n+\t\tif (val \u0026 ~0xff)\n+\t\t\treturn -1;\n+\t\t*sha1++ \u003d val;\n+\t\thex +\u003d 2;\n+\t}\n+\treturn 0;\n+}\n+\n+char *sha1_to_hex(const unsigned char *sha1)\n+{\n+\tstatic int bufno;\n+\tstatic char hexbuffer[4][50];\n+\tstatic const char hex[] \u003d \"0123456789abcdef\";\n+\tchar *buffer \u003d hexbuffer[3 \u0026 ++bufno], *buf \u003d buffer;\n+\tint i;\n+\n+\tfor (i \u003d 0; i \u003c 20; i++) {\n+\t\tunsigned int val \u003d *sha1++;\n+\t\t*buf++ \u003d hex[val \u003e\u003e 4];\n+\t\t*buf++ \u003d hex[val \u0026 0xf];\n+\t}\n+\t*buf \u003d \u0027\\0\u0027;\n+\n+\treturn buffer;\n+}\ndiff --git a/sha1_file.c b/sha1_file.c\nindex 7086760dbe..12478a3652 100644\n--- a/sha1_file.c\n+++ b/sha1_file.c\n@@ -35,54 +35,6 @@ static size_t sz_fmt(size_t s) { return s; }\n \n const unsigned char null_sha1[20];\n \n-const signed char hexval_table[256] \u003d {\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 00-07 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 08-0f */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 10-17 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 18-1f */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 20-27 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 28-2f */\n-\t  0,  1,  2,  3,  4,  5,  6,  7,\t\t/* 30-37 */\n-\t  8,  9, -1, -1, -1, -1, -1, -1,\t\t/* 38-3f */\n-\t -1, 10, 11, 12, 13, 14, 15, -1,\t\t/* 40-47 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 48-4f */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 50-57 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 58-5f */\n-\t -1, 10, 11, 12, 13, 14, 15, -1,\t\t/* 60-67 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 68-67 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 70-77 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 78-7f */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 80-87 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 88-8f */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 90-97 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* 98-9f */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* a0-a7 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* a8-af */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* b0-b7 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* b8-bf */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* c0-c7 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* c8-cf */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* d0-d7 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* d8-df */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* e0-e7 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* e8-ef */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* f0-f7 */\n-\t -1, -1, -1, -1, -1, -1, -1, -1,\t\t/* f8-ff */\n-};\n-\n-int get_sha1_hex(const char *hex, unsigned char *sha1)\n-{\n-\tint i;\n-\tfor (i \u003d 0; i \u003c 20; i++) {\n-\t\tunsigned int val \u003d (hexval(hex[0]) \u003c\u003c 4) | hexval(hex[1]);\n-\t\tif (val \u0026 ~0xff)\n-\t\t\treturn -1;\n-\t\t*sha1++ \u003d val;\n-\t\thex +\u003d 2;\n-\t}\n-\treturn 0;\n-}\n-\n static inline int offset_1st_component(const char *path)\n {\n \tif (has_dos_drive_prefix(path))\n@@ -133,24 +85,6 @@ int safe_create_leading_directories_const(const char *path)\n \treturn result;\n }\n \n-char *sha1_to_hex(const unsigned char *sha1)\n-{\n-\tstatic int bufno;\n-\tstatic char hexbuffer[4][50];\n-\tstatic const char hex[] \u003d \"0123456789abcdef\";\n-\tchar *buffer \u003d hexbuffer[3 \u0026 ++bufno], *buf \u003d buffer;\n-\tint i;\n-\n-\tfor (i \u003d 0; i \u003c 20; i++) {\n-\t\tunsigned int val \u003d *sha1++;\n-\t\t*buf++ \u003d hex[val \u003e\u003e 4];\n-\t\t*buf++ \u003d hex[val \u0026 0xf];\n-\t}\n-\t*buf \u003d \u0027\\0\u0027;\n-\n-\treturn buffer;\n-}\n-\n static void fill_sha1_path(char *pathbuf, const unsigned char *sha1)\n {\n \tint i;\ndiff --git a/show-index.c b/show-index.c\nindex 63f9da5323..4c0ac138af 100644\n--- a/show-index.c\n+++ b/show-index.c\n@@ -48,7 +48,7 @@ int main(int argc, char **argv)\n \t\t\tunsigned char sha1[20];\n \t\t\tuint32_t crc;\n \t\t\tuint32_t off;\n-\t\t} *entries \u003d xmalloc(nr * sizeof(entries[0]));\n+\t\t} *entries \u003d malloc(nr * sizeof(entries[0]));\n \t\tfor (i \u003d 0; i \u003c nr; i++)\n \t\t\tif (fread(entries[i].sha1, 20, 1, stdin) !\u003d 1)\n \t\t\t\tdie(\"unable to read sha1 %u/%u\", i, nr);","expectedMessage":"slim down \"git show-index\"","repository":"git-linus","commitHash":"a5031214c4fe5f5d3fcf649d10769744cbc66fed","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-fb7d3f32","diff":" builtin-add.c | 76 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n read-cache.c  | 78 -----------------------------------------------------------\n 2 files changed, 76 insertions(+), 78 deletions(-)\n\ndiff --git a/builtin-add.c b/builtin-add.c\nindex cb6e5906fb..2705f8d057 100644\n--- a/builtin-add.c\n+++ b/builtin-add.c\n@@ -11,6 +11,7 @@\n #include \"run-command.h\"\n #include \"parse-options.h\"\n #include \"diff.h\"\n+#include \"diffcore.h\"\n #include \"revision.h\"\n \n static const char * const builtin_add_usage[] \u003d {\n@@ -20,6 +21,81 @@ static const char * const builtin_add_usage[] \u003d {\n static int patch_interactive, add_interactive, edit_interactive;\n static int take_worktree_changes;\n \n+struct update_callback_data\n+{\n+\tint flags;\n+\tint add_errors;\n+};\n+\n+static void update_callback(struct diff_queue_struct *q,\n+\t\t\t    struct diff_options *opt, void *cbdata)\n+{\n+\tint i;\n+\tstruct update_callback_data *data \u003d cbdata;\n+\n+\tfor (i \u003d 0; i \u003c q-\u003enr; i++) {\n+\t\tstruct diff_filepair *p \u003d q-\u003equeue[i];\n+\t\tconst char *path \u003d p-\u003eone-\u003epath;\n+\t\tswitch (p-\u003estatus) {\n+\t\tdefault:\n+\t\t\tdie(\"unexpected diff status %c\", p-\u003estatus);\n+\t\tcase DIFF_STATUS_UNMERGED:\n+\t\t\t/*\n+\t\t\t * ADD_CACHE_IGNORE_REMOVAL is unset if \"git\n+\t\t\t * add -u\" is calling us, In such a case, a\n+\t\t\t * missing work tree file needs to be removed\n+\t\t\t * if there is an unmerged entry at stage #2,\n+\t\t\t * but such a diff record is followed by\n+\t\t\t * another with DIFF_STATUS_DELETED (and if\n+\t\t\t * there is no stage #2, we won\u0027t see DELETED\n+\t\t\t * nor MODIFIED).  We can simply continue\n+\t\t\t * either way.\n+\t\t\t */\n+\t\t\tif (!(data-\u003eflags \u0026 ADD_CACHE_IGNORE_REMOVAL))\n+\t\t\t\tcontinue;\n+\t\t\t/*\n+\t\t\t * Otherwise, it is \"git add path\" is asking\n+\t\t\t * to explicitly add it; we fall through.  A\n+\t\t\t * missing work tree file is an error and is\n+\t\t\t * caught by add_file_to_index() in such a\n+\t\t\t * case.\n+\t\t\t */\n+\t\tcase DIFF_STATUS_MODIFIED:\n+\t\tcase DIFF_STATUS_TYPE_CHANGED:\n+\t\t\tif (add_file_to_index(\u0026the_index, path, data-\u003eflags)) {\n+\t\t\t\tif (!(data-\u003eflags \u0026 ADD_CACHE_IGNORE_ERRORS))\n+\t\t\t\t\tdie(\"updating files failed\");\n+\t\t\t\tdata-\u003eadd_errors++;\n+\t\t\t}\n+\t\t\tbreak;\n+\t\tcase DIFF_STATUS_DELETED:\n+\t\t\tif (data-\u003eflags \u0026 ADD_CACHE_IGNORE_REMOVAL)\n+\t\t\t\tbreak;\n+\t\t\tif (!(data-\u003eflags \u0026 ADD_CACHE_PRETEND))\n+\t\t\t\tremove_file_from_index(\u0026the_index, path);\n+\t\t\tif (data-\u003eflags \u0026 (ADD_CACHE_PRETEND|ADD_CACHE_VERBOSE))\n+\t\t\t\tprintf(\"remove \u0027%s\u0027\\n\", path);\n+\t\t\tbreak;\n+\t\t}\n+\t}\n+}\n+\n+int add_files_to_cache(const char *prefix, const char **pathspec, int flags)\n+{\n+\tstruct update_callback_data data;\n+\tstruct rev_info rev;\n+\tinit_revisions(\u0026rev, prefix);\n+\tsetup_revisions(0, NULL, \u0026rev, NULL);\n+\trev.prune_data \u003d pathspec;\n+\trev.diffopt.output_format \u003d DIFF_FORMAT_CALLBACK;\n+\trev.diffopt.format_callback \u003d update_callback;\n+\tdata.flags \u003d flags;\n+\tdata.add_errors \u003d 0;\n+\trev.diffopt.format_callback_data \u003d \u0026data;\n+\trun_diff_files(\u0026rev, DIFF_RACY_IS_MODIFIED);\n+\treturn !!data.add_errors;\n+}\n+\n static void fill_pathspec_matches(const char **pathspec, char *seen, int specs)\n {\n \tint num_unmatched \u003d 0, i;\ndiff --git a/read-cache.c b/read-cache.c\nindex edd995943d..79938bf09a 100644\n--- a/read-cache.c\n+++ b/read-cache.c\n@@ -10,9 +10,6 @@\n #include \"dir.h\"\n #include \"tree.h\"\n #include \"commit.h\"\n-#include \"diff.h\"\n-#include \"diffcore.h\"\n-#include \"revision.h\"\n #include \"blob.h\"\n #include \"resolve-undo.h\"\n \n@@ -1648,81 +1645,6 @@ int read_index_unmerged(struct index_state *istate)\n \treturn unmerged;\n }\n \n-struct update_callback_data\n-{\n-\tint flags;\n-\tint add_errors;\n-};\n-\n-static void update_callback(struct diff_queue_struct *q,\n-\t\t\t    struct diff_options *opt, void *cbdata)\n-{\n-\tint i;\n-\tstruct update_callback_data *data \u003d cbdata;\n-\n-\tfor (i \u003d 0; i \u003c q-\u003enr; i++) {\n-\t\tstruct diff_filepair *p \u003d q-\u003equeue[i];\n-\t\tconst char *path \u003d p-\u003eone-\u003epath;\n-\t\tswitch (p-\u003estatus) {\n-\t\tdefault:\n-\t\t\tdie(\"unexpected diff status %c\", p-\u003estatus);\n-\t\tcase DIFF_STATUS_UNMERGED:\n-\t\t\t/*\n-\t\t\t * ADD_CACHE_IGNORE_REMOVAL is unset if \"git\n-\t\t\t * add -u\" is calling us, In such a case, a\n-\t\t\t * missing work tree file needs to be removed\n-\t\t\t * if there is an unmerged entry at stage #2,\n-\t\t\t * but such a diff record is followed by\n-\t\t\t * another with DIFF_STATUS_DELETED (and if\n-\t\t\t * there is no stage #2, we won\u0027t see DELETED\n-\t\t\t * nor MODIFIED).  We can simply continue\n-\t\t\t * either way.\n-\t\t\t */\n-\t\t\tif (!(data-\u003eflags \u0026 ADD_CACHE_IGNORE_REMOVAL))\n-\t\t\t\tcontinue;\n-\t\t\t/*\n-\t\t\t * Otherwise, it is \"git add path\" is asking\n-\t\t\t * to explicitly add it; we fall through.  A\n-\t\t\t * missing work tree file is an error and is\n-\t\t\t * caught by add_file_to_index() in such a\n-\t\t\t * case.\n-\t\t\t */\n-\t\tcase DIFF_STATUS_MODIFIED:\n-\t\tcase DIFF_STATUS_TYPE_CHANGED:\n-\t\t\tif (add_file_to_index(\u0026the_index, path, data-\u003eflags)) {\n-\t\t\t\tif (!(data-\u003eflags \u0026 ADD_CACHE_IGNORE_ERRORS))\n-\t\t\t\t\tdie(\"updating files failed\");\n-\t\t\t\tdata-\u003eadd_errors++;\n-\t\t\t}\n-\t\t\tbreak;\n-\t\tcase DIFF_STATUS_DELETED:\n-\t\t\tif (data-\u003eflags \u0026 ADD_CACHE_IGNORE_REMOVAL)\n-\t\t\t\tbreak;\n-\t\t\tif (!(data-\u003eflags \u0026 ADD_CACHE_PRETEND))\n-\t\t\t\tremove_file_from_index(\u0026the_index, path);\n-\t\t\tif (data-\u003eflags \u0026 (ADD_CACHE_PRETEND|ADD_CACHE_VERBOSE))\n-\t\t\t\tprintf(\"remove \u0027%s\u0027\\n\", path);\n-\t\t\tbreak;\n-\t\t}\n-\t}\n-}\n-\n-int add_files_to_cache(const char *prefix, const char **pathspec, int flags)\n-{\n-\tstruct update_callback_data data;\n-\tstruct rev_info rev;\n-\tinit_revisions(\u0026rev, prefix);\n-\tsetup_revisions(0, NULL, \u0026rev, NULL);\n-\trev.prune_data \u003d pathspec;\n-\trev.diffopt.output_format \u003d DIFF_FORMAT_CALLBACK;\n-\trev.diffopt.format_callback \u003d update_callback;\n-\tdata.flags \u003d flags;\n-\tdata.add_errors \u003d 0;\n-\trev.diffopt.format_callback_data \u003d \u0026data;\n-\trun_diff_files(\u0026rev, DIFF_RACY_IS_MODIFIED);\n-\treturn !!data.add_errors;\n-}\n-\n /*\n  * Returns 1 if the path is an \"other\" path with respect to\n  * the index; that is, the path is not mentioned in the index at all,","expectedMessage":"Remove diff machinery dependency from read-cache","repository":"git-linus","commitHash":"fb7d3f32b283a3847e6f151a06794abd14ffd81b","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-77cd6ab6","diff":" diffcore-delta.c | 11 ++++++++++-\n 1 file changed, 10 insertions(+), 1 deletion(-)\n\ndiff --git a/diffcore-delta.c b/diffcore-delta.c\nindex e670f85125..7cf431d261 100644\n--- a/diffcore-delta.c\n+++ b/diffcore-delta.c\n@@ -201,10 +201,15 @@ int diffcore_count_changes(struct diff_filespec *src,\n \t\twhile (d-\u003ecnt) {\n \t\t\tif (d-\u003ehashval \u003e\u003d s-\u003ehashval)\n \t\t\t\tbreak;\n+\t\t\tla +\u003d d-\u003ecnt;\n \t\t\td++;\n \t\t}\n \t\tsrc_cnt \u003d s-\u003ecnt;\n-\t\tdst_cnt \u003d d-\u003ehashval \u003d\u003d s-\u003ehashval ? d-\u003ecnt : 0;\n+\t\tdst_cnt \u003d 0;\n+\t\tif (d-\u003ecnt \u0026\u0026 d-\u003ehashval \u003d\u003d s-\u003ehashval) {\n+\t\t\tdst_cnt \u003d d-\u003ecnt;\n+\t\t\td++;\n+\t\t}\n \t\tif (src_cnt \u003c dst_cnt) {\n \t\t\tla +\u003d dst_cnt - src_cnt;\n \t\t\tsc +\u003d src_cnt;\n@@ -213,6 +218,10 @@ int diffcore_count_changes(struct diff_filespec *src,\n \t\t\tsc +\u003d dst_cnt;\n \t\ts++;\n \t}\n+\twhile (d-\u003ecnt) {\n+\t\tla +\u003d d-\u003ecnt;\n+\t\td++;\n+\t}\n \n \tif (!src_count_p)\n \t\tfree(src_count);","expectedMessage":"Fix diff -B/--dirstat miscounting of newly added contents","repository":"git-linus","commitHash":"77cd6ab62108c2d4ddd4343abd9bae17c406be4b","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-ad3f9a71","diff":" builtin-rev-list.c  |  2 ++\n builtin-rev-parse.c | 11 +++++++++++\n revision.c          | 19 ++++++++++++++++++-\n revision.h          |  1 +\n 4 files changed, 32 insertions(+), 1 deletion(-)\n\ndiff --git a/builtin-rev-list.c b/builtin-rev-list.c\nindex 4ba1c12e0b..32bf033b5b 100644\n--- a/builtin-rev-list.c\n+++ b/builtin-rev-list.c\n@@ -319,6 +319,8 @@ int cmd_rev_list(int argc, const char **argv, const char *prefix)\n \n \tmemset(\u0026info, 0, sizeof(info));\n \tinfo.revs \u003d \u0026revs;\n+\tif (revs.bisect)\n+\t\tbisect_list \u003d 1;\n \n \tquiet \u003d DIFF_OPT_TST(\u0026revs.diffopt, QUIET);\n \tfor (i \u003d 1 ; i \u003c argc; i++) {\ndiff --git a/builtin-rev-parse.c b/builtin-rev-parse.c\nindex 45bead6545..9526aafc6c 100644\n--- a/builtin-rev-parse.c\n+++ b/builtin-rev-parse.c\n@@ -180,6 +180,12 @@ static int show_reference(const char *refname, const unsigned char *sha1, int fl\n \treturn 0;\n }\n \n+static int anti_reference(const char *refname, const unsigned char *sha1, int flag, void *cb_data)\n+{\n+\tshow_rev(REVERSED, sha1, refname);\n+\treturn 0;\n+}\n+\n static void show_datestring(const char *flag, const char *datestr)\n {\n \tstatic char buffer[100];\n@@ -548,6 +554,11 @@ int cmd_rev_parse(int argc, const char **argv, const char *prefix)\n \t\t\t\tfor_each_ref(show_reference, NULL);\n \t\t\t\tcontinue;\n \t\t\t}\n+\t\t\tif (!strcmp(arg, \"--bisect\")) {\n+\t\t\t\tfor_each_ref_in(\"refs/bisect/bad\", show_reference, NULL);\n+\t\t\t\tfor_each_ref_in(\"refs/bisect/good\", anti_reference, NULL);\n+\t\t\t\tcontinue;\n+\t\t\t}\n \t\t\tif (!strcmp(arg, \"--branches\")) {\n \t\t\t\tfor_each_branch_ref(show_reference, NULL);\n \t\t\t\tcontinue;\ndiff --git a/revision.c b/revision.c\nindex 9fc4e8d381..a36c0d9bcd 100644\n--- a/revision.c\n+++ b/revision.c\n@@ -994,7 +994,8 @@ static int handle_revision_opt(struct rev_info *revs, int argc, const char **arg\n \tif (!strcmp(arg, \"--all\") || !strcmp(arg, \"--branches\") ||\n \t    !strcmp(arg, \"--tags\") || !strcmp(arg, \"--remotes\") ||\n \t    !strcmp(arg, \"--reflog\") || !strcmp(arg, \"--not\") ||\n-\t    !strcmp(arg, \"--no-walk\") || !strcmp(arg, \"--do-walk\"))\n+\t    !strcmp(arg, \"--no-walk\") || !strcmp(arg, \"--do-walk\") ||\n+\t    !strcmp(arg, \"--bisect\"))\n \t{\n \t\tunkv[(*unkc)++] \u003d arg;\n \t\treturn 1;\n@@ -1218,6 +1219,16 @@ void parse_revision_opt(struct rev_info *revs, struct parse_opt_ctx_t *ctx,\n \tctx-\u003eargc -\u003d n;\n }\n \n+static int for_each_bad_bisect_ref(each_ref_fn fn, void *cb_data)\n+{\n+\treturn for_each_ref_in(\"refs/bisect/bad\", fn, cb_data);\n+}\n+\n+static int for_each_good_bisect_ref(each_ref_fn fn, void *cb_data)\n+{\n+\treturn for_each_ref_in(\"refs/bisect/good\", fn, cb_data);\n+}\n+\n /*\n  * Parse revision information, filling in the \"rev_info\" structure,\n  * and removing the used arguments from the argument list.\n@@ -1259,6 +1270,12 @@ int setup_revisions(int argc, const char **argv, struct rev_info *revs, const ch\n \t\t\t\thandle_refs(revs, flags, for_each_branch_ref);\n \t\t\t\tcontinue;\n \t\t\t}\n+\t\t\tif (!strcmp(arg, \"--bisect\")) {\n+\t\t\t\thandle_refs(revs, flags, for_each_bad_bisect_ref);\n+\t\t\t\thandle_refs(revs, flags ^ UNINTERESTING, for_each_good_bisect_ref);\n+\t\t\t\trevs-\u003ebisect \u003d 1;\n+\t\t\t\tcontinue;\n+\t\t\t}\n \t\t\tif (!strcmp(arg, \"--tags\")) {\n \t\t\t\thandle_refs(revs, flags, for_each_tag_ref);\n \t\t\t\tcontinue;\ndiff --git a/revision.h b/revision.h\nindex b6421a6432..921656aaab 100644\n--- a/revision.h\n+++ b/revision.h\n@@ -63,6 +63,7 @@ struct rev_info {\n \t\t\treverse:1,\n \t\t\treverse_output_stage:1,\n \t\t\tcherry_pick:1,\n+\t\t\tbisect:1,\n \t\t\tfirst_parent_only:1;\n \n \t/* Diff flags */","expectedMessage":"Add \u0027--bisect\u0027 revision machinery argument","repository":"git-linus","commitHash":"ad3f9a71a8200418e1da59b9712a8fde3f8c4c08","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-36e4986f","diff":" date.c | 32 +++++++++++++++++++++++++++-----\n 1 file changed, 27 insertions(+), 5 deletions(-)\n\ndiff --git a/date.c b/date.c\nindex 51c646166f..1de184587b 100644\n--- a/date.c\n+++ b/date.c\n@@ -24,6 +24,8 @@ time_t tm_to_time_t(const struct tm *tm)\n \t\treturn -1;\n \tif (month \u003c 2 || (year + 2) % 4)\n \t\tday--;\n+\tif (tm-\u003etm_hour \u003c 0 || tm-\u003etm_min \u003c 0 || tm-\u003etm_sec \u003c 0)\n+\t\treturn -1;\n \treturn (year * 365 + (year + 1) / 4 + mdays[month] + day) * 24*60*60UL +\n \t\ttm-\u003etm_hour * 60*60 + tm-\u003etm_min * 60 + tm-\u003etm_sec;\n }\n@@ -425,13 +427,19 @@ static int match_multi_number(unsigned long num, char c, const char *date, char\n \treturn end - date;\n }\n \n-/* Have we filled in any part of the time/date yet? */\n+/*\n+ * Have we filled in any part of the time/date yet?\n+ * We just do a binary \u0027and\u0027 to see if the sign bit\n+ * is set in all the values.\n+ */\n static inline int nodate(struct tm *tm)\n {\n-\treturn tm-\u003etm_year \u003c 0 \u0026\u0026\n-\t\ttm-\u003etm_mon \u003c 0 \u0026\u0026\n-\t\ttm-\u003etm_mday \u003c 0 \u0026\u0026\n-\t\t!(tm-\u003etm_hour | tm-\u003etm_min | tm-\u003etm_sec);\n+\treturn (tm-\u003etm_year \u0026\n+\t\ttm-\u003etm_mon \u0026\n+\t\ttm-\u003etm_mday \u0026\n+\t\ttm-\u003etm_hour \u0026\n+\t\ttm-\u003etm_min \u0026\n+\t\ttm-\u003etm_sec) \u003c 0;\n }\n \n /*\n@@ -580,6 +588,9 @@ int parse_date(const char *date, char *result, int maxlen)\n \ttm.tm_mon \u003d -1;\n \ttm.tm_mday \u003d -1;\n \ttm.tm_isdst \u003d -1;\n+\ttm.tm_hour \u003d -1;\n+\ttm.tm_min \u003d -1;\n+\ttm.tm_sec \u003d -1;\n \toffset \u003d -1;\n \ttm_gmt \u003d 0;\n \n@@ -893,6 +904,17 @@ static void pending_number(struct tm *tm, int *num)\n \t\t*num \u003d 0;\n \t\tif (tm-\u003etm_mday \u003c 0 \u0026\u0026 number \u003c 32)\n \t\t\ttm-\u003etm_mday \u003d number;\n+\t\telse if (tm-\u003etm_mon \u003c 0 \u0026\u0026 number \u003c 13)\n+\t\t\ttm-\u003etm_mon \u003d number-1;\n+\t\telse if (tm-\u003etm_year \u003c 0) {\n+\t\t\tif (number \u003e 1969 \u0026\u0026 number \u003c 2100)\n+\t\t\t\ttm-\u003etm_year \u003d number - 1900;\n+\t\t\telse if (number \u003e 69 \u0026\u0026 number \u003c 100)\n+\t\t\t\ttm-\u003etm_year \u003d number;\n+\t\t\telse if (number \u003c 38)\n+\t\t\t\ttm-\u003etm_year \u003d 100 + number;\n+\t\t\t/* We screw up for number \u003d 00 ? */\n+\t\t}\n \t}\n }\n ","expectedMessage":"Further \u0027approxidate\u0027 improvements","repository":"git-linus","commitHash":"36e4986f26d18defa51fd7af60ec7e7a98337902","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-90290552","diff":" date.c | 93 +++++++++++++++++++++++++++++++++++++++++++++---------------------\n 1 file changed, 63 insertions(+), 30 deletions(-)\n\ndiff --git a/date.c b/date.c\nindex 409a17d464..51c646166f 100644\n--- a/date.c\n+++ b/date.c\n@@ -525,11 +525,8 @@ static int match_digit(const char *date, struct tm *tm, int *offset, int *tm_gmt\n \t\t}\n \t}\n \n-\tif (num \u003e 0 \u0026\u0026 num \u003c 32) {\n-\t\ttm-\u003etm_mday \u003d num;\n-\t} else if (num \u003e 0 \u0026\u0026 num \u003c 13) {\n+\tif (num \u003e 0 \u0026\u0026 num \u003c 13 \u0026\u0026 tm-\u003etm_mon \u003c 0)\n \t\ttm-\u003etm_mon \u003d num-1;\n-\t}\n \n \treturn n;\n }\n@@ -657,42 +654,59 @@ void datestamp(char *buf, int bufsize)\n \tdate_string(now, offset, buf, bufsize);\n }\n \n-static void update_tm(struct tm *tm, unsigned long sec)\n+/*\n+ * Relative time update (eg \"2 days ago\").  If we haven\u0027t set the time\n+ * yet, we need to set it from current time.\n+ */\n+static unsigned long update_tm(struct tm *tm, struct tm *now, unsigned long sec)\n {\n-\ttime_t n \u003d mktime(tm) - sec;\n+\ttime_t n;\n+\n+\tif (tm-\u003etm_mday \u003c 0)\n+\t\ttm-\u003etm_mday \u003d now-\u003etm_mday;\n+\tif (tm-\u003etm_mon \u003c 0)\n+\t\ttm-\u003etm_mon \u003d now-\u003etm_mon;\n+\tif (tm-\u003etm_year \u003c 0) {\n+\t\ttm-\u003etm_year \u003d now-\u003etm_year;\n+\t\tif (tm-\u003etm_mon \u003e now-\u003etm_mon)\n+\t\t\ttm-\u003etm_year--;\n+\t}\n+\n+\tn \u003d mktime(tm) - sec;\n \tlocaltime_r(\u0026n, tm);\n+\treturn n;\n }\n \n-static void date_yesterday(struct tm *tm, int *num)\n+static void date_yesterday(struct tm *tm, struct tm *now, int *num)\n {\n-\tupdate_tm(tm, 24*60*60);\n+\tupdate_tm(tm, now, 24*60*60);\n }\n \n-static void date_time(struct tm *tm, int hour)\n+static void date_time(struct tm *tm, struct tm *now, int hour)\n {\n \tif (tm-\u003etm_hour \u003c hour)\n-\t\tdate_yesterday(tm, NULL);\n+\t\tdate_yesterday(tm, now, NULL);\n \ttm-\u003etm_hour \u003d hour;\n \ttm-\u003etm_min \u003d 0;\n \ttm-\u003etm_sec \u003d 0;\n }\n \n-static void date_midnight(struct tm *tm, int *num)\n+static void date_midnight(struct tm *tm, struct tm *now, int *num)\n {\n-\tdate_time(tm, 0);\n+\tdate_time(tm, now, 0);\n }\n \n-static void date_noon(struct tm *tm, int *num)\n+static void date_noon(struct tm *tm, struct tm *now, int *num)\n {\n-\tdate_time(tm, 12);\n+\tdate_time(tm, now, 12);\n }\n \n-static void date_tea(struct tm *tm, int *num)\n+static void date_tea(struct tm *tm, struct tm *now, int *num)\n {\n-\tdate_time(tm, 17);\n+\tdate_time(tm, now, 17);\n }\n \n-static void date_pm(struct tm *tm, int *num)\n+static void date_pm(struct tm *tm, struct tm *now, int *num)\n {\n \tint hour, n \u003d *num;\n \t*num \u003d 0;\n@@ -706,7 +720,7 @@ static void date_pm(struct tm *tm, int *num)\n \ttm-\u003etm_hour \u003d (hour % 12) + 12;\n }\n \n-static void date_am(struct tm *tm, int *num)\n+static void date_am(struct tm *tm, struct tm *now, int *num)\n {\n \tint hour, n \u003d *num;\n \t*num \u003d 0;\n@@ -720,7 +734,7 @@ static void date_am(struct tm *tm, int *num)\n \ttm-\u003etm_hour \u003d (hour % 12);\n }\n \n-static void date_never(struct tm *tm, int *num)\n+static void date_never(struct tm *tm, struct tm *now, int *num)\n {\n \ttime_t n \u003d 0;\n \tlocaltime_r(\u0026n, tm);\n@@ -728,7 +742,7 @@ static void date_never(struct tm *tm, int *num)\n \n static const struct special {\n \tconst char *name;\n-\tvoid (*fn)(struct tm *, int *);\n+\tvoid (*fn)(struct tm *, struct tm *, int *);\n } special[] \u003d {\n \t{ \"yesterday\", date_yesterday },\n \t{ \"noon\", date_noon },\n@@ -757,7 +771,7 @@ static const struct typelen {\n \t{ NULL }\n };\n \n-static const char *approxidate_alpha(const char *date, struct tm *tm, int *num)\n+static const char *approxidate_alpha(const char *date, struct tm *tm, struct tm *now, int *num)\n {\n \tconst struct typelen *tl;\n \tconst struct special *s;\n@@ -778,7 +792,7 @@ static const char *approxidate_alpha(const char *date, struct tm *tm, int *num)\n \tfor (s \u003d special; s-\u003ename; s++) {\n \t\tint len \u003d strlen(s-\u003ename);\n \t\tif (match_string(date, s-\u003ename) \u003d\u003d len) {\n-\t\t\ts-\u003efn(tm, num);\n+\t\t\ts-\u003efn(tm, now, num);\n \t\t\treturn end;\n \t\t}\n \t}\n@@ -800,7 +814,7 @@ static const char *approxidate_alpha(const char *date, struct tm *tm, int *num)\n \twhile (tl-\u003etype) {\n \t\tint len \u003d strlen(tl-\u003etype);\n \t\tif (match_string(date, tl-\u003etype) \u003e\u003d len-1) {\n-\t\t\tupdate_tm(tm, tl-\u003elength * *num);\n+\t\t\tupdate_tm(tm, now, tl-\u003elength * *num);\n \t\t\t*num \u003d 0;\n \t\t\treturn end;\n \t\t}\n@@ -818,7 +832,7 @@ static const char *approxidate_alpha(const char *date, struct tm *tm, int *num)\n \t\t\t\tn++;\n \t\t\tdiff +\u003d 7*n;\n \n-\t\t\tupdate_tm(tm, diff * 24 * 60 * 60);\n+\t\t\tupdate_tm(tm, now, diff * 24 * 60 * 60);\n \t\t\treturn end;\n \t\t}\n \t}\n@@ -866,6 +880,22 @@ static const char *approxidate_digit(const char *date, struct tm *tm, int *num)\n \treturn end;\n }\n \n+/*\n+ * Do we have a pending number at the end, or when\n+ * we see a new one? Let\u0027s assume it\u0027s a month day,\n+ * as in \"Dec 6, 1992\"\n+ */\n+static void pending_number(struct tm *tm, int *num)\n+{\n+\tint number \u003d *num;\n+\n+\tif (number) {\n+\t\t*num \u003d 0;\n+\t\tif (tm-\u003etm_mday \u003c 0 \u0026\u0026 number \u003c 32)\n+\t\t\ttm-\u003etm_mday \u003d number;\n+\t}\n+}\n+\n unsigned long approxidate(const char *date)\n {\n \tint number \u003d 0;\n@@ -881,21 +911,24 @@ unsigned long approxidate(const char *date)\n \ttime_sec \u003d tv.tv_sec;\n \tlocaltime_r(\u0026time_sec, \u0026tm);\n \tnow \u003d tm;\n+\n+\ttm.tm_year \u003d -1;\n+\ttm.tm_mon \u003d -1;\n+\ttm.tm_mday \u003d -1;\n+\n \tfor (;;) {\n \t\tunsigned char c \u003d *date;\n \t\tif (!c)\n \t\t\tbreak;\n \t\tdate++;\n \t\tif (isdigit(c)) {\n+\t\t\tpending_number(\u0026tm, \u0026number);\n \t\t\tdate \u003d approxidate_digit(date-1, \u0026tm, \u0026number);\n \t\t\tcontinue;\n \t\t}\n \t\tif (isalpha(c))\n-\t\t\tdate \u003d approxidate_alpha(date-1, \u0026tm, \u0026number);\n+\t\t\tdate \u003d approxidate_alpha(date-1, \u0026tm, \u0026now, \u0026number);\n \t}\n-\tif (number \u003e 0 \u0026\u0026 number \u003c 32)\n-\t\ttm.tm_mday \u003d number;\n-\tif (tm.tm_mon \u003e now.tm_mon \u0026\u0026 tm.tm_year \u003d\u003d now.tm_year)\n-\t\ttm.tm_year--;\n-\treturn mktime(\u0026tm);\n+\tpending_number(\u0026tm, \u0026number);\n+\treturn update_tm(\u0026tm, \u0026now, 0);\n }","expectedMessage":"Improve on \u0027approxidate\u0027","repository":"git-linus","commitHash":"9029055207443c28ca65a705d1a1b96cce3995fd","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-926172c5","diff":" block-sha1/sha1.c | 25 ++++++++++++++++++++++++-\n 1 file changed, 24 insertions(+), 1 deletion(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex 886bcf25e2..304cd0452d 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -82,6 +82,7 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n #define SHA_ASM(op, x, n) ({ unsigned int __res; __asm__(op \" %1,%0\":\"\u003dr\" (__res):\"i\" (n), \"0\" (x)); __res; })\n #define SHA_ROL(x,n)\tSHA_ASM(\"rol\", x, n)\n #define SHA_ROR(x,n)\tSHA_ASM(\"ror\", x, n)\n+#define SMALL_REGISTER_SET\n \n #else\n \n@@ -93,7 +94,29 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n \n /* This \"rolls\" over the 512-bit array */\n #define W(x) (array[(x)\u002615])\n-#define setW(x, val) (*(volatile unsigned int *)\u0026W(x) \u003d (val))\n+\n+/*\n+ * If you have 32 registers or more, the compiler can (and should)\n+ * try to change the array[] accesses into registers. However, on\n+ * machines with less than ~25 registers, that won\u0027t really work,\n+ * and at least gcc will make an unholy mess of it.\n+ *\n+ * So to avoid that mess which just slows things down, we force\n+ * the stores to memory to actually happen (we might be better off\n+ * with a \u0027W(t)\u003d(val);asm(\"\":\"+m\" (W(t))\u0027 there instead, as\n+ * suggested by Artur Skawina - that will also make gcc unable to\n+ * try to do the silly \"optimize away loads\" part because it won\u0027t\n+ * see what the value will be).\n+ *\n+ * Ben Herrenschmidt reports that on PPC, the C version comes close\n+ * to the optimized asm with this (ie on PPC you don\u0027t want that\n+ * \u0027volatile\u0027, since there are lots of registers).\n+ */\n+#ifdef SMALL_REGISTER_SET\n+  #define setW(x, val) (*(volatile unsigned int *)\u0026W(x) \u003d (val))\n+#else\n+  #define setW(x, val) (W(x) \u003d (val))\n+#endif\n \n /*\n  * Where do we get the source from? The first 16 iterations get it from","expectedMessage":"block-sha1: improve code on large-register-set machines","repository":"git-linus","commitHash":"926172c5e4808726244713ef70398cd38b055f1e","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-66c9c6c0","diff":" block-sha1/sha1.c | 7 ++++---\n 1 file changed, 4 insertions(+), 3 deletions(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex b715916675..886bcf25e2 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -93,6 +93,7 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n \n /* This \"rolls\" over the 512-bit array */\n #define W(x) (array[(x)\u002615])\n+#define setW(x, val) (*(volatile unsigned int *)\u0026W(x) \u003d (val))\n \n /*\n  * Where do we get the source from? The first 16 iterations get it from\n@@ -102,9 +103,9 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n #define SHA_MIX(t) SHA_ROL(W(t+13) ^ W(t+8) ^ W(t+2) ^ W(t), 1)\n \n #define SHA_ROUND(t, input, fn, constant, A, B, C, D, E) do { \\\n-\tunsigned int TEMP \u003d input(t); W(t) \u003d TEMP; \\\n-\tTEMP +\u003d E + SHA_ROL(A,5) + (fn) + (constant); \\\n-\tB \u003d SHA_ROR(B, 2); E \u003d TEMP; } while (0)\n+\tunsigned int TEMP \u003d input(t); setW(t, TEMP); \\\n+\tE +\u003d TEMP + SHA_ROL(A,5) + (fn) + (constant); \\\n+\tB \u003d SHA_ROR(B, 2); } while (0)\n \n #define T_0_15(t, A, B, C, D, E)  SHA_ROUND(t, SHA_SRC, (((C^D)\u0026B)^D) , 0x5a827999, A, B, C, D, E )\n #define T_16_19(t, A, B, C, D, E) SHA_ROUND(t, SHA_MIX, (((C^D)\u0026B)^D) , 0x5a827999, A, B, C, D, E )","expectedMessage":"block-sha1: improved SHA1 hashing","repository":"git-linus","commitHash":"66c9c6c0fbba0894ebce3da572f62eb05162e547","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-30d12d4c","diff":" block-sha1/sha1.c | 117 +++++++++++++++++++++++++++++++++++++++++-------------\n 1 file changed, 90 insertions(+), 27 deletions(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex fdd400f22d..b715916675 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -101,20 +101,20 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n #define SHA_SRC(t) htonl(data[t])\n #define SHA_MIX(t) SHA_ROL(W(t+13) ^ W(t+8) ^ W(t+2) ^ W(t), 1)\n \n-#define SHA_ROUND(t, input, fn, constant) \\\n-\tTEMP \u003d input(t); W(t) \u003d TEMP; \\\n-\tTEMP +\u003d SHA_ROL(A,5) + (fn) + E + (constant); \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP\n+#define SHA_ROUND(t, input, fn, constant, A, B, C, D, E) do { \\\n+\tunsigned int TEMP \u003d input(t); W(t) \u003d TEMP; \\\n+\tTEMP +\u003d E + SHA_ROL(A,5) + (fn) + (constant); \\\n+\tB \u003d SHA_ROR(B, 2); E \u003d TEMP; } while (0)\n \n-#define T_0_15(t)  SHA_ROUND(t, SHA_SRC, (((C^D)\u0026B)^D) , 0x5a827999 )\n-#define T_16_19(t) SHA_ROUND(t, SHA_MIX, (((C^D)\u0026B)^D) , 0x5a827999 )\n-#define T_20_39(t) SHA_ROUND(t, SHA_MIX, (B^C^D) , 0x6ed9eba1 )\n-#define T_40_59(t) SHA_ROUND(t, SHA_MIX, ((B\u0026C)+(D\u0026(B^C))) , 0x8f1bbcdc )\n-#define T_60_79(t) SHA_ROUND(t, SHA_MIX, (B^C^D) ,  0xca62c1d6 )\n+#define T_0_15(t, A, B, C, D, E)  SHA_ROUND(t, SHA_SRC, (((C^D)\u0026B)^D) , 0x5a827999, A, B, C, D, E )\n+#define T_16_19(t, A, B, C, D, E) SHA_ROUND(t, SHA_MIX, (((C^D)\u0026B)^D) , 0x5a827999, A, B, C, D, E )\n+#define T_20_39(t, A, B, C, D, E) SHA_ROUND(t, SHA_MIX, (B^C^D) , 0x6ed9eba1, A, B, C, D, E )\n+#define T_40_59(t, A, B, C, D, E) SHA_ROUND(t, SHA_MIX, ((B\u0026C)+(D\u0026(B^C))) , 0x8f1bbcdc, A, B, C, D, E )\n+#define T_60_79(t, A, B, C, D, E) SHA_ROUND(t, SHA_MIX, (B^C^D) ,  0xca62c1d6, A, B, C, D, E )\n \n static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n {\n-\tunsigned int A,B,C,D,E,TEMP;\n+\tunsigned int A,B,C,D,E;\n \tunsigned int array[16];\n \n \tA \u003d ctx-\u003eH[0];\n@@ -124,31 +124,94 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tE \u003d ctx-\u003eH[4];\n \n \t/* Round 1 - iterations 0-16 take their input from \u0027data\u0027 */\n-\tT_0_15( 0); T_0_15( 1); T_0_15( 2); T_0_15( 3); T_0_15( 4);\n-\tT_0_15( 5); T_0_15( 6); T_0_15( 7); T_0_15( 8); T_0_15( 9);\n-\tT_0_15(10); T_0_15(11); T_0_15(12); T_0_15(13); T_0_15(14);\n-\tT_0_15(15);\n+\tT_0_15( 0, A, B, C, D, E);\n+\tT_0_15( 1, E, A, B, C, D);\n+\tT_0_15( 2, D, E, A, B, C);\n+\tT_0_15( 3, C, D, E, A, B);\n+\tT_0_15( 4, B, C, D, E, A);\n+\tT_0_15( 5, A, B, C, D, E);\n+\tT_0_15( 6, E, A, B, C, D);\n+\tT_0_15( 7, D, E, A, B, C);\n+\tT_0_15( 8, C, D, E, A, B);\n+\tT_0_15( 9, B, C, D, E, A);\n+\tT_0_15(10, A, B, C, D, E);\n+\tT_0_15(11, E, A, B, C, D);\n+\tT_0_15(12, D, E, A, B, C);\n+\tT_0_15(13, C, D, E, A, B);\n+\tT_0_15(14, B, C, D, E, A);\n+\tT_0_15(15, A, B, C, D, E);\n \n \t/* Round 1 - tail. Input from 512-bit mixing array */\n-\tT_16_19(16); T_16_19(17); T_16_19(18); T_16_19(19);\n+\tT_16_19(16, E, A, B, C, D);\n+\tT_16_19(17, D, E, A, B, C);\n+\tT_16_19(18, C, D, E, A, B);\n+\tT_16_19(19, B, C, D, E, A);\n \n \t/* Round 2 */\n-\tT_20_39(20); T_20_39(21); T_20_39(22); T_20_39(23); T_20_39(24);\n-\tT_20_39(25); T_20_39(26); T_20_39(27); T_20_39(28); T_20_39(29);\n-\tT_20_39(30); T_20_39(31); T_20_39(32); T_20_39(33); T_20_39(34);\n-\tT_20_39(35); T_20_39(36); T_20_39(37); T_20_39(38); T_20_39(39);\n+\tT_20_39(20, A, B, C, D, E);\n+\tT_20_39(21, E, A, B, C, D);\n+\tT_20_39(22, D, E, A, B, C);\n+\tT_20_39(23, C, D, E, A, B);\n+\tT_20_39(24, B, C, D, E, A);\n+\tT_20_39(25, A, B, C, D, E);\n+\tT_20_39(26, E, A, B, C, D);\n+\tT_20_39(27, D, E, A, B, C);\n+\tT_20_39(28, C, D, E, A, B);\n+\tT_20_39(29, B, C, D, E, A);\n+\tT_20_39(30, A, B, C, D, E);\n+\tT_20_39(31, E, A, B, C, D);\n+\tT_20_39(32, D, E, A, B, C);\n+\tT_20_39(33, C, D, E, A, B);\n+\tT_20_39(34, B, C, D, E, A);\n+\tT_20_39(35, A, B, C, D, E);\n+\tT_20_39(36, E, A, B, C, D);\n+\tT_20_39(37, D, E, A, B, C);\n+\tT_20_39(38, C, D, E, A, B);\n+\tT_20_39(39, B, C, D, E, A);\n \n \t/* Round 3 */\n-\tT_40_59(40); T_40_59(41); T_40_59(42); T_40_59(43); T_40_59(44);\n-\tT_40_59(45); T_40_59(46); T_40_59(47); T_40_59(48); T_40_59(49);\n-\tT_40_59(50); T_40_59(51); T_40_59(52); T_40_59(53); T_40_59(54);\n-\tT_40_59(55); T_40_59(56); T_40_59(57); T_40_59(58); T_40_59(59);\n+\tT_40_59(40, A, B, C, D, E);\n+\tT_40_59(41, E, A, B, C, D);\n+\tT_40_59(42, D, E, A, B, C);\n+\tT_40_59(43, C, D, E, A, B);\n+\tT_40_59(44, B, C, D, E, A);\n+\tT_40_59(45, A, B, C, D, E);\n+\tT_40_59(46, E, A, B, C, D);\n+\tT_40_59(47, D, E, A, B, C);\n+\tT_40_59(48, C, D, E, A, B);\n+\tT_40_59(49, B, C, D, E, A);\n+\tT_40_59(50, A, B, C, D, E);\n+\tT_40_59(51, E, A, B, C, D);\n+\tT_40_59(52, D, E, A, B, C);\n+\tT_40_59(53, C, D, E, A, B);\n+\tT_40_59(54, B, C, D, E, A);\n+\tT_40_59(55, A, B, C, D, E);\n+\tT_40_59(56, E, A, B, C, D);\n+\tT_40_59(57, D, E, A, B, C);\n+\tT_40_59(58, C, D, E, A, B);\n+\tT_40_59(59, B, C, D, E, A);\n \n \t/* Round 4 */\n-\tT_60_79(60); T_60_79(61); T_60_79(62); T_60_79(63); T_60_79(64);\n-\tT_60_79(65); T_60_79(66); T_60_79(67); T_60_79(68); T_60_79(69);\n-\tT_60_79(70); T_60_79(71); T_60_79(72); T_60_79(73); T_60_79(74);\n-\tT_60_79(75); T_60_79(76); T_60_79(77); T_60_79(78); T_60_79(79);\n+\tT_60_79(60, A, B, C, D, E);\n+\tT_60_79(61, E, A, B, C, D);\n+\tT_60_79(62, D, E, A, B, C);\n+\tT_60_79(63, C, D, E, A, B);\n+\tT_60_79(64, B, C, D, E, A);\n+\tT_60_79(65, A, B, C, D, E);\n+\tT_60_79(66, E, A, B, C, D);\n+\tT_60_79(67, D, E, A, B, C);\n+\tT_60_79(68, C, D, E, A, B);\n+\tT_60_79(69, B, C, D, E, A);\n+\tT_60_79(70, A, B, C, D, E);\n+\tT_60_79(71, E, A, B, C, D);\n+\tT_60_79(72, D, E, A, B, C);\n+\tT_60_79(73, C, D, E, A, B);\n+\tT_60_79(74, B, C, D, E, A);\n+\tT_60_79(75, A, B, C, D, E);\n+\tT_60_79(76, E, A, B, C, D);\n+\tT_60_79(77, D, E, A, B, C);\n+\tT_60_79(78, C, D, E, A, B);\n+\tT_60_79(79, B, C, D, E, A);\n \n \tctx-\u003eH[0] +\u003d A;\n \tctx-\u003eH[1] +\u003d B;","expectedMessage":"block-sha1: perform register rotation using cpp","repository":"git-linus","commitHash":"30d12d4c16abc052e8961c07651f97bea2c061bd","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-5d5210c3","diff":" block-sha1/sha1.c | 17 +++++++----------\n block-sha1/sha1.h |  1 -\n 2 files changed, 7 insertions(+), 11 deletions(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex 5bf1b36bd1..fdd400f22d 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -14,7 +14,6 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data);\n \n void blk_SHA1_Init(blk_SHA_CTX *ctx)\n {\n-\tctx-\u003elenW \u003d 0;\n \tctx-\u003esize \u003d 0;\n \n \t/* Initialize H with the magic constants (see FIPS180 for constants)\n@@ -29,9 +28,9 @@ void blk_SHA1_Init(blk_SHA_CTX *ctx)\n \n void blk_SHA1_Update(blk_SHA_CTX *ctx, const void *data, unsigned long len)\n {\n-\tint lenW \u003d ctx-\u003elenW;\n+\tint lenW \u003d ctx-\u003esize \u0026 63;\n \n-\tctx-\u003esize +\u003d (unsigned long long) len \u003c\u003c 3;\n+\tctx-\u003esize +\u003d len;\n \n \t/* Read the data into W and process blocks as they get full\n \t */\n@@ -43,7 +42,6 @@ void blk_SHA1_Update(blk_SHA_CTX *ctx, const void *data, unsigned long len)\n \t\tlenW \u003d (lenW + left) \u0026 63;\n \t\tlen -\u003d left;\n \t\tdata +\u003d left;\n-\t\tctx-\u003elenW \u003d lenW;\n \t\tif (lenW)\n \t\t\treturn;\n \t\tblk_SHA1Block(ctx, ctx-\u003eW);\n@@ -53,10 +51,8 @@ void blk_SHA1_Update(blk_SHA_CTX *ctx, const void *data, unsigned long len)\n \t\tdata +\u003d 64;\n \t\tlen -\u003d 64;\n \t}\n-\tif (len) {\n+\tif (len)\n \t\tmemcpy(ctx-\u003eW, data, len);\n-\t\tctx-\u003elenW \u003d len;\n-\t}\n }\n \n \n@@ -68,10 +64,11 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n \n \t/* Pad with a binary 1 (ie 0x80), then zeroes, then length\n \t */\n-\tpadlen[0] \u003d htonl(ctx-\u003esize \u003e\u003e 32);\n-\tpadlen[1] \u003d htonl(ctx-\u003esize);\n+\tpadlen[0] \u003d htonl(ctx-\u003esize \u003e\u003e 29);\n+\tpadlen[1] \u003d htonl(ctx-\u003esize \u003c\u003c 3);\n \n-\tblk_SHA1_Update(ctx, pad, 1+ (63 \u0026 (55 - ctx-\u003elenW)));\n+\ti \u003d ctx-\u003esize \u0026 63;\n+\tblk_SHA1_Update(ctx, pad, 1+ (63 \u0026 (55 - i)));\n \tblk_SHA1_Update(ctx, padlen, 8);\n \n \t/* Output hash\ndiff --git a/block-sha1/sha1.h b/block-sha1/sha1.h\nindex 7be2d93a2a..c1ae74d3da 100644\n--- a/block-sha1/sha1.h\n+++ b/block-sha1/sha1.h\n@@ -7,7 +7,6 @@\n typedef struct {\n \tunsigned int H[5];\n \tunsigned int W[16];\n-\tint lenW;\n \tunsigned long long size;\n } blk_SHA_CTX;\n ","expectedMessage":"block-sha1: get rid of redundant \u0027lenW\u0027 context","repository":"git-linus","commitHash":"5d5210c35aa83342163ab0ab80b8e6d6fa3ce931","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-e869e113","diff":" block-sha1/sha1.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex 53c93ba603..5bf1b36bd1 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -112,7 +112,7 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n #define T_0_15(t)  SHA_ROUND(t, SHA_SRC, (((C^D)\u0026B)^D) , 0x5a827999 )\n #define T_16_19(t) SHA_ROUND(t, SHA_MIX, (((C^D)\u0026B)^D) , 0x5a827999 )\n #define T_20_39(t) SHA_ROUND(t, SHA_MIX, (B^C^D) , 0x6ed9eba1 )\n-#define T_40_59(t) SHA_ROUND(t, SHA_MIX, ((B\u0026C)|(D\u0026(B|C))) , 0x8f1bbcdc )\n+#define T_40_59(t) SHA_ROUND(t, SHA_MIX, ((B\u0026C)+(D\u0026(B^C))) , 0x8f1bbcdc )\n #define T_60_79(t) SHA_ROUND(t, SHA_MIX, (B^C^D) ,  0xca62c1d6 )\n \n static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)","expectedMessage":"block-sha1: Use \u0027(B\u0026C)+(D\u0026(B^C))\u0027 instead of \u0027(B\u0026C)|(D\u0026(B|C))\u0027 in round 3","repository":"git-linus","commitHash":"e869e113c8f91999f9a433436e0b863fe2727b61","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-ab14c823","diff":" block-sha1/sha1.c | 56 ++++++++++++++++++++++++++-----------------------------\n 1 file changed, 26 insertions(+), 30 deletions(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex 8c4c216f93..53c93ba603 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -94,6 +94,27 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n \n #endif\n \n+/* This \"rolls\" over the 512-bit array */\n+#define W(x) (array[(x)\u002615])\n+\n+/*\n+ * Where do we get the source from? The first 16 iterations get it from\n+ * the input data, the next mix it from the 512-bit array.\n+ */\n+#define SHA_SRC(t) htonl(data[t])\n+#define SHA_MIX(t) SHA_ROL(W(t+13) ^ W(t+8) ^ W(t+2) ^ W(t), 1)\n+\n+#define SHA_ROUND(t, input, fn, constant) \\\n+\tTEMP \u003d input(t); W(t) \u003d TEMP; \\\n+\tTEMP +\u003d SHA_ROL(A,5) + (fn) + E + (constant); \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP\n+\n+#define T_0_15(t)  SHA_ROUND(t, SHA_SRC, (((C^D)\u0026B)^D) , 0x5a827999 )\n+#define T_16_19(t) SHA_ROUND(t, SHA_MIX, (((C^D)\u0026B)^D) , 0x5a827999 )\n+#define T_20_39(t) SHA_ROUND(t, SHA_MIX, (B^C^D) , 0x6ed9eba1 )\n+#define T_40_59(t) SHA_ROUND(t, SHA_MIX, ((B\u0026C)|(D\u0026(B|C))) , 0x8f1bbcdc )\n+#define T_60_79(t) SHA_ROUND(t, SHA_MIX, (B^C^D) ,  0xca62c1d6 )\n+\n static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n {\n \tunsigned int A,B,C,D,E,TEMP;\n@@ -105,53 +126,28 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tD \u003d ctx-\u003eH[3];\n \tE \u003d ctx-\u003eH[4];\n \n-#define T_0_15(t) \\\n-\tTEMP \u003d htonl(data[t]); array[t] \u003d TEMP; \\\n-\tTEMP +\u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D) + E + 0x5a827999; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP; \\\n-\n+\t/* Round 1 - iterations 0-16 take their input from \u0027data\u0027 */\n \tT_0_15( 0); T_0_15( 1); T_0_15( 2); T_0_15( 3); T_0_15( 4);\n \tT_0_15( 5); T_0_15( 6); T_0_15( 7); T_0_15( 8); T_0_15( 9);\n \tT_0_15(10); T_0_15(11); T_0_15(12); T_0_15(13); T_0_15(14);\n \tT_0_15(15);\n \n-/* This \"rolls\" over the 512-bit array */\n-#define W(x) (array[(x)\u002615])\n-#define SHA_XOR(t) \\\n-\tTEMP \u003d SHA_ROL(W(t+13) ^ W(t+8) ^ W(t+2) ^ W(t), 1); W(t) \u003d TEMP;\n-\n-#define T_16_19(t) \\\n-\tSHA_XOR(t); \\\n-\tTEMP +\u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D) + E + 0x5a827999; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP; \\\n-\n+\t/* Round 1 - tail. Input from 512-bit mixing array */\n \tT_16_19(16); T_16_19(17); T_16_19(18); T_16_19(19);\n \n-#define T_20_39(t) \\\n-\tSHA_XOR(t); \\\n-\tTEMP +\u003d SHA_ROL(A,5) + (B^C^D) + E + 0x6ed9eba1; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n-\n+\t/* Round 2 */\n \tT_20_39(20); T_20_39(21); T_20_39(22); T_20_39(23); T_20_39(24);\n \tT_20_39(25); T_20_39(26); T_20_39(27); T_20_39(28); T_20_39(29);\n \tT_20_39(30); T_20_39(31); T_20_39(32); T_20_39(33); T_20_39(34);\n \tT_20_39(35); T_20_39(36); T_20_39(37); T_20_39(38); T_20_39(39);\n \n-#define T_40_59(t) \\\n-\tSHA_XOR(t); \\\n-\tTEMP +\u003d SHA_ROL(A,5) + ((B\u0026C)|(D\u0026(B|C))) + E + 0x8f1bbcdc; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n-\n+\t/* Round 3 */\n \tT_40_59(40); T_40_59(41); T_40_59(42); T_40_59(43); T_40_59(44);\n \tT_40_59(45); T_40_59(46); T_40_59(47); T_40_59(48); T_40_59(49);\n \tT_40_59(50); T_40_59(51); T_40_59(52); T_40_59(53); T_40_59(54);\n \tT_40_59(55); T_40_59(56); T_40_59(57); T_40_59(58); T_40_59(59);\n \n-#define T_60_79(t) \\\n-\tSHA_XOR(t); \\\n-\tTEMP +\u003d SHA_ROL(A,5) + (B^C^D) + E + 0xca62c1d6; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n-\n+\t/* Round 4 */\n \tT_60_79(60); T_60_79(61); T_60_79(62); T_60_79(63); T_60_79(64);\n \tT_60_79(65); T_60_79(66); T_60_79(67); T_60_79(68); T_60_79(69);\n \tT_60_79(70); T_60_79(71); T_60_79(72); T_60_79(73); T_60_79(74);","expectedMessage":"block-sha1: macroize the rounds a bit further","repository":"git-linus","commitHash":"ab14c823dfbf1245712c8179952b51822135d8a8","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-7b5075fc","diff":" block-sha1/sha1.c | 28 ++++++++++++++++------------\n 1 file changed, 16 insertions(+), 12 deletions(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex 13da511b78..8c4c216f93 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -96,9 +96,8 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n \n static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n {\n-\tint t;\n \tunsigned int A,B,C,D,E,TEMP;\n-\tunsigned int W[80];\n+\tunsigned int array[16];\n \n \tA \u003d ctx-\u003eH[0];\n \tB \u003d ctx-\u003eH[1];\n@@ -107,8 +106,8 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tE \u003d ctx-\u003eH[4];\n \n #define T_0_15(t) \\\n-\tTEMP \u003d htonl(data[t]); W[t] \u003d TEMP; \\\n-\tTEMP +\u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D)     + E + 0x5a827999; \\\n+\tTEMP \u003d htonl(data[t]); array[t] \u003d TEMP; \\\n+\tTEMP +\u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D) + E + 0x5a827999; \\\n \tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP; \\\n \n \tT_0_15( 0); T_0_15( 1); T_0_15( 2); T_0_15( 3); T_0_15( 4);\n@@ -116,18 +115,21 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tT_0_15(10); T_0_15(11); T_0_15(12); T_0_15(13); T_0_15(14);\n \tT_0_15(15);\n \n-\t/* Unroll it? */\n-\tfor (t \u003d 16; t \u003c\u003d 79; t++)\n-\t\tW[t] \u003d SHA_ROL(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16], 1);\n+/* This \"rolls\" over the 512-bit array */\n+#define W(x) (array[(x)\u002615])\n+#define SHA_XOR(t) \\\n+\tTEMP \u003d SHA_ROL(W(t+13) ^ W(t+8) ^ W(t+2) ^ W(t), 1); W(t) \u003d TEMP;\n \n #define T_16_19(t) \\\n-\tTEMP \u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D)     + E + W[t] + 0x5a827999; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n+\tSHA_XOR(t); \\\n+\tTEMP +\u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D) + E + 0x5a827999; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP; \\\n \n \tT_16_19(16); T_16_19(17); T_16_19(18); T_16_19(19);\n \n #define T_20_39(t) \\\n-\tTEMP \u003d SHA_ROL(A,5) + (B^C^D)           + E + W[t] + 0x6ed9eba1; \\\n+\tSHA_XOR(t); \\\n+\tTEMP +\u003d SHA_ROL(A,5) + (B^C^D) + E + 0x6ed9eba1; \\\n \tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n \n \tT_20_39(20); T_20_39(21); T_20_39(22); T_20_39(23); T_20_39(24);\n@@ -136,7 +138,8 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tT_20_39(35); T_20_39(36); T_20_39(37); T_20_39(38); T_20_39(39);\n \n #define T_40_59(t) \\\n-\tTEMP \u003d SHA_ROL(A,5) + ((B\u0026C)|(D\u0026(B|C))) + E + W[t] + 0x8f1bbcdc; \\\n+\tSHA_XOR(t); \\\n+\tTEMP +\u003d SHA_ROL(A,5) + ((B\u0026C)|(D\u0026(B|C))) + E + 0x8f1bbcdc; \\\n \tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n \n \tT_40_59(40); T_40_59(41); T_40_59(42); T_40_59(43); T_40_59(44);\n@@ -145,7 +148,8 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tT_40_59(55); T_40_59(56); T_40_59(57); T_40_59(58); T_40_59(59);\n \n #define T_60_79(t) \\\n-\tTEMP \u003d SHA_ROL(A,5) + (B^C^D)           + E + W[t] + 0xca62c1d6; \\\n+\tSHA_XOR(t); \\\n+\tTEMP +\u003d SHA_ROL(A,5) + (B^C^D) + E + 0xca62c1d6; \\\n \tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n \n \tT_60_79(60); T_60_79(61); T_60_79(62); T_60_79(63); T_60_79(64);","expectedMessage":"block-sha1: re-use the temporary array as we calculate the SHA1","repository":"git-linus","commitHash":"7b5075fcfb069fc36ba4cfe5567234974793ab58","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-139e3456","diff":" block-sha1/sha1.c | 28 ++++++++++++++++------------\n 1 file changed, 16 insertions(+), 12 deletions(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex 698e435a39..13da511b78 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -100,27 +100,31 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tunsigned int A,B,C,D,E,TEMP;\n \tunsigned int W[80];\n \n-\tfor (t \u003d 0; t \u003c 16; t++)\n-\t\tW[t] \u003d htonl(data[t]);\n-\n-\t/* Unroll it? */\n-\tfor (t \u003d 16; t \u003c\u003d 79; t++)\n-\t\tW[t] \u003d SHA_ROL(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16], 1);\n-\n \tA \u003d ctx-\u003eH[0];\n \tB \u003d ctx-\u003eH[1];\n \tC \u003d ctx-\u003eH[2];\n \tD \u003d ctx-\u003eH[3];\n \tE \u003d ctx-\u003eH[4];\n \n-#define T_0_19(t) \\\n+#define T_0_15(t) \\\n+\tTEMP \u003d htonl(data[t]); W[t] \u003d TEMP; \\\n+\tTEMP +\u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D)     + E + 0x5a827999; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP; \\\n+\n+\tT_0_15( 0); T_0_15( 1); T_0_15( 2); T_0_15( 3); T_0_15( 4);\n+\tT_0_15( 5); T_0_15( 6); T_0_15( 7); T_0_15( 8); T_0_15( 9);\n+\tT_0_15(10); T_0_15(11); T_0_15(12); T_0_15(13); T_0_15(14);\n+\tT_0_15(15);\n+\n+\t/* Unroll it? */\n+\tfor (t \u003d 16; t \u003c\u003d 79; t++)\n+\t\tW[t] \u003d SHA_ROL(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16], 1);\n+\n+#define T_16_19(t) \\\n \tTEMP \u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D)     + E + W[t] + 0x5a827999; \\\n \tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n \n-\tT_0_19( 0); T_0_19( 1); T_0_19( 2); T_0_19( 3); T_0_19( 4);\n-\tT_0_19( 5); T_0_19( 6); T_0_19( 7); T_0_19( 8); T_0_19( 9);\n-\tT_0_19(10); T_0_19(11); T_0_19(12); T_0_19(13); T_0_19(14);\n-\tT_0_19(15); T_0_19(16); T_0_19(17); T_0_19(18); T_0_19(19);\n+\tT_16_19(16); T_16_19(17); T_16_19(18); T_16_19(19);\n \n #define T_20_39(t) \\\n \tTEMP \u003d SHA_ROL(A,5) + (B^C^D)           + E + W[t] + 0x6ed9eba1; \\","expectedMessage":"block-sha1: make the \u0027ntohl()\u0027 part of the first SHA1 loop","repository":"git-linus","commitHash":"139e3456ecf18fc03a75eda7a77441e8fec344b9","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-b8e48a89","diff":" block-sha1/sha1.c | 32 ++++++++++++++++++++++----------\n 1 file changed, 22 insertions(+), 10 deletions(-)\n\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nindex eef32f7859..a45a3dec1e 100644\n--- a/block-sha1/sha1.c\n+++ b/block-sha1/sha1.c\n@@ -80,7 +80,19 @@ void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n \t\t((unsigned int *)hashout)[i] \u003d htonl(ctx-\u003eH[i]);\n }\n \n-#define SHA_ROT(X,n) (((X) \u003c\u003c (n)) | ((X) \u003e\u003e (32-(n))))\n+#if defined(__i386__) || defined(__x86_64__)\n+\n+#define SHA_ASM(op, x, n) ({ unsigned int __res; asm(op \" %1,%0\":\"\u003dr\" (__res):\"i\" (n), \"0\" (x)); __res; })\n+#define SHA_ROL(x,n)\tSHA_ASM(\"rol\", x, n)\n+#define SHA_ROR(x,n)\tSHA_ASM(\"ror\", x, n)\n+\n+#else\n+\n+#define SHA_ROT(X,n)\t(((X) \u003c\u003c (l)) | ((X) \u003e\u003e (r)))\n+#define SHA_ROL(X,n)\tSHA_ROT(X,n,32-(n))\n+#define SHA_ROR(X,n)\tSHA_ROT(X,32-(n),n)\n+\n+#endif\n \n static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n {\n@@ -93,7 +105,7 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \n \t/* Unroll it? */\n \tfor (t \u003d 16; t \u003c\u003d 79; t++)\n-\t\tW[t] \u003d SHA_ROT(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16], 1);\n+\t\tW[t] \u003d SHA_ROL(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16], 1);\n \n \tA \u003d ctx-\u003eH[0];\n \tB \u003d ctx-\u003eH[1];\n@@ -102,8 +114,8 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tE \u003d ctx-\u003eH[4];\n \n #define T_0_19(t) \\\n-\tTEMP \u003d SHA_ROT(A,5) + (((C^D)\u0026B)^D)     + E + W[t] + 0x5a827999; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROT(B, 30); B \u003d A; A \u003d TEMP;\n+\tTEMP \u003d SHA_ROL(A,5) + (((C^D)\u0026B)^D)     + E + W[t] + 0x5a827999; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n \n \tT_0_19( 0); T_0_19( 1); T_0_19( 2); T_0_19( 3); T_0_19( 4);\n \tT_0_19( 5); T_0_19( 6); T_0_19( 7); T_0_19( 8); T_0_19( 9);\n@@ -111,8 +123,8 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tT_0_19(15); T_0_19(16); T_0_19(17); T_0_19(18); T_0_19(19);\n \n #define T_20_39(t) \\\n-\tTEMP \u003d SHA_ROT(A,5) + (B^C^D)           + E + W[t] + 0x6ed9eba1; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROT(B, 30); B \u003d A; A \u003d TEMP;\n+\tTEMP \u003d SHA_ROL(A,5) + (B^C^D)           + E + W[t] + 0x6ed9eba1; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n \n \tT_20_39(20); T_20_39(21); T_20_39(22); T_20_39(23); T_20_39(24);\n \tT_20_39(25); T_20_39(26); T_20_39(27); T_20_39(28); T_20_39(29);\n@@ -120,8 +132,8 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tT_20_39(35); T_20_39(36); T_20_39(37); T_20_39(38); T_20_39(39);\n \n #define T_40_59(t) \\\n-\tTEMP \u003d SHA_ROT(A,5) + ((B\u0026C)|(D\u0026(B|C))) + E + W[t] + 0x8f1bbcdc; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROT(B, 30); B \u003d A; A \u003d TEMP;\n+\tTEMP \u003d SHA_ROL(A,5) + ((B\u0026C)|(D\u0026(B|C))) + E + W[t] + 0x8f1bbcdc; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n \n \tT_40_59(40); T_40_59(41); T_40_59(42); T_40_59(43); T_40_59(44);\n \tT_40_59(45); T_40_59(46); T_40_59(47); T_40_59(48); T_40_59(49);\n@@ -129,8 +141,8 @@ static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n \tT_40_59(55); T_40_59(56); T_40_59(57); T_40_59(58); T_40_59(59);\n \n #define T_60_79(t) \\\n-\tTEMP \u003d SHA_ROT(A,5) + (B^C^D)           + E + W[t] + 0xca62c1d6; \\\n-\tE \u003d D; D \u003d C; C \u003d SHA_ROT(B, 30); B \u003d A; A \u003d TEMP;\n+\tTEMP \u003d SHA_ROL(A,5) + (B^C^D)           + E + W[t] + 0xca62c1d6; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROR(B, 2); B \u003d A; A \u003d TEMP;\n \n \tT_60_79(60); T_60_79(61); T_60_79(62); T_60_79(63); T_60_79(64);\n \tT_60_79(65); T_60_79(66); T_60_79(67); T_60_79(68); T_60_79(69);","expectedMessage":"block-sha1: try to use rol/ror appropriately","repository":"git-linus","commitHash":"b8e48a89b8f581eaf95b57782bb8e620ca30e968","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
{"id":"git-linus-d7c208a9","diff":" Makefile          |   9 ++++\n block-sha1/sha1.c | 145 ++++++++++++++++++++++++++++++++++++++++++++++++++++++\n block-sha1/sha1.h |  21 ++++++++\n 3 files changed, 175 insertions(+)\n\ndiff --git a/Makefile b/Makefile\nindex daf4296706..e6df8ecde6 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -84,6 +84,10 @@ all::\n # specify your own (or DarwinPort\u0027s) include directories and\n # library directories by defining CFLAGS and LDFLAGS appropriately.\n #\n+# Define BLK_SHA1 environment variable if you want the C version\n+# of the SHA1 that assumes you can do unaligned 32-bit loads and\n+# have a fast htonl() function.\n+#\n # Define PPC_SHA1 environment variable when running make to make use of\n # a bundled SHA1 routine optimized for PowerPC.\n #\n@@ -1167,6 +1171,10 @@ ifdef NO_DEFLATE_BOUND\n \tBASIC_CFLAGS +\u003d -DNO_DEFLATE_BOUND\n endif\n \n+ifdef BLK_SHA1\n+\tSHA1_HEADER \u003d \"block-sha1/sha1.h\"\n+\tLIB_OBJS +\u003d block-sha1/sha1.o\n+else\n ifdef PPC_SHA1\n \tSHA1_HEADER \u003d \"ppc/sha1.h\"\n \tLIB_OBJS +\u003d ppc/sha1.o ppc/sha1ppc.o\n@@ -1184,6 +1192,7 @@ else\n endif\n endif\n endif\n+endif\n ifdef NO_PERL_MAKEMAKER\n \texport NO_PERL_MAKEMAKER\n endif\ndiff --git a/block-sha1/sha1.c b/block-sha1/sha1.c\nnew file mode 100644\nindex 0000000000..50b2b42b03\n--- /dev/null\n+++ b/block-sha1/sha1.c\n@@ -0,0 +1,145 @@\n+/*\n+ * Based on the Mozilla SHA1 (see mozilla-sha1/sha1.c),\n+ * optimized to do word accesses rather than byte accesses,\n+ * and to avoid unnecessary copies into the context array.\n+ */\n+\n+#include \u003cstring.h\u003e\n+#include \u003carpa/inet.h\u003e\n+\n+#include \"sha1.h\"\n+\n+/* Hash one 64-byte block of data */\n+static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data);\n+\n+void blk_SHA1_Init(blk_SHA_CTX *ctx)\n+{\n+\tctx-\u003elenW \u003d 0;\n+\tctx-\u003esize \u003d 0;\n+\n+\t/* Initialize H with the magic constants (see FIPS180 for constants)\n+\t */\n+\tctx-\u003eH[0] \u003d 0x67452301;\n+\tctx-\u003eH[1] \u003d 0xefcdab89;\n+\tctx-\u003eH[2] \u003d 0x98badcfe;\n+\tctx-\u003eH[3] \u003d 0x10325476;\n+\tctx-\u003eH[4] \u003d 0xc3d2e1f0;\n+}\n+\n+\n+void blk_SHA1_Update(blk_SHA_CTX *ctx, const void *data, unsigned long len)\n+{\n+\tint lenW \u003d ctx-\u003elenW;\n+\n+\tctx-\u003esize +\u003d len;\n+\n+\t/* Read the data into W and process blocks as they get full\n+\t */\n+\tif (lenW) {\n+\t\tint left \u003d 64 - lenW;\n+\t\tif (len \u003c left)\n+\t\t\tleft \u003d len;\n+\t\tmemcpy(lenW + (char *)ctx-\u003eW, data, left);\n+\t\tlenW \u003d (lenW + left) \u0026 63;\n+\t\tlen -\u003d left;\n+\t\tdata +\u003d left;\n+\t\tctx-\u003elenW \u003d lenW;\n+\t\tif (lenW)\n+\t\t\treturn;\n+\t\tblk_SHA1Block(ctx, ctx-\u003eW);\n+\t}\n+\twhile (len \u003e\u003d 64) {\n+\t\tblk_SHA1Block(ctx, data);\n+\t\tdata +\u003d 64;\n+\t\tlen -\u003d 64;\n+\t}\n+\tif (len) {\n+\t\tmemcpy(ctx-\u003eW, data, len);\n+\t\tctx-\u003elenW \u003d len;\n+\t}\n+}\n+\n+\n+void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx)\n+{\n+\tstatic const unsigned char pad[64] \u003d { 0x80 };\n+\tunsigned int padlen[2];\n+\tint i;\n+\n+\t/* Pad with a binary 1 (ie 0x80), then zeroes, then length\n+\t */\n+\tpadlen[0] \u003d htonl(ctx-\u003esize \u003e\u003e (32 - 3));\n+\tpadlen[1] \u003d htonl(ctx-\u003esize \u003c\u003c 3);\n+\n+\tblk_SHA1_Update(ctx, pad, 1+ (63 \u0026 (55 - ctx-\u003elenW)));\n+\tblk_SHA1_Update(ctx, padlen, 8);\n+\n+\t/* Output hash\n+\t */\n+\tfor (i \u003d 0; i \u003c 5; i++)\n+\t\t((unsigned int *)hashout)[i] \u003d htonl(ctx-\u003eH[i]);\n+}\n+\n+#define SHA_ROT(X,n) (((X) \u003c\u003c (n)) | ((X) \u003e\u003e (32-(n))))\n+\n+static void blk_SHA1Block(blk_SHA_CTX *ctx, const unsigned int *data)\n+{\n+\tint t;\n+\tunsigned int A,B,C,D,E,TEMP;\n+\tunsigned int W[80];\n+\n+\tfor (t \u003d 0; t \u003c 16; t++)\n+\t\tW[t] \u003d htonl(data[t]);\n+\n+\t/* Unroll it? */\n+\tfor (t \u003d 16; t \u003c\u003d 79; t++)\n+\t\tW[t] \u003d SHA_ROT(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16], 1);\n+\n+\tA \u003d ctx-\u003eH[0];\n+\tB \u003d ctx-\u003eH[1];\n+\tC \u003d ctx-\u003eH[2];\n+\tD \u003d ctx-\u003eH[3];\n+\tE \u003d ctx-\u003eH[4];\n+\n+#define T_0_19(t) \\\n+\tTEMP \u003d SHA_ROT(A,5) + (((C^D)\u0026B)^D)     + E + W[t] + 0x5a827999; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROT(B, 30); B \u003d A; A \u003d TEMP;\n+\n+\tT_0_19( 0); T_0_19( 1); T_0_19( 2); T_0_19( 3); T_0_19( 4);\n+\tT_0_19( 5); T_0_19( 6); T_0_19( 7); T_0_19( 8); T_0_19( 9);\n+\tT_0_19(10); T_0_19(11); T_0_19(12); T_0_19(13); T_0_19(14);\n+\tT_0_19(15); T_0_19(16); T_0_19(17); T_0_19(18); T_0_19(19);\n+\n+#define T_20_39(t) \\\n+\tTEMP \u003d SHA_ROT(A,5) + (B^C^D)           + E + W[t] + 0x6ed9eba1; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROT(B, 30); B \u003d A; A \u003d TEMP;\n+\n+\tT_20_39(20); T_20_39(21); T_20_39(22); T_20_39(23); T_20_39(24);\n+\tT_20_39(25); T_20_39(26); T_20_39(27); T_20_39(28); T_20_39(29);\n+\tT_20_39(30); T_20_39(31); T_20_39(32); T_20_39(33); T_20_39(34);\n+\tT_20_39(35); T_20_39(36); T_20_39(37); T_20_39(38); T_20_39(39);\n+\n+#define T_40_59(t) \\\n+\tTEMP \u003d SHA_ROT(A,5) + ((B\u0026C)|(D\u0026(B|C))) + E + W[t] + 0x8f1bbcdc; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROT(B, 30); B \u003d A; A \u003d TEMP;\n+\n+\tT_40_59(40); T_40_59(41); T_40_59(42); T_40_59(43); T_40_59(44);\n+\tT_40_59(45); T_40_59(46); T_40_59(47); T_40_59(48); T_40_59(49);\n+\tT_40_59(50); T_40_59(51); T_40_59(52); T_40_59(53); T_40_59(54);\n+\tT_40_59(55); T_40_59(56); T_40_59(57); T_40_59(58); T_40_59(59);\n+\n+#define T_60_79(t) \\\n+\tTEMP \u003d SHA_ROT(A,5) + (B^C^D)           + E + W[t] + 0xca62c1d6; \\\n+\tE \u003d D; D \u003d C; C \u003d SHA_ROT(B, 30); B \u003d A; A \u003d TEMP;\n+\n+\tT_60_79(60); T_60_79(61); T_60_79(62); T_60_79(63); T_60_79(64);\n+\tT_60_79(65); T_60_79(66); T_60_79(67); T_60_79(68); T_60_79(69);\n+\tT_60_79(70); T_60_79(71); T_60_79(72); T_60_79(73); T_60_79(74);\n+\tT_60_79(75); T_60_79(76); T_60_79(77); T_60_79(78); T_60_79(79);\n+\n+\tctx-\u003eH[0] +\u003d A;\n+\tctx-\u003eH[1] +\u003d B;\n+\tctx-\u003eH[2] +\u003d C;\n+\tctx-\u003eH[3] +\u003d D;\n+\tctx-\u003eH[4] +\u003d E;\n+}\ndiff --git a/block-sha1/sha1.h b/block-sha1/sha1.h\nnew file mode 100644\nindex 0000000000..7be2d93a2a\n--- /dev/null\n+++ b/block-sha1/sha1.h\n@@ -0,0 +1,21 @@\n+/*\n+ * Based on the Mozilla SHA1 (see mozilla-sha1/sha1.h),\n+ * optimized to do word accesses rather than byte accesses,\n+ * and to avoid unnecessary copies into the context array.\n+ */\n+\n+typedef struct {\n+\tunsigned int H[5];\n+\tunsigned int W[16];\n+\tint lenW;\n+\tunsigned long long size;\n+} blk_SHA_CTX;\n+\n+void blk_SHA1_Init(blk_SHA_CTX *ctx);\n+void blk_SHA1_Update(blk_SHA_CTX *ctx, const void *dataIn, unsigned long len);\n+void blk_SHA1_Final(unsigned char hashout[20], blk_SHA_CTX *ctx);\n+\n+#define git_SHA_CTX\tblk_SHA_CTX\n+#define git_SHA1_Init\tblk_SHA1_Init\n+#define git_SHA1_Update\tblk_SHA1_Update\n+#define git_SHA1_Final\tblk_SHA1_Final","expectedMessage":"Add new optimized C \u0027block-sha1\u0027 routines","repository":"git-linus","commitHash":"d7c208a92e6b15cdcd159e30cd1fc0177fd967e9","metadata":{"author":"Linus Torvalds \u003ctorvalds@linux-foundation.org\u003e"}}
