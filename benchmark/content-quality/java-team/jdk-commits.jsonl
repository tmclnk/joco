{"id":"jdk-30cda000","diff":" src/java.base/linux/native/libnio/ch/FileDispatcherImpl.c    | 5 +++--\n src/java.base/linux/native/libnio/fs/LinuxNativeDispatcher.c | 3 ++-\n 2 files changed, 5 insertions(+), 3 deletions(-)\n\ndiff --git a/src/java.base/linux/native/libnio/ch/FileDispatcherImpl.c b/src/java.base/linux/native/libnio/ch/FileDispatcherImpl.c\nindex efbd0ca56..54d640b03 100644\n--- a/src/java.base/linux/native/libnio/ch/FileDispatcherImpl.c\n+++ b/src/java.base/linux/native/libnio/ch/FileDispatcherImpl.c\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2000, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -63,7 +63,7 @@ Java_sun_nio_ch_FileDispatcherImpl_transferFrom0(JNIEnv *env, jobject this,\n     if (n \u003c 0) {\n         if (errno \u003d\u003d EAGAIN)\n             return IOS_UNAVAILABLE;\n-        if (errno \u003d\u003d ENOSYS)\n+        if (errno \u003d\u003d ENOSYS || errno \u003d\u003d EOPNOTSUPP)\n             return IOS_UNSUPPORTED_CASE;\n         if ((errno \u003d\u003d EBADF || errno \u003d\u003d EINVAL || errno \u003d\u003d EXDEV) \u0026\u0026\n             ((ssize_t)count \u003e\u003d 0))\n@@ -103,6 +103,7 @@ Java_sun_nio_ch_FileDispatcherImpl_transferTo0(JNIEnv *env, jobject this,\n                 case EINVAL:\n                 case ENOSYS:\n                 case EXDEV:\n+                case EOPNOTSUPP:\n                     // ignore and try sendfile()\n                     break;\n                 default:\ndiff --git a/src/java.base/linux/native/libnio/fs/LinuxNativeDispatcher.c b/src/java.base/linux/native/libnio/fs/LinuxNativeDispatcher.c\nindex c90e99dda..4677411b0 100644\n--- a/src/java.base/linux/native/libnio/fs/LinuxNativeDispatcher.c\n+++ b/src/java.base/linux/native/libnio/fs/LinuxNativeDispatcher.c\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2008, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -193,6 +193,7 @@ Java_sun_nio_fs_LinuxNativeDispatcher_directCopy0\n                     case EINVAL:\n                     case ENOSYS:\n                     case EXDEV:\n+                    case EOPNOTSUPP:\n                         // ignore and try sendfile()\n                         break;\n                     default:","expectedMessage":"8375294: (fs) Files.copy can fail with EOPNOTSUPP when copy_file_range not supported","repository":"jdk","commitHash":"30cda00010888b6e9a2bf8cdeaedbb3eb4b6a222","metadata":{"author":"Brian Burkhalter \u003cbpb@openjdk.org\u003e"}}
{"id":"jdk-a8b845e0","diff":" src/hotspot/share/jfr/utilities/jfrSet.hpp | 17 ++++++++++-------\n 1 file changed, 10 insertions(+), 7 deletions(-)\n\ndiff --git a/src/hotspot/share/jfr/utilities/jfrSet.hpp b/src/hotspot/share/jfr/utilities/jfrSet.hpp\nindex 1432d40e4..3d394d10d 100644\n--- a/src/hotspot/share/jfr/utilities/jfrSet.hpp\n+++ b/src/hotspot/share/jfr/utilities/jfrSet.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -25,6 +25,7 @@\n #ifndef SHARE_JFR_UTILITIES_JFRSET_HPP\n #define SHARE_JFR_UTILITIES_JFRSET_HPP\n \n+#include \"cppstdlib/new.hpp\"\n #include \"jfr/utilities/jfrTypes.hpp\"\n #include \"memory/allocation.hpp\"\n \n@@ -67,7 +68,9 @@ class JfrSetStorage : public AnyObj {\n     } else {\n       table \u003d NEW_RESOURCE_ARRAY(K, table_size);\n     }\n-    memset(table, 0, table_size * sizeof(K));\n+    for (unsigned i \u003d 0; i \u003c table_size; ++i) {\n+      ::new (\u0026table[i]) K{};\n+    }\n     return table;\n   }\n \n@@ -88,7 +91,7 @@ class JfrSetStorage : public AnyObj {\n     assert(is_nonempty(), \"invariant\");\n     for (unsigned i \u003d 0; i \u003c _table_size; ++i) {\n       K k \u003d _table[i];\n-      if (k !\u003d 0) {\n+      if (k !\u003d K{}) {\n         functor(k);\n       }\n     }\n@@ -136,11 +139,11 @@ class JfrSet : public JfrSetStorage\u003cCONFIG\u003e {\n     _resize_threshold \u003d old_table_size;\n     for (unsigned i \u003d 0; i \u003c old_table_size; ++i) {\n       const K k \u003d old_table[i];\n-      if (k !\u003d 0) {\n+      if (k !\u003d K{}) {\n         uint32_t idx \u003d slot_idx(CONFIG::hash(k));\n         do {\n           K v \u003d this-\u003e_table[idx];\n-          if (v \u003d\u003d 0) {\n+          if (v \u003d\u003d K{}) {\n             this-\u003e_table[idx] \u003d k;\n             break;\n           }\n@@ -161,7 +164,7 @@ class JfrSet : public JfrSetStorage\u003cCONFIG\u003e {\n     K* result \u003d nullptr;\n     while (true) {\n       K v \u003d this-\u003e_table[idx];\n-      if (v \u003d\u003d 0) {\n+      if (v \u003d\u003d K{}) {\n         result \u003d \u0026this-\u003e_table[idx];\n         break;\n       }\n@@ -196,7 +199,7 @@ class JfrSet : public JfrSetStorage\u003cCONFIG\u003e {\n       // Already exists.\n       return false;\n     }\n-    assert(*slot \u003d\u003d 0, \"invariant\");\n+    assert(*slot \u003d\u003d K{}, \"invariant\");\n     *slot \u003d k;\n     if (++this-\u003e_elements \u003d\u003d _resize_threshold) {\n       resize();","expectedMessage":"8374445: Fix -Wzero-as-null-pointer-constant warnings in JfrSet","repository":"jdk","commitHash":"a8b845e08ce2f1fbe7d807cd963cb6b5e4df5ce6","metadata":{"author":"Kim Barrett \u003ckbarrett@openjdk.org\u003e"}}
{"id":"jdk-25c834a8","diff":" src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_general.c | 8 +++++++-\n 1 file changed, 7 insertions(+), 1 deletion(-)\n\ndiff --git a/src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_general.c b/src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_general.c\nindex e9bcf597a..f61b8a5fb 100644\n--- a/src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_general.c\n+++ b/src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_general.c\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2003, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2026, Oracle and/or its affiliates. All rights reserved.\n  */\n \n /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.\n@@ -100,6 +100,12 @@ Java_sun_security_pkcs11_wrapper_PKCS11_initializeLibrary\n #ifndef NO_CALLBACKS\n     if (notifyListLock \u003d\u003d NULL) {\n         notifyListLock \u003d createLockObject(env);\n+\n+        /* Return immediately if lock creation failed or an exception is pending. */\n+        if (notifyListLock \u003d\u003d NULL || (*env)-\u003eExceptionCheck(env)) {\n+            TRACE0(\"DEBUG: createLockObject failed, aborting initialization\\n\");\n+            return;\n+        }\n     }\n #endif\n ","expectedMessage":"8366807: JNI exception pending in Java_sun_security_pkcs11_wrapper_PKCS11_initializeLibrary of p11_general.c:106","repository":"jdk","commitHash":"25c834a897ac0cac94942a019c9e377a53851f2c","metadata":{"author":"Koushik Thirupattur \u003ckoushik.thirupattur@oracle.com\u003e"}}
{"id":"jdk-e97fb0e2","diff":" .../share/native/libj2pkcs11/p11_keymgmt.c                   | 12 +++++++++---\n 1 file changed, 9 insertions(+), 3 deletions(-)\n\ndiff --git a/src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_keymgmt.c b/src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_keymgmt.c\nindex f2e1a4656..e540f3b5e 100644\n--- a/src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_keymgmt.c\n+++ b/src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_keymgmt.c\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2003, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2026, Oracle and/or its affiliates. All rights reserved.\n  */\n \n /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.\n@@ -929,6 +929,11 @@ JNIEXPORT jlong JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DeriveKey\n     rv \u003d (*ckpFunctions-\u003eC_DeriveKey)(ckSessionHandle, ckpMechanism, ckBaseKeyHandle,\n                  ckpAttributes, ckAttributesLength, phKey);\n \n+    /* If derivation failed, do not attempt copy-back */\n+    if (ckAssertReturnValueOK(env, rv) !\u003d CK_ASSERT_OK) {\n+        goto cleanup;\n+    }\n+\n     jKeyHandle \u003d ckLongToJLong(ckKeyHandle);\n \n     switch (ckpMechanism-\u003emechanism) {\n@@ -956,8 +961,9 @@ JNIEXPORT jlong JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DeriveKey\n         // empty\n         break;\n     }\n-    if (ckAssertReturnValueOK(env, rv) !\u003d CK_ASSERT_OK) {\n-        jKeyHandle \u003d0L;\n+    /* Do not continue if any copy-back operation raised an exception */\n+    if ((*env)-\u003eExceptionCheck(env)) {\n+        goto cleanup;\n     }\n \n cleanup:","expectedMessage":"8367024: JNI exception pending in Java_sun_security_pkcs11_wrapper_PKCS11_C_1DeriveKey of p11_keymgmt.c:950","repository":"jdk","commitHash":"e97fb0e2072a16c59014599719b64e8ea52a4976","metadata":{"author":"Koushik Thirupattur \u003ckoushik.thirupattur@oracle.com\u003e"}}
{"id":"jdk-3f01e8b9","diff":" .../share/classes/java/security/CodeSource.java    |   9 +-\n .../security/CodeSource/CodeSourceNoInputs.java    | 110 +++++++++++++++++++++\n 2 files changed, 117 insertions(+), 2 deletions(-)\n\ndiff --git a/src/java.base/share/classes/java/security/CodeSource.java b/src/java.base/share/classes/java/security/CodeSource.java\nindex 7476b8a1d..9e69b2f08 100644\n--- a/src/java.base/share/classes/java/security/CodeSource.java\n+++ b/src/java.base/share/classes/java/security/CodeSource.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1997, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -238,7 +238,12 @@ public final CodeSigner[] getCodeSigners() {\n         } else if (certs !\u003d null) {\n             // Convert the certs to code signers\n             signers \u003d convertCertArrayToSignerArray(certs);\n-            return signers.clone();\n+            if (signers !\u003d null) {\n+                return signers.clone();\n+\n+            } else {\n+                return new CodeSigner[0];\n+            }\n \n         } else {\n             return null;\ndiff --git a/test/jdk/java/security/CodeSource/CodeSourceNoInputs.java b/test/jdk/java/security/CodeSource/CodeSourceNoInputs.java\nnew file mode 100644\nindex 000000000..e1d249766\n--- /dev/null\n+++ b/test/jdk/java/security/CodeSource/CodeSourceNoInputs.java\n@@ -0,0 +1,110 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+\n+import java.security.CodeSigner;\n+import java.security.CodeSource;\n+import java.security.PublicKey;\n+import java.security.cert.Certificate;\n+\n+/**\n+ * @test\n+ * @bug 8366522\n+ * @summary Verify that getCertificates() and getCodeSigners() return correct\n+ *          results when CodeSource is created with empty or null Certificate[]\n+ *          or CodeSigner[] arguments, or there are no X509 certificates in\n+ *          certs. Make sure that NPE is not thrown from\n+ *          CodeSource.getCodeSigners()\n+ */\n+public class CodeSourceNoInputs {\n+    private static final Certificate NON_X509_CERT \u003d new Certificate(\"\") {\n+        @Override\n+        public byte[] getEncoded() {\n+            return new byte[0];\n+        }\n+\n+        @Override\n+        public void verify(PublicKey key) {\n+        }\n+\n+        @Override\n+        public void verify(PublicKey key, String sigProvider) {\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return \"\";\n+        }\n+\n+        @Override\n+        public PublicKey getPublicKey() {\n+            return null;\n+        }\n+    };\n+\n+    public static void main(String[] args) throws Exception {\n+        CodeSource cs;\n+\n+        cs \u003d new CodeSource(null, (Certificate[]) null);\n+        if (cs.getCodeSigners() !\u003d null || cs.getCertificates() !\u003d null) {\n+\n+            throw new SecurityException(\"Both CodeSource.getCodeSigners() \" +\n+                \"and CodeSource.getCertificates() should return null for \" +\n+                \"new CodeSource(null, (Certificate[]) null)\");\n+        }\n+\n+        cs \u003d new CodeSource(null, (CodeSigner[]) null);\n+        if (cs.getCodeSigners() !\u003d null || cs.getCertificates() !\u003d null) {\n+\n+            throw new SecurityException(\"Both CodeSource.getCodeSigners() \" +\n+                \"and CodeSource.getCertificates() should return null for \" +\n+                \"new CodeSource(null, (CodeSigners[]) null)\");\n+        }\n+\n+        cs \u003d new CodeSource(null, new Certificate[0]);\n+        if (cs.getCodeSigners().length !\u003d 0\n+            || cs.getCertificates().length !\u003d 0) {\n+\n+            throw new SecurityException(\"Both CodeSource.getCodeSigners()\" +\n+                \"and CodeSource.getCertificates() should return empty arrays \" +\n+                \"for new CodeSource(null, new Certificate[0])\");\n+\n+        }\n+\n+        cs \u003d new CodeSource(null, new CodeSigner[0]);\n+        if (cs.getCodeSigners().length !\u003d 0\n+            || cs.getCertificates().length !\u003d 0) {\n+\n+            throw new SecurityException(\"Both CodeSource.getCodeSigners() and\" +\n+                \" CodeSource.getCertificates() should return empty arrays for\" +\n+                \" new CodeSource(null, new CodeSigners[0])\");\n+        }\n+\n+        cs \u003d new CodeSource(null, new Certificate[]{NON_X509_CERT});\n+        if (cs.getCodeSigners().length !\u003d 0 || cs.getCertificates() \u003d\u003d null) {\n+\n+            throw new SecurityException(\"Both CodeSource.getCodeSigners() and\" +\n+                \" CodeSource.getCertificates() should return arrays for new\" +\n+                \" CodeSource(null, new CodeSigners[1]{NON-X509-CERTIFICATE})\");\n+        }\n+    }\n+}","expectedMessage":"8366522: CodeSource.getCodeSigners() throws NPE within empty certs","repository":"jdk","commitHash":"3f01e8b9b8f68560545540f9a70391a7ff7726d0","metadata":{"author":"Kirill Shirokov \u003ckirshiro@amazon.com\u003e"}}
{"id":"jdk-ee0387be","diff":" src/java.base/share/man/java.md | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/src/java.base/share/man/java.md b/src/java.base/share/man/java.md\nindex 4343df663..956a6aa14 100644\n--- a/src/java.base/share/man/java.md\n+++ b/src/java.base/share/man/java.md\n@@ -3283,7 +3283,7 @@ ### Description\n The following provides quick reference to the `-Xlog` command and syntax for\n options:\n \n-[`-Xlog`]{#-Xlog}\n+`-Xlog`\n :   Enables JVM logging on an `info` level.\n \n `-Xlog:help`","expectedMessage":"8375342: jdk/javadoc/doccheck/checks/jdkCheckHtml.java failed with duplicate anchors","repository":"jdk","commitHash":"ee0387be4c562c7f7ad5240f412d4d5363358855","metadata":{"author":"Roger Calnan \u003croger.calnan@oracle.com\u003e"}}
{"id":"jdk-203eb701","diff":" src/java.base/unix/native/libjava/ProcessImpl_md.c |  13 +-\n .../java/lang/ProcessBuilder/PipelineLeaksFD.java  | 261 +++++++++++++++++----\n test/jdk/java/lang/ProcessBuilder/TEST.properties  |   1 +\n 3 files changed, 229 insertions(+), 46 deletions(-)\n\ndiff --git a/src/java.base/unix/native/libjava/ProcessImpl_md.c b/src/java.base/unix/native/libjava/ProcessImpl_md.c\nindex f7531ad5a..12597fbb6 100644\n--- a/src/java.base/unix/native/libjava/ProcessImpl_md.c\n+++ b/src/java.base/unix/native/libjava/ProcessImpl_md.c\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1995, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1995, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -729,12 +729,13 @@ Java_java_lang_ProcessImpl_forkAndExec(JNIEnv *env,\n \n     if ((fds[0] \u003d\u003d -1 \u0026\u0026 pipe(in)  \u003c 0) ||\n         (fds[1] \u003d\u003d -1 \u0026\u0026 pipe(out) \u003c 0) ||\n-        (fds[2] \u003d\u003d -1 \u0026\u0026 pipe(err) \u003c 0) ||\n+        (fds[2] \u003d\u003d -1 \u0026\u0026 !redirectErrorStream \u0026\u0026 pipe(err) \u003c 0) || // if not redirecting create the pipe\n         (pipe(childenv) \u003c 0) ||\n         (pipe(fail) \u003c 0)) {\n         throwInternalIOException(env, errno, \"Bad file descriptor\", mode);\n         goto Catch;\n     }\n+\n     c-\u003efds[0] \u003d fds[0];\n     c-\u003efds[1] \u003d fds[1];\n     c-\u003efds[2] \u003d fds[2];\n@@ -764,17 +765,19 @@ Java_java_lang_ProcessImpl_forkAndExec(JNIEnv *env,\n     assert(resultPid !\u003d 0);\n \n     if (resultPid \u003c 0) {\n+        char * failMessage \u003d \"unknown\";\n         switch (c-\u003emode) {\n           case MODE_VFORK:\n-            throwInternalIOException(env, errno, \"vfork failed\", c-\u003emode);\n+            failMessage \u003d \"vfork failed\";\n             break;\n           case MODE_FORK:\n-            throwInternalIOException(env, errno, \"fork failed\", c-\u003emode);\n+            failMessage \u003d \"fork failed\";\n             break;\n           case MODE_POSIX_SPAWN:\n-            throwInternalIOException(env, errno, \"posix_spawn failed\", c-\u003emode);\n+            failMessage \u003d \"posix_spawn failed\";\n             break;\n         }\n+        throwInternalIOException(env, errno, failMessage, c-\u003emode);\n         goto Catch;\n     }\n     close(fail[1]); fail[1] \u003d -1; /* See: WhyCantJohnnyExec  (childproc.c)  */\ndiff --git a/test/jdk/java/lang/ProcessBuilder/PipelineLeaksFD.java b/test/jdk/java/lang/ProcessBuilder/PipelineLeaksFD.java\nindex d3c44bc92..2b4cdfa9b 100644\n--- a/test/jdk/java/lang/ProcessBuilder/PipelineLeaksFD.java\n+++ b/test/jdk/java/lang/ProcessBuilder/PipelineLeaksFD.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2022, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -21,32 +21,42 @@\n  * questions.\n  */\n \n-import org.testng.Assert;\n-import org.testng.annotations.DataProvider;\n-import org.testng.annotations.Test;\n+import org.junit.jupiter.api.condition.EnabledIf;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import static org.junit.jupiter.api.Assertions.*;\n \n import java.io.BufferedReader;\n-import java.io.File;\n import java.io.IOException;\n import java.io.Writer;\n+import java.lang.ProcessHandle;\n import java.nio.file.Files;\n import java.nio.file.Path;\n+import java.util.HashMap;\n import java.util.HashSet;\n+import java.util.LinkedHashSet;\n import java.util.List;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n /*\n  * @test\n- * @bug 8289643 8291760\n- * @requires (os.family \u003d\u003d \"linux\" \u0026 !vm.musl)\n+ * @bug 8289643 8291760 8291986\n+ * @requires os.family \u003d\u003d \"mac\" | (os.family \u003d\u003d \"linux\" \u0026 !vm.musl)\n  * @summary File descriptor leak detection with ProcessBuilder.startPipeline\n- * @run testng/othervm PipelineLeaksFD\n+ * @run junit/othervm PipelineLeaksFD\n  */\n \n-@Test\n public class PipelineLeaksFD {\n-    @DataProvider\n-    public Object[][] builders() {\n+\n+    private static final String OS_NAME \u003d System.getProperty(\"os.name\", \"Unknown\");\n+\n+    private static final long MY_PID \u003d  ProcessHandle.current().pid();\n+\n+    private static final boolean LSOF_AVAILABLE \u003d checkForLSOF();\n+\n+    // Test cases for pipelines with a number of pipeline sequences\n+    public static Object[][] builders() {\n         return new Object[][]{\n                 {List.of(new ProcessBuilder(\"cat\"))},\n                 {List.of(new ProcessBuilder(\"cat\"),\n@@ -59,20 +69,43 @@ public Object[][] builders() {\n         };\n     }\n \n-    @Test(dataProvider \u003d \"builders\")\n+    // True if lsof is runnable and collect pipe usage.\n+    private static boolean lsofAvailable() {\n+        return LSOF_AVAILABLE;\n+    }\n+\n+    // Check if lsof is available\n+    private static boolean checkForLSOF() {\n+        try {\n+            lsofForAll();\n+            return true;\n+        } catch (IOException ioe) {\n+            System.err.println(\"Skipping: \" + ioe);\n+            return false;\n+        }\n+    }\n+\n+    @EnabledIf(\"lsofAvailable\")\n+    @ParameterizedTest\n+    @MethodSource(\"builders\")\n     void checkForLeaks(List\u003cProcessBuilder\u003e builders) throws IOException {\n \n-        Set\u003cPipeRecord\u003e pipesBefore \u003d myPipes();\n+        List\u003cString\u003e lsofLines \u003d lsofForAll();\n+        Set\u003cPipeRecord\u003e pipesBefore \u003d pipesFromLSOF(lsofLines, MY_PID);\n         if (pipesBefore.size() \u003c 3) {\n-            System.out.println(pipesBefore);\n-            Assert.fail(\"There should be at least 3 pipes before, (0, 1, 2)\");\n+            // Dump all lsof output to aid debugging\n+            System.out.println(\"Output from lsof\");\n+            lsofLines.forEach(System.err::println);\n+            System.err.println(pipesBefore);\n+            fail(\"There should be at least 3 pipes before, (0, 1, 2)\");\n         }\n+        printPipes(pipesBefore, \"Before start\");\n \n         List\u003cProcess\u003e processes \u003d ProcessBuilder.startPipeline(builders);\n \n         // Write something through the pipeline\n         final String text \u003d \"xyz\";\n-        try (Writer out \u003d processes.get(0).outputWriter()) {\n+        try (Writer out \u003d processes.getFirst().outputWriter()) {\n             out.write(text);\n         }\n \n@@ -84,16 +117,17 @@ void checkForLeaks(List\u003cProcessBuilder\u003e builders) throws IOException {\n             try (BufferedReader inputStream \u003d p.inputReader();\n                  BufferedReader errorStream \u003d p.errorReader()) {\n                 String outActual \u003d inputStream.readLine();\n-                Assert.assertEquals(outActual, expectedOut, \"stdout, process[ \" + i + \"]: \" + p);\n+                assertEquals(expectedOut, outActual, \"stdout, process[ \" + i + \"]: \" + p);\n \n                 String errActual \u003d errorStream.readLine();\n-                Assert.assertEquals(errActual, expectedErr, \"stderr, process[ \" + i + \"]: \" + p);\n+                assertEquals(expectedErr, errActual, \"stderr, process[ \" + i + \"]: \" + p);\n             }\n         }\n \n-        processes.forEach(p -\u003e waitForQuiet(p));\n+        processes.forEach(PipelineLeaksFD::waitForQuiet);\n \n-        Set\u003cPipeRecord\u003e pipesAfter \u003d myPipes();\n+        lsofLines \u003d lsofForAll();\n+        Set\u003cPipeRecord\u003e pipesAfter \u003d pipesFromLSOF(lsofLines, MY_PID);\n         if (!pipesBefore.equals(pipesAfter)) {\n             Set\u003cPipeRecord\u003e missing \u003d new HashSet\u003c\u003e(pipesBefore);\n             missing.removeAll(pipesAfter);\n@@ -101,46 +135,191 @@ void checkForLeaks(List\u003cProcessBuilder\u003e builders) throws IOException {\n             Set\u003cPipeRecord\u003e extra \u003d new HashSet\u003c\u003e(pipesAfter);\n             extra.removeAll(pipesBefore);\n             printPipes(extra, \"Extra pipes in pipesAfter\");\n-            Assert.fail(\"More or fewer pipes than expected\");\n+            // Dump all lsof output to aid debugging\n+            System.out.println(\"\\nOutput from lsof\");\n+            lsofLines.forEach(System.err::println);\n+            fail(\"More or fewer pipes than expected\");\n+        }\n+    }\n+\n+    // Test redirectErrorStream, both true and false\n+    public static Object[][] redirectCases() {\n+        return new Object[][] {\n+                {true},\n+                {false},\n+        };\n+    }\n+\n+    // Test redirectErrorStream  (true/false) has the right number of pipes in use\n+    @EnabledIf(\"lsofAvailable\")\n+    @ParameterizedTest()\n+    @MethodSource(\"redirectCases\")\n+    void checkRedirectErrorStream(boolean redirectError) throws IOException {\n+        try (Process p \u003d new ProcessBuilder(\"cat\")\n+                .redirectErrorStream(redirectError)\n+                .start()) {\n+            System.err.printf(\"Parent PID; %d, Child Pid: %d\\n\", MY_PID, p.pid());\n+            List\u003cString\u003e lsofLines \u003d lsofForAll();\n+            final Set\u003cPipeRecord\u003e pipes \u003d pipesFromLSOF(lsofLines, p.pid());\n+            printPipes(pipes, \"Parent and waiting child pipes\");\n+            int uniquePipes \u003d redirectError ? 8 : 9;\n+            if (uniquePipes !\u003d pipes.size()) {\n+                // Dump all lsof output to aid debugging\n+                System.out.println(\"\\nOutput from lsof\");\n+                lsofLines.forEach(System.err::println);\n+            }\n+            assertEquals(uniquePipes, pipes.size(),\n+                    \"wrong number of pipes for redirect: \" + redirectError);\n+            String expectedTypeName \u003d redirectError\n+                    ? \"java.lang.ProcessBuilder$NullInputStream\"\n+                    : \"java.lang.ProcessImpl$ProcessPipeInputStream\";\n+            assertEquals(expectedTypeName, p.getErrorStream().getClass().getName(),\n+                    \"errorStream type is incorrect\");\n+        } catch (IOException ioe) {\n+            fail(\"Process start\", ioe);\n         }\n     }\n \n     static void printPipes(Set\u003cPipeRecord\u003e pipes, String label) {\n-        System.out.printf(\"%s: [%d]%n\", label, pipes.size());\n-        pipes.forEach(r -\u003e System.out.printf(\"%-20s: %s%n\", r.fd(), r.link()));\n+        System.err.printf(\"%s: [%d]%n\", label, pipes.size());\n+        pipes.forEach(System.err::println);\n     }\n \n     static void waitForQuiet(Process p) {\n         try {\n             int st \u003d p.waitFor();\n             if (st !\u003d 0) {\n-                System.out.println(\"non-zero exit status: \" + p);\n+                System.err.println(\"non-zero exit status: \" + p);\n             }\n         } catch (InterruptedException ie) {\n         }\n     }\n \n     /**\n-     * Collect a Set of pairs of /proc fd paths and the symbol links that are pipes.\n+     * Collect a Set of file descriptors and identifying information.\n+     * To identify the pipes in use the `lsof` command is invoked and output scrapped for\n+     * fd\u0027s, pids, unique identities of the pipes (to match with parent).\n      * @return A set of PipeRecords, possibly empty\n      */\n-    static Set\u003cPipeRecord\u003e myPipes() {\n-        Path path \u003d Path.of(\"/proc/\" + ProcessHandle.current().pid() + \"/fd\");\n-        Set\u003cPipeRecord\u003e pipes \u003d new HashSet\u003c\u003e();\n-        File[] files \u003d path.toFile().listFiles(f -\u003e Files.isSymbolicLink(f.toPath()));\n-        if (files !\u003d null) {\n-            for (File file : files) {\n-                try {\n-                    Path link \u003d Files.readSymbolicLink(file.toPath());\n-                    if (link.toString().startsWith(\"pipe:\")) {\n-                        pipes.add(new PipeRecord(file.toPath(), link));\n-                    }\n-                } catch (IOException ioe) {\n-                }\n-            }\n+    private static Set\u003cPipeRecord\u003e pipesForPid(long pid) throws IOException {\n+        var lines \u003d lsofForAll();\n+        return pipesFromLSOF(lines, pid);\n+    }\n+\n+    /**\n+     * Extract the PipeRecords from the `lsof` output for this process and a designated child process.\n+     *\n+     * @param lines lines of lsof output\n+     * @param pid pid of child process of interest\n+     * @return a Set of PipeRecords for parent and child\n+     */\n+    private static LinkedHashSet\u003cPipeRecord\u003e pipesFromLSOF(List\u003cString\u003e lines, long pid) {\n+        return lines.stream()\n+                .map(PipelineLeaksFD::pipeFromLSOF)\n+                .filter(pr -\u003e pr !\u003d null \u0026\u0026\n+                        (pr.pid() \u003d\u003d pid || pr.pid() \u003d\u003d MY_PID))\n+                .collect(Collectors.toCollection(LinkedHashSet::new));\n+    }\n+\n+    /**\n+     * Collect the output of `lsof` for all files.\n+     * Files are used for `lsof` input and output to avoid creating pipes.\n+     * @return a List of lines output from `lsof`.\n+     */\n+    private static List\u003cString\u003e lsofForAll() throws IOException {\n+        Path tmpDir \u003d Path.of(\".\");\n+        String tmpPrefix \u003d \"lsof-\";\n+        Path lsofEmptyInput \u003d Files.createTempFile(tmpDir, tmpPrefix, \".empty\");\n+        Path lsofOutput \u003d Files.createTempFile(tmpDir, tmpPrefix, \".tmp\");\n+        try (Process p \u003d new ProcessBuilder(\"lsof\")\n+                .redirectOutput(lsofOutput.toFile())\n+                .redirectInput(lsofEmptyInput.toFile()) // empty input\n+                .redirectError(ProcessBuilder.Redirect.DISCARD) // ignored output\n+                .start()) {\n+            int status \u003d p.waitFor();\n+            assertEquals(0, status, \"Process \u0027lsof\u0027 failed\");\n+\n+            return Files.readAllLines(lsofOutput);\n+        } catch (InterruptedException ie) {\n+            throw new IOException(\"Waiting for lsof exit interrupted\", ie);\n+        }\n+    }\n+\n+    // Return pipe records by parsing the appropriate platform specific `lsof` output.\n+    static PipeRecord pipeFromLSOF(String s) {\n+        return switch (OS_NAME) {\n+            case \"Linux\" -\u003e pipeFromLinuxLSOF(s);\n+            case \"Mac OS X\" -\u003e pipeFromMacLSOF(s);\n+            default -\u003e throw new RuntimeException(\"lsof not supported on platform: \" + OS_NAME);\n+        };\n+    }\n+\n+    // Return Pipe from lsof output put, or null (on Mac OS X)\n+    // lsof      55221 rriggs    0      PIPE 0xc76402237956a5cb      16384  -\u003e0xfcb0c07ae447908c\n+    // lsof      55221 rriggs    1      PIPE 0xb486e02f86da463e      16384  -\u003e0xf94eacc85896b4e6\n+    static PipeRecord pipeFromMacLSOF(String s) {\n+        String[] fields \u003d s.split(\"\\\\s+\");\n+        if (\"PIPE\".equals(fields[4])) {\n+            final int pid \u003d Integer.parseInt(fields[1]);\n+            final String myKey \u003d (fields.length \u003e 5) ? fields[5] : \"\";\n+            final String otherKey \u003d (fields.length \u003e 7) ? fields[7].substring(2) : \"\";\n+            return PipeRecord.lookup(Integer.parseInt(fields[3]), myKey, otherKey, pid);\n+        }\n+        return null;\n+    }\n+\n+    // Return Pipe from lsof output put, or null (on Linux)\n+    // java    7612 rriggs   14w  FIFO   0,12       0t0   117662267 pipe\n+    // java    7612 rriggs   15r  FIFO   0,12       0t0   117662268 pipe\n+    static PipeRecord pipeFromLinuxLSOF(String s) {\n+        String[] fields \u003d s.split(\"\\\\s+\");\n+        if (\"FIFO\".equals(fields[4])) {\n+            final int pid \u003d Integer.parseInt(fields[1]);\n+            final String key \u003d (fields.length \u003e 7) ? fields[7] : \"\";\n+            final int fdNum \u003d Integer.parseInt(fields[3].substring(0, fields[3].length() - 1));\n+            return PipeRecord.lookup(fdNum, key, null, pid);\n         }\n-        return pipes;\n+        return null;\n     }\n \n-    record PipeRecord(Path fd, Path link) { };\n+    // Identify a pipe by pid, fd, and a key (unique across processes)\n+    // Mac OS X has separate keys for read and write sides, both are matched to the same \"name\"\n+    record PipeRecord(long pid, int fd, KeyedString myKey) {\n+        static PipeRecord lookup(int fd, String myKey, String otherKey, int pid) {\n+            return new PipeRecord(pid, fd, KeyedString.getKey(myKey, otherKey));\n+        }\n+    }\n+\n+    // A unique name for a string with a count of uses\n+    // Used to associate pipe between parent and child.\n+    static class KeyedString {\n+        private static final HashMap\u003cString, KeyedString\u003e map \u003d new HashMap\u003c\u003e();\n+        private static int nextInt \u003d 1;\n+        private final String key;\n+        private final String name;\n+        private int count;\n+        KeyedString(String key, String name) {\n+            this.key \u003d key;\n+            this.name \u003d name;\n+            this.count \u003d 0;\n+        }\n+\n+        KeyedString(String s) {\n+            String k \u003d \"p\" + nextInt++;\n+            this(s, k);\n+        }\n+\n+        static KeyedString getKey(String key, String otherKey) {\n+            var k \u003d map.computeIfAbsent(key, KeyedString::new);\n+            k.count++;\n+            if (otherKey !\u003d null) {\n+                map.putIfAbsent(otherKey, k);\n+            }\n+            return k;\n+        }\n+\n+        public String toString() {\n+            return name + \"(\" + count + \")\";\n+        }\n+    }\n }\ndiff --git a/test/jdk/java/lang/ProcessBuilder/TEST.properties b/test/jdk/java/lang/ProcessBuilder/TEST.properties\nnew file mode 100644\nindex 000000000..c7e8a6850\n--- /dev/null\n+++ b/test/jdk/java/lang/ProcessBuilder/TEST.properties\n@@ -0,0 +1 @@\n+maxOutputSize\u003d6000000","expectedMessage":"8291986: ProcessBuilder.redirectErrorStream(true) leaves error stream available","repository":"jdk","commitHash":"203eb70110dd546784e03243bf98ff3ddb407030","metadata":{"author":"Roger Riggs \u003crriggs@openjdk.org\u003e"}}
{"id":"jdk-78a106ff","diff":" .../classes/sun/security/ssl/SSLConfiguration.java    | 19 +------------------\n .../classes/sun/security/ssl/TransportContext.java    |  3 +--\n 2 files changed, 2 insertions(+), 20 deletions(-)\n\ndiff --git a/src/java.base/share/classes/sun/security/ssl/SSLConfiguration.java b/src/java.base/share/classes/sun/security/ssl/SSLConfiguration.java\nindex ace60e41a..3c68c669d 100644\n--- a/src/java.base/share/classes/sun/security/ssl/SSLConfiguration.java\n+++ b/src/java.base/share/classes/sun/security/ssl/SSLConfiguration.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2018, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -64,9 +64,6 @@ final class SSLConfiguration implements Cloneable {\n     // the configured named groups for the \"supported_groups\" extensions\n     String[]                   namedGroups;\n \n-    // the maximum protocol version of enabled protocols\n-    ProtocolVersion             maximumProtocolVersion;\n-\n     // Configurations per SSLSocket or SSLEngine instance.\n     boolean                     isClientMode;\n     boolean                     enableSessionCreation;\n@@ -249,13 +246,6 @@ final class SSLConfiguration implements Cloneable {\n                         CustomizedServerSignatureSchemes.signatureSchemes :\n                         SupportedSigSchemes.DEFAULT;\n         this.namedGroups \u003d NamedGroup.SupportedGroups.namedGroups;\n-        this.maximumProtocolVersion \u003d ProtocolVersion.NONE;\n-        for (ProtocolVersion pv : enabledProtocols) {\n-            if (pv.compareTo(maximumProtocolVersion) \u003e 0) {\n-                this.maximumProtocolVersion \u003d pv;\n-            }\n-        }\n-\n         // Configurations per SSLSocket or SSLEngine instance.\n         this.isClientMode \u003d isClientMode;\n         this.enableSessionCreation \u003d true;\n@@ -323,13 +313,6 @@ void setSSLParameters(SSLParameters params) {\n         sa \u003d params.getProtocols();\n         if (sa !\u003d null) {\n             this.enabledProtocols \u003d ProtocolVersion.namesOf(sa);\n-\n-            this.maximumProtocolVersion \u003d ProtocolVersion.NONE;\n-            for (ProtocolVersion pv : enabledProtocols) {\n-                if (pv.compareTo(maximumProtocolVersion) \u003e 0) {\n-                    this.maximumProtocolVersion \u003d pv;\n-                }\n-            }\n         }   // otherwise, use the default values\n \n         if (params.getNeedClientAuth()) {\ndiff --git a/src/java.base/share/classes/sun/security/ssl/TransportContext.java b/src/java.base/share/classes/sun/security/ssl/TransportContext.java\nindex 980d9c4a6..35bdd2fff 100644\n--- a/src/java.base/share/classes/sun/security/ssl/TransportContext.java\n+++ b/src/java.base/share/classes/sun/security/ssl/TransportContext.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2018, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -144,7 +144,6 @@ private TransportContext(SSLContextImpl sslContext, SSLTransport transport,\n \n         // initial security parameters\n         this.conSession \u003d new SSLSessionImpl();\n-        this.protocolVersion \u003d this.sslConfig.maximumProtocolVersion;\n         this.clientVerifyData \u003d emptyByteArray;\n         this.serverVerifyData \u003d emptyByteArray;\n ","expectedMessage":"8375183: Remove unused SSLConfiguration.maximumProtocolVersion variable","repository":"jdk","commitHash":"78a106ffbba0e056e7421ca9d77af02f9b8379d3","metadata":{"author":"Artur Barashev \u003cabarashev@openjdk.org\u003e"}}
{"id":"jdk-8ad8920a","diff":" src/hotspot/share/gc/shared/workerUtils.cpp | 25 +++++++++++++------------\n src/hotspot/share/gc/shared/workerUtils.hpp | 12 +++++++-----\n 2 files changed, 20 insertions(+), 17 deletions(-)\n\ndiff --git a/src/hotspot/share/gc/shared/workerUtils.cpp b/src/hotspot/share/gc/shared/workerUtils.cpp\nindex 422d513a5..1826b9d7d 100644\n--- a/src/hotspot/share/gc/shared/workerUtils.cpp\n+++ b/src/hotspot/share/gc/shared/workerUtils.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2001, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -22,8 +22,9 @@\n  *\n  */\n \n+#include \"cppstdlib/new.hpp\"\n #include \"gc/shared/workerUtils.hpp\"\n-#include \"runtime/atomicAccess.hpp\"\n+#include \"runtime/atomic.hpp\"\n #include \"runtime/mutexLocker.hpp\"\n \n // *** WorkerThreadsBarrierSync\n@@ -80,21 +81,21 @@ void WorkerThreadsBarrierSync::abort() {\n \n SubTasksDone::SubTasksDone(uint n) :\n   _tasks(nullptr), _n_tasks(n) {\n-  _tasks \u003d NEW_C_HEAP_ARRAY(bool, n, mtInternal);\n+  _tasks \u003d NEW_C_HEAP_ARRAY(Atomic\u003cbool\u003e, n, mtInternal);\n   for (uint i \u003d 0; i \u003c _n_tasks; i++) {\n-    _tasks[i] \u003d false;\n+    ::new (\u0026_tasks[i]) Atomic\u003cbool\u003e(false);\n   }\n }\n \n #ifdef ASSERT\n void SubTasksDone::all_tasks_claimed_impl(uint skipped[], size_t skipped_size) {\n-  if (AtomicAccess::cmpxchg(\u0026_verification_done, false, true)) {\n+  if (!_verification_done.compare_set(false, true)) {\n     // another thread has done the verification\n     return;\n   }\n   // all non-skipped tasks are claimed\n   for (uint i \u003d 0; i \u003c _n_tasks; ++i) {\n-    if (!_tasks[i]) {\n+    if (!_tasks[i].load_relaxed()) {\n       auto is_skipped \u003d false;\n       for (size_t j \u003d 0; j \u003c skipped_size; ++j) {\n         if (i \u003d\u003d skipped[j]) {\n@@ -109,27 +110,27 @@ void SubTasksDone::all_tasks_claimed_impl(uint skipped[], size_t skipped_size) {\n   for (size_t i \u003d 0; i \u003c skipped_size; ++i) {\n     auto task_index \u003d skipped[i];\n     assert(task_index \u003c _n_tasks, \"Array in range.\");\n-    assert(!_tasks[task_index], \"%d is both claimed and skipped.\", task_index);\n+    assert(!_tasks[task_index].load_relaxed(), \"%d is both claimed and skipped.\", task_index);\n   }\n }\n #endif\n \n bool SubTasksDone::try_claim_task(uint t) {\n   assert(t \u003c _n_tasks, \"bad task id.\");\n-  return !_tasks[t] \u0026\u0026 !AtomicAccess::cmpxchg(\u0026_tasks[t], false, true);\n+  return !_tasks[t].load_relaxed() \u0026\u0026 _tasks[t].compare_set(false, true);\n }\n \n SubTasksDone::~SubTasksDone() {\n-  assert(_verification_done, \"all_tasks_claimed must have been called.\");\n-  FREE_C_HEAP_ARRAY(bool, _tasks);\n+  assert(_verification_done.load_relaxed(), \"all_tasks_claimed must have been called.\");\n+  FREE_C_HEAP_ARRAY(Atomic\u003cbool\u003e, _tasks);\n }\n \n // *** SequentialSubTasksDone\n \n bool SequentialSubTasksDone::try_claim_task(uint\u0026 t) {\n-  t \u003d _num_claimed;\n+  t \u003d _num_claimed.load_relaxed();\n   if (t \u003c _num_tasks) {\n-    t \u003d AtomicAccess::add(\u0026_num_claimed, 1u) - 1;\n+    t \u003d _num_claimed.fetch_then_add(1u);\n   }\n   return t \u003c _num_tasks;\n }\ndiff --git a/src/hotspot/share/gc/shared/workerUtils.hpp b/src/hotspot/share/gc/shared/workerUtils.hpp\nindex 5f771a578..7bf9d7d76 100644\n--- a/src/hotspot/share/gc/shared/workerUtils.hpp\n+++ b/src/hotspot/share/gc/shared/workerUtils.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2002, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -28,6 +28,7 @@\n #include \"cppstdlib/type_traits.hpp\"\n #include \"memory/allocation.hpp\"\n #include \"metaprogramming/enableIf.hpp\"\n+#include \"runtime/atomic.hpp\"\n #include \"runtime/mutex.hpp\"\n #include \"utilities/debug.hpp\"\n #include \"utilities/globalDefinitions.hpp\"\n@@ -79,11 +80,11 @@ class WorkerThreadsBarrierSync : public StackObj {\n // enumeration type.\n \n class SubTasksDone: public CHeapObj\u003cmtInternal\u003e {\n-  volatile bool* _tasks;\n+  Atomic\u003cbool\u003e* _tasks;\n   uint _n_tasks;\n \n   // make sure verification logic is run exactly once to avoid duplicate assertion failures\n-  DEBUG_ONLY(volatile bool _verification_done \u003d false;)\n+  DEBUG_ONLY(Atomic\u003cbool\u003e _verification_done;)\n   void all_tasks_claimed_impl(uint skipped[], size_t skipped_size) NOT_DEBUG_RETURN;\n \n   NONCOPYABLE(SubTasksDone);\n@@ -127,7 +128,7 @@ class SubTasksDone: public CHeapObj\u003cmtInternal\u003e {\n class SequentialSubTasksDone : public CHeapObj\u003cmtInternal\u003e {\n \n   uint _num_tasks;     // Total number of tasks available.\n-  volatile uint _num_claimed;   // Number of tasks claimed.\n+  Atomic\u003cuint\u003e _num_claimed;    // Number of tasks claimed.\n \n   NONCOPYABLE(SequentialSubTasksDone);\n \n@@ -135,7 +136,8 @@ class SequentialSubTasksDone : public CHeapObj\u003cmtInternal\u003e {\n   SequentialSubTasksDone(uint num_tasks) : _num_tasks(num_tasks), _num_claimed(0) { }\n   ~SequentialSubTasksDone() {\n     // Claiming may try to claim more tasks than there are.\n-    assert(_num_claimed \u003e\u003d _num_tasks, \"Claimed %u tasks of %u\", _num_claimed, _num_tasks);\n+    assert(_num_claimed.load_relaxed() \u003e\u003d _num_tasks,\n+           \"Claimed %u tasks of %u\", _num_claimed.load_relaxed(), _num_tasks);\n   }\n \n   // Attempt to claim the next unclaimed task in the sequence,","expectedMessage":"8374984: Convert workerUtils to use Atomic\u003cT\u003e","repository":"jdk","commitHash":"8ad8920aae5c27de947532ba3cd2b57213208d1e","metadata":{"author":"Kim Barrett \u003ckbarrett@openjdk.org\u003e"}}
{"id":"jdk-f6e5c885","diff":" src/hotspot/share/gc/g1/g1CollectedHeap.cpp | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\ndiff --git a/src/hotspot/share/gc/g1/g1CollectedHeap.cpp b/src/hotspot/share/gc/g1/g1CollectedHeap.cpp\nindex 2ad5a26d5..3a0c4a044 100644\n--- a/src/hotspot/share/gc/g1/g1CollectedHeap.cpp\n+++ b/src/hotspot/share/gc/g1/g1CollectedHeap.cpp\n@@ -687,8 +687,8 @@ HeapWord* G1CollectedHeap::attempt_allocation_humongous(size_t word_size) {\n   // before the allocation is that we avoid having to keep track of the newly\n   // allocated memory while we do a GC.\n   // Only try that if we can actually perform a GC.\n-  if (is_init_completed() \u0026\u0026 policy()-\u003eneed_to_start_conc_mark(\"concurrent humongous allocation\",\n-                                        word_size)) {\n+  if (is_init_completed() \u0026\u0026\n+      policy()-\u003eneed_to_start_conc_mark(\"concurrent humongous allocation\", word_size)) {\n     try_collect(word_size, GCCause::_g1_humongous_allocation, collection_counters(this));\n   }\n ","expectedMessage":"8375282: G1: Fix wrong indendation introduced by JDK-8374743","repository":"jdk","commitHash":"f6e5c885e7ca90da2f9fd9ec1c00b4a955ccdf29","metadata":{"author":"Thomas Schatzl \u003ctschatzl@openjdk.org\u003e"}}
{"id":"jdk-bf0da3dd","diff":" src/hotspot/share/gc/g1/g1FullGCMarker.inline.hpp  |  2 +-\n src/hotspot/share/gc/g1/g1ParScanThreadState.cpp   |  8 ++---\n src/hotspot/share/gc/serial/serialFullGC.cpp       |  2 +-\n .../share/gc/shenandoah/shenandoahMark.inline.hpp  |  6 ++--\n src/hotspot/share/gc/z/zHeapIterator.cpp           |  2 +-\n src/hotspot/share/gc/z/zIterator.hpp               |  2 +-\n src/hotspot/share/gc/z/zIterator.inline.hpp        |  4 +--\n src/hotspot/share/oops/objArrayKlass.hpp           | 11 ++++---\n src/hotspot/share/oops/objArrayKlass.inline.hpp    | 34 +++++++---------------\n src/hotspot/share/oops/objArrayOop.hpp             |  4 +--\n src/hotspot/share/oops/objArrayOop.inline.hpp      | 10 +++++++\n 11 files changed, 41 insertions(+), 44 deletions(-)\n\ndiff --git a/src/hotspot/share/gc/g1/g1FullGCMarker.inline.hpp b/src/hotspot/share/gc/g1/g1FullGCMarker.inline.hpp\nindex 6cbfe2674..398ef046b 100644\n--- a/src/hotspot/share/gc/g1/g1FullGCMarker.inline.hpp\n+++ b/src/hotspot/share/gc/g1/g1FullGCMarker.inline.hpp\n@@ -108,7 +108,7 @@ void G1FullGCMarker::follow_array_chunk(objArrayOop array, int index) {\n     push_objarray(array, end_index);\n   }\n \n-  array-\u003eoop_iterate_range(mark_closure(), beg_index, end_index);\n+  array-\u003eoop_iterate_elements_range(mark_closure(), beg_index, end_index);\n }\n \n inline void G1FullGCMarker::follow_object(oop obj) {\ndiff --git a/src/hotspot/share/gc/g1/g1ParScanThreadState.cpp b/src/hotspot/share/gc/g1/g1ParScanThreadState.cpp\nindex 80e5fd44f..e7b02ed68 100644\n--- a/src/hotspot/share/gc/g1/g1ParScanThreadState.cpp\n+++ b/src/hotspot/share/gc/g1/g1ParScanThreadState.cpp\n@@ -238,9 +238,9 @@ void G1ParScanThreadState::do_partial_array(PartialArrayState* state, bool stole\n   G1HeapRegionAttr dest_attr \u003d _g1h-\u003eregion_attr(to_array);\n   G1SkipCardMarkSetter x(\u0026_scanner, dest_attr.is_new_survivor());\n   // Process claimed task.\n-  to_array-\u003eoop_iterate_range(\u0026_scanner,\n-                              checked_cast\u003cint\u003e(claim._start),\n-                              checked_cast\u003cint\u003e(claim._end));\n+  to_array-\u003eoop_iterate_elements_range(\u0026_scanner,\n+                                       checked_cast\u003cint\u003e(claim._start),\n+                                       checked_cast\u003cint\u003e(claim._end));\n }\n \n MAYBE_INLINE_EVACUATION\n@@ -260,7 +260,7 @@ void G1ParScanThreadState::start_partial_objarray(oop from_obj,\n   // Process the initial chunk.  No need to process the type in the\n   // klass, as it will already be handled by processing the built-in\n   // module.\n-  to_array-\u003eoop_iterate_range(\u0026_scanner, 0, checked_cast\u003cint\u003e(initial_chunk_size));\n+  to_array-\u003eoop_iterate_elements_range(\u0026_scanner, 0, checked_cast\u003cint\u003e(initial_chunk_size));\n }\n \n MAYBE_INLINE_EVACUATION\ndiff --git a/src/hotspot/share/gc/serial/serialFullGC.cpp b/src/hotspot/share/gc/serial/serialFullGC.cpp\nindex 546084e38..0c8ca51fc 100644\n--- a/src/hotspot/share/gc/serial/serialFullGC.cpp\n+++ b/src/hotspot/share/gc/serial/serialFullGC.cpp\n@@ -412,7 +412,7 @@ void SerialFullGC::follow_array_chunk(objArrayOop array, int index) {\n   const int stride \u003d MIN2(len - beg_index, (int) ObjArrayMarkingStride);\n   const int end_index \u003d beg_index + stride;\n \n-  array-\u003eoop_iterate_range(\u0026mark_and_push_closure, beg_index, end_index);\n+  array-\u003eoop_iterate_elements_range(\u0026mark_and_push_closure, beg_index, end_index);\n \n   if (end_index \u003c len) {\n     SerialFullGC::push_objarray(array, end_index); // Push the continuation.\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahMark.inline.hpp b/src/hotspot/share/gc/shenandoah/shenandoahMark.inline.hpp\nindex 0a95ee9f1..849459157 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahMark.inline.hpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahMark.inline.hpp\n@@ -167,7 +167,7 @@ inline void ShenandoahMark::do_chunked_array_start(ShenandoahObjToScanQueue* q,\n \n   if (len \u003c\u003d (int) ObjArrayMarkingStride*2) {\n     // A few slices only, process directly\n-    array-\u003eoop_iterate_range(cl, 0, len);\n+    array-\u003eoop_iterate_elements_range(cl, 0, len);\n   } else {\n     int bits \u003d log2i_graceful(len);\n     // Compensate for non-power-of-two arrays, cover the array in excess:\n@@ -216,7 +216,7 @@ inline void ShenandoahMark::do_chunked_array_start(ShenandoahObjToScanQueue* q,\n     // Process the irregular tail, if present\n     int from \u003d last_idx;\n     if (from \u003c len) {\n-      array-\u003eoop_iterate_range(cl, from, len);\n+      array-\u003eoop_iterate_elements_range(cl, from, len);\n     }\n   }\n }\n@@ -248,7 +248,7 @@ inline void ShenandoahMark::do_chunked_array(ShenandoahObjToScanQueue* q, T* cl,\n   assert (0 \u003c to \u0026\u0026 to \u003c\u003d len, \"to is sane: %d/%d\", to, len);\n #endif\n \n-  array-\u003eoop_iterate_range(cl, from, to);\n+  array-\u003eoop_iterate_elements_range(cl, from, to);\n }\n \n template \u003cShenandoahGenerationType GENERATION\u003e\ndiff --git a/src/hotspot/share/gc/z/zHeapIterator.cpp b/src/hotspot/share/gc/z/zHeapIterator.cpp\nindex d6289178e..73ced2110 100644\n--- a/src/hotspot/share/gc/z/zHeapIterator.cpp\n+++ b/src/hotspot/share/gc/z/zHeapIterator.cpp\n@@ -456,7 +456,7 @@ void ZHeapIterator::follow_array_chunk(const ZHeapIteratorContext\u0026 context, cons\n \n   // Follow array chunk\n   ZHeapIteratorOopClosure\u003cfalse /* VisitReferents */\u003e cl(this, context, obj);\n-  ZIterator::oop_iterate_range(obj, \u0026cl, start, end);\n+  ZIterator::oop_iterate_elements_range(obj, \u0026cl, start, end);\n }\n \n template \u003cbool VisitWeaks\u003e\ndiff --git a/src/hotspot/share/gc/z/zIterator.hpp b/src/hotspot/share/gc/z/zIterator.hpp\nindex 3a1de049d..e048002e5 100644\n--- a/src/hotspot/share/gc/z/zIterator.hpp\n+++ b/src/hotspot/share/gc/z/zIterator.hpp\n@@ -41,7 +41,7 @@ class ZIterator : AllStatic {\n   static void oop_iterate(oop obj, OopClosureT* cl);\n \n   template \u003ctypename OopClosureT\u003e\n-  static void oop_iterate_range(objArrayOop obj, OopClosureT* cl, int start, int end);\n+  static void oop_iterate_elements_range(objArrayOop obj, OopClosureT* cl, int start, int end);\n \n   // This function skips invisible roots\n   template \u003ctypename Function\u003e\ndiff --git a/src/hotspot/share/gc/z/zIterator.inline.hpp b/src/hotspot/share/gc/z/zIterator.inline.hpp\nindex fb20a4242..cbfe1a79a 100644\n--- a/src/hotspot/share/gc/z/zIterator.inline.hpp\n+++ b/src/hotspot/share/gc/z/zIterator.inline.hpp\n@@ -66,9 +66,9 @@ void ZIterator::oop_iterate(oop obj, OopClosureT* cl) {\n }\n \n template \u003ctypename OopClosureT\u003e\n-void ZIterator::oop_iterate_range(objArrayOop obj, OopClosureT* cl, int start, int end) {\n+void ZIterator::oop_iterate_elements_range(objArrayOop obj, OopClosureT* cl, int start, int end) {\n   assert(!is_invisible_object_array(obj), \"not safe\");\n-  obj-\u003eoop_iterate_range(cl, start, end);\n+  obj-\u003eoop_iterate_elements_range(cl, start, end);\n }\n \n template \u003ctypename Function\u003e\ndiff --git a/src/hotspot/share/oops/objArrayKlass.hpp b/src/hotspot/share/oops/objArrayKlass.hpp\nindex 12db56351..cdf28b883 100644\n--- a/src/hotspot/share/oops/objArrayKlass.hpp\n+++ b/src/hotspot/share/oops/objArrayKlass.hpp\n@@ -135,17 +135,16 @@ class ObjArrayKlass : public ArrayKlass {\n   template \u003ctypename T, typename OopClosureType\u003e\n   inline void oop_oop_iterate_bounded(oop obj, OopClosureType* closure, MemRegion mr);\n \n-  // Iterate over oop elements within [start, end), and metadata.\n+  // Iterate over all oop elements, and no metadata.\n   template \u003ctypename T, class OopClosureType\u003e\n-  inline void oop_oop_iterate_range(objArrayOop a, OopClosureType* closure, int start, int end);\n+  inline void oop_oop_iterate_elements(objArrayOop a, OopClosureType* closure);\n \n- public:\n-  // Iterate over all oop elements.\n+  // Iterate over oop elements within index range [start, end), and no metadata.\n   template \u003ctypename T, class OopClosureType\u003e\n-  inline void oop_oop_iterate_elements(objArrayOop a, OopClosureType* closure);\n+  inline void oop_oop_iterate_elements_range(objArrayOop a, OopClosureType* closure, int start, int end);\n \n  private:\n-  // Iterate over all oop elements with indices within mr.\n+  // Iterate over all oop elements bounded by addresses [low, high), and no metadata.\n   template \u003ctypename T, class OopClosureType\u003e\n   inline void oop_oop_iterate_elements_bounded(objArrayOop a, OopClosureType* closure, void* low, void* high);\n \ndiff --git a/src/hotspot/share/oops/objArrayKlass.inline.hpp b/src/hotspot/share/oops/objArrayKlass.inline.hpp\nindex a92c42d21..ee5595485 100644\n--- a/src/hotspot/share/oops/objArrayKlass.inline.hpp\n+++ b/src/hotspot/share/oops/objArrayKlass.inline.hpp\n@@ -38,10 +38,18 @@\n \n template \u003ctypename T, class OopClosureType\u003e\n void ObjArrayKlass::oop_oop_iterate_elements(objArrayOop a, OopClosureType* closure) {\n-  T* p         \u003d (T*)a-\u003ebase();\n-  T* const end \u003d p + a-\u003elength();\n+  oop_oop_iterate_elements_range\u003cT\u003e(a, closure, 0, a-\u003elength());\n+}\n \n-  for (;p \u003c end; p++) {\n+// Like oop_oop_iterate but only iterates over a specified range and only used\n+// for objArrayOops.\n+template \u003ctypename T, class OopClosureType\u003e\n+void ObjArrayKlass::oop_oop_iterate_elements_range(objArrayOop a, OopClosureType* closure, int start, int end) {\n+  T* base        \u003d (T*)a-\u003ebase();\n+  T* p           \u003d base + start;\n+  T* const end_p \u003d base + end;\n+\n+  for (;p \u003c end_p; ++p) {\n     Devirtualizer::do_oop(closure, p);\n   }\n }\n@@ -98,24 +106,4 @@ void ObjArrayKlass::oop_oop_iterate_bounded(oop obj, OopClosureType* closure, Me\n   oop_oop_iterate_elements_bounded\u003cT\u003e(a, closure, mr.start(), mr.end());\n }\n \n-// Like oop_oop_iterate but only iterates over a specified range and only used\n-// for objArrayOops.\n-template \u003ctypename T, class OopClosureType\u003e\n-void ObjArrayKlass::oop_oop_iterate_range(objArrayOop a, OopClosureType* closure, int start, int end) {\n-  T* low \u003d (T*)a-\u003ebase() + start;\n-  T* high \u003d (T*)a-\u003ebase() + end;\n-\n-  oop_oop_iterate_elements_bounded\u003cT\u003e(a, closure, low, high);\n-}\n-\n-// Placed here to resolve include cycle between objArrayKlass.inline.hpp and objArrayOop.inline.hpp\n-template \u003ctypename OopClosureType\u003e\n-void objArrayOopDesc::oop_iterate_range(OopClosureType* blk, int start, int end) {\n-  if (UseCompressedOops) {\n-    ((ObjArrayKlass*)klass())-\u003eoop_oop_iterate_range\u003cnarrowOop\u003e(this, blk, start, end);\n-  } else {\n-    ((ObjArrayKlass*)klass())-\u003eoop_oop_iterate_range\u003coop\u003e(this, blk, start, end);\n-  }\n-}\n-\n #endif // SHARE_OOPS_OBJARRAYKLASS_INLINE_HPP\ndiff --git a/src/hotspot/share/oops/objArrayOop.hpp b/src/hotspot/share/oops/objArrayOop.hpp\nindex 82bb41b5f..0af059efc 100644\n--- a/src/hotspot/share/oops/objArrayOop.hpp\n+++ b/src/hotspot/share/oops/objArrayOop.hpp\n@@ -83,9 +83,9 @@ class objArrayOopDesc : public arrayOopDesc {\n   Klass* element_klass();\n \n public:\n-  // special iterators for index ranges, returns size of object\n+  // Special iterators for an element index range.\n   template \u003ctypename OopClosureType\u003e\n-  void oop_iterate_range(OopClosureType* blk, int start, int end);\n+  void oop_iterate_elements_range(OopClosureType* blk, int start, int end);\n };\n \n // See similar requirement for oopDesc.\ndiff --git a/src/hotspot/share/oops/objArrayOop.inline.hpp b/src/hotspot/share/oops/objArrayOop.inline.hpp\nindex 21f95b756..63295a145 100644\n--- a/src/hotspot/share/oops/objArrayOop.inline.hpp\n+++ b/src/hotspot/share/oops/objArrayOop.inline.hpp\n@@ -29,6 +29,7 @@\n \n #include \"oops/access.hpp\"\n #include \"oops/arrayOop.hpp\"\n+#include \"oops/objArrayKlass.inline.hpp\"\n #include \"oops/oop.inline.hpp\"\n #include \"runtime/globals.hpp\"\n \n@@ -51,4 +52,13 @@ inline void objArrayOopDesc::obj_at_put(int index, oop value) {\n   HeapAccess\u003cIS_ARRAY\u003e::oop_store_at(as_oop(), offset, value);\n }\n \n+template \u003ctypename OopClosureType\u003e\n+void objArrayOopDesc::oop_iterate_elements_range(OopClosureType* blk, int start, int end) {\n+  if (UseCompressedOops) {\n+    ((ObjArrayKlass*)klass())-\u003eoop_oop_iterate_elements_range\u003cnarrowOop\u003e(this, blk, start, end);\n+  } else {\n+    ((ObjArrayKlass*)klass())-\u003eoop_oop_iterate_elements_range\u003coop\u003e(this, blk, start, end);\n+  }\n+}\n+\n #endif // SHARE_OOPS_OBJARRAYOOP_INLINE_HPP","expectedMessage":"8375040: Clearer names for non-metadata oop iterators in ObjArrayKlass","repository":"jdk","commitHash":"bf0da3dd5c20410aceab8e6f7a7a31432d17b96d","metadata":{"author":"Stefan Karlsson \u003cstefank@openjdk.org\u003e"}}
{"id":"jdk-f6d26c6b","diff":" src/hotspot/cpu/x86/register_x86.cpp     |  8 +----\n src/hotspot/cpu/x86/register_x86.hpp     | 56 ++++++++++----------------------\n src/hotspot/cpu/x86/vmreg_x86.cpp        |  4 +--\n src/hotspot/cpu/x86/vmreg_x86.hpp        | 13 ++------\n src/hotspot/cpu/x86/vmreg_x86.inline.hpp |  4 +--\n 5 files changed, 23 insertions(+), 62 deletions(-)\n\ndiff --git a/src/hotspot/cpu/x86/register_x86.cpp b/src/hotspot/cpu/x86/register_x86.cpp\nindex e60834293..188af9264 100644\n--- a/src/hotspot/cpu/x86/register_x86.cpp\n+++ b/src/hotspot/cpu/x86/register_x86.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2000, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -32,14 +32,10 @@ const KRegister::KRegisterImpl         all_KRegisterImpls    [KRegister::number_\n \n const char * Register::RegisterImpl::name() const {\n   static const char *const names[number_of_registers] \u003d {\n-#ifdef _LP64\n     \"rax\", \"rcx\", \"rdx\", \"rbx\", \"rsp\", \"rbp\", \"rsi\", \"rdi\",\n     \"r8\",  \"r9\",  \"r10\", \"r11\", \"r12\", \"r13\", \"r14\", \"r15\",\n     \"r16\", \"r17\", \"r18\", \"r19\", \"r20\", \"r21\", \"r22\", \"r23\",\n     \"r24\", \"r25\", \"r26\", \"r27\", \"r28\", \"r29\", \"r30\", \"r31\"\n-#else\n-    \"eax\", \"ecx\", \"edx\", \"ebx\", \"esp\", \"ebp\", \"esi\", \"edi\"\n-#endif // _LP64\n   };\n   return is_valid() ? names[encoding()] : \"noreg\";\n }\n@@ -54,11 +50,9 @@ const char* FloatRegister::FloatRegisterImpl::name() const {\n const char* XMMRegister::XMMRegisterImpl::name() const {\n   static const char *const names[number_of_registers] \u003d {\n     \"xmm0\",    \"xmm1\",  \"xmm2\",  \"xmm3\",  \"xmm4\",  \"xmm5\",  \"xmm6\",  \"xmm7\"\n-#ifdef _LP64\n     ,\"xmm8\",   \"xmm9\",  \"xmm10\", \"xmm11\", \"xmm12\", \"xmm13\", \"xmm14\", \"xmm15\"\n     ,\"xmm16\",  \"xmm17\", \"xmm18\", \"xmm19\", \"xmm20\", \"xmm21\", \"xmm22\", \"xmm23\"\n     ,\"xmm24\",  \"xmm25\", \"xmm26\", \"xmm27\", \"xmm28\", \"xmm29\", \"xmm30\", \"xmm31\"\n-#endif // _LP64\n   };\n   return is_valid() ? names[encoding()] : \"xnoreg\";\n }\ndiff --git a/src/hotspot/cpu/x86/register_x86.hpp b/src/hotspot/cpu/x86/register_x86.hpp\nindex 0a8ecb7be..5e0326b9a 100644\n--- a/src/hotspot/cpu/x86/register_x86.hpp\n+++ b/src/hotspot/cpu/x86/register_x86.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2000, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -34,7 +34,7 @@\n class VMRegImpl;\n typedef VMRegImpl* VMReg;\n \n-// The implementation of integer registers for the x86/x64 architectures.\n+// The implementation of integer registers for the x64 architectures.\n class Register {\n private:\n   int _encoding;\n@@ -44,11 +44,9 @@ class Register {\n public:\n   inline friend constexpr Register as_Register(int encoding);\n \n-  enum {\n-    number_of_registers      \u003d LP64_ONLY( 32 ) NOT_LP64( 8 ),\n-    number_of_byte_registers \u003d LP64_ONLY( 32 ) NOT_LP64( 4 ),\n-    max_slots_per_register   \u003d LP64_ONLY(  2 ) NOT_LP64( 1 )\n-  };\n+  static const int number_of_registers      \u003d 32;\n+  static const int number_of_byte_registers \u003d 32;\n+  static const int max_slots_per_register   \u003d  2;\n \n   class RegisterImpl: public AbstractRegisterImpl {\n     friend class Register;\n@@ -79,11 +77,9 @@ class Register {\n \n   // Actually available GP registers for use, depending on actual CPU capabilities and flags.\n   static int available_gp_registers() {\n-#ifdef _LP64\n     if (!UseAPX) {\n       return number_of_registers / 2;\n     }\n-#endif // _LP64\n     return number_of_registers;\n   }\n };\n@@ -116,9 +112,8 @@ constexpr Register rsp \u003d as_Register(4);\n constexpr Register rbp \u003d as_Register(5);\n constexpr Register rsi \u003d as_Register(6);\n constexpr Register rdi \u003d as_Register(7);\n-#ifdef _LP64\n-constexpr Register r8  \u003d as_Register( 8);\n-constexpr Register r9  \u003d as_Register( 9);\n+constexpr Register r8  \u003d as_Register(8);\n+constexpr Register r9  \u003d as_Register(9);\n constexpr Register r10 \u003d as_Register(10);\n constexpr Register r11 \u003d as_Register(11);\n constexpr Register r12 \u003d as_Register(12);\n@@ -141,7 +136,6 @@ constexpr Register r28 \u003d as_Register(28);\n constexpr Register r29 \u003d as_Register(29);\n constexpr Register r30 \u003d as_Register(30);\n constexpr Register r31 \u003d as_Register(31);\n-#endif // _LP64\n \n \n // The implementation of x87 floating point registers for the ia32 architecture.\n@@ -154,10 +148,8 @@ class FloatRegister {\n public:\n   inline friend constexpr FloatRegister as_FloatRegister(int encoding);\n \n-  enum {\n-    number_of_registers    \u003d 8,\n-    max_slots_per_register \u003d 2\n-  };\n+  static const int number_of_registers    \u003d 8;\n+  static const int max_slots_per_register \u003d 2;\n \n   class FloatRegisterImpl: public AbstractRegisterImpl {\n     friend class FloatRegister;\n@@ -217,10 +209,8 @@ class XMMRegister {\n public:\n   inline friend constexpr XMMRegister as_XMMRegister(int encoding);\n \n-  enum {\n-    number_of_registers    \u003d LP64_ONLY( 32 ) NOT_LP64(  8 ),\n-    max_slots_per_register \u003d LP64_ONLY( 16 ) NOT_LP64( 16 )   // 512-bit\n-  };\n+  static const int number_of_registers    \u003d  32;\n+  static const int max_slots_per_register \u003d  16; // 512-bit\n \n   class XMMRegisterImpl: public AbstractRegisterImpl {\n     friend class XMMRegister;\n@@ -250,11 +240,9 @@ class XMMRegister {\n \n   // Actually available XMM registers for use, depending on actual CPU capabilities and flags.\n   static int available_xmm_registers() {\n-#ifdef _LP64\n     if (UseAVX \u003c 3) {\n       return number_of_registers / 2;\n     }\n-#endif // _LP64\n     return number_of_registers;\n   }\n };\n@@ -287,7 +275,6 @@ constexpr XMMRegister xmm4  \u003d as_XMMRegister( 4);\n constexpr XMMRegister xmm5  \u003d as_XMMRegister( 5);\n constexpr XMMRegister xmm6  \u003d as_XMMRegister( 6);\n constexpr XMMRegister xmm7  \u003d as_XMMRegister( 7);\n-#ifdef _LP64\n constexpr XMMRegister xmm8  \u003d as_XMMRegister( 8);\n constexpr XMMRegister xmm9  \u003d as_XMMRegister( 9);\n constexpr XMMRegister xmm10 \u003d as_XMMRegister(10);\n@@ -312,7 +299,6 @@ constexpr XMMRegister xmm28 \u003d as_XMMRegister(28);\n constexpr XMMRegister xmm29 \u003d as_XMMRegister(29);\n constexpr XMMRegister xmm30 \u003d as_XMMRegister(30);\n constexpr XMMRegister xmm31 \u003d as_XMMRegister(31);\n-#endif // _LP64\n \n \n // The implementation of AVX-512 opmask registers.\n@@ -394,25 +380,17 @@ constexpr KRegister k7 \u003d as_KRegister(7);\n // Define a class that exports it.\n class ConcreteRegisterImpl : public AbstractRegisterImpl {\n  public:\n-  enum {\n-    max_gpr \u003d Register::number_of_registers * Register::max_slots_per_register,\n-    max_fpr \u003d max_gpr + FloatRegister::number_of_registers * FloatRegister::max_slots_per_register,\n-    max_xmm \u003d max_fpr + XMMRegister::number_of_registers * XMMRegister::max_slots_per_register,\n-    max_kpr \u003d max_xmm + KRegister::number_of_registers * KRegister::max_slots_per_register,\n+    static const int max_gpr \u003d Register::number_of_registers * Register::max_slots_per_register;\n+    static const int max_fpr \u003d max_gpr + FloatRegister::number_of_registers * FloatRegister::max_slots_per_register;\n+    static const int max_xmm \u003d max_fpr + XMMRegister::number_of_registers * XMMRegister::max_slots_per_register;\n+    static const int max_kpr \u003d max_xmm + KRegister::number_of_registers * KRegister::max_slots_per_register;\n \n     // A big enough number for C2: all the registers plus flags\n     // This number must be large enough to cover REG_COUNT (defined by c2) registers.\n     // There is no requirement that any ordering here matches any ordering c2 gives\n     // it\u0027s optoregs.\n-\n-    // x86_32.ad defines additional dummy FILL0-FILL7 registers, in order to tally\n-    // REG_COUNT (computed by ADLC based on the number of reg_defs seen in .ad files)\n-    // with ConcreteRegisterImpl::number_of_registers additional count of 8 is being\n-    // added for 32 bit jvm.\n-    number_of_registers \u003d max_kpr +       // gpr/fpr/xmm/kpr\n-                          NOT_LP64( 8 + ) // FILL0-FILL7 in x86_32.ad\n-                          1               // eflags\n-  };\n+    static const int number_of_registers \u003d max_kpr + // gpr/fpr/xmm/kpr\n+                                           1;        // eflags\n };\n \n template \u003c\u003e\ndiff --git a/src/hotspot/cpu/x86/vmreg_x86.cpp b/src/hotspot/cpu/x86/vmreg_x86.cpp\nindex 44aee56ef..45269e69f 100644\n--- a/src/hotspot/cpu/x86/vmreg_x86.cpp\n+++ b/src/hotspot/cpu/x86/vmreg_x86.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2006, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2006, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -32,9 +32,7 @@ void VMRegImpl::set_regName() {\n   int i;\n   for (i \u003d 0; i \u003c ConcreteRegisterImpl::max_gpr ; ) {\n     regName[i++] \u003d reg-\u003ename();\n-#ifdef AMD64\n     regName[i++] \u003d reg-\u003ename();\n-#endif // AMD64\n     reg \u003d reg-\u003esuccessor();\n   }\n \ndiff --git a/src/hotspot/cpu/x86/vmreg_x86.hpp b/src/hotspot/cpu/x86/vmreg_x86.hpp\nindex 6f7c7fafb..032ce654f 100644\n--- a/src/hotspot/cpu/x86/vmreg_x86.hpp\n+++ b/src/hotspot/cpu/x86/vmreg_x86.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2006, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2006, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -52,14 +52,8 @@ inline bool is_KRegister() {\n }\n \n inline Register as_Register() {\n-\n-  assert( is_Register(), \"must be\");\n-  // Yuk\n-#ifdef AMD64\n+  assert(is_Register(), \"must be\");\n   return ::as_Register(value() \u003e\u003e 1);\n-#else\n-  return ::as_Register(value());\n-#endif // AMD64\n }\n \n inline FloatRegister as_FloatRegister() {\n@@ -82,9 +76,6 @@ inline KRegister as_KRegister() {\n \n inline   bool is_concrete() {\n   assert(is_reg(), \"must be\");\n-#ifndef AMD64\n-  if (is_Register()) return true;\n-#endif // AMD64\n   // Do not use is_XMMRegister() here as it depends on the UseAVX setting.\n   if (value() \u003e\u003d ConcreteRegisterImpl::max_fpr \u0026\u0026 value() \u003c ConcreteRegisterImpl::max_xmm) {\n     int base \u003d value() - ConcreteRegisterImpl::max_fpr;\ndiff --git a/src/hotspot/cpu/x86/vmreg_x86.inline.hpp b/src/hotspot/cpu/x86/vmreg_x86.inline.hpp\nindex 1aeedc094..76d70900f 100644\n--- a/src/hotspot/cpu/x86/vmreg_x86.inline.hpp\n+++ b/src/hotspot/cpu/x86/vmreg_x86.inline.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2006, 2021, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2006, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -26,7 +26,7 @@\n #define CPU_X86_VMREG_X86_INLINE_HPP\n \n inline VMReg Register::RegisterImpl::as_VMReg() const {\n-  return VMRegImpl::as_VMReg(encoding() LP64_ONLY( \u003c\u003c 1 ));\n+  return VMRegImpl::as_VMReg(encoding() \u003c\u003c 1);\n }\n \n inline VMReg FloatRegister::FloatRegisterImpl::as_VMReg() const {","expectedMessage":"8354853: Clean up x86 registers after 32-bit x86 removal","repository":"jdk","commitHash":"f6d26c6b32a3ea394cc9b7f6046cd9d7d635c568","metadata":{"author":"Manuel Hssig \u003cmhaessig@openjdk.org\u003e"}}
{"id":"jdk-d16a9b2e","diff":" src/hotspot/share/opto/addnode.cpp                 |  30 ++--\n src/hotspot/share/opto/addnode.hpp                 |  46 ++---\n src/hotspot/share/opto/loopnode.cpp                |  18 +-\n src/hotspot/share/opto/macro.cpp                   |   4 +-\n src/hotspot/share/opto/movenode.cpp                |   4 +-\n src/hotspot/share/opto/node.hpp                    |   3 +\n src/hotspot/share/opto/phaseX.cpp                  |   9 +\n src/hotspot/share/opto/vectorization.cpp           |   2 +-\n .../jtreg/compiler/igvn/TestMinMaxIdentity.java    | 186 +++++++++++++++++++++\n 9 files changed, 251 insertions(+), 51 deletions(-)\n\ndiff --git a/src/hotspot/share/opto/addnode.cpp b/src/hotspot/share/opto/addnode.cpp\nindex 40cd6337c..e04da430e 100644\n--- a/src/hotspot/share/opto/addnode.cpp\n+++ b/src/hotspot/share/opto/addnode.cpp\n@@ -1195,7 +1195,7 @@ const Type* XorLNode::Value(PhaseGVN* phase) const {\n   return AddNode::Value(phase);\n }\n \n-Node* MaxNode::build_min_max_int(Node* a, Node* b, bool is_max) {\n+Node* MinMaxNode::build_min_max_int(Node* a, Node* b, bool is_max) {\n   if (is_max) {\n     return new MaxINode(a, b);\n   } else {\n@@ -1203,7 +1203,7 @@ Node* MaxNode::build_min_max_int(Node* a, Node* b, bool is_max) {\n   }\n }\n \n-Node* MaxNode::build_min_max_long(PhaseGVN* phase, Node* a, Node* b, bool is_max) {\n+Node* MinMaxNode::build_min_max_long(PhaseGVN* phase, Node* a, Node* b, bool is_max) {\n   if (is_max) {\n     return new MaxLNode(phase-\u003eC, a, b);\n   } else {\n@@ -1211,7 +1211,7 @@ Node* MaxNode::build_min_max_long(PhaseGVN* phase, Node* a, Node* b, bool is_max\n   }\n }\n \n-Node* MaxNode::build_min_max(Node* a, Node* b, bool is_max, bool is_unsigned, const Type* t, PhaseGVN\u0026 gvn) {\n+Node* MinMaxNode::build_min_max(Node* a, Node* b, bool is_max, bool is_unsigned, const Type* t, PhaseGVN\u0026 gvn) {\n   bool is_int \u003d gvn.type(a)-\u003eisa_int();\n   assert(is_int || gvn.type(a)-\u003eisa_long(), \"int or long inputs\");\n   assert(is_int \u003d\u003d (gvn.type(b)-\u003eisa_int() !\u003d nullptr), \"inconsistent inputs\");\n@@ -1243,7 +1243,7 @@ Node* MaxNode::build_min_max(Node* a, Node* b, bool is_max, bool is_unsigned, co\n   return res;\n }\n \n-Node* MaxNode::build_min_max_diff_with_zero(Node* a, Node* b, bool is_max, const Type* t, PhaseGVN\u0026 gvn) {\n+Node* MinMaxNode::build_min_max_diff_with_zero(Node* a, Node* b, bool is_max, const Type* t, PhaseGVN\u0026 gvn) {\n   bool is_int \u003d gvn.type(a)-\u003eisa_int();\n   assert(is_int || gvn.type(a)-\u003eisa_long(), \"int or long inputs\");\n   assert(is_int \u003d\u003d (gvn.type(b)-\u003eisa_int() !\u003d nullptr), \"inconsistent inputs\");\n@@ -1290,7 +1290,7 @@ static bool can_overflow(const TypeLong* t, jlong c) {\n // Let \u003cx, x_off\u003e \u003d x_operands and \u003cy, y_off\u003e \u003d y_operands.\n // If x \u003d\u003d y and neither add(x, x_off) nor add(y, y_off) overflow, return\n // add(x, op(x_off, y_off)). Otherwise, return nullptr.\n-Node* MaxNode::extract_add(PhaseGVN* phase, ConstAddOperands x_operands, ConstAddOperands y_operands) {\n+Node* MinMaxNode::extract_add(PhaseGVN* phase, ConstAddOperands x_operands, ConstAddOperands y_operands) {\n   Node* x \u003d x_operands.first;\n   Node* y \u003d y_operands.first;\n   int opcode \u003d Opcode();\n@@ -1327,7 +1327,7 @@ static ConstAddOperands as_add_with_constant(Node* n) {\n   return ConstAddOperands(x, c_type-\u003eis_int()-\u003eget_con());\n }\n \n-Node* MaxNode::IdealI(PhaseGVN* phase, bool can_reshape) {\n+Node* MinMaxNode::IdealI(PhaseGVN* phase, bool can_reshape) {\n   Node* n \u003d AddNode::Ideal(phase, can_reshape);\n   if (n !\u003d nullptr) {\n     return n;\n@@ -1401,7 +1401,7 @@ Node* MaxINode::Identity(PhaseGVN* phase) {\n     return in(2);\n   }\n \n-  return MaxNode::Identity(phase);\n+  return MinMaxNode::Identity(phase);\n }\n \n //\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\u003d\n@@ -1434,7 +1434,7 @@ Node* MinINode::Identity(PhaseGVN* phase) {\n     return in(1);\n   }\n \n-  return MaxNode::Identity(phase);\n+  return MinMaxNode::Identity(phase);\n }\n \n //------------------------------add_ring---------------------------------------\n@@ -1564,7 +1564,7 @@ Node* MaxLNode::Identity(PhaseGVN* phase) {\n     return in(2);\n   }\n \n-  return MaxNode::Identity(phase);\n+  return MinMaxNode::Identity(phase);\n }\n \n Node* MaxLNode::Ideal(PhaseGVN* phase, bool can_reshape) {\n@@ -1596,7 +1596,7 @@ Node* MinLNode::Identity(PhaseGVN* phase) {\n     return in(1);\n   }\n \n-  return MaxNode::Identity(phase);\n+  return MinMaxNode::Identity(phase);\n }\n \n Node* MinLNode::Ideal(PhaseGVN* phase, bool can_reshape) {\n@@ -1610,7 +1610,7 @@ Node* MinLNode::Ideal(PhaseGVN* phase, bool can_reshape) {\n   return nullptr;\n }\n \n-int MaxNode::opposite_opcode() const {\n+int MinMaxNode::opposite_opcode() const {\n   if (Opcode() \u003d\u003d max_opcode()) {\n     return min_opcode();\n   } else {\n@@ -1621,7 +1621,7 @@ int MaxNode::opposite_opcode() const {\n \n // Given a redundant structure such as Max/Min(A, Max/Min(B, C)) where A \u003d\u003d B or A \u003d\u003d C, return the useful part of the structure.\n // \u0027operation\u0027 is the node expected to be the inner \u0027Max/Min(B, C)\u0027, and \u0027operand\u0027 is the node expected to be the \u0027A\u0027 operand of the outer node.\n-Node* MaxNode::find_identity_operation(Node* operation, Node* operand) {\n+Node* MinMaxNode::find_identity_operation(Node* operation, Node* operand) {\n   if (operation-\u003eOpcode() \u003d\u003d Opcode() || operation-\u003eOpcode() \u003d\u003d opposite_opcode()) {\n     Node* n1 \u003d operation-\u003ein(1);\n     Node* n2 \u003d operation-\u003ein(2);\n@@ -1645,17 +1645,17 @@ Node* MaxNode::find_identity_operation(Node* operation, Node* operand) {\n   return nullptr;\n }\n \n-Node* MaxNode::Identity(PhaseGVN* phase) {\n+Node* MinMaxNode::Identity(PhaseGVN* phase) {\n   if (in(1) \u003d\u003d in(2)) {\n       return in(1);\n   }\n \n-  Node* identity_1 \u003d MaxNode::find_identity_operation(in(2), in(1));\n+  Node* identity_1 \u003d MinMaxNode::find_identity_operation(in(2), in(1));\n   if (identity_1 !\u003d nullptr) {\n     return identity_1;\n   }\n \n-  Node* identity_2 \u003d MaxNode::find_identity_operation(in(1), in(2));\n+  Node* identity_2 \u003d MinMaxNode::find_identity_operation(in(1), in(2));\n   if (identity_2 !\u003d nullptr) {\n     return identity_2;\n   }\ndiff --git a/src/hotspot/share/opto/addnode.hpp b/src/hotspot/share/opto/addnode.hpp\nindex 1bbdae92e..4151ab5d0 100644\n--- a/src/hotspot/share/opto/addnode.hpp\n+++ b/src/hotspot/share/opto/addnode.hpp\n@@ -324,14 +324,16 @@ class XorLNode : public AddNode {\n //------------------------------MaxNode----------------------------------------\n // Max (or min) of 2 values.  Included with the ADD nodes because it inherits\n // all the behavior of addition on a ring.\n-class MaxNode : public AddNode {\n+class MinMaxNode : public AddNode {\n private:\n   static Node* build_min_max(Node* a, Node* b, bool is_max, bool is_unsigned, const Type* t, PhaseGVN\u0026 gvn);\n   static Node* build_min_max_diff_with_zero(Node* a, Node* b, bool is_max, const Type* t, PhaseGVN\u0026 gvn);\n   Node* extract_add(PhaseGVN* phase, ConstAddOperands x_operands, ConstAddOperands y_operands);\n \n public:\n-  MaxNode( Node *in1, Node *in2 ) : AddNode(in1,in2) {}\n+  MinMaxNode(Node* in1, Node* in2) : AddNode(in1, in2) {\n+    init_class_id(Class_MinMax);\n+  }\n   virtual int Opcode() const \u003d 0;\n   virtual int max_opcode() const \u003d 0;\n   virtual int min_opcode() const \u003d 0;\n@@ -373,9 +375,9 @@ class MaxNode : public AddNode {\n //------------------------------MaxINode---------------------------------------\n // Maximum of 2 integers.  Included with the ADD nodes because it inherits\n // all the behavior of addition on a ring.\n-class MaxINode : public MaxNode {\n+class MaxINode : public MinMaxNode {\n public:\n-  MaxINode( Node *in1, Node *in2 ) : MaxNode(in1,in2) {}\n+  MaxINode(Node* in1, Node* in2) : MinMaxNode(in1, in2) {}\n   virtual int Opcode() const;\n   virtual const Type *add_ring( const Type *, const Type * ) const;\n   virtual const Type *add_id() const { return TypeInt::make(min_jint); }\n@@ -390,9 +392,9 @@ class MaxINode : public MaxNode {\n //------------------------------MinINode---------------------------------------\n // MINimum of 2 integers.  Included with the ADD nodes because it inherits\n // all the behavior of addition on a ring.\n-class MinINode : public MaxNode {\n+class MinINode : public MinMaxNode {\n public:\n-  MinINode( Node *in1, Node *in2 ) : MaxNode(in1,in2) {}\n+  MinINode(Node* in1, Node* in2) : MinMaxNode(in1, in2) {}\n   virtual int Opcode() const;\n   virtual const Type *add_ring( const Type *, const Type * ) const;\n   virtual const Type *add_id() const { return TypeInt::make(max_jint); }\n@@ -406,9 +408,9 @@ class MinINode : public MaxNode {\n \n //------------------------------MaxLNode---------------------------------------\n // MAXimum of 2 longs.\n-class MaxLNode : public MaxNode {\n+class MaxLNode : public MinMaxNode {\n public:\n-  MaxLNode(Compile* C, Node* in1, Node* in2) : MaxNode(in1, in2) {\n+  MaxLNode(Compile* C, Node* in1, Node* in2) : MinMaxNode(in1, in2) {\n     init_flags(Flag_is_macro);\n     C-\u003eadd_macro_node(this);\n   }\n@@ -425,9 +427,9 @@ class MaxLNode : public MaxNode {\n \n //------------------------------MinLNode---------------------------------------\n // MINimum of 2 longs.\n-class MinLNode : public MaxNode {\n+class MinLNode : public MinMaxNode {\n public:\n-  MinLNode(Compile* C, Node* in1, Node* in2) : MaxNode(in1, in2) {\n+  MinLNode(Compile* C, Node* in1, Node* in2) : MinMaxNode(in1, in2) {\n     init_flags(Flag_is_macro);\n     C-\u003eadd_macro_node(this);\n   }\n@@ -444,9 +446,9 @@ class MinLNode : public MaxNode {\n \n //------------------------------MaxFNode---------------------------------------\n // Maximum of 2 floats.\n-class MaxFNode : public MaxNode {\n+class MaxFNode : public MinMaxNode {\n public:\n-  MaxFNode(Node *in1, Node *in2) : MaxNode(in1, in2) {}\n+  MaxFNode(Node* in1, Node* in2) : MinMaxNode(in1, in2) {}\n   virtual int Opcode() const;\n   virtual const Type *add_ring(const Type*, const Type*) const;\n   virtual const Type *add_id() const { return TypeF::NEG_INF; }\n@@ -458,9 +460,9 @@ class MaxFNode : public MaxNode {\n \n //------------------------------MinFNode---------------------------------------\n // Minimum of 2 floats.\n-class MinFNode : public MaxNode {\n+class MinFNode : public MinMaxNode {\n public:\n-  MinFNode(Node *in1, Node *in2) : MaxNode(in1, in2) {}\n+  MinFNode(Node* in1, Node* in2) : MinMaxNode(in1, in2) {}\n   virtual int Opcode() const;\n   virtual const Type *add_ring(const Type*, const Type*) const;\n   virtual const Type *add_id() const { return TypeF::POS_INF; }\n@@ -472,9 +474,9 @@ class MinFNode : public MaxNode {\n \n //------------------------------MaxHFNode--------------------------------------\n // Maximum of 2 half floats.\n-class MaxHFNode : public MaxNode {\n+class MaxHFNode : public MinMaxNode {\n public:\n-  MaxHFNode(Node* in1, Node* in2) : MaxNode(in1, in2) {}\n+  MaxHFNode(Node* in1, Node* in2) : MinMaxNode(in1, in2) {}\n   virtual int Opcode() const;\n   virtual const Type* add_ring(const Type*, const Type*) const;\n   virtual const Type* add_id() const { return TypeH::NEG_INF; }\n@@ -486,9 +488,9 @@ class MaxHFNode : public MaxNode {\n \n //------------------------------MinHFNode---------------------------------------\n // Minimum of 2 half floats.\n-class MinHFNode : public MaxNode {\n+class MinHFNode : public MinMaxNode {\n public:\n-  MinHFNode(Node* in1, Node* in2) : MaxNode(in1, in2) {}\n+  MinHFNode(Node* in1, Node* in2) : MinMaxNode(in1, in2) {}\n   virtual int Opcode() const;\n   virtual const Type* add_ring(const Type*, const Type*) const;\n   virtual const Type* add_id() const { return TypeH::POS_INF; }\n@@ -500,9 +502,9 @@ class MinHFNode : public MaxNode {\n \n //------------------------------MaxDNode---------------------------------------\n // Maximum of 2 doubles.\n-class MaxDNode : public MaxNode {\n+class MaxDNode : public MinMaxNode {\n public:\n-  MaxDNode(Node *in1, Node *in2) : MaxNode(in1, in2) {}\n+  MaxDNode(Node* in1, Node* in2) : MinMaxNode(in1, in2) {}\n   virtual int Opcode() const;\n   virtual const Type *add_ring(const Type*, const Type*) const;\n   virtual const Type *add_id() const { return TypeD::NEG_INF; }\n@@ -514,9 +516,9 @@ class MaxDNode : public MaxNode {\n \n //------------------------------MinDNode---------------------------------------\n // Minimum of 2 doubles.\n-class MinDNode : public MaxNode {\n+class MinDNode : public MinMaxNode {\n public:\n-  MinDNode(Node *in1, Node *in2) : MaxNode(in1, in2) {}\n+  MinDNode(Node* in1, Node* in2) : MinMaxNode(in1, in2) {}\n   virtual int Opcode() const;\n   virtual const Type *add_ring(const Type*, const Type*) const;\n   virtual const Type *add_id() const { return TypeD::POS_INF; }\ndiff --git a/src/hotspot/share/opto/loopnode.cpp b/src/hotspot/share/opto/loopnode.cpp\nindex dacc1a1a7..8dc34af9c 100644\n--- a/src/hotspot/share/opto/loopnode.cpp\n+++ b/src/hotspot/share/opto/loopnode.cpp\n@@ -979,9 +979,9 @@ bool PhaseIdealLoop::create_loop_nest(IdealLoopTree* loop, Node_List \u0026old_new) {\n \n   Node* inner_iters_max \u003d nullptr;\n   if (stride_con \u003e 0) {\n-    inner_iters_max \u003d MaxNode::max_diff_with_zero(limit, outer_phi, TypeInteger::bottom(bt), _igvn);\n+    inner_iters_max \u003d MinMaxNode::max_diff_with_zero(limit, outer_phi, TypeInteger::bottom(bt), _igvn);\n   } else {\n-    inner_iters_max \u003d MaxNode::max_diff_with_zero(outer_phi, limit, TypeInteger::bottom(bt), _igvn);\n+    inner_iters_max \u003d MinMaxNode::max_diff_with_zero(outer_phi, limit, TypeInteger::bottom(bt), _igvn);\n   }\n \n   Node* inner_iters_limit \u003d _igvn.integercon(iters_limit, bt);\n@@ -989,7 +989,7 @@ bool PhaseIdealLoop::create_loop_nest(IdealLoopTree* loop, Node_List \u0026old_new) {\n   // Long.MIN_VALUE to Long.MAX_VALUE for instance). Use an unsigned\n   // min.\n   const TypeInteger* inner_iters_actual_range \u003d TypeInteger::make(0, iters_limit, Type::WidenMin, bt);\n-  Node* inner_iters_actual \u003d MaxNode::unsigned_min(inner_iters_max, inner_iters_limit, inner_iters_actual_range, _igvn);\n+  Node* inner_iters_actual \u003d MinMaxNode::unsigned_min(inner_iters_max, inner_iters_limit, inner_iters_actual_range, _igvn);\n \n   Node* inner_iters_actual_int;\n   if (bt \u003d\u003d T_LONG) {\n@@ -1618,7 +1618,7 @@ void PhaseIdealLoop::transform_long_range_checks(int stride_con, const Node_List\n       Node* max_jint_plus_one_long \u003d longcon((jlong)max_jint + 1);\n       Node* max_range \u003d new AddLNode(max_jint_plus_one_long, L);\n       register_new_node(max_range, entry_control);\n-      R \u003d MaxNode::unsigned_min(R, max_range, TypeLong::POS, _igvn);\n+      R \u003d MinMaxNode::unsigned_min(R, max_range, TypeLong::POS, _igvn);\n       set_subtree_ctrl(R, true);\n     }\n \n@@ -1717,9 +1717,9 @@ void PhaseIdealLoop::transform_long_range_checks(int stride_con, const Node_List\n }\n \n Node* PhaseIdealLoop::clamp(Node* R, Node* L, Node* H) {\n-  Node* min \u003d MaxNode::signed_min(R, H, TypeLong::LONG, _igvn);\n+  Node* min \u003d MinMaxNode::signed_min(R, H, TypeLong::LONG, _igvn);\n   set_subtree_ctrl(min, true);\n-  Node* max \u003d MaxNode::signed_max(L, min, TypeLong::LONG, _igvn);\n+  Node* max \u003d MinMaxNode::signed_max(L, min, TypeLong::LONG, _igvn);\n   set_subtree_ctrl(max, true);\n   return max;\n }\n@@ -3485,14 +3485,14 @@ void OuterStripMinedLoopNode::adjust_strip_mined_loop(PhaseIterGVN* igvn) {\n     // the loop body to be run for LoopStripMiningIter.\n     Node* max \u003d nullptr;\n     if (stride \u003e 0) {\n-      max \u003d MaxNode::max_diff_with_zero(limit, iv_phi, TypeInt::INT, *igvn);\n+      max \u003d MinMaxNode::max_diff_with_zero(limit, iv_phi, TypeInt::INT, *igvn);\n     } else {\n-      max \u003d MaxNode::max_diff_with_zero(iv_phi, limit, TypeInt::INT, *igvn);\n+      max \u003d MinMaxNode::max_diff_with_zero(iv_phi, limit, TypeInt::INT, *igvn);\n     }\n     // sub is positive and can be larger than the max signed int\n     // value. Use an unsigned min.\n     Node* const_iters \u003d igvn-\u003eintcon(scaled_iters);\n-    Node* min \u003d MaxNode::unsigned_min(max, const_iters, TypeInt::make(0, scaled_iters, Type::WidenMin), *igvn);\n+    Node* min \u003d MinMaxNode::unsigned_min(max, const_iters, TypeInt::make(0, scaled_iters, Type::WidenMin), *igvn);\n     // min is the number of iterations for the next inner loop execution:\n     // unsigned_min(max(limit - iv_phi, 0), scaled_iters) if stride \u003e 0\n     // unsigned_min(max(iv_phi - limit, 0), scaled_iters) if stride \u003c 0\ndiff --git a/src/hotspot/share/opto/macro.cpp b/src/hotspot/share/opto/macro.cpp\nindex 80818a4dd..4df037143 100644\n--- a/src/hotspot/share/opto/macro.cpp\n+++ b/src/hotspot/share/opto/macro.cpp\n@@ -2577,11 +2577,11 @@ void PhaseMacroExpand::eliminate_opaque_looplimit_macro_nodes() {\n         // a CMoveL construct now. At least until here, the type could be computed\n         // precisely. CMoveL is not so smart, but we can give it at least the best\n         // type we know abouot n now.\n-        Node* repl \u003d MaxNode::signed_max(n-\u003ein(1), n-\u003ein(2), _igvn.type(n), _igvn);\n+        Node* repl \u003d MinMaxNode::signed_max(n-\u003ein(1), n-\u003ein(2), _igvn.type(n), _igvn);\n         _igvn.replace_node(n, repl);\n         success \u003d true;\n       } else if (n-\u003eOpcode() \u003d\u003d Op_MinL) {\n-        Node* repl \u003d MaxNode::signed_min(n-\u003ein(1), n-\u003ein(2), _igvn.type(n), _igvn);\n+        Node* repl \u003d MinMaxNode::signed_min(n-\u003ein(1), n-\u003ein(2), _igvn.type(n), _igvn);\n         _igvn.replace_node(n, repl);\n         success \u003d true;\n       }\ndiff --git a/src/hotspot/share/opto/movenode.cpp b/src/hotspot/share/opto/movenode.cpp\nindex 66db1df33..6b6becb43 100644\n--- a/src/hotspot/share/opto/movenode.cpp\n+++ b/src/hotspot/share/opto/movenode.cpp\n@@ -271,9 +271,9 @@ Node* CMoveNode::Ideal_minmax(PhaseGVN* phase, CMoveNode* cmove) {\n \n   // Create the Min/Max node based on the type and kind\n   if (cmp_op \u003d\u003d Op_CmpL) {\n-    return MaxNode::build_min_max_long(phase, cmp_l, cmp_r, is_max);\n+    return MinMaxNode::build_min_max_long(phase, cmp_l, cmp_r, is_max);\n   } else {\n-    return MaxNode::build_min_max_int(cmp_l, cmp_r, is_max);\n+    return MinMaxNode::build_min_max_int(cmp_l, cmp_r, is_max);\n   }\n }\n \ndiff --git a/src/hotspot/share/opto/node.hpp b/src/hotspot/share/opto/node.hpp\nindex 0adb20721..f1d9785a7 100644\n--- a/src/hotspot/share/opto/node.hpp\n+++ b/src/hotspot/share/opto/node.hpp\n@@ -130,6 +130,7 @@ class MemBarNode;\n class MemBarStoreStoreNode;\n class MemNode;\n class MergeMemNode;\n+class MinMaxNode;\n class MoveNode;\n class MulNode;\n class MultiNode;\n@@ -809,6 +810,7 @@ class Node {\n     DEFINE_CLASS_ID(AddP,     Node, 9)\n     DEFINE_CLASS_ID(BoxLock,  Node, 10)\n     DEFINE_CLASS_ID(Add,      Node, 11)\n+      DEFINE_CLASS_ID(MinMax,      Add, 0)\n     DEFINE_CLASS_ID(Mul,      Node, 12)\n     DEFINE_CLASS_ID(ClearArray, Node, 14)\n     DEFINE_CLASS_ID(Halt,     Node, 15)\n@@ -986,6 +988,7 @@ class Node {\n   DEFINE_CLASS_QUERY(MemBar)\n   DEFINE_CLASS_QUERY(MemBarStoreStore)\n   DEFINE_CLASS_QUERY(MergeMem)\n+  DEFINE_CLASS_QUERY(MinMax)\n   DEFINE_CLASS_QUERY(Move)\n   DEFINE_CLASS_QUERY(Mul)\n   DEFINE_CLASS_QUERY(Multi)\ndiff --git a/src/hotspot/share/opto/phaseX.cpp b/src/hotspot/share/opto/phaseX.cpp\nindex c4bdc5e89..52badca80 100644\n--- a/src/hotspot/share/opto/phaseX.cpp\n+++ b/src/hotspot/share/opto/phaseX.cpp\n@@ -2633,6 +2633,15 @@ void PhaseIterGVN::add_users_of_use_to_worklist(Node* n, Node* use, Unique_Node_\n       }\n     }\n   }\n+  // Check for Max/Min(A, Max/Min(B, C)) where A \u003d\u003d B or A \u003d\u003d C\n+  if (use-\u003eis_MinMax()) {\n+    for (DUIterator_Fast i2max, i2 \u003d use-\u003efast_outs(i2max); i2 \u003c i2max; i2++) {\n+      Node* u \u003d use-\u003efast_out(i2);\n+      if (u-\u003eOpcode() \u003d\u003d use-\u003eOpcode()) {\n+        worklist.push(u);\n+      }\n+    }\n+  }\n   auto enqueue_init_mem_projs \u003d [\u0026](ProjNode* proj) {\n     add_users_to_worklist0(proj, worklist);\n   };\ndiff --git a/src/hotspot/share/opto/vectorization.cpp b/src/hotspot/share/opto/vectorization.cpp\nindex 1755b0453..8e0ca927a 100644\n--- a/src/hotspot/share/opto/vectorization.cpp\n+++ b/src/hotspot/share/opto/vectorization.cpp\n@@ -1122,7 +1122,7 @@ Node* make_last(Node* initL, jint stride, Node* limitL, PhaseIdealLoop* phase) {\n   Node* last \u003d new AddLNode(initL, k_mul_stride);\n \n   // Make sure that the last does not lie \"before\" init.\n-  Node* last_clamped \u003d MaxNode::build_min_max_long(\u0026igvn, initL, last, stride \u003e 0);\n+  Node* last_clamped \u003d MinMaxNode::build_min_max_long(\u0026igvn, initL, last, stride \u003e 0);\n \n   phase-\u003eregister_new_node_with_ctrl_of(diffL,        initL);\n   phase-\u003eregister_new_node_with_ctrl_of(diffL_m1,     initL);\ndiff --git a/test/hotspot/jtreg/compiler/igvn/TestMinMaxIdentity.java b/test/hotspot/jtreg/compiler/igvn/TestMinMaxIdentity.java\nnew file mode 100644\nindex 000000000..d358359ff\n--- /dev/null\n+++ b/test/hotspot/jtreg/compiler/igvn/TestMinMaxIdentity.java\n@@ -0,0 +1,186 @@\n+/*\n+ * Copyright (c) 2025 IBM Corporation. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+\n+/*\n+ * @test\n+ * @bug 8373134\n+ * @summary Verify that min/max add identity optimizations get applied correctly\n+ * @modules java.base/jdk.internal.misc\n+ * @modules jdk.incubator.vector\n+ * @library /test/lib /\n+ * @run driver ${test.main.class}\n+ */\n+\n+package compiler.igvn;\n+\n+import compiler.lib.compile_framework.CompileFramework;\n+import compiler.lib.template_framework.Template;\n+import compiler.lib.template_framework.TemplateToken;\n+import compiler.lib.template_framework.library.CodeGenerationDataNameType;\n+import compiler.lib.template_framework.library.PrimitiveType;\n+import compiler.lib.template_framework.library.TestFrameworkClass;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+import static compiler.lib.template_framework.Template.let;\n+import static compiler.lib.template_framework.Template.scope;\n+\n+public class TestMinMaxIdentity {\n+    public static void main(String[] args) {\n+        // Create a new CompileFramework instance.\n+        CompileFramework comp \u003d new CompileFramework();\n+\n+        // Add a java source file.\n+        comp.addJavaSourceCode(\"compiler.igvn.templated.MinMaxIdentity\", generate(comp));\n+\n+        // Compile the source file.\n+        comp.compile(\"--add-modules\u003djdk.incubator.vector\");\n+\n+        comp.invoke(\"compiler.igvn.templated.MinMaxIdentity\", \"main\", new Object[] {new String[] {\n+            \"--add-modules\u003djdk.incubator.vector\",\n+            \"--add-opens\", \"jdk.incubator.vector/jdk.incubator.vector\u003dALL-UNNAMED\"\n+        }});\n+    }\n+\n+    private static String generate(CompileFramework comp) {\n+        // Create a list to collect all tests.\n+        List\u003cTemplateToken\u003e testTemplateTokens \u003d new ArrayList\u003c\u003e();\n+\n+        Stream.of(MinMaxOp.values())\n+            .flatMap(MinMaxOp::generate)\n+            .forEach(testTemplateTokens::add);\n+\n+        Stream.of(Fp16MinMaxOp.values())\n+            .flatMap(Fp16MinMaxOp::generate)\n+            .forEach(testTemplateTokens::add);\n+\n+        // Create the test class, which runs all testTemplateTokens.\n+        return TestFrameworkClass.render(\n+            // package and class name.\n+            \"compiler.igvn.templated\", \"MinMaxIdentity\",\n+            // List of imports.\n+            Set.of(\"jdk.incubator.vector.Float16\"),\n+            // classpath, so the Test VM has access to the compiled class files.\n+            comp.getEscapedClassPathOfCompiledClasses(),\n+            // The list of tests.\n+            testTemplateTokens);\n+    }\n+\n+    enum MinMaxOp {\n+        MIN_D(\"min\", CodeGenerationDataNameType.doubles()),\n+        MAX_D(\"max\", CodeGenerationDataNameType.doubles()),\n+        MIN_F(\"min\", CodeGenerationDataNameType.floats()),\n+        MAX_F(\"max\", CodeGenerationDataNameType.floats()),\n+        MIN_I(\"min\", CodeGenerationDataNameType.ints()),\n+        MAX_I(\"max\", CodeGenerationDataNameType.ints()),\n+        MIN_L(\"min\", CodeGenerationDataNameType.longs()),\n+        MAX_L(\"max\", CodeGenerationDataNameType.longs());\n+\n+        final String functionName;\n+        final PrimitiveType type;\n+\n+        MinMaxOp(String functionName, PrimitiveType type) {\n+            this.functionName \u003d functionName;\n+            this.type \u003d type;\n+        }\n+\n+        Stream\u003cTemplateToken\u003e generate() {\n+            return Stream.of(template(\"a\", \"b\"), template(\"b\", \"a\")).\n+                map(Template.ZeroArgs::asToken);\n+        }\n+\n+        private Template.ZeroArgs template(String arg1, String arg2) {\n+            return Template.make(() -\u003e scope(\n+                let(\"boxedTypeName\", type.boxedTypeName()),\n+                let(\"op\", name()),\n+                let(\"type\", type.name()),\n+                let(\"functionName\", functionName),\n+                let(\"arg1\", arg1),\n+                let(\"arg2\", arg2),\n+                \"\"\"\n+                @Test\n+                @IR(counts \u003d {IRNode.#op, \"\u003d 1\"},\n+                    phase \u003d CompilePhase.BEFORE_MACRO_EXPANSION)\n+                @Arguments(values \u003d {Argument.NUMBER_42, Argument.NUMBER_42})\n+                public #type $test(#type #arg1, #type #arg2) {\n+                    int i;\n+                    for (i \u003d -10; i \u003c 1; i++) {\n+                    }\n+                    #type c \u003d a * i;\n+                    return #boxedTypeName.#functionName(a, #boxedTypeName.#functionName(b, c));\n+                }\n+                \"\"\"\n+            ));\n+        }\n+    }\n+\n+    enum Fp16MinMaxOp {\n+        MAX_HF(\"max\"),\n+        MIN_HF(\"min\");\n+\n+        final String functionName;\n+\n+        Fp16MinMaxOp(String functionName) {\n+            this.functionName \u003d functionName;\n+        }\n+\n+        Stream\u003cTemplateToken\u003e generate() {\n+            return Stream.of(template(\"a\", \"b\"), template(\"b\", \"a\")).\n+                map(Template.ZeroArgs::asToken);\n+        }\n+\n+        private Template.ZeroArgs template(String arg1, String arg2) {\n+            return Template.make(() -\u003e scope(\n+                let(\"op\", name()),\n+                let(\"functionName\", functionName),\n+                let(\"arg1\", arg1),\n+                let(\"arg2\", arg2),\n+                \"\"\"\n+                @Setup\n+                private static Object[] $setup() {\n+                    return new Object[] {Float16.valueOf(42), Float16.valueOf(42)};\n+                }\n+\n+                @Test\n+                @IR(counts \u003d {IRNode.#op, \"\u003d 1\"},\n+                    phase \u003d CompilePhase.BEFORE_MACRO_EXPANSION,\n+                    applyIfCPUFeatureOr \u003d {\"avx512_fp16\", \"true\", \"zfh\", \"true\"})\n+                @IR(counts \u003d {IRNode.#op, \"\u003d 1\"},\n+                    phase \u003d CompilePhase.BEFORE_MACRO_EXPANSION,\n+                    applyIfCPUFeatureAnd \u003d {\"fphp\", \"true\", \"asimdhp\", \"true\"})\n+                @Arguments(setup \u003d \"$setup\")\n+                public Float16 $test(Float16 #arg1, Float16 #arg2) {\n+                    int i;\n+                    for (i \u003d -10; i \u003c 1; i++) {\n+                    }\n+                    Float16 c \u003d Float16.multiply(a, Float16.valueOf(i));\n+                    return Float16.#functionName(a, Float16.#functionName(b, c));\n+                }\n+                \"\"\"\n+            ));\n+        }\n+    }\n+}","expectedMessage":"8373134: C2: Min/Max users of Min/Max uses should be enqueued for GVN","repository":"jdk","commitHash":"d16a9b2ec507251a44f034f1ccf8039f02023d52","metadata":{"author":"Galder Zamarreo \u003cgalder@openjdk.org\u003e"}}
{"id":"jdk-b6b33792","diff":" src/hotspot/share/runtime/arguments.cpp | 23 ++++++++++++++---------\n 1 file changed, 14 insertions(+), 9 deletions(-)\n\ndiff --git a/src/hotspot/share/runtime/arguments.cpp b/src/hotspot/share/runtime/arguments.cpp\nindex cf0a1ab97..546ae6107 100644\n--- a/src/hotspot/share/runtime/arguments.cpp\n+++ b/src/hotspot/share/runtime/arguments.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1997, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -64,7 +64,6 @@\n #include \"runtime/vm_version.hpp\"\n #include \"services/management.hpp\"\n #include \"utilities/align.hpp\"\n-#include \"utilities/checkedCast.hpp\"\n #include \"utilities/debug.hpp\"\n #include \"utilities/defaultStream.hpp\"\n #include \"utilities/macros.hpp\"\n@@ -1207,16 +1206,22 @@ bool Arguments::process_settings_file(const char* file_name, bool should_exist,\n   }\n \n   char token[1024];\n-  int  pos \u003d 0;\n+  size_t pos \u003d 0;\n \n   bool in_white_space \u003d true;\n   bool in_comment     \u003d false;\n   bool in_quote       \u003d false;\n-  int  quote_c        \u003d 0;\n+  char quote_c        \u003d 0;\n   bool result         \u003d true;\n \n-  int c \u003d getc(stream);\n-  while(c !\u003d EOF \u0026\u0026 pos \u003c (int)(sizeof(token)-1)) {\n+  int c_or_eof \u003d getc(stream);\n+  while (c_or_eof !\u003d EOF \u0026\u0026 pos \u003c (sizeof(token) - 1)) {\n+    // We have checked the c_or_eof for EOF. getc should only ever return the\n+    // EOF or an unsigned char converted to an int. We cast down to a char to\n+    // avoid the char to int promotions we would otherwise do in the comparisons\n+    // below (which would be incorrect if we ever compared to a non-ascii char),\n+    // and the int to char conversions we would otherwise do in the assignments.\n+    const char c \u003d static_cast\u003cchar\u003e(c_or_eof);\n     if (in_white_space) {\n       if (in_comment) {\n         if (c \u003d\u003d \u0027\\n\u0027) in_comment \u003d false;\n@@ -1224,7 +1229,7 @@ bool Arguments::process_settings_file(const char* file_name, bool should_exist,\n         if (c \u003d\u003d \u0027#\u0027) in_comment \u003d true;\n         else if (!isspace((unsigned char) c)) {\n           in_white_space \u003d false;\n-          token[pos++] \u003d checked_cast\u003cchar\u003e(c);\n+          token[pos++] \u003d c;\n         }\n       }\n     } else {\n@@ -1244,10 +1249,10 @@ bool Arguments::process_settings_file(const char* file_name, bool should_exist,\n       } else if (in_quote \u0026\u0026 (c \u003d\u003d quote_c)) {\n         in_quote \u003d false;\n       } else {\n-        token[pos++] \u003d checked_cast\u003cchar\u003e(c);\n+        token[pos++] \u003d c;\n       }\n     }\n-    c \u003d getc(stream);\n+    c_or_eof \u003d getc(stream);\n   }\n   if (pos \u003e 0) {\n     token[pos] \u003d \u0027\\0\u0027;","expectedMessage":"8371762: Incorrect use of checked_cast in Arguments::process_settings_file","repository":"jdk","commitHash":"b6b337926d5f13ee2bca12ea94530ea59911ff2f","metadata":{"author":"Axel Boldt-Christmas \u003caboldtch@openjdk.org\u003e"}}
{"id":"jdk-499b5882","diff":" .../jdk/jpackage/internal/MacDmgLicense.java       | 103 +++++++++++\n .../jdk/jpackage/internal/MacDmgPackager.java      |  31 +---\n .../internal/resources/MacResources.properties     |   5 +\n .../internal/resources/MacResources_de.properties  |   7 +-\n .../internal/resources/MacResources_ja.properties  |   7 +-\n .../resources/MacResources_zh_CN.properties        |   7 +-\n .../jpackage/internal/resources/lic_template.plist | 200 +++++----------------\n .../helpers/jdk/jpackage/test/Executor.java        |   4 +-\n test/jdk/tools/jpackage/share/LicenseTest.java     |  33 +++-\n 9 files changed, 205 insertions(+), 192 deletions(-)\n\ndiff --git a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/MacDmgLicense.java b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/MacDmgLicense.java\nnew file mode 100644\nindex 000000000..eea09b809\n--- /dev/null\n+++ b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/MacDmgLicense.java\n@@ -0,0 +1,103 @@\n+/*\n+ * Copyright (c) 2026, Oracle and/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+\n+package jdk.jpackage.internal;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.ResourceBundle;\n+\n+import jdk.jpackage.internal.resources.ResourceLocator;\n+\n+final class MacDmgLicense {\n+\n+    public static void prepareLicensePListFile(Path licenseFile, Path licensePListFile)\n+            throws IOException {\n+        byte[] licenseContentOriginal \u003d\n+                Files.readAllBytes(licenseFile);\n+        String licenseInBase64 \u003d\n+                Base64.getEncoder().encodeToString(licenseContentOriginal);\n+\n+        Map\u003cString, String\u003e data \u003d new HashMap\u003c\u003e();\n+        data.put(\"APPLICATION_LICENSE_TEXT\", licenseInBase64);\n+        data.put(\"STR_DATA_ENGLISH\",\n+                getSTRData(\"English\", Locale.ENGLISH, \"MacRoman\"));\n+        data.put(\"STR_DATA_GERMAN\",\n+                getSTRData(\"German\", Locale.GERMAN, \"MacRoman\"));\n+        data.put(\"STR_DATA_JAPANESE\",\n+                getSTRData(\"Japanese\", Locale.JAPANESE, \"Shift_JIS\"));\n+        data.put(\"STR_DATA_SIMPLIFIED_CHINESE\",\n+                getSTRData(\"Simplified Chinese\", Locale.SIMPLIFIED_CHINESE, \"GB2312\"));\n+\n+        new OverridableResource(DEFAULT_LICENSE_PLIST, ResourceLocator.class)\n+                .setCategory(I18N.getString(\"resource.license-setup\"))\n+                .setSubstitutionData(data)\n+                .saveToFile(licensePListFile);\n+    }\n+\n+    private static void writeSTRDataString(ByteArrayOutputStream bos,\n+                String str, String charset) {\n+        byte [] bytes \u003d str.getBytes(Charset.forName(charset));\n+        byte [] bytesLength \u003d {(byte)bytes.length};\n+        bos.writeBytes(bytesLength);\n+        bos.writeBytes(bytes);\n+    }\n+\n+    // Returns base64 decoded STR section data.\n+    // Strings should be in following order:\n+    // Language, message.dmg.license.button.agree,\n+    // message.dmg.license.button.disagree, message.dmg.license.button.print\n+    // message.dmg.license.button.save, message.dmg.license.message\n+    // STR section data encoded:\n+    // Number of strings in the list (unsigned 16-bit integer, big endian): 6\n+    // A sequence of strings prefixed with string length (unsigned 8-bit integer)\n+    // Note: Language should not be translated.\n+    private static String getSTRData(String language, Locale locale, String charset) {\n+        ResourceBundle bundle \u003d ResourceBundle.getBundle(\n+                \"jdk.jpackage.internal.resources.MacResources\", locale);\n+        ByteArrayOutputStream bos \u003d new ByteArrayOutputStream();\n+\n+        byte [] numberOfStrings \u003d {0x00, 0x06}; // Always 6\n+        bos.writeBytes(numberOfStrings);\n+\n+        writeSTRDataString(bos, language, charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.agree\"), charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.disagree\"), charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.print\"), charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.save\"), charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.message\"), charset);\n+\n+        return Base64.getEncoder().encodeToString(bos.toByteArray());\n+    }\n+\n+    private static final String DEFAULT_LICENSE_PLIST \u003d \"lic_template.plist\";\n+}\ndiff --git a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/MacDmgPackager.java b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/MacDmgPackager.java\nindex 82bb9fc4d..cf4db226d 100644\n--- a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/MacDmgPackager.java\n+++ b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/MacDmgPackager.java\n@@ -34,7 +34,6 @@\n import java.nio.file.Path;\n import java.text.MessageFormat;\n import java.util.ArrayList;\n-import java.util.Base64;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n@@ -105,7 +104,7 @@ Path volumeIcon() {\n         return env.configDir().resolve(pkg.app().name() + \"-volume.icns\");\n     }\n \n-    Path licenseFile() {\n+    Path licensePListFile() {\n         return env.configDir().resolve(pkg.app().name() + \"-license.plist\");\n     }\n \n@@ -175,26 +174,6 @@ private void prepareDMGSetupScript() throws IOException {\n                 .saveToFile(dmgSetup);\n     }\n \n-    private void prepareLicense() throws IOException {\n-        final var licFile \u003d pkg.licenseFile();\n-        if (licFile.isEmpty()) {\n-            return;\n-        }\n-\n-        byte[] licenseContentOriginal \u003d\n-                Files.readAllBytes(licFile.orElseThrow());\n-        String licenseInBase64 \u003d\n-                Base64.getEncoder().encodeToString(licenseContentOriginal);\n-\n-        Map\u003cString, String\u003e data \u003d new HashMap\u003c\u003e();\n-        data.put(\"APPLICATION_LICENSE_TEXT\", licenseInBase64);\n-\n-        env.createResource(DEFAULT_LICENSE_PLIST)\n-                .setCategory(I18N.getString(\"resource.license-setup\"))\n-                .setSubstitutionData(data)\n-                .saveToFile(licenseFile());\n-    }\n-\n     private void prepareConfigFiles() throws IOException {\n \n         env.createResource(DEFAULT_BACKGROUND_IMAGE)\n@@ -206,7 +185,9 @@ private void prepareConfigFiles() throws IOException {\n                 .setExternal(pkg.icon().orElse(null))\n                 .saveToFile(volumeIcon());\n \n-        prepareLicense();\n+        if (pkg.licenseFile().isPresent()) {\n+            MacDmgLicense.prepareLicensePListFile(pkg.licenseFile().get(), licensePListFile());\n+        }\n \n         prepareDMGSetupScript();\n     }\n@@ -359,7 +340,7 @@ private void buildDMG() throws IOException {\n                     \"udifrez\",\n                     normalizedAbsolutePathString(finalDMG),\n                     \"-xml\",\n-                    normalizedAbsolutePathString(licenseFile())\n+                    normalizedAbsolutePathString(licensePListFile())\n             ).retry()\n                     .setMaxAttemptsCount(10)\n                     .setAttemptTimeout(3, TimeUnit.SECONDS)\n@@ -441,6 +422,4 @@ private void convertProtoDmg() throws IOException {\n     private static final String DEFAULT_BACKGROUND_IMAGE \u003d \"background_dmg.tiff\";\n     private static final String DEFAULT_DMG_SETUP_SCRIPT \u003d \"DMGsetup.scpt\";\n     private static final String TEMPLATE_BUNDLE_ICON \u003d \"JavaApp.icns\";\n-\n-    private static final String DEFAULT_LICENSE_PLIST\u003d\"lic_template.plist\";\n }\ndiff --git a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources.properties b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources.properties\nindex ceeab587f..0237d49f3 100644\n--- a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources.properties\n+++ b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources.properties\n@@ -64,6 +64,11 @@ message.signing.pkg\u003dWarning: For signing PKG, you might need to set \"Always Trus\n message.setfile.dmg\u003dSetting custom icon on DMG file skipped because \u0027SetFile\u0027 utility was not found. Installing Xcode with Command Line Tools should resolve this issue.\n message.codesign.failed.reason.app.content\u003d\"codesign\" failed and additional application content was supplied via the \"--app-content\" parameter. Probably the additional content broke the integrity of the application bundle and caused the failure. Ensure content supplied via the \"--app-content\" parameter does not break the integrity of the application bundle, or add it in the post-processing step.\n message.codesign.failed.reason.xcode.tools\u003dPossible reason for \"codesign\" failure is missing Xcode with command line developer tools. Install Xcode with command line developer tools to see if it resolves the problem.\n+message.dmg.license.button.agree\u003dAgree\n+message.dmg.license.button.disagree\u003dDisagree\n+message.dmg.license.button.print\u003dPrint\n+message.dmg.license.button.save\u003dSave...\n+message.dmg.license.message\u003dIf you agree with the terms of this license, press \"Agree\" to install the software. If you do not agree, press \"Disagree\".\n warning.unsigned.app.image\u003dWarning: Using unsigned app-image to build signed {0}.\n warning.per.user.app.image.signed\u003dWarning: Support for per-user configuration of the installed application will not be supported due to missing \"{0}\" in predefined signed application image.\n warning.non.standard.contents.sub.dir\u003dWarning: The file name of the directory \"{0}\" specified for the --app-content option is not a standard subdirectory name in the \"Contents\" directory of the application bundle. The result application bundle may fail code signing and/or notarization.\ndiff --git a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_de.properties b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_de.properties\nindex 3cc56bb6c..367f3216f 100644\n--- a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_de.properties\n+++ b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_de.properties\n@@ -1,5 +1,5 @@\n #\n-# Copyright (c) 2017, 2025, Oracle and/or its affiliates. All rights reserved.\n+# Copyright (c) 2017, 2026, Oracle and/or its affiliates. All rights reserved.\n # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n #\n # This code is free software; you can redistribute it and/or modify it\n@@ -71,6 +71,11 @@ message.signing.pkg\u003dWarnung: Zum Signieren von PKG mssen Sie mglicherweise m\n message.setfile.dmg\u003dDas Festlegen des benutzerdefinierten Symbols fr die DMG-Datei wurde bersprungen, weil das Utility \"SetFile\" nicht gefunden wurde. Durch Installieren von Xcode mit Befehlszeilentools sollte dieses Problem behoben werden.\n message.codesign.failed.reason.app.content\u003d\"codesign\" war nicht erfolgreich, und zustzlicher Anwendungsinhalt wurde ber den Parameter \"--app-content\" angegeben. Wahrscheinlich hat der zustzliche Inhalt die Integritt des Anwendungs-Bundles beeintrchtigt und den Fehler verursacht. Stellen Sie sicher, das der ber den Parameter \"--app-content\" angegebene Inhalt nicht die Integritt des Anwendungs-Bundles beeintrchtigt, oder fgen Sie ihn im Nachverarbeitungsschritt hinzu.\n message.codesign.failed.reason.xcode.tools\u003dMglicher Grund fr \"codesign\"-Fehler ist fehlender Xcode mit Befehlszeilen-Entwicklertools. Installieren Sie Xcode mit Befehlszeilen-Entwicklertools, und prfen Sie, ob das Problem dadurch beseitigt wird.\n+message.dmg.license.button.agree\u003dAkzeptieren\n+message.dmg.license.button.disagree\u003dAblehnen\n+message.dmg.license.button.print\u003dDrucken\n+message.dmg.license.button.save\u003dSichern...\n+message.dmg.license.message\u003dKlicken Sie in Akzeptieren, wenn Sie mit den Bestimmungen des Software-Lizenzvertrags einverstanden sind. Falls nicht, bitte Ablehnen anklicken. Sie knnen die Software nur installieren, wenn Sie Akzeptieren angeklickt haben.\n warning.unsigned.app.image\u003dWarnung: Nicht signiertes app-image wird zum Erstellen von signiertem {0} verwendet.\n warning.per.user.app.image.signed\u003dWarnung: Konfiguration der installierten Anwendung pro Benutzer wird nicht untersttzt, da \"{0}\" im vordefinierten signierten Anwendungsimage fehlt.\n warning.non.standard.contents.sub.dir\u003dWarnung: Der Dateiname des Verzeichnisses \"{0}\", das fr die Option --app-content angegeben wurde, ist kein Standardunterverzeichnisname im Verzeichnis \"Contents\" des Anwendungs-Bundles. Mglicherweise verluft die Codesignierung und/oder Notarisierung im Ergebnisanwendungs-Bundle nicht erfolgreich.\ndiff --git a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_ja.properties b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_ja.properties\nindex d3150a34a..ba2497d30 100644\n--- a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_ja.properties\n+++ b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_ja.properties\n@@ -1,5 +1,5 @@\n #\n-# Copyright (c) 2017, 2025, Oracle and/or its affiliates. All rights reserved.\n+# Copyright (c) 2017, 2026, Oracle and/or its affiliates. All rights reserved.\n # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n #\n # This code is free software; you can redistribute it and/or modify it\n@@ -71,6 +71,11 @@ message.signing.pkg\u003d: PKG\n message.setfile.dmg\u003d\u0027SetFile\u0027DMGXcode\n message.codesign.failed.reason.app.content\u003d\"codesign\"\"--app-content\"\"--app-content\"\n message.codesign.failed.reason.xcode.tools\u003d\"codesign\"XcodeXcode\n+message.dmg.license.button.agree\u003d\n+message.dmg.license.button.disagree\u003d\n+message.dmg.license.button.print\u003d\n+message.dmg.license.button.save\u003d...\n+message.dmg.license.message\u003d\n warning.unsigned.app.image\u003d: app-image{0}\n warning.per.user.app.image.signed\u003d: \"{0}\"\n warning.non.standard.contents.sub.dir\u003d: --app-content\"{0}\"\"Contents\"/\ndiff --git a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_zh_CN.properties b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_zh_CN.properties\nindex 8ca2219b7..f855a31ca 100644\n--- a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_zh_CN.properties\n+++ b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/MacResources_zh_CN.properties\n@@ -1,5 +1,5 @@\n #\n-# Copyright (c) 2017, 2025, Oracle and/or its affiliates. All rights reserved.\n+# Copyright (c) 2017, 2026, Oracle and/or its affiliates. All rights reserved.\n # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n #\n # This code is free software; you can redistribute it and/or modify it\n@@ -71,6 +71,11 @@ message.signing.pkg\u003d PKG \n message.setfile.dmg\u003d \u0027SetFile\u0027  DMG  Xcode \n message.codesign.failed.reason.app.content\u003d\"codesign\"  \"--app-content\"  \"--app-content\" \n message.codesign.failed.reason.xcode.tools\u003d\"codesign\"  Xcode Xcode\n+message.dmg.license.button.agree\u003d\n+message.dmg.license.button.disagree\u003d\n+message.dmg.license.button.print\u003d\n+message.dmg.license.button.save\u003d...\n+message.dmg.license.message\u003d\n warning.unsigned.app.image\u003d app-image  {0}\n warning.per.user.app.image.signed\u003d \"{0}\"\n warning.non.standard.contents.sub.dir\u003d --app-content  \"{0}\"  \"Contents\" /\ndiff --git a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/lic_template.plist b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/lic_template.plist\nindex 072e7168f..ac1b32325 100644\n--- a/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/lic_template.plist\n+++ b/src/jdk.jpackage/macosx/classes/jdk/jpackage/internal/resources/lic_template.plist\n@@ -8,7 +8,9 @@\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n \t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAAAAgAAAAAAAAAAAAQAAA\u003d\u003d\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tAAAABAAAAAAAAAADAAEAAAAOAAIAAQA0AAMAAQ\u003d\u003d\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n \t\t\t\u003cstring\u003e5000\u003c/string\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n@@ -21,17 +23,22 @@\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n \t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYPRW5nbGlzaCBkZWZhdWx0BUFncmVlCERpc2FncmVlBVByaW50B1NhdmUuLi56SWYgeW91IGFncmVlIHdpdGggdGhlIHRlcm1zIG9mIHRoaXMgbGljZW5zZSwgY2xpY2sgIkFncmVlIiB0byBhY2Nlc3MgdGhlIHNvZnR3YXJlLiAgSWYgeW91IGRvIG5vdCBhZ3JlZSwgcHJlc3MgIkRpc2FncmVlLiI\u003d\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tSTR_DATA_ENGLISH\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n \t\t\t\u003cstring\u003e5000\u003c/string\u003e\n+\t\t\t\u003c!-- Note: Values if \"Name\" keys should not be localized for all languages. It is internal use only. --\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eEnglish buttons\u003c/string\u003e\n+\t\t\t\u003cstring\u003eEnglish (United States)\u003c/string\u003e\n \t\t\u003c/dict\u003e\n \t\t\u003cdict\u003e\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n \t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYHRGV1dHNjaAtBa3plcHRpZXJlbghBYmxlaG5lbgdEcnVja2VuClNpY2hlcm4uLi7nS2xpY2tlbiBTaWUgaW4g0kFremVwdGllcmVu0ywgd2VubiBTaWUgbWl0IGRlbiBCZXN0aW1tdW5nZW4gZGVzIFNvZnR3YXJlLUxpemVuenZlcnRyYWdzIGVpbnZlcnN0YW5kZW4gc2luZC4gRmFsbHMgbmljaHQsIGJpdHRlINJBYmxlaG5lbtMgYW5rbGlja2VuLiBTaWUga5pubmVuIGRpZSBTb2Z0d2FyZSBudXIgaW5zdGFsbGllcmVuLCB3ZW5uIFNpZSDSQWt6ZXB0aWVyZW7TIGFuZ2VrbGlja3QgaGFiZW4u\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tSTR_DATA_GERMAN\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n \t\t\t\u003cstring\u003e5001\u003c/string\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n@@ -41,151 +48,25 @@\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n \t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYHRW5nbGlzaAVBZ3JlZQhEaXNhZ3JlZQVQcmludAdTYXZlLi4ue0lmIHlvdSBhZ3JlZSB3aXRoIHRoZSB0ZXJtcyBvZiB0aGlzIGxpY2Vuc2UsIHByZXNzICJBZ3JlZSIgdG8gaW5zdGFsbCB0aGUgc29mdHdhcmUuICBJZiB5b3UgZG8gbm90IGFncmVlLCBwcmVzcyAiRGlzYWdyZWUiLg\u003d\u003d\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tSTR_DATA_JAPANESE\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n \t\t\t\u003cstring\u003e5002\u003c/string\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eEnglish\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYHRXNwYZZvbAdBY2VwdGFyCk5vIGFjZXB0YXIISW1wcmltaXIKR3VhcmRhci4uLsBTaSBlc3SHIGRlIGFjdWVyZG8gY29uIGxvcyB0jnJtaW5vcyBkZSBlc3RhIGxpY2VuY2lhLCBwdWxzZSAiQWNlcHRhciIgcGFyYSBpbnN0YWxhciBlbCBzb2Z0d2FyZS4gRW4gZWwgc3VwdWVzdG8gZGUgcXVlIG5vIGVzdI4gZGUgYWN1ZXJkbyBjb24gbG9zIHSOcm1pbm9zIGRlIGVzdGEgbGljZW5jaWEsIHB1bHNlICJObyBhY2VwdGFyLiI\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5003\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eSpanish\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYIRnJhbo1haXMIQWNjZXB0ZXIHUmVmdXNlcghJbXByaW1lcg5FbnJlZ2lzdHJlci4uLrpTaSB2b3VzIGFjY2VwdGV6IGxlcyB0ZXJtZXMgZGUgbGEgcHKOc2VudGUgbGljZW5jZSwgY2xpcXVleiBzdXIgIkFjY2VwdGVyIiBhZmluIGQnaW5zdGFsbGVyIGxlIGxvZ2ljaWVsLiBTaSB2b3VzIG4nkHRlcyBwYXMgZCdhY2NvcmQgYXZlYyBsZXMgdGVybWVzIGRlIGxhIGxpY2VuY2UsIGNsaXF1ZXogc3VyICJSZWZ1c2VyIi4\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5004\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eFrench\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYISXRhbGlhbm8HQWNjZXR0bwdSaWZpdXRvBlN0YW1wYQtSZWdpc3RyYS4uLn9TZSBhY2NldHRpIGxlIGNvbmRpemlvbmkgZGkgcXVlc3RhIGxpY2VuemEsIGZhaSBjbGljIHN1ICJBY2NldHRvIiBwZXIgaW5zdGFsbGFyZSBpbCBzb2Z0d2FyZS4gQWx0cmltZW50aSBmYWkgY2xpYyBzdSAiUmlmaXV0byIu\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5005\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eItalian\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYISmFwYW5lc2UKk6+I04K1gtyCtwyTr4jTgrWC3IK5gvEIiPON/IK3gukHlduRti4uLrSWe4Ncg3SDZ4NFg0eDQY5nl3CLlpH4jF+W8YLMj/CMj4LJk6+I04KzguqC6Y/qjYeCyYLNgUGDXIN0g2eDRYNHg0GC8INDg5ODWINngVuDi4K3gumCvYLfgsmBdZOviNOCtYLcgreBdoLwiZ+CtYLEgq2CvoKzgqKBQoFAk6+I04KzguqCyIKij+qNh4LJgs2BQYF1k6+I04K1gtyCuYLxgXaC8ImfgrWCxIKtgr6Cs4KigUI\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5006\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n \t\t\t\u003cstring\u003eJapanese\u003c/string\u003e\n \t\t\u003c/dict\u003e\n \t\t\u003cdict\u003e\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n \t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYKTmVkZXJsYW5kcwJKYQNOZWUFUHJpbnQJQmV3YWFyLi4upEluZGllbiB1IGFra29vcmQgZ2FhdCBtZXQgZGUgdm9vcndhYXJkZW4gdmFuIGRlemUgbGljZW50aWUsIGt1bnQgdSBvcCAnSmEnIGtsaWtrZW4gb20gZGUgcHJvZ3JhbW1hdHV1ciB0ZSBpbnN0YWxsZXJlbi4gSW5kaWVuIHUgbmlldCBha2tvb3JkIGdhYXQsIGtsaWt0IHUgb3AgJ05lZScu\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5007\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eDutch\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYGU3ZlbnNrCEdvZGuKbm5zBkF2YppqcwhTa3JpdiB1dAhTcGFyYS4uLpNPbSBEdSBnb2Rrim5uZXIgbGljZW5zdmlsbGtvcmVuIGtsaWNrYSBwjCAiR29ka4pubnMiIGaaciBhdHQgaW5zdGFsbGVyYSBwcm9ncmFtcHJvZHVrdGVuLiBPbSBEdSBpbnRlIGdvZGuKbm5lciBsaWNlbnN2aWxsa29yZW4sIGtsaWNrYSBwjCAiQXZimmpzIi4\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5008\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eSwedish\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYRUG9ydHVndZBzLCBCcmFzaWwJQ29uY29yZGFyCURpc2NvcmRhcghJbXByaW1pcglTYWx2YXIuLi6MU2UgZXN0hyBkZSBhY29yZG8gY29tIG9zIHRlcm1vcyBkZXN0YSBsaWNlbo1hLCBwcmVzc2lvbmUgIkNvbmNvcmRhciIgcGFyYSBpbnN0YWxhciBvIHNvZnR3YXJlLiBTZSBui28gZXN0hyBkZSBhY29yZG8sIHByZXNzaW9uZSAiRGlzY29yZGFyIi4\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5009\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eBrazilian Portuguese\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYSU2ltcGxpZmllZCBDaGluZXNlBM2s0uIGsrvNrNLiBLTy06EGtOa0oqGtVMjnufvE+s2s0uKxvtDtv8nQrdLptcTM9b/uo6zH67C0obDNrNLiobHAtLCy17C0y8jtvP6ho8jnufvE+rK7zazS4qOsx+uwtKGwsrvNrNLiobGhow\u003d\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5010\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eSimplified Chinese\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYTVHJhZGl0aW9uYWwgQ2hpbmVzZQSmULdOBqSjplC3TgSmQ6ZMBsB4pnOhS1CmcKpHsXqmULdOpbuzXKVpw9K4zKq6sfi02qFBvdCr9qGnplC3TqGopUimd7jLs27F6aFDpnCqR6SjplC3TqFBvdCr9qGnpKOmULdOoaihQw\u003d\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5011\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eTraditional Chinese\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYFRGFuc2sERW5pZwVVZW5pZwdVZHNrcml2CkFya2l2ZXIuLi6YSHZpcyBkdSBhY2NlcHRlcmVyIGJldGluZ2Vsc2VybmUgaSBsaWNlbnNhZnRhbGVuLCBza2FsIGR1IGtsaWtrZSBwjCDSRW5pZ9MgZm9yIGF0IGluc3RhbGxlcmUgc29mdHdhcmVuLiBLbGlrIHCMINJVZW5pZ9MgZm9yIGF0IGFubnVsbGVyZSBpbnN0YWxsZXJpbmdlbi4\u003d\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tSTR_DATA_SIMPLIFIED_CHINESE\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5012\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eDanish\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYFU3VvbWkISHl2imtzeW4KRW4gaHl2imtzeQdUdWxvc3RhCVRhbGxlbm5hyW9IeXaKa3N5IGxpc2Vuc3Npc29waW11a3NlbiBlaGRvdCBvc29pdHRhbWFsbGEg1Uh5doprc3nVLiBKb3MgZXQgaHl2imtzeSBzb3BpbXVrc2VuIGVodG9qYSwgb3NvaXRhINVFbiBoeXaKa3N51S4\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5013\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eFinnish\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYRRnJhbo1haXMgY2FuYWRpZW4IQWNjZXB0ZXIHUmVmdXNlcghJbXByaW1lcg5FbnJlZ2lzdHJlci4uLrpTaSB2b3VzIGFjY2VwdGV6IGxlcyB0ZXJtZXMgZGUgbGEgcHKOc2VudGUgbGljZW5jZSwgY2xpcXVleiBzdXIgIkFjY2VwdGVyIiBhZmluIGQnaW5zdGFsbGVyIGxlIGxvZ2ljaWVsLiBTaSB2b3VzIG4nkHRlcyBwYXMgZCdhY2NvcmQgYXZlYyBsZXMgdGVybWVzIGRlIGxhIGxpY2VuY2UsIGNsaXF1ZXogc3VyICJSZWZ1c2VyIi4\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5014\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eFrench Canadian\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYGS29yZWFuBLW/wMcJtb/AxyC+yMfUBsfBuLDGrgfA+sDlLi4ufrvnv+sgsOi+4LytwMcgs7u/67+hILW/wMfHz7jpLCAitb/AxyIgtNzD37imILStt68gvNLHwcauv/6+7rimILyzxKHHz73KvcO/wC4gtb/Ax8fPwfYgvsq0wrTZuOksICK1v8DHIL7Ix9QiILTcw9+4piC0qbijvcq9w7/ALg\u003d\u003d\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5015\u003c/string\u003e\n-\t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eKorean\u003c/string\u003e\n-\t\t\u003c/dict\u003e\n-\t\t\u003cdict\u003e\n-\t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n-\t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAYFTm9yc2sERW5pZwlJa2tlIGVuaWcIU2tyaXYgdXQKQXJraXZlci4uLqNIdmlzIERlIGVyIGVuaWcgaSBiZXN0ZW1tZWxzZW5lIGkgZGVubmUgbGlzZW5zYXZ0YWxlbiwga2xpa2tlciBEZSBwjCAiRW5pZyIta25hcHBlbiBmb3IgjCBpbnN0YWxsZXJlIHByb2dyYW12YXJlbi4gSHZpcyBEZSBpa2tlIGVyIGVuaWcsIGtsaWtrZXIgRGUgcIwgIklra2UgZW5pZyIu\u003c/data\u003e\n-\t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5016\u003c/string\u003e\n+\t\t\t\u003cstring\u003e5003\u003c/string\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eNorwegian\u003c/string\u003e\n+\t\t\t\u003cstring\u003eChinese (Simplified)\u003c/string\u003e\n \t\t\u003c/dict\u003e\n \t\u003c/array\u003e\n \t\u003ckey\u003eTEXT\u003c/key\u003e\n@@ -194,50 +75,49 @@\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n \t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAPPLICATION_LICENSE_TEXT\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tAPPLICATION_LICENSE_TEXT\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n \t\t\t\u003cstring\u003e5000\u003c/string\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eEnglish SLA\u003c/string\u003e\n+\t\t\t\u003cstring\u003eEnglish (United States) SLA\u003c/string\u003e\n \t\t\u003c/dict\u003e\n-\t\u003c/array\u003e\n-\t\u003ckey\u003eTMPL\u003c/key\u003e\n-\t\u003carray\u003e\n-\t\t\u003cdict\u003e\n+\t\t\t\t\u003cdict\u003e\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n \t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eE0RlZmF1bHQgTGFuZ3VhZ2UgSUREV1JEBUNvdW50T0NOVAQqKioqTFNUQwtzeXMgbGFuZyBJRERXUkQebG9jYWwgcmVzIElEIChvZmZzZXQgZnJvbSA1MDAwRFdSRBAyLWJ5dGUgbGFuZ3VhZ2U/RFdSRAQqKioqTFNURQ\u003d\u003d\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tAPPLICATION_LICENSE_TEXT\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e128\u003c/string\u003e\n+\t\t\t\u003cstring\u003e5001\u003c/string\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eLPic\u003c/string\u003e\n+\t\t\t\u003cstring\u003eGerman SLA\u003c/string\u003e\n \t\t\u003c/dict\u003e\n-\t\u003c/array\u003e\n-\t\u003ckey\u003eplst\u003c/key\u003e\n-\t\u003carray\u003e\n \t\t\u003cdict\u003e\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0x0050\u003c/string\u003e\n+\t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tAPPLICATION_LICENSE_TEXT\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e0\u003c/string\u003e\n+\t\t\t\u003cstring\u003e5002\u003c/string\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003e\u003c/string\u003e\n+\t\t\t\u003cstring\u003eJapanese SLA\u003c/string\u003e\n \t\t\u003c/dict\u003e\n-\t\u003c/array\u003e\n-\t\u003ckey\u003estyl\u003c/key\u003e\n-\t\u003carray\u003e\n \t\t\u003cdict\u003e\n \t\t\t\u003ckey\u003eAttributes\u003c/key\u003e\n \t\t\t\u003cstring\u003e0x0000\u003c/string\u003e\n \t\t\t\u003ckey\u003eData\u003c/key\u003e\n-\t\t\t\u003cdata\u003eAAMAAAAAAAwACQAUAAAAAAAAAAAAAAAAACcADAAJABQBAAAAAAAAAAAAAAAAKgAMAAkAFAAAAAAAAAAAAAA\u003d\u003c/data\u003e\n+\t\t\t\u003cdata\u003e\n+\t\t\tAPPLICATION_LICENSE_TEXT\n+\t\t\t\u003c/data\u003e\n \t\t\t\u003ckey\u003eID\u003c/key\u003e\n-\t\t\t\u003cstring\u003e5000\u003c/string\u003e\n+\t\t\t\u003cstring\u003e5003\u003c/string\u003e\n \t\t\t\u003ckey\u003eName\u003c/key\u003e\n-\t\t\t\u003cstring\u003eEnglish SLA\u003c/string\u003e\n+\t\t\t\u003cstring\u003eChinese (Simplified) SLA\u003c/string\u003e\n \t\t\u003c/dict\u003e\n \t\u003c/array\u003e\n \u003c/dict\u003e\ndiff --git a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\nindex b508d4f5f..1ae678cd9 100644\n--- a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\n+++ b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\n@@ -183,12 +183,12 @@ public Charset charset() {\n         return commandOutputControl.charset();\n     }\n \n-    Executor storeOutputInFiles(boolean v) {\n+    public Executor storeOutputInFiles(boolean v) {\n         commandOutputControl.storeOutputInFiles(v);\n         return this;\n     }\n \n-    Executor storeOutputInFiles() {\n+    public Executor storeOutputInFiles() {\n         return storeOutputInFiles(true);\n     }\n \ndiff --git a/test/jdk/tools/jpackage/share/LicenseTest.java b/test/jdk/tools/jpackage/share/LicenseTest.java\nindex 1c6bfd51b..9c2d10775 100644\n--- a/test/jdk/tools/jpackage/share/LicenseTest.java\n+++ b/test/jdk/tools/jpackage/share/LicenseTest.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2018, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -56,6 +56,9 @@\n  *\n  * Mac:\n  *\n+ * For DMG license should be displayed on command line when \"hdiutil attach\"\n+ * is called.\n+ *\n  * Windows\n  *\n  * Installer should display license text matching contents of the license file\n@@ -96,6 +99,7 @@ public static void testCommon() {\n                     LICENSE_FILE));\n         });\n \n+        initMacDmgLicenseVerifier(test.forTypes(PackageType.MAC_DMG));\n         initLinuxLicenseVerifier(test.forTypes(PackageType.LINUX));\n \n         test.run();\n@@ -131,6 +135,33 @@ public static void testCustomDebianCopyrightSubst() {\n         new CustomDebianCopyrightTest().withSubstitution(true).run();\n     }\n \n+    private static PackageTest initMacDmgLicenseVerifier(PackageTest test) {\n+        return test\n+        .addBundleVerifier(cmd -\u003e {\n+            verifyLicenseFileInDMGPackage(cmd);\n+        });\n+    }\n+\n+    private static void verifyLicenseFileInDMGPackage(JPackageCommand cmd)\n+            throws IOException {\n+        // DMG should have license, so attach with \"no\", since we only need license.\n+        // With \"no\" attach will be canceled.\n+        final var attachExec \u003d Executor.of(\"sh\", \"-c\", String.join(\" \",\n+                \"no\",\n+                \"|\",\n+                \"/usr/bin/hdiutil\",\n+                \"attach\",\n+                JPackageCommand.escapeAndJoin(cmd.outputBundle().toString())\n+        )).saveOutput().storeOutputInFiles();\n+\n+        // Expected exit code is 1, since we canceling license.\n+        final var attachResult \u003d attachExec.executeAndRepeatUntilExitCode(1, 10, 6);\n+        TKit.assertStringListEquals(Files.readAllLines(LICENSE_FILE),\n+                attachResult.stdout(), String.format(\n+                \"Check output of \\\"hdiutil attach\\\" has the same license as contents of source license file [%s]\",\n+                LICENSE_FILE));\n+    }\n+\n     private static PackageTest initLinuxLicenseVerifier(PackageTest test) {\n         return test\n         .addBundleVerifier(cmd -\u003e {","expectedMessage":"8374215: [macos] Clean and fix \"lic_template.plist\" to correctly work with multiple languages","repository":"jdk","commitHash":"499b58820225eb96c728816af9ea2ade47d1fc6b","metadata":{"author":"Alexander Matveev \u003calmatvee@openjdk.org\u003e"}}
{"id":"jdk-2b1e11c2","diff":" .../serviceability/jvmti/NMethodRelocation/NMethodRelocationTest.java  | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/test/hotspot/jtreg/serviceability/jvmti/NMethodRelocation/NMethodRelocationTest.java b/test/hotspot/jtreg/serviceability/jvmti/NMethodRelocation/NMethodRelocationTest.java\nindex 10888dce1..5b4a1c7e6 100644\n--- a/test/hotspot/jtreg/serviceability/jvmti/NMethodRelocation/NMethodRelocationTest.java\n+++ b/test/hotspot/jtreg/serviceability/jvmti/NMethodRelocation/NMethodRelocationTest.java\n@@ -29,7 +29,8 @@\n  *           vm.gc !\u003d \"Epsilon\" \u0026\n  *           vm.flavor \u003d\u003d \"server\" \u0026\n  *           !vm.emulatedClient \u0026\n- *           (vm.opt.TieredStopAtLevel \u003d\u003d null | vm.opt.TieredStopAtLevel \u003d\u003d 4)\n+ *           (vm.opt.TieredStopAtLevel \u003d\u003d null | vm.opt.TieredStopAtLevel \u003d\u003d 4) \u0026\n+ *           vm.compMode \u003d\u003d \"Xmixed\"\n  * @library /test/lib /test/hotspot/jtreg\n  * @build jdk.test.whitebox.WhiteBox\n  * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox","expectedMessage":"8374879: NMethodRelocationTest fails with -Xcomp after 8369150","repository":"jdk","commitHash":"2b1e11c2541f799142bd71e9526cbd04743c6f4e","metadata":{"author":"SendaoYan \u003csyan@openjdk.org\u003e"}}
{"id":"jdk-d8f45faf","diff":" test/jdk/java/net/httpclient/TimeoutResponseTestSupport.java | 8 +++++---\n 1 file changed, 5 insertions(+), 3 deletions(-)\n\ndiff --git a/test/jdk/java/net/httpclient/TimeoutResponseTestSupport.java b/test/jdk/java/net/httpclient/TimeoutResponseTestSupport.java\nindex 67b993eef..2d8ff05db 100644\n--- a/test/jdk/java/net/httpclient/TimeoutResponseTestSupport.java\n+++ b/test/jdk/java/net/httpclient/TimeoutResponseTestSupport.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -75,7 +75,8 @@ public class TimeoutResponseTestSupport {\n     private static final SSLContext SSL_CONTEXT \u003d SimpleSSLContext.findSSLContext();\n \n     protected static final Duration REQUEST_TIMEOUT \u003d\n-            Duration.ofMillis(Long.parseLong(System.getProperty(\"test.requestTimeoutMillis\")));\n+            Duration.ofMillis(jdk.test.lib.Utils.adjustTimeout(\n+                Long.parseLong(System.getProperty(\"test.requestTimeoutMillis\"))));\n \n     static {\n         assertTrue(\n@@ -87,7 +88,8 @@ public class TimeoutResponseTestSupport {\n             Integer.parseInt(System.getProperty(\"jdk.httpclient.redirects.retrylimit\", \"0\"));\n \n     private static final long RESPONSE_FAILURE_WAIT_DURATION_MILLIS \u003d\n-            Long.parseLong(System.getProperty(\"test.responseFailureWaitDurationMillis\", \"0\"));\n+            jdk.test.lib.Utils.adjustTimeout(\n+                Long.parseLong(System.getProperty(\"test.responseFailureWaitDurationMillis\", \"0\")));\n \n     static {\n         if (RETRY_LIMIT \u003e 0) {","expectedMessage":"8374432: TimeoutResponseBodyTest.java#retriesEnabledForResponseFailure fails run with -Xcomp","repository":"jdk","commitHash":"d8f45faf5849e66b8f0e35e1d18ed0331a0cb1c2","metadata":{"author":"SendaoYan \u003csyan@openjdk.org\u003e"}}
{"id":"jdk-fb526c8f","diff":" .../share/classes/jdk/jpackage/internal/LauncherFromOptions.java    | 6 +++---\n .../jdk/jpackage/internal/resources/MainResources.properties        | 1 +\n 2 files changed, 4 insertions(+), 3 deletions(-)\n\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/LauncherFromOptions.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/LauncherFromOptions.java\nindex ed030a4a7..9e81d144a 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/LauncherFromOptions.java\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/LauncherFromOptions.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -51,6 +51,7 @@\n import jdk.jpackage.internal.cli.Options;\n import jdk.jpackage.internal.cli.StandardFaOption;\n import jdk.jpackage.internal.model.CustomLauncherIcon;\n+import jdk.jpackage.internal.model.JPackageException;\n import jdk.jpackage.internal.model.DefaultLauncherIcon;\n import jdk.jpackage.internal.model.FileAssociation;\n import jdk.jpackage.internal.model.Launcher;\n@@ -130,8 +131,7 @@ Launcher create(Options options) {\n                         .advice(\"error.no-content-types-for-file-association.advice\", faID)\n                         .create();\n             } catch (FileAssociationNoExtensionsException ex) {\n-                // TODO: Must do something about this condition!\n-                throw new AssertionError();\n+                throw new JPackageException(I18N.format(\"error.no-extensions-for-file-association\", faID));\n             } catch (FileAssociationException ex) {\n                 // Should never happen\n                 throw new UnsupportedOperationException(ex);\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/resources/MainResources.properties b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/resources/MainResources.properties\nindex 07460a18f..e1f41e3ff 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/resources/MainResources.properties\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/resources/MainResources.properties\n@@ -93,6 +93,7 @@ error.properties-parameter-not-path\u003dThe value \"{0}\" provided for property \"{1}\"\n error.properties-parameter-not-file\u003dThe value \"{0}\" provided for property \"{1}\" in \"{2}\" file is not a file\n error.properties-parameter-not-launcher-shortcut-dir\u003dThe value \"{0}\" provided for property \"{1}\" in \"{2}\" file is not a valid shortcut startup directory\n \n+error.no-extensions-for-file-association\u003dNo extensions were specified for File Association number {0}\n error.no-content-types-for-file-association\u003dNo MIME types were specified for File Association number {0}\n error.no-content-types-for-file-association.advice\u003dSpecify MIME type for File Association number {0}\n error.too-many-content-types-for-file-association\u003dMore than one MIME types was specified for File Association number {0}","expectedMessage":"8373001: LauncherFromOptions.create() not properly handling FileAssociationNoExtensionsException","repository":"jdk","commitHash":"fb526c8f45de6ca9a57608f728ac223cbca118be","metadata":{"author":"Alexey Semenyuk \u003casemenyuk@openjdk.org\u003e"}}
{"id":"jdk-a7507ffa","diff":" src/java.base/share/classes/java/lang/Integer.java | 4 +++-\n src/java.base/share/classes/java/lang/Long.java    | 4 +++-\n 2 files changed, 6 insertions(+), 2 deletions(-)\n\ndiff --git a/src/java.base/share/classes/java/lang/Integer.java b/src/java.base/share/classes/java/lang/Integer.java\nindex a9da1c324..85ca80735 100644\n--- a/src/java.base/share/classes/java/lang/Integer.java\n+++ b/src/java.base/share/classes/java/lang/Integer.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1994, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1994, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -1448,6 +1448,7 @@ public static long toUnsignedLong(int x) {\n      * @param divisor the value doing the dividing\n      * @return the unsigned quotient of the first argument divided by\n      * the second argument\n+     * @throws ArithmeticException if the divisor is zero\n      * @see #remainderUnsigned\n      * @since 1.8\n      */\n@@ -1466,6 +1467,7 @@ public static int divideUnsigned(int dividend, int divisor) {\n      * @param divisor the value doing the dividing\n      * @return the unsigned remainder of the first argument divided by\n      * the second argument\n+     * @throws ArithmeticException if the divisor is zero\n      * @see #divideUnsigned\n      * @since 1.8\n      */\ndiff --git a/src/java.base/share/classes/java/lang/Long.java b/src/java.base/share/classes/java/lang/Long.java\nindex c5cd9650f..5fa1b8fc2 100644\n--- a/src/java.base/share/classes/java/lang/Long.java\n+++ b/src/java.base/share/classes/java/lang/Long.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1994, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1994, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -1411,6 +1411,7 @@ public static int compareUnsigned(long x, long y) {\n      * @param divisor the value doing the dividing\n      * @return the unsigned quotient of the first argument divided by\n      * the second argument\n+     * @throws ArithmeticException if the divisor is zero\n      * @see #remainderUnsigned\n      * @since 1.8\n      */\n@@ -1434,6 +1435,7 @@ public static long divideUnsigned(long dividend, long divisor) {\n      * @param divisor the value doing the dividing\n      * @return the unsigned remainder of the first argument divided by\n      * the second argument\n+     * @throws ArithmeticException if the divisor is zero\n      * @see #divideUnsigned\n      * @since 1.8\n      */","expectedMessage":"8375237: Document existing exceptional behavior of divideUnsigned and remainderUnsigned","repository":"jdk","commitHash":"a7507ffa1dda403110a61c4b61143b76e8a7911e","metadata":{"author":"Joe Darcy \u003cdarcy@openjdk.org\u003e"}}
{"id":"jdk-60fbaf5b","diff":" src/hotspot/share/code/aotCodeCache.cpp | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/src/hotspot/share/code/aotCodeCache.cpp b/src/hotspot/share/code/aotCodeCache.cpp\nindex 0314c5227..f51c068f1 100644\n--- a/src/hotspot/share/code/aotCodeCache.cpp\n+++ b/src/hotspot/share/code/aotCodeCache.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2023, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -1371,6 +1371,7 @@ void AOTCodeAddressTable::init_extrs() {\n   SET_ADDRESS(_extrs, ShenandoahRuntime::load_reference_barrier_phantom_narrow);\n #endif\n #if INCLUDE_ZGC\n+  SET_ADDRESS(_extrs, ZBarrierSetRuntime::load_barrier_on_oop_field_preloaded_addr());\n   SET_ADDRESS(_extrs, ZBarrierSetRuntime::load_barrier_on_phantom_oop_field_preloaded_addr());\n #if defined(AMD64)\n   SET_ADDRESS(_extrs, \u0026ZPointerLoadShift);","expectedMessage":"8374828: Save load_barrier_on_oop_field_preloaded in aot CodeCache","repository":"jdk","commitHash":"60fbaf5b26d7d359b1258898d4c4dfd86010b8a5","metadata":{"author":"Coleen Phillimore \u003ccoleenp@openjdk.org\u003e"}}
{"id":"jdk-56545328","diff":" src/hotspot/os/linux/gc/z/zPhysicalMemoryBacking_linux.cpp | 3 ---\n 1 file changed, 3 deletions(-)\n\ndiff --git a/src/hotspot/os/linux/gc/z/zPhysicalMemoryBacking_linux.cpp b/src/hotspot/os/linux/gc/z/zPhysicalMemoryBacking_linux.cpp\nindex 25ffd0b80..28159ae48 100644\n--- a/src/hotspot/os/linux/gc/z/zPhysicalMemoryBacking_linux.cpp\n+++ b/src/hotspot/os/linux/gc/z/zPhysicalMemoryBacking_linux.cpp\n@@ -66,9 +66,6 @@\n #endif\n \n // open(2) flags\n-#ifndef O_CLOEXEC\n-#define O_CLOEXEC                        02000000\n-#endif\n #ifndef O_TMPFILE\n #define O_TMPFILE                        (020000000 | O_DIRECTORY)\n #endif","expectedMessage":"8375297: ZGC: Remove obsolete O_CLOEXEC definition","repository":"jdk","commitHash":"56545328f849c3ebf062e3ff601224084fa3b46e","metadata":{"author":"Jonas Norlinder \u003cjnorlinder@openjdk.org\u003e"}}
{"id":"jdk-703665c1","diff":" .../classes/jdk/jpackage/internal/Executor.java    |  16 +-\n .../classes/jdk/jpackage/internal/cli/Main.java    |  62 ++++---\n .../jdk/jpackage/internal/cli/StandardOption.java  |   3 +\n .../classes/jdk/jpackage/internal/cli/Utils.java   |   4 +-\n .../ExecutableAttributesWithCapturedOutput.java    |  53 ++++++\n .../jpackage/internal/model/JPackageException.java |   3 +-\n .../internal/model/SelfContainedException.java     |  42 +++++\n .../internal/resources/MainResources.properties    |   5 +\n .../internal/util/CommandOutputControl.java        |  83 +++++++---\n .../helpers/jdk/jpackage/test/Executor.java        |  15 +-\n .../jdk/jpackage/test/mock/CommandActionSpecs.java |   7 +\n .../jdk/jpackage/internal/cli/MainTest.java        | 180 ++++++++++++++++++++-\n .../internal/util/CommandOutputControlTest.java    |  39 +++--\n 13 files changed, 439 insertions(+), 73 deletions(-)\n\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/Executor.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/Executor.java\nindex ca7a630b6..53c587ab3 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/Executor.java\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/Executor.java\n@@ -41,6 +41,7 @@\n import java.util.function.UnaryOperator;\n import java.util.spi.ToolProvider;\n import java.util.stream.Stream;\n+import jdk.jpackage.internal.model.ExecutableAttributesWithCapturedOutput;\n import jdk.jpackage.internal.util.CommandLineFormat;\n import jdk.jpackage.internal.util.CommandOutputControl;\n import jdk.jpackage.internal.util.CommandOutputControl.ProcessAttributes;\n@@ -211,17 +212,11 @@ Result execute() throws IOException {\n             throw new IllegalStateException(\"No target to execute\");\n         }\n \n-        PrintableOutputBuilder printableOutputBuilder;\n-        if (dumpOutput()) {\n-            printableOutputBuilder \u003d new PrintableOutputBuilder(coc);\n-        } else {\n-            printableOutputBuilder \u003d null;\n-        }\n-\n         if (dumpOutput()) {\n             Log.verbose(String.format(\"Running %s\", CommandLineFormat.DEFAULT.apply(List.of(commandLine().getFirst()))));\n         }\n \n+        var printableOutputBuilder \u003d new PrintableOutputBuilder(coc);\n         Result result;\n         try {\n             if (timeout \u003d\u003d null) {\n@@ -233,11 +228,12 @@ Result execute() throws IOException {\n             throw ExceptionBox.toUnchecked(ex);\n         }\n \n+        var printableOutput \u003d printableOutputBuilder.create();\n         if (dumpOutput()) {\n-            log(result, printableOutputBuilder.create());\n+            log(result, printableOutput);\n         }\n \n-        return result;\n+        return ExecutableAttributesWithCapturedOutput.augmentResultWithOutput(result, printableOutput);\n     }\n \n     Result executeExpectSuccess() throws IOException {\n@@ -309,7 +305,7 @@ private static void log(Result result, String printableOutput) throws IOExceptio\n         pid.ifPresent(p -\u003e {\n             sb.append(\" [PID: \").append(p).append(\"]\");\n         });\n-        sb.append(\":\\n    \").append(result.execAttrs());\n+        sb.append(\":\\n    \").append(result.execAttrs().printableCommandLine());\n         Log.verbose(sb.toString());\n \n         if (!printableOutput.isEmpty()) {\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/Main.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/Main.java\nindex 270ba0c92..562a0d2d3 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/Main.java\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/Main.java\n@@ -29,10 +29,12 @@\n import static jdk.jpackage.internal.cli.StandardOption.VERBOSE;\n import static jdk.jpackage.internal.cli.StandardOption.VERSION;\n \n+import java.io.BufferedReader;\n import java.io.FileNotFoundException;\n import java.io.IOException;\n import java.io.PrintStream;\n import java.io.PrintWriter;\n+import java.io.StringReader;\n import java.io.UncheckedIOException;\n import java.nio.file.NoSuchFileException;\n import java.util.Collection;\n@@ -48,7 +50,11 @@\n import jdk.jpackage.internal.Globals;\n import jdk.jpackage.internal.Log;\n import jdk.jpackage.internal.model.ConfigException;\n+import jdk.jpackage.internal.model.ExecutableAttributesWithCapturedOutput;\n import jdk.jpackage.internal.model.JPackageException;\n+import jdk.jpackage.internal.model.SelfContainedException;\n+import jdk.jpackage.internal.util.CommandOutputControl.UnexpectedExitCodeException;\n+import jdk.jpackage.internal.util.CommandOutputControl.UnexpectedResultException;\n import jdk.jpackage.internal.util.Slot;\n import jdk.jpackage.internal.util.function.ExceptionBox;\n \n@@ -239,44 +245,60 @@ void reportError(Throwable t) {\n                 reportError(ex.getCause());\n             } else if (t instanceof UncheckedIOException ex) {\n                 reportError(ex.getCause());\n+            } else if (t instanceof UnexpectedResultException ex) {\n+                printExternalCommandError(ex);\n             } else {\n                 printError(t, Optional.empty());\n             }\n         }\n \n+        private void printExternalCommandError(UnexpectedResultException ex) {\n+            var result \u003d ex.getResult();\n+            var commandOutput \u003d ((ExecutableAttributesWithCapturedOutput)result.execAttrs()).printableOutput();\n+            var printableCommandLine \u003d result.execAttrs().printableCommandLine();\n+\n+            if (verbose) {\n+                stackTracePrinter.accept(ex);\n+            }\n+\n+            String msg;\n+            if (ex instanceof UnexpectedExitCodeException) {\n+                msg \u003d I18N.format(\"error.command-failed-unexpected-exit-code\", result.getExitCode(), printableCommandLine);\n+            } else if (result.exitCode().isPresent()) {\n+                msg \u003d I18N.format(\"error.command-failed-unexpected-output\", printableCommandLine);\n+            } else {\n+                msg \u003d I18N.format(\"error.command-failed-timed-out\", printableCommandLine);\n+            }\n+\n+            messagePrinter.accept(I18N.format(\"message.error-header\", msg));\n+            if (!verbose) {\n+                messagePrinter.accept(I18N.format(\"message.failed-command-output-header\"));\n+                try (var lines \u003d new BufferedReader(new StringReader(commandOutput)).lines()) {\n+                    lines.forEach(messagePrinter);\n+                }\n+            }\n+        }\n+\n         private void printError(Throwable t, Optional\u003cString\u003e advice) {\n-            var isAlienException \u003d isAlienExceptionType(t);\n+            var isSelfContained \u003d isSelfContained(t);\n \n-            if (isAlienException || verbose) {\n+            if (!isSelfContained || verbose) {\n                 stackTracePrinter.accept(t);\n             }\n \n             String msg;\n-            if (isAlienException) {\n-                msg \u003d t.toString();\n-            } else {\n+            if (isSelfContained) {\n                 msg \u003d t.getMessage();\n+            } else {\n+                msg \u003d t.toString();\n             }\n \n             messagePrinter.accept(I18N.format(\"message.error-header\", msg));\n             advice.ifPresent(v -\u003e messagePrinter.accept(I18N.format(\"message.advice-header\", v)));\n         }\n \n-        private static boolean isAlienExceptionType(Throwable t) {\n-            switch (t) {\n-                case JPackageException _ -\u003e {\n-                    return false;\n-                }\n-                case Utils.ParseException _ -\u003e {\n-                    return false;\n-                }\n-                case StandardOption.AddLauncherIllegalArgumentException _ -\u003e {\n-                    return false;\n-                }\n-                default -\u003e {\n-                    return true;\n-                }\n-            }\n+        private static boolean isSelfContained(Throwable t) {\n+            return t.getClass().getAnnotation(SelfContainedException.class) !\u003d null;\n         }\n     }\n \ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/StandardOption.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/StandardOption.java\nindex 9c828705a..fadd9bacb 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/StandardOption.java\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/StandardOption.java\n@@ -61,6 +61,8 @@\n import jdk.jpackage.internal.model.JPackageException;\n import jdk.jpackage.internal.model.LauncherShortcut;\n import jdk.jpackage.internal.model.LauncherShortcutStartupDirectory;\n+import jdk.jpackage.internal.model.PackageType;\n+import jdk.jpackage.internal.model.SelfContainedException;\n import jdk.jpackage.internal.util.SetBuilder;\n \n /**\n@@ -701,6 +703,7 @@ private static String resourceKeySuffix(OperatingSystem os) {\n     }\n \n \n+    @SelfContainedException\n     static class AddLauncherIllegalArgumentException extends IllegalArgumentException {\n \n         AddLauncherIllegalArgumentException(String message) {\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/Utils.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/Utils.java\nindex 0565a8f12..a94de3552 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/Utils.java\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/cli/Utils.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -32,6 +32,7 @@\n import java.util.stream.Stream;\n import jdk.internal.util.OperatingSystem;\n import jdk.jpackage.internal.model.BundlingEnvironment;\n+import jdk.jpackage.internal.model.SelfContainedException;\n \n final class Utils {\n \n@@ -98,6 +99,7 @@ static JOptSimpleOptionsBuilder buildParser(OperatingSystem os, BundlingEnvironm\n                 });\n     }\n \n+    @SelfContainedException\n     static final class ParseException extends RuntimeException {\n \n         ParseException(String msg) {\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/ExecutableAttributesWithCapturedOutput.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/ExecutableAttributesWithCapturedOutput.java\nnew file mode 100644\nindex 000000000..faed9d24d\n--- /dev/null\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/ExecutableAttributesWithCapturedOutput.java\n@@ -0,0 +1,53 @@\n+/*\n+ * Copyright (c) 2026, Oracle and/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+\n+package jdk.jpackage.internal.model;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import jdk.jpackage.internal.util.CommandOutputControl.ExecutableAttributes;\n+import jdk.jpackage.internal.util.CommandOutputControl.Result;\n+\n+/**\n+ * {@link ExecutableAttributes} augmented with printable command output.\n+ */\n+public record ExecutableAttributesWithCapturedOutput(ExecutableAttributes execAttrs, String printableOutput)\n+        implements ExecutableAttributes {\n+\n+    public ExecutableAttributesWithCapturedOutput {\n+        Objects.requireNonNull(execAttrs);\n+        Objects.requireNonNull(printableOutput);\n+    }\n+\n+    @Override\n+    public List\u003cString\u003e commandLine() {\n+        return execAttrs.commandLine();\n+    }\n+\n+    public static Result augmentResultWithOutput(Result result, String output) {\n+        var execAttrs \u003d new ExecutableAttributesWithCapturedOutput(result.execAttrs(), output);\n+        return result.copyWithExecutableAttributes(execAttrs);\n+    }\n+}\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/JPackageException.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/JPackageException.java\nindex 9727f21d2..3d24d293f 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/JPackageException.java\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/JPackageException.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2012, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -30,6 +30,7 @@\n /**\n  * Generic jpackage exception with non-null message.\n  */\n+@SelfContainedException\n public class JPackageException extends RuntimeException {\n \n     public JPackageException(String msg) {\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/SelfContainedException.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/SelfContainedException.java\nnew file mode 100644\nindex 000000000..c7d1b3016\n--- /dev/null\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/model/SelfContainedException.java\n@@ -0,0 +1,42 @@\n+/*\n+ * Copyright (c) 2026, Oracle and/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+\n+package jdk.jpackage.internal.model;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Inherited;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+/**\n+ * Annotation for exceptions with self-contained error messages that don\u0027t\n+ * require an additional context, like exception class name or a stack trace.\n+ */\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target(ElementType.TYPE)\n+@Inherited\n+public @interface SelfContainedException {\n+}\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/resources/MainResources.properties b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/resources/MainResources.properties\nindex 588a37028..07460a18f 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/resources/MainResources.properties\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/resources/MainResources.properties\n@@ -55,6 +55,11 @@ message.module-version\u003dUsing version \"{0}\" from module \"{1}\" as application vers\n \n message.error-header\u003dError: {0}\n message.advice-header\u003dAdvice to fix: {0}\n+message.failed-command-output-header\u003dCommand output:\n+\n+error.command-failed-unexpected-output\u003dUnexpected output from executing the command {0}\n+error.command-failed-unexpected-exit-code\u003dUnexpected exit code {0} from executing the command {1}\n+error.command-failed-timed-out\u003dTimed-out command {0}\n \n error.version-string-empty\u003dVersion may not be empty string\n error.version-string-zero-length-component\u003dVersion [{0}] contains a zero length component\ndiff --git a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/util/CommandOutputControl.java b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/util/CommandOutputControl.java\nindex e35439815..00fbdd719 100644\n--- a/src/jdk.jpackage/share/classes/jdk/jpackage/internal/util/CommandOutputControl.java\n+++ b/src/jdk.jpackage/share/classes/jdk/jpackage/internal/util/CommandOutputControl.java\n@@ -796,6 +796,10 @@ public CommandOutputControl copy() {\n \n     public interface ExecutableAttributes {\n         List\u003cString\u003e commandLine();\n+\n+        default String printableCommandLine() {\n+            return CommandLineFormat.DEFAULT.apply(commandLine());\n+        }\n     }\n \n     public sealed interface Executable {\n@@ -812,11 +816,6 @@ public record ProcessAttributes(Optional\u003cLong\u003e pid, List\u003cString\u003e commandLine) im\n             Objects.requireNonNull(pid);\n             commandLine.forEach(Objects::requireNonNull);\n         }\n-\n-        @Override\n-        public String toString() {\n-            return CommandLineFormat.DEFAULT.apply(commandLine());\n-        }\n     }\n \n     public record ToolProviderAttributes(String name, List\u003cString\u003e args) implements ExecutableAttributes {\n@@ -825,11 +824,6 @@ public record ToolProviderAttributes(String name, List\u003cString\u003e args) implements\n             args.forEach(Objects::requireNonNull);\n         }\n \n-        @Override\n-        public String toString() {\n-            return CommandLineFormat.DEFAULT.apply(commandLine());\n-        }\n-\n         @Override\n         public List\u003cString\u003e commandLine() {\n             return Stream.concat(Stream.of(name), args.stream()).toList();\n@@ -837,14 +831,9 @@ public List\u003cString\u003e commandLine() {\n     }\n \n     public static ExecutableAttributes EMPTY_EXECUTABLE_ATTRIBUTES \u003d new ExecutableAttributes() {\n-        @Override\n-        public String toString() {\n-            return \"\u003cunknown\u003e\";\n-        }\n-\n         @Override\n         public List\u003cString\u003e commandLine() {\n-            return List.of();\n+            return List.of(\"\u003cunknown\u003e\");\n         }\n     };\n \n@@ -869,6 +858,51 @@ public record Result(\n             Objects.requireNonNull(execAttrs);\n         }\n \n+        public static Builder build() {\n+            return new Builder();\n+        }\n+\n+        public static final class Builder {\n+\n+            public Result create() {\n+                return new Result(\n+                        exitCode,\n+                        Optional.ofNullable(content).map(List::copyOf).map(StringListContent::new).map(c -\u003e {\n+                            return new CommandOutput\u003cList\u003cString\u003e\u003e(Optional.of(c), c.size(), true);\n+                        }),\n+                        Optional.empty(),\n+                        Optional.ofNullable(execAttrs).orElse(EMPTY_EXECUTABLE_ATTRIBUTES));\n+            }\n+\n+            public Builder exitCode(int v) {\n+                exitCode \u003d Optional.of(v);\n+                return this;\n+            }\n+\n+            public Builder noExitCode() {\n+                exitCode \u003d Optional.empty();\n+                return this;\n+            }\n+\n+            public Builder execAttrs(ExecutableAttributes v) {\n+                execAttrs \u003d v;\n+                return this;\n+            }\n+\n+            public Builder content(List\u003cString\u003e v) {\n+                content \u003d v;\n+                return this;\n+            }\n+\n+            public Builder content(String... v) {\n+                return content(List.of(v));\n+            }\n+\n+            private ExecutableAttributes execAttrs;\n+            private List\u003cString\u003e content;\n+            private Optional\u003cInteger\u003e exitCode \u003d Optional.empty();\n+        }\n+\n         public Result(int exitCode) {\n             this(Optional.of(exitCode), Optional.empty(), Optional.empty(), EMPTY_EXECUTABLE_ATTRIBUTES);\n         }\n@@ -1019,7 +1053,8 @@ private UnexpectedResultException(Result value, String message) {\n         }\n \n         private UnexpectedResultException(Result value) {\n-            this(value, String.format(\"Unexpected result from executing the command %s\", value.execAttrs()));\n+            this(value, String.format(\"Unexpected result from executing the command %s\",\n+                    value.execAttrs().printableCommandLine()));\n         }\n \n         public Result getResult() {\n@@ -1034,11 +1069,21 @@ public Result getResult() {\n     public static final class UnexpectedExitCodeException extends UnexpectedResultException {\n \n         public UnexpectedExitCodeException(Result value, String message) {\n-            super(value, message);\n+            super(requireExitCode(value), message);\n         }\n \n         public UnexpectedExitCodeException(Result value) {\n-            this(value, String.format(\"Unexpected exit code %d from executing the command %s\", value.getExitCode(), value.execAttrs()));\n+            this(value, String.format(\"Unexpected exit code %d from executing the command %s\",\n+                    requireExitCode(value).getExitCode(), value.execAttrs().printableCommandLine()));\n+        }\n+\n+        private static Result requireExitCode(Result v) {\n+            Objects.requireNonNull(v);\n+            if (v.exitCode().isPresent()) {\n+                return v;\n+            } else {\n+                throw new IllegalArgumentException();\n+            }\n         }\n \n         private static final long serialVersionUID \u003d 1L;\ndiff --git a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\nindex d4833eb97..b508d4f5f 100644\n--- a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\n+++ b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\n@@ -283,11 +283,11 @@ private Result assertExitCodeIs(List\u003cInteger\u003e expectedExitCodes) {\n                     long expectedExitCode \u003d expectedExitCodes.getFirst();\n                     TKit.assertEquals(expectedExitCode, getExitCode(), String.format(\n                             \"Check command %s exited with %d code\",\n-                            base.execAttrs(), expectedExitCode));\n+                            base.execAttrs().printableCommandLine(), expectedExitCode));\n                 } default -\u003e {\n                     TKit.assertTrue(expectedExitCodes.contains(getExitCode()), String.format(\n                             \"Check command %s exited with one of %s codes\",\n-                            base.execAttrs(), expectedExitCodes.stream().sorted().toList()));\n+                            base.execAttrs().printableCommandLine(), expectedExitCodes.stream().sorted().toList()));\n                 }\n             }\n             return this;\n@@ -302,7 +302,7 @@ public int getExitCode() {\n         }\n \n         public String getPrintableCommandLine() {\n-            return base.execAttrs().toString();\n+            return base.execAttrs().printableCommandLine();\n         }\n     }\n \n@@ -515,21 +515,16 @@ public String getPrintableCommandLine() {\n         return String.format(format, CommandLineFormat.DEFAULT.apply(cmdline), cmdline.size());\n     }\n \n-    private record ExecutableAttributes(CommandOutputControl.ExecutableAttributes base, String toStringValue)\n+    private record ExecutableAttributes(CommandOutputControl.ExecutableAttributes base, String printableCommandLine)\n             implements CommandOutputControl.ExecutableAttributes {\n \n         ExecutableAttributes {\n             Objects.requireNonNull(base);\n-            if (toStringValue.isBlank()) {\n+            if (printableCommandLine.isBlank()) {\n                 throw new IllegalArgumentException();\n             }\n         }\n \n-        @Override\n-        public String toString() {\n-            return toStringValue;\n-        }\n-\n         @Override\n         public List\u003cString\u003e commandLine() {\n             return base.commandLine();\ndiff --git a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/mock/CommandActionSpecs.java b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/mock/CommandActionSpecs.java\nindex e89e458c0..ce3aa6f80 100644\n--- a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/mock/CommandActionSpecs.java\n+++ b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/mock/CommandActionSpecs.java\n@@ -115,6 +115,13 @@ public Builder printToStderr(String... str) {\n             return printToStderr(List.of(str));\n         }\n \n+        public Builder argsListener(Consumer\u003cList\u003cString\u003e\u003e listener) {\n+            Objects.requireNonNull(listener);\n+            return action(CommandActionSpec.create(\"args-listener\", context -\u003e {\n+                listener.accept(context.args());\n+            }));\n+        }\n+\n         public Builder exit(int exitCode) {\n             return action(CommandActionSpec.create(String.format(\"exit(%d)\", exitCode), () -\u003e {\n                 return exitCode;\ndiff --git a/test/jdk/tools/jpackage/junit/share/jdk.jpackage/jdk/jpackage/internal/cli/MainTest.java b/test/jdk/tools/jpackage/junit/share/jdk.jpackage/jdk/jpackage/internal/cli/MainTest.java\nindex 365a8a50b..796482602 100644\n--- a/test/jdk/tools/jpackage/junit/share/jdk.jpackage/jdk/jpackage/internal/cli/MainTest.java\n+++ b/test/jdk/tools/jpackage/junit/share/jdk.jpackage/jdk/jpackage/internal/cli/MainTest.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -22,6 +22,7 @@\n  */\n package jdk.jpackage.internal.cli;\n \n+import static jdk.jpackage.internal.model.ExecutableAttributesWithCapturedOutput.augmentResultWithOutput;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertNotEquals;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n@@ -43,19 +44,31 @@\n import java.util.function.BiFunction;\n import java.util.function.Function;\n import java.util.function.UnaryOperator;\n+import java.util.spi.ToolProvider;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n import jdk.internal.util.OperatingSystem;\n+import jdk.jpackage.internal.Globals;\n+import jdk.jpackage.internal.MockUtils;\n import jdk.jpackage.internal.model.ConfigException;\n+import jdk.jpackage.internal.model.ExecutableAttributesWithCapturedOutput;\n import jdk.jpackage.internal.model.JPackageException;\n+import jdk.jpackage.internal.util.CommandOutputControl;\n+import jdk.jpackage.internal.util.CommandOutputControl.UnexpectedExitCodeException;\n+import jdk.jpackage.internal.util.CommandOutputControl.UnexpectedResultException;\n import jdk.jpackage.internal.util.function.ExceptionBox;\n+import jdk.jpackage.test.Annotations;\n+import jdk.jpackage.test.JPackageCommand;\n import jdk.jpackage.test.JUnitAdapter;\n import jdk.jpackage.test.TKit;\n+import jdk.jpackage.test.mock.CommandActionSpecs;\n+import jdk.jpackage.test.mock.Script;\n+import jdk.jpackage.test.mock.VerbatimCommandMock;\n import org.junit.jupiter.params.ParameterizedTest;\n import org.junit.jupiter.params.provider.MethodSource;\n import org.junit.jupiter.params.provider.ValueSource;\n \n-public class MainTest extends JUnitAdapter.TestSrcInitializer {\n+public class MainTest extends JUnitAdapter {\n \n     @ParameterizedTest\n     @MethodSource\n@@ -78,6 +91,71 @@ public void test_ErrorReporter_format(String key) {\n         assertNotEquals(str, msg);\n     }\n \n+    /**\n+     * Run app image packaging and simulate jlink failure.\n+     * \u003cp\u003e\n+     * The test verifies that jpackage prints an error message with jlink exit code,\n+     * command line, and output.\n+     */\n+    @Annotations.Test\n+    public void testFailedCommandOutput() {\n+\n+        var jlinkMockExitCode \u003d 17;\n+\n+        var jlinkArgs \u003d new ArrayList\u003cString\u003e();\n+\n+        var jlinkMock \u003d CommandActionSpecs.build()\n+                .stdout(\"It\").stderr(\"fell\").stdout(\"apart\")\n+                .argsListener(jlinkArgs::addAll)\n+                .exit(jlinkMockExitCode).create().toCommandMockBuilder().name(\"jlink-mock\").create();\n+\n+        var script \u003d Script.build()\n+                // Replace jlink with the mock.\n+                .map(Script.cmdlineStartsWith(\"jlink\"), jlinkMock)\n+                // Don\u0027t mock other external commands.\n+                .map(_ -\u003e true, VerbatimCommandMock.INSTANCE)\n+                .createLoop();\n+\n+        var jpackageExitCode \u003d 1;\n+\n+        var jpackageToolProviderMock \u003d new ToolProvider() {\n+            @Override\n+            public int run(PrintWriter out, PrintWriter err, String... args) {\n+                var globalsMutator \u003d MockUtils.buildJPackage().script(script).createGlobalsMutator();\n+                return Globals.main(() -\u003e {\n+                    globalsMutator.accept(Globals.instance());\n+\n+                    var result \u003d ExecutionResult.create(args);\n+\n+                    var jlinkMockAttrs \u003d new CommandOutputControl.ToolProviderAttributes(jlinkMock.name(), jlinkArgs);\n+\n+                    result.stdout().forEach(out::println);\n+                    result.stderr().forEach(err::println);\n+\n+                    assertEquals(jpackageExitCode, result.exitCode());\n+                    assertEquals(List.of(), result.stdout());\n+                    assertEquals(List.of(\n+                            I18N.format(\"message.error-header\", I18N.format(\"error.command-failed-unexpected-exit-code\",\n+                                    jlinkMockExitCode, jlinkMockAttrs.printableCommandLine())),\n+                            I18N.format(\"message.failed-command-output-header\"),\n+                            \"It\", \"fell\", \"apart\"), result.stderr());\n+\n+                    return jpackageExitCode;\n+                });\n+            }\n+\n+            @Override\n+            public String name() {\n+                return \"jpackage-mock\";\n+            }\n+        };\n+\n+        JPackageCommand.helloAppImage()\n+                .ignoreDefaultVerbose(true)\n+                .useToolProvider(jpackageToolProviderMock)\n+                .execute(jpackageExitCode);\n+    }\n+\n     private static Collection\u003cTestSpec\u003e testOutput() {\n         return Stream.of(\n                 // Print the tool version\n@@ -165,6 +243,49 @@ private static List\u003cErrorReporterTestSpec\u003e test_ErrorReporter() {\n                     data.add(new ErrorReporterTestSpec(cause, expect.getKey(), verbose, expectedOutput));\n                 }\n             }\n+\n+            var execAttrs \u003d new CommandOutputControl.ProcessAttributes(Optional.of(12345L), List.of(\"foo\", \"--bar\"));\n+            for (var makeCause : List.\u003cUnaryOperator\u003cException\u003e\u003eof(\n+                    ex -\u003e ex,\n+                    ExceptionBox::toUnchecked\n+            )) {\n+\n+                for (var expect : List.of(\n+                        Map.entry(\n+                                augmentResultWithOutput(\n+                                        CommandOutputControl.Result.build().exitCode(135).execAttrs(execAttrs).create(),\n+                                        \"The quick brown fox\\njumps over the lazy dog\"\n+                                ).unexpected(\"Kaput!\"),\n+                                ExceptionFormatter.FAILED_COMMAND_UNEXPECTED_OUTPUT_MESSAGE\n+                        ),\n+                        Map.entry(\n+                                new UnexpectedExitCodeException(augmentResultWithOutput(\n+                                        CommandOutputControl.Result.build().exitCode(135).create(),\n+                                        \"The quick brown fox\\njumps\"\n+                                )),\n+                                ExceptionFormatter.FAILED_COMMAND_UNEXPECTED_EXIT_CODE_MESSAGE\n+                        ),\n+                        Map.entry(\n+                                augmentResultWithOutput(\n+                                        CommandOutputControl.Result.build().create(),\n+                                        \"The quick brown fox\\njumps\"\n+                                ).unexpected(\"Timed out!\"),\n+                                ExceptionFormatter.FAILED_COMMAND_TIMEDOUT_MESSAGE\n+                        )\n+                )) {\n+                    var cause \u003d makeCause.apply(expect.getKey());\n+                    var expectedOutput \u003d new ArrayList\u003cExceptionFormatter\u003e();\n+                    if (verbose) {\n+                        expectedOutput.add(ExceptionFormatter.STACK_TRACE);\n+                    }\n+                    expectedOutput.add(expect.getValue());\n+                    if (!verbose) {\n+                        expectedOutput.add(ExceptionFormatter.FAILED_COMMAND_OUTPUT);\n+                    }\n+                    data.add(new ErrorReporterTestSpec(cause, expect.getKey(), verbose, expectedOutput));\n+                }\n+            }\n+\n         }\n \n         return data;\n@@ -350,7 +471,24 @@ private enum ExceptionFormatter {\n                 ex.printStackTrace(pw);\n             }\n             return sink.toString();\n-        })\n+        }),\n+        FAILED_COMMAND_OUTPUT(ex -\u003e {\n+            var result \u003d failedCommandResult(ex);\n+            var commandOutput \u003d ((ExecutableAttributesWithCapturedOutput)result.execAttrs()).printableOutput();\n+\n+            var sink \u003d new StringWriter();\n+            var pw \u003d new PrintWriter(sink);\n+\n+            pw.println(I18N.format(\"message.failed-command-output-header\"));\n+            try (var lines \u003d new BufferedReader(new StringReader(commandOutput)).lines()) {\n+                lines.forEach(pw::println);\n+            }\n+\n+            return sink.toString();\n+        }),\n+        FAILED_COMMAND_UNEXPECTED_OUTPUT_MESSAGE(errorMessage(CommandFailureType.UNEXPECTED_OUTPUT::getMessage)),\n+        FAILED_COMMAND_UNEXPECTED_EXIT_CODE_MESSAGE(errorMessage(CommandFailureType.UNEXPECTED_EXIT_CODE::getMessage)),\n+        FAILED_COMMAND_TIMEDOUT_MESSAGE(errorMessage(CommandFailureType.TIMEDOUT::getMessage)),\n         ;\n \n         ExceptionFormatter(Function\u003cException, String\u003e formatter) {\n@@ -369,6 +507,42 @@ private static Function\u003cException, String\u003e errorMessage(Function\u003cException, Stri\n             };\n         }\n \n+        private static CommandOutputControl.Result failedCommandResult(Exception ex) {\n+            Objects.requireNonNull(ex);\n+            if (ex instanceof UnexpectedResultException urex) {\n+                return urex.getResult();\n+            } else {\n+                throw new IllegalArgumentException();\n+            }\n+        }\n+\n+        private enum CommandFailureType {\n+            UNEXPECTED_OUTPUT,\n+            UNEXPECTED_EXIT_CODE,\n+            TIMEDOUT,\n+            ;\n+\n+            String getMessage(Exception ex) {\n+                var result \u003d failedCommandResult(ex);\n+                var printableCommandLine \u003d result.execAttrs().printableCommandLine();\n+                switch (this) {\n+                    case TIMEDOUT -\u003e {\n+                        return I18N.format(\"error.command-failed-timed-out\", printableCommandLine);\n+                    }\n+                    case UNEXPECTED_EXIT_CODE -\u003e {\n+                        return I18N.format(\"error.command-failed-unexpected-exit-code\", result.getExitCode(), printableCommandLine);\n+                    }\n+                    case UNEXPECTED_OUTPUT -\u003e {\n+                        return I18N.format(\"error.command-failed-unexpected-output\", printableCommandLine);\n+                    }\n+                    default -\u003e {\n+                        // Unreachable\n+                        throw ExceptionBox.reachedUnreachable();\n+                    }\n+                }\n+            }\n+        }\n+\n         private final Function\u003cException, String\u003e formatter;\n     }\n \ndiff --git a/test/jdk/tools/jpackage/junit/share/jdk.jpackage/jdk/jpackage/internal/util/CommandOutputControlTest.java b/test/jdk/tools/jpackage/junit/share/jdk.jpackage/jdk/jpackage/internal/util/CommandOutputControlTest.java\nindex f1d8c142e..d71cf7c4d 100644\n--- a/test/jdk/tools/jpackage/junit/share/jdk.jpackage/jdk/jpackage/internal/util/CommandOutputControlTest.java\n+++ b/test/jdk/tools/jpackage/junit/share/jdk.jpackage/jdk/jpackage/internal/util/CommandOutputControlTest.java\n@@ -203,11 +203,11 @@ public int run(PrintWriter out, PrintWriter err, String... args) {\n             exec \u003d coc.createExecutable(new ProcessBuilder(\"runme\", \"--foo\", \"--baz\u003d10\"));\n         }\n \n-        assertEquals(\"runme --foo --baz\u003d10\", exec.attributes().toString());\n+        assertEquals(\"runme --foo --baz\u003d10\", exec.attributes().printableCommandLine());\n     }\n \n     @Test\n-    public void test_Result_no_args_ctor() {\n+    public void test_Result_single_arg_ctor() {\n         var result \u003d new CommandOutputControl.Result(7);\n         assertFalse(result.findContent().isPresent());\n         assertFalse(result.findStdout().isPresent());\n@@ -216,6 +216,18 @@ public void test_Result_no_args_ctor() {\n         assertSame(Objects.requireNonNull(CommandOutputControl.EMPTY_EXECUTABLE_ATTRIBUTES), result.execAttrs());\n     }\n \n+    @ParameterizedTest\n+    @ValueSource(booleans \u003d {true, false})\n+    public void test_Result_unexpected(boolean customMessage) throws IOException {\n+        var result \u003d new CommandOutputControl.Result(7);\n+\n+        if (customMessage) {\n+            assertEquals(\"Kaput!\", result.unexpected(\"Kaput!\").getMessage());\n+        } else {\n+            assertEquals(\"Unexpected result from executing the command \u003cunknown\u003e\", result.unexpected().getMessage());\n+        }\n+    }\n+\n     @Test\n     public void test_Result_expectExitCode() throws IOException {\n         var result \u003d new CommandOutputControl.Result(7);\n@@ -276,14 +288,9 @@ public void test_Result_toCharacterResult_copyWithExecutableAttributes() {\n         var empty \u003d new CommandOutputControl.Result(0);\n \n         var execAttrs \u003d new CommandOutputControl.ExecutableAttributes() {\n-            @Override\n-            public String toString() {\n-                return \"foo\";\n-            }\n-\n             @Override\n             public List\u003cString\u003e commandLine() {\n-                return List.of();\n+                return List.of(\"foo\");\n             }\n         };\n \n@@ -295,6 +302,20 @@ public List\u003cString\u003e commandLine() {\n         assertSame(execAttrs, copy.execAttrs());\n     }\n \n+    @Test\n+    public void test_UnexpectedExitCodeException_no_exit_code() {\n+\n+        var resultWithoutExitCode \u003d CommandOutputControl.Result.build().create();\n+\n+        assertThrowsExactly(IllegalArgumentException.class, () -\u003e {\n+            new CommandOutputControl.UnexpectedExitCodeException(resultWithoutExitCode);\n+        });\n+\n+        assertThrowsExactly(IllegalArgumentException.class, () -\u003e {\n+            new CommandOutputControl.UnexpectedExitCodeException(resultWithoutExitCode, \"Kaput!\");\n+        });\n+    }\n+\n     @ParameterizedTest\n     @EnumSource(ExecutableType.class)\n     public void test_timeout_expires(ExecutableType mode) throws InterruptedException, IOException {\n@@ -1781,7 +1802,7 @@ public void mutate(CommandOutputControl coc) {\n         }\n     }\n \n-    private final static class InterruptibleToolProvider implements ToolProvider {\n+    private static final class InterruptibleToolProvider implements ToolProvider {\n \n         InterruptibleToolProvider(ToolProvider impl) {\n             this.impl \u003d impl;","expectedMessage":"8356684: jpackage error messages are not helpful","repository":"jdk","commitHash":"703665c13f754f3ba7858c4bb2549c76cbc22a62","metadata":{"author":"Alexey Semenyuk \u003casemenyuk@openjdk.org\u003e"}}
{"id":"jdk-1b6c2bdd","diff":" src/hotspot/share/opto/phaseX.cpp | 46 ++++++++++++++++++++++++---------------\n 1 file changed, 28 insertions(+), 18 deletions(-)\n\ndiff --git a/src/hotspot/share/opto/phaseX.cpp b/src/hotspot/share/opto/phaseX.cpp\nindex 1e4cd42e0..c4bdc5e89 100644\n--- a/src/hotspot/share/opto/phaseX.cpp\n+++ b/src/hotspot/share/opto/phaseX.cpp\n@@ -762,26 +762,36 @@ bool PhaseGVN::is_dominator_helper(Node *d, Node *n, bool linear_only) {\n //------------------------------dead_loop_check--------------------------------\n // Check for a simple dead loop when a data node references itself directly\n // or through an other data node excluding cons and phis.\n-void PhaseGVN::dead_loop_check( Node *n ) {\n-  // Phi may reference itself in a loop\n-  if (n !\u003d nullptr \u0026\u0026 !n-\u003eis_dead_loop_safe() \u0026\u0026 !n-\u003eis_CFG()) {\n-    // Do 2 levels check and only data inputs.\n-    bool no_dead_loop \u003d true;\n-    uint cnt \u003d n-\u003ereq();\n-    for (uint i \u003d 1; i \u003c cnt \u0026\u0026 no_dead_loop; i++) {\n-      Node *in \u003d n-\u003ein(i);\n-      if (in \u003d\u003d n) {\n-        no_dead_loop \u003d false;\n-      } else if (in !\u003d nullptr \u0026\u0026 !in-\u003eis_dead_loop_safe()) {\n-        uint icnt \u003d in-\u003ereq();\n-        for (uint j \u003d 1; j \u003c icnt \u0026\u0026 no_dead_loop; j++) {\n-          if (in-\u003ein(j) \u003d\u003d n || in-\u003ein(j) \u003d\u003d in)\n-            no_dead_loop \u003d false;\n-        }\n+void PhaseGVN::dead_loop_check(Node* n) {\n+  // Phi may reference itself in a loop.\n+  if (n \u003d\u003d nullptr || n-\u003eis_dead_loop_safe() || n-\u003eis_CFG()) {\n+    return;\n+  }\n+\n+  // Do 2 levels check and only data inputs.\n+  for (uint i \u003d 1; i \u003c n-\u003ereq(); i++) {\n+    Node* in \u003d n-\u003ein(i);\n+    if (in \u003d\u003d n) {\n+      n-\u003edump_bfs(100, nullptr, \"\");\n+      fatal(\"Dead loop detected, node references itself: %s (%d)\",\n+            n-\u003eName(), n-\u003e_idx);\n+    }\n+\n+    if (in \u003d\u003d nullptr || in-\u003eis_dead_loop_safe()) {\n+      continue;\n+    }\n+    for (uint j \u003d 1; j \u003c in-\u003ereq(); j++) {\n+      if (in-\u003ein(j) \u003d\u003d n) {\n+        n-\u003edump_bfs(100, nullptr, \"\");\n+        fatal(\"Dead loop detected, node input references current node: %s (%d) -\u003e %s (%d)\",\n+              in-\u003eName(), in-\u003e_idx, n-\u003eName(), n-\u003e_idx);\n+      }\n+      if (in-\u003ein(j) \u003d\u003d in) {\n+        n-\u003edump_bfs(100, nullptr, \"\");\n+        fatal(\"Dead loop detected, node input references itself: %s (%d)\",\n+              in-\u003eName(), in-\u003e_idx);\n       }\n     }\n-    if (!no_dead_loop) { n-\u003edump_bfs(100, nullptr, \"\"); }\n-    assert(no_dead_loop, \"dead loop detected\");\n   }\n }\n ","expectedMessage":"8375055: C2: Better dead loop detection printout","repository":"jdk","commitHash":"1b6c2bdd7b57891ed35e3c067871d2c0bf282824","metadata":{"author":"Aleksey Shipilev \u003cshade@openjdk.org\u003e"}}
{"id":"jdk-624d7144","diff":" src/hotspot/share/opto/escape.cpp                  | 35 ++++++++++++-\n .../TestSplitLoadThroughPhiDuringEA.java           | 58 ++++++++++++++++++++++\n 2 files changed, 92 insertions(+), 1 deletion(-)\n\ndiff --git a/src/hotspot/share/opto/escape.cpp b/src/hotspot/share/opto/escape.cpp\nindex 7b5c3855a..792384b1e 100644\n--- a/src/hotspot/share/opto/escape.cpp\n+++ b/src/hotspot/share/opto/escape.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2005, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -1058,6 +1058,39 @@ void ConnectionGraph::updates_after_load_split(Node* data_phi, Node* previous_lo\n     // \"new_load\" might actually be a constant, parameter, etc.\n     if (new_load-\u003eis_Load()) {\n       Node* new_addp \u003d new_load-\u003ein(MemNode::Address);\n+\n+      // If new_load is a Load but not from an AddP, it means that the load is folded into another\n+      // load. And since this load is not from a field, we cannot create a unique type for it.\n+      // For example:\n+      //\n+      //   if (b) {\n+      //       Holder h1 \u003d new Holder();\n+      //       Object o \u003d ...;\n+      //       h.o \u003d o.getClass();\n+      //   } else {\n+      //       Holder h2 \u003d ...;\n+      //   }\n+      //   Holder h \u003d Phi(h1, h2);\n+      //   Object r \u003d h.o;\n+      //\n+      // Then, splitting r through the merge point results in:\n+      //\n+      //   if (b) {\n+      //       Holder h1 \u003d new Holder();\n+      //       Object o \u003d ...;\n+      //       h.o \u003d o.getClass();\n+      //       Object o1 \u003d h.o;\n+      //   } else {\n+      //       Holder h2 \u003d ...;\n+      //       Object o2 \u003d h2.o;\n+      //   }\n+      //   Object r \u003d Phi(o1, o2);\n+      //\n+      // In this case, o1 is folded to o.getClass() which is a Load but not from an AddP, but from\n+      // an OopHandle that is loaded from the Klass of o.\n+      if (!new_addp-\u003eis_AddP()) {\n+        continue;\n+      }\n       Node* base \u003d get_addp_base(new_addp);\n \n       // The base might not be something that we can create an unique\ndiff --git a/test/hotspot/jtreg/compiler/escapeAnalysis/TestSplitLoadThroughPhiDuringEA.java b/test/hotspot/jtreg/compiler/escapeAnalysis/TestSplitLoadThroughPhiDuringEA.java\nnew file mode 100644\nindex 000000000..1221c1b80\n--- /dev/null\n+++ b/test/hotspot/jtreg/compiler/escapeAnalysis/TestSplitLoadThroughPhiDuringEA.java\n@@ -0,0 +1,58 @@\n+/*\n+ * Copyright (c) 2026, Oracle and/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package compiler.escapeAnalysis;\n+\n+import java.util.Objects;\n+\n+/*\n+ * @test\n+ * @bug 8374435\n+ * @summary assert during escape analysis when splitting a Load through a Phi because the input of\n+ *          the result Phi is a Load not from an AddP\n+ * @run main/othervm -XX:-UseOnStackReplacement -XX:-UseCompressedOops ${test.main.class}\n+ */\n+public class TestSplitLoadThroughPhiDuringEA {\n+    static class Holder {\n+        Object o;\n+    }\n+\n+    public static void main(String[] args) {\n+        Object o \u003d new Object();\n+        Holder h \u003d new Holder();\n+        for (int i \u003d 0; i \u003c 20000; i++) {\n+            test(true, h, o);\n+            test(false, h, o);\n+        }\n+    }\n+\n+    private static Object test(boolean b, Holder h, Object o) {\n+        h \u003d Objects.requireNonNull(h);\n+        if (b) {\n+            h \u003d new Holder();\n+            // This access has the pattern LoadP -\u003e LoadP, which upsets the compiler because the\n+            // pointer input of a LoadP is not an AddP\n+            h.o \u003d o.getClass();\n+        }\n+        return h.o;\n+    }\n+}","expectedMessage":"8374435: assert(addp-\u003eis_AddP()) failed: must be AddP during EA with -XX:-UseCompressedOops","repository":"jdk","commitHash":"624d7144f757c39215ae3dfed1b78cdd3b3e4f8e","metadata":{"author":"Quan Anh Mai \u003cqamai@openjdk.org\u003e"}}
{"id":"jdk-5da70b18","diff":" src/hotspot/os/linux/os_linux.cpp | 40 +--------------------------------------\n 1 file changed, 1 insertion(+), 39 deletions(-)\n\ndiff --git a/src/hotspot/os/linux/os_linux.cpp b/src/hotspot/os/linux/os_linux.cpp\nindex 88e5e9b58..6a2a3974a 100644\n--- a/src/hotspot/os/linux/os_linux.cpp\n+++ b/src/hotspot/os/linux/os_linux.cpp\n@@ -4878,31 +4878,8 @@ int os::open(const char *path, int oflag, int mode) {\n   // All file descriptors that are opened in the Java process and not\n   // specifically destined for a subprocess should have the close-on-exec\n   // flag set.  If we don\u0027t set it, then careless 3rd party native code\n-  // might fork and exec without closing all appropriate file descriptors,\n-  // and this in turn might:\n-  //\n-  // - cause end-of-file to fail to be detected on some file\n-  //   descriptors, resulting in mysterious hangs, or\n-  //\n-  // - might cause an fopen in the subprocess to fail on a system\n-  //   suffering from bug 1085341.\n-  //\n-  // (Yes, the default setting of the close-on-exec flag is a Unix\n-  // design flaw)\n-  //\n-  // See:\n-  // 1085341: 32-bit stdio routines should support file descriptors \u003e255\n-  // 4843136: (process) pipe file descriptor from Runtime.exec not being closed\n-  // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9\n-  //\n-  // Modern Linux kernels (after 2.6.23 2007) support O_CLOEXEC with open().\n-  // O_CLOEXEC is preferable to using FD_CLOEXEC on an open file descriptor\n-  // because it saves a system call and removes a small window where the flag\n-  // is unset.  On ancient Linux kernels the O_CLOEXEC flag will be ignored\n-  // and we fall back to using FD_CLOEXEC (see below).\n-#ifdef O_CLOEXEC\n+  // might fork and exec without closing all appropriate file descriptors.\n   oflag |\u003d O_CLOEXEC;\n-#endif\n \n   int fd \u003d ::open(path, oflag, mode);\n   if (fd \u003d\u003d -1) return -1;\n@@ -4925,21 +4902,6 @@ int os::open(const char *path, int oflag, int mode) {\n     }\n   }\n \n-#ifdef FD_CLOEXEC\n-  // Validate that the use of the O_CLOEXEC flag on open above worked.\n-  // With recent kernels, we will perform this check exactly once.\n-  static sig_atomic_t O_CLOEXEC_is_known_to_work \u003d 0;\n-  if (!O_CLOEXEC_is_known_to_work) {\n-    int flags \u003d ::fcntl(fd, F_GETFD);\n-    if (flags !\u003d -1) {\n-      if ((flags \u0026 FD_CLOEXEC) !\u003d 0)\n-        O_CLOEXEC_is_known_to_work \u003d 1;\n-      else\n-        ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);\n-    }\n-  }\n-#endif\n-\n   return fd;\n }\n ","expectedMessage":"8375006: [Linux] Remove obsolete O_CLOEXEC check in os::open","repository":"jdk","commitHash":"5da70b180461d46b1aa44f24ba3c05efdeb03f49","metadata":{"author":"Jonas Norlinder \u003cjnorlinder@openjdk.org\u003e"}}
{"id":"jdk-de6f35ef","diff":" src/hotspot/cpu/riscv/vm_version_riscv.cpp | 10 +++++-----\n 1 file changed, 5 insertions(+), 5 deletions(-)\n\ndiff --git a/src/hotspot/cpu/riscv/vm_version_riscv.cpp b/src/hotspot/cpu/riscv/vm_version_riscv.cpp\nindex 22f19c4f5..36f0864da 100644\n--- a/src/hotspot/cpu/riscv/vm_version_riscv.cpp\n+++ b/src/hotspot/cpu/riscv/vm_version_riscv.cpp\n@@ -167,11 +167,6 @@ void VM_Version::common_initialize() {\n       (unaligned_scalar.value() \u003d\u003d MISALIGNED_SCALAR_FAST));\n   }\n \n-  if (FLAG_IS_DEFAULT(AlignVector)) {\n-    FLAG_SET_DEFAULT(AlignVector,\n-      unaligned_vector.value() !\u003d MISALIGNED_VECTOR_FAST);\n-  }\n-\n #ifdef __riscv_ztso\n   // Hotspot is compiled with TSO support, it will only run on hardware which\n   // supports Ztso\n@@ -242,6 +237,11 @@ void VM_Version::c2_initialize() {\n     }\n   }\n \n+  if (FLAG_IS_DEFAULT(AlignVector)) {\n+    FLAG_SET_DEFAULT(AlignVector,\n+      unaligned_vector.value() !\u003d MISALIGNED_VECTOR_FAST);\n+  }\n+\n   // NOTE: Make sure codes dependent on UseRVV are put after MaxVectorSize initialize,\n   //       as there are extra checks inside it which could disable UseRVV\n   //       in some situations.","expectedMessage":"8375094: RISC-V: Fix client builds after JDK-8368732","repository":"jdk","commitHash":"de6f35eff988e737496d5e99e991868e97d72db4","metadata":{"author":"Dingli Zhang \u003cdzhang@openjdk.org\u003e"}}
{"id":"jdk-0d19d91b","diff":" .../share/gc/shenandoah/shenandoahFreeSet.cpp      | 11 +++-\n .../share/gc/shenandoah/shenandoahFreeSet.hpp      | 74 +++++++++++++++-------\n .../share/gc/shenandoah/shenandoahFullGC.cpp       | 21 +++---\n .../share/gc/shenandoah/shenandoahGeneration.cpp   |  3 +-\n src/hotspot/share/gc/shenandoah/shenandoahHeap.cpp | 16 ++---\n .../share/gc/shenandoah/shenandoahMetrics.cpp      |  5 +-\n .../gc/shenandoah/shenandoahOldGeneration.cpp      |  7 +-\n 7 files changed, 84 insertions(+), 53 deletions(-)\n\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahFreeSet.cpp b/src/hotspot/share/gc/shenandoah/shenandoahFreeSet.cpp\nindex c03e66e28..a8c978018 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahFreeSet.cpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahFreeSet.cpp\n@@ -338,7 +338,7 @@ void ShenandoahRegionPartitions::make_all_regions_unavailable() {\n     _empty_region_counts[partition_id] \u003d 0;\n     _used[partition_id] \u003d 0;\n     _humongous_waste[partition_id] \u003d 0;\n-    _available[partition_id] \u003d FreeSetUnderConstruction;\n+    _available[partition_id] \u003d 0;\n   }\n }\n \n@@ -2495,6 +2495,10 @@ void ShenandoahFreeSet::move_regions_from_collector_to_mutator(size_t max_xfer_r\n void ShenandoahFreeSet::prepare_to_rebuild(size_t \u0026young_trashed_regions, size_t \u0026old_trashed_regions,\n                                            size_t \u0026first_old_region, size_t \u0026last_old_region, size_t \u0026old_region_count) {\n   shenandoah_assert_heaplocked();\n+  assert(rebuild_lock() !\u003d nullptr, \"sanity\");\n+  rebuild_lock()-\u003elock(false);\n+  // This resets all state information, removing all regions from all sets.\n+  clear();\n   log_debug(gc, free)(\"Rebuilding FreeSet\");\n \n   // This places regions that have alloc_capacity into the old_collector set if they identify as is_old() or the\n@@ -2524,6 +2528,9 @@ void ShenandoahFreeSet::finish_rebuild(size_t young_trashed_regions, size_t old_\n   _total_young_regions \u003d _heap-\u003enum_regions() - old_region_count;\n   _total_global_regions \u003d _heap-\u003enum_regions();\n   establish_old_collector_alloc_bias();\n+\n+  // Release the rebuild lock now.  What remains in this function is read-only\n+  rebuild_lock()-\u003eunlock();\n   _partitions.assert_bounds(true);\n   log_status();\n }\n@@ -3058,7 +3065,7 @@ void ShenandoahFreeSet::log_status() {\n       size_t max_humongous \u003d max_contig * ShenandoahHeapRegion::region_size_bytes();\n       // capacity() is capacity of mutator\n       // used() is used of mutator\n-      size_t free \u003d capacity() - used();\n+      size_t free \u003d capacity_holding_lock() - used_holding_lock();\n       // Since certain regions that belonged to the Mutator free partition at the time of most recent rebuild may have been\n       // retired, the sum of used and capacities within regions that are still in the Mutator free partition may not match\n       // my internally tracked values of used() and free().\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahFreeSet.hpp b/src/hotspot/share/gc/shenandoah/shenandoahFreeSet.hpp\nindex 95f9fbe68..364637740 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahFreeSet.hpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahFreeSet.hpp\n@@ -28,9 +28,13 @@\n \n #include \"gc/shenandoah/shenandoahHeap.hpp\"\n #include \"gc/shenandoah/shenandoahHeapRegionSet.hpp\"\n+#include \"gc/shenandoah/shenandoahLock.hpp\"\n #include \"gc/shenandoah/shenandoahSimpleBitMap.hpp\"\n #include \"logging/logStream.hpp\"\n \n+typedef ShenandoahLock    ShenandoahRebuildLock;\n+typedef ShenandoahLocker  ShenandoahRebuildLocker;\n+\n // Each ShenandoahHeapRegion is associated with a ShenandoahFreeSetPartitionId.\n enum class ShenandoahFreeSetPartitionId : uint8_t {\n   Mutator,                      // Region is in the Mutator free set: available memory is available to mutators.\n@@ -139,8 +143,6 @@ using idx_t \u003d ShenandoahSimpleBitMap::idx_t;\n   ShenandoahRegionPartitions(size_t max_regions, ShenandoahFreeSet* free_set);\n   ~ShenandoahRegionPartitions() {}\n \n-  static const size_t FreeSetUnderConstruction \u003d SIZE_MAX;\n-\n   inline idx_t max() const { return _max; }\n \n   // At initialization, reset OldCollector tallies\n@@ -352,6 +354,16 @@ using idx_t \u003d ShenandoahSimpleBitMap::idx_t;\n     return _available[int(which_partition)];\n   }\n \n+  // Return available_in assuming caller does not hold the heap lock but does hold the rebuild_lock.\n+  // The returned value may be \"slightly stale\" because we do not assure that every fetch of this value\n+  // sees the most recent update of this value.  Requiring the caller to hold the rebuild_lock assures\n+  // that we don\u0027t see \"bogus\" values that are \"worse than stale\".  During rebuild of the freeset, the\n+  // value of _available is not reliable.\n+  inline size_t available_in_locked_for_rebuild(ShenandoahFreeSetPartitionId which_partition) const {\n+    assert (which_partition \u003c NumPartitions, \"selected free set must be valid\");\n+    return _available[int(which_partition)];\n+  }\n+\n   // Returns bytes of humongous waste\n   inline size_t humongous_waste(ShenandoahFreeSetPartitionId which_partition) const {\n     assert (which_partition \u003c NumPartitions, \"selected free set must be valid\");\n@@ -359,23 +371,6 @@ using idx_t \u003d ShenandoahSimpleBitMap::idx_t;\n     return _humongous_waste[int(which_partition)];\n   }\n \n-  // Return available_in assuming caller does not hold the heap lock.  In production builds, available is\n-  // returned without acquiring the lock.  In debug builds, the global heap lock is acquired in order to\n-  // enforce a consistency assert.\n-  inline size_t available_in_not_locked(ShenandoahFreeSetPartitionId which_partition) const {\n-    assert (which_partition \u003c NumPartitions, \"selected free set must be valid\");\n-    shenandoah_assert_not_heaplocked();\n-#ifdef ASSERT\n-    ShenandoahHeapLocker locker(ShenandoahHeap::heap()-\u003elock());\n-    assert((_available[int(which_partition)] \u003d\u003d FreeSetUnderConstruction) ||\n-           (_available[int(which_partition)] \u003d\u003d _capacity[int(which_partition)] - _used[int(which_partition)]),\n-           \"Expect available (%zu) equals capacity (%zu) - used (%zu) for partition %s\",\n-           _available[int(which_partition)], _capacity[int(which_partition)], _used[int(which_partition)],\n-           partition_membership_name(idx_t(which_partition)));\n-#endif\n-    return _available[int(which_partition)];\n-  }\n-\n   inline void set_capacity_of(ShenandoahFreeSetPartitionId which_partition, size_t value);\n \n   inline void set_used_by(ShenandoahFreeSetPartitionId which_partition, size_t value) {\n@@ -440,6 +435,15 @@ using idx_t \u003d ShenandoahSimpleBitMap::idx_t;\n   ShenandoahHeap* const _heap;\n   ShenandoahRegionPartitions _partitions;\n \n+  // This locks the rebuild process (in combination with the global heap lock).  Whenever we rebuild the free set,\n+  // we first acquire the global heap lock and then we acquire this _rebuild_lock in a nested context.  Threads that\n+  // need to check available, acquire only the _rebuild_lock to make sure that they are not obtaining the value of\n+  // available for a partially reconstructed free-set.\n+  //\n+  // Note that there is rank ordering of nested locks to prevent deadlock.  All threads that need to acquire both\n+  // locks will acquire them in the same order: first the global heap lock and then the rebuild lock.\n+  ShenandoahRebuildLock _rebuild_lock;\n+\n   size_t _total_humongous_waste;\n \n   HeapWord* allocate_aligned_plab(size_t size, ShenandoahAllocRequest\u0026 req, ShenandoahHeapRegion* r);\n@@ -635,10 +639,12 @@ using idx_t \u003d ShenandoahSimpleBitMap::idx_t;\n   void log_status();\n \n public:\n-  static const size_t FreeSetUnderConstruction \u003d ShenandoahRegionPartitions::FreeSetUnderConstruction;\n-\n   ShenandoahFreeSet(ShenandoahHeap* heap, size_t max_regions);\n \n+  ShenandoahRebuildLock* rebuild_lock() {\n+    return \u0026_rebuild_lock;\n+  }\n+\n   inline size_t max_regions() const { return _partitions.max(); }\n   ShenandoahFreeSetPartitionId membership(size_t index) const { return _partitions.membership(index); }\n   inline void shrink_interval_if_range_modifies_either_boundary(ShenandoahFreeSetPartitionId partition,\n@@ -776,9 +782,29 @@ using idx_t \u003d ShenandoahSimpleBitMap::idx_t;\n   // adjusts available with respect to lock holders.  However, sequential calls to these three functions may produce\n   // inconsistent data: available may not equal capacity - used because the intermediate states of any \"atomic\"\n   // locked action can be seen by these unlocked functions.\n-  inline size_t capacity()  const { return _partitions.capacity_of(ShenandoahFreeSetPartitionId::Mutator);             }\n-  inline size_t used()      const { return _partitions.used_by(ShenandoahFreeSetPartitionId::Mutator);                 }\n-  inline size_t available() const { return _partitions.available_in_not_locked(ShenandoahFreeSetPartitionId::Mutator); }\n+  inline size_t capacity_holding_lock() const {\n+    shenandoah_assert_heaplocked();\n+    return _partitions.capacity_of(ShenandoahFreeSetPartitionId::Mutator);\n+  }\n+  inline size_t capacity_not_holding_lock() {\n+    shenandoah_assert_not_heaplocked();\n+    ShenandoahRebuildLocker locker(rebuild_lock());\n+    return _partitions.capacity_of(ShenandoahFreeSetPartitionId::Mutator);\n+  }\n+  inline size_t used_holding_lock() const {\n+    shenandoah_assert_heaplocked();\n+    return _partitions.used_by(ShenandoahFreeSetPartitionId::Mutator);\n+  }\n+  inline size_t used_not_holding_lock() {\n+    shenandoah_assert_not_heaplocked();\n+    ShenandoahRebuildLocker locker(rebuild_lock());\n+    return _partitions.used_by(ShenandoahFreeSetPartitionId::Mutator);\n+  }\n+  inline size_t available() {\n+    shenandoah_assert_not_heaplocked();\n+    ShenandoahRebuildLocker locker(rebuild_lock());\n+    return _partitions.available_in_locked_for_rebuild(ShenandoahFreeSetPartitionId::Mutator);\n+  }\n \n   inline size_t total_humongous_waste() const      { return _total_humongous_waste; }\n   inline size_t humongous_waste_in_mutator() const { return _partitions.humongous_waste(ShenandoahFreeSetPartitionId::Mutator); }\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahFullGC.cpp b/src/hotspot/share/gc/shenandoah/shenandoahFullGC.cpp\nindex 027d7e022..fa3a7a422 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahFullGC.cpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahFullGC.cpp\n@@ -1113,18 +1113,17 @@ void ShenandoahFullGC::phase5_epilog() {\n     ShenandoahPostCompactClosure post_compact;\n     heap-\u003eheap_region_iterate(\u0026post_compact);\n     heap-\u003ecollection_set()-\u003eclear();\n-    size_t young_cset_regions, old_cset_regions;\n-    size_t first_old, last_old, num_old;\n-    heap-\u003efree_set()-\u003eprepare_to_rebuild(young_cset_regions, old_cset_regions, first_old, last_old, num_old);\n-\n-    // We also do not expand old generation size following Full GC because we have scrambled age populations and\n-    // no longer have objects separated by age into distinct regions.\n-    if (heap-\u003emode()-\u003eis_generational()) {\n-      ShenandoahGenerationalFullGC::compute_balances();\n+    size_t young_cset_regions, old_cset_regions, first_old, last_old, num_old;\n+    ShenandoahFreeSet* free_set \u003d heap-\u003efree_set();\n+    {\n+      free_set-\u003eprepare_to_rebuild(young_cset_regions, old_cset_regions, first_old, last_old, num_old);\n+      // We also do not expand old generation size following Full GC because we have scrambled age populations and\n+      // no longer have objects separated by age into distinct regions.\n+      if (heap-\u003emode()-\u003eis_generational()) {\n+        ShenandoahGenerationalFullGC::compute_balances();\n+      }\n+      free_set-\u003efinish_rebuild(young_cset_regions, old_cset_regions, num_old);\n     }\n-\n-    heap-\u003efree_set()-\u003efinish_rebuild(young_cset_regions, old_cset_regions, num_old);\n-\n     // Set mark incomplete because the marking bitmaps have been reset except pinned regions.\n     _generation-\u003eset_mark_incomplete();\n \ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahGeneration.cpp b/src/hotspot/share/gc/shenandoah/shenandoahGeneration.cpp\nindex d74ee872c..a5d8cca45 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahGeneration.cpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahGeneration.cpp\n@@ -815,10 +815,9 @@ void ShenandoahGeneration::prepare_regions_and_collection_set(bool concurrent) {\n     ShenandoahGCPhase phase(concurrent ? ShenandoahPhaseTimings::final_rebuild_freeset :\n                             ShenandoahPhaseTimings::degen_gc_final_rebuild_freeset);\n     ShenandoahHeapLocker locker(heap-\u003elock());\n-    size_t young_cset_regions, old_cset_regions;\n \n     // We are preparing for evacuation.  At this time, we ignore cset region tallies.\n-    size_t first_old, last_old, num_old;\n+    size_t young_cset_regions, old_cset_regions, first_old, last_old, num_old;\n     _free_set-\u003eprepare_to_rebuild(young_cset_regions, old_cset_regions, first_old, last_old, num_old);\n \n     if (heap-\u003emode()-\u003eis_generational()) {\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahHeap.cpp b/src/hotspot/share/gc/shenandoah/shenandoahHeap.cpp\nindex 3bf53f800..683e2959a 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahHeap.cpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahHeap.cpp\n@@ -426,8 +426,6 @@ jint ShenandoahHeap::initialize() {\n       _affiliations[i] \u003d ShenandoahAffiliation::FREE;\n     }\n     _free_set \u003d new ShenandoahFreeSet(this, _num_regions);\n-\n-\n     post_initialize_heuristics();\n     // We are initializing free set.  We ignore cset region tallies.\n     size_t young_cset_regions, old_cset_regions, first_old, last_old, num_old;\n@@ -1658,7 +1656,7 @@ void ShenandoahHeap::verify(VerifyOption vo) {\n   }\n }\n size_t ShenandoahHeap::tlab_capacity() const {\n-  return _free_set-\u003ecapacity();\n+  return _free_set-\u003ecapacity_not_holding_lock();\n }\n \n class ObjectIterateScanRootClosure : public BasicOopIterateClosure {\n@@ -2138,7 +2136,7 @@ GCTracer* ShenandoahHeap::tracer() {\n }\n \n size_t ShenandoahHeap::tlab_used() const {\n-  return _free_set-\u003eused();\n+  return _free_set-\u003eused_not_holding_lock();\n }\n \n bool ShenandoahHeap::try_cancel_gc(GCCause::Cause cause) {\n@@ -2528,8 +2526,7 @@ void ShenandoahHeap::rebuild_free_set(bool concurrent) {\n                           ShenandoahPhaseTimings::final_update_refs_rebuild_freeset :\n                           ShenandoahPhaseTimings::degen_gc_final_update_refs_rebuild_freeset);\n   ShenandoahHeapLocker locker(lock());\n-  size_t young_cset_regions, old_cset_regions;\n-  size_t first_old_region, last_old_region, old_region_count;\n+  size_t young_cset_regions, old_cset_regions, first_old_region, last_old_region, old_region_count;\n   _free_set-\u003eprepare_to_rebuild(young_cset_regions, old_cset_regions, first_old_region, last_old_region, old_region_count);\n   // If there are no old regions, first_old_region will be greater than last_old_region\n   assert((first_old_region \u003e last_old_region) ||\n@@ -2548,13 +2545,14 @@ void ShenandoahHeap::rebuild_free_set(bool concurrent) {\n     // The computation of bytes_of_allocation_runway_before_gc_trigger is quite conservative so consider all of this\n     // available for transfer to old. Note that transfer of humongous regions does not impact available.\n     ShenandoahGenerationalHeap* gen_heap \u003d ShenandoahGenerationalHeap::heap();\n-    size_t allocation_runway \u003d gen_heap-\u003eyoung_generation()-\u003eheuristics()-\u003ebytes_of_allocation_runway_before_gc_trigger(young_cset_regions);\n+    size_t allocation_runway \u003d\n+      gen_heap-\u003eyoung_generation()-\u003eheuristics()-\u003ebytes_of_allocation_runway_before_gc_trigger(young_cset_regions);\n     gen_heap-\u003ecompute_old_generation_balance(allocation_runway, old_cset_regions);\n \n     // Total old_available may have been expanded to hold anticipated promotions.  We trigger if the fragmented available\n     // memory represents more than 16 regions worth of data.  Note that fragmentation may increase when we promote regular\n-    // regions in place when many of these regular regions have an abundant amount of available memory within them.  Fragmentation\n-    // will decrease as promote-by-copy consumes the available memory within these partially consumed regions.\n+    // regions in place when many of these regular regions have an abundant amount of available memory within them.\n+    // Fragmentation will decrease as promote-by-copy consumes the available memory within these partially consumed regions.\n     //\n     // We consider old-gen to have excessive fragmentation if more than 12.5% of old-gen is free memory that resides\n     // within partially consumed regions of memory.\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahMetrics.cpp b/src/hotspot/share/gc/shenandoah/shenandoahMetrics.cpp\nindex d774a8dba..81c62ebbd 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahMetrics.cpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahMetrics.cpp\n@@ -30,7 +30,7 @@\n \n ShenandoahMetricsSnapshot::ShenandoahMetricsSnapshot(ShenandoahFreeSet* free_set)\n   : _free_set(free_set)\n-  , _used_before(free_set-\u003eused())\n+  , _used_before(free_set-\u003eused_not_holding_lock())\n   , _if_before(free_set-\u003einternal_fragmentation())\n   , _ef_before(free_set-\u003eexternal_fragmentation()) {\n }\n@@ -38,7 +38,6 @@ ShenandoahMetricsSnapshot::ShenandoahMetricsSnapshot(ShenandoahFreeSet* free_set\n bool ShenandoahMetricsSnapshot::is_good_progress() const {\n   // Under the critical threshold?\n   const size_t free_actual \u003d _free_set-\u003eavailable();\n-  assert(free_actual !\u003d ShenandoahFreeSet::FreeSetUnderConstruction, \"Avoid this race\");\n \n   // ShenandoahCriticalFreeThreshold is expressed as a percentage.  We multiply this percentage by 1/100th\n   // of the soft max capacity to determine whether the available memory within the mutator partition of the\n@@ -52,7 +51,7 @@ bool ShenandoahMetricsSnapshot::is_good_progress() const {\n   }\n \n   // Freed up enough?\n-  const size_t used_after \u003d _free_set-\u003eused();\n+  const size_t used_after \u003d _free_set-\u003eused_not_holding_lock();\n   const size_t progress_actual   \u003d (_used_before \u003e used_after) ? _used_before - used_after : 0;\n   const size_t progress_expected \u003d ShenandoahHeapRegion::region_size_bytes();\n   const bool prog_used \u003d progress_actual \u003e\u003d progress_expected;\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahOldGeneration.cpp b/src/hotspot/share/gc/shenandoah/shenandoahOldGeneration.cpp\nindex c7cf013d0..c795eda3d 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahOldGeneration.cpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahOldGeneration.cpp\n@@ -412,9 +412,12 @@ void ShenandoahOldGeneration::prepare_regions_and_collection_set(bool concurrent\n     ShenandoahGCPhase phase(concurrent ?\n         ShenandoahPhaseTimings::final_rebuild_freeset :\n         ShenandoahPhaseTimings::degen_gc_final_rebuild_freeset);\n+    ShenandoahFreeSet* free_set \u003d heap-\u003efree_set();\n     ShenandoahHeapLocker locker(heap-\u003elock());\n-    size_t young_trash_regions, old_trash_regions;\n-    size_t first_old, last_old, num_old;\n+\n+    // This is completion of old-gen marking.  We rebuild in order to reclaim immediate garbage and to\n+    // prepare for subsequent mixed evacuations.\n+    size_t young_trash_regions, old_trash_regions, first_old, last_old, num_old;\n     heap-\u003efree_set()-\u003eprepare_to_rebuild(young_trash_regions, old_trash_regions, first_old, last_old, num_old);\n     // At the end of old-gen, we may find that we have reclaimed immediate garbage, allowing a longer allocation runway.\n     // We may also find that we have accumulated canddiate regions for mixed evacuation.  If so, we will want to expand","expectedMessage":"8369048: GenShen: Defer ShenFreeSet::available() during rebuild","repository":"jdk","commitHash":"0d19d91b44e5232dbd99d34dcdf6500f892e3048","metadata":{"author":"Kelvin Nilsen \u003ckdnilsen@openjdk.org\u003e"}}
{"id":"jdk-4d0ad0a4","diff":" test/jdk/jdk/internal/misc/VM/RuntimeArguments.java | 1 +\n 1 file changed, 1 insertion(+)\n\ndiff --git a/test/jdk/jdk/internal/misc/VM/RuntimeArguments.java b/test/jdk/jdk/internal/misc/VM/RuntimeArguments.java\nindex dbcb30255..b86593d84 100644\n--- a/test/jdk/jdk/internal/misc/VM/RuntimeArguments.java\n+++ b/test/jdk/jdk/internal/misc/VM/RuntimeArguments.java\n@@ -24,6 +24,7 @@\n /**\n  * @test\n  * @requires vm.flagless\n+ * @requires test.thread.factory \u003d\u003d null\n  * @library /test/lib\n  * @modules java.base/jdk.internal.misc\n  *          jdk.zipfs","expectedMessage":"8373718: jdk/internal/misc/VM/RuntimeArguments.java test fails in Virtual threads mode","repository":"jdk","commitHash":"4d0ad0a4a391286c683ebb8c8d711ea0be68c31a","metadata":{"author":"Brent Christian \u003cbchristi@openjdk.org\u003e"}}
{"id":"jdk-b070367b","diff":" .../jfr/periodic/sampling/jfrThreadSampler.cpp     | 94 ++++++++++------------\n 1 file changed, 44 insertions(+), 50 deletions(-)\n\ndiff --git a/src/hotspot/share/jfr/periodic/sampling/jfrThreadSampler.cpp b/src/hotspot/share/jfr/periodic/sampling/jfrThreadSampler.cpp\nindex 805426078..0a8b39751 100644\n--- a/src/hotspot/share/jfr/periodic/sampling/jfrThreadSampler.cpp\n+++ b/src/hotspot/share/jfr/periodic/sampling/jfrThreadSampler.cpp\n@@ -232,41 +232,50 @@ void JfrSamplerThread::task_stacktrace(JfrSampleRequestType type, JavaThread** l\n   JavaThread* start \u003d nullptr;\n   elapsedTimer sample_time;\n   sample_time.start();\n-  ThreadsListHandle tlh;\n-  // Resolve a sample session relative start position index into the thread list array.\n-  // In cases where the last sampled thread is null or not-null but stale, find_index() returns -1.\n-  _cur_index \u003d tlh.list()-\u003efind_index_of_JavaThread(*last_thread);\n-  JavaThread* current \u003d _cur_index !\u003d -1 ? *last_thread : nullptr;\n-\n-  while (num_samples \u003c sample_limit) {\n-    current \u003d next_thread(tlh.list(), start, current);\n-    if (current \u003d\u003d nullptr) {\n-      break;\n-    }\n-    if (is_excluded(current)) {\n-      continue;\n-    }\n-    if (start \u003d\u003d nullptr) {\n-      start \u003d current; // remember the thread where we started to attempt sampling\n-    }\n-    bool success;\n-    if (JAVA_SAMPLE \u003d\u003d type) {\n-      success \u003d sample_java_thread(current);\n-    } else {\n-      assert(type \u003d\u003d NATIVE_SAMPLE, \"invariant\");\n-      success \u003d sample_native_thread(current);\n-    }\n-    if (success) {\n-      num_samples++;\n-    }\n-    if (SafepointSynchronize::is_at_safepoint()) {\n-      // For _thread_in_native, we cannot get the Threads_lock.\n-      // For _thread_in_Java, well, there are none.\n-      break;\n+  {\n+    /*\n+     * Take the Threads_lock for three purposes:\n+     *\n+     * 1) Avoid sampling right through a safepoint,\n+     *    which could result in touching oops in case of virtual threads.\n+     * 2) Prevent JFR from issuing an epoch rotation while the sampler thread\n+     *    is actively processing a thread in state native, as both threads are outside the safepoint protocol.\n+     * 3) Some operating systems (BSD / Mac) require a process lock when sending a signal with pthread_kill.\n+     *    Holding the Threads_lock prevents a JavaThread from calling os::create_thread(), which also takes the process lock.\n+     *    In a sense, we provide a coarse signal mask, so we can always send the resume signal.\n+     */\n+    MutexLocker tlock(Threads_lock);\n+    ThreadsListHandle tlh;\n+    // Resolve a sample session relative start position index into the thread list array.\n+    // In cases where the last sampled thread is null or not-null but stale, find_index() returns -1.\n+    _cur_index \u003d tlh.list()-\u003efind_index_of_JavaThread(*last_thread);\n+    JavaThread* current \u003d _cur_index !\u003d -1 ? *last_thread : nullptr;\n+\n+    while (num_samples \u003c sample_limit) {\n+      current \u003d next_thread(tlh.list(), start, current);\n+      if (current \u003d\u003d nullptr) {\n+        break;\n+      }\n+      if (is_excluded(current)) {\n+        continue;\n+      }\n+      if (start \u003d\u003d nullptr) {\n+        start \u003d current; // remember the thread where we started to attempt sampling\n+      }\n+      bool success;\n+      if (JAVA_SAMPLE \u003d\u003d type) {\n+        success \u003d sample_java_thread(current);\n+      } else {\n+        assert(type \u003d\u003d NATIVE_SAMPLE, \"invariant\");\n+        success \u003d sample_native_thread(current);\n+      }\n+      if (success) {\n+        num_samples++;\n+      }\n     }\n-  }\n \n-  *last_thread \u003d current; // remember the thread we last attempted to sample\n+    *last_thread \u003d current; // remember the thread we last attempted to sample\n+  }\n   sample_time.stop();\n   log_trace(jfr)(\"JFR thread sampling done in %3.7f secs with %d java %d native samples\",\n     sample_time.seconds(), type \u003d\u003d JAVA_SAMPLE ? num_samples : 0, type \u003d\u003d NATIVE_SAMPLE ? num_samples : 0);\n@@ -297,6 +306,7 @@ class OSThreadSampler : public SuspendedThreadTask {\n // Sampling a thread in state _thread_in_Java\n // involves a platform-specific thread suspend and CPU context retrieval.\n bool JfrSamplerThread::sample_java_thread(JavaThread* jt) {\n+  assert_lock_strong(Threads_lock);\n   if (jt-\u003ethread_state() !\u003d _thread_in_Java) {\n     return false;\n   }\n@@ -328,6 +338,7 @@ static JfrSamplerThread* _sampler_thread \u003d nullptr;\n // without thread suspension and CPU context retrieval,\n // if we carefully order the loads of the thread state.\n bool JfrSamplerThread::sample_native_thread(JavaThread* jt) {\n+  assert_lock_strong(Threads_lock);\n   if (jt-\u003ethread_state() !\u003d _thread_in_native) {\n     return false;\n   }\n@@ -343,22 +354,6 @@ bool JfrSamplerThread::sample_native_thread(JavaThread* jt) {\n \n   SafepointMechanism::arm_local_poll_release(jt);\n \n-  // Take the Threads_lock for two purposes:\n-  // 1) Avoid sampling through a safepoint which could result\n-  //    in touching oops in case of virtual threads.\n-  // 2) Prevent JFR from issuing an epoch rotation while the sampler thread\n-  //    is actively processing a thread in native, as both threads are now\n-  //    outside the safepoint protocol.\n-\n-  // OrderAccess::fence() as part of acquiring the lock prevents loads from floating up.\n-  JfrMutexTryLock lock(Threads_lock);\n-\n-  if (!lock.acquired()) {\n-    // Remove the native sample request and release the potentially waiting thread.\n-    JfrSampleMonitor jsm(tl);\n-    return false;\n-  }\n-\n   // Separate the arming of the poll (above) from the reading of JavaThread state (below).\n   if (UseSystemMemoryBarrier) {\n     SystemMemoryBarrier::emit();\n@@ -367,7 +362,6 @@ bool JfrSamplerThread::sample_native_thread(JavaThread* jt) {\n   }\n \n   if (jt-\u003ethread_state() !\u003d _thread_in_native || !jt-\u003ehas_last_Java_frame()) {\n-    assert_lock_strong(Threads_lock);\n     JfrSampleMonitor jsm(tl);\n     if (jsm.is_waiting()) {\n       // The thread has already returned from native,","expectedMessage":"8373106: JFR suspend/resume deadlock on macOS in pthreads library","repository":"jdk","commitHash":"b070367bdf980ef1c257cab485927db39b544241","metadata":{"author":"Markus Grnlund \u003cmgronlun@openjdk.org\u003e"}}
{"id":"jdk-f23752a7","diff":" src/hotspot/share/jfr/jfr.cpp                      |  14 +-\n src/hotspot/share/jfr/jfr.hpp                      |   5 +-\n src/hotspot/share/jfr/jni/jfrJniMethod.cpp         |   5 +-\n .../jfr/recorder/repository/jfrEmergencyDump.cpp   |  54 ++++---\n .../jfr/recorder/repository/jfrEmergencyDump.hpp   |   4 +-\n .../share/jfr/recorder/service/jfrPostBox.cpp      |   7 +-\n .../share/jfr/recorder/service/jfrPostBox.hpp      |  25 +--\n .../jfr/recorder/service/jfrRecorderService.cpp    | 180 +++++++++++++++++++--\n .../jfr/recorder/service/jfrRecorderService.hpp    |  20 ++-\n .../jfr/recorder/service/jfrRecorderThreadLoop.cpp |   8 +-\n src/hotspot/share/runtime/java.cpp                 |   7 +-\n src/hotspot/share/utilities/debug.cpp              |   7 +-\n src/hotspot/share/utilities/vmError.cpp            |   4 +-\n test/jdk/ProblemList.txt                           |   1 -\n .../event/oldobject/TestEmergencyDumpAtOOM.java    |   6 +-\n 15 files changed, 274 insertions(+), 73 deletions(-)\n\ndiff --git a/src/hotspot/share/jfr/jfr.cpp b/src/hotspot/share/jfr/jfr.cpp\nindex b09a89594..d9892f80b 100644\n--- a/src/hotspot/share/jfr/jfr.cpp\n+++ b/src/hotspot/share/jfr/jfr.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2019, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -32,6 +32,7 @@\n #include \"jfr/recorder/repository/jfrEmergencyDump.hpp\"\n #include \"jfr/recorder/repository/jfrRepository.hpp\"\n #include \"jfr/recorder/service/jfrOptionSet.hpp\"\n+#include \"jfr/recorder/service/jfrRecorderService.hpp\"\n #include \"jfr/support/jfrClassDefineEvent.hpp\"\n #include \"jfr/support/jfrKlassExtension.hpp\"\n #include \"jfr/support/jfrResolution.hpp\"\n@@ -43,6 +44,7 @@\n #include \"runtime/java.hpp\"\n #include \"runtime/javaThread.hpp\"\n \n+\n bool Jfr::is_enabled() {\n   return JfrRecorder::is_enabled();\n }\n@@ -153,9 +155,9 @@ void Jfr::on_resolution(const Method* caller, const Method* target, TRAPS) {\n }\n #endif\n \n-void Jfr::on_vm_shutdown(bool emit_old_object_samples, bool emit_event_shutdown, bool halt) {\n+void Jfr::on_vm_shutdown(bool exception_handler /* false */, bool halt /* false */, bool oom /* false */) {\n   if (!halt \u0026\u0026 JfrRecorder::is_recording()) {\n-    JfrEmergencyDump::on_vm_shutdown(emit_old_object_samples, emit_event_shutdown);\n+    JfrEmergencyDump::on_vm_shutdown(exception_handler, oom);\n   }\n }\n \n@@ -173,6 +175,12 @@ bool Jfr::on_start_flight_recording_option(const JavaVMOption** option, char* de\n   return JfrOptionSet::parse_start_flight_recording_option(option, delimiter);\n }\n \n+void Jfr::on_report_java_out_of_memory() {\n+  if (CrashOnOutOfMemoryError \u0026\u0026 JfrRecorder::is_recording()) {\n+    JfrRecorderService::emit_leakprofiler_events_on_oom();\n+  }\n+}\n+\n #if INCLUDE_CDS\n void Jfr::on_restoration(const Klass* k, JavaThread* jt) {\n   assert(k !\u003d nullptr, \"invariant\");\ndiff --git a/src/hotspot/share/jfr/jfr.hpp b/src/hotspot/share/jfr/jfr.hpp\nindex db567cc9a..ac6a232dd 100644\n--- a/src/hotspot/share/jfr/jfr.hpp\n+++ b/src/hotspot/share/jfr/jfr.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2018, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -71,7 +71,7 @@ class Jfr : AllStatic {\n   static void on_resolution(const Method* caller, const Method* target, TRAPS);\n   static void on_java_thread_start(JavaThread* starter, JavaThread* startee);\n   static void on_set_current_thread(JavaThread* jt, oop thread);\n-  static void on_vm_shutdown(bool emit_old_object_samples, bool emit_event_shutdown, bool halt \u003d false);\n+  static void on_vm_shutdown(bool exception_handler \u003d false, bool halt \u003d false, bool oom \u003d false);\n   static void on_vm_error_report(outputStream* st);\n   static bool on_flight_recorder_option(const JavaVMOption** option, char* delimiter);\n   static bool on_start_flight_recording_option(const JavaVMOption** option, char* delimiter);\n@@ -79,6 +79,7 @@ class Jfr : AllStatic {\n   static void initialize_main_thread(JavaThread* jt);\n   static bool has_sample_request(JavaThread* jt);\n   static void check_and_process_sample_request(JavaThread* jt);\n+  static void on_report_java_out_of_memory();\n   CDS_ONLY(static void on_restoration(const Klass* k, JavaThread* jt);)\n };\n \ndiff --git a/src/hotspot/share/jfr/jni/jfrJniMethod.cpp b/src/hotspot/share/jfr/jni/jfrJniMethod.cpp\nindex 6a1146587..d8a30f9b5 100644\n--- a/src/hotspot/share/jfr/jni/jfrJniMethod.cpp\n+++ b/src/hotspot/share/jfr/jni/jfrJniMethod.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2014, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -364,8 +364,7 @@ JVM_ENTRY_NO_ENV(void, jfr_set_force_instrumentation(JNIEnv* env, jclass jvm, jb\n JVM_END\n \n NO_TRANSITION(void, jfr_emit_old_object_samples(JNIEnv* env, jclass jvm, jlong cutoff_ticks, jboolean emit_all, jboolean skip_bfs))\n-  JfrRecorderService service;\n-  service.emit_leakprofiler_events(cutoff_ticks, emit_all \u003d\u003d JNI_TRUE, skip_bfs \u003d\u003d JNI_TRUE);\n+  JfrRecorderService::emit_leakprofiler_events(cutoff_ticks, emit_all \u003d\u003d JNI_TRUE, skip_bfs \u003d\u003d JNI_TRUE);\n NO_TRANSITION_END\n \n JVM_ENTRY_NO_ENV(void, jfr_exclude_thread(JNIEnv* env, jclass jvm, jobject t))\ndiff --git a/src/hotspot/share/jfr/recorder/repository/jfrEmergencyDump.cpp b/src/hotspot/share/jfr/recorder/repository/jfrEmergencyDump.cpp\nindex 309ae9618..cdebcbcfc 100644\n--- a/src/hotspot/share/jfr/recorder/repository/jfrEmergencyDump.cpp\n+++ b/src/hotspot/share/jfr/recorder/repository/jfrEmergencyDump.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2012, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -38,6 +38,8 @@\n #include \"runtime/mutexLocker.hpp\"\n #include \"runtime/os.hpp\"\n #include \"runtime/thread.inline.hpp\"\n+#include \"runtime/vmOperations.hpp\"\n+#include \"runtime/vmThread.hpp\"\n #include \"utilities/growableArray.hpp\"\n #include \"utilities/ostream.hpp\"\n \n@@ -460,15 +462,6 @@ static void release_locks(Thread* thread) {\n   assert(thread !\u003d nullptr, \"invariant\");\n   assert(!thread-\u003eis_Java_thread() || JavaThread::cast(thread)-\u003ethread_state() \u003d\u003d _thread_in_vm, \"invariant\");\n \n-#ifdef ASSERT\n-  Mutex* owned_lock \u003d thread-\u003eowned_locks();\n-  while (owned_lock !\u003d nullptr) {\n-    Mutex* next \u003d owned_lock-\u003enext();\n-    owned_lock-\u003eunlock();\n-    owned_lock \u003d next;\n-  }\n-#endif // ASSERT\n-\n   if (Threads_lock-\u003eowned_by_self()) {\n     Threads_lock-\u003eunlock();\n   }\n@@ -550,17 +543,14 @@ class JavaThreadInVMAndNative : public StackObj {\n   }\n };\n \n-static void post_events(bool emit_old_object_samples, bool emit_event_shutdown, Thread* thread) {\n-  if (emit_old_object_samples) {\n-    LeakProfiler::emit_events(max_jlong, false, false);\n-  }\n-  if (emit_event_shutdown) {\n+static void post_events(bool exception_handler, bool oom, Thread * thread) {\n+  if (exception_handler) {\n     EventShutdown e;\n-    e.set_reason(\"VM Error\");\n+    e.set_reason(oom ? \"CrashOnOutOfMemoryError\" : \"VM Error\");\n     e.commit();\n   }\n   EventDumpReason event;\n-  event.set_reason(emit_old_object_samples ? \"Out of Memory\" : \"Crash\");\n+  event.set_reason(exception_handler \u0026\u0026 oom ? \"CrashOnOutOfMemoryError\" : exception_handler ? \"Crash\" : \"Out of Memory\");\n   event.set_recordingId(-1);\n   event.commit();\n }\n@@ -594,20 +584,40 @@ static bool guard_reentrancy() {\n   return false;\n }\n \n-void JfrEmergencyDump::on_vm_shutdown(bool emit_old_object_samples, bool emit_event_shutdown) {\n+void JfrEmergencyDump::on_vm_shutdown(bool exception_handler, bool oom) {\n   if (!guard_reentrancy()) {\n     return;\n   }\n+\n   Thread* const thread \u003d Thread::current_or_null_safe();\n   assert(thread !\u003d nullptr, \"invariant\");\n+\n+  // Ensure a JavaThread is _thread_in_vm when we make this call\n+  JavaThreadInVMAndNative jtivm(thread);\n+  post_events(exception_handler, oom, thread);\n+\n   if (thread-\u003eis_Watcher_thread()) {\n-    log_info(jfr, system)(\"The Watcher thread crashed so no jfr emergency dump will be generated.\");\n+    // We cannot attempt an emergency dump using the Watcher thread\n+    // because we rely on the WatcherThread task \"is_error_reported()\",\n+    // to exit the VM after a hardcoded timeout, should the relatively\n+    // risky operation of an emergency dump fail (deadlock, livelock).\n+    log_warning(jfr, system)\n+      (\"The Watcher thread crashed so no jfr emergency dump will be generated.\");\n     return;\n   }\n-  // Ensure a JavaThread is _thread_in_vm when we make this call\n-  JavaThreadInVMAndNative jtivm(thread);\n+\n+  if (thread-\u003eis_VM_thread()) {\n+    const VM_Operation* const operation \u003d VMThread::vm_operation();\n+    if (operation !\u003d nullptr \u0026\u0026 operation-\u003etype() \u003d\u003d VM_Operation::VMOp_JFROldObject) {\n+      // We will not be able to issue a rotation because the rotation lock\n+      // is held by the JFR Recorder Thread that issued the VM_Operation.\n+      log_warning(jfr, system)\n+        (\"The VM Thread crashed as part of emitting leak profiler events so no jfr emergency dump will be generated.\");\n+      return;\n+    }\n+  }\n+\n   release_locks(thread);\n-  post_events(emit_old_object_samples, emit_event_shutdown, thread);\n \n   // if JavaThread, transition to _thread_in_native to issue a final flushpoint\n   NoHandleMark nhm;\ndiff --git a/src/hotspot/share/jfr/recorder/repository/jfrEmergencyDump.hpp b/src/hotspot/share/jfr/recorder/repository/jfrEmergencyDump.hpp\nindex 04c2851a5..b337d7336 100644\n--- a/src/hotspot/share/jfr/recorder/repository/jfrEmergencyDump.hpp\n+++ b/src/hotspot/share/jfr/recorder/repository/jfrEmergencyDump.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2018, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -39,7 +39,7 @@ class JfrEmergencyDump : AllStatic {\n   static const char* chunk_path(const char* repository_path);\n   static void on_vm_error(const char* repository_path);\n   static void on_vm_error_report(outputStream* st, const char* repository_path);\n-  static void on_vm_shutdown(bool emit_old_object_samples, bool emit_event_shutdown);\n+  static void on_vm_shutdown(bool exception_handler, bool oom);\n };\n \n #endif // SHARE_JFR_RECORDER_REPOSITORY_JFREMERGENCYDUMP_HPP\ndiff --git a/src/hotspot/share/jfr/recorder/service/jfrPostBox.cpp b/src/hotspot/share/jfr/recorder/service/jfrPostBox.cpp\nindex a9ba456ad..6db7a42ab 100644\n--- a/src/hotspot/share/jfr/recorder/service/jfrPostBox.cpp\n+++ b/src/hotspot/share/jfr/recorder/service/jfrPostBox.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2013, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -34,7 +34,8 @@\n                              (MSGBIT(MSG_START))  |          \\\n                              (MSGBIT(MSG_CLONE_IN_MEMORY)) | \\\n                              (MSGBIT(MSG_VM_ERROR))        | \\\n-                             (MSGBIT(MSG_FLUSHPOINT))        \\\n+                             (MSGBIT(MSG_FLUSHPOINT))      | \\\n+                             (MSGBIT(MSG_EMIT_LEAKP_REFCHAINS)) \\\n                            )\n \n static JfrPostBox* _instance \u003d nullptr;\n@@ -165,7 +166,7 @@ void JfrPostBox::notify_waiters() {\n   assert(JfrMsg_lock-\u003eowned_by_self(), \"incrementing _msg_handled_serial is protected by JfrMsg_lock.\");\n   // Update made visible on release of JfrMsg_lock via fence instruction in Monitor::IUnlock.\n   ++_msg_handled_serial;\n-  JfrMsg_lock-\u003enotify();\n+  JfrMsg_lock-\u003enotify_all();\n }\n \n // safeguard to ensure no threads are left waiting\ndiff --git a/src/hotspot/share/jfr/recorder/service/jfrPostBox.hpp b/src/hotspot/share/jfr/recorder/service/jfrPostBox.hpp\nindex 104572616..92f70b1dc 100644\n--- a/src/hotspot/share/jfr/recorder/service/jfrPostBox.hpp\n+++ b/src/hotspot/share/jfr/recorder/service/jfrPostBox.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2013, 2020, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -43,6 +43,7 @@ enum JFR_Msg {\n   MSG_SHUTDOWN,\n   MSG_VM_ERROR,\n   MSG_FLUSHPOINT,\n+  MSG_EMIT_LEAKP_REFCHAINS,\n   MSG_NO_OF_MSGS\n };\n \n@@ -51,23 +52,25 @@ enum JFR_Msg {\n  *\n  *  Synchronous messages (posting thread waits for message completion):\n  *\n- *  MSG_CLONE_IN_MEMORY (0) ; MSGBIT(MSG_CLONE_IN_MEMORY) \u003d\u003d (1 \u003c\u003c 0) \u003d\u003d 0x1\n- *  MSG_START(1)            ; MSGBIT(MSG_START) \u003d\u003d (1 \u003c\u003c 0x1) \u003d\u003d 0x2\n- *  MSG_STOP (2)            ; MSGBIT(MSG_STOP) \u003d\u003d (1 \u003c\u003c 0x2) \u003d\u003d 0x4\n- *  MSG_ROTATE (3)          ; MSGBIT(MSG_ROTATE) \u003d\u003d (1 \u003c\u003c 0x3) \u003d\u003d 0x8\n- *  MSG_VM_ERROR (8)        ; MSGBIT(MSG_VM_ERROR) \u003d\u003d (1 \u003c\u003c 0x8) \u003d\u003d 0x100\n- *  MSG_FLUSHPOINT (9)     ; MSGBIT(MSG_FLUSHPOINT) \u003d\u003d (1 \u003c\u003c 0x9) \u003d\u003d 0x200\n+ *  MSG_CLONE_IN_MEMORY (0)      ; MSGBIT(MSG_CLONE_IN_MEMORY) \u003d\u003d (1 \u003c\u003c 0) \u003d\u003d 0x1\n+ *  MSG_START(1)                 ; MSGBIT(MSG_START) \u003d\u003d (1 \u003c\u003c 0x1) \u003d\u003d 0x2\n+ *  MSG_STOP (2)                 ; MSGBIT(MSG_STOP) \u003d\u003d (1 \u003c\u003c 0x2) \u003d\u003d 0x4\n+ *  MSG_ROTATE (3)               ; MSGBIT(MSG_ROTATE) \u003d\u003d (1 \u003c\u003c 0x3) \u003d\u003d 0x8\n+ *  MSG_VM_ERROR (8)             ; MSGBIT(MSG_VM_ERROR) \u003d\u003d (1 \u003c\u003c 0x8) \u003d\u003d 0x100\n+ *  MSG_FLUSHPOINT (9)           ; MSGBIT(MSG_FLUSHPOINT) \u003d\u003d (1 \u003c\u003c 0x9) \u003d\u003d 0x200\n+ *  MSG_EMIT_LEAKP_REFCHAINS (10); MSGBIT(MSG_EMIT_LEAKP_REFCHAINS) \u003d\u003d (1 \u003c\u003c 0xa) \u003d\u003d 0x400\n  *\n  *  Asynchronous messages (posting thread returns immediately upon deposit):\n  *\n- *  MSG_FULLBUFFER (4)      ; MSGBIT(MSG_FULLBUFFER) \u003d\u003d (1 \u003c\u003c 0x4) \u003d\u003d 0x10\n- *  MSG_CHECKPOINT (5)      ; MSGBIT(CHECKPOINT) \u003d\u003d (1 \u003c\u003c 0x5) \u003d\u003d 0x20\n- *  MSG_WAKEUP (6)          ; MSGBIT(WAKEUP) \u003d\u003d (1 \u003c\u003c 0x6) \u003d\u003d 0x40\n- *  MSG_SHUTDOWN (7)        ; MSGBIT(MSG_SHUTDOWN) \u003d\u003d (1 \u003c\u003c 0x7) \u003d\u003d 0x80\n+ *  MSG_FULLBUFFER (4)           ; MSGBIT(MSG_FULLBUFFER) \u003d\u003d (1 \u003c\u003c 0x4) \u003d\u003d 0x10\n+ *  MSG_CHECKPOINT (5)           ; MSGBIT(CHECKPOINT) \u003d\u003d (1 \u003c\u003c 0x5) \u003d\u003d 0x20\n+ *  MSG_WAKEUP (6)               ; MSGBIT(WAKEUP) \u003d\u003d (1 \u003c\u003c 0x6) \u003d\u003d 0x40\n+ *  MSG_SHUTDOWN (7)             ; MSGBIT(MSG_SHUTDOWN) \u003d\u003d (1 \u003c\u003c 0x7) \u003d\u003d 0x80\n  */\n \n class JfrPostBox : public JfrCHeapObj {\n   friend class JfrRecorder;\n+  friend class JfrRecorderService;\n  public:\n   void post(JFR_Msg msg);\n \ndiff --git a/src/hotspot/share/jfr/recorder/service/jfrRecorderService.cpp b/src/hotspot/share/jfr/recorder/service/jfrRecorderService.cpp\nindex 08250a1ae..6f8d44fb1 100644\n--- a/src/hotspot/share/jfr/recorder/service/jfrRecorderService.cpp\n+++ b/src/hotspot/share/jfr/recorder/service/jfrRecorderService.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2016, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -55,6 +55,7 @@\n #include \"runtime/safepoint.hpp\"\n #include \"runtime/vmOperations.hpp\"\n #include \"runtime/vmThread.hpp\"\n+#include \"utilities/growableArray.hpp\"\n \n // incremented on each flushpoint\n static u8 flushpoint_id \u003d 0;\n@@ -391,6 +392,7 @@ class JfrSafepointWriteVMOperation : public VM_Operation {\n JfrRecorderService::JfrRecorderService() :\n   _checkpoint_manager(JfrCheckpointManager::instance()),\n   _chunkwriter(JfrRepository::chunkwriter()),\n+  _post_box(JfrPostBox::instance()),\n   _repository(JfrRepository::instance()),\n   _stack_trace_repository(JfrStackTraceRepository::instance()),\n   _storage(JfrStorage::instance()),\n@@ -670,17 +672,173 @@ void JfrRecorderService::evaluate_chunk_size_for_rotation() {\n   JfrChunkRotation::evaluate(_chunkwriter);\n }\n \n-void JfrRecorderService::emit_leakprofiler_events(int64_t cutoff_ticks, bool emit_all, bool skip_bfs) {\n-  DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(JavaThread::current()));\n-  // Take the rotation lock to exclude flush() during event emits. This is because event emit\n-  // also creates a number checkpoint events. Those checkpoint events require a future typeset checkpoint\n-  // event for completeness, i.e. to be generated before being flushed to a segment.\n+// LeakProfiler event serialization support.\n+\n+struct JfrLeakProfilerEmitRequest {\n+  int64_t cutoff_ticks;\n+  bool emit_all;\n+  bool skip_bfs;\n+  bool oom;\n+};\n+\n+typedef GrowableArrayCHeap\u003cJfrLeakProfilerEmitRequest, mtTracing\u003e JfrLeakProfilerEmitRequestQueue;\n+static JfrLeakProfilerEmitRequestQueue* _queue \u003d nullptr;\n+constexpr const static int64_t _no_path_to_gc_roots \u003d 0;\n+static bool _oom_emit_request_posted \u003d false;\n+static bool _oom_emit_request_delivered \u003d false;\n+\n+static inline bool exclude_paths_to_gc_roots(int64_t cutoff_ticks) {\n+  return cutoff_ticks \u003c\u003d _no_path_to_gc_roots;\n+}\n+\n+static void enqueue(const JfrLeakProfilerEmitRequest\u0026 request) {\n+  assert(JfrRotationLock::is_owner(), \"invariant\");\n+  if (_queue \u003d\u003d nullptr) {\n+    _queue \u003d new JfrLeakProfilerEmitRequestQueue(4);\n+  }\n+  assert(_queue !\u003d nullptr, \"invariant\");\n+  assert(!_oom_emit_request_posted, \"invariant\");\n+  if (request.oom) {\n+    _oom_emit_request_posted \u003d true;\n+  }\n+  _queue-\u003eappend(request);\n+}\n+\n+static JfrLeakProfilerEmitRequest dequeue() {\n+  assert(JfrRotationLock::is_owner(), \"invariant\");\n+  assert(_queue !\u003d nullptr, \"invariant\");\n+  assert(_queue-\u003eis_nonempty(), \"invariant\");\n+  const JfrLeakProfilerEmitRequest\u0026 request \u003d _queue-\u003efirst();\n+  _queue-\u003eremove_at(0);\n+  return request;\n+}\n+\n+// This version of emit excludes path-to-gc-roots, i.e. it skips reference chains.\n+static void emit_leakprofiler_events(bool emit_all, bool skip_bfs, JavaThread* jt) {\n+  assert(jt !\u003d nullptr, \"invariant\");\n+  DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(jt));\n+  // Take the rotation lock to exclude flush() during event emits. This is because the event emit operation\n+  // also creates a number of checkpoint events. Those checkpoint events require a future typeset checkpoint\n+  // event for completeness, i.e., to be generated before being flushed to a segment.\n   // The upcoming flush() or rotation() after event emit completes this typeset checkpoint\n-  // and serializes all event emit checkpoint events to the same segment.\n+  // and serializes all checkpoint events to the same segment.\n   JfrRotationLock lock;\n+  // Take the rotation lock before the thread transition, to avoid blocking safepoints.\n+  if (_oom_emit_request_posted) {\n+    // A request to emit leakprofiler events in response to CrashOnOutOfMemoryError\n+    // is pending or has already been completed. We are about to crash at any time now.\n+    assert(CrashOnOutOfMemoryError, \"invariant\");\n+    return;\n+  }\n+  MACOS_AARCH64_ONLY(ThreadWXEnable __wx(WXWrite, jt));\n+  ThreadInVMfromNative transition(jt);\n+  // Since we are not requesting path-to-gc-roots, i.e., reference chains, we need not issue a VM_Operation.\n+  // Therefore, we can let the requesting thread process the request directly, since it already holds the requisite lock.\n+  LeakProfiler::emit_events(_no_path_to_gc_roots, emit_all, skip_bfs);\n+}\n+\n+void JfrRecorderService::transition_and_post_leakprofiler_emit_msg(JavaThread* jt) {\n+  assert(jt !\u003d nullptr, \"invariant\");\n+  DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(jt);)\n+  assert(!JfrRotationLock::is_owner(), \"invariant\");\n+  // Transition to _thread_in_VM and post a synchronous message to the JFR Recorder Thread\n+  // for it to process our enqueued request, which includes paths-to-gc-roots, i.e., reference chains.\n+  MACOS_AARCH64_ONLY(ThreadWXEnable __wx(WXWrite, jt));\n+  ThreadInVMfromNative transition(jt);\n+  _post_box.post(MSG_EMIT_LEAKP_REFCHAINS);\n+}\n+\n+// This version of emit includes path-to-gc-roots, i.e., it includes in the request traversing of reference chains.\n+// Traversing reference chains is performed as part of a VM_Operation, and we initiate it from the JFR Recorder Thread.\n+// Because multiple threads can concurrently report_on_java_out_of_memory(), having them all post a synchronous JFR msg,\n+// they rendezvous at a safepoint in a convenient state, ThreadBlockInVM. This mechanism prevents any thread from racing past\n+// this point and begin executing VMError::report_and_die(), until at least one oom request has been delivered.\n+void JfrRecorderService::emit_leakprofiler_events_paths_to_gc_roots(int64_t cutoff_ticks,\n+                                                                    bool emit_all,\n+                                                                    bool skip_bfs,\n+                                                                    bool oom,\n+                                                                    JavaThread* jt) {\n+  assert(jt !\u003d nullptr, \"invariant\");\n+  DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(jt);)\n+  assert(!exclude_paths_to_gc_roots(cutoff_ticks), \"invariant\");\n+\n+  {\n+    JfrRotationLock lock;\n+    // Take the rotation lock to read and post a request for the JFR Recorder Thread.\n+    if (_oom_emit_request_posted) {\n+      if (!oom) {\n+        // A request to emit leakprofiler events in response to CrashOnOutOfMemoryError\n+        // is pending or has already been completed. We are about to crash at any time now.\n+        assert(CrashOnOutOfMemoryError, \"invariant\");\n+        return;\n+      }\n+    } else {\n+      assert(!_oom_emit_request_posted, \"invariant\");\n+      JfrLeakProfilerEmitRequest request \u003d { cutoff_ticks, emit_all, skip_bfs, oom };\n+      enqueue(request);\n+    }\n+  }\n+  JfrRecorderService service;\n+  service.transition_and_post_leakprofiler_emit_msg(jt);\n+}\n+\n+// Leakprofiler serialization request, the jdk.jfr.internal.JVM.emitOldObjectSamples() Java entry point.\n+void JfrRecorderService::emit_leakprofiler_events(int64_t cutoff_ticks,\n+                                                  bool emit_all,\n+                                                  bool skip_bfs) {\n+  JavaThread* const jt \u003d JavaThread::current();\n+  DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(jt);)\n+  if (exclude_paths_to_gc_roots(cutoff_ticks)) {\n+    ::emit_leakprofiler_events(emit_all, skip_bfs, jt);\n+    return;\n+  }\n+  emit_leakprofiler_events_paths_to_gc_roots(cutoff_ticks, emit_all, skip_bfs, /* oom */ false, jt);\n+}\n+\n+// Leakprofiler serialization request, the report_on_java_out_of_memory VM entry point.\n+void JfrRecorderService::emit_leakprofiler_events_on_oom() {\n+  assert(CrashOnOutOfMemoryError, \"invariant\");\n+  if (EventOldObjectSample::is_enabled()) {\n+    JavaThread* const jt \u003d JavaThread::current();\n+    DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_vm(jt);)\n+    ThreadToNativeFromVM transition(jt);\n+    emit_leakprofiler_events_paths_to_gc_roots(max_jlong, false, false, /* oom */ true, jt);\n+  }\n+}\n+\n+// The worker routine for the JFR Recorder Thread when processing MSG_EMIT_LEAKP_REFCHAINS messages.\n+void JfrRecorderService::emit_leakprofiler_events() {\n+  JavaThread* const jt \u003d JavaThread::current();\n+  DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(jt));\n   // Take the rotation lock before the transition.\n-  JavaThread* current_thread \u003d JavaThread::current();\n-  MACOS_AARCH64_ONLY(ThreadWXEnable __wx(WXWrite, current_thread));\n-  ThreadInVMfromNative transition(current_thread);\n-  LeakProfiler::emit_events(cutoff_ticks, emit_all, skip_bfs);\n+  JfrRotationLock lock;\n+  if (_oom_emit_request_delivered) {\n+    // A request to emit leakprofiler events in response to CrashOnOutOfMemoryError\n+    // has already been completed. We are about to crash at any time now.\n+    assert(_oom_emit_request_posted, \"invariant\");\n+    assert(CrashOnOutOfMemoryError, \"invariant\");\n+    return;\n+  }\n+\n+  assert(_queue-\u003eis_nonempty(), \"invariant\");\n+\n+  {\n+    MACOS_AARCH64_ONLY(ThreadWXEnable __wx(WXWrite, jt));\n+    ThreadInVMfromNative transition(jt);\n+    while (_queue-\u003eis_nonempty()) {\n+      const JfrLeakProfilerEmitRequest\u0026 request \u003d dequeue();\n+      LeakProfiler::emit_events(request.cutoff_ticks, request.emit_all, request.skip_bfs);\n+      if (_oom_emit_request_posted \u0026\u0026 request.oom) {\n+        assert(CrashOnOutOfMemoryError, \"invariant\");\n+        _oom_emit_request_delivered \u003d true;\n+        break;\n+      }\n+    }\n+  }\n+\n+  // If processing involved an out-of-memory request, issue an immediate flush operation.\n+  DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(jt));\n+  if (_chunkwriter.is_valid() \u0026\u0026 _oom_emit_request_delivered) {\n+    invoke_flush();\n+  }\n }\ndiff --git a/src/hotspot/share/jfr/recorder/service/jfrRecorderService.hpp b/src/hotspot/share/jfr/recorder/service/jfrRecorderService.hpp\nindex e5b4500af..3759ff988 100644\n--- a/src/hotspot/share/jfr/recorder/service/jfrRecorderService.hpp\n+++ b/src/hotspot/share/jfr/recorder/service/jfrRecorderService.hpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2016, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -27,19 +27,23 @@\n \n #include \"jfr/utilities/jfrAllocation.hpp\"\n \n+class JavaThread;\n class JfrCheckpointManager;\n class JfrChunkWriter;\n+class JfrPostBox;\n class JfrRepository;\n class JfrStackTraceRepository;\n class JfrStorage;\n class JfrStringPool;\n \n class JfrRecorderService : public StackObj {\n+  friend class Jfr;\n   friend class JfrSafepointClearVMOperation;\n   friend class JfrSafepointWriteVMOperation;\n  private:\n   JfrCheckpointManager\u0026 _checkpoint_manager;\n   JfrChunkWriter\u0026 _chunkwriter;\n+  JfrPostBox\u0026 _post_box;\n   JfrRepository\u0026 _repository;\n   JfrStackTraceRepository\u0026 _stack_trace_repository;\n   JfrStorage\u0026 _storage;\n@@ -64,6 +68,14 @@ class JfrRecorderService : public StackObj {\n   void invoke_safepoint_write();\n   void post_safepoint_write();\n \n+  void transition_and_post_leakprofiler_emit_msg(JavaThread* jt);\n+\n+  static void emit_leakprofiler_events_on_oom();\n+  static void emit_leakprofiler_events_paths_to_gc_roots(int64_t cutoff_ticks,\n+                                                         bool emit_all,\n+                                                         bool skip_bfs,\n+                                                         bool oom,\n+                                                         JavaThread* jt);\n  public:\n   JfrRecorderService();\n   void start();\n@@ -72,8 +84,12 @@ class JfrRecorderService : public StackObj {\n   void flushpoint();\n   void process_full_buffers();\n   void evaluate_chunk_size_for_rotation();\n-  void emit_leakprofiler_events(int64_t cutoff_ticks, bool emit_all, bool skip_bfs);\n+  void emit_leakprofiler_events();\n+\n   static bool is_recording();\n+  static void emit_leakprofiler_events(int64_t cutoff_ticks,\n+                                       bool emit_all,\n+                                       bool skip_bfs);\n };\n \n #endif // SHARE_JFR_RECORDER_SERVICE_JFRRECORDERSERVICE_HPP\ndiff --git a/src/hotspot/share/jfr/recorder/service/jfrRecorderThreadLoop.cpp b/src/hotspot/share/jfr/recorder/service/jfrRecorderThreadLoop.cpp\nindex de015e9a5..bd01adf5b 100644\n--- a/src/hotspot/share/jfr/recorder/service/jfrRecorderThreadLoop.cpp\n+++ b/src/hotspot/share/jfr/recorder/service/jfrRecorderThreadLoop.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2012, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -44,6 +44,7 @@ void recorderthread_entry(JavaThread* thread, JavaThread* unused) {\n   #define ROTATE (msgs \u0026 (MSGBIT(MSG_ROTATE)|MSGBIT(MSG_STOP)))\n   #define FLUSHPOINT (msgs \u0026 (MSGBIT(MSG_FLUSHPOINT)))\n   #define PROCESS_FULL_BUFFERS (msgs \u0026 (MSGBIT(MSG_ROTATE)|MSGBIT(MSG_STOP)|MSGBIT(MSG_FULLBUFFER)))\n+  #define LEAKPROFILER_REFCHAINS (msgs \u0026 MSGBIT(MSG_EMIT_LEAKP_REFCHAINS))\n \n   JfrPostBox\u0026 post_box \u003d JfrRecorderThreadEntry::post_box();\n   log_debug(jfr, system)(\"Recorder thread STARTED\");\n@@ -70,6 +71,9 @@ void recorderthread_entry(JavaThread* thread, JavaThread* unused) {\n         if (PROCESS_FULL_BUFFERS) {\n           service.process_full_buffers();\n         }\n+        if (LEAKPROFILER_REFCHAINS) {\n+          service.emit_leakprofiler_events();\n+        }\n         // Check amount of data written to chunk already\n         // if it warrants asking for a new chunk.\n         service.evaluate_chunk_size_for_rotation();\n@@ -98,5 +102,5 @@ void recorderthread_entry(JavaThread* thread, JavaThread* unused) {\n   #undef ROTATE\n   #undef FLUSHPOINT\n   #undef PROCESS_FULL_BUFFERS\n-  #undef SCAVENGE\n+  #undef LEAKPROFILER_REFCHAINS\n }\ndiff --git a/src/hotspot/share/runtime/java.cpp b/src/hotspot/share/runtime/java.cpp\nindex c49a9f5d4..ee4f776df 100644\n--- a/src/hotspot/share/runtime/java.cpp\n+++ b/src/hotspot/share/runtime/java.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1997, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -466,10 +466,7 @@ void before_exit(JavaThread* thread, bool halt) {\n     event.commit();\n   }\n \n-  // 2nd argument (emit_event_shutdown) should be set to false\n-  // because EventShutdown would be emitted at Threads::destroy_vm().\n-  // (one of the callers of before_exit())\n-  JFR_ONLY(Jfr::on_vm_shutdown(true, false, halt);)\n+  JFR_ONLY(Jfr::on_vm_shutdown(false, halt);)\n \n   // Stop the WatcherThread. We do this before disenrolling various\n   // PeriodicTasks to reduce the likelihood of races.\ndiff --git a/src/hotspot/share/utilities/debug.cpp b/src/hotspot/share/utilities/debug.cpp\nindex de39fe32d..9e1671412 100644\n--- a/src/hotspot/share/utilities/debug.cpp\n+++ b/src/hotspot/share/utilities/debug.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1997, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -63,6 +63,9 @@\n #include \"utilities/nativeStackPrinter.hpp\"\n #include \"utilities/unsigned5.hpp\"\n #include \"utilities/vmError.hpp\"\n+#if INCLUDE_JFR\n+#include \"jfr/jfr.hpp\"\n+#endif\n \n #include \u003cstdarg.h\u003e\n #include \u003cstdio.h\u003e\n@@ -262,6 +265,8 @@ void report_untested(const char* file, int line, const char* message) {\n void report_java_out_of_memory(const char* message) {\n   static int out_of_memory_reported \u003d 0;\n \n+  JFR_ONLY(Jfr::on_report_java_out_of_memory();)\n+\n   // A number of threads may attempt to report OutOfMemoryError at around the\n   // same time. To avoid dumping the heap or executing the data collection\n   // commands multiple times we just do it once when the first threads reports\ndiff --git a/src/hotspot/share/utilities/vmError.cpp b/src/hotspot/share/utilities/vmError.cpp\nindex a290602e0..88f81b312 100644\n--- a/src/hotspot/share/utilities/vmError.cpp\n+++ b/src/hotspot/share/utilities/vmError.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2003, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2026, Oracle and/or its affiliates. All rights reserved.\n  * Copyright (c) 2017, 2024 SAP SE. All rights reserved.\n  * Copyright (c) 2023, 2025, Red Hat, Inc. and/or its affiliates.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n@@ -1898,7 +1898,7 @@ void VMError::report_and_die(int id, const char* message, const char* detail_fmt\n     log.set_fd(-1);\n   }\n \n-  JFR_ONLY(Jfr::on_vm_shutdown(static_cast\u003cVMErrorType\u003e(_id) \u003d\u003d OOM_JAVA_HEAP_FATAL, true);)\n+  JFR_ONLY(Jfr::on_vm_shutdown(true, false, static_cast\u003cVMErrorType\u003e(_id) \u003d\u003d OOM_JAVA_HEAP_FATAL);)\n \n   if (PrintNMTStatistics) {\n     fdStream fds(fd_out);\ndiff --git a/test/jdk/ProblemList.txt b/test/jdk/ProblemList.txt\nindex 9cfc23ea8..291b2163b 100644\n--- a/test/jdk/ProblemList.txt\n+++ b/test/jdk/ProblemList.txt\n@@ -710,7 +710,6 @@ jdk/incubator/vector/LoadJsvmlTest.java                         8305390 windows-\n # jdk_jfr\n \n jdk/jfr/event/compiler/TestCodeSweeper.java                     8338127 generic-all\n-jdk/jfr/event/oldobject/TestEmergencyDumpAtOOM.java             8371014 aix-ppc64,linux-ppc64le\n jdk/jfr/event/oldobject/TestShenandoah.java                     8342951 generic-all\n jdk/jfr/event/runtime/TestResidentSetSizeEvent.java             8309846 aix-ppc64\n jdk/jfr/jvm/TestWaste.java                                      8371630 generic-all\ndiff --git a/test/jdk/jdk/jfr/event/oldobject/TestEmergencyDumpAtOOM.java b/test/jdk/jdk/jfr/event/oldobject/TestEmergencyDumpAtOOM.java\nindex d540acd85..b3630fa7f 100644\n--- a/test/jdk/jdk/jfr/event/oldobject/TestEmergencyDumpAtOOM.java\n+++ b/test/jdk/jdk/jfr/event/oldobject/TestEmergencyDumpAtOOM.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2026, Oracle and/or its affiliates. All rights reserved.\n  * Copyright (c) 2025, NTT DATA.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n@@ -98,8 +98,8 @@ private static void test(boolean shouldCrash) throws Exception {\n             // Check OldObjectSample events\n             if (oldObjects.get() \u003e 0L) {\n                 if (shouldCrash) {\n-                    Asserts.assertEquals(\"VM Error\", shutdownReason.get());\n-                    Asserts.assertEquals(\"Out of Memory\", dumpReason.get());\n+                    Asserts.assertEquals(\"CrashOnOutOfMemoryError\", shutdownReason.get());\n+                    Asserts.assertEquals(\"CrashOnOutOfMemoryError\", dumpReason.get());\n                 } else {\n                     Asserts.assertEquals(\"No remaining non-daemon Java threads\", shutdownReason.get());\n                 }","expectedMessage":"8371014: Dump JFR recording on CrashOnOutOfMemoryError is incorrectly implemented","repository":"jdk","commitHash":"f23752a75ee3d3af0853eff9c678d2496bb1cf58","metadata":{"author":"Markus Grnlund \u003cmgronlun@openjdk.org\u003e"}}
{"id":"jdk-07403843","diff":" .../native/libjsound/PLATFORM_API_MacOSX_PCM.cpp   |  7 ++--\n .../classes/com/sun/media/sound/Platform.java      | 17 ++-------\n src/java.desktop/share/native/libjsound/Platform.c | 43 ----------------------\n .../share/native/libjsound/Utilities.c             | 11 +-----\n .../share/native/libjsound/Utilities.h             |  6 +--\n 5 files changed, 8 insertions(+), 76 deletions(-)\n\ndiff --git a/src/java.desktop/macosx/native/libjsound/PLATFORM_API_MacOSX_PCM.cpp b/src/java.desktop/macosx/native/libjsound/PLATFORM_API_MacOSX_PCM.cpp\nindex 441a71f5c..bae16cb0a 100644\n--- a/src/java.desktop/macosx/native/libjsound/PLATFORM_API_MacOSX_PCM.cpp\n+++ b/src/java.desktop/macosx/native/libjsound/PLATFORM_API_MacOSX_PCM.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -162,8 +162,7 @@ void DAUDIO_GetFormats(INT32 mixerIndex, INT32 deviceID, int isSource, void* cre\n                 sampleRate,                 // sample rate\n                 DAUDIO_PCM,                 // only accept PCM\n                 bits \u003d\u003d 8 ? FALSE : TRUE,   // signed\n-                bits \u003d\u003d 8 ? FALSE           // little-endian for 8bit\n-                    : UTIL_IsBigEndianPlatform());\n+                FALSE);                     // all supported macOS versions run on LE\n         }\n     }\n     // add default format\n@@ -175,7 +174,7 @@ void DAUDIO_GetFormats(INT32 mixerIndex, INT32 deviceID, int isSource, void* cre\n             defSampleRate,                  // sample rate\n             DAUDIO_PCM,                     // PCM\n             TRUE,                           // signed\n-            UTIL_IsBigEndianPlatform());    // native endianness\n+            FALSE);                         // native endianness; all supported macOS versions run on LE\n     }\n \n     TRACE0(\"\u003c\u003cDAUDIO_GetFormats\\n\");\ndiff --git a/src/java.desktop/share/classes/com/sun/media/sound/Platform.java b/src/java.desktop/share/classes/com/sun/media/sound/Platform.java\nindex ba03798f1..a0db2a421 100644\n--- a/src/java.desktop/share/classes/com/sun/media/sound/Platform.java\n+++ b/src/java.desktop/share/classes/com/sun/media/sound/Platform.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1999, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -25,6 +25,7 @@\n \n package com.sun.media.sound;\n \n+import java.nio.ByteOrder;\n import java.util.StringTokenizer;\n \n /**\n@@ -40,12 +41,6 @@ final class Platform {\n \n     private static boolean isNativeLibLoaded;\n \n-    // SYSTEM CHARACTERISTICS\n-    // vary according to hardware architecture\n-\n-    // intel is little-endian.  sparc is big-endian.\n-    private static boolean bigEndian;\n-\n     static {\n         loadLibraries();\n     }\n@@ -66,7 +61,7 @@ static void initialize() {\n      * Determine whether the system is big-endian.\n      */\n     static boolean isBigEndian() {\n-        return bigEndian;\n+        return ByteOrder.nativeOrder().equals(ByteOrder.BIG_ENDIAN);\n     }\n \n     /**\n@@ -82,9 +77,6 @@ private static void loadLibraries() {\n             if (Printer.err) Printer.err(\"Couldn\u0027t load library \"+libName+\": \"+t.toString());\n             isNativeLibLoaded \u003d false;\n         }\n-        if (isNativeLibLoaded) {\n-            bigEndian \u003d nIsBigEndian();\n-        }\n     }\n \n     static boolean isMidiIOEnabled() {\n@@ -98,7 +90,4 @@ static boolean isPortsEnabled() {\n     static boolean isDirectAudioEnabled() {\n         return isNativeLibLoaded;\n     }\n-\n-    // the following native method is implemented in Platform.c\n-    private static native boolean nIsBigEndian();\n }\ndiff --git a/src/java.desktop/share/native/libjsound/Platform.c b/src/java.desktop/share/native/libjsound/Platform.c\ndeleted file mode 100644\nindex ecb389c89..000000000\n--- a/src/java.desktop/share/native/libjsound/Platform.c\n+++ /dev/null\n@@ -1,43 +0,0 @@\n-/*\n- * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.  Oracle designates this\n- * particular file as subject to the \"Classpath\" exception as provided\n- * by Oracle in the LICENSE file that accompanied this code.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- */\n-\n-\n-#include \"Utilities.h\"\n-// Platform.java includes\n-#include \"com_sun_media_sound_Platform.h\"\n-\n-/*\n- * Declare library specific JNI_Onload entry if static build\n- */\n-DEF_STATIC_JNI_OnLoad\n-\n-/*\n- * Class:     com_sun_media_sound_Platform\n- * Method:    nIsBigEndian\n- * Signature: ()Z\n- */\n-JNIEXPORT jboolean JNICALL Java_com_sun_media_sound_Platform_nIsBigEndian(JNIEnv *env, jclass clss) {\n-    return UTIL_IsBigEndianPlatform();\n-}\ndiff --git a/src/java.desktop/share/native/libjsound/Utilities.c b/src/java.desktop/share/native/libjsound/Utilities.c\nindex 6e92813d5..50ca18c02 100644\n--- a/src/java.desktop/share/native/libjsound/Utilities.c\n+++ b/src/java.desktop/share/native/libjsound/Utilities.c\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1998, 2007, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -26,15 +26,6 @@\n \n #include \"Utilities.h\"\n \n-\n-int UTIL_IsBigEndianPlatform() {\n-#ifdef _LITTLE_ENDIAN\n-    return 0;\n-#else\n-    return 1;\n-#endif\n-}\n-\n void ThrowJavaMessageException(JNIEnv *e, const char *exClass, const char *msg) {\n     jclass newExcCls;\n \ndiff --git a/src/java.desktop/share/native/libjsound/Utilities.h b/src/java.desktop/share/native/libjsound/Utilities.h\nindex fbecab1e0..7cb0dcbdd 100644\n--- a/src/java.desktop/share/native/libjsound/Utilities.h\n+++ b/src/java.desktop/share/native/libjsound/Utilities.h\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1998, 2015, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -28,10 +28,6 @@\n #include \"SoundDefs.h\"\n #include \"Configure.h\"          // put flags for debug msgs etc. here\n \n-// return 1 if this platform is big endian, or 0 for little endian\n-int UTIL_IsBigEndianPlatform();\n-\n-\n // ERROR PRINTS\n #ifdef USE_ERROR\n #define ERROR0(string)                        { fprintf(stdout, (string)); fflush(stdout); }","expectedMessage":"8374727: Audio configuration Platform class - use nio for getting endianness of the underlying platform","repository":"jdk","commitHash":"074038438f5b8b91e9390430b4fa58ff53e5df26","metadata":{"author":"Matthias Baesken \u003cmbaesken@openjdk.org\u003e"}}
{"id":"jdk-7f707ba8","diff":" .../classes/sun/awt/image/XbmImageDecoder.java     | 130 +++++++++++++--------\n .../java/awt/image/XBMDecoder/XBMDecoderTest.java  |  28 ++++-\n .../java/awt/image/XBMDecoder/invalid_empty.xbm    |   6 +\n test/jdk/java/awt/image/XBMDecoder/invalid_hex.xbm |   4 +-\n .../jdk/java/awt/image/XBMDecoder/invalid_plus.xbm |   3 +\n .../java/awt/image/XBMDecoder/valid_multiline.xbm  |   8 ++\n 6 files changed, 124 insertions(+), 55 deletions(-)\n\ndiff --git a/src/java.desktop/share/classes/sun/awt/image/XbmImageDecoder.java b/src/java.desktop/share/classes/sun/awt/image/XbmImageDecoder.java\nindex cac9f8baa..bc025b87f 100644\n--- a/src/java.desktop/share/classes/sun/awt/image/XbmImageDecoder.java\n+++ b/src/java.desktop/share/classes/sun/awt/image/XbmImageDecoder.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1995, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1995, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -92,8 +92,8 @@ public void produceImage() throws IOException, ImageFormatException {\n         byte[] raster \u003d null;\n         IndexColorModel model \u003d null;\n \n-        String matchRegex \u003d \"(0[xX])?[0-9a-fA-F]+[\\\\s+]?[,|};]\";\n-        String replaceRegex \u003d \"(0[xX])|,|[\\\\s+]|[};]\";\n+        String matchRegex \u003d \"\\\\s*(0[xX])?((?:(?!,|\\\\};).)+)(,|\\\\};)\";\n+        String replaceRegex \u003d \"0[xX]|,|\\\\s+|\\\\};\";\n \n         String line;\n         int lineNum \u003d 0;\n@@ -111,11 +111,19 @@ public void produceImage() throws IOException, ImageFormatException {\n                     }\n                     try {\n                         if (!token[2].isBlank() \u0026\u0026 state \u003d\u003d 0) {\n-                            W \u003d Integer.parseInt(token[2]);\n-                            state \u003d 1; // after width is set\n+                            if (token[1].endsWith(\"th\")) {\n+                                W \u003d Integer.parseInt(token[2]);\n+                            } else if (token[1].endsWith(\"t\")) {\n+                                H \u003d Integer.parseInt(token[2]);\n+                            }\n+                            state \u003d 1; // after first dimension is set\n                         } else if (!token[2].isBlank() \u0026\u0026 state \u003d\u003d 1) {\n-                            H \u003d Integer.parseInt(token[2]);\n-                            state \u003d 2; // after height is set\n+                            if (token[1].endsWith(\"th\")) {\n+                                W \u003d Integer.parseInt(token[2]);\n+                            } else if (token[1].endsWith(\"t\")) {\n+                                H \u003d Integer.parseInt(token[2]);\n+                            }\n+                            state \u003d 2; // after second dimension is set\n                         }\n                     } catch (NumberFormatException nfe) {\n                         // parseInt() can throw NFE\n@@ -147,58 +155,80 @@ public void produceImage() throws IOException, ImageFormatException {\n                 error(\"Width or Height of XBM file not defined\");\n             }\n \n+            boolean contFlag \u003d false;\n+            StringBuilder sb \u003d new StringBuilder();\n+\n             // loop to process image data\n             while (!aborted \u0026\u0026 (line \u003d br.readLine()) !\u003d null) {\n                 lineNum++;\n \n-                if (line.contains(\"[]\")) {\n-                    Matcher matcher \u003d Pattern.compile(matchRegex).matcher(line);\n-                    while (matcher.find()) {\n-                        if (y \u003e\u003d H) {\n-                            error(\"Scan size of XBM file exceeds\"\n-                                    + \" the defined width x height\");\n-                        }\n+                if (!contFlag) {\n+                    if (line.contains(\"[]\")) {\n+                        contFlag \u003d true;\n+                    } else {\n+                        continue;\n+                    }\n+                }\n \n-                        int startIndex \u003d matcher.start();\n-                        int endIndex \u003d matcher.end();\n-                        String hexByte \u003d line.substring(startIndex, endIndex);\n+                int end \u003d line.indexOf(\u0027;\u0027);\n+                if (end \u003e\u003d 0) {\n+                    sb.append(line, 0, end + 1);\n+                    break;\n+                } else {\n+                    sb.append(line).append(System.lineSeparator());\n+                }\n+            }\n \n-                        if (!(hexByte.startsWith(\"0x\")\n-                                || hexByte.startsWith(\"0X\"))) {\n-                            error(\"Invalid hexadecimal number at Ln#:\" + lineNum\n-                                    + \" Col#:\" + (startIndex + 1));\n-                        }\n-                        hexByte \u003d hexByte.replaceAll(replaceRegex, \"\");\n-                        if (hexByte.length() !\u003d 2) {\n-                            error(\"Invalid hexadecimal number at Ln#:\" + lineNum\n-                                    + \" Col#:\" + (startIndex + 1));\n-                        }\n+            String resultLine \u003d sb.toString();\n+            int cutOffIndex \u003d resultLine.indexOf(\u0027{\u0027);\n+            resultLine \u003d resultLine.substring(cutOffIndex + 1);\n \n-                        try {\n-                            n \u003d Integer.parseInt(hexByte, 16);\n-                        } catch (NumberFormatException nfe) {\n-                            error(\"Error parsing hexadecimal at Ln#:\" + lineNum\n-                                    + \" Col#:\" + (startIndex + 1));\n-                        }\n-                        for (int mask \u003d 1; mask \u003c\u003d 0x80; mask \u003c\u003c\u003d 1) {\n-                            if (x \u003c W) {\n-                                if ((n \u0026 mask) !\u003d 0)\n-                                    raster[x] \u003d 1;\n-                                else\n-                                    raster[x] \u003d 0;\n-                            }\n-                            x++;\n-                        }\n+            Matcher matcher \u003d Pattern.compile(matchRegex).matcher(resultLine);\n+            while (matcher.find()) {\n+                if (y \u003e\u003d H) {\n+                    error(\"Scan size of XBM file exceeds\"\n+                            + \" the defined width x height\");\n+                }\n \n-                        if (x \u003e\u003d W) {\n-                            int result \u003d setPixels(0, y, W, 1, model, raster, 0, W);\n-                            if (result \u003c\u003d 0) {\n-                                error(\"Unexpected error occurred during setPixel()\");\n-                            }\n-                            x \u003d 0;\n-                            y++;\n-                        }\n+                int startIndex \u003d matcher.start();\n+                int endIndex \u003d matcher.end();\n+                String hexByte \u003d resultLine.substring(startIndex, endIndex);\n+                hexByte \u003d hexByte.replaceAll(\"^\\\\s+\", \"\");\n+\n+                if (!(hexByte.startsWith(\"0x\")\n+                        || hexByte.startsWith(\"0X\"))) {\n+                    error(\"Invalid hexadecimal number at Ln#:\" + lineNum\n+                            + \" Col#:\" + (startIndex + 1));\n+                }\n+                hexByte \u003d hexByte.replaceAll(replaceRegex, \"\");\n+                if (hexByte.length() !\u003d 2) {\n+                    error(\"Invalid hexadecimal number at Ln#:\" + lineNum\n+                            + \" Col#:\" + (startIndex + 1));\n+                }\n+\n+                try {\n+                    n \u003d Integer.parseInt(hexByte, 16);\n+                } catch (NumberFormatException nfe) {\n+                    error(\"Error parsing hexadecimal at Ln#:\" + lineNum\n+                            + \" Col#:\" + (startIndex + 1));\n+                }\n+                for (int mask \u003d 1; mask \u003c\u003d 0x80; mask \u003c\u003c\u003d 1) {\n+                    if (x \u003c W) {\n+                        if ((n \u0026 mask) !\u003d 0)\n+                            raster[x] \u003d 1;\n+                        else\n+                            raster[x] \u003d 0;\n+                    }\n+                    x++;\n+                }\n+\n+                if (x \u003e\u003d W) {\n+                    int result \u003d setPixels(0, y, W, 1, model, raster, 0, W);\n+                    if (result \u003c\u003d 0) {\n+                        error(\"Unexpected error occurred during setPixel()\");\n                     }\n+                    x \u003d 0;\n+                    y++;\n                 }\n             }\n             imageComplete(ImageConsumer.STATICIMAGEDONE, true);\ndiff --git a/test/jdk/java/awt/image/XBMDecoder/XBMDecoderTest.java b/test/jdk/java/awt/image/XBMDecoder/XBMDecoderTest.java\nindex 19bc6d95c..9694043d1 100644\n--- a/test/jdk/java/awt/image/XBMDecoder/XBMDecoderTest.java\n+++ b/test/jdk/java/awt/image/XBMDecoder/XBMDecoderTest.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -29,10 +29,14 @@\n  * @run main XBMDecoderTest\n  */\n \n+import java.awt.Graphics2D;\n+import java.awt.Image;\n+import java.awt.image.BufferedImage;\n import java.io.ByteArrayOutputStream;\n import java.io.File;\n import java.io.FileInputStream;\n import java.io.PrintStream;\n+import java.util.Arrays;\n import javax.swing.ImageIcon;\n \n public class XBMDecoderTest {\n@@ -57,21 +61,39 @@ public static void main(String[] args) throws Exception {\n \n                 ImageIcon icon \u003d new ImageIcon(fis.readAllBytes());\n                 boolean isErrEmpty \u003d errContent.toString().isEmpty();\n+\n                 if (!isErrEmpty) {\n                     System.out.println(\"Expected ImageFormatException occurred.\");\n                     System.out.print(errContent);\n                 }\n-\n                 if (validCase \u0026\u0026 !isErrEmpty) {\n                     throw new RuntimeException(\"Test failed: Error stream not empty\");\n-                } else if (!validCase \u0026\u0026 isErrEmpty) {\n+                } else if (!validCase \u0026\u0026 isErrEmpty \u0026\u0026 hasPixelData(icon.getImage())) {\n                     throw new RuntimeException(\"Test failed: ImageFormatException\"\n                             + \" expected but not thrown\");\n                 }\n+                if (validCase \u0026\u0026 !hasPixelData(icon.getImage())) {\n+                    throw new RuntimeException(\"Test failed: the parsed image \" +\n+                            \"does not contain any pixel data\");\n+                }\n                 System.out.println(\"PASSED\\n\");\n             } finally {\n                 System.setErr(originalErr);\n             }\n         }\n     }\n+\n+    private static boolean hasPixelData(Image img) {\n+        int w \u003d img.getWidth(null);\n+        int h \u003d img.getHeight(null);\n+        BufferedImage bi \u003d new BufferedImage(w, h, BufferedImage.TYPE_INT_ARGB);\n+        Graphics2D g \u003d bi.createGraphics();\n+        g.drawImage(img, 0, 0, null);\n+        g.dispose();\n+        int[] pixels \u003d bi.getRGB(0, 0, w, h, null, 0, w);\n+        if (Arrays.stream(pixels).allMatch(i -\u003e i \u003d\u003d 0)) {\n+            return false;\n+        }\n+        return true;\n+    }\n }\ndiff --git a/test/jdk/java/awt/image/XBMDecoder/invalid_empty.xbm b/test/jdk/java/awt/image/XBMDecoder/invalid_empty.xbm\nnew file mode 100644\nindex 000000000..5cfb8e21c\n--- /dev/null\n+++ b/test/jdk/java/awt/image/XBMDecoder/invalid_empty.xbm\n@@ -0,0 +1,6 @@\n+#define test_width 16\n+#define test_height 3\n+#define ht_x 1\n+#define ht_y 2\n+static unsigned char test_bits[] \u003d {\n+};\ndiff --git a/test/jdk/java/awt/image/XBMDecoder/invalid_hex.xbm b/test/jdk/java/awt/image/XBMDecoder/invalid_hex.xbm\nindex c6f819582..1286eee1d 100644\n--- a/test/jdk/java/awt/image/XBMDecoder/invalid_hex.xbm\n+++ b/test/jdk/java/awt/image/XBMDecoder/invalid_hex.xbm\n@@ -1,3 +1,3 @@\n-#define k_wt 16\n-#define k_ht  1\n+#define k_width 16\n+#define k_height  1\n k[] \u003d { 0x10, 1234567890};\ndiff --git a/test/jdk/java/awt/image/XBMDecoder/invalid_plus.xbm b/test/jdk/java/awt/image/XBMDecoder/invalid_plus.xbm\nnew file mode 100644\nindex 000000000..714907084\n--- /dev/null\n+++ b/test/jdk/java/awt/image/XBMDecoder/invalid_plus.xbm\n@@ -0,0 +1,3 @@\n+#define test_width 16\n+#define test_height 2\n+static unsigned char test_bits[] \u003d { 0x13, 0x11, 0xAB+, 0xff };\n\\ No newline at end of file\ndiff --git a/test/jdk/java/awt/image/XBMDecoder/valid_multiline.xbm b/test/jdk/java/awt/image/XBMDecoder/valid_multiline.xbm\nnew file mode 100644\nindex 000000000..e24bc10e9\n--- /dev/null\n+++ b/test/jdk/java/awt/image/XBMDecoder/valid_multiline.xbm\n@@ -0,0 +1,8 @@\n+#define test_width 16\n+#define test_height 3\n+#define ht_x 1\n+#define ht_y 2\n+static unsigned char test_bits[] \u003d {\n+0x20, 0x10, \n+0x25, 0x01, \n+0xAC, 0xab };","expectedMessage":"8373727: New XBM images parser regression: only the first line of the bitmap array is parsed","repository":"jdk","commitHash":"7f707ba8e746d859ac171d71ef8f731953a92e6a","metadata":{"author":"Damon Nguyen \u003cdnguyen@openjdk.org\u003e"}}
{"id":"jdk-45990d79","diff":" src/hotspot/cpu/x86/macroAssembler_x86.cpp     | 4 ++--\n test/hotspot/jtreg/compiler/c2/ClearArray.java | 6 ++++--\n 2 files changed, 6 insertions(+), 4 deletions(-)\n\ndiff --git a/src/hotspot/cpu/x86/macroAssembler_x86.cpp b/src/hotspot/cpu/x86/macroAssembler_x86.cpp\nindex be7deb884..7f7bb2c4c 100644\n--- a/src/hotspot/cpu/x86/macroAssembler_x86.cpp\n+++ b/src/hotspot/cpu/x86/macroAssembler_x86.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1997, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -6086,7 +6086,7 @@ void MacroAssembler::generate_fill(BasicType t, bool aligned,\n           vpbroadcastd(xtmp, xtmp, Assembler::AVX_512bit);\n \n           subptr(count, 16 \u003c\u003c shift);\n-          jccb(Assembler::less, L_check_fill_32_bytes);\n+          jcc(Assembler::less, L_check_fill_32_bytes);\n           align(16);\n \n           BIND(L_fill_64_bytes_loop_avx3);\ndiff --git a/test/hotspot/jtreg/compiler/c2/ClearArray.java b/test/hotspot/jtreg/compiler/c2/ClearArray.java\nindex ee3766416..d218eef57 100644\n--- a/test/hotspot/jtreg/compiler/c2/ClearArray.java\n+++ b/test/hotspot/jtreg/compiler/c2/ClearArray.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2022, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -24,7 +24,7 @@\n \n /*\n  * @test ClearArray.java\n- * @bug 8284883\n+ * @bug 8284883 8374570\n  * @compile ClearArray.java\n  * @summary ClearArray instruction overflows scratch buffer\n  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:-TieredCompilation -Xbatch\n@@ -33,6 +33,8 @@\n  *   -XX:InitArrayShortSize\u003d32768 -XX:-IdealizeClearArrayNode -XX:UseAVX\u003d3 compiler.c2.ClearArray\n  * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+IgnoreUnrecognizedVMOptions -XX:-TieredCompilation -Xbatch\n  *   -XX:InitArrayShortSize\u003d32768 -XX:MaxVectorSize\u003d8 -XX:-IdealizeClearArrayNode -XX:UseAVX\u003d3 compiler.c2.ClearArray\n+ * @run main/othervm -XX:+UnlockDiagnosticVMOptions -XX:+IgnoreUnrecognizedVMOptions -XX:-TieredCompilation -Xbatch\n+ *   -XX:+EnableX86ECoreOpts -XX:MaxVectorSize\u003d8 -XX:UseAVX\u003d3 compiler.c2.ClearArray\n  */\n \n package compiler.c2;","expectedMessage":"8374570: Assertion failure in ClearArray.java  with -XX:+EnableX86EcoreOpts","repository":"jdk","commitHash":"45990d796ffafc228c6e843049c80aefedb0f12b","metadata":{"author":"Volodymyr Paprotski \u003cvpaprotski@openjdk.org\u003e"}}
{"id":"jdk-49f72658","diff":" .../hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE78_A.java | 2 +-\n .../jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE_Loader2.java     | 2 +-\n test/hotspot/jtreg/runtime/execstack/Test.java                          | 2 +-\n test/hotspot/jtreg/runtime/execstack/TestMT.java                        | 2 +-\n test/hotspot/jtreg/runtime/execstack/libtest-rw.c                       | 2 +-\n test/hotspot/jtreg/runtime/execstack/libtest-rwx.c                      | 2 +-\n 6 files changed, 6 insertions(+), 6 deletions(-)\n\ndiff --git a/test/hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE78_A.java b/test/hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE78_A.java\nindex e0491b4b8..0684ad1aa 100644\n--- a/test/hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE78_A.java\n+++ b/test/hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE78_A.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2018 by SAP AG, Walldorf, Germany.\n+ * Copyright (c) 2018, 2026 SAP SE. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\ndiff --git a/test/hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE_Loader2.java b/test/hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE_Loader2.java\nindex 373ee5846..d13e5e5d3 100644\n--- a/test/hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE_Loader2.java\n+++ b/test/hotspot/jtreg/runtime/exceptionMsgs/IllegalAccessError/IAE_Loader2.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2018 by SAP AG, Walldorf, Germany.\n+ * Copyright (c) 2018, 2026 SAP SE. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\ndiff --git a/test/hotspot/jtreg/runtime/execstack/Test.java b/test/hotspot/jtreg/runtime/execstack/Test.java\nindex 67891a523..22063a56d 100644\n--- a/test/hotspot/jtreg/runtime/execstack/Test.java\n+++ b/test/hotspot/jtreg/runtime/execstack/Test.java\n@@ -1,6 +1,6 @@\n /*\n  * Copyright (c) 2002, 2016, Oracle and/or its affiliates. All rights reserved.\n- * Copyright (c) 2011 SAP AG.  All Rights Reserved.\n+ * Copyright (c) 2011, 2026 SAP SE. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\ndiff --git a/test/hotspot/jtreg/runtime/execstack/TestMT.java b/test/hotspot/jtreg/runtime/execstack/TestMT.java\nindex 0be1a461c..282b09f9a 100644\n--- a/test/hotspot/jtreg/runtime/execstack/TestMT.java\n+++ b/test/hotspot/jtreg/runtime/execstack/TestMT.java\n@@ -1,6 +1,6 @@\n /*\n  * Copyright (c) 2002, 2016, Oracle and/or its affiliates. All rights reserved.\n- * Copyright (c) 2011 SAP AG.  All Rights Reserved.\n+ * Copyright (c) 2011, 2026 SAP SE. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\ndiff --git a/test/hotspot/jtreg/runtime/execstack/libtest-rw.c b/test/hotspot/jtreg/runtime/execstack/libtest-rw.c\nindex 7ad4b95d2..52e1e8328 100644\n--- a/test/hotspot/jtreg/runtime/execstack/libtest-rw.c\n+++ b/test/hotspot/jtreg/runtime/execstack/libtest-rw.c\n@@ -1,6 +1,6 @@\n /*\n  * Copyright (c) 2002, 2016, Oracle and/or its affiliates. All rights reserved.\n- * Copyright (c) 2011 SAP AG.  All Rights Reserved.\n+ * Copyright (c) 2011, 2026 SAP SE. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\ndiff --git a/test/hotspot/jtreg/runtime/execstack/libtest-rwx.c b/test/hotspot/jtreg/runtime/execstack/libtest-rwx.c\nindex bce4f8531..e0d8e4248 100644\n--- a/test/hotspot/jtreg/runtime/execstack/libtest-rwx.c\n+++ b/test/hotspot/jtreg/runtime/execstack/libtest-rwx.c\n@@ -1,6 +1,6 @@\n /*\n  * Copyright (c) 2002, 2016, Oracle and/or its affiliates. All rights reserved.\n- * Copyright (c) 2011 SAP AG.  All Rights Reserved.\n+ * Copyright (c) 2011, 2026 SAP SE. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it","expectedMessage":"8374872: Cleanup outdated SAP AG copyright header info","repository":"jdk","commitHash":"49f7265894652ea243f3a531cf3f9d0b06e53565","metadata":{"author":"Matthias Baesken \u003cmbaesken@openjdk.org\u003e"}}
{"id":"jdk-7330e1a9","diff":" test/jdk/build/CheckFiles.java | 37 +++++++++++++++++++++++++++++++++++--\n 1 file changed, 35 insertions(+), 2 deletions(-)\n\ndiff --git a/test/jdk/build/CheckFiles.java b/test/jdk/build/CheckFiles.java\nindex 412e66ebf..eb903c0a2 100644\n--- a/test/jdk/build/CheckFiles.java\n+++ b/test/jdk/build/CheckFiles.java\n@@ -60,6 +60,8 @@ public static void main(String[] args) throws Exception {\n         System.out.println(\"Main directory to scan:\" + mainDirToScan);\n         Path binDir \u003d mainDirToScan.resolve(\"bin\");\n         Path libDir \u003d mainDirToScan.resolve(\"lib\");\n+        Path includeDir \u003d mainDirToScan.resolve(\"include\");\n+        Path jmodsDir \u003d mainDirToScan.resolve(\"jmods\");\n \n         System.out.println(\"Bin directory to scan:\" + binDir);\n         ArrayList\u003cString\u003e allowedEndingsBinDir \u003d new ArrayList\u003c\u003e();\n@@ -108,13 +110,44 @@ public static void main(String[] args) throws Exception {\n         }\n         boolean libDirRes \u003d scanFiles(libDir, allowedEndingsLibDir);\n \n-        if (!binDirRes) {\n+        if (binDirRes) {\n+            System.out.println(\"Bin directory scan successful.\");\n+        } else {\n             throw new Error(\"bin dir scan failed\");\n         }\n \n-        if (!libDirRes) {\n+        if (libDirRes) {\n+            System.out.println(\"Lib directory scan successful.\");\n+        } else {\n             throw new Error(\"lib dir scan failed\");\n         }\n+\n+        if (Files.isDirectory(includeDir)) {\n+            System.out.println(\"Include directory to scan:\" + includeDir);\n+            ArrayList\u003cString\u003e allowedEndingsIncludeDir \u003d new ArrayList\u003c\u003e();\n+            allowedEndingsIncludeDir.add(\".h\");\n+            allowedEndingsIncludeDir.add(\".hpp\");\n+            boolean includeDirRes \u003d scanFiles(includeDir, allowedEndingsIncludeDir);\n+            if (includeDirRes) {\n+                System.out.println(\"Include directory scan successful.\");\n+            } else {\n+                throw new Error(\"include dir scan failed\");\n+            }\n+        }\n+\n+        // when enabling \"JEP 493: Linking Run-Time Images without JMODs\" we do not\n+        // have the jmods folder at all, so first test the presence of the folder\n+        if (Files.isDirectory(jmodsDir)) {\n+            System.out.println(\"Jmods directory to scan:\" + jmodsDir);\n+            ArrayList\u003cString\u003e allowedEndingsJmodsDir \u003d new ArrayList\u003c\u003e();\n+            allowedEndingsJmodsDir.add(\".jmod\");\n+            boolean jmodsDirRes \u003d scanFiles(jmodsDir, allowedEndingsJmodsDir);\n+            if (jmodsDirRes) {\n+                System.out.println(\"Jmods directory scan successful.\");\n+            } else {\n+                throw new Error(\"jmods dir scan failed\");\n+            }\n+        }\n     }\n \n     private static boolean scanFiles(Path root, ArrayList\u003cString\u003e allowedEndings) throws IOException {","expectedMessage":"8374990: Check include and jmods folder of JDK image for unwanted files","repository":"jdk","commitHash":"7330e1a996fd43d92430a73b818f33552bc6ae9c","metadata":{"author":"Matthias Baesken \u003cmbaesken@openjdk.org\u003e"}}
{"id":"jdk-47029ccf","diff":" .../helpers/jdk/jpackage/test/Executor.java        | 33 ++------\n .../helpers/jdk/jpackage/test/HelloApp.java        | 30 ++++----\n .../helpers/jdk/jpackage/test/WindowsHelper.java   | 87 ----------------------\n .../jpackage/macosx/ArgumentsFilteringTest.java    | 12 ++-\n test/jdk/tools/jpackage/share/MainClassTest.java   |  7 +-\n .../jdk/tools/jpackage/windows/Win8301247Test.java | 47 +++++++++---\n .../jpackage/windows/WinChildProcessTest.java      | 20 ++---\n .../tools/jpackage/windows/WinNoRestartTest.java   | 47 +++++++++---\n 8 files changed, 112 insertions(+), 171 deletions(-)\n\ndiff --git a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\nindex 5d3033e2e..6e94133a5 100644\n--- a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\n+++ b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/Executor.java\n@@ -35,6 +35,7 @@\n import java.util.Optional;\n import java.util.Set;\n import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n import java.util.function.Supplier;\n import java.util.spi.ToolProvider;\n import java.util.stream.IntStream;\n@@ -109,15 +110,6 @@ public Executor setEnvVar(String envVarName, String envVarValue) {\n         return this;\n     }\n \n-    public Executor setWinRunWithEnglishOutput(boolean value) {\n-        if (!TKit.isWindows()) {\n-            throw new UnsupportedOperationException(\n-                    \"setWinRunWithEnglishOutput is only valid on Windows platform\");\n-        }\n-        winEnglishOutput \u003d value;\n-        return this;\n-    }\n-\n     public Executor setWindowsTmpDir(String tmp) {\n         if (!TKit.isWindows()) {\n             throw new UnsupportedOperationException(\n@@ -195,6 +187,11 @@ Executor storeOutputInFiles() {\n         return storeOutputInFiles(true);\n     }\n \n+    public Executor processListener(Consumer\u003cProcess\u003e v) {\n+        commandOutputControl.processListener(v);\n+        return this;\n+    }\n+\n     public record Result(CommandOutputControl.Result base) {\n         public Result {\n             Objects.requireNonNull(base);\n@@ -310,11 +307,6 @@ public Result executeWithoutExitCodeCheck() {\n                     \"Can\u0027t change directory when using tool provider\");\n         }\n \n-        if (toolProvider !\u003d null \u0026\u0026 winEnglishOutput) {\n-            throw new IllegalArgumentException(\n-                    \"Can\u0027t change locale when using tool provider\");\n-        }\n-\n         return ThrowingSupplier.toSupplier(() -\u003e {\n             if (toolProvider !\u003d null) {\n                 return runToolProvider();\n@@ -434,17 +426,8 @@ private Path executablePath() {\n         return executable.toAbsolutePath();\n     }\n \n-    private List\u003cString\u003e prefixCommandLineArgs() {\n-        if (winEnglishOutput) {\n-            return List.of(\"cmd.exe\", \"/c\", \"chcp\", \"437\", \"\u003enul\", \"2\u003e\u00261\", \"\u0026\u0026\");\n-        } else {\n-            return List.of();\n-        }\n-    }\n-\n     private Result runExecutable() throws IOException, InterruptedException {\n         List\u003cString\u003e command \u003d new ArrayList\u003c\u003e();\n-        command.addAll(prefixCommandLineArgs());\n         command.add(executablePath().toString());\n         command.addAll(args);\n         ProcessBuilder builder \u003d new ProcessBuilder(command);\n@@ -522,8 +505,7 @@ public String getPrintableCommandLine() {\n             exec \u003d executablePath().toString();\n         }\n \n-        var cmdline \u003d Stream.of(prefixCommandLineArgs(), List.of(exec), args).flatMap(\n-                List::stream).toList();\n+        var cmdline \u003d Stream.of(List.of(exec), args).flatMap(List::stream).toList();\n \n         return String.format(format, CommandLineFormat.DEFAULT.apply(cmdline), cmdline.size());\n     }\n@@ -559,6 +541,5 @@ private static void trace(String msg) {\n     private Path directory;\n     private Set\u003cString\u003e removeEnvVars \u003d new HashSet\u003c\u003e();\n     private Map\u003cString, String\u003e setEnvVars \u003d new HashMap\u003c\u003e();\n-    private boolean winEnglishOutput;\n     private String winTmpDir \u003d null;\n }\ndiff --git a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/HelloApp.java b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/HelloApp.java\nindex 6c7b6a252..bc731e181 100644\n--- a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/HelloApp.java\n+++ b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/HelloApp.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2019, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -35,6 +35,7 @@\n import java.util.Optional;\n import java.util.Set;\n import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.Consumer;\n import java.util.function.Predicate;\n import java.util.function.Supplier;\n import java.util.regex.Matcher;\n@@ -315,37 +316,33 @@ public static Path createBundle(JavaAppDesc appDesc, Path outputDir) {\n \n     public static void executeLauncherAndVerifyOutput(JPackageCommand cmd,\n             String... args) {\n-        AppOutputVerifier av \u003d assertMainLauncher(cmd, args);\n-        if (av !\u003d null) {\n+        assertMainLauncher(cmd, args).ifPresent(av -\u003e {\n             av.executeAndVerifyOutput(args);\n-        }\n+        });\n     }\n \n     public static Executor.Result executeLauncher(JPackageCommand cmd,\n             String... args) {\n-        AppOutputVerifier av \u003d assertMainLauncher(cmd, args);\n-        if (av !\u003d null) {\n+        return assertMainLauncher(cmd, args).map(av -\u003e {\n             return av.saveOutput(true).execute(args);\n-        } else {\n-            return null;\n-        }\n+        }).orElseThrow();\n     }\n \n-    public static AppOutputVerifier assertMainLauncher(JPackageCommand cmd,\n+    public static Optional\u003cAppOutputVerifier\u003e assertMainLauncher(JPackageCommand cmd,\n             String... args) {\n         final Path launcherPath \u003d cmd.appLauncherPath();\n         if (!cmd.canRunLauncher(String.format(\"Not running [%s] launcher\",\n                 launcherPath))) {\n-            return null;\n+            return Optional.empty();\n         }\n \n-        return assertApp(launcherPath)\n+        return Optional.of(assertApp(launcherPath)\n         .addDefaultArguments(Optional\n                 .ofNullable(cmd.getAllArgumentValues(\"--arguments\"))\n                 .orElseGet(() -\u003e new String[0]))\n         .addJavaOptions(Optional\n                 .ofNullable(cmd.getAllArgumentValues(\"--java-options\"))\n-                .orElseGet(() -\u003e new String[0]));\n+                .orElseGet(() -\u003e new String[0])));\n     }\n \n \n@@ -426,6 +423,11 @@ public AppOutputVerifier addJavaOptions(Collection\u003cString\u003e v) {\n             .collect(Collectors.toList()));\n         }\n \n+        public AppOutputVerifier processListener(Consumer\u003cProcess\u003e v) {\n+            processListener \u003d v;\n+            return this;\n+        }\n+\n         public void verifyOutput(String... args) {\n             final List\u003cString\u003e launcherArgs \u003d List.of(args);\n             final List\u003cString\u003e appArgs;\n@@ -479,6 +481,7 @@ private Executor getExecutor(String...args) {\n                     .saveOutput(saveOutput)\n                     .dumpOutput()\n                     .setExecutable(executablePath)\n+                    .processListener(processListener)\n                     .addArguments(List.of(args));\n \n             env.forEach((envVarName, envVarValue) -\u003e {\n@@ -493,6 +496,7 @@ private Executor getExecutor(String...args) {\n         private final Path launcherPath;\n         private Path outputFilePath;\n         private int expectedExitCode;\n+        private Consumer\u003cProcess\u003e processListener;\n         private final List\u003cString\u003e defaultLauncherArgs;\n         private final Map\u003cString, String\u003e params;\n         private final Map\u003cString, String\u003e env;\ndiff --git a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/WindowsHelper.java b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/WindowsHelper.java\nindex f9fbf285b..c7b55ed1d 100644\n--- a/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/WindowsHelper.java\n+++ b/test/jdk/tools/jpackage/helpers/jdk/jpackage/test/WindowsHelper.java\n@@ -42,8 +42,6 @@\n import java.util.Properties;\n import java.util.Set;\n import java.util.concurrent.ConcurrentHashMap;\n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n import java.util.stream.Stream;\n import jdk.jpackage.internal.util.function.ThrowingRunnable;\n import jdk.jpackage.test.PackageTest.PackageHandlers;\n@@ -306,91 +304,6 @@ public static String getExecutableDescription(Path pathToExeFile) {\n                 \"Failed to get file description of [%s]\", pathToExeFile));\n     }\n \n-    public static void killProcess(long pid) {\n-        Executor.of(\"taskkill\", \"/F\", \"/PID\", Long.toString(pid)).dumpOutput(true).execute();\n-    }\n-\n-    public static void killAppLauncherProcess(JPackageCommand cmd,\n-            String launcherName, int expectedCount) {\n-        var pids \u003d findAppLauncherPIDs(cmd, launcherName);\n-        try {\n-            TKit.assertEquals(expectedCount, pids.length, String.format(\n-                    \"Check [%d] %s app launcher processes found running\",\n-                    expectedCount, Optional.ofNullable(launcherName).map(\n-                            str -\u003e \"[\" + str + \"]\").orElse(\"\u003cmain\u003e\")));\n-        } finally {\n-            if (pids.length !\u003d 0) {\n-                killProcess(pids[0]);\n-            }\n-        }\n-    }\n-\n-    private static long[] findAppLauncherPIDs(JPackageCommand cmd, String launcherName) {\n-        // Get the list of PIDs and PPIDs of app launcher processes. Run setWinRunWithEnglishOutput(true) for JDK-8344275.\n-        // powershell -NoLogo -NoProfile -NonInteractive -Command\n-        //   \"Get-CimInstance Win32_Process -Filter \\\"Name \u003d \u0027foo.exe\u0027\\\" | select ProcessID,ParentProcessID\"\n-        String command \u003d \"Get-CimInstance Win32_Process -Filter \\\\\\\"Name \u003d \u0027\"\n-                + cmd.appLauncherPath(launcherName).getFileName().toString()\n-                + \"\u0027\\\\\\\" | select ProcessID,ParentProcessID\";\n-        List\u003cString\u003e output \u003d Executor.of(\"powershell\", \"-NoLogo\", \"-NoProfile\", \"-NonInteractive\", \"-Command\", command)\n-                .dumpOutput(true).saveOutput().setWinRunWithEnglishOutput(true).executeAndGetOutput();\n-\n-        if (output.size() \u003c 1) {\n-            return new long[0];\n-        }\n-\n-        String[] headers \u003d Stream.of(output.get(1).split(\"\\\\s+\", 2)).map(\n-                String::trim).map(String::toLowerCase).toArray(String[]::new);\n-        Pattern pattern;\n-        if (headers[0].equals(\"parentprocessid\") \u0026\u0026 headers[1].equals(\n-                \"processid\")) {\n-            pattern \u003d Pattern.compile(\"^\\\\s+(?\u003cppid\u003e\\\\d+)\\\\s+(?\u003cpid\u003e\\\\d+)$\");\n-        } else if (headers[1].equals(\"parentprocessid\") \u0026\u0026 headers[0].equals(\n-                \"processid\")) {\n-            pattern \u003d Pattern.compile(\"^\\\\s+(?\u003cpid\u003e\\\\d+)\\\\s+(?\u003cppid\u003e\\\\d+)$\");\n-        } else {\n-            throw new RuntimeException(\n-                    \"Unrecognizable output of \\\u0027Get-CimInstance Win32_Process\\\u0027 command\");\n-        }\n-\n-        List\u003clong[]\u003e processes \u003d output.stream().skip(3).map(line -\u003e {\n-            Matcher m \u003d pattern.matcher(line);\n-            long[] pids \u003d null;\n-            if (m.matches()) {\n-                pids \u003d new long[]{Long.parseLong(m.group(\"pid\")), Long.\n-                    parseLong(m.group(\"ppid\"))};\n-            }\n-            return pids;\n-        }).filter(Objects::nonNull).toList();\n-\n-        switch (processes.size()) {\n-            case 2 -\u003e {\n-                final long parentPID;\n-                final long childPID;\n-                if (processes.get(0)[0] \u003d\u003d processes.get(1)[1]) {\n-                    parentPID \u003d processes.get(0)[0];\n-                    childPID \u003d processes.get(1)[0];\n-                } else if (processes.get(1)[0] \u003d\u003d processes.get(0)[1]) {\n-                    parentPID \u003d processes.get(1)[0];\n-                    childPID \u003d processes.get(0)[0];\n-                } else {\n-                    TKit.assertUnexpected(\"App launcher processes unrelated\");\n-                    return null; // Unreachable\n-                }\n-                return new long[]{parentPID, childPID};\n-            }\n-            case 1 -\u003e {\n-                return new long[]{processes.get(0)[0]};\n-            }\n-            default -\u003e {\n-                TKit.assertUnexpected(String.format(\n-                        \"Unexpected number of running processes [%d]\",\n-                        processes.size()));\n-                return null; // Unreachable\n-            }\n-        }\n-    }\n-\n     static boolean isUserLocalInstall(JPackageCommand cmd) {\n         return cmd.hasArgument(\"--win-per-user-install\");\n     }\ndiff --git a/test/jdk/tools/jpackage/macosx/ArgumentsFilteringTest.java b/test/jdk/tools/jpackage/macosx/ArgumentsFilteringTest.java\nindex 1a42a30c0..e4adf3b96 100644\n--- a/test/jdk/tools/jpackage/macosx/ArgumentsFilteringTest.java\n+++ b/test/jdk/tools/jpackage/macosx/ArgumentsFilteringTest.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2020, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -49,11 +49,10 @@ public class ArgumentsFilteringTest {\n     public void test1() {\n         JPackageCommand cmd \u003d JPackageCommand.helloAppImage();\n         cmd.executeAndAssertHelloAppImageCreated();\n-        var appVerifier \u003d HelloApp.assertMainLauncher(cmd);\n-        if (appVerifier !\u003d null) {\n+        HelloApp.assertMainLauncher(cmd).ifPresent(appVerifier -\u003e {\n             appVerifier.execute(\"-psn_1_1\");\n             appVerifier.verifyOutput();\n-        }\n+        });\n     }\n \n     @Test\n@@ -61,10 +60,9 @@ public void test2() {\n         JPackageCommand cmd \u003d JPackageCommand.helloAppImage()\n                 .addArguments(\"--arguments\", \"-psn_2_2\");\n         cmd.executeAndAssertHelloAppImageCreated();\n-        var appVerifier \u003d HelloApp.assertMainLauncher(cmd);\n-        if (appVerifier !\u003d null) {\n+        HelloApp.assertMainLauncher(cmd).ifPresent(appVerifier -\u003e {\n             appVerifier.execute(\"-psn_1_1\");\n             appVerifier.verifyOutput(\"-psn_2_2\");\n-        }\n+        });\n     }\n }\ndiff --git a/test/jdk/tools/jpackage/share/MainClassTest.java b/test/jdk/tools/jpackage/share/MainClassTest.java\nindex bc813c4ec..72e77bbbf 100644\n--- a/test/jdk/tools/jpackage/share/MainClassTest.java\n+++ b/test/jdk/tools/jpackage/share/MainClassTest.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2019, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -240,8 +240,7 @@ public void test() throws IOException {\n             cmd.executeAndAssertHelloAppImageCreated();\n         } else {\n             cmd.executeAndAssertImageCreated();\n-            var appVerifier \u003d HelloApp.assertMainLauncher(cmd);\n-            if (appVerifier !\u003d null) {\n+            HelloApp.assertMainLauncher(cmd).ifPresent(appVerifier -\u003e {\n                 List\u003cString\u003e output \u003d appVerifier\n                         .saveOutput(true)\n                         .expectedExitCode(1)\n@@ -249,7 +248,7 @@ public void test() throws IOException {\n                 TKit.assertTextStream(String.format(\n                         \"Error: Could not find or load main class %s\",\n                         nonExistingMainClass)).apply(output);\n-            }\n+            });\n         }\n \n         CfgFile cfg \u003d cmd.readLauncherCfgFile();\ndiff --git a/test/jdk/tools/jpackage/windows/Win8301247Test.java b/test/jdk/tools/jpackage/windows/Win8301247Test.java\nindex 2f98141dc..3cdd9810d 100644\n--- a/test/jdk/tools/jpackage/windows/Win8301247Test.java\n+++ b/test/jdk/tools/jpackage/windows/Win8301247Test.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2023, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -21,12 +21,14 @@\n  * questions.\n  */\n \n-import static jdk.jpackage.test.WindowsHelper.killAppLauncherProcess;\n-\n import java.time.Duration;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n import jdk.jpackage.test.Annotations.Test;\n import jdk.jpackage.test.HelloApp;\n import jdk.jpackage.test.JPackageCommand;\n+import jdk.jpackage.test.TKit;\n \n /**\n  * Test that terminating of the parent app launcher process automatically\n@@ -46,7 +48,7 @@\n public class Win8301247Test {\n \n     @Test\n-    public void test() throws InterruptedException {\n+    public void test() throws InterruptedException, ExecutionException {\n         var cmd \u003d JPackageCommand.helloAppImage().ignoreFakeRuntime();\n \n         // Launch the app in a way it doesn\u0027t exit to let us trap app laucnher\n@@ -54,20 +56,41 @@ public void test() throws InterruptedException {\n         cmd.addArguments(\"--java-options\", \"-Djpackage.test.noexit\u003dtrue\");\n         cmd.executeAndAssertImageCreated();\n \n+        var f \u003d new CompletableFuture\u003cProcess\u003e();\n+\n         // Launch the app in a separate thread\n         new Thread(() -\u003e {\n-            HelloApp.executeLauncher(cmd);\n+            HelloApp.assertMainLauncher(cmd).get().processListener(f::complete).execute();\n         }).start();\n \n-        // Wait a bit to let the app start\n-        Thread.sleep(Duration.ofSeconds(10));\n+        var mainLauncherProcess \u003d f.get();\n+\n+        Optional\u003cProcessHandle\u003e childProcess \u003d Optional.empty();\n+\n+        try {\n+            // Wait a bit to let the app start\n+            Thread.sleep(Duration.ofSeconds(10));\n+\n+            try (var children \u003d mainLauncherProcess.children()) {\n+                childProcess \u003d children.filter(p -\u003e {\n+                    return mainLauncherProcess.info().command().equals(p.info().command());\n+                }).findFirst();\n+            }\n \n-        // Find the main app launcher process and kill it\n-        killAppLauncherProcess(cmd, null, 2);\n+            TKit.assertTrue(childProcess.isPresent(),\n+                    String.format(\"Check the main launcher process with PID\u003d%d restarted\", mainLauncherProcess.pid()));\n+        } finally {\n+            // Kill the main app launcher process\n+            TKit.trace(\"About to kill the main launcher process...\");\n+            mainLauncherProcess.destroyForcibly();\n \n-        // Wait a bit and check if child app launcher process is still running (it must NOT)\n-        Thread.sleep(Duration.ofSeconds(5));\n+            // Wait a bit and check if child app launcher process is still running (it must NOT)\n+            Thread.sleep(Duration.ofSeconds(5));\n \n-        killAppLauncherProcess(cmd, null, 0);\n+            childProcess.ifPresent(p -\u003e {\n+                TKit.assertTrue(!p.isAlive(), String.format(\n+                        \"Check restarted main launcher process with PID\u003d%d is not alive\", p.pid()));\n+            });\n+        }\n     }\n }\ndiff --git a/test/jdk/tools/jpackage/windows/WinChildProcessTest.java b/test/jdk/tools/jpackage/windows/WinChildProcessTest.java\nindex a83ef8373..e5de19d18 100644\n--- a/test/jdk/tools/jpackage/windows/WinChildProcessTest.java\n+++ b/test/jdk/tools/jpackage/windows/WinChildProcessTest.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2024, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -44,7 +44,6 @@\n import jdk.jpackage.test.Annotations.Test;\n import jdk.jpackage.test.Executor;\n import jdk.jpackage.test.TKit;\n-import static jdk.jpackage.test.WindowsHelper.killProcess;\n \n public class WinChildProcessTest {\n     private static final Path TEST_APP_JAVA \u003d TKit.TEST_SRC_ROOT\n@@ -52,7 +51,7 @@ public class WinChildProcessTest {\n \n     @Test\n     public static void test() {\n-        long childPid \u003d 0;\n+        Optional\u003cProcessHandle\u003e child \u003d Optional.empty();\n         try {\n             JPackageCommand cmd \u003d JPackageCommand\n                     .helloAppImage(TEST_APP_JAVA + \"*Hello\")\n@@ -69,21 +68,18 @@ public static void test() {\n             String pidStr \u003d output.get(0);\n \n             // parse child PID\n-            childPid \u003d Long.parseLong(pidStr.split(\"\u003d\", 2)[1]);\n+            var childPid \u003d Long.parseLong(pidStr.split(\"\u003d\", 2)[1]);\n \n             // Check whether the termination of third party application launcher\n             // also terminating the launched third party application\n             // If third party application is not terminated the test is\n             // successful else failure\n-            Optional\u003cProcessHandle\u003e processHandle \u003d ProcessHandle.of(childPid);\n-            boolean isAlive \u003d processHandle.isPresent()\n-                    \u0026\u0026 processHandle.get().isAlive();\n-            TKit.assertTrue(isAlive, \"Check child process is alive\");\n+            child \u003d ProcessHandle.of(childPid);\n+            boolean isAlive \u003d child.map(ProcessHandle::isAlive).orElse(false);\n+            TKit.assertTrue(isAlive, String.format(\"Check child process with PID\u003d%d is alive\", childPid));\n         } finally {\n-            if (childPid !\u003d 0) {\n-                // Kill only a specific child instance\n-                killProcess(childPid);\n-            }\n+            TKit.trace(\"About to kill the child process...\");\n+            child.ifPresent(ProcessHandle::destroyForcibly);\n         }\n     }\n }\ndiff --git a/test/jdk/tools/jpackage/windows/WinNoRestartTest.java b/test/jdk/tools/jpackage/windows/WinNoRestartTest.java\nindex 909ee06b0..984ddfcdf 100644\n--- a/test/jdk/tools/jpackage/windows/WinNoRestartTest.java\n+++ b/test/jdk/tools/jpackage/windows/WinNoRestartTest.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2024, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -21,15 +21,18 @@\n  * questions.\n  */\n \n-import static jdk.jpackage.test.WindowsHelper.killAppLauncherProcess;\n \n import java.io.IOException;\n import java.time.Duration;\n import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n import jdk.jpackage.test.Annotations.Test;\n import jdk.jpackage.test.CfgFile;\n import jdk.jpackage.test.HelloApp;\n import jdk.jpackage.test.JPackageCommand;\n+import jdk.jpackage.test.TKit;\n \n /* @test\n  * @bug 8340311\n@@ -47,7 +50,7 @@\n public class WinNoRestartTest {\n \n     @Test\n-    public static void test() throws InterruptedException, IOException {\n+    public static void test() throws InterruptedException, IOException, ExecutionException {\n         var cmd \u003d JPackageCommand.helloAppImage().ignoreFakeRuntime();\n \n         // Configure test app to launch in a way it will not exit\n@@ -77,7 +80,7 @@ void apply(CfgFile cfgFile) {\n     private static record NoRerunConfig(NoRerunSectionConfig firstSection,\n             NoRerunSectionConfig secondSection, boolean expectedNoRestarted) {\n \n-        void apply(JPackageCommand cmd, CfgFile origCfgFile) throws InterruptedException {\n+        void apply(JPackageCommand cmd, CfgFile origCfgFile) throws InterruptedException, ExecutionException {\n             // Alter the main launcher .cfg file\n             var cfgFile \u003d new CfgFile();\n             if (firstSection !\u003d null) {\n@@ -92,16 +95,40 @@ void apply(JPackageCommand cmd, CfgFile origCfgFile) throws InterruptedException\n             // Save updated main launcher .cfg file\n             cfgFile.save(cmd.appLauncherCfgPath(null));\n \n+            var f \u003d new CompletableFuture\u003cProcess\u003e();\n+\n             // Launch the app in a separate thread\n             new Thread(() -\u003e {\n-                HelloApp.executeLauncher(cmd);\n+                HelloApp.assertMainLauncher(cmd).get().processListener(f::complete).execute();\n             }).start();\n \n-            // Wait a bit to let the app start\n-            Thread.sleep(Duration.ofSeconds(10));\n-\n-            // Find the main app launcher process and kill it\n-            killAppLauncherProcess(cmd, null, expectedNoRestarted ? 1 : 2);\n+            var mainLauncherProcess \u003d f.get();\n+\n+            try {\n+                // Wait a bit to let the app start\n+                Thread.sleep(Duration.ofSeconds(10));\n+\n+                try (var children \u003d mainLauncherProcess.children()) {\n+                    Optional\u003cString\u003e childPid \u003d children.filter(p -\u003e {\n+                        return mainLauncherProcess.info().command().equals(p.info().command());\n+                    }).map(ProcessHandle::pid).map(Object::toString).findFirst();\n+\n+                    Optional\u003cString\u003e expectedChildPid;\n+                    if (expectedNoRestarted) {\n+                        expectedChildPid \u003d Optional.empty();\n+                    } else {\n+                        expectedChildPid \u003d childPid.or(() -\u003e {\n+                            return Optional.of(\"\u003csome\u003e\");\n+                        });\n+                    }\n+                    TKit.assertEquals(expectedChildPid, childPid, String.format(\n+                            \"Check the main launcher process with PID\u003d%d restarted\",\n+                            mainLauncherProcess.pid()));\n+                }\n+            } finally {\n+                TKit.trace(\"About to kill the main launcher process...\");\n+                mainLauncherProcess.destroyForcibly();\n+            }\n         }\n     }\n ","expectedMessage":"8375050: Simplify process management in jpackage tests","repository":"jdk","commitHash":"47029ccfec988e0a9298e35dcc729d9eeffc45e1","metadata":{"author":"Alexey Semenyuk \u003casemenyuk@openjdk.org\u003e"}}
{"id":"jdk-a90c7eee","diff":" src/hotspot/share/opto/memnode.cpp |  7 ++++++-\n src/hotspot/share/opto/memnode.hpp | 11 ++++-------\n 2 files changed, 10 insertions(+), 8 deletions(-)\n\ndiff --git a/src/hotspot/share/opto/memnode.cpp b/src/hotspot/share/opto/memnode.cpp\nindex 5b76f5b42..0d4fb6791 100644\n--- a/src/hotspot/share/opto/memnode.cpp\n+++ b/src/hotspot/share/opto/memnode.cpp\n@@ -3913,7 +3913,6 @@ const Type* SCMemProjNode::Value(PhaseGVN* phase) const\n LoadStoreNode::LoadStoreNode( Node *c, Node *mem, Node *adr, Node *val, const TypePtr* at, const Type* rt, uint required )\n   : Node(required),\n     _type(rt),\n-    _adr_type(at),\n     _barrier_data(0)\n {\n   init_req(MemNode::Control, c  );\n@@ -3921,6 +3920,7 @@ LoadStoreNode::LoadStoreNode( Node *c, Node *mem, Node *adr, Node *val, const Ty\n   init_req(MemNode::Address, adr);\n   init_req(MemNode::ValueIn, val);\n   init_class_id(Class_LoadStore);\n+  DEBUG_ONLY(_adr_type \u003d at; adr_type();)\n }\n \n //------------------------------Value-----------------------------------------\n@@ -3944,6 +3944,11 @@ const Type* LoadStoreNode::Value(PhaseGVN* phase) const {\n   return bottom_type();\n }\n \n+const TypePtr* LoadStoreNode::adr_type() const {\n+  const TypePtr* cross_check \u003d DEBUG_ONLY(_adr_type) NOT_DEBUG(nullptr);\n+  return MemNode::calculate_adr_type(in(MemNode::Address)-\u003ebottom_type(), cross_check);\n+}\n+\n uint LoadStoreNode::ideal_reg() const {\n   return _type-\u003eideal_reg();\n }\ndiff --git a/src/hotspot/share/opto/memnode.hpp b/src/hotspot/share/opto/memnode.hpp\nindex d554c0370..e84556528 100644\n--- a/src/hotspot/share/opto/memnode.hpp\n+++ b/src/hotspot/share/opto/memnode.hpp\n@@ -797,11 +797,6 @@ class SCMemProjNode : public ProjNode {\n   virtual int Opcode() const;\n   virtual bool      is_CFG() const  { return false; }\n   virtual const Type *bottom_type() const {return Type::MEMORY;}\n-  virtual const TypePtr *adr_type() const {\n-    Node* ctrl \u003d in(0);\n-    if (ctrl \u003d\u003d nullptr)  return nullptr; // node is dead\n-    return ctrl-\u003ein(MemNode::Memory)-\u003eadr_type();\n-  }\n   virtual uint ideal_reg() const { return 0;} // memory projections don\u0027t have a register\n   virtual const Type* Value(PhaseGVN* phase) const;\n #ifndef PRODUCT\n@@ -814,9 +809,11 @@ class SCMemProjNode : public ProjNode {\n class LoadStoreNode : public Node {\n private:\n   const Type* const _type;      // What kind of value is loaded?\n-  const TypePtr* _adr_type;     // What kind of memory is being addressed?\n   uint8_t _barrier_data;        // Bit field with barrier information\n   virtual uint size_of() const; // Size is bigger\n+#ifdef ASSERT\n+  const TypePtr* _adr_type;     // What kind of memory is being addressed?\n+#endif // ASSERT\n public:\n   LoadStoreNode( Node *c, Node *mem, Node *adr, Node *val, const TypePtr* at, const Type* rt, uint required );\n   virtual bool depends_only_on_test() const { return false; }\n@@ -824,7 +821,7 @@ class LoadStoreNode : public Node {\n \n   virtual const Type *bottom_type() const { return _type; }\n   virtual uint ideal_reg() const;\n-  virtual const class TypePtr *adr_type() const { return _adr_type; }  // returns bottom_type of address\n+  virtual const TypePtr* adr_type() const;\n   virtual const Type* Value(PhaseGVN* phase) const;\n \n   bool result_not_used() const;","expectedMessage":"8374969: Incorrect results of LoadStoreNode::adr_type and SCMemProj::adr_type","repository":"jdk","commitHash":"a90c7eee6f7e950edea4d94cf2b109fdb5e49909","metadata":{"author":"Quan Anh Mai \u003cqamai@openjdk.org\u003e"}}
{"id":"jdk-543a9722","diff":" .../share/jfr/periodic/sampling/jfrThreadSampler.cpp      | 15 +++++++++++----\n 1 file changed, 11 insertions(+), 4 deletions(-)\n\ndiff --git a/src/hotspot/share/jfr/periodic/sampling/jfrThreadSampler.cpp b/src/hotspot/share/jfr/periodic/sampling/jfrThreadSampler.cpp\nindex 7e7747ba3..805426078 100644\n--- a/src/hotspot/share/jfr/periodic/sampling/jfrThreadSampler.cpp\n+++ b/src/hotspot/share/jfr/periodic/sampling/jfrThreadSampler.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2012, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -351,15 +351,22 @@ bool JfrSamplerThread::sample_native_thread(JavaThread* jt) {\n   //    outside the safepoint protocol.\n \n   // OrderAccess::fence() as part of acquiring the lock prevents loads from floating up.\n-  JfrMutexTryLock threads_lock(Threads_lock);\n+  JfrMutexTryLock lock(Threads_lock);\n \n-  if (!threads_lock.acquired() || !jt-\u003ehas_last_Java_frame()) {\n+  if (!lock.acquired()) {\n     // Remove the native sample request and release the potentially waiting thread.\n     JfrSampleMonitor jsm(tl);\n     return false;\n   }\n \n-  if (jt-\u003ethread_state() !\u003d _thread_in_native) {\n+  // Separate the arming of the poll (above) from the reading of JavaThread state (below).\n+  if (UseSystemMemoryBarrier) {\n+    SystemMemoryBarrier::emit();\n+  } else {\n+    OrderAccess::fence();\n+  }\n+\n+  if (jt-\u003ethread_state() !\u003d _thread_in_native || !jt-\u003ehas_last_Java_frame()) {\n     assert_lock_strong(Threads_lock);\n     JfrSampleMonitor jsm(tl);\n     if (jsm.is_waiting()) {","expectedMessage":"8373485: JFR Crash during sampling:  assert(jt-\u003ehas_last_Java_frame()) failed: invariant","repository":"jdk","commitHash":"543a972222118155e4c72c6f2d32d154c5dfd442","metadata":{"author":"Markus Grnlund \u003cmgronlun@openjdk.org\u003e"}}
{"id":"jdk-578204f8","diff":" .../com/sun/tools/javac/code/TypeAnnotations.java  |  3 ++-\n .../classes/com/sun/tools/javac/comp/Annotate.java |  3 ++-\n .../classfile/TestNewCastArray.java                | 22 ++++++++++++++++++++--\n 3 files changed, 24 insertions(+), 4 deletions(-)\n\ndiff --git a/src/jdk.compiler/share/classes/com/sun/tools/javac/code/TypeAnnotations.java b/src/jdk.compiler/share/classes/com/sun/tools/javac/code/TypeAnnotations.java\nindex 6aae8eb85..86319f20c 100644\n--- a/src/jdk.compiler/share/classes/com/sun/tools/javac/code/TypeAnnotations.java\n+++ b/src/jdk.compiler/share/classes/com/sun/tools/javac/code/TypeAnnotations.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2009, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2009, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -1403,6 +1403,7 @@ public void visitNewArray(JCNewArray tree) {\n                     break;\n                 }\n             }\n+            scan(tree.dims);\n             scan(tree.elems);\n         }\n \ndiff --git a/src/jdk.compiler/share/classes/com/sun/tools/javac/comp/Annotate.java b/src/jdk.compiler/share/classes/com/sun/tools/javac/comp/Annotate.java\nindex f5fdc1578..f865afe11 100644\n--- a/src/jdk.compiler/share/classes/com/sun/tools/javac/comp/Annotate.java\n+++ b/src/jdk.compiler/share/classes/com/sun/tools/javac/comp/Annotate.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2003, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -1107,6 +1107,7 @@ public void visitNewArray(JCNewArray tree) {\n             for (List\u003cJCAnnotation\u003e dimAnnos : tree.dimAnnotations)\n                 enterTypeAnnotations(dimAnnos, env, sym, false);\n             scan(tree.elemtype);\n+            scan(tree.dims);\n             scan(tree.elems);\n         }\n \ndiff --git a/test/langtools/tools/javac/annotations/typeAnnotations/classfile/TestNewCastArray.java b/test/langtools/tools/javac/annotations/typeAnnotations/classfile/TestNewCastArray.java\nindex 803e0c886..a65c45032 100644\n--- a/test/langtools/tools/javac/annotations/typeAnnotations/classfile/TestNewCastArray.java\n+++ b/test/langtools/tools/javac/annotations/typeAnnotations/classfile/TestNewCastArray.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2013, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -44,7 +44,8 @@ public class TestNewCastArray {\n     // \u0027b\u0027 tests fail with only even numbers of annotations (8005681).\n     String[] testclasses \u003d {\"Test1\",\n         \"Test2a\", \"Test3a\", \"Test4a\", \"Test5a\",\n-        \"Test2b\", \"Test3b\", \"Test4b\", \"Test5b\"\n+        \"Test2b\", \"Test3b\", \"Test4b\", \"Test5b\",\n+        \"Test6a\"\n     };\n \n     public static void main(String[] args) throws Exception {\n@@ -182,6 +183,11 @@ \u003cT extends Attribute\u003cT\u003e\u003e void test(String clazz, AttributedElement m, AttributeM\n             case \"ci2\":  expected \u003d 0; break;\n             case \"ci22\": expected \u003d 0; break;\n \n+            case \"Test6a\u003cinit\u003e\": cexpected\u003d4; break;\n+            case \"test6aPrimitiveArray\":  expected \u003d 0; break;\n+            case \"test6aRefArray\": expected \u003d 0; break;\n+            case \"test6aMethod\": cexpected \u003d 4; break;\n+\n             default: expected \u003d 0; break;\n         }\n         if(codeattr)\n@@ -353,6 +359,18 @@ static class Test5b {\n         Integer ci22 \u003d (@A @A @B @B Integer)o; // FAIL expect 3, got 1\n     }\n \n+    static class Test6a {\n+        Test6a(){}\n+        long l \u003d 0;\n+        // Cast expressions inside new array dimensions:\n+        int[] test6aPrimitiveArray \u003d new int[(@A @A @B @B int) l];\n+        Integer[] test6aRefArray   \u003d new Integer[(@A @A @B @B int) l];\n+        private void test6aMethod() {\n+            int[] primitiveArray \u003d new int[(@A @A @B @B int) l];\n+            Integer[] refArray   \u003d new Integer[(@A @A @B @B int) l];\n+        }\n+    }\n+\n @Retention(RUNTIME) @Target({TYPE_USE}) @Repeatable( AC.class ) @interface A { }\n @Retention(RUNTIME) @Target({TYPE_USE}) @Repeatable( BC.class ) @interface B { }\n @Retention(RUNTIME) @Target({FIELD}) @Repeatable( FC.class ) @interface F { }","expectedMessage":"8374379: Type annotation in new array dimension expression causes java.lang.AssertionError","repository":"jdk","commitHash":"578204f8c49f06be8b9c4855359ca61c9e107678","metadata":{"author":"Jan Lahoda \u003cjlahoda@openjdk.org\u003e"}}
{"id":"jdk-d6f43d73","diff":" src/java.base/share/classes/java/lang/foreign/MemorySegment.java    | 2 ++\n src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java | 1 +\n 2 files changed, 3 insertions(+)\n\ndiff --git a/src/java.base/share/classes/java/lang/foreign/MemorySegment.java b/src/java.base/share/classes/java/lang/foreign/MemorySegment.java\nindex 2b931a7d2..78098e39a 100644\n--- a/src/java.base/share/classes/java/lang/foreign/MemorySegment.java\n+++ b/src/java.base/share/classes/java/lang/foreign/MemorySegment.java\n@@ -1354,6 +1354,7 @@ MemorySegment reinterpret(long newSize,\n      * @throws WrongThreadException if this method is called from a thread {@code T},\n      *         such that {@code isAccessibleBy(T) \u003d\u003d false}\n      * @throws IllegalArgumentException if {@code byteLength \u003c 0}\n+     * @since 27\n      */\n     String getString(long offset, Charset charset, long byteLength);\n \n@@ -2669,6 +2670,7 @@ static void copy(Object srcArray, int srcIndex,\n      * @throws IndexOutOfBoundsException if {@code dstOffset \u003e dstSegment.byteSize() - B} where {@code B} is the size,\n      *         in bytes, of the substring of {@code src} encoded using the given charset\n      * @return the number of copied bytes.\n+     * @since 27\n      */\n     @ForceInline\n     static long copy(String src, Charset dstEncoding, int srcIndex, MemorySegment dst, long dstOffset, int numChars) {\ndiff --git a/src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java b/src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java\nindex 5b213af54..03d92ec24 100644\n--- a/src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java\n+++ b/src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java\n@@ -183,6 +183,7 @@ default MemorySegment allocateFrom(String str, Charset charset) {\n      *           {@code this.allocate(B)}, where {@code B} is the size, in bytes, of\n      *           the string encoded using the provided charset\n      *           (e.g. {@code str.getBytes(charset).length});\n+     * @since 27\n      */\n     @ForceInline\n     default MemorySegment allocateFrom(String str, Charset charset, int srcIndex, int numChars) {","expectedMessage":"8375066: Test tools/sincechecker/modules/java.base/JavaBaseCheckSince.java broken by JDK-8369564","repository":"jdk","commitHash":"d6f43d7329bf0ba08464f6d0a22de7e27ca8b399","metadata":{"author":"Liam Miller-Cushon \u003ccushon@openjdk.org\u003e"}}
{"id":"jdk-c000343b","diff":" src/hotspot/share/gc/epsilon/epsilonHeap.cpp              | 10 ++++------\n src/hotspot/share/gc/epsilon/epsilonHeap.hpp              |  5 +++--\n src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.cpp |  5 ++---\n src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.hpp |  3 ++-\n 4 files changed, 11 insertions(+), 12 deletions(-)\n\ndiff --git a/src/hotspot/share/gc/epsilon/epsilonHeap.cpp b/src/hotspot/share/gc/epsilon/epsilonHeap.cpp\nindex 24182c22a..59ab69b24 100644\n--- a/src/hotspot/share/gc/epsilon/epsilonHeap.cpp\n+++ b/src/hotspot/share/gc/epsilon/epsilonHeap.cpp\n@@ -62,8 +62,6 @@ jint EpsilonHeap::initialize() {\n \n   // Enable monitoring\n   _monitoring_support \u003d new EpsilonMonitoringSupport(this);\n-  _last_counter_update \u003d 0;\n-  _last_heap_print \u003d 0;\n \n   // Install barrier set\n   BarrierSet::set_barrier_set(new EpsilonBarrierSet());\n@@ -156,17 +154,17 @@ HeapWord* EpsilonHeap::allocate_work(size_t size) {\n   // At this point, some diagnostic subsystems might not yet be initialized.\n   // We pretend the printout happened either way. This keeps allocation path\n   // from obsessively checking the subsystems\u0027 status on every allocation.\n-  size_t last_counter \u003d AtomicAccess::load(\u0026_last_counter_update);\n+  size_t last_counter \u003d _last_counter_update.load_relaxed();\n   if ((used - last_counter \u003e\u003d _step_counter_update) \u0026\u0026\n-      AtomicAccess::cmpxchg(\u0026_last_counter_update, last_counter, used) \u003d\u003d last_counter) {\n+      _last_counter_update.compare_set(last_counter, used)) {\n     if (_monitoring_support-\u003eis_ready()) {\n       _monitoring_support-\u003eupdate_counters();\n     }\n   }\n \n-  size_t last_heap \u003d AtomicAccess::load(\u0026_last_heap_print);\n+  size_t last_heap \u003d _last_heap_print.load_relaxed();\n   if ((used - last_heap \u003e\u003d _step_heap_print) \u0026\u0026\n-      AtomicAccess::cmpxchg(\u0026_last_heap_print, last_heap, used) \u003d\u003d last_heap) {\n+      _last_heap_print.compare_set(last_heap, used)) {\n     print_heap_info(used);\n     if (Metaspace::initialized()) {\n       print_metaspace_info();\ndiff --git a/src/hotspot/share/gc/epsilon/epsilonHeap.hpp b/src/hotspot/share/gc/epsilon/epsilonHeap.hpp\nindex 9693c63b1..8d7aa7960 100644\n--- a/src/hotspot/share/gc/epsilon/epsilonHeap.hpp\n+++ b/src/hotspot/share/gc/epsilon/epsilonHeap.hpp\n@@ -31,6 +31,7 @@\n #include \"gc/shared/collectedHeap.hpp\"\n #include \"gc/shared/space.hpp\"\n #include \"memory/virtualspace.hpp\"\n+#include \"runtime/atomic.hpp\"\n #include \"services/memoryManager.hpp\"\n \n class EpsilonHeap : public CollectedHeap {\n@@ -45,8 +46,8 @@ class EpsilonHeap : public CollectedHeap {\n   size_t _step_counter_update;\n   size_t _step_heap_print;\n   int64_t _decay_time_ns;\n-  volatile size_t _last_counter_update;\n-  volatile size_t _last_heap_print;\n+  Atomic\u003csize_t\u003e _last_counter_update;\n+  Atomic\u003csize_t\u003e _last_heap_print;\n \n   void print_tracing_info() const override;\n   void stop() override {};\ndiff --git a/src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.cpp b/src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.cpp\nindex 38be736df..213fc18b8 100644\n--- a/src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.cpp\n+++ b/src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.cpp\n@@ -96,7 +96,6 @@ class EpsilonGenerationCounters : public GenerationCounters {\n EpsilonMonitoringSupport::EpsilonMonitoringSupport(EpsilonHeap* heap) {\n   _heap_counters  \u003d new EpsilonGenerationCounters(heap);\n   _space_counters \u003d new EpsilonSpaceCounters(\"Heap\", 0, heap-\u003emax_capacity(), 0, _heap_counters);\n-  _ready \u003d false;\n }\n \n void EpsilonMonitoringSupport::update_counters() {\n@@ -114,9 +113,9 @@ void EpsilonMonitoringSupport::update_counters() {\n }\n \n bool EpsilonMonitoringSupport::is_ready() {\n-  return AtomicAccess::load_acquire(\u0026_ready);\n+  return _ready.load_acquire();\n }\n \n void EpsilonMonitoringSupport::mark_ready() {\n-  return AtomicAccess::release_store(\u0026_ready, true);\n+  _ready.release_store(true);\n }\ndiff --git a/src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.hpp b/src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.hpp\nindex 76cdac6df..9dc52c2a6 100644\n--- a/src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.hpp\n+++ b/src/hotspot/share/gc/epsilon/epsilonMonitoringSupport.hpp\n@@ -26,6 +26,7 @@\n #define SHARE_GC_EPSILON_EPSILONMONITORINGSUPPORT_HPP\n \n #include \"memory/allocation.hpp\"\n+#include \"runtime/atomic.hpp\"\n \n class EpsilonGenerationCounters;\n class EpsilonSpaceCounters;\n@@ -35,7 +36,7 @@ class EpsilonMonitoringSupport : public CHeapObj\u003cmtGC\u003e {\n private:\n   EpsilonGenerationCounters* _heap_counters;\n   EpsilonSpaceCounters* _space_counters;\n-  volatile bool _ready;\n+  Atomic\u003cbool\u003e _ready;\n \n public:\n   EpsilonMonitoringSupport(EpsilonHeap* heap);","expectedMessage":"8374876: Epsilon: Convert to use Atomic\u003cT\u003e","repository":"jdk","commitHash":"c000343bbb1d822d2cee37e1a27672cfb3128bee","metadata":{"author":"Aleksey Shipilev \u003cshade@openjdk.org\u003e"}}
{"id":"jdk-586846b8","diff":" test/hotspot/gtest/opto/test_rangeinference.cpp | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\ndiff --git a/test/hotspot/gtest/opto/test_rangeinference.cpp b/test/hotspot/gtest/opto/test_rangeinference.cpp\nindex 61a9ff7fb..42767e9fc 100644\n--- a/test/hotspot/gtest/opto/test_rangeinference.cpp\n+++ b/test/hotspot/gtest/opto/test_rangeinference.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -202,7 +202,7 @@ static void test_canonicalize_constraints_random() {\n   }\n }\n \n-TEST(opto, canonicalize_constraints) {\n+TEST_VM(opto, canonicalize_constraints) {\n   test_canonicalize_constraints_trivial();\n   test_canonicalize_constraints_exhaustive\u003cintn_t\u003c1\u003e, uintn_t\u003c1\u003e\u003e();\n   test_canonicalize_constraints_exhaustive\u003cintn_t\u003c2\u003e, uintn_t\u003c2\u003e\u003e();","expectedMessage":"8374450: GTest opto.canonicalize_constraints cannot run without VM","repository":"jdk","commitHash":"586846b84a38d285c5905437e903cfc57f609410","metadata":{"author":"Axel Boldt-Christmas \u003caboldtch@openjdk.org\u003e"}}
{"id":"jdk-f4ebf958","diff":" src/hotspot/os/posix/signals_posix.cpp | 40 +++++++++++++++++++++++++++++++++-\n 1 file changed, 39 insertions(+), 1 deletion(-)\n\ndiff --git a/src/hotspot/os/posix/signals_posix.cpp b/src/hotspot/os/posix/signals_posix.cpp\nindex 85babea56..203e13a46 100644\n--- a/src/hotspot/os/posix/signals_posix.cpp\n+++ b/src/hotspot/os/posix/signals_posix.cpp\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2020, 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -951,6 +951,32 @@ struct enum_sigcode_desc_t {\n   const char* s_desc;\n };\n \n+#if defined(LINUX)\n+// Additional kernel si_code definitions that are only exported by\n+// more recent glibc distributions, so we have to hard-code the values.\n+#ifndef BUS_MCEERR_AR // glibc 2.17\n+#define BUS_MCEERR_AR 4\n+#define BUS_MCEERR_AO 5\n+#endif\n+\n+#ifndef SEGV_PKUERR // glibc 2.27\n+#define SEGV_PKUERR 4\n+#endif\n+\n+#ifndef SYS_SECCOMP // glibc 2.28\n+#define SYS_SECCOMP 1\n+#endif\n+\n+#ifndef TRAP_BRANCH // glibc 2.30\n+#define TRAP_BRANCH 3\n+#endif\n+\n+#ifndef TRAP_HWBKPT // not glibc version specific - gdb related\n+#define TRAP_HWBKPT 4\n+#endif\n+\n+#endif // LINUX\n+\n static bool get_signal_code_description(const siginfo_t* si, enum_sigcode_desc_t* out) {\n \n   const struct {\n@@ -976,6 +1002,7 @@ static bool get_signal_code_description(const siginfo_t* si, enum_sigcode_desc_t\n     { SIGSEGV, SEGV_ACCERR,  \"SEGV_ACCERR\",  \"Invalid permissions for mapped object.\" },\n #if defined(LINUX)\n     { SIGSEGV, SEGV_BNDERR,  \"SEGV_BNDERR\",  \"Failed address bound checks.\" },\n+    { SIGSEGV, SEGV_PKUERR,  \"SEGV_PKUERR\",  \"Protection key checking failure.\" },\n #endif\n #if defined(AIX)\n     // no explanation found what keyerr would be\n@@ -984,8 +1011,18 @@ static bool get_signal_code_description(const siginfo_t* si, enum_sigcode_desc_t\n     { SIGBUS,  BUS_ADRALN,   \"BUS_ADRALN\",   \"Invalid address alignment.\" },\n     { SIGBUS,  BUS_ADRERR,   \"BUS_ADRERR\",   \"Nonexistent physical address.\" },\n     { SIGBUS,  BUS_OBJERR,   \"BUS_OBJERR\",   \"Object-specific hardware error.\" },\n+#if defined(LINUX)\n+    { SIGBUS,  BUS_MCEERR_AR,\"BUS_MCEERR_AR\",\"Hardware memory error consumed on a machine check: action required.\" },\n+    { SIGBUS,  BUS_MCEERR_AO,\"BUS_MCEERR_AO\",\"Hardware memory error detected in process but not consumed: action optional.\" },\n+\n+    { SIGSYS,  SYS_SECCOMP,  \"SYS_SECCOMP\",  \"Secure computing (seccomp) filter failure.\" },\n+#endif\n     { SIGTRAP, TRAP_BRKPT,   \"TRAP_BRKPT\",   \"Process breakpoint.\" },\n     { SIGTRAP, TRAP_TRACE,   \"TRAP_TRACE\",   \"Process trace trap.\" },\n+#if defined(LINUX)\n+    { SIGTRAP, TRAP_BRANCH,  \"TRAP_BRANCH\",  \"Process taken branch trap.\" },\n+    { SIGTRAP, TRAP_HWBKPT,  \"TRAP_HWBKPT\",  \"Hardware breakpoint/watchpoint.\" },\n+#endif\n     { SIGCHLD, CLD_EXITED,   \"CLD_EXITED\",   \"Child has exited.\" },\n     { SIGCHLD, CLD_KILLED,   \"CLD_KILLED\",   \"Child has terminated abnormally and did not create a core file.\" },\n     { SIGCHLD, CLD_DUMPED,   \"CLD_DUMPED\",   \"Child has terminated abnormally and created a core file.\" },\n@@ -993,6 +1030,7 @@ static bool get_signal_code_description(const siginfo_t* si, enum_sigcode_desc_t\n     { SIGCHLD, CLD_STOPPED,  \"CLD_STOPPED\",  \"Child has stopped.\" },\n     { SIGCHLD, CLD_CONTINUED,\"CLD_CONTINUED\",\"Stopped child has continued.\" },\n #ifdef SIGPOLL\n+    { SIGPOLL, POLL_IN,      \"POLL_IN\",      \"Data input available.\" },\n     { SIGPOLL, POLL_OUT,     \"POLL_OUT\",     \"Output buffers available.\" },\n     { SIGPOLL, POLL_MSG,     \"POLL_MSG\",     \"Input message available.\" },\n     { SIGPOLL, POLL_ERR,     \"POLL_ERR\",     \"I/O error.\" },","expectedMessage":"8370314: Update signals_posix with new Linux signal codes","repository":"jdk","commitHash":"f4ebf9585f63177584d8c48838ef793407ebce12","metadata":{"author":"David Holmes \u003cdholmes@openjdk.org\u003e"}}
{"id":"jdk-0b9d4c02","diff":" .../javax/swing/plaf/basic/BasicSplitPaneUI.java   |   4 +-\n .../swing/JSplitPane/TestSplitPaneCompResize.java  | 173 +++++++++++++++++++++\n 2 files changed, 175 insertions(+), 2 deletions(-)\n\ndiff --git a/src/java.desktop/share/classes/javax/swing/plaf/basic/BasicSplitPaneUI.java b/src/java.desktop/share/classes/javax/swing/plaf/basic/BasicSplitPaneUI.java\nindex 5ff68f78d..270181f46 100644\n--- a/src/java.desktop/share/classes/javax/swing/plaf/basic/BasicSplitPaneUI.java\n+++ b/src/java.desktop/share/classes/javax/swing/plaf/basic/BasicSplitPaneUI.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 1997, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -1405,7 +1405,7 @@ public void layoutContainer(Container container) {\n             // If the splitpane has a zero size then no op out of here.\n             // If we execute this function now, we\u0027re going to cause ourselves\n             // much grief.\n-            if (containerSize.height \u003c\u003d 0 || containerSize.width \u003c\u003d 0 ) {\n+            if (containerSize.height \u003c\u003d 0 \u0026\u0026 containerSize.width \u003c\u003d 0 ) {\n                 lastSplitPaneSize \u003d 0;\n                 return;\n             }\ndiff --git a/test/jdk/javax/swing/JSplitPane/TestSplitPaneCompResize.java b/test/jdk/javax/swing/JSplitPane/TestSplitPaneCompResize.java\nnew file mode 100644\nindex 000000000..07d9b77f9\n--- /dev/null\n+++ b/test/jdk/javax/swing/JSplitPane/TestSplitPaneCompResize.java\n@@ -0,0 +1,173 @@\n+/*\n+ * Copyright (c) 2026, Oracle and/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+\n+/*\n+ * @test\n+ * @bug 4765299\n+ * @key headful\n+ * @summary Verifies componentResized() is called with nested JSplitPanes\n+ * @run main TestSplitPaneCompResize\n+ */\n+\n+import java.awt.Dimension;\n+import java.awt.Point;\n+import java.awt.Robot;\n+import java.awt.event.ComponentAdapter;\n+import java.awt.event.ComponentEvent;\n+import java.awt.event.InputEvent;\n+\n+import javax.swing.JButton;\n+import javax.swing.JFrame;\n+import javax.swing.JList;\n+import javax.swing.JScrollPane;\n+import javax.swing.JSplitPane;\n+import javax.swing.JPanel;\n+import javax.swing.ListSelectionModel;\n+import javax.swing.plaf.basic.BasicSplitPaneDivider;\n+import javax.swing.plaf.basic.BasicSplitPaneUI;\n+import javax.swing.SwingUtilities;\n+\n+public class TestSplitPaneCompResize {\n+\n+    private static JFrame frame;\n+    private JSplitPane outer;\n+    private static JButton leftOneTouchButton;\n+    private static volatile Point leftBtnPos;\n+    private static volatile boolean resized;\n+\n+    public TestSplitPaneCompResize() {\n+\n+        // set up a simple list embedded inside a scroll pane\n+        String[] listItems \u003d {\"Item1\", \"Item2\"};\n+        JList list \u003d new JList\u003c\u003e(listItems);\n+        list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);\n+        list.setSelectedIndex(0);\n+\n+        JScrollPane comp \u003d new JScrollPane(list);\n+        JSplitPane inner \u003d new JSplitPane(JSplitPane.VERTICAL_SPLIT,\n+                                          comp, new JPanel());\n+        JPanel rightPanel \u003d new JPanel();\n+\n+        outer \u003d new JSplitPane(JSplitPane.HORIZONTAL_SPLIT,\n+                               inner, rightPanel);\n+        outer.setDividerLocation(150);\n+\n+        //Provide minimum sizes for the two components in the split pane\n+        Dimension minimumSize \u003d new Dimension(100, 50);\n+        comp.setMinimumSize(minimumSize);\n+        inner.setMinimumSize(minimumSize);\n+        rightPanel.setMinimumSize(minimumSize);\n+\n+        //Provide a preferred size for the split pane\n+        outer.setPreferredSize(new Dimension(400, 200));\n+        inner.addComponentListener(new ComponentAdapter() {\n+            public void componentResized(ComponentEvent e) {\n+                System.out.println(\"inner resized\");\n+            }\n+        });\n+        comp.addComponentListener(new ComponentAdapter() {\n+            public void componentResized(ComponentEvent e) {\n+                resized \u003d true;\n+                System.out.println(\"comp resized\");\n+            }\n+        });\n+    }\n+\n+    public JSplitPane getSplitPane() {\n+        return outer;\n+    }\n+\n+\n+    public static void main(String[] s) throws Exception {\n+        Robot robot \u003d new Robot();\n+        try {\n+            SwingUtilities.invokeAndWait(() -\u003e {\n+                frame \u003d new JFrame(\"SplitPaneDemo\");\n+\n+                TestSplitPaneCompResize sp \u003d new TestSplitPaneCompResize();\n+                JSplitPane jsp \u003d sp.getSplitPane();\n+                frame.getContentPane().add(jsp);\n+                jsp.setUI(new MySplitPaneUI());\n+                jsp.setOneTouchExpandable(true);\n+                frame.pack();\n+                frame.setLocationRelativeTo(null);\n+                frame.setVisible(true);\n+            });\n+\n+            robot.waitForIdle();\n+            robot.delay(1000);\n+\n+            SwingUtilities.invokeAndWait(() -\u003e {\n+                leftBtnPos \u003d leftOneTouchButton.getLocationOnScreen();\n+                leftBtnPos.x +\u003d leftOneTouchButton.getWidth() / 2;\n+                leftBtnPos.y +\u003d leftOneTouchButton.getHeight() / 2;\n+            });\n+\n+            resized \u003d false;\n+            robot.mouseMove(leftBtnPos.x, leftBtnPos.y);\n+            robot.mousePress(InputEvent.BUTTON1_DOWN_MASK);\n+            robot.mouseRelease(InputEvent.BUTTON1_DOWN_MASK);\n+            robot.waitForIdle();\n+            robot.delay(1000);\n+\n+            if (!resized) {\n+                throw new RuntimeException(\"ComponentResized not called\");\n+            }\n+        } finally {\n+            SwingUtilities.invokeAndWait(() -\u003e {\n+                if (frame !\u003d null) {\n+                    frame.dispose();\n+                }\n+            });\n+        }\n+    }\n+\n+\n+    static class MySplitPaneUI extends BasicSplitPaneUI {\n+\n+        public MySplitPaneUI() {\n+            super();\n+        }\n+\n+        public BasicSplitPaneDivider createDefaultDivider() {\n+            return new MySplitPaneDivider(this);\n+        }\n+    }\n+\n+    static class MySplitPaneDivider extends BasicSplitPaneDivider {\n+\n+        public MySplitPaneDivider(BasicSplitPaneUI ui) {\n+            super(ui);\n+        }\n+\n+        protected JButton createLeftOneTouchButton() {\n+            leftOneTouchButton \u003d super.createLeftOneTouchButton();\n+            return leftOneTouchButton;\n+        }\n+\n+        protected JButton createRightOneTouchButton() {\n+            JButton rightOneTouchButton \u003d super.createRightOneTouchButton();\n+            return rightOneTouchButton;\n+        }\n+    }\n+}","expectedMessage":"4765299: componentResized() not always called with nested JSplitPanes","repository":"jdk","commitHash":"0b9d4c02e39191e9dba721115f422e28ee5b9869","metadata":{"author":"Prasanta Sadhukhan \u003cpsadhukhan@openjdk.org\u003e"}}
{"id":"jdk-e89c1290","diff":" .../jtreg/GatherDiagnosticInfoObserver.java        | 33 ++++++++++++++--------\n 1 file changed, 22 insertions(+), 11 deletions(-)\n\ndiff --git a/test/failure_handler/src/share/classes/jdk/test/failurehandler/jtreg/GatherDiagnosticInfoObserver.java b/test/failure_handler/src/share/classes/jdk/test/failurehandler/jtreg/GatherDiagnosticInfoObserver.java\nindex e63e55888..32dbedb51 100644\n--- a/test/failure_handler/src/share/classes/jdk/test/failurehandler/jtreg/GatherDiagnosticInfoObserver.java\n+++ b/test/failure_handler/src/share/classes/jdk/test/failurehandler/jtreg/GatherDiagnosticInfoObserver.java\n@@ -29,13 +29,14 @@\n import com.sun.javatest.regtest.config.RegressionParameters;\n import jdk.test.failurehandler.*;\n \n-import java.io.File;\n import java.io.FileWriter;\n import java.io.IOException;\n import java.io.PrintWriter;\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n+import java.util.List;\n+import java.util.stream.Stream;\n \n /**\n  * The jtreg test execution observer, which gathers info about\n@@ -85,11 +86,15 @@ public void finishedTest(TestResult tr) {\n                     testJdk, compileJdk);\n             gatherEnvInfo(workDir, name, log,\n                     gathererFactory.getEnvironmentInfoGatherer());\n-            Files.walk(workDir)\n-                    .filter(Files::isRegularFile)\n-                    .filter(f -\u003e (f.getFileName().toString().contains(\"core\") || f.getFileName().toString().contains(\"mdmp\")))\n-                    .forEach(core -\u003e gatherCoreInfo(workDir, name,\n-                            core, log, gathererFactory.getCoreInfoGatherer()));\n+            // generate a cores.html file after parsing the core dump files (if any)\n+            List\u003cPath\u003e coreFiles;\n+            try (Stream\u003cPath\u003e paths \u003d Files.walk(workDir)) {\n+                coreFiles \u003d paths.filter(Files::isRegularFile)\n+                        .filter(f -\u003e (f.getFileName().toString().contains(\"core\")\n+                                || f.getFileName().toString().contains(\"mdmp\")))\n+                        .toList();\n+            }\n+            gatherCoreInfo(workDir, name, coreFiles, log, gathererFactory.getCoreInfoGatherer());\n         } catch (Throwable e) {\n             log.printf(\"ERROR: exception in observer %s:\", name);\n             e.printStackTrace(log);\n@@ -103,16 +108,22 @@ public void finishedTest(TestResult tr) {\n         }\n     }\n \n-    private void gatherCoreInfo(Path workDir, String name, Path core, PrintWriter log,\n-                               CoreInfoGatherer gatherer) {\n+    private void gatherCoreInfo(Path workDir, String name, List\u003cPath\u003e coreFiles,\n+                                PrintWriter log, CoreInfoGatherer gatherer) {\n+        if (coreFiles.isEmpty()) {\n+            return;\n+        }\n         try (HtmlPage html \u003d new HtmlPage(workDir, CORES_OUTPUT, true)) {\n             try (ElapsedTimePrinter timePrinter\n                          \u003d new ElapsedTimePrinter(new Stopwatch(), name, log)) {\n-                gatherer.gatherCoreInfo(html.getRootSection(), core);\n+                // gather information from the contents of each core file\n+                for (Path coreFile : coreFiles) {\n+                    gatherer.gatherCoreInfo(html.getRootSection(), coreFile);\n+                }\n             }\n         } catch (Throwable e) {\n-            log.printf(\"ERROR: exception in observer on getting environment \"\n-                    + \"information %s:\", name);\n+            log.printf(\"ERROR: exception in %s observer while gathering information from\"\n+                    + \" core dump file\", name);\n             e.printStackTrace(log);\n         }\n     }","expectedMessage":"8374181: failure_handler: The cores.html file is formatted incorrectly and so hides the core dump information","repository":"jdk","commitHash":"e89c1290ca8b3e07bef12f4c0465c3e83389fef4","metadata":{"author":"Jaikiran Pai \u003cjpai@openjdk.org\u003e"}}
{"id":"jdk-15b7a425","diff":" .../shenandoahGenerationalControlThread.cpp        | 106 +++++++++++++--------\n .../shenandoahGenerationalControlThread.hpp        |  11 +--\n .../gc/shenandoah/shenandoahGenerationalHeap.hpp   |   4 +-\n .../gc/shenandoah/shenandoahRegulatorThread.cpp    |   7 ++\n 4 files changed, 78 insertions(+), 50 deletions(-)\n\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahGenerationalControlThread.cpp b/src/hotspot/share/gc/shenandoah/shenandoahGenerationalControlThread.cpp\nindex ece4150f5..018b4898a 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahGenerationalControlThread.cpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahGenerationalControlThread.cpp\n@@ -61,7 +61,12 @@ ShenandoahGenerationalControlThread::ShenandoahGenerationalControlThread() :\n \n void ShenandoahGenerationalControlThread::run_service() {\n \n+  // This is the only instance of request. It is important that request.generation\n+  // does not change between a concurrent cycle failure and the start of a degenerated\n+  // cycle. We initialize it with the young generation to handle the pathological case\n+  // where the very first cycle is degenerated (some tests exercise this path).\n   ShenandoahGCRequest request;\n+  request.generation \u003d _heap-\u003eyoung_generation();\n   while (!should_terminate()) {\n \n     // Figure out if we have pending requests.\n@@ -77,12 +82,10 @@ void ShenandoahGenerationalControlThread::run_service() {\n \n     // If the cycle was cancelled, continue the next iteration to deal with it. Otherwise,\n     // if there was no other cycle requested, cleanup and wait for the next request.\n-    if (!_heap-\u003ecancelled_gc()) {\n-      MonitorLocker ml(\u0026_control_lock, Mutex::_no_safepoint_check_flag);\n-      if (_requested_gc_cause \u003d\u003d GCCause::_no_gc) {\n-        set_gc_mode(ml, none);\n-        ml.wait();\n-      }\n+    MonitorLocker ml(\u0026_control_lock, Mutex::_no_safepoint_check_flag);\n+    if (_requested_gc_cause \u003d\u003d GCCause::_no_gc) {\n+      set_gc_mode(ml, none);\n+      ml.wait();\n     }\n   }\n \n@@ -96,8 +99,7 @@ void ShenandoahGenerationalControlThread::stop_service() {\n   log_debug(gc, thread)(\"Stopping control thread\");\n   MonitorLocker ml(\u0026_control_lock, Mutex::_no_safepoint_check_flag);\n   _heap-\u003ecancel_gc(GCCause::_shenandoah_stop_vm);\n-  _requested_gc_cause \u003d GCCause::_shenandoah_stop_vm;\n-  notify_cancellation(ml, GCCause::_shenandoah_stop_vm);\n+  notify_control_thread(ml, GCCause::_shenandoah_stop_vm);\n   // We can\u0027t wait here because it may interfere with the active cycle\u0027s ability\n   // to reach a safepoint (this runs on a java thread).\n }\n@@ -105,29 +107,39 @@ void ShenandoahGenerationalControlThread::stop_service() {\n void ShenandoahGenerationalControlThread::check_for_request(ShenandoahGCRequest\u0026 request) {\n   // Hold the lock while we read request cause and generation\n   MonitorLocker ml(\u0026_control_lock, Mutex::_no_safepoint_check_flag);\n-  if (_heap-\u003ecancelled_gc()) {\n-    // The previous request was cancelled. Either it was cancelled for an allocation\n-    // failure (degenerated cycle), or old marking was cancelled to run a young collection.\n-    // In either case, the correct generation for the next cycle can be determined by\n-    // the cancellation cause.\n-    request.cause \u003d _heap-\u003eclear_cancellation(GCCause::_shenandoah_concurrent_gc);\n-    if (request.cause \u003d\u003d GCCause::_shenandoah_concurrent_gc) {\n+\n+  log_debug(gc, thread)(\"cancelled cause: %s, requested cause: %s\",\n+    GCCause::to_string(_heap-\u003ecancelled_cause()), GCCause::to_string(_requested_gc_cause));\n+\n+  request.cause \u003d _requested_gc_cause;\n+  if (ShenandoahCollectorPolicy::is_allocation_failure(request.cause)) {\n+    if (_degen_point \u003d\u003d ShenandoahGC::_degenerated_unset) {\n       request.generation \u003d _heap-\u003eyoung_generation();\n+      _degen_point \u003d ShenandoahGC::_degenerated_outside_cycle;\n+    } else {\n+      assert(request.generation !\u003d nullptr, \"Must know which generation to use for degenerated cycle\");\n     }\n   } else {\n-    request.cause \u003d _requested_gc_cause;\n+    if (request.cause \u003d\u003d GCCause::_shenandoah_concurrent_gc) {\n+      // This is a regulator request. It is also possible that the regulator \"canceled\" an old mark,\n+      // so we can clear that here. This clear operation will only clear the cancellation if it is\n+      // a regulator request.\n+      _heap-\u003eclear_cancellation(GCCause::_shenandoah_concurrent_gc);\n+    }\n     request.generation \u003d _requested_generation;\n-\n-    // Only clear these if we made a request from them. In the case of a cancelled gc,\n-    // we do not want to inadvertently lose this pending request.\n-    _requested_gc_cause \u003d GCCause::_no_gc;\n-    _requested_generation \u003d nullptr;\n   }\n \n+  log_debug(gc, thread)(\"request.cause: %s, request.generation: %s\",\n+    GCCause::to_string(request.cause), request.generation \u003d\u003d nullptr ? \"None\" : request.generation-\u003ename());\n+\n+  _requested_gc_cause \u003d GCCause::_no_gc;\n+  _requested_generation \u003d nullptr;\n+\n   if (request.cause \u003d\u003d GCCause::_no_gc || request.cause \u003d\u003d GCCause::_shenandoah_stop_vm) {\n     return;\n   }\n \n+  assert(request.generation !\u003d nullptr, \"request.generation cannot be null, cause is: %s\", GCCause::to_string(request.cause));\n   GCMode mode;\n   if (ShenandoahCollectorPolicy::is_allocation_failure(request.cause)) {\n     mode \u003d prepare_for_allocation_failure_gc(request);\n@@ -140,11 +152,9 @@ void ShenandoahGenerationalControlThread::check_for_request(ShenandoahGCRequest\u0026\n }\n \n ShenandoahGenerationalControlThread::GCMode ShenandoahGenerationalControlThread::prepare_for_allocation_failure_gc(ShenandoahGCRequest \u0026request) {\n-\n-  if (_degen_point \u003d\u003d ShenandoahGC::_degenerated_unset) {\n-    _degen_point \u003d ShenandoahGC::_degenerated_outside_cycle;\n-    request.generation \u003d _heap-\u003eyoung_generation();\n-  } else if (request.generation-\u003eis_old()) {\n+  // Important: not all paths update the request.generation. This is intentional.\n+  // A degenerated cycle must use the same generation carried over from the previous request.\n+  if (request.generation-\u003eis_old()) {\n     // This means we degenerated during the young bootstrap for the old generation\n     // cycle. The following degenerated cycle should therefore also be young.\n     request.generation \u003d _heap-\u003eyoung_generation();\n@@ -588,6 +598,8 @@ bool ShenandoahGenerationalControlThread::check_cancellation_or_degen(Shenandoah\n   if (ShenandoahCollectorPolicy::is_allocation_failure(_heap-\u003ecancelled_cause())) {\n     assert(_degen_point \u003d\u003d ShenandoahGC::_degenerated_unset,\n            \"Should not be set yet: %s\", ShenandoahGC::degen_point_to_string(_degen_point));\n+    MonitorLocker ml(\u0026_control_lock, Mutex::_no_safepoint_check_flag);\n+    _requested_gc_cause \u003d _heap-\u003ecancelled_cause();\n     _degen_point \u003d point;\n     log_debug(gc, thread)(\"Cancellation detected:, reason: %s, degen point: %s\",\n                           GCCause::to_string(_heap-\u003ecancelled_cause()),\n@@ -633,9 +645,7 @@ void ShenandoahGenerationalControlThread::service_stw_degenerated_cycle(const Sh\n \n void ShenandoahGenerationalControlThread::request_gc(GCCause::Cause cause) {\n   if (ShenandoahCollectorPolicy::is_allocation_failure(cause)) {\n-    // GC should already be cancelled. Here we are just notifying the control thread to\n-    // wake up and handle the cancellation request, so we don\u0027t need to set _requested_gc_cause.\n-    notify_cancellation(cause);\n+    notify_control_thread(cause);\n   } else if (ShenandoahCollectorPolicy::should_handle_requested_gc(cause)) {\n     handle_requested_gc(cause);\n   }\n@@ -653,7 +663,8 @@ bool ShenandoahGenerationalControlThread::request_concurrent_gc(ShenandoahGenera\n   MonitorLocker ml(\u0026_control_lock, Mutex::_no_safepoint_check_flag);\n   if (gc_mode() \u003d\u003d servicing_old) {\n     if (!preempt_old_marking(generation)) {\n-      log_debug(gc, thread)(\"Cannot start young, old collection is not preemptible\");\n+      // Global should be able to cause old collection to be abandoned\n+      log_debug(gc, thread)(\"Cannot start %s, old collection is not preemptible\", generation-\u003ename());\n       return false;\n     }\n \n@@ -661,7 +672,7 @@ bool ShenandoahGenerationalControlThread::request_concurrent_gc(ShenandoahGenera\n     log_info(gc)(\"Preempting old generation mark to allow %s GC\", generation-\u003ename());\n     while (gc_mode() \u003d\u003d servicing_old) {\n       ShenandoahHeap::heap()-\u003ecancel_gc(GCCause::_shenandoah_concurrent_gc);\n-      notify_cancellation(ml, GCCause::_shenandoah_concurrent_gc);\n+      notify_control_thread(ml, GCCause::_shenandoah_concurrent_gc, generation);\n       ml.wait();\n     }\n     return true;\n@@ -695,21 +706,34 @@ void ShenandoahGenerationalControlThread::notify_control_thread(GCCause::Cause c\n \n void ShenandoahGenerationalControlThread::notify_control_thread(MonitorLocker\u0026 ml, GCCause::Cause cause, ShenandoahGeneration* generation) {\n   assert(_control_lock.is_locked(), \"Request lock must be held here\");\n-  log_debug(gc, thread)(\"Notify control (%s): %s, %s\", gc_mode_name(gc_mode()), GCCause::to_string(cause), generation-\u003ename());\n-  _requested_gc_cause \u003d cause;\n-  _requested_generation \u003d generation;\n-  ml.notify();\n+  if (ShenandoahCollectorPolicy::is_allocation_failure(_requested_gc_cause)) {\n+    // We have already observed a request to handle an allocation failure. We cannot allow\n+    // another request (System.gc or regulator) to subvert the degenerated cycle.\n+    log_debug(gc, thread)(\"Not overwriting gc cause %s with %s\", GCCause::to_string(_requested_gc_cause), GCCause::to_string(cause));\n+  } else {\n+    log_debug(gc, thread)(\"Notify control (%s): %s, %s\", gc_mode_name(gc_mode()), GCCause::to_string(cause), generation-\u003ename());\n+    _requested_gc_cause \u003d cause;\n+    _requested_generation \u003d generation;\n+    ml.notify();\n+  }\n }\n \n-void ShenandoahGenerationalControlThread::notify_cancellation(GCCause::Cause cause) {\n+void ShenandoahGenerationalControlThread::notify_control_thread(GCCause::Cause cause) {\n   MonitorLocker ml(\u0026_control_lock, Mutex::_no_safepoint_check_flag);\n-  notify_cancellation(ml, cause);\n+  notify_control_thread(ml, cause);\n }\n \n-void ShenandoahGenerationalControlThread::notify_cancellation(MonitorLocker\u0026 ml, GCCause::Cause cause) {\n-  assert(_heap-\u003ecancelled_gc(), \"GC should already be cancelled\");\n-  log_debug(gc,thread)(\"Notify control (%s): %s\", gc_mode_name(gc_mode()), GCCause::to_string(cause));\n-  ml.notify();\n+void ShenandoahGenerationalControlThread::notify_control_thread(MonitorLocker\u0026 ml, GCCause::Cause cause) {\n+  assert(_control_lock.is_locked(), \"Request lock must be held here\");\n+  if (ShenandoahCollectorPolicy::is_allocation_failure(_requested_gc_cause)) {\n+    // We have already observed a request to handle an allocation failure. We cannot allow\n+    // another request (System.gc or regulator) to subvert the degenerated cycle.\n+    log_debug(gc, thread)(\"Not overwriting gc cause %s with %s\", GCCause::to_string(_requested_gc_cause), GCCause::to_string(cause));\n+  } else {\n+    log_debug(gc, thread)(\"Notify control (%s): %s\", gc_mode_name(gc_mode()), GCCause::to_string(cause));\n+    _requested_gc_cause \u003d cause;\n+    ml.notify();\n+  }\n }\n \n bool ShenandoahGenerationalControlThread::preempt_old_marking(ShenandoahGeneration* generation) {\ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahGenerationalControlThread.hpp b/src/hotspot/share/gc/shenandoah/shenandoahGenerationalControlThread.hpp\nindex b7dbedd5e..13e69d252 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahGenerationalControlThread.hpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahGenerationalControlThread.hpp\n@@ -135,16 +135,13 @@ class ShenandoahGenerationalControlThread: public ShenandoahController {\n   // Return printable name for the given gc mode.\n   static const char* gc_mode_name(GCMode mode);\n \n-  // Takes the request lock and updates the requested cause and generation, then notifies the control thread.\n-  // The overloaded variant should be used when the _control_lock is already held.\n+  // These notify the control thread after updating _requested_gc_cause and (optionally) _requested_generation.\n+  // Updating the requested generation is not necessary for allocation failures nor when stopping the thread.\n+  void notify_control_thread(GCCause::Cause cause);\n+  void notify_control_thread(MonitorLocker\u0026 ml, GCCause::Cause cause);\n   void notify_control_thread(GCCause::Cause cause, ShenandoahGeneration* generation);\n   void notify_control_thread(MonitorLocker\u0026 ml, GCCause::Cause cause, ShenandoahGeneration* generation);\n \n-  // Notifies the control thread, but does not update the requested cause or generation.\n-  // The overloaded variant should be used when the _control_lock is already held.\n-  void notify_cancellation(GCCause::Cause cause);\n-  void notify_cancellation(MonitorLocker\u0026 ml, GCCause::Cause cause);\n-\n   // Configure the heap to age objects and regions if the aging period has elapsed.\n   void maybe_set_aging_cycle();\n \ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahGenerationalHeap.hpp b/src/hotspot/share/gc/shenandoah/shenandoahGenerationalHeap.hpp\nindex 736026916..a2ae4a68c 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahGenerationalHeap.hpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahGenerationalHeap.hpp\n@@ -44,13 +44,13 @@ class ShenandoahGenerationalHeap : public ShenandoahHeap {\n   void post_initialize_heuristics() override;\n \n   static ShenandoahGenerationalHeap* heap() {\n-    assert(ShenandoahCardBarrier, \"Should have card barrier to use genenrational heap\");\n+    assert(ShenandoahCardBarrier, \"Should have card barrier to use generational heap\");\n     CollectedHeap* heap \u003d Universe::heap();\n     return cast(heap);\n   }\n \n   static ShenandoahGenerationalHeap* cast(CollectedHeap* heap) {\n-    assert(ShenandoahCardBarrier, \"Should have card barrier to use genenrational heap\");\n+    assert(ShenandoahCardBarrier, \"Should have card barrier to use generational heap\");\n     return checked_cast\u003cShenandoahGenerationalHeap*\u003e(heap);\n   }\n \ndiff --git a/src/hotspot/share/gc/shenandoah/shenandoahRegulatorThread.cpp b/src/hotspot/share/gc/shenandoah/shenandoahRegulatorThread.cpp\nindex 964b6f0a1..ec4b7c721 100644\n--- a/src/hotspot/share/gc/shenandoah/shenandoahRegulatorThread.cpp\n+++ b/src/hotspot/share/gc/shenandoah/shenandoahRegulatorThread.cpp\n@@ -149,6 +149,13 @@ bool ShenandoahRegulatorThread::start_global_cycle() const {\n \n bool ShenandoahRegulatorThread::request_concurrent_gc(ShenandoahGeneration* generation) const {\n   double now \u003d os::elapsedTime();\n+\n+  // This call may find the control thread waiting on workers which have suspended\n+  // to allow a safepoint to run. If this regulator thread does not yield, the safepoint\n+  // will not run. The worker threads won\u0027t progress, the control thread won\u0027t progress,\n+  // and the regulator thread may never yield. Therefore, we leave the suspendible\n+  // thread set before making this call.\n+  SuspendibleThreadSetLeaver leaver;\n   bool accepted \u003d _control_thread-\u003erequest_concurrent_gc(generation);\n   if (LogTarget(Debug, gc, thread)::is_enabled() \u0026\u0026 accepted) {\n     double wait_time \u003d os::elapsedTime() - now;","expectedMessage":"8373819: Genshen: Control thread can miss allocation failure notification (redux)","repository":"jdk","commitHash":"15b7a4252b8d3595b7bc409e20d4c617e89240e8","metadata":{"author":"William Kemper \u003cwkemper@openjdk.org\u003e"}}
{"id":"jdk-9a2592f8","diff":" .../share/classes/javax/lang/model/type/TypeMirror.java       | 11 ++++++++++-\n .../share/classes/javax/lang/model/util/Types.java            | 11 ++++++++++-\n 2 files changed, 20 insertions(+), 2 deletions(-)\n\ndiff --git a/src/java.compiler/share/classes/javax/lang/model/type/TypeMirror.java b/src/java.compiler/share/classes/javax/lang/model/type/TypeMirror.java\nindex 5bd205a6c..facdbe405 100644\n--- a/src/java.compiler/share/classes/javax/lang/model/type/TypeMirror.java\n+++ b/src/java.compiler/share/classes/javax/lang/model/type/TypeMirror.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2005, 2023, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -120,6 +120,15 @@ public interface TypeMirror extends AnnotatedConstruct {\n      * The results of {@code t1.equals(t2)} and\n      * {@code Types.isSameType(t1, t2)} may differ.\n      *\n+     * @apiNote The identity of a {@code TypeMirror} involves implicit\n+     * state not directly accessible from its methods, including state\n+     * about the presence of unrelated types. {@code TypeMirror}\n+     * objects created by different implementations of these\n+     * interfaces should \u003ci\u003enot\u003c/i\u003e be expected to compare as equal\n+     * even if \u0026quot;the same\u0026quot; type is being modeled; this is\n+     * analogous to the inequality of {@code Class} objects for the\n+     * same class file loaded through different class loaders.\n+     *\n      * @param obj  the object to be compared with this type\n      * @return {@code true} if the specified object is equal to this one\n      */\ndiff --git a/src/java.compiler/share/classes/javax/lang/model/util/Types.java b/src/java.compiler/share/classes/javax/lang/model/util/Types.java\nindex 951b56ed2..e7212a7e0 100644\n--- a/src/java.compiler/share/classes/javax/lang/model/util/Types.java\n+++ b/src/java.compiler/share/classes/javax/lang/model/util/Types.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2005, 2024, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -106,6 +106,15 @@ public interface Types {\n      * {@code TypeMirror} objects can have different annotations and\n      * still be considered the same.\n      *\n+     * @apiNote The identity of a {@code TypeMirror} involves implicit\n+     * state not directly accessible from its methods, including state\n+     * about the presence of unrelated types. {@code TypeMirror}\n+     * objects created by different implementations of these\n+     * interfaces should \u003ci\u003enot\u003c/i\u003e be expected to compare as equal\n+     * even if \u0026quot;the same\u0026quot; type is being modeled; this is\n+     * analogous to the inequality of {@code Class} objects for the\n+     * same class file loaded through different class loaders.\n+     *\n      * @param t1  the first type\n      * @param t2  the second type\n      * @return {@code true} if and only if the two types are the same","expectedMessage":"8374953: Add note on about implicit state when comparing TypeMirrors","repository":"jdk","commitHash":"9a2592f8d2177f1480758e94faf9b986c7bba681","metadata":{"author":"Joe Darcy \u003cdarcy@openjdk.org\u003e"}}
{"id":"jdk-d433ce52","diff":" src/java.base/share/classes/java/lang/String.java  |  15 +-\n src/java.base/share/classes/java/lang/System.java  |   8 +-\n .../classes/java/lang/foreign/MemorySegment.java   |  88 ++++++++-\n .../java/lang/foreign/SegmentAllocator.java        |  54 +++++-\n .../jdk/internal/access/JavaLangAccess.java        |   4 +-\n .../foreign/AbstractMemorySegmentImpl.java         |  17 ++\n .../jdk/internal/foreign/StringSupport.java        |  71 +++----\n test/jdk/java/foreign/TestStringEncoding.java      | 205 ++++++++++++++++++++-\n .../java/lang/foreign/FromJavaStringTest.java      |  94 ++++++++++\n .../bench/java/lang/foreign/ToJavaStringTest.java  |  22 ++-\n 10 files changed, 523 insertions(+), 55 deletions(-)\n\ndiff --git a/src/java.base/share/classes/java/lang/String.java b/src/java.base/share/classes/java/lang/String.java\nindex d3eda0527..1ac15e3a8 100644\n--- a/src/java.base/share/classes/java/lang/String.java\n+++ b/src/java.base/share/classes/java/lang/String.java\n@@ -2045,19 +2045,26 @@ public byte[] getBytes() {\n         return encode(Charset.defaultCharset(), coder(), value);\n     }\n \n-    boolean bytesCompatible(Charset charset) {\n+    boolean bytesCompatible(Charset charset, int srcIndex, int numChars) {\n         if (isLatin1()) {\n             if (charset \u003d\u003d ISO_8859_1.INSTANCE) {\n                 return true; // ok, same encoding\n             } else if (charset \u003d\u003d UTF_8.INSTANCE || charset \u003d\u003d US_ASCII.INSTANCE) {\n-                return !StringCoding.hasNegatives(value, 0, value.length); // ok, if ASCII-compatible\n+                return !StringCoding.hasNegatives(value, srcIndex, numChars); // ok, if ASCII-compatible\n             }\n         }\n         return false;\n     }\n \n-    void copyToSegmentRaw(MemorySegment segment, long offset) {\n-        MemorySegment.copy(value, 0, segment, ValueLayout.JAVA_BYTE, offset, value.length);\n+    void copyToSegmentRaw(MemorySegment segment, long offset, int srcIndex, int srcLength) {\n+        if (!isLatin1()) {\n+            // This method is intended to be used together with bytesCompatible, which currently only supports\n+            // latin1 strings. In the future, bytesCompatible could be updated to handle more cases, like\n+            // UTF-16 strings (when the platform and charset endianness match, and the String doesnt contain\n+            // unpaired surrogates). If that happens, copyToSegmentRaw should also be updated.\n+            throw new IllegalStateException(\"This string does not support copyToSegmentRaw\");\n+        }\n+        MemorySegment.copy(value, srcIndex, segment, ValueLayout.JAVA_BYTE, offset, srcLength);\n     }\n \n     /**\ndiff --git a/src/java.base/share/classes/java/lang/System.java b/src/java.base/share/classes/java/lang/System.java\nindex f3a57c341..cfe09c613 100644\n--- a/src/java.base/share/classes/java/lang/System.java\n+++ b/src/java.base/share/classes/java/lang/System.java\n@@ -2331,13 +2331,13 @@ public String getLoaderNameID(ClassLoader loader) {\n             }\n \n             @Override\n-            public void copyToSegmentRaw(String string, MemorySegment segment, long offset) {\n-                string.copyToSegmentRaw(segment, offset);\n+            public void copyToSegmentRaw(String string, MemorySegment segment, long offset, int srcIndex, int srcLength) {\n+                string.copyToSegmentRaw(segment, offset, srcIndex, srcLength);\n             }\n \n             @Override\n-            public boolean bytesCompatible(String string, Charset charset) {\n-                return string.bytesCompatible(charset);\n+            public boolean bytesCompatible(String string, Charset charset, int srcIndex, int numChars) {\n+                return string.bytesCompatible(charset, srcIndex, numChars);\n             }\n         });\n     }\ndiff --git a/src/java.base/share/classes/java/lang/foreign/MemorySegment.java b/src/java.base/share/classes/java/lang/foreign/MemorySegment.java\nindex 196f44d1a..2b931a7d2 100644\n--- a/src/java.base/share/classes/java/lang/foreign/MemorySegment.java\n+++ b/src/java.base/share/classes/java/lang/foreign/MemorySegment.java\n@@ -1296,12 +1296,7 @@ MemorySegment reinterpret(long newSize,\n      * over the decoding process is required.\n      * \u003cp\u003e\n      * Getting a string from a segment with a known byte offset and\n-     * known byte length can be done like so:\n-     * {@snippet lang\u003djava :\n-     *     byte[] bytes \u003d new byte[length];\n-     *     MemorySegment.copy(segment, JAVA_BYTE, offset, bytes, 0, length);\n-     *     return new String(bytes, charset);\n-     * }\n+     * known byte length can be done using {@link #getString(long, Charset, long)}.\n      *\n      * @param offset  offset in bytes (relative to this segment address) at which this\n      *                access operation will occur\n@@ -1328,6 +1323,40 @@ MemorySegment reinterpret(long newSize,\n      */\n     String getString(long offset, Charset charset);\n \n+    /**\n+     * Reads a string from this segment at the given offset, using the provided length\n+     * and charset.\n+     * \u003cp\u003e\n+     * This method always replaces malformed-input and unmappable-character\n+     * sequences with this charset\u0027s default replacement string. The {@link\n+     * java.nio.charset.CharsetDecoder} class should be used when more control\n+     * over the decoding process is required.\n+     * \u003cp\u003e\n+     * If the string contains any {@code \u0027\\0\u0027} characters, they will be read as well.\n+     * This differs from {@link #getString(long, Charset)}, which will only read up\n+     * to the first {@code \u0027\\0\u0027}, resulting in truncation for string data that contains\n+     * the {@code \u0027\\0\u0027} character.\n+     *\n+     * @param offset  offset in bytes (relative to this segment address) at which this\n+     *                access operation will occur\n+     * @param charset the charset used to {@linkplain Charset#newDecoder() decode} the\n+     *                string bytes\n+     * @param byteLength length, in bytes, of the region of memory to read and decode into\n+     *                a string\n+     * @return a Java string constructed from the bytes read from the given starting\n+     *         address up to the given length\n+     * @throws IllegalArgumentException  if the size of the string is greater than the\n+     *         largest string supported by the platform\n+     * @throws IndexOutOfBoundsException if {@code offset \u003c 0}\n+     * @throws IndexOutOfBoundsException if {@code offset \u003e byteSize() - byteLength}\n+     * @throws IllegalStateException if the {@linkplain #scope() scope} associated with\n+     *         this segment is not {@linkplain Scope#isAlive() alive}\n+     * @throws WrongThreadException if this method is called from a thread {@code T},\n+     *         such that {@code isAccessibleBy(T) \u003d\u003d false}\n+     * @throws IllegalArgumentException if {@code byteLength \u003c 0}\n+     */\n+    String getString(long offset, Charset charset, long byteLength);\n+\n     /**\n      * Writes the given string into this segment at the given offset, converting it to\n      * a null-terminated byte sequence using the {@linkplain StandardCharsets#UTF_8 UTF-8}\n@@ -1366,7 +1395,8 @@ MemorySegment reinterpret(long newSize,\n      * If the given string contains any {@code \u0027\\0\u0027} characters, they will be\n      * copied as well. This means that, depending on the method used to read\n      * the string, such as {@link MemorySegment#getString(long)}, the string\n-     * will appear truncated when read again.\n+     * will appear truncated when read again. The string can be read without\n+     * truncation using {@link #getString(long, Charset, long)}.\n      *\n      * @param offset  offset in bytes (relative to this segment address) at which this\n      *                access operation will occur, the final address of this write\n@@ -2606,6 +2636,50 @@ static void copy(Object srcArray, int srcIndex,\n                 elementCount);\n     }\n \n+    /**\n+     * Copies the byte sequence of the given string encoded using the provided charset\n+     * to the destination segment.\n+     * \u003cp\u003e\n+     * This method always replaces malformed-input and unmappable-character\n+     * sequences with this charset\u0027s default replacement string. The {@link\n+     * java.nio.charset.CharsetDecoder} class should be used when more control\n+     * over the decoding process is required.\n+     * \u003cp\u003e\n+     * If the given string contains any {@code \u0027\\0\u0027} characters, they will be\n+     * copied as well. This means that, depending on the method used to read\n+     * the string, such as {@link MemorySegment#getString(long)}, the string\n+     * will appear truncated when read again. The string can be read without\n+     * truncation using {@link #getString(long, Charset, long)}.\n+     *\n+     * @param src      the Java string to be written into the destination segment\n+     * @param dstEncoding the charset used to {@linkplain Charset#newEncoder() encode}\n+     *                 the string bytes.\n+     * @param srcIndex the starting character index of the source string\n+     * @param dst      the destination segment\n+     * @param dstOffset the starting offset, in bytes, of the destination segment\n+     * @param numChars the number of characters to be copied\n+     * @throws IllegalStateException if the {@linkplain #scope() scope} associated with\n+     *         {@code dst} is not {@linkplain Scope#isAlive() alive}\n+     * @throws WrongThreadException if this method is called from a thread {@code T},\n+     *         such that {@code dst.isAccessibleBy(T) \u003d\u003d false}\n+     * @throws IndexOutOfBoundsException if either {@code srcIndex}, {@code numChars}, or {@code dstOffset}\n+     *         are {@code \u003c 0}\n+     * @throws IndexOutOfBoundsException if {@code srcIndex \u003e src.length() - numChars}\n+     * @throws IllegalArgumentException if {@code dst} is {@linkplain #isReadOnly() read-only}\n+     * @throws IndexOutOfBoundsException if {@code dstOffset \u003e dstSegment.byteSize() - B} where {@code B} is the size,\n+     *         in bytes, of the substring of {@code src} encoded using the given charset\n+     * @return the number of copied bytes.\n+     */\n+    @ForceInline\n+    static long copy(String src, Charset dstEncoding, int srcIndex, MemorySegment dst, long dstOffset, int numChars) {\n+        Objects.requireNonNull(src);\n+        Objects.requireNonNull(dstEncoding);\n+        Objects.requireNonNull(dst);\n+        Objects.checkFromIndexSize(srcIndex, numChars, src.length());\n+\n+        return AbstractMemorySegmentImpl.copy(src, dstEncoding, srcIndex, dst, dstOffset, numChars);\n+    }\n+\n     /**\n      * Finds and returns the relative offset, in bytes, of the first mismatch between the\n      * source and the destination segments. More specifically, the bytes at offset\ndiff --git a/src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java b/src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java\nindex 1297406dc..5b213af54 100644\n--- a/src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java\n+++ b/src/java.base/share/classes/java/lang/foreign/SegmentAllocator.java\n@@ -111,7 +111,8 @@ default MemorySegment allocateFrom(String str) {\n      * If the given string contains any {@code \u0027\\0\u0027} characters, they will be\n      * copied as well. This means that, depending on the method used to read\n      * the string, such as {@link MemorySegment#getString(long)}, the string\n-     * will appear truncated when read again.\n+     * will appear truncated when read again. The string can be read without\n+     * truncation using {@link MemorySegment#getString(long, Charset, long)}.\n      *\n      * @param str     the Java string to be converted into a C string\n      * @param charset the charset used to {@linkplain Charset#newEncoder() encode} the\n@@ -137,10 +138,10 @@ default MemorySegment allocateFrom(String str, Charset charset) {\n         int termCharSize \u003d StringSupport.CharsetKind.of(charset).terminatorCharSize();\n         MemorySegment segment;\n         int length;\n-        if (StringSupport.bytesCompatible(str, charset)) {\n+        if (StringSupport.bytesCompatible(str, charset, 0, str.length())) {\n             length \u003d str.length();\n             segment \u003d allocateNoInit((long) length + termCharSize);\n-            StringSupport.copyToSegmentRaw(str, segment, 0);\n+            StringSupport.copyToSegmentRaw(str, segment, 0, 0, str.length());\n         } else {\n             byte[] bytes \u003d str.getBytes(charset);\n             length \u003d bytes.length;\n@@ -153,6 +154,53 @@ default MemorySegment allocateFrom(String str, Charset charset) {\n         return segment;\n     }\n \n+    /**\n+     * Encodes a Java string using the provided charset and stores the resulting\n+     * byte array into a memory segment.\n+     * \u003cp\u003e\n+     * This method always replaces malformed-input and unmappable-character\n+     * sequences with this charset\u0027s default replacement byte array. The\n+     * {@link java.nio.charset.CharsetEncoder} class should be used when more\n+     * control over the encoding process is required.\n+     * \u003cp\u003e\n+     * If the given string contains any {@code \u0027\\0\u0027} characters, they will be\n+     * copied as well. This means that, depending on the method used to read\n+     * the string, such as {@link MemorySegment#getString(long)}, the string\n+     * will appear truncated when read again. The string can be read without\n+     * truncation using {@link MemorySegment#getString(long, Charset, long)}.\n+     *\n+     * @param str      the Java string to be encoded\n+     * @param charset  the charset used to {@linkplain Charset#newEncoder() encode} the\n+     *                 string bytes\n+     * @param srcIndex the starting index of the source string\n+     * @param numChars the number of characters to be copied\n+     * @return a new native segment containing the encoded string\n+     * @throws IndexOutOfBoundsException if either {@code srcIndex} or {@code numChars} are {@code \u003c 0}\n+     * @throws IndexOutOfBoundsException if {@code srcIndex \u003e str.length() - numChars}\n+     *\n+     * @implSpec The default implementation for this method copies the contents of the\n+     *           provided Java string into a new memory segment obtained by calling\n+     *           {@code this.allocate(B)}, where {@code B} is the size, in bytes, of\n+     *           the string encoded using the provided charset\n+     *           (e.g. {@code str.getBytes(charset).length});\n+     */\n+    @ForceInline\n+    default MemorySegment allocateFrom(String str, Charset charset, int srcIndex, int numChars) {\n+        Objects.requireNonNull(charset);\n+        Objects.requireNonNull(str);\n+        Objects.checkFromIndexSize(srcIndex, numChars, str.length());\n+        MemorySegment segment;\n+        if (StringSupport.bytesCompatible(str, charset, srcIndex, numChars)) {\n+            segment \u003d allocateNoInit(numChars);\n+            StringSupport.copyToSegmentRaw(str, segment, 0, srcIndex, numChars);\n+        } else {\n+            byte[] bytes \u003d str.substring(srcIndex, srcIndex + numChars).getBytes(charset);\n+            segment \u003d allocateNoInit(bytes.length);\n+            MemorySegment.copy(bytes, 0, segment, ValueLayout.JAVA_BYTE, 0, bytes.length);\n+        }\n+        return segment;\n+    }\n+\n     /**\n      * {@return a new memory segment initialized with the provided byte value}\n      * \u003cp\u003e\ndiff --git a/src/java.base/share/classes/jdk/internal/access/JavaLangAccess.java b/src/java.base/share/classes/jdk/internal/access/JavaLangAccess.java\nindex c5c45ca35..b2a224f59 100644\n--- a/src/java.base/share/classes/jdk/internal/access/JavaLangAccess.java\n+++ b/src/java.base/share/classes/jdk/internal/access/JavaLangAccess.java\n@@ -634,10 +634,10 @@ StackWalker newStackWalkerInstance(Set\u003cStackWalker.Option\u003e options,\n     /**\n      * Copy the string bytes to an existing segment, avoiding intermediate copies.\n      */\n-    void copyToSegmentRaw(String string, MemorySegment segment, long offset);\n+    void copyToSegmentRaw(String string, MemorySegment segment, long offset, int srcIndex, int srcLength);\n \n     /**\n      * Are the string bytes compatible with the given charset?\n      */\n-    boolean bytesCompatible(String string, Charset charset);\n+    boolean bytesCompatible(String string, Charset charset, int srcIndex, int numChars);\n }\ndiff --git a/src/java.base/share/classes/jdk/internal/foreign/AbstractMemorySegmentImpl.java b/src/java.base/share/classes/jdk/internal/foreign/AbstractMemorySegmentImpl.java\nindex a0c8a0a5a..f75d67adb 100644\n--- a/src/java.base/share/classes/jdk/internal/foreign/AbstractMemorySegmentImpl.java\n+++ b/src/java.base/share/classes/jdk/internal/foreign/AbstractMemorySegmentImpl.java\n@@ -551,6 +551,13 @@ public boolean equals(Object o) {\n                 unsafeGetOffset() \u003d\u003d that.unsafeGetOffset();\n     }\n \n+    @Override\n+    public String getString(long offset, Charset charset, long byteLength) {\n+        Utils.checkNonNegativeArgument(byteLength, \"byteLength\");\n+        Objects.requireNonNull(charset);\n+        return StringSupport.read(this, offset, charset, byteLength);\n+    }\n+\n     @Override\n     public int hashCode() {\n         return Objects.hash(\n@@ -702,6 +709,16 @@ public static void copy(Object srcArray, int srcIndex,\n         }\n     }\n \n+    @ForceInline\n+    public static long copy(String src, Charset dstEncoding, int srcIndex, MemorySegment dst, long dstOffset, int numChars) {\n+        Objects.requireNonNull(src);\n+        Objects.requireNonNull(dstEncoding);\n+        Objects.requireNonNull(dst);\n+\n+        AbstractMemorySegmentImpl destImpl \u003d (AbstractMemorySegmentImpl)dst;\n+        return StringSupport.copyBytes(src, destImpl, dstEncoding, dstOffset, srcIndex, numChars);\n+    }\n+\n     // accessors\n \n     @ForceInline\ndiff --git a/src/java.base/share/classes/jdk/internal/foreign/StringSupport.java b/src/java.base/share/classes/jdk/internal/foreign/StringSupport.java\nindex 208c6d54a..b9f528969 100644\n--- a/src/java.base/share/classes/jdk/internal/foreign/StringSupport.java\n+++ b/src/java.base/share/classes/jdk/internal/foreign/StringSupport.java\n@@ -30,11 +30,14 @@\n import jdk.internal.misc.ScopedMemoryAccess;\n import jdk.internal.util.Architecture;\n import jdk.internal.util.ArraysSupport;\n+import jdk.internal.util.Preconditions;\n import jdk.internal.vm.annotation.ForceInline;\n \n import java.lang.foreign.MemorySegment;\n+import java.lang.reflect.Array;\n import java.nio.charset.CharacterCodingException;\n import java.nio.charset.Charset;\n+import java.util.Objects;\n \n import static java.lang.foreign.ValueLayout.*;\n \n@@ -58,6 +61,27 @@ public static String read(AbstractMemorySegmentImpl segment, long offset, Charse\n         };\n     }\n \n+    @ForceInline\n+    public static String read(AbstractMemorySegmentImpl segment, long offset, Charset charset, long length) {\n+        return readBytes(segment, offset, charset, length);\n+    }\n+\n+    @ForceInline\n+    public static String readBytes(AbstractMemorySegmentImpl segment, long offset, Charset charset, long length) {\n+        if (length \u003e Integer.MAX_VALUE) {\n+            throw new IllegalArgumentException(\"Required length exceeds implementation limit\");\n+        }\n+        final int lengthBytes \u003d (int) length;\n+        final byte[] bytes \u003d new byte[lengthBytes];\n+        MemorySegment.copy(segment, JAVA_BYTE, offset, bytes, 0, lengthBytes);\n+        try {\n+            return JAVA_LANG_ACCESS.uncheckedNewStringOrThrow(bytes, charset);\n+        } catch (CharacterCodingException _) {\n+            // use replacement characters for malformed input\n+            return new String(bytes, charset);\n+        }\n+    }\n+\n     @ForceInline\n     public static void write(AbstractMemorySegmentImpl segment, long offset, Charset charset, String string) {\n         switch (CharsetKind.of(charset)) {\n@@ -70,14 +94,7 @@ public static void write(AbstractMemorySegmentImpl segment, long offset, Charset\n     @ForceInline\n     private static String readByte(AbstractMemorySegmentImpl segment, long offset, Charset charset) {\n         final int len \u003d strlenByte(segment, offset, segment.byteSize());\n-        final byte[] bytes \u003d new byte[len];\n-        MemorySegment.copy(segment, JAVA_BYTE, offset, bytes, 0, len);\n-        try {\n-            return JAVA_LANG_ACCESS.uncheckedNewStringOrThrow(bytes, charset);\n-        } catch (CharacterCodingException _) {\n-            // use replacement characters for malformed input\n-            return new String(bytes, charset);\n-        }\n+        return readBytes(segment, offset, charset, len);\n     }\n \n     @ForceInline\n@@ -89,14 +106,7 @@ private static void writeByte(AbstractMemorySegmentImpl segment, long offset, Ch\n     @ForceInline\n     private static String readShort(AbstractMemorySegmentImpl segment, long offset, Charset charset) {\n         int len \u003d strlenShort(segment, offset, segment.byteSize());\n-        byte[] bytes \u003d new byte[len];\n-        MemorySegment.copy(segment, JAVA_BYTE, offset, bytes, 0, len);\n-        try {\n-            return JAVA_LANG_ACCESS.uncheckedNewStringOrThrow(bytes, charset);\n-        } catch (CharacterCodingException _) {\n-          // use replacement characters for malformed input\n-          return new String(bytes, charset);\n-        }\n+        return readBytes(segment, offset, charset, len);\n     }\n \n     @ForceInline\n@@ -108,14 +118,7 @@ private static void writeShort(AbstractMemorySegmentImpl segment, long offset, C\n     @ForceInline\n     private static String readInt(AbstractMemorySegmentImpl segment, long offset, Charset charset) {\n         int len \u003d strlenInt(segment, offset, segment.byteSize());\n-        byte[] bytes \u003d new byte[len];\n-        MemorySegment.copy(segment, JAVA_BYTE, offset, bytes, 0, len);\n-        try {\n-            return JAVA_LANG_ACCESS.uncheckedNewStringOrThrow(bytes, charset);\n-        } catch (CharacterCodingException _) {\n-            // use replacement characters for malformed input\n-            return new String(bytes, charset);\n-        }\n+        return readBytes(segment, offset, charset, len);\n     }\n \n     @ForceInline\n@@ -345,22 +348,26 @@ public static CharsetKind of(Charset charset) {\n         }\n     }\n \n-    public static boolean bytesCompatible(String string, Charset charset) {\n-        return JAVA_LANG_ACCESS.bytesCompatible(string, charset);\n+    public static boolean bytesCompatible(String string, Charset charset, int srcIndex, int numChars) {\n+        return JAVA_LANG_ACCESS.bytesCompatible(string, charset, srcIndex, numChars);\n     }\n \n     public static int copyBytes(String string, MemorySegment segment, Charset charset, long offset) {\n-        if (bytesCompatible(string, charset)) {\n-            copyToSegmentRaw(string, segment, offset);\n-            return string.length();\n+        return copyBytes(string, segment, charset, offset, 0, string.length());\n+    }\n+\n+    public static int copyBytes(String string, MemorySegment segment, Charset charset, long offset, int srcIndex, int numChars) {\n+        if (bytesCompatible(string, charset, srcIndex, numChars)) {\n+            copyToSegmentRaw(string, segment, offset, srcIndex, numChars);\n+            return numChars;\n         } else {\n-            byte[] bytes \u003d string.getBytes(charset);\n+            byte[] bytes \u003d string.substring(srcIndex, srcIndex + numChars).getBytes(charset);\n             MemorySegment.copy(bytes, 0, segment, JAVA_BYTE, offset, bytes.length);\n             return bytes.length;\n         }\n     }\n \n-    public static void copyToSegmentRaw(String string, MemorySegment segment, long offset) {\n-        JAVA_LANG_ACCESS.copyToSegmentRaw(string, segment, offset);\n+    public static void copyToSegmentRaw(String string, MemorySegment segment, long offset, int srcIndex, int srcLength) {\n+        JAVA_LANG_ACCESS.copyToSegmentRaw(string, segment, offset, srcIndex, srcLength);\n     }\n }\ndiff --git a/test/jdk/java/foreign/TestStringEncoding.java b/test/jdk/java/foreign/TestStringEncoding.java\nindex 94732943b..e9e47420a 100644\n--- a/test/jdk/java/foreign/TestStringEncoding.java\n+++ b/test/jdk/java/foreign/TestStringEncoding.java\n@@ -37,6 +37,7 @@\n import java.util.Arrays;\n import java.util.List;\n import java.util.Random;\n+import java.util.Set;\n import java.util.function.UnaryOperator;\n \n import jdk.internal.foreign.AbstractMemorySegmentImpl;\n@@ -102,6 +103,140 @@ public void testStrings(String testString) {\n         }\n     }\n \n+    @Test(dataProvider \u003d \"strings\")\n+    public void testStringsLength(String testString) {\n+        if (!testString.isEmpty()) {\n+            for (Charset charset : Charset.availableCharsets().values()) {\n+                if (charset.canEncode()) {\n+                    for (Arena arena : arenas()) {\n+                        try (arena) {\n+                            MemorySegment text \u003d arena.allocateFrom(testString, charset, 0, testString.length());\n+                            long length \u003d text.byteSize();\n+                            assertEquals(length, testString.getBytes(charset).length);\n+                            String roundTrip \u003d text.getString(0, charset, length);\n+                            if (charset.newEncoder().canEncode(testString)) {\n+                                assertEquals(roundTrip, testString);\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Test(dataProvider \u003d \"strings\")\n+    public void testStringsCopy(String testString) {\n+        if (!testString.isEmpty()) {\n+            for (Charset charset : Charset.availableCharsets().values()) {\n+                if (charset.canEncode()) {\n+                    for (Arena arena : arenas()) {\n+                        try (arena) {\n+                            byte[] bytes \u003d testString.getBytes(charset);\n+                            MemorySegment text \u003d arena.allocate(JAVA_BYTE, bytes.length);\n+                            MemorySegment.copy(testString, charset, 0, text, 0, testString.length());\n+                            String roundTrip \u003d text.getString(0, charset, bytes.length);\n+                            if (charset.newEncoder().canEncode(testString)) {\n+                                assertEquals(roundTrip, testString);\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void testStringsLengthNegative() {\n+        try (Arena arena \u003d Arena.ofConfined()) {\n+            var segment \u003d arena.allocateFrom(\"abc\");\n+            assertThrows(IllegalArgumentException.class, () -\u003e segment.getString(1, StandardCharsets.UTF_8, -1));\n+        }\n+    }\n+\n+    @Test\n+    public void testCopyThrows() {\n+        try (Arena arena \u003d Arena.ofConfined()) {\n+            String testString \u003d \"abc\";\n+            String testString_notBytesCompatible \u003d \"snowman \\u26C4\";\n+            MemorySegment text \u003d arena.allocate(JAVA_BYTE, 3);\n+            MemorySegment text_notBytesCompatible \u003d arena.allocate(JAVA_BYTE,\n+                    testString_notBytesCompatible.getBytes(StandardCharsets.UTF_8).length);\n+            MemorySegment.copy(testString, StandardCharsets.UTF_8, 0, text, 0, testString.length());\n+            MemorySegment.copy(testString_notBytesCompatible, StandardCharsets.UTF_8, 0,\n+                    text_notBytesCompatible, 0,\n+                    testString_notBytesCompatible.length());\n+            // srcIndex \u003c 0\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    MemorySegment.copy(testString, StandardCharsets.UTF_8, -1, text, 0, testString.length()));\n+            // dstOffset \u003c 0\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    MemorySegment.copy(testString, StandardCharsets.UTF_8, 0, text, -1, testString.length()));\n+            // numChars \u003c 0\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    MemorySegment.copy(testString, StandardCharsets.UTF_8, 0, text, 0, -1));\n+            // srcIndex + numChars \u003e length\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    MemorySegment.copy(testString, StandardCharsets.UTF_8, 1, text, 0, testString.length()));\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    MemorySegment.copy(testString, StandardCharsets.UTF_8, 0, text, 0, testString.length() + 1));\n+            // dstOffset \u003e byteSize() - B\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    MemorySegment.copy(testString, StandardCharsets.UTF_8, 0, text, 1, testString.length()));\n+            // srcIndex + numChars overflows\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    MemorySegment.copy(testString, StandardCharsets.UTF_8, Integer.MAX_VALUE, text, 0, Integer.MAX_VALUE + 3));\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    MemorySegment.copy(testString_notBytesCompatible, StandardCharsets.UTF_8, Integer.MAX_VALUE, text, 0, Integer.MAX_VALUE + 3));\n+        }\n+    }\n+\n+    @Test\n+    public void testAllocateFromThrows() {\n+        try (Arena arena \u003d Arena.ofConfined()) {\n+            String testString \u003d \"abc\";\n+            String testString_notBytesCompatible \u003d \"snowman \\u26C4\";\n+            arena.allocateFrom(testString, StandardCharsets.UTF_8, 0, testString.length());\n+            arena.allocateFrom(testString, StandardCharsets.UTF_8, 2, 1);\n+            // srcIndex \u003c 0\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    arena.allocateFrom(testString, StandardCharsets.UTF_8, -1, testString.length()));\n+            // numChars \u003c 0\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    arena.allocateFrom(testString, StandardCharsets.UTF_8, 0, -1));\n+            // srcIndex + numChars \u003e length\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    arena.allocateFrom(testString, StandardCharsets.UTF_8, 0, testString.length() + 1));\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    arena.allocateFrom(testString, StandardCharsets.UTF_8, 1, testString.length()));\n+            // srcIndex + numChars overflows\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    arena.allocateFrom(testString, StandardCharsets.UTF_8, 3, Integer.MAX_VALUE));\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e arena.allocateFrom(\n+                    testString_notBytesCompatible, StandardCharsets.UTF_8, 3, Integer.MAX_VALUE));\n+        }\n+    }\n+\n+    @Test\n+    public void testGetStringThrows() {\n+        try (Arena arena \u003d Arena.ofConfined()) {\n+            String testString \u003d \"abc\";\n+            MemorySegment text \u003d arena.allocateFrom(testString, StandardCharsets.UTF_8, 0, testString.length());\n+            text.getString(0, StandardCharsets.UTF_8, 3);\n+            // unsupported string size\n+            assertThrows(IllegalArgumentException.class, () -\u003e\n+                    text.getString(0, StandardCharsets.UTF_8, Integer.MAX_VALUE + 1L));\n+            // offset \u003c 0\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    text.getString(-1, StandardCharsets.UTF_8, 3));\n+            // offset \u003e byteSize() - length\n+            assertThrows(IndexOutOfBoundsException.class, () -\u003e\n+                    text.getString(1, StandardCharsets.UTF_8, 3));\n+            // length \u003c 0\n+            assertThrows(IllegalArgumentException.class, () -\u003e\n+                    text.getString(0, StandardCharsets.UTF_8, -1));\n+        }\n+    }\n+\n     @Test(dataProvider \u003d \"strings\")\n     public void testStringsHeap(String testString) {\n         for (Charset charset : singleByteCharsets()) {\n@@ -221,6 +356,74 @@ public void testOffset(String testString) {\n         }\n     }\n \n+    @Test(dataProvider \u003d \"strings\")\n+    public void testSubstringGetString(String testString) {\n+        if (testString.length() \u003c 3 || !containsOnlyRegularCharacters(testString)) {\n+            return;\n+        }\n+        for (var charset : singleByteCharsets()) {\n+            for (var arena: arenas()) {\n+                try (arena) {\n+                    MemorySegment text \u003d arena.allocateFrom(testString, charset, 0, testString.length());\n+                    for (int srcIndex \u003d 0; srcIndex \u003c\u003d testString.length(); srcIndex++) {\n+                        for (int numChars \u003d 0; numChars \u003c\u003d testString.length() - srcIndex; numChars++) {\n+                            // this test assumes single-byte charsets\n+                            String roundTrip \u003d text.getString(srcIndex, charset, numChars);\n+                            String substring \u003d testString.substring(srcIndex, srcIndex + numChars);\n+                            assertEquals(roundTrip, substring);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Test(dataProvider \u003d \"strings\")\n+    public void testSubstringAllocate(String testString) {\n+        if (testString.length() \u003c 3 || !containsOnlyRegularCharacters(testString)) {\n+            return;\n+        }\n+        for (var charset : singleByteCharsets()) {\n+            for (var arena: arenas()) {\n+                try (arena) {\n+                    for (int srcIndex \u003d 0; srcIndex \u003c\u003d testString.length(); srcIndex++) {\n+                        for (int numChars \u003d 0; numChars \u003c\u003d testString.length() - srcIndex; numChars++) {\n+                            MemorySegment text \u003d arena.allocateFrom(testString, charset, srcIndex, numChars);\n+                            String substring \u003d testString.substring(srcIndex, srcIndex + numChars);\n+                            assertEquals(text.byteSize(), substring.getBytes(charset).length);\n+                            String roundTrip \u003d text.getString(0, charset, text.byteSize());\n+                            assertEquals(roundTrip, substring);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    @Test(dataProvider \u003d \"strings\")\n+    public void testSubstringCopy(String testString) {\n+        if (testString.length() \u003c 3 || !containsOnlyRegularCharacters(testString)) {\n+            return;\n+        }\n+        for (var charset : singleByteCharsets()) {\n+            for (var arena: arenas()) {\n+                try (arena) {\n+                    for (int srcIndex \u003d 0; srcIndex \u003c\u003d testString.length(); srcIndex++) {\n+                        for (int numChars \u003d 0; numChars \u003c\u003d testString.length() - srcIndex; numChars++) {\n+                            String substring \u003d testString.substring(srcIndex, srcIndex + numChars);\n+                            long length \u003d substring.getBytes(charset).length;\n+                            MemorySegment text \u003d arena.allocate(JAVA_BYTE, length);\n+                            long copied \u003d MemorySegment.copy(testString, charset, srcIndex, text, 0, numChars);\n+                            String roundTrip \u003d text.getString(0, charset, length);\n+                            assertEquals(roundTrip, substring);\n+                            assertEquals(copied, length);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n     private static final MemoryLayout CHAR_POINTER \u003d ADDRESS\n             .withTargetLayout(MemoryLayout.sequenceLayout(Long.MAX_VALUE, JAVA_BYTE));\n     private static final Linker LINKER \u003d Linker.nativeLinker();\n@@ -402,7 +605,7 @@ public static Object[][] strings() {\n                 {\"\"},\n                 {\"X\"},\n                 {\"12345\"},\n-                {\"yen \\u00A5\"},\n+                {\"section \\u00A7\"},\n                 {\"snowman \\u26C4\"},\n                 {\"rainbow \\uD83C\\uDF08\"},\n                 {\"0\"},\ndiff --git a/test/micro/org/openjdk/bench/java/lang/foreign/FromJavaStringTest.java b/test/micro/org/openjdk/bench/java/lang/foreign/FromJavaStringTest.java\nnew file mode 100644\nindex 000000000..ba559b523\n--- /dev/null\n+++ b/test/micro/org/openjdk/bench/java/lang/foreign/FromJavaStringTest.java\n@@ -0,0 +1,94 @@\n+/*\n+ * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ */\n+package org.openjdk.bench.java.lang.foreign;\n+\n+import static java.lang.foreign.ValueLayout.JAVA_BYTE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.OutputTimeUnit;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+import java.lang.foreign.Arena;\n+import java.lang.foreign.MemorySegment;\n+import java.util.concurrent.TimeUnit;\n+\n+@BenchmarkMode(Mode.AverageTime)\n+@Warmup(iterations \u003d 5, time \u003d 500, timeUnit \u003d TimeUnit.MILLISECONDS)\n+@Measurement(iterations \u003d 10, time \u003d 500, timeUnit \u003d TimeUnit.MILLISECONDS)\n+@State(Scope.Benchmark)\n+@OutputTimeUnit(TimeUnit.NANOSECONDS)\n+@Fork(value \u003d 3)\n+public class FromJavaStringTest {\n+\n+    private String str;\n+    private MemorySegment strSegment;\n+    private int lengthBytes;\n+\n+    @Param({\"5\", \"20\", \"100\", \"200\", \"451\"})\n+    int size;\n+\n+    @Setup\n+    public void setup() {\n+        var arena \u003d Arena.ofAuto();\n+        while (LOREM.length() \u003c size) {\n+            LOREM +\u003d LOREM;\n+        }\n+        str \u003d LOREM.substring(0, size);\n+        strSegment \u003d arena.allocateFrom(str);\n+        lengthBytes \u003d str.getBytes(UTF_8).length;\n+    }\n+\n+    @Benchmark\n+    public void segment_setString() {\n+        strSegment.setString(0, str, UTF_8);\n+    }\n+\n+    @Benchmark\n+    public void segment_copyStringRaw() {\n+        MemorySegment.copy(str, UTF_8, 0, strSegment, 0, str.length());\n+    }\n+\n+    @Benchmark\n+    public void segment_copyStringBytes() {\n+        byte[] bytes \u003d str.getBytes(UTF_8);\n+        MemorySegment.copy(bytes, 0, strSegment, JAVA_BYTE, 0, bytes.length);\n+    }\n+\n+    static String LOREM \u003d\n+            \"\"\"\n+            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et\n+             dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip\n+             ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu\n+             fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt\n+             mollit anim id est laborum.\n+            \"\"\";\n+}\ndiff --git a/test/micro/org/openjdk/bench/java/lang/foreign/ToJavaStringTest.java b/test/micro/org/openjdk/bench/java/lang/foreign/ToJavaStringTest.java\nindex 901f4c709..c3e8f3aac 100644\n--- a/test/micro/org/openjdk/bench/java/lang/foreign/ToJavaStringTest.java\n+++ b/test/micro/org/openjdk/bench/java/lang/foreign/ToJavaStringTest.java\n@@ -22,6 +22,9 @@\n  */\n package org.openjdk.bench.java.lang.foreign;\n \n+import static java.lang.foreign.ValueLayout.JAVA_BYTE;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n import org.openjdk.jmh.annotations.Benchmark;\n import org.openjdk.jmh.annotations.BenchmarkMode;\n import org.openjdk.jmh.annotations.Fork;\n@@ -47,6 +50,7 @@\n public class ToJavaStringTest {\n \n     private MemorySegment strSegment;\n+    private int length;\n \n     @Param({\"5\", \"20\", \"100\", \"200\", \"451\"})\n     int size;\n@@ -61,19 +65,33 @@ public void setup() {\n         while (LOREM.length() \u003c size) {\n             LOREM +\u003d LOREM;\n         }\n-        strSegment \u003d arena.allocateFrom(LOREM.substring(0, size));\n+        var s \u003d LOREM.substring(0, size);\n+        strSegment \u003d arena.allocateFrom(s);\n+        length \u003d s.getBytes(UTF_8).length;\n     }\n \n     @Benchmark\n-    public String panama_readString() {\n+    public String segment_getString() {\n         return strSegment.getString(0);\n     }\n \n+    @Benchmark\n+    public String segment_getStringLength() {\n+        return strSegment.getString(0, UTF_8, length);\n+    }\n+\n     @Benchmark\n     public String jni_readString() {\n         return readString(strSegment.address());\n     }\n \n+    @Benchmark\n+    public String segment_copyStringBytes() {\n+        byte[] bytes \u003d new byte[length];\n+        MemorySegment.copy(strSegment, JAVA_BYTE, 0, bytes, 0, length);\n+        return new String(bytes, UTF_8);\n+    }\n+\n     static native String readString(long addr);\n \n     static String LOREM \u003d \"\"\"","expectedMessage":"8369564: Provide a MemorySegment API to read strings with known lengths","repository":"jdk","commitHash":"d433ce52360994be5a88a0bcbf39cbb741b435ec","metadata":{"author":"Liam Miller-Cushon \u003ccushon@openjdk.org\u003e"}}
{"id":"jdk-556bddfd","diff":" .../jfr/event/runtime/TestBackToBackSensitive.java | 59 ++++++++++++----------\n 1 file changed, 33 insertions(+), 26 deletions(-)\n\ndiff --git a/test/jdk/jdk/jfr/event/runtime/TestBackToBackSensitive.java b/test/jdk/jdk/jfr/event/runtime/TestBackToBackSensitive.java\nindex 147caee82..fbef91e73 100644\n--- a/test/jdk/jdk/jfr/event/runtime/TestBackToBackSensitive.java\n+++ b/test/jdk/jdk/jfr/event/runtime/TestBackToBackSensitive.java\n@@ -1,5 +1,5 @@\n /*\n- * Copyright (c) 2025, Oracle and/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and/or its affiliates. All rights reserved.\n  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n  *\n  * This code is free software; you can redistribute it and/or modify it\n@@ -34,8 +34,9 @@\n import jdk.jfr.Event;\n import jdk.jfr.Recording;\n import jdk.jfr.StackTrace;\n+import jdk.jfr.consumer.EventStream;\n import jdk.jfr.consumer.RecordedClassLoader;\n-import jdk.jfr.consumer.RecordingStream;\n+import jdk.test.lib.jfr.TestClassLoader;\n \n /**\n  * @test\n@@ -52,28 +53,17 @@ public class TestBackToBackSensitive {\n     static class FillEvent extends Event {\n         String message;\n     }\n+    public static Object OBJECT;\n \n     public static void main(String... arg) throws Exception {\n-        Set\u003cInstant\u003e threadDumps \u003d Collections.synchronizedSet(new LinkedHashSet\u003c\u003e());\n-        Set\u003cInstant\u003e classLoaderStatistics \u003d Collections.synchronizedSet(new LinkedHashSet\u003c\u003e());\n-        Set\u003cInstant\u003e physicalMemory \u003d Collections.synchronizedSet(new LinkedHashSet\u003c\u003e());\n-\n+        TestClassLoader loader \u003d new TestClassLoader();\n+        Class\u003c?\u003e clazz \u003d loader.loadClass(TestBackToBackSensitive.class.getName());\n+        String classLoaderName \u003d loader.getClass().getName();\n+        OBJECT \u003d clazz.getDeclaredConstructor().newInstance();\n         Configuration configuration \u003d Configuration.getConfiguration(\"default\");\n-        try (RecordingStream r1 \u003d new RecordingStream(configuration)) {\n-            r1.setMaxSize(Long.MAX_VALUE);\n-            r1.onEvent(\"jdk.ThreadDump\", e -\u003e threadDumps.add(e.getStartTime()));\n-            r1.onEvent(\"jdk.ClassLoaderStatistics\", e -\u003e {\n-                RecordedClassLoader cl \u003d e.getValue(\"classLoader\");\n-                if (cl !\u003d null) {\n-                    if (cl.getType().getName().contains(\"PlatformClassLoader\")) {\n-                        classLoaderStatistics.add(e.getStartTime());\n-                        System.out.println(\"Class loader\" + e);\n-                    }\n-                }\n-            });\n-            r1.onEvent(\"jdk.PhysicalMemory\", e -\u003e physicalMemory.add(e.getStartTime()));\n+        try (Recording r1 \u003d new Recording(configuration)) {\n             // Start chunk 1\n-            r1.startAsync();\n+            r1.start();\n             try (Recording r2 \u003d new Recording()) {\n                 // Start chunk 2\n                 r2.start();\n@@ -86,6 +76,25 @@ public static void main(String... arg) throws Exception {\n                 f.commit();\n             }\n             r1.stop();\n+            Path file \u003d Path.of(\"file.jfr\");\n+            r1.dump(file);\n+            Set\u003cInstant\u003e threadDumps \u003d new LinkedHashSet\u003c\u003e();\n+            Set\u003cInstant\u003e classLoaderStatistics \u003d new LinkedHashSet\u003c\u003e();\n+            Set\u003cInstant\u003e physicalMemory \u003d new LinkedHashSet\u003c\u003e();\n+            try (EventStream es \u003d EventStream.openFile(file)) {\n+                es.onEvent(\"jdk.ThreadDump\", e -\u003e threadDumps.add(e.getStartTime()));\n+                es.onEvent(\"jdk.ClassLoaderStatistics\", e -\u003e {\n+                    RecordedClassLoader cl \u003d e.getValue(\"classLoader\");\n+                    if (cl !\u003d null) {\n+                        if (cl.getType().getName().equals(classLoaderName)) {\n+                            classLoaderStatistics.add(e.getStartTime());\n+                            System.out.println(\"Class loader\" + e);\n+                        }\n+                    }\n+                });\n+                es.onEvent(\"jdk.PhysicalMemory\", e -\u003e physicalMemory.add(e.getStartTime()));\n+                es.start();\n+            }\n             long chunkFiles \u003d filesInRepository();\n             System.out.println(\"Number of chunk files: \" + chunkFiles);\n             // When jdk.PhysicalMemory is expected to be emitted:\n@@ -93,15 +102,15 @@ public static void main(String... arg) throws Exception {\n             // Chunk 2: begin, end\n             // Chunk 3: begin, end\n             // Chunk 4: begin, end\n-            assertCount(r1, \"jdk.PhysicalMemory\", physicalMemory, 2 * chunkFiles);\n+            assertCount(\"jdk.PhysicalMemory\", physicalMemory, 2 * chunkFiles);\n             // When jdk.ClassLoaderStatistics and jdk.ThreadThreadDump are expected to be\n             // emitted:\n             // Chunk 1: begin, end\n             // Chunk 2: begin, end\n             // Chunk 3: end\n             // Chunk 4: end\n-            assertCount(r1, \"jdk.ThreadDump\", threadDumps, 2 + 2 + (chunkFiles - 2));\n-            assertCount(r1, \"jdk.ClassLoaderStatistics\", classLoaderStatistics, 2 + 2 + (chunkFiles - 2));\n+            assertCount(\"jdk.ThreadDump\", threadDumps, 2 + 2 + (chunkFiles - 2));\n+            assertCount(\"jdk.ClassLoaderStatistics\", classLoaderStatistics, 2 + 2 + (chunkFiles - 2));\n         }\n     }\n \n@@ -110,15 +119,13 @@ private static long filesInRepository() throws IOException {\n         return Files.list(repository).filter(p -\u003e p.toString().endsWith(\".jfr\")).count();\n     }\n \n-    private static void assertCount(RecordingStream stream, String eventName, Set\u003cInstant\u003e timestamps, long expected) throws Exception {\n+    private static void assertCount(String eventName, Set\u003cInstant\u003e timestamps, long expected) throws Exception {\n         System.out.println(\"Timestamps for \" + eventName + \":\");\n         for (Instant timestamp : timestamps) {\n             System.out.println(timestamp);\n         }\n         int count \u003d timestamps.size();\n         if (count !\u003d expected) {\n-            System.out.println(\"Dumping failure file.\");\n-            stream.dump(Path.of(\"failure.jfr\"));\n             throw new Exception(\"Expected \" + expected + \"  timestamps for event \" + eventName + \", but got \" + count);\n         }\n     }","expectedMessage":"8372321: TestBackToBackSensitive fails intermittently after JDK-8365972","repository":"jdk","commitHash":"556bddfd9439d1bad698ab5134317ce263a36b04","metadata":{"author":"Erik Gahlin \u003cegahlin@openjdk.org\u003e"}}
{"id":"jdk-2fbe4755","diff":" .../jtreg/compiler/lib/template_framework/library/Operations.java     | 4 +++-\n 1 file changed, 3 insertions(+), 1 deletion(-)\n\ndiff --git a/test/hotspot/jtreg/compiler/lib/template_framework/library/Operations.java b/test/hotspot/jtreg/compiler/lib/template_framework/library/Operations.java\nindex cb0e94c9f..1fe05cc2b 100644\n--- a/test/hotspot/jtreg/compiler/lib/template_framework/library/Operations.java\n+++ b/test/hotspot/jtreg/compiler/lib/template_framework/library/Operations.java\n@@ -274,6 +274,7 @@ private static List\u003cExpression\u003e generatePrimitiveOperations() {\n         ops.add(Expression.make(BOOLEANS, \"Boolean.logicalXor(\", BOOLEANS, \", \", BOOLEANS, \")\"));\n \n         // TODO: Math and other classes.\n+        // Note: Math.copySign is non-deterministic because of NaN having encoding with sign bit set and unset.\n \n         // Make sure the list is not modifiable.\n         return List.copyOf(ops);\n@@ -294,7 +295,8 @@ private static List\u003cExpression\u003e generateFloat16Operations() {\n         ops.add(Expression.make(INTS, \"Float16.compare(\", FLOAT16, \",\", FLOAT16, \")\"));\n         addComparisonOperations(ops, \"Float16.compare\", FLOAT16);\n         ops.add(Expression.make(INTS, \"(\", FLOAT16, \").compareTo(\",  FLOAT16, \")\"));\n-        ops.add(Expression.make(FLOAT16, \"Float16.copySign(\", FLOAT16, \",\", FLOAT16, \")\"));\n+        // Note: There are NaN encodings with bit set or unset.\n+        ops.add(Expression.make(FLOAT16, \"Float16.copySign(\", FLOAT16, \",\", FLOAT16, \")\", WITH_NONDETERMINISTIC_RESULT));\n         ops.add(Expression.make(FLOAT16, \"Float16.divide(\", FLOAT16, \",\", FLOAT16, \")\"));\n         ops.add(Expression.make(BOOLEANS, \"\", FLOAT16, \".equals(\", FLOAT16, \")\"));\n         // Note: there are multiple NaN values with different bit representations.","expectedMessage":"8374785: Template Library: need to tag Float16.copySign as having non-deterministic result because of multiple NaNs with different sign bits","repository":"jdk","commitHash":"2fbe47559e9ba45306bd08c3636647f865a75abd","metadata":{"author":"Emanuel Peter \u003cepeter@openjdk.org\u003e"}}
